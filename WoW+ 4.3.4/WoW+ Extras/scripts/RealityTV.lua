-- RealityTV 1.4.2 by Whoknowsit
-- Programmed for WoWPlus

---------------------------------------------------
--                   Variables                   --
---------------------------------------------------

local b_power = nil;
local b_start = nil;
local player  = nil;

---------------------------------------------------
--                    Startup                    --
---------------------------------------------------

function Load()
    Plus.PrintChat("RealityTV loaded.");
    
    local frm = Frame.CreateEmpty("RealityTV", 190, 205);
    Border.Create(frm, 0, 50, 190, 100, 3, 0xFF000000);
    Rectangle.Create(frm, 0, 50, 190, 100, 0x908B4513);
    Border.Create(frm, 45, 150, 100, 20, 3, 0xFF000000);
    Rectangle.Create(frm, 45, 150, 100, 20, 0x908B4513);
    b_power = Button.Create(frm, " ", 177, 140, 5, 5, 0xFFFF0000);
    b_start = Button.Create(frm, "Turn on", 20, 65, 150, 70, 0x60AAAAAA);
    Rectangle.Create(frm, 30, 40, 50, 10, 0xAF000000);
    
    Line.Create(frm, 30, 0, 50, 40, 3, 0xAF000000);
    Line.Create(frm, 80, 0, 60, 40, 3, 0xAF000000);
    
    frm:SetPosition(400, 200);
    
    Event.RegisterSignalCallback(SwitchCam, FRAMEEVENT_PLAYER_TARGET_CHANGED);
    Event.RegisterFrameCallback(SwitchCam, b_start, "OnClick");
    Event.RegisterFrameCallback(OnButtonCloseClick, b_power, "OnClick");
end

function Unload()
    Plus.PrintChat("Thank you for using RealityTV by Whoknowsit :)");
    Plus.PrintChat("Check out http://www.wow-pl.us for more, useful stuff.");
    
	if player ~= nil then
		setCam(player);
	end
end

---------------------------------------------------
--                     Events                    --
---------------------------------------------------

function OnButtonCloseClick()
	Plus.Unload();
end

---------------------------------------------------
--                 Main Functions                --
---------------------------------------------------

function SwitchCam(id, sender, xtype)
	player = ObjectManager.GetActivePlayer();
    local target = ObjectManager.GetCurrentTarget();

    if target ~= nil then
        if sender == b_start then
            setCam(target);
            
            b_start:SetText("You're watching");
            b_start:SetColor(0x40CCCCCC);
            b_power:SetColor(0xFF00FF00);
        end
    elseif player ~= nil then
        setCam(player);
        
        b_start:SetText("Turn on");
        b_start:SetColor(0x60AAAAAA);
        b_power:SetColor(0xFFFF0000);
    end
end

function setCam(obj)
    local myCam = Memory.Call(Memory.GetModuleBase() + 0x580500, "cdecl", "int");

    local viewObjectPtr = obj:GetPointer();
    local descriptorFields = Memory.Read(viewObjectPtr + 0x8, "int");
    local viewObjectBytes = Memory.ReadBuffer(descriptorFields + 0x0, 8, true);
	
	if myCam ~= nil then
		Memory.WriteBuffer(myCam + 0x80, viewObjectBytes);
	end
end