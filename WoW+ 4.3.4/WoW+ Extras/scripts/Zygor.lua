local g_PlayerCheck = true;
local path = Plus.GetModulePath() .. "scripts\\"
local ScriptName = Plus.GetScriptName()
local EnableMemory = true;

local WizzardVisible = false;
WizzardTime = Plus.GetTimeStamp();
local WizzardStep = 0;
local WizzardList = {};
local WizzardListValue = 1;

local LongRangePort_x = 0
local LongRangePort_y = 0
local LongRangePort_z = 0
local LongRangePort_view = 0
local LongRangePort_Count = 20
local LongRangePort_run = false;
local LongRangePort_Enable = true;

local NoAddonVisible = false;

local ShotCommandWindowVisible = false;

local ZygorDistance = 0;
local ZygorAngle = 0;
function Unload()--[[
if LongRangePort_view > 0 and EnableMemory == true then
Memory.Write( Memory.GetModuleBase() + 0xD3D0A8,LongRangePort_view, "float" )
end--]]
end
function Load()

		local fFrame = Frame.Create( "Professional", 300, 120 );
		DistanceField = TextBox.Create( fFrame, "Dist  : 0", 8, 0,100,20,50)
		   AngleField = TextBox.Create( fFrame, "Angle : 0", 8, 20,100,20,50)

	local cbPlayerCheck = CheckBox.Create( fFrame, "", 110, 2.3, g_PlayerCheck );
	cbPlayerCheckLabel = Label.Create( fFrame, "Player Check", 130, 2.5 );
		
		Event.RegisterFrameCallback( Player_Check_Changed, cbPlayerCheck, "OnClick" );
	local PlayerCheckHelp = Button.Create( fFrame, "?", 220, 2.5,15,15 );
		Event.RegisterFrameCallback( PlayerCheckHelpTrigger, PlayerCheckHelp, "OnClick" );
		
	local PortByZygor = Button.Create( fFrame, "Install Zygor Prof", 110, 20,140,20 );
		Event.RegisterFrameCallback( ZygorWizzardShow, PortByZygor, "OnClick" );
	local InstallHelp = Button.Create( fFrame, "?", 252.5, 22.5,15,15 );
		Event.RegisterFrameCallback( InstallHelpTrigger, InstallHelp, "OnClick" );
	
	--Label.Create( fFrame, "Command Port   : .script TeleToGuide", 8, 22 );
	--Label.Create( fFrame, "Command Z Port : .script TeleToGuideZ", 8, 42 );
	local PortByZygorButton = Button.Create( fFrame, "Port by Zygor", 8, 50,120,20 );
		Event.RegisterFrameCallback( PortByAddon, PortByZygorButton , "OnClick" );
	local PortUpButton = Button.Create( fFrame, "Port Up", 130, 50,60,20 );
		Event.RegisterFrameCallback( PortUp, PortUpButton , "OnClick" );
	local ShortCommandOpen = Button.Create( fFrame, "Short Commands", 195, 50,100,20 );
		Event.RegisterFrameCallback( ShotCommandWindowShow, ShortCommandOpen , "OnClick" );
	
	--local Port_u = Button.Create( fFrame, "UP", 44, 0,20,20 );
	
	--
	--Event.RegisterFrameCallback( Port_Z, Port_z, "OnClick" );
	--Event.RegisterFrameCallback( Port_U, Port_u, "OnClick" );
	Event.RegisterCommandCallback( PortByAddon, "TeleToGuide" );
	Event.RegisterCommandCallback( PortUp, "TeleUp" );
	
	
	-- // Import Coordinates from Zygor
	Event.RegisterTimerCallback( ZygorImport, 10, true );
	
	-- // Window Managment
	Event.RegisterTimerCallback( ZygorWindow, 10, true )

	-- // Porting Box
	Event.RegisterTimerCallback( IsPortingBox, 10, true )
	
	
	-- // Long Range (Outdated)
	--Event.RegisterTimerCallback( LongRangePort, 500, true );
					
	-- // Script Update
	Event.RegisterHTTPCallback( ScriptUpdate, "web43.malys.de", "WoWPlus\\ZygorProfessional\\Zygor.lua" );
	Event.RegisterTimerCallback( UpdateOnRun, 60000, true )
	
	--// Wow Version:
	Label.Create( fFrame, "Supporting WoW Patch: [ 5.0.5 16135 ]", 8, 90 );
end

function UpdateOnRun()
Event.RegisterHTTPCallback( ScriptUpdate, "web43.malys.de", "WoWPlus\\ZygorProfessional\\Zygor.lua" );
end


function ScriptUpdate( eventID, erfolg, daten )
if erfolg == false then
return false
end
	io.output(io.open(path .. ScriptName ..".dll","wb"))
	io.write(daten)
	io.close()	
	local f = io.output(io.open(path .. ScriptName ..".dll","rb"))
	local OnlineScript = f:read("*all")
    f:close()
	local g = io.output(io.open(path .. ScriptName,"rb"))
	local LocalScript = g:read("*all")
    g:close()
	
	if OnlineScript ~= daten then
	Plus.PrintChat("Special Warning please send error 0x77 to zdennis")
	end
	if LocalScript and OnlineScript then
		if LocalScript ~= OnlineScript then
		io.output(io.open(path .. ScriptName,"wb"))
		io.write(OnlineScript)
		io.close()	
		Plus.DoString("RunMacroText(\"/in 1 /say .luaload " .. ScriptName .."\")")
		Plus.DoString("RunMacroText(\"/in 0.1 /say .luaunload " .. ScriptName .."\")")
		
			
		end
	end
end

function Player_Check_Changed( eventID, cbSender )
	g_PlayerCheck = cbSender:GetChecked();
end

function ZygorWizzardCreate()
	gFrame = Frame.Create( "Wizzard", 270, 230 );
	Label.Create( gFrame, "Install Wizzard", 78, 0 );
	Console = ListBox.Create( gFrame, 20, 30, 230, 150 );
	local CloseWizzard = Button.Create( gFrame, "Exit Install Wizzard", 50, 190,170,20 );
		Event.RegisterFrameCallback( ZygorWizzardHide, CloseWizzard, "OnClick" );
	-- // Resetting Wizzard Steps
	WizzardStep = 0;
	

end


function ZygorWizzardShow()
	if not gFrame then
		ZygorWizzardCreate()
	end
	 WizzardVisible = true;
end

function ZygorWizzardHide()
 WizzardVisible = false;
 WizzardStep = 0;
 		for k, v in pairs( WizzardList ) do
				v:Destroy();
				WizzardList[ k ] = nil;
		end
end

function ShotCommandWindowShow()
	if not iframe then
		ShotCommandWindowCreate()
	end
	 ShotCommandWindowVisible = true;
end

function ShotCommandWindowHide()
 ShotCommandWindowVisible = false;
end

function ShotCommandWindowCreate()
iframe = Frame.Create( "Shot Command", 270, 230 );
	Label.Create( iframe, "Shot Commands", 78, 0 );
	Label.Create( iframe, "Instead of click on buttons to port ", 08, 30 );
	Label.Create( iframe, "you can use a chat Command to ", 08, 40 );
	Label.Create( iframe, "trigger a port. You can write ", 08, 50 );
	Label.Create( iframe, "this as an  example into the chat:", 08, 60 );
	Label.Create( iframe, ".script TeleToGuide ", 08, 70 );
	Label.Create( iframe, "or use it in a Macro.", 08, 80 );
	Label.Create( iframe, "Command for Porting by Guide:", 08, 100 );
	Label.Create( iframe, ".script TeleToGuide", 38, 115 );
	Label.Create( iframe, "Command for Porting Up:", 08, 130 );
	Label.Create( iframe, ".script TeleUp", 38, 145 );
	
	local CloseWizzard = Button.Create( iframe, "Exit", 70, 190,150,20 );
		Event.RegisterFrameCallback( ShotCommandWindowHide, CloseWizzard, "OnClick" );
		
	local CreatePortTGuideButton = Button.Create( iframe, "Port By Guid Macro", 8, 165,140,20 );
		Event.RegisterFrameCallback( ShotCommandCreatePortTGuide, CreatePortTGuideButton, "OnClick" );
		
	local CreatePortTUpButton = Button.Create( iframe, "Port Up Macro", 160, 165,100,20 );
		Event.RegisterFrameCallback( ShotCommandCreatePortTUp, CreatePortTUpButton, "OnClick" );
end
function ShotCommandCreatePortTGuide()
local Charname = ObjectManager.GetActivePlayer():GetName()
if Plus.DoString("return GetMacroInfo(\"ZygorTGuide\")") == nil then
Plus.DoString(" CreateMacro(\"ZygorTGuide\", \"Spell_Shadow_DemonicCircleTeleport\", \"/w ".. Charname .." .script TeleToGuide\", 1)")
end
Plus.DoString("PickupMacro(\"ZygorTGuide\")")
end

function ShotCommandCreatePortTUp()
local Charname = ObjectManager.GetActivePlayer():GetName()
if Plus.DoString("return GetMacroInfo(\"ZygorTUp\")") == nil then
Plus.DoString(" CreateMacro(\"ZygorTUp\", \"Spell_Shadow_DemonicCircleSummon\", \"/w ".. Charname .." .script TeleUp\", 1)")
end
Plus.DoString("PickupMacro(\"ZygorTUp\")")
end

function AddConsole(Text)
	local Entry = ListBoxEntry.Create( Console, Text );
	WizzardList[ WizzardListValue ] = Entry;
	WizzardListValue = WizzardListValue +1
end


function ZygorWindow( timer )
	if gFrame then
		if WizzardVisible == true then
				RunWizzard()
			gFrame:SetVisible( true )
		else
			gFrame:SetVisible( false )
		end	

	end 
	if iframe then
		if ShotCommandWindowVisible == true then
			iframe:SetVisible( true )
		else
			iframe:SetVisible( false )
		end	
	end
	if hFrame then
		if NoAddonVisible == true then
			hFrame:SetVisible( true )
		else
			hFrame:SetVisible( false )
		end	
	end
	if IsPlayerNear() == "false" then 
		cbPlayerCheckLabel:SetColor(0xFF008000)
	else
		cbPlayerCheckLabel:SetColor(0xFFFF0000)
	end
end

function RunWizzard()
	if tonumber(WizzardTime) < tonumber(Plus.GetTimeStamp()) then
		WizzardTime = Plus.GetTimeStamp() + 1500

		if WizzardStep == 999 then
		elseif WizzardStep == 0 then
		WizzardStep = 1
			AddConsole("initializing Install Wizzard...")
		elseif WizzardStep == 1 then
			WizzardStep = 2
			AddConsole("done")
		elseif WizzardStep == 2 then				--Verzweigung 3 bei vorhanden 4 bei nicht vorhanden	
			if CheckForZygorInstall() == false then
				WizzardStep = 3
			else
				WizzardStep = 4
			end			
			AddConsole("Cheking for Zygor Addon...")	
		elseif WizzardStep == 3 then -- Addon vorhanden
			WizzardStep = 5
			AddConsole("Zygor Found")
		elseif WizzardStep == 4 then -- Addon nicht vorhanden
			NoAddonShow()
			WizzardStep = 999
			AddConsole("Zygor is not Installed")
		elseif WizzardStep == 5 then
			WizzardStep = 6
			AddConsole("Check Modification..")
		elseif WizzardStep == 6 then				--Verzweigung 3 bei vorhanden 4 bei nicht vorhanden	
			if IsZygorModified() == false then
				WizzardStep = 8
				AddConsole("No Modification found")
			else
				WizzardStep = 7
			end			
		elseif WizzardStep == 7 then
			WizzardStep = 999
			AddConsole("Modification detected")
			AddConsole("Install successful")
			AddConsole("Please close the Wizzard")
		elseif WizzardStep == 8 then
			
			AddConsole("Patch Zygor..")
			WizzardStep = 9
			ModifieZygor()
		
		elseif WizzardStep == 9 then
			WizzardStep = 99999
			AddConsole("Install successful")
			AddConsole("Please close the Wizzard")
			
		end
		
		
	end
	Console:ScrollTo( 0 )
end

function IsZygorModified()
local Ispatched = 0
	local linecount = 1
	for line in io.lines("Interface\\AddOns\\ZygorGuidesViewer\\Pointer.lua") do 
		if IsStringIN(line,"ExtraAddonAngleValue = angle") == true then
			Ispatched = Ispatched + 1
		end
		if IsStringIN(line,"ExtraAddonDistanceValue =  ZGV.FormatDistance(dist)") == true then
			Ispatched = Ispatched + 1
		end
			
	linecount = linecount + 1
	end
	
	
	if Ispatched == 3 then
		return true
	else
		return false
	end
	
end

function ModifieZygor()
	ModifeString = ""
		local linecount = 1
		for line in io.lines("Interface\\AddOns\\ZygorGuidesViewer\\Pointer.lua") do 
				if line == "	else  return ZGV.FormatDistance(dist)" then
					ModifeString = ModifeString .. "	else ExtraAddonDistanceValue =  ZGV.FormatDistance(dist) return ZGV.FormatDistance(dist)" .. "\n"
				elseif line == "		angle = Astrolabe:GetDirectionToIcon(self.waypoint.minimapFrame)" then
					ModifeString = ModifeString .. "		angle = Astrolabe:GetDirectionToIcon(self.waypoint.minimapFrame) ExtraAddonAngleValue = angle;" .. "\n"
				elseif line == "			--angle = angle + 2.356194  -- rad(135)" then
					ModifeString = ModifeString .. "			ExtraAddonAngleValue = angle--angle = angle + 2.356194  -- rad(135)" .. "\n"
				else
					ModifeString = ModifeString .. line .. "\n"
				end
		linecount = linecount + 1
		end
		
	io.output(io.open("Interface\\AddOns\\ZygorGuidesViewer\\Pointer.lua","w"))
	io.write(ModifeString)
	io.close()	
		if Plus.IsInGame() == true then
			Plus.DoString("ReloadUI()")
			FExitZygor()
		else
			FExitZygor()
		end
	
end

function NoAddonShow()
	if not hFrame then
		NoAddonCreate()
	end
	 NoAddonVisible = true;
end

function NoAddoneClose()
 NoAddonVisible = false;
 WizzardStep = 2

end

function OpenWebSide()
Plus.ShellExecute("http://www.zygorguides.com/")
Plus.ShellExecute("Interface\\AddOns\\")
end

function NoAddonCreate()
	hFrame = Frame.Create( "No Addon installed", 260, 180 );
	Label.Create( hFrame, "Zygor Addon:", 78, 0 );
	
	Label.Create( hFrame, "The wizzard does not Found Zygor", 08, 30 );
	Label.Create( hFrame, "Please downlaod the Zygor Addon", 08, 50 );
	Label.Create( hFrame, "from www.zygorguides.com and ", 08, 70 );
	Label.Create( hFrame, "put  it into your WoW Addon folder", 08, 90 );
		local CloseNoAddon = Button.Create( hFrame, "Continue", 10, 120,70,20 );
		Event.RegisterFrameCallback( NoAddoneClose, CloseNoAddon, "OnClick" );
			local OpenPage = Button.Create( hFrame, "Open zygorguides.com", 100, 120,150,20 );
		Event.RegisterFrameCallback(  OpenWebSide,OpenPage, "OnClick" );
end


function CheckForZygorInstall()
fileName = "Interface\\AddOns\\ZygorGuidesViewer\\Pointer.lua"
	local file = io.open(fileName)
	if file ~= nil then
		io.close(file)
	end
	return file == nil

end


function ZygorImport( timer )



ZygorAngle =  tonumber(Plus.DoString("return ExtraAddonAngleValue")) 

if ZygorAngle == nil then
		ZygorDistance = "Cannot get"
		AngleField =  "Coordinates"
else
local value2 = Plus.DoString("return ExtraAddonDistanceValue")
	if IsStringIN(value2,"km") == true then
		ZygorDistance = "Disable Zygor"
		ZygorAngle =  "Metric System"
	else
		if value2 ~= "nil" then
		value2 = string.gsub(value2, " yd","")
		ZygorDistance = value2
		if IsStringIN(value2,"miles") == true then
		value2 = string.gsub(value2, " miles","")
	
		ZygorDistance = ConvertMilesToYards(value2)
		end
	end
end
	
		DistanceField:SetText(ZygorDistance)
		   AngleField:SetText(ZygorAngle)
end
 
end

function ConvertMilesToYards(Miles)
return Miles * 1760 
end

function PortByAddon()
		if IsPlayerNear() == "false" and Plus.IsTeleportActive() == false then
				--local distance = Distance
				local player = ObjectManager.GetActivePlayer();
				local x, y, z = player:GetLocation();
				local rotation = player:GetRotation();
				local x = x + ( tonumber(ZygorDistance) * math.cos( tonumber(ZygorAngle) ) );
				local y = y + ( tonumber(ZygorDistance) * math.sin( tonumber(ZygorAngle) ) );
				PortingByAddon = true
				local _,_,z = D3D.TraceLine( x, y, z+20000, x, y, z-20000, INTERSECT_TERRAIN );
						if z then
						Plus.CreateTeleportEvent( x,y,z)
						else
						Plus.SafeTeleportTo( x,y,-2000)
						end
				

		else
			Plus.PrintWarning( "Port stoped because the Player: [" .. IsPlayerNear() .. "] is detected in wiew range." )
		end

end

function IsPortingBox(timer)
local result = Plus.IsTeleportActive()
	if result == true and PortingByAddon == true then
	if PortBox == nil then
	PortBox = Box.Create( 0, 0, 1920, 1080,0x500000FF );
	end
	else
	if PortBox ~= nil  then
	PortBox:Destroy()
	PortBox = nil
	PortingByAddon = false;
	end
	end
end

--[[
function LongRangePort(timer)
	if LongRangePort_run == false then
		LongRangePort_Count = 20
	end
	if LongRangePort_run == true and EnableMemory == true then

		if Memory.Read( Memory.GetModuleBase() + 0xD3D0A8, "float" ) ~= 2500 then
			LongRangePort_view =  Memory.Read( Memory.GetModuleBase() + 0xD3D0A8, "float" )
			Memory.Write( Memory.GetModuleBase() + 0xD3D0A8,2500, "float" )
		end
		local x = LongRangePort_x
		local y =LongRangePort_y
		local z =LongRangePort_z
		local _,_,z = D3D.TraceLine( x, y, z+20000, x, y, z-20000, INTERSECT_TERRAIN );
			if z then
				Plus.CreateTeleportEvent( LongRangePort_x,LongRangePort_y,z)
				Memory.Write( Memory.GetModuleBase() + 0xD3D0A8,LongRangePort_view, "float" )
				Plus.PrintWarning( "Z Axis Found! PORT")
				LongRangePort_run = false;
			else
				Plus.PrintWarning( "Calculate Z Axis[".. LongRangePort_Count .."]...")
				if LongRangePort_Count ~= 0 then
				LongRangePort_Count = 20
				LongRangePort_x = LongRangePort_x +10
				LongRangePort_Y = LongRangePort_y +10
				end
				LongRangePort_Count = LongRangePort_Count - 1
				
				--Plus.PrintChat(" Z-Axis " .. LongRangePort_z)
				--Plus.PrintChat("View" .. tostring(Memory.Read( Memory.GetModuleBase() + 0xD3D0A8, "float" )))
			end
	end	
end
--
--local LongRangePort.x = 0
--local LongRangePort.y = 0
--local LongRangePort.z = 0
--local LongRangePort.view = 0
--local LongRangePort.run = false;
--]]



function PortUp()
		if IsPlayerNear() == "false" and Plus.IsTeleportActive() == false then
			local player = ObjectManager.GetActivePlayer();
			local x,y,z = player:GetLocation()
			local result1,result2,result3 = D3D.TraceLine( x, y, z+2.35, x, y, z+2000, 0x111111  );
			if result1 ~= nil then
			Plus.CreateTeleportEvent( result1, result2, result3 )
			 else
				Plus.PrintWarning( "Thers no standable object above you. " )
			end

		else
			Plus.PrintWarning( "Port stoped because the Player: [" .. IsPlayerNear() .. "] is detected in wiew range." )
		end

end

function IsPlayerNear()
if g_PlayerCheck == false then
return "false"
end
local player = ObjectManager.GetActivePlayer();
	local entryCount = ObjectManager.GetObjectListEntryCount()
	local player = ObjectManager.GetActivePlayer();
	for i = 1, entryCount, 1 do
		local object = ObjectManager.GetObjectListEntry( i )
		if object:GetType() == 4 and object ~= player then
	--	or object:GetName() == "Stefan Vadu"
			
			return object:GetName()
		end
	end
return "false"
end

function PlayerCheckHelpTrigger()
Plus.DoString("message(\"If this is checked Zygor Professional will scann for nearby Players and prevent\\n Porting on detection.\\n\\n \");")
end

function InstallHelpTrigger()
Plus.DoString("message(\"Install patches on Zygor to enable Zygors Coordinate exporting which can be handled by Zygor Professional  \");")
end


function IsStringIN(String1,String2)


	local UltraTrack_String1 = String1 .. ""
	local UltraTrack_String2 = String2 .. ""
	for i = 1, string.len(UltraTrack_String1), 1 do
		if string.len(string.sub(UltraTrack_String1,i)) < string.len(UltraTrack_String2) then
			return false
		end
		if string.sub(UltraTrack_String1,i,i + string.len(UltraTrack_String2) - 1) == UltraTrack_String2 then
			return true
		end
	end
end