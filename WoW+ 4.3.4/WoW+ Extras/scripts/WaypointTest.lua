-- WaypointTest v1.0 by Jadd
-- Programmed for WoWPlus v1.1

g_started = false;
g_ctmCheck = nil;
g_lbWaypoints, g_bStartStop = nil;

g_waypointCurrent = 1;
g_waypointCount = 1;
g_waypointList = {};

function Load()
	Plus.PrintChat( "WaypointTest v1.0 loaded!" );

	fFrame = Frame.Create( "WaypointTest v1.0", 270, 210 );
	lWaypoints = Label.Create( fFrame, "Waypoints:", 8, 0 );
	g_lbWaypoints = ListBox.Create( fFrame, 10, 20, 250, 115 );
	bAddWaypoint = Button.Create( fFrame, "Add Waypoint", 10, 140, 250, 20 );
	g_bStartStop = Button.Create( fFrame, "Start", 10, 165, 250, 20 );

	Event.RegisterFrameCallback( OnAddWaypointClicked, bAddWaypoint, "OnClick" );
	Event.RegisterFrameCallback( OnStartStopClicked, g_bStartStop, "OnClick" );
end

function Unload()
end

function OnAddWaypointClicked( eventID, button )
	x, y, z = ObjectManager.GetActivePlayer():GetLocation();
	ListBoxEntry.Create( g_lbWaypoints, "X: " .. math.floor( x ) .. ", Y: " .. math.floor( y ) .. ", Z: " .. math.floor( z ) );
	g_waypointList[g_waypointCount] = { x, y, z };
	g_waypointCount = g_waypointCount + 1;
end

function OnStartStopClicked( eventID, button )
	if g_started then
		g_bStartStop:SetText( "Start" );
		g_started = false;
		Event.RemoveTimerCallback( g_ctmCheck );
		Player.CancelMoveTo();
	else
		g_bStartStop:SetText( "Stop" );
		g_started = true;
		g_ctmCheck = Event.RegisterTimerCallback( RefreshWaypoint, 80, true );
	end
end

function RefreshWaypoint( eventID, timer )
	if Player.IsMoveToActive() then
		return;
	end

	if g_waypointCurrent >= g_waypointCount then
		g_waypointCurrent = 1;
	end

	x = g_waypointList[g_waypointCurrent][1];
	y = g_waypointList[g_waypointCurrent][2];
	z = g_waypointList[g_waypointCurrent][3];
	Player.MoveTo( x, y, z );

	g_waypointCurrent = g_waypointCurrent + 1;
end
