local g_PlayerCheck = true;

function Load()
	--Event.RegisterTimerCallback( "UpdateSpots", 100, true );

	local fFrame = Frame.Create( "-Zygor", 270, 80 );
	Distance = TextBox.Create( fFrame, "0", 8, 0,50,20,50)

	Event.RegisterTimerCallback( "ZyGorDistanceUpdate", 10, true );
	local cbPlayerCheck = CheckBox.Create( fFrame, "Player Check", 155, 2.5, g_PlayerCheck );
	Label.Create( fFrame, "Command Port   : .script TeleToGuide", 8, 22 );
	Label.Create( fFrame, "Command Z Port : .script TeleToGuideZ", 8, 42 );
	local Port_z = Button.Create( fFrame, "Z Port", 60, 0,50,20 );
	local Port_n = Button.Create( fFrame, "Port", 112, 0,40,20 );
	
	Event.RegisterFrameCallback( "Port_N", Port_n, "OnClick" );
	Event.RegisterFrameCallback( "Port_Z", Port_z, "OnClick" );
	Event.RegisterFrameCallback( "Player_Check_Changed", cbPlayerCheck, "OnClick" );
	Event.RegisterCommandCallback( "PortByCommandN", "TeleToGuide" );
	Event.RegisterCommandCallback( "PortByCommandZ", "TeleToGuideZ" );
end

function Unload()
end

function Player_Check_Changed( eventID, cbSender )
	g_PlayerCheck = cbSender:GetChecked();
end

function PortByCommandN( command )

Port_N()
end
function PortByCommandZ( command )

Port_Z()
end
function UpdateSpots( timer )
	Plus.DoString("TeleGuide = ''")
	Plus.DoString("for k, v in pairs(Astrolabe.MinimapIcons) do TeleGuide=TeleGuide .. Astrolabe.MinimapIcons[k].dist .. ',' end")
	local value = Plus.DoString("return TeleGuide")
	local value = string.split(value,",") 
	Plus.PrintChat(#value)

end

function ZyGorDistanceUpdate( timer)
local value2 = Plus.DoString("return ExtraAddonDistanceValue")
value =  tonumber(Plus.DoString("return ExtraAddonAngleValue")) 
	if value2 ~= "nil" then
	value2 = string.gsub(value2, " yd","")
	Distance:SetText(value2)
	if IsStringIN(value2,"miles") == true then
	Distance:SetText(1800)
	end
end

--------ZPort------------
	if ActivePort == 1 then
		if Plus.IsTeleportActive() == false then
			local player = ObjectManager.GetActivePlayer();
			local x, y, z = player:GetLocation();
			if ShortPort_Old_Z == z then
				Plus.CreateTeleportEvent( ShortPort_Old_X,ShortPort_Old_Y,ShortPort_Old_Z)
				ActivePort = 0
			else
				Plus.CreateTeleportEvent( x,y,ShortPort_Old_Z)
		
			end
		end
	end
end

function Port_Z()
		if IsPlayerNear() == "false" and ActivePort ~= 1 then
				--local distance = Distance
				local player = ObjectManager.GetActivePlayer();
				local x, y, z = player:GetLocation();
				local rotation = player:GetRotation();
				
					--Plus.PrintChat(Distance:GetText())
				local x = x + ( tonumber(Distance:GetText()) * math.cos( tonumber(value) ) );
				local y = y + ( tonumber(Distance:GetText()) * math.sin( tonumber(value) ) );
				local _,_,z = D3D.TraceLine( x, y, 20000, x, y, -20000, INTERSECT_TERRAIN );
				--Player.SetRotation( value)
				ShortPort_Old_X,ShortPort_Old_Y,ShortPort_Old_Z = player:GetLocation()
				ShortPort_Old_X,ShortPort_Old_Y,ShortPort_Old_Z = x,y,z
					if  tonumber(Distance:GetText()) < 1800 then
						if z then
						ActivePort = 1
						else
							Plus.PrintChat("No Z")
						end
					else
						local x, y, z = player:GetLocation();
						local x = x + ( (Distance:GetText() /2) * math.cos( tonumber(value) ) );
						local y = y + ( (Distance:GetText() /2)* math.sin( tonumber(value) ) );
						Plus.CreateTeleportEvent( x,y,z)
					end
				
				
				
				
				
		else
			Plus.PrintWarning( "Port stoped because " .. IsPlayerNear() .. " is detected" )
		end

end

function Port_N()
		if IsPlayerNear() == "false" then
				--local distance = Distance
				local player = ObjectManager.GetActivePlayer();
				local x, y, z = player:GetLocation();
				local rotation = player:GetRotation();
				local x = x + ( tonumber(Distance:GetText()) * math.cos( tonumber(value) ) );
				local y = y + ( tonumber(Distance:GetText()) * math.sin( tonumber(value) ) );
				Plus.CreateTeleportEvent( x, y, z)
				
		else
			Plus.PrintWarning( "Port stoped because " .. IsPlayerNear() .. " is detected" )
		end
end

function IsPlayerNear()
if g_PlayerCheck == false then
return "false"
end
local player = ObjectManager.GetActivePlayer();
	local entryCount = ObjectManager.GetObjectListEntryCount()
	local player = ObjectManager.GetActivePlayer();
	for i = 1, entryCount, 1 do
		local object = ObjectManager.GetObjectListEntry( i )
		if object:GetType() == 4 and object ~= player then
	--	or object:GetName() == "Stefan Vadu"
			
			return object:GetName()
		end
	end
return "false"
end

function IsStringIN(String1,String2)


	local UltraTrack_String1 = String1 .. ""
	local UltraTrack_String2 = String2 .. ""
	for i = 1, string.len(UltraTrack_String1), 1 do
		if string.len(string.sub(UltraTrack_String1,i)) < string.len(UltraTrack_String2) then
			return false
		end
		if string.sub(UltraTrack_String1,i,i + string.len(UltraTrack_String2) - 1) == UltraTrack_String2 then
			return true
		end
	end
end