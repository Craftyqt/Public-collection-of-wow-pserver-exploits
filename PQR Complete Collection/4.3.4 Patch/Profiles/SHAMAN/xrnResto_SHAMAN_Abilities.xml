<?xml version="1.0" encoding="utf-8" ?><SHAMAN><Ability><Name>--- initialize ---</Name><Default>false</Default><SpellID>0</SpellID><Actions></Actions><Lua>if not PQR_LoadLua(&amp;quot;PQR_xrn.lua&amp;quot;) then
  PQR_WriteToChat(&amp;quot;PQR_xrn.lua is missing. Rotation has been stopped.&amp;quot;, &amp;quot;Error&amp;quot;)
  PQR_StopRotation()
  return true
end

CastClick() 
HealEngine() 

-- Uncoment next line to show healing target on focus
-- if members[1].Unit then FocusUnit(members[1].Unit) end 

if IsLeftAltKeyDown() 
or IsMounted()
or SpellIsTargeting()
or UnitBuffID(&amp;quot;player&amp;quot;,80169)
or UnitBuffID(&amp;quot;player&amp;quot;,87959)
or UnitChannelInfo(&amp;quot;player&amp;quot;) 
or UnitIsDeadOrGhost(&amp;quot;player&amp;quot;) 
or UnitIsDeadOrGhost(&amp;quot;target&amp;quot;) 
then return true end</Lua><RecastDelay>0</RecastDelay><Target>Target</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>--- special events ---</Name><Default>false</Default><SpellID>0</SpellID><Actions></Actions><Lua>-- Avoid sudden death on Ultraxion
local fadingtime = select(7,UnitDebuffID(&amp;quot;player&amp;quot;,110070))
if fadingtime and fadingtime - GetTime() &amp;lt; 1.5 then RunMacroText(&amp;quot;/click ExtraActionButton1&amp;quot;) end 

-- Avoid Hour of Twilight on Ultraxion, Delete next 3 lines if you are working as tank
local channelSpell, _, _, _, _, endTime = UnitCastingInfo(&amp;quot;boss1&amp;quot;)
if channelSpell == GetSpellInfo(109417) and endTime/1000 - GetTime() &amp;lt; 1.1 
then RunMacroText(&amp;quot;/click ExtraActionButton1&amp;quot;) end 

-- Avoid sudden death on Madness 
local tentacledeath = select(7,UnitDebuffID(&amp;quot;player&amp;quot;,109597))
if tentacledeath and tentacledeath - GetTime() &amp;lt; 1 then RunMacroText(&amp;quot;/click ExtraActionButton1&amp;quot;) end</Lua><RecastDelay>0</RecastDelay><Target>Target</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>--- healing spells ---</Name><Default>false</Default><SpellID>0</SpellID><Actions></Actions><Lua>if PQR_RotationStarted then
  PQR_RotationStarted = false
  local spells = { 51514 }
  for i=1, #spells do PQR_AddToSpellDelayList(spells[i],0,1) end
end

if IsSpellKnown(51490) then return PQR_SwapRotation(&amp;quot;Elemental PvE [32/9/0] (xrnElem)&amp;quot;) end

if PQR_IsCastingSpell(403) and members[1].HP &amp;lt; 75 then SpellStopCasting() return true end

local InCombat = false
for i=1, #members do if UnitAffectingCombat(members[i].Unit) then InCombat = true end end
if not InCombat and not IsLeftShiftKeyDown() 
then return true end</Lua><RecastDelay>0</RecastDelay><Target>Target</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Earthliving Weapon</Name><Default>false</Default><SpellID>51730</SpellID><Actions></Actions><Lua>local WEnchant,WEnchantExpires = GetWeaponEnchantInfo()

if ( not WEnchant or ( Wenchant and WEnchantExpires/60000 &amp;lt; 10 and not UnitAffectingCombat(&amp;quot;player&amp;quot;) ) ) 
and GetSpellCooldown(8024) == 0 
then return true end</Lua><RecastDelay>0</RecastDelay><Target>Player</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Water Shield</Name><Default>false</Default><SpellID>52127</SpellID><Actions></Actions><Lua>if not UnitBuffID(&amp;quot;player&amp;quot;,52127) 
then return true end</Lua><RecastDelay>500</RecastDelay><Target>Player</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Healing Wave</Name><Default>false</Default><SpellID>331</SpellID><Actions></Actions><Lua>if members[1].HP &amp;lt; 90 
and UnitBuffID(&amp;quot;player&amp;quot;,53390) 
and not PQR_IsMoving(1) 
then
  PQR_CustomTarget = members[1].Unit
  return true
end</Lua><RecastDelay>0</RecastDelay><Target>Custom</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Healing Surge</Name><Default>false</Default><SpellID>8004</SpellID><Actions></Actions><Lua>if members[1].HP &amp;lt; 20 
and 100 * UnitPower(&amp;quot;player&amp;quot;) / UnitPowerMax(&amp;quot;player&amp;quot;) &amp;gt; 50 
and not PQR_IsMoving(1) 
then
  PQR_CustomTarget = members[1].Unit
  return true
end</Lua><RecastDelay>0</RecastDelay><Target>Custom</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Greater Healing Wave</Name><Default>false</Default><SpellID>77472</SpellID><Actions></Actions><Lua>if members[1].HP &amp;lt; 65 
and UnitBuffID(&amp;quot;player&amp;quot;,53390) 
and not PQR_IsMoving(1) 
then
  if IsUsableSpell(16188) then CastSpellByID(16188) end 
  PQR_CustomTarget = members[1].Unit
  return true
end</Lua><RecastDelay>0</RecastDelay><Target>Custom</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Riptide</Name><Default>false</Default><SpellID>61295</SpellID><Actions></Actions><Lua>if members[1].HP &amp;lt; 90 then
  PQR_CustomTarget = members[1].Unit
  return true
else
  for i=1,#members do
    if UnitGroupRolesAssigned(members[i].Unit) == &amp;quot;TANK&amp;quot; then PQR_CustomTarget = members[i].Unit return true end 
  end
end</Lua><RecastDelay>0</RecastDelay><Target>Custom</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Unleash Elements</Name><Default>false</Default><SpellID>73680</SpellID><Actions></Actions><Lua>if members[1].HP &amp;lt; 99 
and UnitThreatSituation(members[1].Unit) == 3 
then
  PQR_CustomTarget = members[1].Unit
  return true
end</Lua><RecastDelay>0</RecastDelay><Target>Custom</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Spiritwalker&amp;apos;s Grace</Name><Default>false</Default><SpellID>79206</SpellID><Actions></Actions><Lua>if not SWbonus then 
  function SWbonus() 
    local pieces,tier13 = 0, { 78786, 76758, 78691, 78834, 76760, 78739, 78820, 76756, 78725, 78767, 76757, 78672, 78813, 76759, 78718 } 
    for i=1,#tier13 do if IsEquippedItem(tier13[i]) then pieces = pieces + 1 end end
    if pieces &amp;gt; 3 then return true end
  end
end

if ( members[1].HP &amp;lt; 33 and PQR_IsMoving(1) ) 
or ( SWbonus() and 100 * group.low / #members &amp;gt; 70  ) 
then return true end</Lua><RecastDelay>0</RecastDelay><Target>Player</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Earth Shield</Name><Default>false</Default><SpellID>974</SpellID><Actions></Actions><Lua>local EarthShield
for i=1, #members do 
  if UnitBuffID(members[i].Unit,974,&amp;quot;PLAYER&amp;quot;) then EarthShield = members[i].Unit end 
end

if not EarthShield
or ( EarthShield and UnitThreatSituation(EarthShield) ~= 3 ) 
then 
  for i=1,#members do
    if UnitGroupRolesAssigned(members[i].Unit) == &amp;quot;TANK&amp;quot; 
    and UnitThreatSituation(members[i].Unit) == 3 
    and not UnitBuffID(members[i].Unit,974) 
    then PQR_CustomTarget = members[i].Unit return true end 
  end
end</Lua><RecastDelay>10000</RecastDelay><Target>Custom</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Call of the Elements</Name><Default>false</Default><SpellID>0</SpellID><Actions></Actions><Lua>if UnitAffectingCombat(&amp;quot;player&amp;quot;) and not PQR_IsMoving(1) then

  local _,fire = GetTotemInfo(1) 
  local fireid = ( not UnitBuffID(&amp;quot;player&amp;quot;,61316) and not UnitBuffID(&amp;quot;player&amp;quot;,1459) ) and 8227 or 3599 
  local _,earth = GetTotemInfo(2) 
  local earthid = not UnitBuffID(&amp;quot;player&amp;quot;, 465) and 8071 or 8075 
  local _,water = GetTotemInfo(3) 
  local waterid = ( not UnitBuffID(&amp;quot;player&amp;quot;, 19740) and not UnitBuffID(&amp;quot;player&amp;quot;, 54424) ) and 5675 or 5394
  local _,air = GetTotemInfo(4) 
  local airid = ( not UnitBuffID(&amp;quot;player&amp;quot;, 53290) and not UnitBuffID(&amp;quot;player&amp;quot;, 55610) and ( UnitBuffID(&amp;quot;player&amp;quot;, 49868) or UnitBuffID(&amp;quot;player&amp;quot;, 24907) ) ) and 8512 or 3738 

  if fire == &amp;quot;&amp;quot; and earth == &amp;quot;&amp;quot; and water == &amp;quot;&amp;quot; and air == &amp;quot;&amp;quot; 
  then 
    SetMultiCastSpell(133,fireid)
    SetMultiCastSpell(134,earthid)
    SetMultiCastSpell(135,waterid)
    SetMultiCastSpell(136,airid)
    CastSpellByID(66842) 
    SmartTotems = true
    return true 
  end

  if fire == &amp;quot;&amp;quot; then SetMultiCastSpell(133,fireid) CastSpellByID(fireid) SmartTotems = true return true end
  if earth == &amp;quot;&amp;quot; then SetMultiCastSpell(134,earthid) CastSpellByID(earthid) SmartTotems = true return true end
  if water == &amp;quot;&amp;quot; then SetMultiCastSpell(135,waterid) CastSpellByID(waterid) SmartTotems = true return true end
  if air == &amp;quot;&amp;quot; then SetMultiCastSpell(136,airid) CastSpellByID(airid) SmartTotems = true return true end
  
end</Lua><RecastDelay>0</RecastDelay><Target>Target</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Chain Heal</Name><Default>false</Default><SpellID>1064</SpellID><Actions></Actions><Lua>if not UnitsClose then 
  function UnitsClose(t) 
    local n = -1
    for i=1,#members do
      if PQR_UnitDistance(t,members[i].Unit) &amp;lt; 12.5 and members[i].HP &amp;lt; 95 then n = n + 1 end
    end 
    return n
  end
end

if members[1].HP &amp;lt; 95 
and UnitsClose(members[1].Unit) &amp;gt; 1
then
  PQR_CustomTarget = members[1].Unit
  return true
end</Lua><RecastDelay>0</RecastDelay><Target>Custom</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Healing Rain</Name><Default>false</Default><SpellID>0</SpellID><Actions></Actions><Lua>if IsLeftControlKeyDown() 
and not GetCurrentKeyBoardFocus() 
and not UnitChannelInfo(&amp;quot;player&amp;quot;) 
and IsSpellKnown(73920) 
then
  CastSpellByName(tostring(GetSpellInfo(73920)))
  if SpellIsTargeting() then CameraOrSelectOrMoveStart() CameraOrSelectOrMoveStop() end  
  return true
end</Lua><RecastDelay>0</RecastDelay><Target>Target</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Mana Tide</Name><Default>false</Default><SpellID>16190</SpellID><Actions></Actions><Lua>if 100 * UnitPower(&amp;quot;player&amp;quot;) / UnitPowerMax(&amp;quot;player&amp;quot;) &amp;lt; 70 
and UnitAffectingCombat(&amp;quot;player&amp;quot;) 
then return true end</Lua><RecastDelay>0</RecastDelay><Target>Target</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Totemic Recall</Name><Default>false</Default><SpellID>36936</SpellID><Actions></Actions><Lua>local _,fire = GetTotemInfo(1)
local _,earth = GetTotemInfo(2)
local _,water = GetTotemInfo(3)
local _,air = GetTotemInfo(4)


if SmartTotems and not UnitAffectingCombat(&amp;quot;player&amp;quot;) 
and fire ~= &amp;quot;Fire Elemental Totem&amp;quot; 
and earth ~= &amp;quot;Earth Elemental Totem&amp;quot; 
and water ~= &amp;quot;Mana Tide Totem&amp;quot; 
and ( fire ~= &amp;quot;&amp;quot; or earth ~= &amp;quot;&amp;quot; or water ~= &amp;quot;&amp;quot; or air ~= &amp;quot;&amp;quot; ) 
then 
  SmartTotems = false
  return true 
end</Lua><RecastDelay>0</RecastDelay><Target>Player</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Cleanse Spirit</Name><Default>false</Default><SpellID>51886</SpellID><Actions></Actions><Lua>if not CheckEffects then 
  function CheckEffects(t)
    for n=1,40 do 
      local buff,_,_,count,bufftype,duration = UnitDebuff(t, n)
      if buff then 
        if bufftype == &amp;quot;Magic&amp;quot; or bufftype == &amp;quot;Curse&amp;quot; then return true end 
      else
        break 
      end       
    end
  end
end

for i=1,#members do
  if not BadEffects(members[i].Unit) 
  and CheckEffects(members[i].Unit) 
  and select(5,GetTalentInfo(3,12)) == 1 
  then 
    PQR_CustomTarget = members[i].Unit
     return true 
  end
end</Lua><RecastDelay>500</RecastDelay><Target>Custom</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Lightning Bolt</Name><Default>false</Default><SpellID>403</SpellID><Actions></Actions><Lua>if select(5,GetTalentInfo(3,16)) ~= 0
and not ImmuneTarget(&amp;quot;target&amp;quot;) 
and UnitCanAttack(&amp;quot;player&amp;quot;,&amp;quot;target&amp;quot;) 
and ( UnitAffectingCombat(&amp;quot;target&amp;quot;) or SpecialAggro(&amp;quot;target&amp;quot;) or UnitIsPlayer(&amp;quot;target&amp;quot;) ) 
and IsSpellInRange(tostring(GetSpellInfo(403)),&amp;quot;target&amp;quot;) == 1 
then return true end</Lua><RecastDelay>0</RecastDelay><Target>Target</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability></SHAMAN>