<?xml version="1.0" encoding="utf-8" ?><SHAMAN><Ability><Name>--- initialize ---</Name><Default>false</Default><SpellID>0</SpellID><Actions></Actions><Lua>if not PQR_LoadLua(&amp;quot;PQR_xrn.lua&amp;quot;) then
  PQR_WriteToChat(&amp;quot;PQR_xrn.lua is missing. Rotation has been stopped.&amp;quot;, &amp;quot;Error&amp;quot;)
  PQR_StopRotation()
  return true
end

CastClick() 
HealEngine() 

if IsLeftAltKeyDown() 
or IsMounted()
or SpellIsTargeting()
or UnitBuffID(&amp;quot;player&amp;quot;,80169)
or UnitBuffID(&amp;quot;player&amp;quot;,87959)
or UnitChannelInfo(&amp;quot;player&amp;quot;) 
or UnitIsDeadOrGhost(&amp;quot;player&amp;quot;) 
or UnitIsDeadOrGhost(&amp;quot;target&amp;quot;) 
then return true end</Lua><RecastDelay>0</RecastDelay><Target>Target</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>--- offensive spells ---</Name><Default>false</Default><SpellID>0</SpellID><Actions></Actions><Lua>if UnitDebuffID(&amp;quot;target&amp;quot;,8050,&amp;quot;PLAYER&amp;quot;) 
and IsControlKeyDown() and not GetCurrentKeyBoardFocus() 
then TargetNearestEnemy() end 

if UnitIsDead(&amp;quot;target&amp;quot;) 
or ImmuneTarget(&amp;quot;target&amp;quot;) 
or not UnitCanAttack(&amp;quot;player&amp;quot;,&amp;quot;target&amp;quot;) 
or tonumber(UnitGUID(&amp;quot;target&amp;quot;):sub(5,5),16) == 4
or ( not UnitAffectingCombat(&amp;quot;target&amp;quot;) and not SpecialAggro(&amp;quot;target&amp;quot;) and not UnitIsPlayer(&amp;quot;target&amp;quot;) )
or IsSpellInRange(tostring(GetSpellInfo(403)),&amp;quot;target&amp;quot;) == 0 
then return true end</Lua><RecastDelay>0</RecastDelay><Target>Target</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>--- special events ---</Name><Default>false</Default><SpellID>0</SpellID><Actions></Actions><Lua>-- Avoid sudden death on Ultraxion
local fadingtime = select(7,UnitDebuffID(&amp;quot;player&amp;quot;,110070))
if fadingtime and fadingtime - GetTime() &amp;lt; 1.5 then RunMacroText(&amp;quot;/click ExtraActionButton1&amp;quot;) end 

-- Avoid Hour of Twilight on Ultraxion, Delete next 3 lines if you are working as tank
local channelSpell, _, _, _, _, endTime = UnitCastingInfo(&amp;quot;boss1&amp;quot;)
if channelSpell == GetSpellInfo(109417) and endTime/1000 - GetTime() &amp;lt; 1.1 
then RunMacroText(&amp;quot;/click ExtraActionButton1&amp;quot;) end 

-- Avoid sudden death on Madness 
local tentacledeath = select(7,UnitDebuffID(&amp;quot;player&amp;quot;,109597))
if tentacledeath and tentacledeath - GetTime() &amp;lt; 1 then RunMacroText(&amp;quot;/click ExtraActionButton1&amp;quot;) end</Lua><RecastDelay>0</RecastDelay><Target>Target</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Flametongue Weapon</Name><Default>false</Default><SpellID>8024</SpellID><Actions></Actions><Lua>local WEnchant,WEnchantExpires = GetWeaponEnchantInfo()

if ( not WEnchant or ( Wenchant and WEnchantExpires/60000 &amp;lt; 10 and not UnitAffectingCombat(&amp;quot;player&amp;quot;) ) ) 
and GetSpellCooldown(8024) == 0 
then return true end</Lua><RecastDelay>500</RecastDelay><Target>Player</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Lightning Shield</Name><Default>false</Default><SpellID>324</SpellID><Actions></Actions><Lua>if not UnitBuffID(&amp;quot;player&amp;quot;,324) 
and GetSpellCooldown(324) == 0 
then return true end</Lua><RecastDelay>500</RecastDelay><Target>Player</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Searing Totem</Name><Default>false</Default><SpellID>3599</SpellID><Actions></Actions><Lua>if select(3,GetTotemInfo(1)) == 0 
then return true end</Lua><RecastDelay>500</RecastDelay><Target>Target</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Flame Shock</Name><Default>false</Default><SpellID>8050</SpellID><Actions></Actions><Lua>local debuff,_,_,_,_,_,endtime = UnitDebuffID(&amp;quot;target&amp;quot;,8050,&amp;quot;PLAYER&amp;quot;) 

if not debuff 
or ( endtime and endtime - GetTime() &amp;lt; 2 ) 
then return true end</Lua><RecastDelay>0</RecastDelay><Target>Target</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Lava Burst</Name><Default>false</Default><SpellID>51505</SpellID><Actions></Actions><Lua>if not PQR_IsMoving(1) 
or UnitBuffID(&amp;quot;player&amp;quot;,79206) 
then return true end</Lua><RecastDelay>0</RecastDelay><Target>Target</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Earth Shock</Name><Default>false</Default><SpellID>8042</SpellID><Actions></Actions><Lua>local ShieldStacks = select(4,UnitBuffID(&amp;quot;player&amp;quot;,324)) 

if ShieldStacks 
and ShieldStacks &amp;gt; 6 
and not IsControlKeyDown() 
then return true end</Lua><RecastDelay>0</RecastDelay><Target>Target</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Lightning Bolt</Name><Default>false</Default><SpellID>403</SpellID><Actions></Actions><Lua>return true</Lua><RecastDelay>0</RecastDelay><Target>Target</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Elemental Mastery</Name><Default>false</Default><SpellID>16166</SpellID><Actions></Actions><Lua>if UnitHealthMax(&amp;quot;target&amp;quot;) &amp;gt; UnitHealthMax(&amp;quot;player&amp;quot;)*10 
then return true end</Lua><RecastDelay>0</RecastDelay><Target>Target</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Call of the Elements</Name><Default>false</Default><SpellID>66842</SpellID><Actions></Actions><Lua>if UnitAffectingCombat(&amp;quot;player&amp;quot;) then

  local _,fire = GetTotemInfo(1) 
  local fireid = ( not UnitBuffID(&amp;quot;player&amp;quot;,61316) and not UnitBuffID(&amp;quot;player&amp;quot;,1459) ) and 8227 or 3599 
  local _,earth = GetTotemInfo(2) 
  local earthid = not UnitBuffID(&amp;quot;player&amp;quot;, 465) and 8071 or 8075 
  local _,water = GetTotemInfo(3) 
  local waterid = ( not UnitBuffID(&amp;quot;player&amp;quot;, 19740) and not UnitBuffID(&amp;quot;player&amp;quot;, 54424) ) and 5675 or 5394
  local _,air = GetTotemInfo(4) 
  local airid = ( not UnitBuffID(&amp;quot;player&amp;quot;, 53290) and not UnitBuffID(&amp;quot;player&amp;quot;, 55610) and ( UnitBuffID(&amp;quot;player&amp;quot;, 49868) or UnitBuffID(&amp;quot;player&amp;quot;, 24907) ) ) and 8512 or 3738 

  if fire == &amp;quot;&amp;quot; and earth == &amp;quot;&amp;quot; and water == &amp;quot;&amp;quot; and air == &amp;quot;&amp;quot; 
  then 
    SetMultiCastSpell(133,fireid)
    SetMultiCastSpell(134,earthid)
    SetMultiCastSpell(135,waterid)
    SetMultiCastSpell(136,airid)
    CastSpellByID(66842) 
    SmartTotems = true
    return true 
  end

  if fire == &amp;quot;&amp;quot; then SetMultiCastSpell(133,fireid) CastSpellByID(fireid) SmartTotems = true return true end
  if earth == &amp;quot;&amp;quot; then SetMultiCastSpell(134,earthid) CastSpellByID(earthid) SmartTotems = true return true end
  if water == &amp;quot;&amp;quot; then SetMultiCastSpell(135,waterid) CastSpellByID(waterid) SmartTotems = true return true end
  if air == &amp;quot;&amp;quot; then SetMultiCastSpell(136,airid) CastSpellByID(airid) SmartTotems = true return true end
  
end</Lua><RecastDelay>500</RecastDelay><Target>Target</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Assist Tank</Name><Default>false</Default><SpellID>0</SpellID><Actions></Actions><Lua>if GetNumPartyMembers() &amp;gt; 0 and not UnitInRaid(&amp;quot;player&amp;quot;) then

local heisthetank = nil

for i = 1, GetNumPartyMembers(), 1 do
  if UnitGroupRolesAssigned(&amp;quot;party&amp;quot;..tostring(i)) == &amp;quot;TANK&amp;quot; then heisthetank = &amp;quot;party&amp;quot;..tostring(i) end
end

if heisthetank 
and not UnitExists(&amp;quot;target&amp;quot;) 
and UnitAffectingCombat(heisthetank) 
and UnitAffectingCombat(heisthetank..&amp;quot;target&amp;quot;) 
and not UnitIsDead(heisthetank..&amp;quot;target&amp;quot;) 
and UnitCanAttack(&amp;quot;player&amp;quot;,heisthetank..&amp;quot;target&amp;quot;)
then TargetUnit(heisthetank..&amp;quot;target&amp;quot;) end

end</Lua><RecastDelay>0</RecastDelay><Target>Target</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Chain Lightning</Name><Default>false</Default><SpellID>421</SpellID><Actions></Actions><Lua>if ( IsLeftShiftKeyDown() or IsLeftControlKeyDown() )
and not GetCurrentKeyBoardFocus() 
then return true end</Lua><RecastDelay>0</RecastDelay><Target>Target</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Earthquake</Name><Default>false</Default><SpellID>61882</SpellID><Actions></Actions><Lua>if IsControlKeyDown() and not GetCurrentKeyBoardFocus() 
then return true end</Lua><RecastDelay>500</RecastDelay><Target>Click</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Fire Nova</Name><Default>false</Default><SpellID>1535</SpellID><Actions></Actions><Lua>if IsControlKeyDown() and not GetCurrentKeyBoardFocus() 
then return true end</Lua><RecastDelay>0</RecastDelay><Target>Target</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Totemic Recall</Name><Default>false</Default><SpellID>36936</SpellID><Actions></Actions><Lua>local _,fire = GetTotemInfo(1)
local _,earth = GetTotemInfo(2)
local _,water = GetTotemInfo(3)
local _,air = GetTotemInfo(4)


if SmartTotems and not UnitAffectingCombat(&amp;quot;player&amp;quot;) 
and fire ~= &amp;quot;Fire Elemental Totem&amp;quot; 
and earth ~= &amp;quot;Earth Elemental Totem&amp;quot; 
and water ~= &amp;quot;Mana Tide Totem&amp;quot; 
and ( fire ~= &amp;quot;&amp;quot; or earth ~= &amp;quot;&amp;quot; or water ~= &amp;quot;&amp;quot; or air ~= &amp;quot;&amp;quot; ) 
then 
  SmartTotems = false
  return true 
end</Lua><RecastDelay>0</RecastDelay><Target>Target</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Spiritwalker&amp;apos;s Grace</Name><Default>false</Default><SpellID>79206</SpellID><Actions></Actions><Lua>if PQR_IsMoving(1) 
and select(2,GetSpellCooldown(51505)) &amp;lt; 2
then return true end</Lua><RecastDelay>0</RecastDelay><Target>Target</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Blood Fury</Name><Default>false</Default><SpellID>33697</SpellID><Actions></Actions><Lua>if IsSpellKnown(33697) 
then return true end</Lua><RecastDelay>0</RecastDelay><Target>Target</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>USE: Gloves</Name><Default>false</Default><SpellID>0</SpellID><Actions></Actions><Lua>local _,cd,havecd = GetInventoryItemCooldown(&amp;quot;player&amp;quot;,10)

if cd == 0 and havecd == 1  
and UnitChannelInfo(&amp;quot;player&amp;quot;) == nil 
then 
  UseInventoryItem(10) 
  return true
end</Lua><RecastDelay>0</RecastDelay><Target>Target</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>USE: Trinket 1</Name><Default>false</Default><SpellID>0</SpellID><Actions></Actions><Lua>local _,cd,havecd = GetInventoryItemCooldown(&amp;quot;player&amp;quot;,13)

if cd == 0 and havecd == 1  
and UnitChannelInfo(&amp;quot;player&amp;quot;) == nil 
then 
  UseInventoryItem(13) 
  return true
end</Lua><RecastDelay>0</RecastDelay><Target>Target</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>USE: Trinket 2</Name><Default>false</Default><SpellID>0</SpellID><Actions></Actions><Lua>local _,cd,havecd = GetInventoryItemCooldown(&amp;quot;player&amp;quot;,14)

if cd == 0 and havecd == 1  
and UnitChannelInfo(&amp;quot;player&amp;quot;) == nil 
then 
  UseInventoryItem(14) 
  return true
end</Lua><RecastDelay>0</RecastDelay><Target>Target</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability></SHAMAN>