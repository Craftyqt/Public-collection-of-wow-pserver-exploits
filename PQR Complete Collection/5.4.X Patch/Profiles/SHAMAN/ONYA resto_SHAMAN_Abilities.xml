<?xml version="1.0" encoding="utf-8" ?><SHAMAN><Ability><Name>totems</Name><Default>false</Default><SpellID>0</SpellID><Actions></Actions><Lua>local DB = UnitBuffID(&amp;quot;player&amp;quot;,61316)
local AB = UnitBuffID(&amp;quot;player&amp;quot;,1459)
local _, WaterTotem = GetTotemInfo(3)
local _, FireTotem = GetTotemInfo(1)
local _, AirTotem = GetTotemInfo(4)
local _, EarthTotem = GetTotemInfo(2)
local MQ = UnitBuffID(&amp;quot;player&amp;quot;, 49868)
local MA = UnitBuffID(&amp;quot;player&amp;quot;, 24907)
local HP = UnitBuffID(&amp;quot;player&amp;quot;, 53290)
local IIT = UnitBuffID(&amp;quot;player&amp;quot;, 55610)
local DA = UnitBuffID(&amp;quot;player&amp;quot;, 465)
local ST = UnitBuffID(&amp;quot;player&amp;quot;, 8071)
local BoM = UnitBuffID(&amp;quot;player&amp;quot;, 19740)
local FI = UnitBuffID(&amp;quot;player&amp;quot;, 54424)

if FireTotem == &amp;quot;&amp;quot; and  AirTotem == &amp;quot;&amp;quot; and EarthTotem == &amp;quot;&amp;quot; and WaterTotem == &amp;quot;&amp;quot; and incombat == 1 and moving ==0  and member[lowest].health &amp;gt; ghwhealth then
  SilentCast(66842)
  return true
end

if not( FireTotem == &amp;quot;&amp;quot; and  AirTotem == &amp;quot;&amp;quot; and EarthTotem == &amp;quot;&amp;quot; and WaterTotem == &amp;quot;&amp;quot; and incombat == 1 and moving ==1) and member[lowest].health &amp;gt; ghwhealth then

if DB == nil and AB == nil  then
  SetMultiCastSpell (133,8227)
  if FireTotem == &amp;quot;&amp;quot; and incombat == 1  then
    SilentCast(8227)
    return true
  end
else
  SetMultiCastSpell (133,3599)
  if FireTotem == &amp;quot;&amp;quot; and incombat == 1  then
    SilentCast(3599)
    return true
  end
end

if MQ == nil and MA == nil  then
  SetMultiCastSpell (136,3738)
  if AirTotem == &amp;quot;&amp;quot; and incombat == 1  then
    SilentCast(3738)
    return true
  end
else
  if HP == nil and IIT == nil  then
    SetMultiCastSpell (136,8512)
    if AirTotem == &amp;quot;&amp;quot; and incombat == 1  then
      SilentCast(8512)
       return true        
    end
  end
end

if DA == nil then
  SetMultiCastSpell (134,8071)
  if EarthTotem == &amp;quot;&amp;quot; and incombat == 1  then
     SilentCast(8071)
    return true
  end
else
   SetMultiCastSpell (134,8075)
   if EarthTotem == &amp;quot;&amp;quot; and incombat == 1  then
       SilentCast(8075)
      return true
   end
end

if  BoM == nil and FI == nil  then
  SetMultiCastSpell (135,5675)
  if WaterTotem == &amp;quot;&amp;quot; and incombat == 1  then
     SilentCast(5675)
     return true
  end
else 
  SetMultiCastSpell (135,5394)
  if WaterTotem == &amp;quot;&amp;quot; and incombat == 1  then
      SilentCast(5394)
      return true
    end
end
end</Lua><RecastDelay>0</RecastDelay><Target>Target</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Earthliving Weapon</Name><Default>false</Default><SpellID>51730</SpellID><Actions></Actions><Lua>local hasEarthliving = GetWeaponEnchantInfo()

if hasEarthliving ~= nil or member[lowest].health &amp;lt; ghwhealth or not PQR_SpellAvailable(51730) then
 return false
else
  return true
end</Lua><RecastDelay>0</RecastDelay><Target>Player</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>-- init</Name><Default>false</Default><SpellID>0</SpellID><Actions></Actions><Lua>local ctrl = IsControlKeyDown()
local leftctrl = IsLeftControlKeyDown()
local rightctrl = IsRightControlKeyDown()
local shift = IsShiftKeyDown()
local leftshift = IsLeftShiftKeyDown()
local rightshift = IsRightShiftKeyDown()

hrkey = leftctrl or 0 -- healing rain keybind
lbspam = leftshift or 0 -- in combat lighting bolt spam keybind
oochealing = leftshift or 0 -- out of combat healing keybind

rthealth = 95 -- riptide
hwhealth = 95 -- healing wave
ghwhealth = 70 -- greater healing wave
hshealth = 30 -- healing surge
uehealth = 90 -- unleash elements
inttrinket = 70 -- use int trinkets when target health below this
nshealth= 15 -- nature&amp;apos;s swiftness + GHW
targethealth = 90  -- chain heal first target
hophealth = 95 --  chain heal secondary targets
hops = 2 -- chain heals jumps, doesn&amp;apos;t count the first target so if set to 3 will heal 4 people
onyacvars = {2894,2825,79206,2062,98008,36936,66842} -- spells to create macros for


if PQR_RotationStarted == true then
  PQR_RotationStarted = false
  ---PQR_ObjMgrPulseTimer = 100
  if GetPrimaryTalentTree() ==1 then PQR_SwapRotation(&amp;quot;Elemental (ONYA elemental)&amp;quot;) end
  if GetPrimaryTalentTree() ==2 then
     PQR_WriteToChat(&amp;quot;enhance spec not supported&amp;quot;)     
     PQR_StopRotation()
     return true
  end
  if GetCVar(&amp;quot;synchronizeMacros&amp;quot;) ~=0 then SetCVar(&amp;quot;synchronizeMacros&amp;quot;,0) end
  for k, val in pairs(onyacvars) do 
    local aval = &amp;quot;onya_&amp;quot;..tostring(val)
    if GetCVarBool(aval) then SetCVar(aval,nil) end
    local name = GetSpellInfo(val)
    if GetMacroInfo(name) ~= name then
      local mac = &amp;quot;#showtooltip &amp;quot;..name..&amp;quot;\\n/run if GetCVar\\(\\&amp;quot;&amp;quot;..aval..&amp;quot;\\&amp;quot;\\) == nil then RegisterCVar\\(\\&amp;quot;&amp;quot;..aval..&amp;quot;\\&amp;quot;\\,nil) end;SetCVar\\(\\&amp;quot;&amp;quot;..aval..&amp;quot;\\&amp;quot;\\,1)&amp;quot;
      CreateMacro(name,&amp;quot;INV_MISC_QUESTIONMARK&amp;quot;,mac, 1) 
    end
  end
  spelltocast = {}  
 
function DistanceBetweenUnits(unit1,unit2)
   if unit2 == unit1 then return 0 end
   local r = PQR_UnitDistance(unit1,unit2)
   return r
end
cursesfromevent = { }
Decurse = { 
--- Hour of Twilight
      ---102582, --- chains of frost
      102848, -- tentacle smash
      43415, -- freezing trap
      103363, -- Twilight Shear
      103151, -- Righteous Shear

--- End Time
      102057, -- Scorched
      101840, -- Molten Blast
      101412, -- Shriek of the Highborne

--- Dragon Soul
      105289, -- Shattered Ice
      108567, -- Shattered Ice
    ---  103434, --- disrupting shadows 
   ---   104599, --- disrupting shadows 
      109333, -- Frost Corruption
  ---    107629, --- boulder smash
      109423-- Shackles of Ice
}

function EventHandler(self, event, ...)
  if event == &amp;quot;COMBAT_LOG_EVENT_UNFILTERED&amp;quot; then
      if (select(2, ...) == &amp;quot;SPELL_CAST_SUCCESS&amp;quot; ) and
        bit.band(select(6, ...), COMBATLOG_OBJECT_AFFILIATION_MINE) == 1
      then
         local castspell =  select(12, ...)       
         for k,v in ipairs(spelltocast) do
            if castspell == v then table.remove(spelltocast,k) end
         end
      end
      if select(2, ...) == &amp;quot;SPELL_AURA_APPLIED&amp;quot;  and
         select(15, ...) == &amp;quot;DEBUFF&amp;quot; and
         bit.band(select(10, ...), COMBATLOG_OBJECT_AFFILIATION_OUTSIDER) ~= 8
      then
        local target = select(8, ...)
        local spell = select(12, ...)
        local spellname = select(13, ...)
        for k, val in pairs(Decurse) do 
           if val == spell  then 
              table.insert(cursesfromevent ,target)
              table.insert(cursesfromevent ,spell)
          end
       end
    end
  end
end

frame = CreateFrame(&amp;quot;FRAME&amp;quot;, &amp;quot;OurFrame&amp;quot;)
frame:RegisterEvent(&amp;quot;COMBAT_LOG_EVENT_UNFILTERED&amp;quot;)
frame:SetScript(&amp;quot;OnEvent&amp;quot;, EventHandler)

function GetDamageTarget()
 if UnitExists(&amp;quot;focus&amp;quot;) and IsSpellInRange(&amp;quot;Lightning Bolt&amp;quot;, &amp;quot;focus&amp;quot;) and not UnitIsDead(&amp;quot;focus&amp;quot;) then return (&amp;quot;focus&amp;quot;) end   
 if IsSpellInRange(&amp;quot;Lightning Bolt&amp;quot;, &amp;quot;target&amp;quot;) and not UnitIsDead(&amp;quot;target&amp;quot;)then return (&amp;quot;target&amp;quot;) end  
 for k,v in ipairs(tanks) do
    if IsSpellInRange(&amp;quot;Lightning Bolt&amp;quot;, member[v].name..&amp;quot;target&amp;quot;) 
        and not UnitIsDead(member[v].name..&amp;quot;target&amp;quot;) 
      then return (member[v].name..&amp;quot;target&amp;quot;) end
 end
end

function isvalidhealtarget(vtarget)
     if UnitInRange(vtarget) 
         and UnitIsDeadOrGhost(vtarget) == nil 
         and UnitIsVisible(vtarget) == 1
         and UnitHealth(vtarget) ~=0
         and UnitExists(vtarget)== 1
         and not PQR_IsOutOfSight(vtarget,1)
         and UnitIsConnected(vtarget) == 1
         and PQR_IsOutOfSight(vtarget) == false   
         and UnitIsCharmed(vtarget) == nil 
         and UnitCanCooperate(&amp;quot;player&amp;quot;,vtarget)
     then
        return true 
     else
        return false
     end
end

function SilentCast(scspell,sctarget) 
   local SFX = GetCVar(&amp;quot;Sound_EnableSFX&amp;quot;)	
   SetCVar(&amp;quot;Sound_EnableSFX&amp;quot;, 0)
   if sctarget ~= nil then
        CastSpellByID(scspell,sctarget)        
   end
   if sctarget == nil then
      CastSpellByID(scspell)       
   end
   SetCVar(&amp;quot;Sound_EnableSFX&amp;quot;, SFX)
end

end -- everything above here run once


manapercent = 100 * UnitPower(&amp;quot;player&amp;quot;) / UnitPowerMax(&amp;quot;player&amp;quot;)
mana = UnitPower(&amp;quot;player&amp;quot;) or 0
Spell, _, _, _, _, endTime = UnitCastingInfo(&amp;quot;player&amp;quot;)
member = {}
tanks = {}
myesbuff = nil
lowest = 1
rttarget = 1
chtargets = {}
chhops = {}
gooey = {}

local SwG = UnitBuffID(&amp;quot;player&amp;quot;, 79206)
local mf = UnitBuffID(&amp;quot;player&amp;quot;, 98734)
local plucked = UnitDebuffID(&amp;quot;player&amp;quot;, 97318)
if ((SwG ~= nil ) or not(PQR_IsMoving (0.5))  or (mf ~= nil ) or (plucked ~= nil )) then
 moving = 0
else 
  moving = 1
end

group = &amp;quot;party&amp;quot;
members = GetNumPartyMembers()+1
if GetNumRaidMembers() &amp;gt; 0 then
  group = &amp;quot;raid&amp;quot;
  members = GetNumRaidMembers()
end

if UnitIsDeadOrGhost(&amp;quot;player&amp;quot;) then return true end

for i = 1, members, 1 do
   member[i] = {}
   member[i].name = group..tostring(i) 
   if group == &amp;quot;party&amp;quot; and i == members then member[i].name = &amp;quot;player&amp;quot; end
   gooey[UnitGUID(member[i].name)] = member[i].name
   local myIncomingHeal = UnitGetIncomingHeals(member[i].name, &amp;quot;player&amp;quot;) or 0
   local allIncomingHeal = UnitGetIncomingHeals(member[i].name) or 0
   local otherin = 0
   if myIncomingHeal &amp;lt; allIncomingHeal then otherin = allIncomingHeal - myIncomingHeal  end
   -- if myIncomingHeal ~= allIncomingHeal and myIncomingHeal ~= 0 then 
   local memberin = UnitGetIncomingHeals(member[i].name) or 0
   
   member[i].health= 100 * (UnitHealth(member[i].name)+ memberin ) / UnitHealthMax(member[i].name)
   member[i].healthothers = 100 * (UnitHealth(member[i].name)+ otherin ) / UnitHealthMax(member[i].name)
   member[i].healthreal= 100 * UnitHealth(member[i].name) / UnitHealthMax(member[i].name)
   
   if isvalidhealtarget(member[i].name) then 
      if member[i].health &amp;lt; member[lowest].health then lowest = i end
      if UnitGroupRolesAssigned(member[i].name) == &amp;quot;TANK&amp;quot; then table.insert(tanks,i) end
      local hasES ,_,_,_,_,_,_,uc = UnitBuffID(member[i].name, 974) 
      if hasES then if uc == &amp;quot;player&amp;quot; then myesbuff = i  end end
      if member[i].health &amp;lt; targethealth and isvalidhealtarget(member[i].name) then table.insert(chtargets,i) end
      if member[i].health &amp;lt; hophealth then table.insert(chhops,i) end
      local hasrt ,_,_,_,_,_,_, unitCaster = UnitBuffID(member[i].name, 61295) 
      local hasmyrt = 0
      if hasrt then if unitCaster == &amp;quot;player&amp;quot; then hasmyrt = 1 end end
      if member[i].health &amp;lt; member[rttarget].health and
         isvalidhealtarget(member[i].name)
         and hasmyrt == 0
      then rttarget = i end
   end
end</Lua><RecastDelay>0</RecastDelay><Target>Target</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Lightning Bolt</Name><Default>false</Default><SpellID>0</SpellID><Actions></Actions><Lua>local lbtarget = GetDamageTarget()
local _, _, _, _, telluric = GetTalentInfo(3, 16)
if lbtarget ~= nil and moving == 0 and PQR_SpellAvailable(403) 
     and telluric &amp;gt; 0 then -- and PQR_UnitFacing(&amp;quot;player&amp;quot;,lbtarget) then
  SilentCast(403,lbtarget)
  return true
end</Lua><RecastDelay>0</RecastDelay><Target>Custom</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Riptide</Name><Default>false</Default><SpellID>0</SpellID><Actions></Actions><Lua>if PQR_SpellAvailable(61295) then
  if UnitExists(&amp;quot;focus&amp;quot;) then
    local _,_,_,_,_,_,ah = UnitBuffID(&amp;quot;focus&amp;quot;, 105284)
    local _,_,_,_,_,_,rt = UnitBuffID(&amp;quot;focus&amp;quot;, 61295)
    if isvalidhealtarget(&amp;quot;focus&amp;quot;) and ah &amp;lt; 6 and rt &amp;lt; 6 then
      SilentCast(61295,&amp;quot;focus&amp;quot;)
      return true
    end
  else
    for k,v in ipairs(tanks) do
      local _,_,_,_,_,_,ah = UnitBuffID(member[v].name, 105284)
      local _,_,_,_,_,_,rt = UnitBuffID(member[v].name, 61295)
      if ah == nil then ah = 0 end
      if rt == nil then rt = 0 end
      if isvalidhealtarget(member[v].name) and ah &amp;lt; 6 and rt &amp;lt; 6 then
        SilentCast(61295,member[v].name)
        return true
      end
    end
  end  
  if rttarget == nil then rttarget = 1 end
  if member[rttarget].health &amp;lt; rthealth then
    if isvalidhealtarget(member[rttarget].name) then  
       SilentCast(61295,member[rttarget].name)
        return true
     end
  end
end</Lua><RecastDelay>0</RecastDelay><Target>Custom</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Nature&amp;apos;s Swiftness</Name><Default>false</Default><SpellID>0</SpellID><Actions></Actions><Lua>if member[lowest].healthreal &amp;lt; nshealth and PQR_SpellAvailable(16188) then
  SpellStopCasting()
  SilentCast(16188)
end

local NS = UnitBuffID(&amp;quot;player&amp;quot;, 16188) 

if NS ~= nil and PQR_SpellAvailable(77472) then
  SilentCast(77472,member[lowest].name)
  return true
end</Lua><RecastDelay>0</RecastDelay><Target>Target</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Healing Rain</Name><Default>false</Default><SpellID>0</SpellID><Actions></Actions><Lua>local hrname = GetSpellInfo(73920)
local lbname = GetSpellInfo(403)
Spell, _, _, _, _, endTime = UnitCastingInfo(&amp;quot;player&amp;quot;)
if GetCurrentKeyBoardFocus() == nil and Spell ~= hrname and PQR_SpellAvailable(73920) and hrkey==1 then
  if Spell == lbname and hrkey == 1 then RunMacroText(&amp;quot;/stopcasting&amp;quot;) end
  SilentCast(73920)
  if SpellIsTargeting() then CameraOrSelectOrMoveStart() CameraOrSelectOrMoveStop() end  
  return true
end</Lua><RecastDelay>0</RecastDelay><Target>Target</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Purge</Name><Default>false</Default><SpellID>0</SpellID><Actions></Actions><Lua>local buff= {

-- Zul&amp;apos;Aman
       97987, -- Tectonic Plating
       43242, -- Blazing Haste
       43421, -- Lifebloom

--- End Time
      101891, -- Wail of the Dead
      102599 -- Void Shield
  }

if member[lowest].health &amp;gt; 50 then
  for i = 0, members, 1 do
    if i==0 then purgetarget = &amp;quot;target&amp;quot; else purgetarget = group..tostring(i)..&amp;quot;target&amp;quot; end
    if IsSpellInRange(&amp;quot;Purge&amp;quot;, purgetarget) then     
       for k,v in ipairs(buff) do
         if UnitBuffID(purgetarget,v) then
            SilentCast(370,purgetarget)
            return true
         end 
      end
     end
  end
end</Lua><RecastDelay>0</RecastDelay><Target>Target</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>UE</Name><Default>false</Default><SpellID>0</SpellID><Actions></Actions><Lua>local _,lcd =  GetSpellCooldown(73680)

if lcd == 0  and member[lowest].health &amp;lt; uehealth and moving == 1 and PQR_SpellAvailable(73680) then
  SilentCast(73680,member[lowest].name)
  return true
end</Lua><RecastDelay>0</RecastDelay><Target>Target</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Mana Tide</Name><Default>false</Default><SpellID>0</SpellID><Actions></Actions><Lua>if manapercent &amp;lt; 75  and incombat == 1 and PQR_SpellAvailable(16190) then
  SilentCast(16190)
  return true
end</Lua><RecastDelay>0</RecastDelay><Target>Player</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Greater Healing Wave</Name><Default>false</Default><SpellID>0</SpellID><Actions></Actions><Lua>if moving == 0 and PQR_SpellAvailable(77472) and isvalidhealtarget(member[lowest].name) and (member[lowest].health &amp;lt; ghwhealth ) then
  SilentCast(77472,member[lowest].name)
  return true
end</Lua><RecastDelay>0</RecastDelay><Target>Custom</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Healing Wave</Name><Default>false</Default><SpellID>0</SpellID><Actions></Actions><Lua>local searingplasmadebuffs = { 105479,109363,109364 }
local hassp = 0
for _,v in ipairs(searingplasmadebuffs) do
    if UnitDebuffID(member[lowest].name,v) then hassp = 1 end
end

if ( member[lowest].health &amp;lt; hwhealth or hassp ==1) and moving == 0  and isvalidhealtarget(member[lowest].name) and PQR_SpellAvailable(331) then
  SilentCast(331,member[lowest].name)
  return true
end</Lua><RecastDelay>0</RecastDelay><Target>Custom</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Chain Heal</Name><Default>false</Default><SpellID>0</SpellID><Actions></Actions><Lua>function IsInRange(u1,u2)
  local range = DistanceBetweenUnits(member[u1].name,member[u2].name)
  if range == nil then range = 100 end
  if range &amp;lt; 11.5  then
     return true
   else 
     return false
   end
end

function getDefHealth(unit)
   local hp = member[unit].health
   if UnitBuffID(member[unit].name, 974) then hp = hp - 5 end
    return (100 - hp)
end

function sortDefHealth(aUnit, anotherUnit)
    return getDefHealth(aUnit) &amp;gt; getDefHealth(anotherUnit)
end

function getnexthop(u)
 for nh = 1, table.maxn(chhops) do
   local onlist = 0
   for xxx = 1, table.maxn(nexthop) do
      if tostring(member[nexthop[xxx]].name) == tostring(member[chhops[nh]].name) then
        onlist = 1
      end
   end
   if nexthop[u] ~= nil and onlist == 0 then
     if IsInRange(nexthop[u],chhops [nh]) then return chhops[nh] end       
   end
 end
end

function findGoodTarget()
  if table.maxn(chtargets) ~=0 and table.maxn(chhops) &amp;gt;= hops then   
   table.sort(chtargets, sortDefHealth)  
   table.sort(chhops, sortDefHealth)
   for x = 1, table.maxn(chtargets) do
      nexthop = {}
      nexthop[1] = chtargets[x]
      for z = 1,hops do
       nexthop[z+1] = getnexthop(z)     
        if nexthop[(hops + 1)] ~= nil then
          return chtargets[x]
        end
        if nexthop[z] == nil then z = hops end
      end
   end
 end  
end

if PQR_SpellAvailable(1064) and spell ~= GetSpellInfo(1064)then
   local chtarget = findGoodTarget()
   if chtarget ~= nil and moving == 0 then
      SilentCast(1064,member[chtarget].name) 
      return true
   end
end</Lua><RecastDelay>0</RecastDelay><Target>Custom</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Water Shield</Name><Default>false</Default><SpellID>52127</SpellID><Actions></Actions><Lua>local WS = UnitBuffID(&amp;quot;player&amp;quot;, 52127) 
local ES = UnitBuffID(&amp;quot;player&amp;quot;, 974) 

if (member[lowest].health &amp;gt; ghwhealth ) and WS == nil and ES == nil and PQR_SpellAvailable(52127) then
    return true
end</Lua><RecastDelay>0</RecastDelay><Target>Player</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>SWG</Name><Default>false</Default><SpellID>0</SpellID><Actions></Actions><Lua>if PQR_IsMoving(1) == true and member[lowest].health &amp;lt;40 and moving == 1 and PQR_SpellAvailable (79206) then
  SilentCast(79206)
end</Lua><RecastDelay>0</RecastDelay><Target>Target</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>combat checker</Name><Default>false</Default><SpellID>0</SpellID><Actions></Actions><Lua>if IsMounted() or UnitBuffID(&amp;quot;player&amp;quot;,87959)  then return true end

incombat = 1
incom = 0

for i = 1, members, 1 do
   if UnitAffectingCombat(member[i].name) then incom = 1 end
end

if ooctimer == nil then ooctimer = 0 end
if incom == 1 then ooctimerstarted = 0 end
if incom ~=1 and ooctimerstarted == 0 then
   ooctimer = GetTime()
   ooctimerstarted = 1
 end
 if  (GetTime() - ooctimer &amp;gt; 5) and incom ~= 1 then incombat = 0 end</Lua><RecastDelay>0</RecastDelay><Target>Target</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>canceltotems</Name><Default>false</Default><SpellID>0</SpellID><Actions></Actions><Lua>local _, WaterTotem = GetTotemInfo(3)
local _, FireTotem = GetTotemInfo(1)
local _, AirTotem = GetTotemInfo(4)
local _, EarthTotem = GetTotemInfo(2)
if WaterTotem ~=&amp;quot;Mana Tide Totem&amp;quot; 
   and incombat ~=1 and PQR_SpellAvailable(36936)
   and ((FireTotem ~= &amp;quot;&amp;quot;) or  (AirTotem ~= &amp;quot;&amp;quot;) or (EarthTotem ~= &amp;quot;&amp;quot;) or (WaterTotem ~= &amp;quot;&amp;quot;)) then
       SilentCast(36936)
 end</Lua><RecastDelay>0</RecastDelay><Target>Target</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Cancel LB</Name><Default>false</Default><SpellID>0</SpellID><Actions></Actions><Lua>local et = endTime or 0
local _, _, _, powerCost= GetSpellInfo(331)
local lbname = GetSpellInfo(403)
if (member[lowest].health &amp;lt; ghwhealth) 
  and isvalidhealtarget(member[lowest].name)
  and ((et/1000 - GetTime()) &amp;gt; 0.5)
  and  lbspam  == 0
  and mana &amp;gt; powerCost ---if we can&amp;apos;t even cast healing wave we shouldn&amp;apos;t cancel lb
then
  if Spell == lbname then
     RunMacroText(&amp;quot;/stopcasting&amp;quot;)
     return true
  end
end</Lua><RecastDelay>0</RecastDelay><Target>Target</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Earth Shield</Name><Default>false</Default><SpellID>0</SpellID><Actions></Actions><Lua>if PQR_SpellAvailable(974) then
  if (member[lowest].health &amp;gt; ghwhealth ) then
    if UnitExists(&amp;quot;focus&amp;quot;) and isvalidhealtarget(&amp;quot;focus&amp;quot;) and not UnitBuffID(&amp;quot;focus&amp;quot;, 974) then
      SilentCast(974,&amp;quot;focus&amp;quot;)
      return true
    end
    if table.maxn(tanks) &amp;gt; 0 then
      if myesbuff == nil then
       for k,v in ipairs(tanks) do
        if isvalidhealtarget(member[v].name) and UnitThreatSituation(member[v].name) == 3 
           and isvalidhealtarget(member[v].name) and not(UnitBuffID(member[v].name, 974)) then
         SilentCast(974,member[v].name)
         return true
        end
      end
      if myesbuff ~= nil and UnitThreatSituation(member[myesbuff].name) ~= 3 then
        for k,v in ipairs(tanks) do
          if isvalidhealtarget(member[v].name) and UnitThreatSituation(member[v].name) == 3 
             and isvalidhealtarget(member[v].name) and not(UnitBuffID(member[v].name, 974)) then
            SilentCast(974,member[v].name)
            return true
          end
        end
      end 
    end -- TODO if we have no tanks cast it on lowest person with aggro
  end
 end
end</Lua><RecastDelay>0</RecastDelay><Target>Custom</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>trinkets -- int</Name><Default>false</Default><SpellID>0</SpellID><Actions></Actions><Lua>if member[lowest].health &amp;lt; inttrinket and incombat ==1  then
   if GetInventoryItemCooldown(&amp;quot;player&amp;quot;,13) == 0 then
      UseInventoryItem(13) 
      return true
    end
   if GetInventoryItemCooldown(&amp;quot;player&amp;quot;,14) == 0 then
     UseInventoryItem(14)
     return true
   end
end</Lua><RecastDelay>0</RecastDelay><Target>Target</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>trinkets -- spirit</Name><Default>false</Default><SpellID>0</SpellID><Actions></Actions><Lua>if manapercent &amp;lt; 85 and incombat ==1  then
   if GetInventoryItemCooldown(&amp;quot;player&amp;quot;,13) == 0 then UseInventoryItem(13) end
   if GetInventoryItemCooldown(&amp;quot;player&amp;quot;,14) == 0 then UseInventoryItem(14) end
end</Lua><RecastDelay>0</RecastDelay><Target>Target</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>ooc pause</Name><Default>false</Default><SpellID>0</SpellID><Actions></Actions><Lua>local gotloot = GetNumLootItems()
if gotloot &amp;gt; 0 then 
   for i = 1,gotloot do
     LootSlot(i)     
   end
   return true
end

local inc = 0
for k,v in ipairs(tanks) do
    if isvalidhealtarget(member[v].name)  and UnitAffectingCombat(member[v].name) then inc = 1 end
end

if (UnitAffectingCombat(&amp;quot;player&amp;quot;) == nil and oochealing == 0 and inc == 0) then 
   return true 
end

if UnitAffectingCombat(&amp;quot;player&amp;quot;) and lbspam == 1 then
   local lbtarget = GetDamageTarget()
   if lbtarget ~= nil then
       SilentCast(403,lbtarget)
       return true
   end
end</Lua><RecastDelay>0</RecastDelay><Target>Target</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>cancel ghw</Name><Default>false</Default><SpellID>0</SpellID><Actions></Actions><Lua>local ghwname = GetSpellInfo(77472)
if (member[lowest].healthothers &amp;gt; 90)  and Spell == ghwname then
     RunMacroText(&amp;quot;/stopcasting&amp;quot;)
     return true
end</Lua><RecastDelay>0</RecastDelay><Target>Target</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Hex</Name><Default>false</Default><SpellID>0</SpellID><Actions></Actions><Lua>local inRange = 0
local _,lcd =  GetSpellCooldown(51514)

if lcd == 0 and UnitExists(&amp;quot;focus&amp;quot;) and UnitIsVisible(&amp;quot;focus&amp;quot;) and UnitIsEnemy(&amp;quot;player&amp;quot;,&amp;quot;focus&amp;quot;) then
   inRange = IsSpellInRange(&amp;quot;Hex&amp;quot;,&amp;quot;focus&amp;quot;)
end

if inRange==1 then
  SilentCast(51514,&amp;quot;focus&amp;quot;)
  return true
end</Lua><RecastDelay>0</RecastDelay><Target>Focus</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Cleanse Spirit</Name><Default>false</Default><SpellID>0</SpellID><Actions></Actions><Lua>if table.maxn (cursesfromevent) ~= 0 then
   local aaa= gooey[cursesfromevent[1]]
   local dc = 0
   if aaa ~= nil then
      for i=1,40 do
        local D, _, _, _,_,_,_,_,_,_,sid = UnitDebuff(aaa,i)
        if D then if sid == cursesfromevent[2] then dc = 1 end end
      end
    end
    if dc == 0 then
       table.remove(cursesfromevent,1)
       table.remove(cursesfromevent,1)
    else
     if isvalidhealtarget(aaa) and PQR_SpellAvailable(51886) then
       SilentCast(51886,aaa)
       return true
     end
  end
end</Lua><RecastDelay>0</RecastDelay><Target>Custom</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Healing Surge</Name><Default>false</Default><SpellID>0</SpellID><Actions></Actions><Lua>if moving == 0 and PQR_SpellAvailable(8004) and isvalidhealtarget(member[lowest].name) and (member[lowest].health &amp;lt; hshealth ) then
  SilentCast(8004,member[lowest].name)
  return true
end</Lua><RecastDelay>0</RecastDelay><Target>Custom</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>Keybinds</Name><Default>false</Default><SpellID>0</SpellID><Actions></Actions><Lua>local function ProcessKB(sid)
   local cv = &amp;quot;onya_&amp;quot;..sid
   local dur,lcd =  GetSpellCooldown(sid)
   local name = GetSpellInfo(sid)
   local d= floor( dur - GetTime()+lcd)
   if GetCVarBool(cv) then
     SetCVar(cv,nil)
     if (d &amp;lt;10)or (lcd &amp;lt; 1.5)  then
       table.insert(spelltocast,sid)
       PQR_WriteToChat(name) 
     else
       if d &amp;gt; 10 then
         PQR_WriteToChat(name..&amp;quot; off cooldown in &amp;quot;..d..&amp;quot; seconds&amp;quot;)
       end
     end
   end
end

for k, val in pairs(onyacvars) do 
  ProcessKB(val)
end

for k,v in ipairs(spelltocast) do
  local dur,lcd =  GetSpellCooldown(v)
  if lcd &amp;lt; 1.5 and IsUsableSpell(v) then
   SilentCast(v)
   return true
  end  
end</Lua><RecastDelay>0</RecastDelay><Target>Target</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability><Ability><Name>--- Special Event</Name><Default>false</Default><SpellID>0</SpellID><Actions></Actions><Lua>---copied from team nova
-- Edited with Mentally&amp;apos;s Code
-- Fading Light
local FadingLight = {110070, 105925, 109075, 110079, 110069, 110070, 110080, 110068, 110078}
for i,v in ipairs(FadingLight) do
	if select(7,UnitDebuffID(&amp;quot;player&amp;quot;, v)) and select(7,UnitDebuffID(&amp;quot;player&amp;quot;, v)) - GetTime() &amp;lt; 2 then
			RunMacroText(&amp;quot;/click ExtraActionButton1&amp;quot;)
	end
end

-- Hour of Twilight
local HoT,_,_,_,_,timer = UnitCastingInfo(&amp;quot;boss1&amp;quot;)
local HourOfTwilight = {109415, 106371, 109416, 109415, 109417}
	
for i,v in ipairs(HourOfTwilight) do
	if HoT == GetSpellInfo(v) and timer/1000 - GetTime() &amp;lt; 2 then
		RunMacroText(&amp;quot;/click ExtraActionButton1&amp;quot;)
	end
end

-- Try to aim on Darkmoon Faerie Cannon
local canontime = select(7,UnitBuffID(&amp;quot;player&amp;quot;,102116))
if canontime and canontime - GetTime() &amp;lt; 1.07 then CancelUnitBuff(&amp;quot;player&amp;quot;,&amp;quot;Magic Wings&amp;quot;) end
-- Code provided by Kickmydog
-- Avoid Fragmentation on Madness
local tentacledeath = select(7,UnitDebuffID(&amp;quot;player&amp;quot;,109597))
if tentacledeath and tentacledeath - GetTime() &amp;lt; 0.7 then RunMacroText(&amp;quot;/click ExtraActionButton1&amp;quot;) end

--- xepler lightwell
local LightwellName = &amp;quot;Lightwell&amp;quot;
local hp = UnitHealth(&amp;quot;player&amp;quot;) / UnitHealthMax(&amp;quot;player&amp;quot;) * 100
local sLightwell = UnitBuffID(&amp;quot;player&amp;quot;, 7001)
local sDeepCorruption = UnitDebuffID(&amp;quot;player&amp;quot;, 108220)
if PQR_LightwellTimeout == nil then
    PQR_LightwellTimeout = 0
end

if hp &amp;lt; 90 and sLightwell == nil then
    if PQR_LightwellTimeout &amp;lt; GetTime() then
        if sDeepCorruption == nil then
            PQR_LightwellTimeout = GetTime() + 1
            InteractUnit(LightwellName)
        end
    end
end
--- InteractUnit(&amp;quot;Gift of Life&amp;quot;)
--- InteractUnit(&amp;quot;Essence of Dreams&amp;quot;)
--- InteractUnit(&amp;quot;Source of Magic&amp;quot;)</Lua><RecastDelay>0</RecastDelay><Target>Target</Target><CancelChannel>False</CancelChannel><SkipUnknown>True</SkipUnknown></Ability></SHAMAN>