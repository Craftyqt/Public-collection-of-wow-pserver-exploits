-- PQInterface Settings
local keybinds = {
                name    = "ELEMENTAL HOTKEYS",
                author  = "Mavmins",
                hotkeys = {
                
           	{	name	= "AoE Mode Toggle",
				enable	= true,
				hotkeys	= {'ls'},
			},
           	{	name	= "AoE Key Hold",
				enable	= true,
				hotkeys	= {'ls'},
			},
	      	{	name	= "Cleave Mode Toggle",
				enable	= false,
				hotkeys	= {'ls'},
			},
           	{	name	= "Cleave Key Hold",
				enable	= false,
				hotkeys	= {'ls'},
			},
			{	name	= "Pause Rotation",
				enable	= false,
				hotkeys	= {'rs'},
			},
			{	name	= "Pause Key Hold",
				enable	= true,
				hotkeys	= {'rs'},
			},
			{	name	= "Offensive CD Toggle",
				enable	= true,
				hotkeys	= {'rs'},
			},
			{	name	= "Offensive CD Key Hold",
				enable	= false,
				hotkeys	= {'rs'},
			},
			{	name	= "Heroism",
				enable	= false,
				hotkeys	= {'ls'},
			},
			{	name	= "Ascendance",
				enable	= false,
				hotkeys	= {'ls'},
			},
			{	name	= "Stormlash Totem",
				enable	= false,
				hotkeys	= {'la'},
			},
			{	name	= "Fire Elemental Totem",
				enable	= false,
				hotkeys	= {'lc'},
			},
			{	name	= "Earth Elemental Totem",
				enable	= false,
				hotkeys	= {'ra'},
			},
			{	name	= "Thunderstorm",
				enable	= false,
				hotkeys	= {'rs'},
			},
			{	name	= "Earthquake",
				enable	= false,
				hotkeys	= {'rs'},
			},
			{	name	= "Spiritwalkers Grace",
				enable	= false,
				hotkeys	= {'rc'},
			},
			{	name	= "Stone Bulwark Totem",
				enable	= false,
				hotkeys	= {'rs'},
			},
			{	name	= "Astral Shift",
				enable	= false,
				hotkeys	= {'rs'},
			},
			{	name	= "Shamanistic Rage",
				enable	= false,
				hotkeys	= {'rs'},
			},
			{	name	= "Elemental Mastery",
				enable	= false,
				hotkeys	= {'rs'},
			},
			{	name	= "Ancestral Swiftness",
				enable	= false,
				hotkeys	= {'rs'},
			},
			{	name	= "Hex Mouseover",
				enable	= false,
				hotkeys	= {'rs'},
			},
			{	name	= "Bind Elemental Mouseover",
				enable	= false,
				hotkeys	= {'rs'},
			},
			{	name	= "Purge Target",
				enable	= false,
				hotkeys	= {'rs'},
			},
			{	name	= "Wind Shear Target",
				enable	= false,
				hotkeys	= {'rs'},
			},
			{	name	= "Cleanse Spirit Mouseover",
				enable	= true,
				hotkeys	= {'rs'},
			},
			{	name	= "Tremor Totem",
				enable	= false,
				hotkeys	= {'rs'},
			},
			{	name	= "Grounding Totem",
				enable	= false,
				hotkeys	= {'rs'},
			},
			{	name	= "Capacitor Totem",
				enable	= false,
				hotkeys	= {'rs'},
			},
			{	name	= "Windwalk Totem",
				enable	= false,
				hotkeys	= {'rs'},
			},
			{	name	= "Earthbind Totem",
				enable	= false,
				hotkeys	= {'rs'},
			},
			{	name	= "Magma Totem",
				enable	= false,
				hotkeys	= {'rs'},
			},
			{	name	= "Totemic Recall",
				enable	= false,
				hotkeys	= {'rs'},
			},
			{	name	= "Totemic Projection",
				enable	= false,
				hotkeys	= {'rs'},
			},
			{	name	= "Ancestral Guidance",
				enable	= false,
				hotkeys	= {'rs'},
			},
			{	name	= "Healing Tide Totem",
				enable	= false,
				hotkeys	= {'rs'},
			},
			{	name	= "Healing Stream Totem",
				enable	= false,
				hotkeys	= {'rs'},
			},
			{	name	= "Healing Rain",
				enable	= false,
				hotkeys	= {'rs'},
			},
			{	name	= "Chain Heal Mouseover",
				enable	= false,
				hotkeys	= {'rs'},
			},
		},
	}

local functions = {
                name    = "ELEMENTAL FUNCTIONS",
                author  = "Mavmins",
                abilities = {
			{ 	name	= "Chat Notifications",
				tooltip	= "Show AOE / Single Target or Auto / Manual ROF in Chat Window",
				enable	= true,
				newSection  = true,
			},
			{ 	name	= "Enable Self Healing",
				tooltip	= "Enables profile using healing surge on self",
				enable	= true,
				newSection  = true,
			},
			{ 	name	= "Auto Healing Surge",
				enable	= false,
				widget	= { type = "numBox",
					value	= 50,
					step	= 5,
					tooltip	= "Set Healing Surge Threshold.",
				},
			},
			{ 	name	= "Auto Healing Stream Totem ",
				enable	= true,
				widget	= { type = "numBox",
					value	= 25,
					step	= 5,
					tooltip	= "Set automatichealing tide totem usage.",
				},
			},		
			{ 	name	= "Auto Healing Tide Totem ",
				enable	= true,
				widget	= { type = "numBox",
					value	= 25,
					step	= 5,
					tooltip	= "Set automatichealing tide totem usage.",
				},
			},
			{ 	name	= "Auto Ancestral Guidance",
				enable	= false,
				widget	= { type = "numBox",
					value	= 50,
					step	= 5,
					tooltip	= "Set automatic Mortal Coil usage.",
				},
			},
			{ 	name	= "Healthstone",
				enable	= true,
				widget	= { type = "numBox",
					value	= 60,
					step	= 5,
					tooltip	= "Set automatic Healthstone usage.",
				},
			},
			{ 	name	= "Auto Ascendance",
				tooltip	= "Automatic Potion usage under Heroism.",
				enable	= false,
				newSection  = true,
			},
			{ 	name	= "Auto Stormlash Totem",
				tooltip	= "Auto Stormlash totem when off CD",
				enable	= false,
			},
			{ 	name	= "Auto Fire Elemental Totem",
				tooltip	= "Auto Fire elemental totem when off CD",
				enable	= false,
			},
			{ 	name	= "Auto Earth Elemental Totem",
				tooltip	= "Auto Earth Elemental totem when off CD",
				enable	= false,
			},
			{ 	name	= "Auto Elemental Mastery",
				tooltip	= "Auto Elemental Mastery",
				enable	= false,
			},
			{ 	name	= "Auto Ancestral Swiftness",
				tooltip	= "Auto Ancestral Swiftness on Lave Burst",
				enable	= false,
			},
			{ 	name	= "Auto Racials",
				tooltip	= "Automatic Racial usage under Heroism.",
				enable	= true,
			},
			{ 	name	= "Auto Potion",
				tooltip	= "Automatic Jade Serpent usage under Heroism.",
				enable	= true,
			},
			{ 	name	= "Engineer CDs",
				tooltip	= "Automatic use synapse springs.",
				enable	= false,
			},
			{ 	name	= "Auto Stone Bulwark Totem",
				enable	= true,
				newSection  = true,
				widget	= { type = "numBox",
					value	= 50,
					step	= 5,
					tooltip	= "Set automatic stone bulwark usage.",
				},
			},
			{ 	name	= "Auto Astral Shift",
				enable	= true,
				widget	= { type = "numBox",
					value	= 50,
					step	= 5,
					tooltip	= "Set automatic Astral Shift usage.",
				},
			},
			{ 	name	= "Auto Shamanistic Rage",
				enable	= true,
				widget	= { type = "numBox",
					value	= 50,
					step	= 5,
					tooltip	= "Set automatic Shamanistic Rage usage.",
				},
			},
			{ 	name	= "Auto Cleanse Spirit Self",
				tooltip	= "Automatic curse remove on self.",
				enable	= true,
			},
			{ 	name	= "Auto Spiritwalkers Grace",
				tooltip	= "Enable/Disable Auto spirit walkers grace under ascendance.",
				enable	= true,
				newSection  = true,
			},
			{ 	name	= "Auto Purge",
				tooltip	= "Auto purge on target.",
				enable	= true,
			},
			{ 	name	= "Auto Wind Shear",
				tooltip	= "Auto interrupt on target.",
				enable	= true,
			},
			{ 	name	= "Auto Thunderstorm",
				enable	= true,
				widget	= { type = "numBox",
					value	= 50,
					step	= 5,
					tooltip	= "Auto thunderstorm at set mana threshold.",
				},
			},
			{ 	name	= "Auto Flame Shock Focus",
				tooltip	= "Enable/Disable Autoflame shock on focus target.",
				enable	= true,
			},
			{ 	name	= "Auto Totem Reposition",
				tooltip	= "Enable/Disable Autoflame totem range check.",
				enable	= true,
			},
			{ 	name	= "Enable Cancel Cast",
				enable	= true,
				widget	= { type = "numBox",
					value	= 25,
					step	= 1,
					tooltip	= "Enable/Disable Cancelling of Lightning Bolt under value% cast when Lava Surge Procs",
				},
			},
			{ 	name	= "Auto Disable CDs OOC",
				tooltip	= "Disable USE_CDS out of combat.",
				enable	= false,
			},
			{ 	name	= "Auto Totem Pickup OOC",
				tooltip	= "recovers totems out of combat",
				enable	= false,
			},
                },
        }
        
	MAVMINS_ELEMENTAL = PQI:AddRotation(keybinds)
	MAVMINS_ELEMENTAL = PQI:AddRotation(functions)

-- GetSpellCD will return actual Timer before we can use the ability, 0 if the ability is ready. 
GetSpellCD = nil
function GetSpellCD(MySpell)
    if GetSpellCooldown(GetSpellInfo(MySpell)) == nil then
        return 0
    else
        local Start ,CD = GetSpellCooldown(MySpell)
        local MyCD = Start + CD - GetTime()
        return MyCD
    end
end 

  -- Checks if our Cleanse will have a valid Debuff to Cleanse
  function ValidDispel(t)
  	local HasValidDispel = false
  	local i = 1
  	local debuff = UnitDebuff(t, i)
  	while debuff do
  		local debuffType = select(5, UnitDebuff(t, i))
  		local debuffName = select(1, UnitDebuff(t, i))
  		if debuffType == "Curse" then
  			if debuffName == "Hex"
  				or debuffName == "Curse of the Elements"
  				or debuffName == "Curse of Tongues"
  				or debuffName == "Curse of Weakness"
  				or debuffName == "Curse of Exhaustion" then
	  			HasValidDispel = true
	  		end
  		end
  		i = i + 1
  		debuff = UnitDebuff(t, i)
  	end
  	return HasValidDispel
  end
  
  
 ------------------COKX LOS CHECK--------------------------------
if not tLOS then tLOS={} end
if not fLOS then fLOS=CreateFrame("Frame") end

	function LineOfSight(target)
		local updateRate=0.5
		fLOS:RegisterEvent("COMBAT_LOG_EVENT_UNFILTERED")
		function fLOSOnEvent(self,event,...)
			if event=="COMBAT_LOG_EVENT_UNFILTERED" then
				local cLOG={...}
				if cLOG[2]=="SPELL_CAST_FAILED" then
					local player=UnitGUID("player") or ""
					if cLOG[4]==player then 
						if cLOG[15]==SPELL_FAILED_LINE_OF_SIGHT then
							tinsert(tLOS,{unit=target,time=GetTime()})
						end
					end
				else
					table.sort(tLOS,function(x,y) return x.time>y.time end)
				end
			end
		end
		fLOS:SetScript("OnEvent",fLOSOnEvent)
		for i=1,#tLOS do
			if tLOS[i].unit==target then
				return true
			end
		end
 end
--------------------------------------------------
--------------------------------------------------