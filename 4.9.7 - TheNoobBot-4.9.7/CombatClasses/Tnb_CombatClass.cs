/*
* CombatClass for TheNoobBot
* Credit : Vesper, Neo2003, Dreadlocks
* Thanks you !
*/

using System;
using System.IO;
using System.Reflection;
using System.Threading;
using System.Windows.Forms;
using nManager.Helpful;
using nManager.Wow;
using nManager.Wow.Bot.Tasks;
using nManager.Wow.Class;
using nManager.Wow.Enums;
using nManager.Wow.Helpers;
using nManager.Wow.ObjectManager;
using Timer = nManager.Helpful.Timer;

// ReSharper disable EmptyGeneralCatchClause
// ReSharper disable ObjectCreationAsStatement

public class Main : ICombatClass
{
    internal static float InternalRange = 5.0f;
    internal static float InternalAggroRange = 5.0f;
    internal static bool InternalLoop = true;

    #region ICombatClass Members

    public float AggroRange
    {
        get { return InternalAggroRange; }
    }

    public float Range
    {
        get { return InternalRange; }
        set { InternalRange = value; }
    }

    public void Initialize()
    {
        Initialize(false);
    }

    public void Dispose()
    {
        Logging.WriteFight("Combat system stopped.");
        InternalLoop = false;
    }

    public void ShowConfiguration()
    {
        Directory.CreateDirectory(Application.StartupPath + "\\CombatClasses\\Settings\\");
        Initialize(true);
    }

    public void ResetConfiguration()
    {
        Directory.CreateDirectory(Application.StartupPath + "\\CombatClasses\\Settings\\");
        Initialize(true, true);
    }

    #endregion

    public void Initialize(bool configOnly, bool resetSettings = false)
    {
        try
        {
            if (!InternalLoop)
                InternalLoop = true;
            Logging.WriteFight("Loading combat system.");
            WoWSpecialization wowSpecialization = ObjectManager.Me.WowSpecialization(true);
            switch (ObjectManager.Me.WowClass)
            {
                    #region DeathKnight Specialisation checking

                case WoWClass.DeathKnight:

                    if (wowSpecialization == WoWSpecialization.DeathknightBlood)
                    {
                        if (configOnly)
                        {
                            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Deathknight_Blood.xml";
                            var currentSetting = new DeathknightBlood.DeathknightBloodSettings();
                            if (File.Exists(currentSettingsFile) && !resetSettings)
                            {
                                currentSetting = Settings.Load<DeathknightBlood.DeathknightBloodSettings>(currentSettingsFile);
                            }
                            currentSetting.ToForm();
                            currentSetting.Save(currentSettingsFile);
                        }
                        else
                        {
                            Logging.WriteFight("Loading Deathknight Blood Combat class...");
                            InternalRange = 5.0f;
                            EquipmentAndStats.SetPlayerSpe(WoWSpecialization.DeathknightBlood);
                            new DeathknightBlood();
                        }
                        break;
                    }
                    if (wowSpecialization == WoWSpecialization.DeathknightUnholy)
                    {
                        if (configOnly)
                        {
                            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Deathknight_Unholy.xml";
                            var currentSetting = new DeathknightUnholy.DeathknightUnholySettings();
                            if (File.Exists(currentSettingsFile) && !resetSettings)
                            {
                                currentSetting = Settings.Load<DeathknightUnholy.DeathknightUnholySettings>(currentSettingsFile);
                            }
                            currentSetting.ToForm();
                            currentSetting.Save(currentSettingsFile);
                        }
                        else
                        {
                            Logging.WriteFight("Loading Deathknight Unholy Combat class...");
                            InternalRange = 5.0f;
                            EquipmentAndStats.SetPlayerSpe(WoWSpecialization.DeathknightUnholy);
                            new DeathknightUnholy();
                        }
                        break;
                    }
                    if (wowSpecialization == WoWSpecialization.DeathknightFrost)
                    {
                        if (configOnly)
                        {
                            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Deathknight_Frost.xml";
                            var currentSetting = new DeathknightFrost.DeathknightFrostSettings();
                            if (File.Exists(currentSettingsFile) && !resetSettings)
                            {
                                currentSetting = Settings.Load<DeathknightFrost.DeathknightFrostSettings>(currentSettingsFile);
                            }
                            currentSetting.ToForm();
                            currentSetting.Save(currentSettingsFile);
                        }
                        else
                        {
                            Logging.WriteFight("Loading Deathknight Frost Combat class...");
                            InternalRange = 5.0f;
                            EquipmentAndStats.SetPlayerSpe(WoWSpecialization.DeathknightFrost);
                            new DeathknightFrost();
                        }
                        break;
                    }
                    if (configOnly)
                    {
                        MessageBox.Show(@"Your specification haven't be found, loading Deathknight Apprentice Settings");
                        string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Deathknight_Apprentice.xml";
                        var currentSetting = new DeathknightApprentice.DeathknightApprenticeSettings();
                        if (File.Exists(currentSettingsFile) && !resetSettings)
                        {
                            currentSetting = Settings.Load<DeathknightApprentice.DeathknightApprenticeSettings>(currentSettingsFile);
                        }
                        currentSetting.ToForm();
                        currentSetting.Save(currentSettingsFile);
                    }
                    else
                    {
                        Logging.WriteFight("No specialisation detected.");
                        Logging.WriteFight("Loading Deathknight Apprentice Combat class...");
                        InternalRange = 5.0f;
                        EquipmentAndStats.SetPlayerSpe(WoWSpecialization.DeathknightUnholy);
                        new DeathknightApprentice();
                    }
                    break;

                    #endregion

                    #region Mage Specialisation checking

                case WoWClass.Mage:

                    if (wowSpecialization == WoWSpecialization.MageArcane)
                    {
                        if (configOnly)
                        {
                            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Mage_Arcane.xml";
                            var currentSetting = new MageArcane.MageArcaneSettings();
                            if (File.Exists(currentSettingsFile) && !resetSettings)
                            {
                                currentSetting = Settings.Load<MageArcane.MageArcaneSettings>(currentSettingsFile);
                            }
                            currentSetting.ToForm();
                            currentSetting.Save(currentSettingsFile);
                        }
                        else
                        {
                            Logging.WriteFight("Loading Mage Arcane Combat class...");
                            InternalRange = 30.0f;
                            EquipmentAndStats.SetPlayerSpe(WoWSpecialization.MageArcane);
                            new MageArcane();
                        }
                        break;
                    }
                    if (wowSpecialization == WoWSpecialization.MageFire)
                    {
                        if (configOnly)
                        {
                            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Mage_Fire.xml";
                            var currentSetting = new MageFire.MageFireSettings();
                            if (File.Exists(currentSettingsFile) && !resetSettings)
                            {
                                currentSetting = Settings.Load<MageFire.MageFireSettings>(currentSettingsFile);
                            }
                            currentSetting.ToForm();
                            currentSetting.Save(currentSettingsFile);
                        }
                        else
                        {
                            Logging.WriteFight("Loading Mage Fire Combat class...");
                            InternalRange = 30.0f;
                            EquipmentAndStats.SetPlayerSpe(WoWSpecialization.MageFire);
                            new MageFire();
                        }
                        break;
                    }
                    if (wowSpecialization == WoWSpecialization.MageFrost)
                    {
                        if (configOnly)
                        {
                            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Mage_Frost.xml";
                            var currentSetting = new MageFrost.MageFrostSettings();
                            if (File.Exists(currentSettingsFile) && !resetSettings)
                            {
                                currentSetting = Settings.Load<MageFrost.MageFrostSettings>(currentSettingsFile);
                            }
                            currentSetting.ToForm();
                            currentSetting.Save(currentSettingsFile);
                        }
                        else
                        {
                            Logging.WriteFight("Loading Mage Frost Combat class...");
                            InternalRange = 30.0f;
                            EquipmentAndStats.SetPlayerSpe(WoWSpecialization.MageFrost);
                            new MageFrost();
                        }
                        break;
                    }
                    if (configOnly)
                    {
                        string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Mage_Frost.xml";
                        var currentSetting = new MageFrost.MageFrostSettings();
                        if (File.Exists(currentSettingsFile) && !resetSettings)
                        {
                            currentSetting = Settings.Load<MageFrost.MageFrostSettings>(currentSettingsFile);
                        }
                        currentSetting.ToForm();
                        currentSetting.Save(currentSettingsFile);
                    }
                    else
                    {
                        Logging.WriteFight("No specialisation detected.");
                        Logging.WriteFight("Loading Mage Frost Combat class...");
                        InternalRange = 30.0f;
                        EquipmentAndStats.SetPlayerSpe(WoWSpecialization.MageFrost);
                        new MageFrost();
                    }
                    break;

                    #endregion

                    #region Warlock Specialisation checking

                case WoWClass.Warlock:

                    if (wowSpecialization == WoWSpecialization.WarlockDemonology)
                    {
                        if (configOnly)
                        {
                            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Warlock_Demonology.xml";
                            var currentSetting = new WarlockDemonology.WarlockDemonologySettings();
                            if (File.Exists(currentSettingsFile) && !resetSettings)
                            {
                                currentSetting = Settings.Load<WarlockDemonology.WarlockDemonologySettings>(currentSettingsFile);
                            }
                            currentSetting.ToForm();
                            currentSetting.Save(currentSettingsFile);
                        }
                        else
                        {
                            Logging.WriteFight("Loading Warlock Demonology Combat class...");
                            InternalRange = 40.0f;
                            EquipmentAndStats.SetPlayerSpe(WoWSpecialization.WarlockDemonology);
                            new WarlockDemonology();
                        }
                        break;
                    }
                    if (wowSpecialization == WoWSpecialization.WarlockAffliction)
                    {
                        if (configOnly)
                        {
                            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Warlock_Affliction.xml";
                            var currentSetting = new WarlockAffliction.WarlockAfflictionSettings();
                            if (File.Exists(currentSettingsFile) && !resetSettings)
                            {
                                currentSetting = Settings.Load<WarlockAffliction.WarlockAfflictionSettings>(currentSettingsFile);
                            }
                            currentSetting.ToForm();
                            currentSetting.Save(currentSettingsFile);
                        }
                        else
                        {
                            Logging.WriteFight("Loading Warlock Affliction Combat class...");
                            InternalRange = 40.0f;
                            EquipmentAndStats.SetPlayerSpe(WoWSpecialization.WarlockAffliction);
                            new WarlockAffliction();
                        }
                        break;
                    }
                    if (wowSpecialization == WoWSpecialization.WarlockDestruction)
                    {
                        if (configOnly)
                        {
                            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Warlock_Destruction.xml";
                            var currentSetting = new WarlockDestruction.WarlockDestructionSettings();
                            if (File.Exists(currentSettingsFile) && !resetSettings)
                            {
                                currentSetting = Settings.Load<WarlockDestruction.WarlockDestructionSettings>(currentSettingsFile);
                            }
                            currentSetting.ToForm();
                            currentSetting.Save(currentSettingsFile);
                        }
                        else
                        {
                            Logging.WriteFight("Loading Warlock Destruction Combat class...");
                            InternalRange = 40.0f;
                            EquipmentAndStats.SetPlayerSpe(WoWSpecialization.WarlockDestruction);
                            new WarlockDestruction();
                        }
                        break;
                    }
                    if (configOnly)
                    {
                        MessageBox.Show(@"Your specification haven't be found, loading Warlock Demonology Settings");
                        string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Warlock_Demonology.xml";
                        var currentSetting = new WarlockDemonology.WarlockDemonologySettings();
                        if (File.Exists(currentSettingsFile) && !resetSettings)
                        {
                            currentSetting = Settings.Load<WarlockDemonology.WarlockDemonologySettings>(currentSettingsFile);
                        }
                        currentSetting.ToForm();
                        currentSetting.Save(currentSettingsFile);
                    }
                    else
                    {
                        Logging.WriteFight("No specialisation detected.");
                        Logging.WriteFight("Loading Warlock Demonology Combat class...");
                        InternalRange = 40.0f;
                        EquipmentAndStats.SetPlayerSpe(WoWSpecialization.WarlockDemonology);
                        new WarlockDemonology();
                    }
                    break;

                    #endregion

                    #region Druid Specialisation checking

                case WoWClass.Druid:

                    if (wowSpecialization == WoWSpecialization.DruidFeral)
                    {
                        if (configOnly)
                        {
                            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Druid_Feral.xml";
                            var currentSetting = new DruidFeral.DruidFeralSettings();
                            if (File.Exists(currentSettingsFile) && !resetSettings)
                            {
                                currentSetting = Settings.Load<DruidFeral.DruidFeralSettings>(currentSettingsFile);
                            }
                            currentSetting.ToForm();
                            currentSetting.Save(currentSettingsFile);
                        }
                        else
                        {
                            Logging.WriteFight("Druid Feral Found");
                            EquipmentAndStats.SetPlayerSpe(WoWSpecialization.DruidFeral);
                            new DruidFeral();
                        }
                        break;
                    }
                    if (wowSpecialization == WoWSpecialization.DruidGuardian)
                    {
                        if (configOnly)
                        {
                            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Druid_Guardian.xml";
                            var currentSetting = new DruidGuardian.DruidGuardianSettings();
                            if (File.Exists(currentSettingsFile) && !resetSettings)
                            {
                                currentSetting = Settings.Load<DruidGuardian.DruidGuardianSettings>(currentSettingsFile);
                            }
                            currentSetting.ToForm();
                            currentSetting.Save(currentSettingsFile);
                        }
                        else
                        {
                            Logging.WriteFight("Feral Guardian Found");
                            EquipmentAndStats.SetPlayerSpe(WoWSpecialization.DruidGuardian);
                            new DruidGuardian();
                        }
                        break;
                    }
                    if (wowSpecialization == WoWSpecialization.DruidBalance)
                    {
                        if (configOnly)
                        {
                            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Druid_Balance.xml";
                            var currentSetting = new DruidBalance.DruidBalanceSettings();
                            if (File.Exists(currentSettingsFile) && !resetSettings)
                            {
                                currentSetting = Settings.Load<DruidBalance.DruidBalanceSettings>(currentSettingsFile);
                            }
                            currentSetting.ToForm();
                            currentSetting.Save(currentSettingsFile);
                        }
                        else
                        {
                            Logging.WriteFight("Druid Balance Found");
                            InternalRange = 30.0f;
                            EquipmentAndStats.SetPlayerSpe(WoWSpecialization.DruidBalance);
                            new DruidBalance();
                        }
                        break;
                    }
                    if (wowSpecialization == WoWSpecialization.DruidRestoration)
                    {
                        if (configOnly)
                        {
                            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Druid_Restoration.xml";
                            var currentSetting = new DruidRestoration.DruidRestorationSettings();
                            if (File.Exists(currentSettingsFile) && !resetSettings)
                            {
                                currentSetting = Settings.Load<DruidRestoration.DruidRestorationSettings>(currentSettingsFile);
                            }
                            currentSetting.ToForm();
                            currentSetting.Save(currentSettingsFile);
                        }
                        else
                        {
                            Logging.WriteFight("Druid Restoration Found");
                            InternalRange = 30.0f;
                            EquipmentAndStats.SetPlayerSpe(WoWSpecialization.DruidRestoration);
                            new DruidRestoration();
                        }
                        break;
                    }
                    if (configOnly)
                    {
                        string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Druid_Balance.xml";
                        var currentSetting = new DruidBalance.DruidBalanceSettings();
                        if (File.Exists(currentSettingsFile) && !resetSettings)
                        {
                            currentSetting = Settings.Load<DruidBalance.DruidBalanceSettings>(currentSettingsFile);
                        }
                        currentSetting.ToForm();
                        currentSetting.Save(currentSettingsFile);
                    }
                    else
                    {
                        Logging.WriteFight("No specialisation detected.");
                        Logging.WriteFight("Loading Druid Balance Combat class...");
                        InternalRange = 30.0f;
                        EquipmentAndStats.SetPlayerSpe(WoWSpecialization.DruidBalance);
                        new DruidBalance();
                    }
                    break;

                    #endregion

                    #region Paladin Specialisation checking

                case WoWClass.Paladin:

                    if (wowSpecialization == WoWSpecialization.PaladinRetribution)
                    {
                        if (configOnly)
                        {
                            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Paladin_Retribution.xml";
                            var currentSetting = new PaladinRetribution.PaladinRetributionSettings();
                            if (File.Exists(currentSettingsFile) && !resetSettings)
                            {
                                currentSetting = Settings.Load<PaladinRetribution.PaladinRetributionSettings>(currentSettingsFile);
                            }
                            currentSetting.ToForm();
                            currentSetting.Save(currentSettingsFile);
                        }
                        else
                        {
                            Logging.WriteFight("Loading Paladin Retribution Combat class...");
                            EquipmentAndStats.SetPlayerSpe(WoWSpecialization.PaladinRetribution);
                            new PaladinRetribution();
                        }
                        break;
                    }
                    if (wowSpecialization == WoWSpecialization.PaladinProtection)
                    {
                        if (configOnly)
                        {
                            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Paladin_Protection.xml";
                            var currentSetting = new PaladinProtection.PaladinProtectionSettings();
                            if (File.Exists(currentSettingsFile) && !resetSettings)
                            {
                                currentSetting = Settings.Load<PaladinProtection.PaladinProtectionSettings>(currentSettingsFile);
                            }
                            currentSetting.ToForm();
                            currentSetting.Save(currentSettingsFile);
                        }
                        else
                        {
                            Logging.WriteFight("Loading Paladin Protection Combat class...");
                            EquipmentAndStats.SetPlayerSpe(WoWSpecialization.PaladinProtection);
                            new PaladinProtection();
                        }
                        break;
                    }
                    if (wowSpecialization == WoWSpecialization.PaladinHoly)
                    {
                        if (configOnly)
                        {
                            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Paladin_Holy.xml";
                            var currentSetting = new PaladinHoly.PaladinHolySettings();
                            if (File.Exists(currentSettingsFile) && !resetSettings)
                            {
                                currentSetting = Settings.Load<PaladinHoly.PaladinHolySettings>(currentSettingsFile);
                            }
                            currentSetting.ToForm();
                            currentSetting.Save(currentSettingsFile);
                        }
                        else
                        {
                            Logging.WriteFight("Loading Paladin Holy Combat class...");
                            InternalRange = 30.0f;
                            EquipmentAndStats.SetPlayerSpe(WoWSpecialization.PaladinHoly);
                            new PaladinHoly();
                        }
                        break;
                    }
                    if (configOnly)
                    {
                        MessageBox.Show(@"Your specification haven't be found, loading Paladin Retribution Settings");
                        string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Paladin_Retribution.xml";
                        var currentSetting = new PaladinRetribution.PaladinRetributionSettings();
                        if (File.Exists(currentSettingsFile) && !resetSettings)
                        {
                            currentSetting = Settings.Load<PaladinRetribution.PaladinRetributionSettings>(currentSettingsFile);
                        }
                        currentSetting.ToForm();
                        currentSetting.Save(currentSettingsFile);
                    }
                    else
                    {
                        Logging.WriteFight("No specialisation detected.");
                        Logging.WriteFight("Loading Paladin Retribution Combat class...");
                        EquipmentAndStats.SetPlayerSpe(WoWSpecialization.PaladinRetribution);
                        new PaladinRetribution();
                    }
                    break;

                    #endregion

                    #region Shaman Specialisation checking

                case WoWClass.Shaman:

                    if (wowSpecialization == WoWSpecialization.ShamanEnhancement)
                    {
                        if (configOnly)
                        {
                            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Shaman_Enhancement.xml";
                            var currentSetting = new ShamanEnhancement.ShamanEnhancementSettings();
                            if (File.Exists(currentSettingsFile) && !resetSettings)
                            {
                                currentSetting = Settings.Load<ShamanEnhancement.ShamanEnhancementSettings>(currentSettingsFile);
                            }
                            currentSetting.ToForm();
                            currentSetting.Save(currentSettingsFile);
                        }
                        else
                        {
                            Logging.WriteFight("Loading Shaman Enhancement Combat class...");
                            EquipmentAndStats.SetPlayerSpe(WoWSpecialization.ShamanEnhancement);
                            new ShamanEnhancement();
                        }
                        break;
                    }
                    if (wowSpecialization == WoWSpecialization.ShamanElemental)
                    {
                        if (configOnly)
                        {
                            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Shaman_Elemental.xml";
                            var currentSetting = new ShamanElemental.ShamanElementalSettings();
                            if (File.Exists(currentSettingsFile) && !resetSettings)
                            {
                                currentSetting = Settings.Load<ShamanElemental.ShamanElementalSettings>(currentSettingsFile);
                            }
                            currentSetting.ToForm();
                            currentSetting.Save(currentSettingsFile);
                        }
                        else
                        {
                            Logging.WriteFight("Loading Shaman Elemental Combat class...");
                            InternalRange = 30.0f;
                            EquipmentAndStats.SetPlayerSpe(WoWSpecialization.ShamanElemental);
                            new ShamanElemental();
                        }
                        break;
                    }
                    if (wowSpecialization == WoWSpecialization.ShamanRestoration)
                    {
                        if (configOnly)
                        {
                            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Shaman_Restoration.xml";
                            var currentSetting = new ShamanRestoration.ShamanRestorationSettings();
                            if (File.Exists(currentSettingsFile) && !resetSettings)
                            {
                                currentSetting = Settings.Load<ShamanRestoration.ShamanRestorationSettings>(currentSettingsFile);
                            }
                            currentSetting.ToForm();
                            currentSetting.Save(currentSettingsFile);
                        }
                        else
                        {
                            Logging.WriteFight("Loading Shaman Restoration Combat class...");
                            InternalRange = 30.0f;
                            EquipmentAndStats.SetPlayerSpe(WoWSpecialization.ShamanRestoration);
                            new ShamanRestoration();
                        }
                        break;
                    }
                    if (configOnly)
                    {
                        string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Shaman_Restoration.xml";
                        var currentSetting = new ShamanRestoration.ShamanRestorationSettings();
                        if (File.Exists(currentSettingsFile) && !resetSettings)
                        {
                            currentSetting = Settings.Load<ShamanRestoration.ShamanRestorationSettings>(currentSettingsFile);
                        }
                        currentSetting.ToForm();
                        currentSetting.Save(currentSettingsFile);
                    }
                    else
                    {
                        Logging.WriteFight("No specialisation detected.");
                        Logging.WriteFight("Loading Shaman Restoration Combat class...");
                        InternalRange = 30.0f;
                        EquipmentAndStats.SetPlayerSpe(WoWSpecialization.ShamanRestoration);
                        new ShamanRestoration();
                    }
                    break;

                    #endregion

                    #region Priest Specialisation checking

                case WoWClass.Priest:

                    if (wowSpecialization == WoWSpecialization.PriestShadow)
                    {
                        if (configOnly)
                        {
                            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Priest_Shadow.xml";
                            var currentSetting = new PriestShadow.PriestShadowSettings();
                            if (File.Exists(currentSettingsFile) && !resetSettings)
                            {
                                currentSetting = Settings.Load<PriestShadow.PriestShadowSettings>(currentSettingsFile);
                            }
                            currentSetting.ToForm();
                            currentSetting.Save(currentSettingsFile);
                        }
                        else
                        {
                            Logging.WriteFight("Loading Priest Shadow Combat class...");
                            InternalRange = 30.0f;
                            EquipmentAndStats.SetPlayerSpe(WoWSpecialization.PriestShadow);
                            new PriestShadow();
                        }
                        break;
                    }
                    if (wowSpecialization == WoWSpecialization.PriestDiscipline)
                    {
                        if (configOnly)
                        {
                            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Priest_Discipline.xml";
                            var currentSetting = new PriestDiscipline.PriestDisciplineSettings();
                            if (File.Exists(currentSettingsFile) && !resetSettings)
                            {
                                currentSetting = Settings.Load<PriestDiscipline.PriestDisciplineSettings>(currentSettingsFile);
                            }
                            currentSetting.ToForm();
                            currentSetting.Save(currentSettingsFile);
                        }
                        else
                        {
                            Logging.WriteFight("Loading Priest Discipline Combat class...");
                            InternalRange = 30.0f;
                            EquipmentAndStats.SetPlayerSpe(WoWSpecialization.PriestDiscipline);
                            new PriestDiscipline();
                        }
                        break;
                    }
                    if (wowSpecialization == WoWSpecialization.PriestHoly)
                    {
                        if (configOnly)
                        {
                            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Priest_Holy.xml";
                            var currentSetting = new PriestHoly.PriestHolySettings();
                            if (File.Exists(currentSettingsFile) && !resetSettings)
                            {
                                currentSetting = Settings.Load<PriestHoly.PriestHolySettings>(currentSettingsFile);
                            }
                            currentSetting.ToForm();
                            currentSetting.Save(currentSettingsFile);
                        }
                        else
                        {
                            Logging.WriteFight("Loading Priest Holy Combat class...");
                            InternalRange = 30.0f;
                            EquipmentAndStats.SetPlayerSpe(WoWSpecialization.PriestHoly);
                            new PriestHoly();
                        }
                        break;
                    }
                    if (configOnly)
                    {
                        MessageBox.Show(@"Your specification haven't be found, loading Priest Shadow Settings");
                        string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Priest_Shadow.xml";
                        var currentSetting = new PriestShadow.PriestShadowSettings();
                        if (File.Exists(currentSettingsFile) && !resetSettings)
                        {
                            currentSetting = Settings.Load<PriestShadow.PriestShadowSettings>(currentSettingsFile);
                        }
                        currentSetting.ToForm();
                        currentSetting.Save(currentSettingsFile);
                    }
                    else
                    {
                        Logging.WriteFight("No specialisation detected.");
                        Logging.WriteFight("Loading Priest Shadow Combat class...");
                        InternalRange = 30.0f;
                        EquipmentAndStats.SetPlayerSpe(WoWSpecialization.PriestShadow);
                        new PriestShadow();
                    }
                    break;

                    #endregion

                    #region Rogue Specialisation checking

                case WoWClass.Rogue:

                    if (wowSpecialization == WoWSpecialization.RogueCombat)
                    {
                        if (configOnly)
                        {
                            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Rogue_Combat.xml";
                            var currentSetting = new RogueCombat.RogueCombatSettings();
                            if (File.Exists(currentSettingsFile) && !resetSettings)
                            {
                                currentSetting = Settings.Load<RogueCombat.RogueCombatSettings>(currentSettingsFile);
                            }
                            currentSetting.ToForm();
                            currentSetting.Save(currentSettingsFile);
                        }
                        else
                        {
                            Logging.WriteFight("Loading Rogue Combat Combat class...");
                            EquipmentAndStats.SetPlayerSpe(WoWSpecialization.RogueCombat);
                            new RogueCombat();
                        }
                        break;
                    }
                    if (wowSpecialization == WoWSpecialization.RogueAssassination)
                    {
                        if (configOnly)
                        {
                            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Rogue_Assassination.xml";
                            var currentSetting = new RogueAssassination.RogueAssassinationSettings();
                            if (File.Exists(currentSettingsFile) && !resetSettings)
                            {
                                currentSetting = Settings.Load<RogueAssassination.RogueAssassinationSettings>(currentSettingsFile);
                            }
                            currentSetting.ToForm();
                            currentSetting.Save(currentSettingsFile);
                        }
                        else
                        {
                            Logging.WriteFight("Loading Rogue Assassination Combat class...");
                            EquipmentAndStats.SetPlayerSpe(WoWSpecialization.RogueAssassination);
                            new RogueAssassination();
                        }
                        break;
                    }
                    if (wowSpecialization == WoWSpecialization.RogueSubtlety)
                    {
                        if (configOnly)
                        {
                            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Rogue_Subtlety.xml";
                            var currentSetting = new RogueSubtlety.RogueSubtletySettings();
                            if (File.Exists(currentSettingsFile) && !resetSettings)
                            {
                                currentSetting = Settings.Load<RogueSubtlety.RogueSubtletySettings>(currentSettingsFile);
                            }
                            currentSetting.ToForm();
                            currentSetting.Save(currentSettingsFile);
                        }
                        else
                        {
                            Logging.WriteFight("Loading Rogue Subtlety Combat class...");
                            EquipmentAndStats.SetPlayerSpe(WoWSpecialization.RogueSubtlety);
                            new RogueSubtlety();
                        }
                        break;
                    }
                    if (configOnly)
                    {
                        string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Rogue_Combat.xml";
                        var currentSetting = new RogueCombat.RogueCombatSettings();
                        if (File.Exists(currentSettingsFile) && !resetSettings)
                        {
                            currentSetting = Settings.Load<RogueCombat.RogueCombatSettings>(currentSettingsFile);
                        }
                        currentSetting.ToForm();
                        currentSetting.Save(currentSettingsFile);
                    }
                    else
                    {
                        Logging.WriteFight("No specialisation detected.");
                        Logging.WriteFight("Loading Rogue Combat Combat class...");
                        EquipmentAndStats.SetPlayerSpe(WoWSpecialization.RogueCombat);
                        new RogueCombat();
                    }
                    break;

                    #endregion

                    #region Warrior Specialisation checking

                case WoWClass.Warrior:

                    if (wowSpecialization == WoWSpecialization.WarriorArms)
                    {
                        if (configOnly)
                        {
                            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Warrior_Arms.xml";
                            var currentSetting = new WarriorArms.WarriorArmsSettings();
                            if (File.Exists(currentSettingsFile) && !resetSettings)
                            {
                                currentSetting = Settings.Load<WarriorArms.WarriorArmsSettings>(currentSettingsFile);
                            }
                            currentSetting.ToForm();
                            currentSetting.Save(currentSettingsFile);
                        }
                        else
                        {
                            Logging.WriteFight("Loading Warrior Arms Combat class...");
                            EquipmentAndStats.SetPlayerSpe(WoWSpecialization.WarriorArms);
                            new WarriorArms();
                        }
                        break;
                    }
                    if (wowSpecialization == WoWSpecialization.WarriorFury)
                    {
                        if (configOnly)
                        {
                            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Warrior_Fury.xml";
                            var currentSetting = new WarriorFury.WarriorFurySettings();
                            if (File.Exists(currentSettingsFile) && !resetSettings)
                            {
                                currentSetting = Settings.Load<WarriorFury.WarriorFurySettings>(currentSettingsFile);
                            }
                            currentSetting.ToForm();
                            currentSetting.Save(currentSettingsFile);
                        }
                        else
                        {
                            Logging.WriteFight("Loading Warrior Fury Combat class...");
                            EquipmentAndStats.SetPlayerSpe(WoWSpecialization.WarriorFury);
                            new WarriorFury();
                        }
                        break;
                    }
                    if (wowSpecialization == WoWSpecialization.WarriorProtection)
                    {
                        if (configOnly)
                        {
                            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Warrior_Protection.xml";
                            var currentSetting = new WarriorProtection.WarriorProtectionSettings();
                            if (File.Exists(currentSettingsFile) && !resetSettings)
                            {
                                currentSetting = Settings.Load<WarriorProtection.WarriorProtectionSettings>(currentSettingsFile);
                            }
                            currentSetting.ToForm();
                            currentSetting.Save(currentSettingsFile);
                        }
                        else
                        {
                            Logging.WriteFight("Loading Warrior Protection Combat class...");
                            EquipmentAndStats.SetPlayerSpe(WoWSpecialization.WarriorProtection);
                            new WarriorProtection();
                        }
                        break;
                    }
                    if (configOnly)
                    {
                        MessageBox.Show(@"Your specification haven't be found, loading Warrior Arms Settings");
                        string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Warrior_Arms.xml";
                        var currentSetting = new WarriorArms.WarriorArmsSettings();
                        if (File.Exists(currentSettingsFile) && !resetSettings)
                        {
                            currentSetting = Settings.Load<WarriorArms.WarriorArmsSettings>(currentSettingsFile);
                        }
                        currentSetting.ToForm();
                        currentSetting.Save(currentSettingsFile);
                    }
                    else
                    {
                        Logging.WriteFight("No specialisation detected.");
                        Logging.WriteFight("Loading Warrior Arms Combat class...");
                        EquipmentAndStats.SetPlayerSpe(WoWSpecialization.WarriorArms);
                        new WarriorArms();
                    }
                    break;

                    #endregion

                    #region Hunter Specialisation checking

                case WoWClass.Hunter:

                    if (wowSpecialization == WoWSpecialization.HunterMarksmanship)
                    {
                        if (configOnly)
                        {
                            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Hunter_Marksmanship.xml";
                            var currentSetting = new HunterMarksmanship.HunterMarksmanshipSettings();
                            if (File.Exists(currentSettingsFile) && !resetSettings)
                            {
                                currentSetting = Settings.Load<HunterMarksmanship.HunterMarksmanshipSettings>(currentSettingsFile);
                            }
                            currentSetting.ToForm();
                            currentSetting.Save(currentSettingsFile);
                        }
                        else
                        {
                            Logging.WriteFight("Loading Hunter Marksmanship Combat class...");
                            InternalRange = 40.0f;
                            EquipmentAndStats.SetPlayerSpe(WoWSpecialization.HunterMarksmanship);
                            new HunterMarksmanship();
                        }
                        break;
                    }
                    if (wowSpecialization == WoWSpecialization.HunterSurvival)
                    {
                        if (configOnly)
                        {
                            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Hunter_Survival.xml";
                            var currentSetting = new HunterSurvival.HunterSurvivalSettings();
                            if (File.Exists(currentSettingsFile) && !resetSettings)
                            {
                                currentSetting = Settings.Load<HunterSurvival.HunterSurvivalSettings>(currentSettingsFile);
                            }
                            currentSetting.ToForm();
                            currentSetting.Save(currentSettingsFile);
                        }
                        else
                        {
                            Logging.WriteFight("Loading Hunter Survival Combat class...");
                            InternalRange = 40.0f;
                            EquipmentAndStats.SetPlayerSpe(WoWSpecialization.HunterSurvival);
                            new HunterSurvival();
                        }
                        break;
                    }
                    if (wowSpecialization == WoWSpecialization.HunterBeastMastery)
                    {
                        if (configOnly)
                        {
                            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Hunter_BeastMastery.xml";
                            var currentSetting = new HunterBeastMastery.HunterBeastMasterySettings();
                            if (File.Exists(currentSettingsFile) && !resetSettings)
                            {
                                currentSetting = Settings.Load<HunterBeastMastery.HunterBeastMasterySettings>(currentSettingsFile);
                            }
                            currentSetting.ToForm();
                            currentSetting.Save(currentSettingsFile);
                        }
                        else
                        {
                            Logging.WriteFight("Loading Hunter BeastMastery Combat class...");
                            InternalRange = 40.0f;
                            EquipmentAndStats.SetPlayerSpe(WoWSpecialization.HunterBeastMastery);
                            new HunterBeastMastery();
                        }
                        break;
                    }
                    if (configOnly)
                    {
                        MessageBox.Show(@"Your specification haven't be found, loading Hunter Marksmanship Settings");
                        string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Hunter_Marksmanship.xml";
                        var currentSetting = new HunterMarksmanship.HunterMarksmanshipSettings();
                        if (File.Exists(currentSettingsFile) && !resetSettings)
                        {
                            currentSetting = Settings.Load<HunterMarksmanship.HunterMarksmanshipSettings>(currentSettingsFile);
                        }
                        currentSetting.ToForm();
                        currentSetting.Save(currentSettingsFile);
                    }
                    else
                    {
                        Logging.WriteFight("No specialisation detected.");
                        Logging.WriteFight("Loading Hunter Marksmanship Combat class...");
                        InternalRange = 35.0f;
                        EquipmentAndStats.SetPlayerSpe(WoWSpecialization.HunterMarksmanship);
                        new HunterMarksmanship();
                    }
                    break;

                    #endregion

                    #region Monk Specialisation checking

                case WoWClass.Monk:

                    if (wowSpecialization == WoWSpecialization.MonkBrewmaster)
                    {
                        if (configOnly)
                        {
                            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Monk_Brewmaster.xml";
                            var currentSetting = new MonkBrewmaster.MonkBrewmasterSettings();
                            if (File.Exists(currentSettingsFile) && !resetSettings)
                            {
                                currentSetting = Settings.Load<MonkBrewmaster.MonkBrewmasterSettings>(currentSettingsFile);
                            }
                            currentSetting.ToForm();
                            currentSetting.Save(currentSettingsFile);
                        }
                        else
                        {
                            Logging.WriteFight("Loading Monk Brewmaster Combat class...");
                            EquipmentAndStats.SetPlayerSpe(WoWSpecialization.MonkBrewmaster);
                            new MonkBrewmaster();
                        }
                        break;
                    }
                    if (wowSpecialization == WoWSpecialization.MonkWindwalker)
                    {
                        if (configOnly)
                        {
                            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Monk_Windwalker.xml";
                            var currentSetting = new MonkWindwalker.MonkWindwalkerSettings();
                            if (File.Exists(currentSettingsFile) && !resetSettings)
                            {
                                currentSetting = Settings.Load<MonkWindwalker.MonkWindwalkerSettings>(currentSettingsFile);
                            }
                            currentSetting.ToForm();
                            currentSetting.Save(currentSettingsFile);
                        }
                        else
                        {
                            Logging.WriteFight("Loading Monk Windwalker Combat class...");
                            EquipmentAndStats.SetPlayerSpe(WoWSpecialization.MonkWindwalker);
                            new MonkWindwalker();
                        }
                        break;
                    }
                    if (wowSpecialization == WoWSpecialization.MonkMistweaver)
                    {
                        if (configOnly)
                        {
                            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Monk_Mistweaver.xml";
                            var currentSetting = new MonkMistweaver.MonkMistweaverSettings();
                            if (File.Exists(currentSettingsFile) && !resetSettings)
                            {
                                currentSetting = Settings.Load<MonkMistweaver.MonkMistweaverSettings>(currentSettingsFile);
                            }
                            currentSetting.ToForm();
                            currentSetting.Save(currentSettingsFile);
                        }
                        else
                        {
                            Logging.WriteFight("Loading Monk Mistweaver Combat class...");
                            InternalRange = 30.0f;
                            EquipmentAndStats.SetPlayerSpe(WoWSpecialization.MonkMistweaver);
                            new MonkMistweaver();
                        }
                        break;
                    }
                    if (configOnly)
                    {
                        MessageBox.Show(@"Your specification haven't be found, loading Monk Brewmaster Settings");
                        string currentSettingsFile = Application.StartupPath +
                                                     "\\CombatClasses\\Settings\\Monk_Brewmaster.xml";
                        var currentSetting = new MonkBrewmaster.MonkBrewmasterSettings();
                        if (File.Exists(currentSettingsFile) && !resetSettings)
                        {
                            currentSetting =
                                Settings.Load<MonkBrewmaster.MonkBrewmasterSettings>(currentSettingsFile);
                        }
                        currentSetting.ToForm();
                        currentSetting.Save(currentSettingsFile);
                    }
                    else
                    {
                        Logging.WriteFight("No specialisation detected.");
                        Logging.WriteFight("Loading Monk Brewmaster Combat class...");
                        EquipmentAndStats.SetPlayerSpe(WoWSpecialization.MonkBrewmaster);
                        new MonkBrewmaster();
                    }
                    break;

                    #endregion

                default:
                    Dispose();
                    break;
            }
        }
        catch
        {
        }
        Logging.WriteFight("Combat system stopped.");
    }

    internal static void DumpCurrentSettings<T>(object mySettings)
    {
        mySettings = mySettings is T ? (T) mySettings : default(T);
        BindingFlags bindingFlags = BindingFlags.Public |
                                    BindingFlags.NonPublic |
                                    BindingFlags.Instance |
                                    BindingFlags.Static;
        for (int i = 0; i < mySettings.GetType().GetFields(bindingFlags).Length - 1; i++)
        {
            FieldInfo field = mySettings.GetType().GetFields(bindingFlags)[i];
            Logging.WriteDebug(field.Name + " = " + field.GetValue(mySettings));
        }

        // Last field is intentionnally ommited because it's a backing field.
    }
}

#region Deathknight

public class DeathknightApprentice
{
    private static DeathknightApprenticeSettings MySettings = DeathknightApprenticeSettings.GetSettings();

    #region Professions & Racials

    public readonly Spell ArcaneTorrent = new Spell("Arcane Torrent");
    public readonly Spell Berserking = new Spell("Berserking");
    public readonly Spell BloodFury = new Spell("Blood Fury");
    public readonly Spell GiftoftheNaaru = new Spell("Gift of the Naaru");
    public readonly Spell Stoneform = new Spell("Stoneform");
    public readonly Spell WarStomp = new Spell("War Stomp");

    #endregion

    #region Deathknight Presence & Buffs

    public readonly Spell BloodPlague = new Spell(55078);
    public readonly Spell BloodPresence = new Spell("Blood Presence");
    public readonly Spell FrostFever = new Spell(55095);
    public readonly Spell FrostPresence = new Spell("Frost Presence");

    #endregion

    #region Offensive Spell

    public readonly Spell BloodBoil = new Spell("Blood Boil");
    public readonly Spell DeathCoil = new Spell("Death Coil");
    public readonly Spell IcyTouch = new Spell("Icy Touch");
    public readonly Spell PlagueStrike = new Spell("Plague Strike");

    #endregion

    #region Offensive Cooldown

    public readonly Spell DeathGrip = new Spell("Death Grip");

    #endregion

    #region Defensive Cooldown

    public readonly Spell ChainsofIce = new Spell("Chains of Ice");
    public readonly Spell MindFreeze = new Spell("Mind Freeze");

    #endregion

    #region Healing Spell

    public readonly Spell DeathStrike = new Spell("Death Strike");

    #endregion

    public DeathknightApprentice()
    {
        Main.InternalRange = ObjectManager.Me.GetCombatReach;
        MySettings = DeathknightApprenticeSettings.GetSettings();
        Main.DumpCurrentSettings<DeathknightApprenticeSettings>(MySettings);
        UInt128 lastTarget = 0;

        while (Main.InternalLoop)
        {
            try
            {
                if (!ObjectManager.Me.IsDeadMe)
                {
                    if (!ObjectManager.Me.IsMounted)
                    {
                        if (Fight.InFight && ObjectManager.Me.Target > 0)
                        {
                            if (ObjectManager.Me.Target != lastTarget && (DeathGrip.IsHostileDistanceGood || IcyTouch.IsHostileDistanceGood))
                            {
                                Pull();
                                lastTarget = ObjectManager.Me.Target;
                            }

                            if (ObjectManager.Target.GetDistance < 30)
                                Combat();
                        }
                        if (!ObjectManager.Me.IsCast)
                            Patrolling();
                    }
                }
                else
                    Thread.Sleep(500);
            }
            catch
            {
            }
            Thread.Sleep(100);
        }
    }

    private void Pull()
    {
        if (MySettings.UseDeathGrip && DeathGrip.IsSpellUsable && ObjectManager.Target.GetDistance > Main.InternalRange && DeathGrip.IsHostileDistanceGood)
        {
            DeathGrip.Cast();
            MovementManager.StopMove();
            return;
        }
        if (MySettings.UseIcyTouch && IcyTouch.IsSpellUsable && IcyTouch.IsHostileDistanceGood)
            IcyTouch.Cast();
    }

    private void Combat()
    {
        Buff();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();

        DPSCycle();
        DefenseCycle();
        Heal();
        Decast();
        DPSBurst();
        DPSCycle();
    }

    private void Buff()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (MySettings.UseBloodPresence && !BloodPresence.HaveBuff && (ObjectManager.Me.HealthPercent <= MySettings.UseBloodPresenceAtPercentage
            || ObjectManager.GetUnitInSpellRange(PlagueStrike.MaxRangeHostile) >= 3) && BloodPresence.IsSpellUsable)
        {
            BloodPresence.Cast();
            return;
        }
        if (MySettings.UseFrostPresence && !FrostPresence.HaveBuff && ObjectManager.Me.HealthPercent > MySettings.UseBloodPresenceAtPercentage + 10
            && FrostPresence.IsSpellUsable)
            FrostPresence.Cast();
    }

    private void AvoidMelee()
    {
        if (ObjectManager.Target.GetDistance < MySettings.DoAvoidMeleeDistance && ObjectManager.Target.InCombat)
        {
            Logging.WriteFight("Too Close. Moving Back");
            var maxTimeTimer = new Timer(1000*2);
            MovementsAction.MoveBackward(true);
            while (ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat && !maxTimeTimer.IsReady)
            {
                Others.SafeSleep(300);
            }
            MovementsAction.MoveBackward(false);
            if (maxTimeTimer.IsReady && ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat)
            {
                MovementsAction.MoveForward(true);
                Others.SafeSleep(1000);
                MovementsAction.MoveForward(false);
                MovementManager.Face(ObjectManager.Target.Position);
            }
        }
    }

    private void DefenseCycle()
    {
        if (MySettings.UseStoneform && ObjectManager.Me.HealthPercent <= MySettings.UseStoneformAtPercentage && Stoneform.IsSpellUsable)
        {
            Stoneform.Cast();
            return;
        }
        if (MySettings.UseWarStomp && ObjectManager.Me.HealthPercent <= MySettings.UseWarStompAtPercentage && WarStomp.IsSpellUsable
            && ObjectManager.GetUnitInSpellRange(WarStomp.MaxRangeHostile) > 0)
            WarStomp.Cast();
    }

    private void Heal()
    {
        if (MySettings.UseGiftoftheNaaru && ObjectManager.Me.HealthPercent <= MySettings.UseGiftoftheNaaruAtPercentage &&
            GiftoftheNaaru.IsSpellUsable)
        {
            GiftoftheNaaru.Cast();
            return;
        }
        if (MySettings.UseDeathStrike && ObjectManager.Target.IsValid && ObjectManager.Target.IsAlive
            && ObjectManager.Me.HealthPercent <= MySettings.UseDeathStrikeAtPercentage && DeathStrike.IsSpellUsable && DeathStrike.IsHostileDistanceGood)
            DeathStrike.Cast();
    }

    private void Decast()
    {
        if (MySettings.UseArcaneTorrentForDecast && ObjectManager.Me.HealthPercent <= MySettings.UseArcaneTorrentForDecastAtPercentage
            && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe && ArcaneTorrent.IsSpellUsable && ObjectManager.Target.GetDistance < 8)
        {
            ArcaneTorrent.Cast();
            return;
        }
        if (MySettings.UseMindFreeze && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe
            && ObjectManager.Me.HealthPercent <= MySettings.UseMindFreezeAtPercentage && MindFreeze.IsSpellUsable && MindFreeze.IsHostileDistanceGood)
        {
            MindFreeze.Cast();
            return;
        }
        if (MySettings.UseChainsofIce && ObjectManager.Target.GetMove && !ChainsofIce.TargetHaveBuff && ChainsofIce.IsSpellUsable
            && ChainsofIce.IsHostileDistanceGood)
            ChainsofIce.Cast();
    }

    private void DPSBurst()
    {
        if (MySettings.UseBerserking && Berserking.IsSpellUsable && ObjectManager.Target.GetDistance < 30)
            Berserking.Cast();

        if (MySettings.UseBloodFury && BloodFury.IsSpellUsable && ObjectManager.Target.GetDistance < 30)
            BloodFury.Cast();
    }

    private void DPSCycle()
    {
        Usefuls.SleepGlobalCooldown();
        try
        {
            Memory.WowMemory.GameFrameLock(); // !!! WARNING - DONT SLEEP WHILE LOCKED - DO FINALLY(GameFrameUnLock()) !!!

            if (MySettings.UseIcyTouch && IcyTouch.IsSpellUsable && IcyTouch.IsHostileDistanceGood)
            {
                IcyTouch.Cast();
                return;
            }
            if (MySettings.UsePlagueStrike && PlagueStrike.IsSpellUsable && PlagueStrike.IsHostileDistanceGood)
            {
                PlagueStrike.Cast();
                return;
            }
            if (MySettings.UseBloodBoil && BloodPlague.TargetHaveBuff && FrostFever.TargetHaveBuff && BloodBoil.IsSpellUsable
                && BloodBoil.IsHostileDistanceGood)
            {
                BloodBoil.Cast();
                return;
            }
            if (MySettings.UseDeathCoil && DeathCoil.IsSpellUsable && DeathCoil.IsHostileDistanceGood)
            {
                DeathCoil.Cast();
                return;
            }
            if (MySettings.UseArcaneTorrentForResource && ObjectManager.Me.RunicPowerPercentage < 86 && ArcaneTorrent.IsSpellUsable)
                ArcaneTorrent.Cast();
        }
        finally
        {
            Memory.WowMemory.GameFrameUnLock();
        }
    }

    private void Patrolling()
    {
        if (!ObjectManager.Me.IsMounted)
        {
            Buff();
            Heal();
        }
    }

    #region Nested type: DeathknightApprenticeSettings

    [Serializable]
    public class DeathknightApprenticeSettings : Settings
    {
        public bool DoAvoidMelee = false;
        public int DoAvoidMeleeDistance = 0;
        public bool UseArcaneTorrentForDecast = true;
        public int UseArcaneTorrentForDecastAtPercentage = 100;
        public bool UseArcaneTorrentForResource = true;
        public bool UseBerserking = true;
        public bool UseBloodBoil = true;
        public bool UseBloodFury = true;
        public bool UseBloodPresence = true;
        public int UseBloodPresenceAtPercentage = 50;
        public bool UseBloodStrike = true;
        public bool UseChainsofIce = false;
        public bool UseDeathCoil = true;
        public bool UseDeathGrip = true;
        public bool UseDeathStrike = true;
        public int UseDeathStrikeAtPercentage = 80;
        public bool UseFrostPresence = true;
        public bool UseGiftoftheNaaru = true;
        public int UseGiftoftheNaaruAtPercentage = 80;
        public bool UseIcyTouch = true;
        public bool UseMindFreeze = true;
        public int UseMindFreezeAtPercentage = 100;
        public bool UsePlagueStrike = true;
        public bool UseStoneform = true;
        public int UseStoneformAtPercentage = 80;
        public bool UseWarStomp = true;
        public int UseWarStompAtPercentage = 80;

        public DeathknightApprenticeSettings()
        {
            ConfigWinForm("Deathknight Apprentice Settings");
            /* Professions & Racials */
            AddControlInWinForm("Use Arcane Torrent for Interrupt", "UseArcaneTorrentForDecast", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Arcane Torrent for Resource", "UseArcaneTorrentForResource", "Professions & Racials");
            AddControlInWinForm("Use Berserking", "UseBerserking", "Professions & Racials");
            AddControlInWinForm("Use Blood Fury", "UseBloodFury", "Professions & Racials");
            AddControlInWinForm("Use Gift of the Naaru", "UseGiftoftheNaaru", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Stoneform", "UseStoneform", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use War Stomp", "UseWarStomp", "Professions & Racials", "AtPercentage");
            /* Deathknight Presence & Buffs */
            AddControlInWinForm("Use Blood Presence", "UseBloodPresence", "Deathknight Presence & Buffs", "AtPercentage");
            AddControlInWinForm("Use Frost Presence", "UseFrostPresence", "Deathknight Presence & Buffs");
            /* Offensive Spell */
            AddControlInWinForm("Use Blood Boil", "UseBloodBoil", "Offensive Spell");
            AddControlInWinForm("Use Death Coil", "UseDeathCoil", "Offensive Spell");
            AddControlInWinForm("Use Icy Touch", "UseIcyTouch", "Offensive Spell");
            AddControlInWinForm("Use Plague Strike", "UsePlagueStrike", "Offensive Spell");
            /* Offensive Cooldown */
            AddControlInWinForm("Use Death Grip", "UseDeathGrip", "Offensive Cooldown");
            /* Defensive Cooldown */
            AddControlInWinForm("Use Chains of Ice", "UseChainsofIce", "Defensive Cooldown");
            AddControlInWinForm("Use Mind Freeze", "UseMindFreeze", "Defensive Cooldown", "AtPercentage");
            /* Healing Spell */
            AddControlInWinForm("Use Death Strike", "UseDeathStrike", "Healing Spell", "AtPercentage");
            /* Game Settings */
            AddControlInWinForm("Do avoid melee (Off Advised!!)", "DoAvoidMelee", "Game Settings");
            AddControlInWinForm("Avoid melee distance (1 to 4)", "DoAvoidMeleeDistance", "Game Settings");
        }

        public static DeathknightApprenticeSettings CurrentSetting { get; set; }

        public static DeathknightApprenticeSettings GetSettings()
        {
            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Deathknight_Apprentice.xml";
            if (File.Exists(currentSettingsFile))
            {
                return
                    CurrentSetting = Load<DeathknightApprenticeSettings>(currentSettingsFile);
            }
            return new DeathknightApprenticeSettings();
        }
    }

    #endregion
}

public class DeathknightBlood
{
    private static DeathknightBloodSettings MySettings = DeathknightBloodSettings.GetSettings();

    #region General Timers & Variables

    private readonly WoWItem _firstTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET);
    private readonly WoWItem _secondTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET, 2);
    public int DecastHP = 0;
    public int DefenseHP = 0;
    public int HealHP = 0;
    public int LC = 0;

    private Timer _onCd = new Timer(0);

    #endregion

    #region Professions & Racials

    public readonly Spell ArcaneTorrent = new Spell("Arcane Torrent");
    public readonly Spell Berserking = new Spell("Berserking");
    public readonly Spell BloodFury = new Spell("Blood Fury");
    public readonly Spell GiftoftheNaaru = new Spell("Gift of the Naaru");
    public readonly Spell Stoneform = new Spell("Stoneform");
    public readonly Spell WarStomp = new Spell("War Stomp");

    #endregion

    #region Deathknight Presence & Buffs

    public readonly Spell BloodPlague = new Spell(55078);
    public readonly Spell BloodPresence = new Spell("Blood Presence");
    public readonly Spell CrimsonScourge = new Spell(81141);
    public readonly Spell FrostFever = new Spell(55095);
    public readonly Spell FrostPresence = new Spell("Frost Presence");
    public readonly Spell HornofWinter = new Spell("Horn of Winter");
    public readonly Spell NecroticPlague = new Spell(152281);
    public readonly Spell PathofFrost = new Spell("Path of Frost");
    public readonly uint PathofFrostBuff = 3714;
    public readonly Spell UnholyPresence = new Spell("Unholy Presence");
    private Timer _pathofFrostBuffTimer = new Timer(0);

    #endregion

    #region Offensive Spell

    public readonly Spell BloodBoil = new Spell("Blood Boil");
    public readonly Spell DeathCoil = new Spell("Death Coil");
    public readonly Spell DeathStrike = new Spell("Death Strike");
    public readonly Spell DeathandDecay = new Spell("Death and Decay");
    public readonly Spell Defile = new Spell("Defile");
    public readonly Spell IcyTouch = new Spell("Icy Touch");
    public readonly Spell PlagueLeech = new Spell("Plague Leech");
    public readonly Spell PlagueStrike = new Spell("Plague Strike");
    public readonly Spell SoulReaper = new Spell("Soul Reaper");
    public readonly Spell UnholyBlight = new Spell("Unholy Blight");
    private Timer _defileTimer = new Timer(0);

    #endregion

    #region Offensive Cooldown

    public readonly Spell BloodTap = new Spell("Blood Tap");
    public readonly Spell BloodCharge = new Spell(114851);
    public readonly Spell BreathofSindragosa = new Spell("Breath of Sindragosa");
    public readonly Spell DancingRuneWeapon = new Spell("Dancing Rune Weapon");
    public readonly Spell DeathGrip = new Spell("Death Grip");
    public readonly Spell EmpowerRuneWeapon = new Spell("Empower Rune Weapon");
    public readonly Spell Outbreak = new Spell("Outbreak");

    #endregion

    #region Defensive Cooldown

    public readonly Spell AntiMagicShell = new Spell("Anti-Magic Shell");
    public readonly Spell AntiMagicZone = new Spell("Anti-Magic Zone");
    public readonly Spell ArmyoftheDead = new Spell("Army of the Dead");
    public readonly Spell Asphyxiate = new Spell("Asphyxiate");
    public readonly Spell BoneShield = new Spell("Bone Shield");
    public readonly Spell ChainsofIce = new Spell("Chains of Ice");
    public readonly Spell DeathsAdvance = new Spell("Death's Advance");
    public readonly Spell DesecratedGround = new Spell("Desecrated Ground");
    public readonly Spell GorefiendsGrasp = new Spell("Gorefriend's Grasp");
    public readonly Spell IceboundFortitude = new Spell("Icebound Fortitude");
    public readonly Spell MindFreeze = new Spell("Mind Freeze");
    public readonly Spell RemorselessWinter = new Spell("Remorseless Winter");
    public readonly Spell RuneTap = new Spell("Rune Tap");
    public readonly Spell Strangulate = new Spell("Strangulate");
    public readonly Spell VampiricBlood = new Spell("Vampiric Blood");

    #endregion

    #region Healing Spell

    public readonly Spell Conversion = new Spell("Conversion");
    public readonly Spell DeathPact = new Spell("Death Pact");
    public readonly Spell DeathSiphon = new Spell("Death Siphon");
    public readonly Spell Lichborne = new Spell("Lichborne");

    #endregion

    public DeathknightBlood()
    {
        Main.InternalRange = ObjectManager.Me.GetCombatReach;
        MySettings = DeathknightBloodSettings.GetSettings();
        Main.DumpCurrentSettings<DeathknightBloodSettings>(MySettings);
        UInt128 lastTarget = 0;
        LowHP();

        while (Main.InternalLoop)
        {
            try
            {
                if (!ObjectManager.Me.IsDeadMe)
                {
                    BuffPath();
                    if (!ObjectManager.Me.IsMounted)
                    {
                        if (Fight.InFight && ObjectManager.Me.Target > 0)
                        {
                            if (ObjectManager.Me.Target != lastTarget && (DeathGrip.IsHostileDistanceGood || IcyTouch.IsHostileDistanceGood))
                            {
                                Pull();
                                lastTarget = ObjectManager.Me.Target;
                            }

                            if (MySettings.UseLowCombat && (ObjectManager.Me.Level - ObjectManager.Target.Level >= MySettings.UseLowCombatAtPercentage))
                            {
                                LC = 1;
                                if (ObjectManager.Target.GetDistance < 30)
                                    LowCombat();
                            }
                            else
                            {
                                LC = 0;
                                if (ObjectManager.Target.GetDistance < 30)
                                    Combat();
                            }
                        }
                        if (!ObjectManager.Me.IsCast)
                            Patrolling();
                    }
                }
                else
                    Thread.Sleep(500);
            }
            catch
            {
            }
            Thread.Sleep(100);
        }
    }

    private void LowHP()
    {
        if (MySettings.UseAsphyxiateAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseAsphyxiateAtPercentage;
        
        if (MySettings.UseBoneShieldAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseBoneShieldAtPercentage;

        if (MySettings.UseIceboundFortitudeAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseIceboundFortitudeAtPercentage;

        if (MySettings.UseRemorselessWinterAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseRemorselessWinterAtPercentage;

        if (MySettings.UseRuneTapAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseRuneTapAtPercentage;

        if (MySettings.UseStoneformAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseStoneformAtPercentage;

        if (MySettings.UseWarStompAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseWarStompAtPercentage;

        if (MySettings.UseConversionAtPercentage > HealHP)
            HealHP = MySettings.UseConversionAtPercentage;

        if (MySettings.UseDeathPactAtPercentage > HealHP)
            HealHP = MySettings.UseDeathPactAtPercentage;

        if (MySettings.UseDeathSiphonAtPercentage > HealHP)
            HealHP = MySettings.UseDeathSiphonAtPercentage;

        if (MySettings.UseGiftoftheNaaruAtPercentage > HealHP)
            HealHP = MySettings.UseGiftoftheNaaruAtPercentage;

        if (MySettings.UseLichborneAtPercentage > HealHP)
            HealHP = MySettings.UseLichborneAtPercentage;

        if (MySettings.UseVampiricBloodAtPercentage > HealHP)
            HealHP = MySettings.UseVampiricBloodAtPercentage;

        if (MySettings.UseAntiMagicShellAtPercentage > DecastHP)
            DecastHP = MySettings.UseAntiMagicShellAtPercentage;

        if (MySettings.UseAntiMagicZoneAtPercentage > DecastHP)
            DecastHP = MySettings.UseAntiMagicZoneAtPercentage;

        if (MySettings.UseArcaneTorrentForDecastAtPercentage > DecastHP)
            DecastHP = MySettings.UseArcaneTorrentForDecastAtPercentage;

        if (MySettings.UseAsphyxiateAtPercentage > DecastHP)
            DecastHP = MySettings.UseAsphyxiateAtPercentage;

        if (MySettings.UseMindFreezeAtPercentage > DecastHP)
            DecastHP = MySettings.UseMindFreezeAtPercentage;

        if (MySettings.UseStrangulateAtPercentage > DecastHP)
            DecastHP = MySettings.UseStrangulateAtPercentage;
    }

    private void BuffPath()
    {
        if (MySettings.UsePathofFrost && !ObjectManager.Me.InCombat && _pathofFrostBuffTimer.IsReady 
            && (!PathofFrost.HaveBuff || ObjectManager.Me.AuraIsActiveAndExpireInLessThanMs(PathofFrostBuff, 10000)) && PathofFrost.IsSpellUsable)
        {
            PathofFrost.Cast();
            _pathofFrostBuffTimer = new Timer(1000*10);
        }
    }

    private void Pull()
    {
        if (MySettings.UseDeathGrip && DeathGrip.IsSpellUsable && ObjectManager.Target.GetDistance > Main.InternalRange && DeathGrip.IsHostileDistanceGood)
        {
            DeathGrip.Cast();
            MovementManager.StopMove();
            return;
        }
        if (MySettings.UseIcyTouch && IcyTouch.IsSpellUsable && IcyTouch.IsHostileDistanceGood)
            IcyTouch.Cast();
    }

    private void LowCombat()
    {
        Buff();

        if (MySettings.DoAvoidMelee)
            AvoidMelee();

        if (_onCd.IsReady && ObjectManager.Me.HealthPercent <= DefenseHP)
            DefenseCycle();

        if (ObjectManager.Me.HealthPercent <= HealHP)
            Heal();

        if (MySettings.UseIcyTouch && IcyTouch.IsSpellUsable && IcyTouch.IsHostileDistanceGood)
        {
            IcyTouch.Cast();
            return;
        }
        if (MySettings.UseDeathCoil && DeathCoil.IsSpellUsable && DeathCoil.IsHostileDistanceGood)
        {
            DeathCoil.Cast();
            return;
        }
        if (MySettings.UsePlagueStrike && PlagueStrike.IsSpellUsable && PlagueStrike.IsHostileDistanceGood)
        {
            PlagueStrike.Cast();
            return;
        }
        if (MySettings.UseBloodBoil && BloodBoil.IsSpellUsable && BloodBoil.IsHostileDistanceGood)
            BloodBoil.Cast();
    }

    private void Combat()
    {
        Buff();

        if (MySettings.DoAvoidMelee)
            AvoidMelee();

        DPSCycle();

        if (_onCd.IsReady && ObjectManager.Me.HealthPercent <= DefenseHP)
            DefenseCycle();

        if (ObjectManager.Me.HealthPercent <= HealHP)
            Heal();

        if (ObjectManager.Me.HealthPercent <= DecastHP || (MySettings.UseChainsofIce && ObjectManager.Target.GetMove))
            Decast();

        DPSBurst();
        DPSCycle();
    }

    private void Buff()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (MySettings.UseUnholyPresence && LC == 1 && !UnholyPresence.HaveBuff && ObjectManager.Me.HealthPercent > MySettings.UseBloodPresenceAtPercentage + 10
            && UnholyPresence.IsSpellUsable)
            UnholyPresence.Cast();

        if (MySettings.UseFrostPresence && !MySettings.UseUnholyPresence && LC == 1 && !FrostPresence.HaveBuff
            && ObjectManager.Me.HealthPercent > MySettings.UseBloodPresenceAtPercentage + 10 && FrostPresence.IsSpellUsable)
            FrostPresence.Cast();

        if (MySettings.UseBloodPresence && !BloodPresence.HaveBuff && (LC != 1 || (!MySettings.UseUnholyPresence && !MySettings.UseFrostPresence)) && BloodPresence.IsSpellUsable)
            BloodPresence.Cast();

        if (MySettings.UseHornofWinter && !HornofWinter.HaveBuff && HornofWinter.IsSpellUsable)
            HornofWinter.Cast();

        if (MySettings.UseDeathsAdvance && !ObjectManager.Me.InCombat && ObjectManager.Me.GetMove && DeathsAdvance.IsSpellUsable)
            DeathsAdvance.Cast();

        if (MySettings.UseAlchFlask && ItemsManager.GetItemCount(75525) > 0 && !ObjectManager.Me.HaveBuff(79638) && !ObjectManager.Me.HaveBuff(79640) 
            && !ObjectManager.Me.HaveBuff(79639) && !ItemsManager.IsItemOnCooldown(75525))
            ItemsManager.UseItem(75525);
    }

    private void AvoidMelee()
    {
        if (ObjectManager.Target.GetDistance < MySettings.DoAvoidMeleeDistance && ObjectManager.Target.InCombat)
        {
            Logging.WriteFight("Too Close. Moving Back");
            var maxTimeTimer = new Timer(1000*2);
            MovementsAction.MoveBackward(true);
            while (ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat && !maxTimeTimer.IsReady)
            {
                Others.SafeSleep(300);
            }
            MovementsAction.MoveBackward(false);
            if (maxTimeTimer.IsReady && ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat)
            {
                MovementsAction.MoveForward(true);
                Others.SafeSleep(1000);
                MovementsAction.MoveForward(false);
                MovementManager.Face(ObjectManager.Target.Position);
            }
        }
    }

    private void DefenseCycle()
    {
        if (MySettings.UseAsphyxiate && ObjectManager.Me.HealthPercent <= MySettings.UseAsphyxiateAtPercentage && Asphyxiate.IsSpellUsable
            && Asphyxiate.IsHostileDistanceGood)
        {
            Asphyxiate.Cast();
            _onCd = new Timer(1000*5);
            return;
        }
        if (MySettings.UseBoneShield && !BoneShield.HaveBuff && ObjectManager.Me.HealthPercent <= MySettings.UseBoneShieldAtPercentage 
            && BoneShield.IsSpellUsable)
        {
            BoneShield.Cast();
            return;
        }
        if (MySettings.UseIceboundFortitude && ObjectManager.Me.HealthPercent <= MySettings.UseIceboundFortitudeAtPercentage 
            && IceboundFortitude.IsSpellUsable)
        {
            IceboundFortitude.Cast();
            _onCd = new Timer(1000*12);
            return;
        }
        if (MySettings.UseRemorselessWinter && (ObjectManager.Me.HealthPercent <= MySettings.UseRemorselessWinterAtPercentage
            || ObjectManager.GetUnitInSpellRange(RemorselessWinter.MaxRangeHostile) > 1) && RemorselessWinter.IsSpellUsable)
        {
            RemorselessWinter.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (MySettings.UseRuneTap && ObjectManager.Me.HealthPercent <= MySettings.UseRuneTapAtPercentage && RuneTap.IsSpellUsable)
        {
            RuneTap.Cast();
            _onCd = new Timer(1000*3);
            return;
        }
        if (MySettings.UseStoneform && ObjectManager.Me.HealthPercent <= MySettings.UseStoneformAtPercentage && Stoneform.IsSpellUsable)
        {
            Stoneform.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (MySettings.UseWarStomp && ObjectManager.Me.HealthPercent <= MySettings.UseWarStompAtPercentage && WarStomp.IsSpellUsable
            && ObjectManager.GetUnitInSpellRange(WarStomp.MaxRangeHostile) > 0)
        {
            WarStomp.Cast();
            _onCd = new Timer(1000*2);
        }
    }

    private void Heal()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (MySettings.UseBloodTapForHeal && BloodTap.IsSpellUsable && BloodCharge.BuffStack > 4 && ObjectManager.Me.HealthPercent <= HealHP
            && ObjectManager.Target.GetDistance < 30)
            BloodTap.Cast();

        if (MySettings.UseConversion && ObjectManager.Me.RunicPower > 10 && ObjectManager.Me.HealthPercent <= MySettings.UseConversionAtPercentage
            && Conversion.IsSpellUsable)
        {
            Conversion.Cast();
            while (ObjectManager.Me.IsCast && (ObjectManager.Me.RunicPower > 4 || ObjectManager.Me.HealthPercent < 100))
                Others.SafeSleep(200);
            return;
        }
        if (MySettings.UseDeathPact && ObjectManager.Me.HealthPercent <= MySettings.UseDeathPactAtPercentage && DeathPact.IsSpellUsable)
        {
            DeathPact.Cast();
            return;
        }
        if (MySettings.UseDeathSiphon && ObjectManager.Me.HealthPercent <= MySettings.UseDeathSiphonAtPercentage && DeathSiphon.IsSpellUsable && DeathSiphon.IsHostileDistanceGood)
        {
            DeathSiphon.Cast();
            return;
        }
        if (MySettings.UseGiftoftheNaaru && ObjectManager.Me.HealthPercent <= MySettings.UseGiftoftheNaaruAtPercentage && GiftoftheNaaru.IsSpellUsable)
        {
            GiftoftheNaaru.Cast();
            return;
        }
        if (MySettings.UseLichborne && ObjectManager.Me.HealthPercent <= MySettings.UseLichborneAtPercentage && ObjectManager.Me.RunicPower > 39 && Lichborne.IsSpellUsable)
        {
            Lichborne.Cast();
            return;
        }
        if (MySettings.UseVampiricBlood && ObjectManager.Me.HealthPercent <= MySettings.UseVampiricBloodAtPercentage && VampiricBlood.IsSpellUsable)
            VampiricBlood.Cast();
    }

    private void Decast()
    {
        if (MySettings.UseArcaneTorrentForDecast && ObjectManager.Me.HealthPercent <= MySettings.UseArcaneTorrentForDecastAtPercentage
            && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe && ArcaneTorrent.IsSpellUsable && ObjectManager.Target.GetDistance < 8)
        {
            ArcaneTorrent.Cast();
            return;
        }
        if (MySettings.UseAntiMagicShell && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe
            && ObjectManager.Me.HealthPercent <= MySettings.UseAntiMagicShellAtPercentage && AntiMagicShell.IsSpellUsable)
        {
            AntiMagicShell.Cast();
            return;
        }
        if (MySettings.UseAntiMagicZone && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe
            && ObjectManager.Me.HealthPercent <= MySettings.UseAntiMagicZoneAtPercentage && AntiMagicZone.IsSpellUsable)
        {
            SpellManager.CastSpellByIDAndPosition(51052, ObjectManager.Me.Position);
            return;
        }
        if (MySettings.UseAsphyxiate && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe
            && ObjectManager.Me.HealthPercent <= MySettings.UseAsphyxiateAtPercentage && Asphyxiate.IsSpellUsable && Asphyxiate.IsHostileDistanceGood)
        {
            Asphyxiate.Cast();
            return;
        }
        if (MySettings.UseMindFreeze && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe
            && ObjectManager.Me.HealthPercent <= MySettings.UseMindFreezeAtPercentage && MindFreeze.IsSpellUsable && MindFreeze.IsHostileDistanceGood)
        {
            MindFreeze.Cast();
            return;
        }
        if (MySettings.UseStrangulate && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe && (MySettings.UseStrangulate && ObjectManager.Me.HealthPercent <= MySettings.UseStrangulateAtPercentage
            || MySettings.UseAsphyxiate && ObjectManager.Me.HealthPercent <= MySettings.UseAsphyxiateAtPercentage) && Strangulate.IsSpellUsable && Strangulate.IsHostileDistanceGood)
        {
            Strangulate.Cast();
            return;
        }
        if (MySettings.UseChainsofIce && ObjectManager.Target.GetMove && !ChainsofIce.TargetHaveBuff && ChainsofIce.IsHostileDistanceGood 
            && ChainsofIce.IsSpellUsable)
            ChainsofIce.Cast();
    }

    private void DPSBurst()
    {
        if (MySettings.UseTrinketOne && !ItemsManager.IsItemOnCooldown(_firstTrinket.Entry) && ItemsManager.IsItemUsable(_firstTrinket.Entry))
        {
            ItemsManager.UseItem(_firstTrinket.Name);
            Logging.WriteFight("Use First Trinket Slot");
        }
        if (MySettings.UseTrinketTwo && !ItemsManager.IsItemOnCooldown(_secondTrinket.Entry) && ItemsManager.IsItemUsable(_secondTrinket.Entry))
        {
            ItemsManager.UseItem(_secondTrinket.Name);
            Logging.WriteFight("Use Second Trinket Slot");
        }
        if (MySettings.UseBerserking && Berserking.IsSpellUsable && ObjectManager.Target.GetDistance < 30)
            Berserking.Cast();

        if (MySettings.UseBloodFury && BloodFury.IsSpellUsable && ObjectManager.Target.GetDistance < 30)
            BloodFury.Cast();

        if (MySettings.UseBloodTapForDPS && BloodTap.IsSpellUsable && BloodCharge.BuffStack > 9 && ObjectManager.Target.GetDistance < 30)
            BloodTap.Cast();

        if (MySettings.UseDancingRuneWeapon && DancingRuneWeapon.IsSpellUsable && DancingRuneWeapon.IsHostileDistanceGood)
            DancingRuneWeapon.Cast();
    }

    private void DPSCycle()
    {
        Usefuls.SleepGlobalCooldown();
        try
        {
            Memory.WowMemory.GameFrameLock(); // !!! WARNING - DONT SLEEP WHILE LOCKED - DO FINALLY(GameFrameUnLock()) !!!
            if (Lichborne.HaveBuff && ObjectManager.Me.HealthPercent < 85 && DeathCoil.IsSpellUsable)
            {
                Lua.RunMacroText("/target Player");
                DeathCoil.Cast();
                return;
            }
            if (MySettings.UsePlagueLeech && MySettings.UseOutbreak && !NecroticPlague.KnownSpell && BloodPlague.TargetHaveBuff 
                && FrostFever.TargetHaveBuff && Outbreak.IsSpellUsable && PlagueLeech.IsSpellUsable && !DeathStrike.IsSpellUsable && PlagueLeech.IsHostileDistanceGood)
            {
                PlagueLeech.Cast();
                Others.SafeSleep(1000);
                if (!BloodPlague.TargetHaveBuff && Outbreak.IsSpellUsable && Outbreak.IsHostileDistanceGood)
                    Outbreak.Cast();
                return;
            }

            if (MySettings.UseUnholyBlight && NecroticPlague.KnownSpell && (!NecroticPlague.TargetHaveBuff || ObjectManager.Target.AuraIsActiveAndExpireInLessThanMs(NecroticPlague.Id, 4000))
                && UnholyBlight.IsSpellUsable && ObjectManager.Target.GetDistance < 9)
            {
                UnholyBlight.Cast();
                return;
            }
            else if (MySettings.UseUnholyBlight && UnholyBlight.KnownSpell && (!BloodPlague.TargetHaveBuff || ObjectManager.Target.AuraIsActiveAndExpireInLessThanMs(BloodPlague.Id, 4000)
                || !FrostFever.TargetHaveBuff || ObjectManager.Target.AuraIsActiveAndExpireInLessThanMs(FrostFever.Id, 4000))
                && UnholyBlight.IsSpellUsable && ObjectManager.Target.GetDistance < 9)
            {
                UnholyBlight.Cast();
                return;
            }

            if (MySettings.UseOutbreak && NecroticPlague.KnownSpell && (!NecroticPlague.TargetHaveBuff || ObjectManager.Target.AuraIsActiveAndExpireInLessThanMs(NecroticPlague.Id, 4000))
                && Outbreak.IsSpellUsable && Outbreak.IsHostileDistanceGood)
            {
                Outbreak.Cast();
                return;
            }
            else if (MySettings.UseOutbreak && Outbreak.KnownSpell && (!BloodPlague.TargetHaveBuff || ObjectManager.Target.AuraIsActiveAndExpireInLessThanMs(BloodPlague.Id, 4000)
                || !FrostFever.TargetHaveBuff || ObjectManager.Target.AuraIsActiveAndExpireInLessThanMs(FrostFever.Id, 4000)) 
                && Outbreak.IsSpellUsable && Outbreak.IsHostileDistanceGood)
            {
                Outbreak.Cast();
                return;
            }

            if (MySettings.UseDefile && Defile.IsSpellUsable && Defile.IsHostileDistanceGood)
            {
                SpellManager.CastSpellByIDAndPosition(152280, ObjectManager.Target.Position);
                _defileTimer = new Timer(1000*30);
                return;
            }
            if (MySettings.UseBreathofSindragosa && ObjectManager.Me.RunicPower > 75 && BreathofSindragosa.IsSpellUsable
                && ObjectManager.Target.GetDistance < 11)
            {
                BreathofSindragosa.Cast();
                return;
            }
            if (MySettings.UseDeathStrike && DeathStrike.IsSpellUsable && DeathStrike.IsHostileDistanceGood)
            {
                if (Defile.KnownSpell && _defileTimer.IsReady)
                    return;
                DeathStrike.Cast();
                return;
            }
            if (MySettings.UseDeathCoil && DeathCoil.IsSpellUsable && DeathCoil.IsHostileDistanceGood)
            {
                if (MySettings.UseBreathofSindragosa && !BreathofSindragosa.IsSpellUsable)
                {
                    if ((MySettings.UseLichborne && ObjectManager.Me.HealthPercent <= MySettings.UseLichborneAtPercentage && Lichborne.IsSpellUsable)
                        || (MySettings.UseConversion && ObjectManager.Me.HealthPercent <= MySettings.UseConversionAtPercentage && Conversion.IsSpellUsable))
                        return;
                    DeathCoil.Cast();
                    return;
                }
                else if (!BreathofSindragosa.KnownSpell)
                {
                    if ((MySettings.UseLichborne && ObjectManager.Me.HealthPercent <= MySettings.UseLichborneAtPercentage && Lichborne.IsSpellUsable)
                        || (MySettings.UseConversion && ObjectManager.Me.HealthPercent <= MySettings.UseConversionAtPercentage && Conversion.IsSpellUsable))
                        return;
                    DeathCoil.Cast();
                    return;
                }
            }

            if (MySettings.UsePlagueStrike && NecroticPlague.KnownSpell && (!NecroticPlague.TargetHaveBuff || ObjectManager.Target.AuraIsActiveAndExpireInLessThanMs(NecroticPlague.Id, 4000))
                && PlagueStrike.IsSpellUsable && PlagueStrike.IsHostileDistanceGood)
            {
                PlagueStrike.Cast();
                return;
            }
            else if (MySettings.UsePlagueStrike && (!BloodPlague.TargetHaveBuff || ObjectManager.Target.AuraIsActiveAndExpireInLessThanMs(BloodPlague.Id, 4000))
                && !Outbreak.IsSpellUsable && !UnholyBlight.IsSpellUsable && PlagueStrike.IsSpellUsable && PlagueStrike.IsHostileDistanceGood)
            {
                PlagueStrike.Cast();
                return;
            }

            if (MySettings.UseIcyTouch && NecroticPlague.KnownSpell && (!NecroticPlague.TargetHaveBuff || ObjectManager.Target.AuraIsActiveAndExpireInLessThanMs(NecroticPlague.Id, 4000))
                && IcyTouch.IsSpellUsable && IcyTouch.IsHostileDistanceGood)
            {
                IcyTouch.Cast();
                return;
            }
            else if (MySettings.UseIcyTouch && (!FrostFever.TargetHaveBuff || ObjectManager.Target.AuraIsActiveAndExpireInLessThanMs(FrostFever.Id, 4000))
                && !Outbreak.IsSpellUsable && !UnholyBlight.IsSpellUsable && IcyTouch.IsSpellUsable && IcyTouch.IsHostileDistanceGood)
            {
                IcyTouch.Cast();
                return;
            }

            if (MySettings.UseGorefiendsGrasp && GorefiendsGrasp.IsSpellUsable && ObjectManager.GetUnitInSpellRange(GorefiendsGrasp.MaxRangeHostile) > 2)
            {
                GorefiendsGrasp.Cast();
                return;
            }
            /* CURRENTLY TOO WEAK FOR SINGLE TARGET OR AOE
            if (MySettings.UseDeathandDecay && !Defile.KnownSpell && DeathandDecay.IsSpellUsable && DeathandDecay.IsHostileDistanceGood)
            {
                SpellManager.CastSpellByIDAndPosition(43265, ObjectManager.Target.Position);
                return;
            }
             * */
            if (MySettings.UseArmyoftheDead && ArmyoftheDead.IsSpellUsable && ObjectManager.GetUnitInSpellRange(ArmyoftheDead.MaxRangeHostile) > 3)
            {
                ArmyoftheDead.Cast();
                return;
            }
            if (MySettings.UseSoulReaper && ObjectManager.Target.HealthPercent < 35 && SoulReaper.IsSpellUsable && !DeathStrike.IsSpellUsable 
                && SoulReaper.IsHostileDistanceGood)
            {
                SoulReaper.Cast();
                return;
            }
            if (MySettings.UseBloodBoil && BloodBoil.IsSpellUsable && (!DeathStrike.IsSpellUsable || CrimsonScourge.HaveBuff) && BloodBoil.IsHostileDistanceGood)
            {
                BloodBoil.Cast();
                return;
            }
            if ((!MySettings.UseDeathStrike || !DeathStrike.KnownSpell) && MySettings.UsePlagueStrike && PlagueStrike.IsSpellUsable && PlagueStrike.IsHostileDistanceGood)
            {
                PlagueStrike.Cast();
                return;
            }
            if ((!MySettings.UseDeathStrike || !DeathStrike.KnownSpell) && MySettings.UseIcyTouch && IcyTouch.IsSpellUsable && IcyTouch.IsHostileDistanceGood)
            {
                IcyTouch.Cast();
                return;
            }
            if (MySettings.UseArcaneTorrentForResource && ObjectManager.Me.RunicPowerPercentage < 85 && ArcaneTorrent.IsSpellUsable)
            {
                ArcaneTorrent.Cast();
                return;
            }
            if (MySettings.UseEmpowerRuneWeapon && ObjectManager.Me.RunicPowerPercentage < 75 && EmpowerRuneWeapon.IsSpellUsable)
                EmpowerRuneWeapon.Cast();
        }
        finally
        {
            Memory.WowMemory.GameFrameUnLock();
        }
    }

    private void Patrolling()
    {
        if (!ObjectManager.Me.IsMounted)
        {
            Buff();
            Heal();
        }
    }

    #region Nested type: DeathknightBloodSettings

    [Serializable]
    public class DeathknightBloodSettings : Settings
    {
        public bool DoAvoidMelee = false;
        public int DoAvoidMeleeDistance = 0;
        public bool UseAlchFlask = true;
        public bool UseAntiMagicShell = true;
        public int UseAntiMagicShellAtPercentage = 100;
        public bool UseAntiMagicZone = true;
        public int UseAntiMagicZoneAtPercentage = 100;
        public bool UseArcaneTorrentForDecast = true;
        public int UseArcaneTorrentForDecastAtPercentage = 100;
        public bool UseArcaneTorrentForResource = true;
        public bool UseArmyoftheDead = true;
        public bool UseAsphyxiate = true;
        public int UseAsphyxiateAtPercentage = 90;
        public bool UseBerserking = true;
        public bool UseBloodBoil = true;
        public bool UseBloodFury = true;
        public bool UseBloodPresence = true;
        public int UseBloodPresenceAtPercentage = 50;
        public bool UseBloodTapForDPS = true;
        public bool UseBloodTapForHeal = true;
        public bool UseBreathofSindragosa = true;
        public bool UseBoneShield = true;
        public int UseBoneShieldAtPercentage = 100;
        public bool UseChainsofIce = false;
        public bool UseConversion = true;
        public int UseConversionAtPercentage = 45;
        public bool UseDancingRuneWeapon = true;
        public bool UseDeathCoil = true;
        public bool UseDeathGrip = true;
        public bool UseDeathPact = true;
        public int UseDeathPactAtPercentage = 55;
        public bool UseDeathSiphon = true;
        public int UseDeathSiphonAtPercentage = 80;
        public bool UseDeathStrike = true;
        public bool UseDeathandDecay = true;
        public bool UseDefile = true;
        public bool UseDeathsAdvance = true;
        public bool UseEmpowerRuneWeapon = true;
        public bool UseFrostPresence = true;
        public bool UseGiftoftheNaaru = true;
        public int UseGiftoftheNaaruAtPercentage = 80;
        public bool UseGorefiendsGrasp = true;
        public bool UseHornofWinter = true;
        public bool UseIceboundFortitude = true;
        public int UseIceboundFortitudeAtPercentage = 80;
        public bool UseIcyTouch = true;
        public bool UseLichborne = true;
        public int UseLichborneAtPercentage = 45;
        public bool UseLowCombat = true;
        public int UseLowCombatAtPercentage = 15;
        public bool UseMindFreeze = true;
        public int UseMindFreezeAtPercentage = 100;
        public bool UseOutbreak = true;
        public bool UsePathofFrost = true;
        public bool UsePlagueLeech = true;
        public bool UsePlagueStrike = true;
        public bool UseRemorselessWinter = true;
        public int UseRemorselessWinterAtPercentage = 70;
        public bool UseRuneTap = true;
        public int UseRuneTapAtPercentage = 70;
        public bool UseSoulReaper = true;
        public bool UseStoneform = true;
        public int UseStoneformAtPercentage = 80;
        public bool UseStrangulate = true;
        public int UseStrangulateAtPercentage = 100;
        public bool UseTrinketOne = true;
        public bool UseTrinketTwo = true;
        public bool UseUnholyBlight = true;
        public bool UseUnholyPresence = true;
        public bool UseVampiricBlood = true;
        public int UseVampiricBloodAtPercentage = 70;
        public bool UseWarStomp = true;
        public int UseWarStompAtPercentage = 80;

        public DeathknightBloodSettings()
        {
            ConfigWinForm("Deathknight Blood Settings");
            /* Professions & Racials */
            AddControlInWinForm("Use Arcane Torrent for Interrupt", "UseArcaneTorrentForDecast", "Professions && Racials", "AtPercentage");
            AddControlInWinForm("Use Arcane Torrent for Resource", "UseArcaneTorrentForResource", "Professions && Racials");
            AddControlInWinForm("Use Berserking", "UseBerserking", "Professions && Racials");
            AddControlInWinForm("Use Blood Fury", "UseBloodFury", "Professions && Racials");
            AddControlInWinForm("Use Gift of the Naaru", "UseGiftoftheNaaru", "Professions && Racials", "AtPercentage");
            AddControlInWinForm("Use Stoneform", "UseStoneform", "Professions && Racials", "AtPercentage");
            AddControlInWinForm("Use War Stomp", "UseWarStomp", "Professions && Racials", "AtPercentage");
            /* Deathknight Presence & Buffs */
            AddControlInWinForm("Use Blood Presence", "UseBloodPresence", "Deathknight Presence && Buffs", "AtPercentage");
            AddControlInWinForm("Use Frost Presence", "UseFrostPresence", "Deathknight Presence && Buffs");
            AddControlInWinForm("Use Horn of Winter", "UseHornofWinter", "Deathknight Presence && Buffs");
            AddControlInWinForm("Use Path of Frost", "UsePathofFrost", "Deathknight Presence && Buffs");
            AddControlInWinForm("Use Unholy Presence", "UseUnholyPresence", "Deathknight Presence && Buffs");
            /* Offensive Spell */
            AddControlInWinForm("Use Blood Boil", "UseBloodBoil", "Offensive Spell");
            AddControlInWinForm("Use Death Coil", "UseDeathCoil", "Offensive Spell");
            AddControlInWinForm("Use Death and Decay", "UseDeathandDecay", "Offensive Spell");
            AddControlInWinForm("Use Death Strike", "UseDeathStrike", "Offensive Spell");
            AddControlInWinForm("Use Defile", "UseDefile", "Offensive Spell");
            AddControlInWinForm("Use Icy Touch", "UseIcyTouch", "Offensive Spell");
            AddControlInWinForm("Use Plague Leech", "UsePlagueLeech", "Offensive Spell");
            AddControlInWinForm("Use Plague Strike", "UsePlagueStrike", "Offensive Spell");
            AddControlInWinForm("Use Soul Reaper", "UseSoulReaper", "Offensive Spell");
            AddControlInWinForm("Use Unholy Blight", "UseUnholyBlight", "Offensive Spell");
            /* Offensive Cooldown */
            AddControlInWinForm("Use Blood Tap for DPS", "UseBloodTapForDPS", "Offensive Cooldown");
            AddControlInWinForm("Use Blood Tap for Healing", "UseBloodTapForHeal", "Offensive Cooldown");
            AddControlInWinForm("Use Breath of Sindragosa", "UseBreathofSindragosa", "Offensive Cooldown");
            AddControlInWinForm("Use Dancing Rune Weapon", "UseDancingRuneWeapon", "Offensive Cooldown");
            AddControlInWinForm("Use Death Grip", "UseDeathGrip", "Offensive Cooldown");
            AddControlInWinForm("Use Empower Rune Weapon", "UseEmpowerRuneWeapon", "Offensive Cooldown");
            AddControlInWinForm("Use Outbreak", "UseOutbreak", "Offensive Cooldown");
            /* Defensive Cooldown */
            AddControlInWinForm("Use Anti-Magic Shell", "UseAntiMagicShell", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Anti-Magic Zone", "UseAntiMagicZone", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Army of the Dead", "UseArmyoftheDead", "Defensive Cooldown");
            AddControlInWinForm("Use Asphyxiate", "UseAsphyxiate", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Bone Shield", "UseBoneShield", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Chains of Ice", "UseChainsofIce", "Defensive Cooldown");
            AddControlInWinForm("Use Death's Advance", "UseDeathsAdvance", "Defensive Cooldown");
            AddControlInWinForm("Use Gorefiend's Grasp", "UseGorefiendsGrasp", "Defensive Cooldown");
            AddControlInWinForm("Use Icebound Fortitude", "UseIceboundFortitude", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Mind Freeze", "UseMindFreeze", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Remorseless Winter", "UseRemorseless Winter", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Rune Tap", "UseRuneTap", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Strangulate", "UseStrangulate", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Vampiric Blood", "UseVampiricBlood", "Defensive Cooldown", "AtPercentage");
            /* Healing Spell */
            AddControlInWinForm("Use Conversion", "UseConversion", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Death Pact", "UseDeathPact", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Death Siphon", "UseDeathSiphon", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Lichborne", "UseLichborne", "Healing Spell", "AtPercentage");
            /* Game Settings */
            AddControlInWinForm("Use Low Combat Settings - Level Differnce", "UseLowCombat", "Game Settings", "AtPercentage");
            AddControlInWinForm("Use Trinket One", "UseTrinketOne", "Game Settings");
            AddControlInWinForm("Use Trinket Two", "UseTrinketTwo", "Game Settings");
            AddControlInWinForm("Use Engineer Gloves", "UseEngGlove", "Game Settings");
            AddControlInWinForm("Use Alchemist Flask", "UseAlchFlask", "Game Settings");
            AddControlInWinForm("Do avoid melee (Off Advised!!)", "DoAvoidMelee", "Game Settings");
            AddControlInWinForm("Avoid melee distance (1 to 4)", "DoAvoidMeleeDistance", "Game Settings");
        }

        public static DeathknightBloodSettings CurrentSetting { get; set; }

        public static DeathknightBloodSettings GetSettings()
        {
            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Deathknight_Blood.xml";
            if (File.Exists(currentSettingsFile))
            {
                return
                    CurrentSetting = Load<DeathknightBloodSettings>(currentSettingsFile);
            }
            return new DeathknightBloodSettings();
        }
    }

    #endregion
}

public class DeathknightUnholy
{
    private static DeathknightUnholySettings MySettings = DeathknightUnholySettings.GetSettings();

    #region General Timers & Variables

    private readonly WoWItem _firstTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET);
    private readonly WoWItem _secondTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET, 2);
    public int DecastHP = 0;
    public int DefenseHP = 0;
    public int HealHP = 0;
    public int LC = 0;

    private Timer _onCd = new Timer(0);

    #endregion

    #region Professions & Racials

    public readonly Spell ArcaneTorrent = new Spell("Arcane Torrent");
    public readonly Spell Berserking = new Spell("Berserking");
    public readonly Spell BloodFury = new Spell("Blood Fury");
    public readonly Spell GiftoftheNaaru = new Spell("Gift of the Naaru");
    public readonly Spell Stoneform = new Spell("Stoneform");
    public readonly Spell WarStomp = new Spell("War Stomp");

    #endregion

    #region Deathknight Presence & Buffs

    public readonly Spell BloodPlague = new Spell(55078);
    public readonly Spell BloodPresence = new Spell("Blood Presence");
    public readonly Spell FrostFever = new Spell(55095);
    public readonly Spell FrostPresence = new Spell("Frost Presence");
    public readonly Spell HornofWinter = new Spell("Horn of Winter");
    public readonly Spell NecroticPlague = new Spell(152281);
    public readonly Spell PathofFrost = new Spell("Path of Frost");
    public readonly uint PathofFrostBuff = 3714;
    public readonly Spell ShadowInfusion = new Spell(91342);
    public readonly Spell SuddenDoom = new Spell(81340);
    public readonly Spell UnholyPresence = new Spell("Unholy Presence");
    private Timer _pathofFrostBuffTimer = new Timer(0);

    #endregion

    #region Offensive Spell

    public readonly Spell BloodBoil = new Spell("Blood Boil");
    public readonly Spell DeathandDecay = new Spell("Death and Decay");
    public readonly Spell DeathCoil = new Spell("Death Coil");
    public readonly Spell Defile = new Spell("Defile");
    public readonly Spell FesteringStrike = new Spell("Festering Strike");
    public readonly Spell IcyTouch = new Spell("Icy Touch");
    public readonly Spell PlagueLeech = new Spell("Plague Leech");
    public readonly Spell PlagueStrike = new Spell("Plague Strike");
    public readonly Spell ScourgeStrike = new Spell("Scourge Strike");
    public readonly Spell SoulReaper = new Spell("Soul Reaper");
    public readonly Spell UnholyBlight = new Spell("Unholy Blight");
    private Timer _defileTimer = new Timer(0);

    #endregion

    #region Offensive Cooldown

    public readonly Spell BloodTap = new Spell("Blood Tap");
    public readonly Spell BloodCharge = new Spell(114851);
    public readonly Spell BreathofSindragosa = new Spell("Breath of Sindragosa");
    public readonly Spell DarkTransformation = new Spell("Dark Transformation");
    public readonly Spell DeathGrip = new Spell("Death Grip");
    public readonly Spell EmpowerRuneWeapon = new Spell("Empower Rune Weapon");
    public readonly Spell Outbreak = new Spell("Outbreak");
    public readonly Spell RaiseDead = new Spell("Raise Dead");
    public readonly Spell SummonGargoyle = new Spell("Summon Gargoyle");

    #endregion

    #region Defensive Cooldown

    public readonly Spell AntiMagicShell = new Spell("Anti-Magic Shell");
    public readonly Spell AntiMagicZone = new Spell("Anti-Magic Zone");
    public readonly Spell ArmyoftheDead = new Spell("Army of the Dead");
    public readonly Spell Asphyxiate = new Spell("Asphyxiate");
    public readonly Spell ChainsofIce = new Spell("Chains of Ice");
    public readonly Spell DeathsAdvance = new Spell("Death's Advance");
    public readonly Spell DesecratedGround = new Spell("Desecrated Ground");
    public readonly Spell GorefiendsGrasp = new Spell("Gorefriend's Grasp");
    public readonly Spell IceboundFortitude = new Spell("Icebound Fortitude");
    public readonly Spell MindFreeze = new Spell("Mind Freeze");
    public readonly Spell RemorselessWinter = new Spell("Remorseless Winter");
    public readonly Spell Strangulate = new Spell("Strangulate");

    #endregion

    #region Healing Spell

    public readonly Spell Conversion = new Spell("Conversion");
    public readonly Spell DeathPact = new Spell("Death Pact");
    public readonly Spell DeathSiphon = new Spell("Death Siphon");
    public readonly Spell DeathStrike = new Spell("Death Strike");
    public readonly Spell Lichborne = new Spell("Lichborne");

    #endregion

    public DeathknightUnholy()
    {
        Main.InternalAggroRange = 29f;
        Main.InternalRange = ObjectManager.Me.GetCombatReach;
        MySettings = DeathknightUnholySettings.GetSettings();
        Main.DumpCurrentSettings<DeathknightUnholySettings>(MySettings);
        UInt128 lastTarget = 0;
        LowHP();

        while (Main.InternalLoop)
        {
            try
            {
                if (!ObjectManager.Me.IsDeadMe)
                {
                    BuffPath();
                    if (!ObjectManager.Me.IsMounted)
                    {
                        if (Fight.InFight && ObjectManager.Me.Target > 0)
                        {
                            if (ObjectManager.Me.Target != lastTarget && (DeathGrip.IsHostileDistanceGood || IcyTouch.IsHostileDistanceGood))
                            {
                                Pull();
                                lastTarget = ObjectManager.Me.Target;
                            }

                            if (MySettings.UseLowCombat && (ObjectManager.Me.Level - ObjectManager.Target.Level >= MySettings.UseLowCombatAtPercentage))
                            {
                                LC = 1;
                                if (ObjectManager.Target.GetDistance < Main.InternalAggroRange)
                                    LowCombat();
                            }
                            else
                            {
                                LC = 0;
                                if (ObjectManager.Target.GetDistance < Main.InternalAggroRange)
                                    Combat();
                            }
                        }
                        if (!ObjectManager.Me.IsCast)
                            Patrolling();
                    }
                }
                else
                    Thread.Sleep(500);
            }
            catch
            {
            }
            Thread.Sleep(100);
        }
    }

    private void LowHP()
    {
        if (MySettings.UseAsphyxiateAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseAsphyxiateAtPercentage;

        if (MySettings.UseIceboundFortitudeAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseIceboundFortitudeAtPercentage;

        if (MySettings.UseRemorselessWinterAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseRemorselessWinterAtPercentage;

        if (MySettings.UseStoneformAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseStoneformAtPercentage;

        if (MySettings.UseWarStompAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseWarStompAtPercentage;

        if (MySettings.UseConversionAtPercentage > HealHP)
            HealHP = MySettings.UseConversionAtPercentage;

        if (MySettings.UseDeathPactAtPercentage > HealHP)
            HealHP = MySettings.UseDeathPactAtPercentage;

        if (MySettings.UseDeathSiphonAtPercentage > HealHP)
            HealHP = MySettings.UseDeathSiphonAtPercentage;

        if (MySettings.UseDeathStrikeAtPercentage > HealHP)
            HealHP = MySettings.UseDeathStrikeAtPercentage;

        if (MySettings.UseGiftoftheNaaruAtPercentage > HealHP)
            HealHP = MySettings.UseGiftoftheNaaruAtPercentage;

        if (MySettings.UseLichborneAtPercentage > HealHP)
            HealHP = MySettings.UseLichborneAtPercentage;

        if (MySettings.UseAntiMagicShellAtPercentage > DecastHP)
            DecastHP = MySettings.UseAntiMagicShellAtPercentage;

        if (MySettings.UseAntiMagicZoneAtPercentage > DecastHP)
            DecastHP = MySettings.UseAntiMagicZoneAtPercentage;

        if (MySettings.UseArcaneTorrentForDecastAtPercentage > DecastHP)
            DecastHP = MySettings.UseArcaneTorrentForDecastAtPercentage;

        if (MySettings.UseAsphyxiateAtPercentage > DecastHP)
            DecastHP = MySettings.UseAsphyxiateAtPercentage;

        if (MySettings.UseMindFreezeAtPercentage > DecastHP)
            DecastHP = MySettings.UseMindFreezeAtPercentage;

        if (MySettings.UseStrangulateAtPercentage > DecastHP)
            DecastHP = MySettings.UseStrangulateAtPercentage;
    }

    private void BuffPath()
    {
        if (MySettings.UsePathofFrost && !ObjectManager.Me.InCombat && _pathofFrostBuffTimer.IsReady 
            && (!PathofFrost.HaveBuff || ObjectManager.Me.AuraIsActiveAndExpireInLessThanMs(PathofFrostBuff, 10000)) && PathofFrost.IsSpellUsable)
        {
            PathofFrost.Cast();
            _pathofFrostBuffTimer = new Timer(1000*10);
        }
    }

    private void Pull()
    {
        if (ObjectManager.Pet.IsAlive)
        {
            Lua.RunMacroText("/petattack");
            Logging.WriteFight("Cast Pet Attack");
        }

        if (MySettings.UseDeathGrip && DeathGrip.IsSpellUsable && ObjectManager.Target.GetDistance > Main.InternalRange && DeathGrip.IsHostileDistanceGood)
        {
            DeathGrip.Cast();
            MovementManager.StopMove();
            return;
        }
        if (MySettings.UseIcyTouch && IcyTouch.IsSpellUsable && IcyTouch.IsHostileDistanceGood)
            IcyTouch.Cast();
    }

    private void LowCombat()
    {
        Buff();

        if (MySettings.DoAvoidMelee)
            AvoidMelee();

        if (_onCd.IsReady && ObjectManager.Me.HealthPercent <= DefenseHP)
            DefenseCycle();

        if (ObjectManager.Me.HealthPercent <= HealHP)
            Heal();

        if (MySettings.UseIcyTouch && IcyTouch.IsSpellUsable && IcyTouch.IsHostileDistanceGood)
        {
            IcyTouch.Cast();
            return;
        }
        if (MySettings.UseDeathCoil && DeathCoil.IsSpellUsable && DeathCoil.IsHostileDistanceGood)
        {
            DeathCoil.Cast();
            return;
        }
        if (MySettings.UseScourgeStrike && ScourgeStrike.IsSpellUsable && ScourgeStrike.IsHostileDistanceGood)
        {
            ScourgeStrike.Cast();
            return;
        }
        if (MySettings.UseBloodBoil && BloodBoil.IsSpellUsable && BloodBoil.IsHostileDistanceGood)
            BloodBoil.Cast();
    }

    private void Combat()
    {
        Buff();

        if (MySettings.DoAvoidMelee)
            AvoidMelee();

        DPSCycle();

        if (_onCd.IsReady && ObjectManager.Me.HealthPercent <= DefenseHP)
            DefenseCycle();

        if (ObjectManager.Me.HealthPercent <= HealHP)
            Heal();

        if (ObjectManager.Me.HealthPercent <= DecastHP || (MySettings.UseChainsofIce && ObjectManager.Target.GetMove))
            Decast();

        DPSBurst();
        DPSCycle();
    }

    private void Buff()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (MySettings.UseRaiseDead && (ObjectManager.Pet.Health == 0 || ObjectManager.Pet.Guid == 0) && RaiseDead.IsSpellUsable)
        {
            Logging.WriteFight(" - PET DEAD - ");
            Logging.WriteFight(" - SUMMONING PET - ");
            RaiseDead.Cast();
        }
        if (MySettings.UseUnholyPresence && !UnholyPresence.HaveBuff && (ObjectManager.Me.HealthPercent > MySettings.UseBloodPresenceAtPercentage + 10 || !MySettings.UseBloodPresence)
            && UnholyPresence.IsSpellUsable)
            UnholyPresence.Cast();

        if (MySettings.UseFrostPresence && !MySettings.UseUnholyPresence && !FrostPresence.HaveBuff 
            && (ObjectManager.Me.HealthPercent > MySettings.UseBloodPresenceAtPercentage + 10 || !MySettings.UseBloodPresence) && FrostPresence.IsSpellUsable)
            FrostPresence.Cast();

        if (MySettings.UseBloodPresence && !BloodPresence.HaveBuff && ObjectManager.Me.HealthPercent <= MySettings.UseBloodPresenceAtPercentage 
            && BloodPresence.IsSpellUsable)
            BloodPresence.Cast();

        if (MySettings.UseHornofWinter && !HornofWinter.HaveBuff && HornofWinter.IsSpellUsable)
            HornofWinter.Cast();

        if (MySettings.UseDeathsAdvance && !ObjectManager.Me.InCombat && ObjectManager.Me.GetMove && DeathsAdvance.IsSpellUsable)
            DeathsAdvance.Cast();

        if (MySettings.UseAlchFlask && ItemsManager.GetItemCount(75525) > 0 && !ObjectManager.Me.HaveBuff(79638) && !ObjectManager.Me.HaveBuff(79640) && !ObjectManager.Me.HaveBuff(79639)
            && !ItemsManager.IsItemOnCooldown(75525))
            ItemsManager.UseItem(75525);
    }

    private void AvoidMelee()
    {
        if (ObjectManager.Target.GetDistance < MySettings.DoAvoidMeleeDistance && ObjectManager.Target.InCombat)
        {
            Logging.WriteFight("Too Close. Moving Back");
            var maxTimeTimer = new Timer(1000*2);
            MovementsAction.MoveBackward(true);
            while (ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat && !maxTimeTimer.IsReady)
            {
                Others.SafeSleep(300);
            }
            MovementsAction.MoveBackward(false);
            if (maxTimeTimer.IsReady && ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat)
            {
                MovementsAction.MoveForward(true);
                Others.SafeSleep(1000);
                MovementsAction.MoveForward(false);
                MovementManager.Face(ObjectManager.Target.Position);
            }
        }
    }

    private void DefenseCycle()
    {
        if (MySettings.UseAsphyxiate && ObjectManager.Me.HealthPercent <= MySettings.UseAsphyxiateAtPercentage && Asphyxiate.IsSpellUsable
            && Asphyxiate.IsHostileDistanceGood)
        {
            Asphyxiate.Cast();
            _onCd = new Timer(1000*5);
            return;
        }
        if (MySettings.UseIceboundFortitude && ObjectManager.Me.HealthPercent <= MySettings.UseIceboundFortitudeAtPercentage
            && IceboundFortitude.IsSpellUsable)
        {
            IceboundFortitude.Cast();
            _onCd = new Timer(1000*12);
            return;
        }
        if (MySettings.UseRemorselessWinter && (ObjectManager.Me.HealthPercent <= MySettings.UseRemorselessWinterAtPercentage
            || ObjectManager.GetUnitInSpellRange(RemorselessWinter.MaxRangeHostile) > 1) && RemorselessWinter.IsSpellUsable)
        {
            RemorselessWinter.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (MySettings.UseStoneform && ObjectManager.Me.HealthPercent <= MySettings.UseStoneformAtPercentage && Stoneform.IsSpellUsable)
        {
            Stoneform.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (MySettings.UseWarStomp && ObjectManager.Me.HealthPercent <= MySettings.UseWarStompAtPercentage && WarStomp.IsSpellUsable
            && ObjectManager.GetUnitInSpellRange(WarStomp.MaxRangeHostile) > 0)
        {
            WarStomp.Cast();
            _onCd = new Timer(1000*2);
        }
    }

    private void Heal()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (MySettings.UseBloodTapForHeal && BloodTap.IsSpellUsable && BloodCharge.BuffStack > 4 && ObjectManager.Me.HealthPercent <= HealHP
            && ObjectManager.Target.GetDistance < 30)
            BloodTap.Cast();

        if (MySettings.UseConversion && ObjectManager.Me.RunicPower > 10 && ObjectManager.Me.HealthPercent <= MySettings.UseConversionAtPercentage
            && Conversion.IsSpellUsable)
        {
            Conversion.Cast();
            while (ObjectManager.Me.IsCast && (ObjectManager.Me.RunicPower > 4 || ObjectManager.Me.HealthPercent < 100))
                Others.SafeSleep(200);
            return;
        }
        if (MySettings.UseDeathPact && ObjectManager.Me.HealthPercent <= MySettings.UseDeathPactAtPercentage && DeathPact.IsSpellUsable)
        {
            DeathPact.Cast();
            return;
        }
        if (MySettings.UseDeathSiphon && ObjectManager.Me.HealthPercent <= MySettings.UseDeathSiphonAtPercentage && DeathSiphon.IsSpellUsable && DeathSiphon.IsHostileDistanceGood)
        {
            DeathSiphon.Cast();
            return;
        }
        if (MySettings.UseDeathStrike && ObjectManager.Target.IsValid && ObjectManager.Target.IsAlive
            && ObjectManager.Me.HealthPercent <= MySettings.UseDeathStrikeAtPercentage && DeathStrike.IsSpellUsable && DeathStrike.IsHostileDistanceGood)
        {
            DeathStrike.Cast();
            return;
        }
        if (MySettings.UseGiftoftheNaaru && ObjectManager.Me.HealthPercent <= MySettings.UseGiftoftheNaaruAtPercentage && GiftoftheNaaru.IsSpellUsable)
        {
            GiftoftheNaaru.Cast();
            return;
        }
        if (MySettings.UseLichborne && ObjectManager.Me.HealthPercent <= MySettings.UseLichborneAtPercentage && ObjectManager.Me.RunicPower > 39 && Lichborne.IsSpellUsable)
            Lichborne.Cast();
    }

    private void Decast()
    {
        if (MySettings.UseArcaneTorrentForDecast && ObjectManager.Me.HealthPercent <= MySettings.UseArcaneTorrentForDecastAtPercentage && ObjectManager.Target.IsCast 
            && ObjectManager.Target.IsTargetingMe && ArcaneTorrent.IsSpellUsable && ObjectManager.Target.GetDistance < 8)
        {
            ArcaneTorrent.Cast();
            return;
        }
        if (MySettings.UseAntiMagicShell && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe
            && ObjectManager.Me.HealthPercent <= MySettings.UseAntiMagicShellAtPercentage && AntiMagicShell.IsSpellUsable)
        {
            AntiMagicShell.Cast();
            return;
        }
        if (MySettings.UseAntiMagicZone && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe
            && ObjectManager.Me.HealthPercent <= MySettings.UseAntiMagicZoneAtPercentage && AntiMagicZone.IsSpellUsable)
        {
            SpellManager.CastSpellByIDAndPosition(51052, ObjectManager.Me.Position);
            return;
        }
        if (MySettings.UseAsphyxiate && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe
            && ObjectManager.Me.HealthPercent <= MySettings.UseAsphyxiateAtPercentage && Asphyxiate.IsSpellUsable && Asphyxiate.IsHostileDistanceGood)
        {
            Asphyxiate.Cast();
            return;
        }
        if (MySettings.UseMindFreeze && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe
            && ObjectManager.Me.HealthPercent <= MySettings.UseMindFreezeAtPercentage && MindFreeze.IsSpellUsable && MindFreeze.IsHostileDistanceGood)
        {
            MindFreeze.Cast();
            return;
        }
        if (MySettings.UseStrangulate && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe && (MySettings.UseStrangulate && ObjectManager.Me.HealthPercent <= MySettings.UseStrangulateAtPercentage
            || MySettings.UseAsphyxiate && ObjectManager.Me.HealthPercent <= MySettings.UseAsphyxiateAtPercentage) && Strangulate.IsSpellUsable && Strangulate.IsHostileDistanceGood)
        {
            Strangulate.Cast();
            return;
        }
        if (MySettings.UseChainsofIce && ObjectManager.Target.GetMove && !ChainsofIce.TargetHaveBuff && ChainsofIce.IsHostileDistanceGood && ChainsofIce.IsSpellUsable)
            ChainsofIce.Cast();
    }

    private void DPSBurst()
    {
        if (MySettings.UseTrinketOne && !ItemsManager.IsItemOnCooldown(_firstTrinket.Entry) && ItemsManager.IsItemUsable(_firstTrinket.Entry))
        {
            ItemsManager.UseItem(_firstTrinket.Name);
            Logging.WriteFight("Use First Trinket Slot");
        }
        if (MySettings.UseTrinketTwo && !ItemsManager.IsItemOnCooldown(_secondTrinket.Entry) && ItemsManager.IsItemUsable(_secondTrinket.Entry))
        {
            ItemsManager.UseItem(_secondTrinket.Name);
            Logging.WriteFight("Use Second Trinket Slot");
        }
        if (MySettings.UseBerserking && Berserking.IsSpellUsable && ObjectManager.Target.GetDistance < 30)
            Berserking.Cast();

        if (MySettings.UseBloodFury && BloodFury.IsSpellUsable && ObjectManager.Target.GetDistance < 30)
            BloodFury.Cast();

        if (MySettings.UseBloodTapForDPS && BloodTap.IsSpellUsable && BloodCharge.BuffStack > 9 && ObjectManager.Target.GetDistance < 30)
            BloodTap.Cast();

        if (MySettings.UseSummonGargoyle && SummonGargoyle.IsSpellUsable && ObjectManager.Target.GetDistance < 30)
            SummonGargoyle.Cast();
    }

    private void DPSCycle()
    {
        Usefuls.SleepGlobalCooldown();
        try
        {
            Memory.WowMemory.GameFrameLock(); // !!! WARNING - DONT SLEEP WHILE LOCKED - DO FINALLY(GameFrameUnLock()) !!!

            if (Lichborne.HaveBuff && ObjectManager.Me.HealthPercent < 85 && DeathCoil.IsSpellUsable)
            {
                Lua.RunMacroText("/target Player");
                DeathCoil.Cast();
                return;
            }
            if (MySettings.UsePlagueLeech && MySettings.UseOutbreak && !NecroticPlague.KnownSpell && BloodPlague.TargetHaveBuff 
                && FrostFever.TargetHaveBuff && Outbreak.IsSpellUsable && PlagueLeech.IsSpellUsable && !FesteringStrike.IsSpellUsable && PlagueLeech.IsHostileDistanceGood)
            {
                PlagueLeech.Cast();
                Others.SafeSleep(1000);
                if (!BloodPlague.TargetHaveBuff && Outbreak.IsSpellUsable && Outbreak.IsHostileDistanceGood)
                    Outbreak.Cast();
                return;
            }

            if (MySettings.UseUnholyBlight && UnholyBlight.KnownSpell && NecroticPlague.KnownSpell && (!NecroticPlague.TargetHaveBuff || ObjectManager.Me.BuffStack(155159) < 15
                || ObjectManager.Target.AuraIsActiveAndExpireInLessThanMs(NecroticPlague.Id, 4000)) && UnholyBlight.IsSpellUsable && ObjectManager.Target.GetDistance < 9)
            {
                UnholyBlight.Cast();
                return;
            }
            else if (MySettings.UseUnholyBlight && UnholyBlight.KnownSpell && (!BloodPlague.TargetHaveBuff || ObjectManager.Target.AuraIsActiveAndExpireInLessThanMs(BloodPlague.Id, 4000)
                || !FrostFever.TargetHaveBuff || ObjectManager.Target.AuraIsActiveAndExpireInLessThanMs(FrostFever.Id, 4000))
                && UnholyBlight.IsSpellUsable && ObjectManager.Target.GetDistance < 9)
            {
                UnholyBlight.Cast();
                return;
            }

            if (MySettings.UseOutbreak && Outbreak.KnownSpell && NecroticPlague.KnownSpell && (!NecroticPlague.TargetHaveBuff || ObjectManager.Me.BuffStack(155159) < 15
                || ObjectManager.Target.AuraIsActiveAndExpireInLessThanMs(NecroticPlague.Id, 4000)) && Outbreak.IsSpellUsable && Outbreak.IsHostileDistanceGood)
            {
                Outbreak.Cast();
                return;
            }
            else if (MySettings.UseOutbreak && Outbreak.KnownSpell && (!BloodPlague.TargetHaveBuff || ObjectManager.Target.AuraIsActiveAndExpireInLessThanMs(BloodPlague.Id, 4000)
                || !FrostFever.TargetHaveBuff || ObjectManager.Target.AuraIsActiveAndExpireInLessThanMs(FrostFever.Id, 4000)) && Outbreak.IsSpellUsable && Outbreak.IsHostileDistanceGood)
            {
                Outbreak.Cast();
                return;
            }

            if (MySettings.UsePlagueStrike && NecroticPlague.KnownSpell && (!NecroticPlague.TargetHaveBuff || ObjectManager.Target.AuraIsActiveAndExpireInLessThanMs(NecroticPlague.Id, 4000))
                && PlagueStrike.IsSpellUsable && PlagueStrike.IsHostileDistanceGood)
            {
                PlagueStrike.Cast();
                return;
            }
            else if (MySettings.UsePlagueStrike && (!BloodPlague.TargetHaveBuff || ObjectManager.Target.AuraIsActiveAndExpireInLessThanMs(BloodPlague.Id, 4000))
                && !Outbreak.IsSpellUsable && !UnholyBlight.IsSpellUsable && PlagueStrike.IsSpellUsable && PlagueStrike.IsHostileDistanceGood)
            {
                PlagueStrike.Cast();
                return;
            }

            if (MySettings.UseIcyTouch && NecroticPlague.KnownSpell && (!NecroticPlague.TargetHaveBuff || ObjectManager.Target.AuraIsActiveAndExpireInLessThanMs(NecroticPlague.Id, 4000))
                && IcyTouch.IsSpellUsable && IcyTouch.IsHostileDistanceGood)
            {
                IcyTouch.Cast();
                return;
            }
            else if (MySettings.UseIcyTouch && (!FrostFever.TargetHaveBuff || ObjectManager.Target.AuraIsActiveAndExpireInLessThanMs(FrostFever.Id, 4000))
                && !Outbreak.IsSpellUsable && !UnholyBlight.IsSpellUsable && IcyTouch.IsSpellUsable && IcyTouch.IsHostileDistanceGood)
            {
                IcyTouch.Cast();
                return;
            }

            if (MySettings.UseDarkTransformation && ObjectManager.Me.BuffStack(91342) > 4 && DarkTransformation.IsSpellUsable)
            {
                DarkTransformation.Cast();
                return;
            }
            if (MySettings.UseGorefiendsGrasp && GorefiendsGrasp.IsSpellUsable && ObjectManager.GetUnitInSpellRange(GorefiendsGrasp.MaxRangeHostile) > 2)
            {
                GorefiendsGrasp.Cast();
                return;
            }
            if (MySettings.UseDeathandDecay && DeathandDecay.IsSpellUsable && ObjectManager.GetUnitInSpellRange(DeathandDecay.MaxRangeHostile) > 2)
            {
                SpellManager.CastSpellByIDAndPosition(43265, ObjectManager.Target.Position);
                return;
            }
            if (MySettings.UseArmyoftheDead && ArmyoftheDead.IsSpellUsable && ObjectManager.GetUnitInSpellRange(ArmyoftheDead.MaxRangeHostile) > 3)
            {
                ArmyoftheDead.Cast();
                return;
            }
            if (MySettings.UseBloodBoil && BloodBoil.IsSpellUsable && ObjectManager.GetUnitInSpellRange(BloodBoil.MaxRangeHostile) > 2)
            {
                BloodBoil.Cast();
                return;
            }
            if (MySettings.UseBreathofSindragosa && ObjectManager.Me.RunicPower > 75 && BreathofSindragosa.IsSpellUsable && ObjectManager.Target.GetDistance < 11)
            {
                BreathofSindragosa.Cast();
                return;
            }
            if (MySettings.UseSoulReaper && ObjectManager.Target.HealthPercent < 45
                && (ObjectManager.Me.HealthPercent > MySettings.UseDeathStrikeAtPercentage || !MySettings.UseDeathStrike)
                && SoulReaper.IsSpellUsable && SoulReaper.IsHostileDistanceGood)
            {
                SoulReaper.Cast();
                return;
            }
            if (MySettings.UseDefile && Defile.IsSpellUsable && Defile.IsHostileDistanceGood)
            {
                SpellManager.CastSpellByIDAndPosition(152280, ObjectManager.Target.Position);
                _defileTimer = new Timer(1000*30);
                return;
            }
            if (MySettings.UseScourgeStrike && ObjectManager.Me.RunicPowerPercentage < 90 && ScourgeStrike.IsSpellUsable && ScourgeStrike.IsHostileDistanceGood)
            {
                if (Defile.KnownSpell && _defileTimer.IsReady)
                    return;
                ScourgeStrike.Cast();
                return;
            }
            if ((!MySettings.UseScourgeStrike || !ScourgeStrike.KnownSpell) && MySettings.UsePlagueStrike && PlagueStrike.IsSpellUsable && PlagueStrike.IsHostileDistanceGood)
            {
                PlagueStrike.Cast();
                return;
            }
            if (MySettings.UseDeathCoil && (ObjectManager.Me.RunicPowerPercentage > 79 || SuddenDoom.HaveBuff
                || !ObjectManager.Pet.HaveBuff(63560)) && DeathCoil.IsSpellUsable && DeathCoil.IsHostileDistanceGood)
            {
                if (MySettings.UseBreathofSindragosa && BreathofSindragosa.KnownSpell && !BreathofSindragosa.IsSpellUsable)
                {
                    if ((MySettings.UseLichborne && ObjectManager.Me.HealthPercent <= MySettings.UseLichborneAtPercentage && Lichborne.IsSpellUsable)
                        || (MySettings.UseConversion && ObjectManager.Me.HealthPercent <= MySettings.UseConversionAtPercentage && Conversion.IsSpellUsable))
                        return;
                    DeathCoil.Cast();
                    return;
                }
                else if(!BreathofSindragosa.KnownSpell)
                {
                    if ((MySettings.UseLichborne && ObjectManager.Me.HealthPercent <= MySettings.UseLichborneAtPercentage && Lichborne.IsSpellUsable)
                        || (MySettings.UseConversion && ObjectManager.Me.HealthPercent <= MySettings.UseConversionAtPercentage && Conversion.IsSpellUsable))
                        return;
                    DeathCoil.Cast();
                    return;
                }
            }
            if (MySettings.UseFesteringStrike && ObjectManager.Me.RunicPowerPercentage < 90 && !ScourgeStrike.IsSpellUsable
                && FesteringStrike.IsSpellUsable && FesteringStrike.IsHostileDistanceGood)
            {
                if (MySettings.UseDeathStrike && ObjectManager.Me.HealthPercent <= MySettings.UseDeathStrikeAtPercentage && DeathStrike.IsSpellUsable)
                    return;
                FesteringStrike.Cast();
                return;
            }
            if (MySettings.UseDeathStrike && (!FesteringStrike.KnownSpell || !MySettings.UseFesteringStrike) && ObjectManager.Me.RunicPowerPercentage < 90 && !ScourgeStrike.IsSpellUsable
                && DeathStrike.IsSpellUsable && DeathStrike.IsHostileDistanceGood)
            {
                DeathStrike.Cast();
                return;
            }
            if (MySettings.UseArcaneTorrentForResource && ObjectManager.Me.RunicPowerPercentage < 85 && ArcaneTorrent.IsSpellUsable)
            {
                ArcaneTorrent.Cast();
                return;
            }
            if (MySettings.UseEmpowerRuneWeapon && ObjectManager.Me.RunicPowerPercentage < 75 && EmpowerRuneWeapon.IsSpellUsable)
                EmpowerRuneWeapon.Cast();
        }
        finally
        {
            Memory.WowMemory.GameFrameUnLock();
        }
    }

    private void Patrolling()
    {
        if (!ObjectManager.Me.IsMounted)
        {
            Buff();
            Heal();
        }
    }

    #region Nested type: DeathknightUnholySettings

    [Serializable]
    public class DeathknightUnholySettings : Settings
    {
        public bool DoAvoidMelee = false;
        public int DoAvoidMeleeDistance = 0;
        public bool UseAlchFlask = true;
        public bool UseAntiMagicShell = true;
        public int UseAntiMagicShellAtPercentage = 100;
        public bool UseAntiMagicZone = true;
        public int UseAntiMagicZoneAtPercentage = 100;
        public bool UseArcaneTorrentForDecast = true;
        public int UseArcaneTorrentForDecastAtPercentage = 100;
        public bool UseArcaneTorrentForResource = true;
        public bool UseArmyoftheDead = true;
        public bool UseAsphyxiate = true;
        public int UseAsphyxiateAtPercentage = 90;
        public bool UseBerserking = true;
        public bool UseBloodBoil = true;
        public bool UseBloodFury = true;
        public bool UseBloodPresence = true;
        public int UseBloodPresenceAtPercentage = 50;
        public bool UseBloodTapForDPS = true;
        public bool UseBloodTapForHeal = true;
        public bool UseBreathofSindragosa = true;
        public bool UseChainsofIce = false;
        public bool UseConversion = true;
        public int UseConversionAtPercentage = 45;
        public bool UseDarkTransformation = true;
        public bool UseDeathCoil = true;
        public bool UseDeathGrip = true;
        public bool UseDeathPact = true;
        public int UseDeathPactAtPercentage = 55;
        public bool UseDeathSiphon = true;
        public int UseDeathSiphonAtPercentage = 80;
        public bool UseDeathStrike = true;
        public int UseDeathStrikeAtPercentage = 80;
        public bool UseDeathandDecay = true;
        public bool UseDefile = true;
        public bool UseDeathsAdvance = true;
        public bool UseEmpowerRuneWeapon = true;
        public bool UseFesteringStrike = true;
        public bool UseFrostPresence = true;
        public bool UseGiftoftheNaaru = true;
        public int UseGiftoftheNaaruAtPercentage = 80;
        public bool UseGorefiendsGrasp = true;
        public bool UseHornofWinter = true;
        public bool UseIceboundFortitude = true;
        public int UseIceboundFortitudeAtPercentage = 80;
        public bool UseIcyTouch = true;
        public bool UseLichborne = true;
        public int UseLichborneAtPercentage = 45;
        public bool UseLowCombat = true;
        public int UseLowCombatAtPercentage = 15;
        public bool UseMindFreeze = true;
        public int UseMindFreezeAtPercentage = 100;
        public bool UseOutbreak = true;
        public bool UsePathofFrost = true;
        public bool UsePlagueLeech = true;
        public bool UsePlagueStrike = true;
        public bool UseRaiseDead = true;
        public bool UseRemorselessWinter = true;
        public int UseRemorselessWinterAtPercentage = 70;
        public bool UseScourgeStrike = true;
        public bool UseSoulReaper = true;
        public bool UseStoneform = true;
        public int UseStoneformAtPercentage = 80;
        public bool UseStrangulate = true;
        public int UseStrangulateAtPercentage = 100;
        public bool UseSummonGargoyle = true;
        public bool UseTrinketOne = true;
        public bool UseTrinketTwo = true;
        public bool UseUnholyBlight = true;
        public bool UseUnholyPresence = true;
        public bool UseWarStomp = true;
        public int UseWarStompAtPercentage = 80;

        public DeathknightUnholySettings()
        {
            ConfigWinForm("Deathknight Unholy Settings");
            /* Professions & Racials */
            AddControlInWinForm("Use Arcane Torrent for Interrupt", "UseArcaneTorrentForDecast", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Arcane Torrent for Resource", "UseArcaneTorrentForResource", "Professions & Racials");
            AddControlInWinForm("Use Berserking", "UseBerserking", "Professions & Racials");
            AddControlInWinForm("Use Blood Fury", "UseBloodFury", "Professions & Racials");
            AddControlInWinForm("Use Gift of the Naaru", "UseGiftoftheNaaru", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Stoneform", "UseStoneform", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use War Stomp", "UseWarStomp", "Professions & Racials", "AtPercentage");
            /* Deathknight Presence & Buffs */
            AddControlInWinForm("Use Frost Presence", "UseFrostPresence", "Deathknight Presence & Buffs");
            AddControlInWinForm("Use Blood Presence", "UseBloodPresence", "Deathknight Presence & Buffs", "AtPercentage");
            AddControlInWinForm("Use Horn of Winter", "UseHornofWinter", "Deathknight Presence & Buffs");
            AddControlInWinForm("Use Path of Frost", "UsePathofFrost", "Deathknight Presence & Buffs");
            AddControlInWinForm("Use Unholy Presence", "UseUnholyPresence", "Deathknight Presence & Buffs");
            /* Offensive Spell */
            AddControlInWinForm("Use Blood Boil", "UseBloodBoil", "Offensive Spell");
            AddControlInWinForm("Use Dark Transformation", "UseDarkTransformation", "Offensive Spell");
            AddControlInWinForm("Use Death Coil", "UseDeathCoil", "Offensive Spell");
            AddControlInWinForm("Use Death and Decay", "UseDeathandDecay", "Offensive Spell");
            AddControlInWinForm("Use Defile", "UseDefile", "Offensive Spell");
            AddControlInWinForm("Use Festering Strike", "UseFesteringStrike", "Offensive Spell");
            AddControlInWinForm("Use Icy Touch", "UseIcyTouch", "Offensive Spell");
            AddControlInWinForm("Use Plague Leech", "UsePlagueLeech", "Offensive Spell");
            AddControlInWinForm("Use Plague Strike", "UsePlagueStrike", "Offensive Spell");
            AddControlInWinForm("Use Soul Reaper", "UseSoulReaper", "Offensive Spell");
            AddControlInWinForm("Use Scourge Strike", "UseScourgeStrike", "Offensive Spell");
            AddControlInWinForm("Use Unholy Blight", "UseUnholyBlight", "Offensive Spell");
            /* Offensive Cooldown */
            AddControlInWinForm("Use Blood Tap for DPS", "UseBloodTapForDPS", "Offensive Cooldown");
            AddControlInWinForm("Use Blood Tap for Healing", "UseBloodTapForHeal", "Offensive Cooldown");
            AddControlInWinForm("Use Breath of Sindragosa", "UseBreathofSindragosa", "Offensive Cooldown");
            AddControlInWinForm("Use Death Grip", "UseDeathGrip", "Offensive Cooldown");
            AddControlInWinForm("Use Empower Rune Weapon", "UseEmpowerRuneWeapon", "Offensive Cooldown");
            AddControlInWinForm("Use Outbreak", "UseOutbreak", "Offensive Cooldown");
            AddControlInWinForm("Use Raise Dead", "UseRaiseDead", "Offensive Cooldown");
            AddControlInWinForm("Use Summon Gargoyle", "UseSummonGargoyle", "Offensive Cooldown");
            /* Defensive Cooldown */
            AddControlInWinForm("Use Anti-Magic Shell", "UseAntiMagicShell", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Anti-Magic Zone", "UseAntiMagicZone", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Army of the Dead", "UseArmyoftheDead", "Defensive Cooldown");
            AddControlInWinForm("Use Asphyxiate", "UseAsphyxiate", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Chains of Ice", "UseChainsofIce", "Defensive Cooldown");
            AddControlInWinForm("Use Death's Advance", "UseDeathsAdvance", "Defensive Cooldown");
            AddControlInWinForm("Use Gorefiend's Grasp", "UseGorefriendsGrasp", "Defensive Cooldown");
            AddControlInWinForm("Use Icebound Fortitude", "UseIceboundFortitude", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Mind Freeze", "UseMindFreeze", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Remorseless Winter", "UseRemorseless Winter", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Strangulate", "UseStrangulate", "Defensive Cooldown", "AtPercentage");
            /* Healing Spell */
            AddControlInWinForm("Use Conversion", "UseConversion", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Death Pact", "UseDeathPact", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Death Siphon", "UseDeathSiphon", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Death Strike", "UseDeathStrike", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Lichborne", "UseLichborne", "Healing Spell", "AtPercentage");
            /* Game Settings */
            AddControlInWinForm("Use Low Combat Settings - Level Difference", "UseLowCombat", "Game Settings", "AtPercentage");
            AddControlInWinForm("Use Trinket One", "UseTrinketOne", "Game Settings");
            AddControlInWinForm("Use Trinket Two", "UseTrinketTwo", "Game Settings");
            AddControlInWinForm("Use Alchemist Flask", "UseAlchFlask", "Game Settings");
            AddControlInWinForm("Do avoid melee (Off Advised!!)", "DoAvoidMelee", "Game Settings");
            AddControlInWinForm("Avoid melee distance (1 to 4)", "DoAvoidMeleeDistance", "Game Settings");
        }

        public static DeathknightUnholySettings CurrentSetting { get; set; }

        public static DeathknightUnholySettings GetSettings()
        {
            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Deathknight_Unholy.xml";
            if (File.Exists(currentSettingsFile))
            {
                return
                    CurrentSetting = Load<DeathknightUnholySettings>(currentSettingsFile);
            }
            return new DeathknightUnholySettings();
        }
    }

    #endregion
}

public class DeathknightFrost
{
    private static DeathknightFrostSettings MySettings = DeathknightFrostSettings.GetSettings();

    #region General Timers & Variables

    private readonly WoWItem _firstTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET);
    private readonly WoWItem _secondTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET, 2);
    public int DecastHP = 0;
    public int DefenseHP = 0;
    public int HealHP = 0;
    public int LC = 0;

    private Timer _onCd = new Timer(0);

    #endregion

    #region Professions & Racials

    public readonly Spell ArcaneTorrent = new Spell("Arcane Torrent");
    public readonly Spell Berserking = new Spell("Berserking");
    public readonly Spell BloodFury = new Spell("Blood Fury");
    public readonly Spell GiftoftheNaaru = new Spell("Gift of the Naaru");
    public readonly Spell Stoneform = new Spell("Stoneform");
    public readonly Spell WarStomp = new Spell("War Stomp");

    #endregion

    #region Deathknight Presence & Buffs

    public readonly Spell BloodPlague = new Spell(55078);
    public readonly Spell BloodPresence = new Spell("Blood Presence");
    public readonly Spell FreezingFog = new Spell(59052);
    public readonly Spell FrostFever = new Spell(55095);
    public readonly Spell FrostPresence = new Spell("Frost Presence");
    public readonly Spell HornofWinter = new Spell("Horn of Winter");
    public readonly Spell KillingMachine = new Spell(51124);
    public readonly Spell PathofFrost = new Spell("Path of Frost");
    public readonly uint PathofFrostBuff = 3714;
    public readonly Spell NecroticPlague = new Spell(152281);
    public readonly Spell UnholyPresence = new Spell("Unholy Presence");
    private Timer _pathofFrostBuffTimer = new Timer(0);

    #endregion

    #region Offensive Spell

    public readonly Spell BloodBoil = new Spell("Blood Boil");
    public readonly Spell BloodStrike = new Spell("Blood Strike");
    public readonly Spell DeathCoil = new Spell("Death Coil");
    public readonly Spell DeathandDecay = new Spell("Death and Decay");
    public readonly Spell FrostStrike = new Spell("Frost Strike");
    public readonly Spell HowlingBlast = new Spell("Howling Blast");
    public readonly Spell IcyTouch = new Spell("Icy Touch");
    public readonly Spell Obliterate = new Spell("Obliterate");
    public readonly Spell PlagueLeech = new Spell("Plague Leech");
    public readonly Spell PlagueStrike = new Spell("Plague Strike");
    public readonly Spell SoulReaper = new Spell("Soul Reaper");
    public readonly Spell UnholyBlight = new Spell("Unholy Blight");
    public readonly Spell Defile = new Spell("Defile");
    private Timer _defileTimer = new Timer(0);

    #endregion

    #region Offensive Cooldown

    public readonly Spell BloodTap = new Spell("Blood Tap");
    public readonly Spell BloodCharge = new Spell(114851);
    public readonly Spell DeathGrip = new Spell("Death Grip");
    public readonly Spell EmpowerRuneWeapon = new Spell("Empower Rune Weapon");
    public readonly Spell Outbreak = new Spell("Outbreak");
    public readonly Spell PillarofFrost = new Spell("Pillar of Frost");

    #endregion

    #region Defensive Cooldown

    public readonly Spell AntiMagicShell = new Spell("Anti-Magic Shell");
    public readonly Spell AntiMagicZone = new Spell("Anti-Magic Zone");
    public readonly Spell ArmyoftheDead = new Spell("Army of the Dead");
    public readonly Spell Asphyxiate = new Spell("Asphyxiate");
    public readonly Spell ChainsofIce = new Spell("Chains of Ice");
    public readonly Spell DeathsAdvance = new Spell("Death's Advance");
    public readonly Spell DesecratedGround = new Spell("Desecrated Ground");
    public readonly Spell GorefiendsGrasp = new Spell("Gorefriend's Grasp");
    public readonly Spell IceboundFortitude = new Spell("Icebound Fortitude");
    public readonly Spell MindFreeze = new Spell("Mind Freeze");
    public readonly Spell RemorselessWinter = new Spell("Remorseless Winter");
    public readonly Spell Strangulate = new Spell("Strangulate");

    #endregion

    #region Healing Spell

    public readonly Spell Conversion = new Spell("Conversion");
    public readonly Spell DeathPact = new Spell("Death Pact");
    public readonly Spell DeathSiphon = new Spell("Death Siphon");
    public readonly Spell DeathStrike = new Spell("Death Strike");
    public readonly Spell Lichborne = new Spell("Lichborne");

    #endregion

    public DeathknightFrost()
    {
        Main.InternalRange = ObjectManager.Me.GetCombatReach;
        MySettings = DeathknightFrostSettings.GetSettings();
        Main.DumpCurrentSettings<DeathknightFrostSettings>(MySettings);
        UInt128 lastTarget = 0;
        LowHP();

        while (Main.InternalLoop)
        {
            try
            {
                if (!ObjectManager.Me.IsDeadMe)
                {
                    BuffPath();
                    if (!ObjectManager.Me.IsMounted)
                    {
                        if (Fight.InFight && ObjectManager.Me.Target > 0)
                        {
                            if (ObjectManager.Me.Target != lastTarget && (DeathGrip.IsHostileDistanceGood || IcyTouch.IsHostileDistanceGood))
                            {
                                Pull();
                                lastTarget = ObjectManager.Me.Target;
                            }

                            if (MySettings.UseLowCombat && (ObjectManager.Me.Level - ObjectManager.Target.Level >= MySettings.UseLowCombatAtPercentage))
                            {
                                LC = 1;
                                if (ObjectManager.Target.GetDistance < 30)
                                    LowCombat();
                            }
                            else
                            {
                                LC = 0;
                                if (ObjectManager.Target.GetDistance < 30)
                                    Combat();
                            }
                        }
                        if (!ObjectManager.Me.IsCast)
                            Patrolling();
                    }
                }
                else
                    Thread.Sleep(500);
            }
            catch
            {
            }
            Thread.Sleep(100);
        }
    }

    private void LowHP()
    {
        if (MySettings.UseAsphyxiateAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseAsphyxiateAtPercentage;

        if (MySettings.UseIceboundFortitudeAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseIceboundFortitudeAtPercentage;

        if (MySettings.UseRemorselessWinterAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseRemorselessWinterAtPercentage;

        if (MySettings.UseStoneformAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseStoneformAtPercentage;

        if (MySettings.UseWarStompAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseWarStompAtPercentage;

        if (MySettings.UseConversionAtPercentage > HealHP)
            HealHP = MySettings.UseConversionAtPercentage;

        if (MySettings.UseDeathPactAtPercentage > HealHP)
            HealHP = MySettings.UseDeathPactAtPercentage;

        if (MySettings.UseDeathSiphonAtPercentage > HealHP)
            HealHP = MySettings.UseDeathSiphonAtPercentage;

        if (MySettings.UseDeathStrikeAtPercentage > HealHP)
            HealHP = MySettings.UseDeathStrikeAtPercentage;

        if (MySettings.UseGiftoftheNaaruAtPercentage > HealHP)
            HealHP = MySettings.UseGiftoftheNaaruAtPercentage;

        if (MySettings.UseLichborneAtPercentage > HealHP)
            HealHP = MySettings.UseLichborneAtPercentage;

        if (MySettings.UseAntiMagicShellAtPercentage > DecastHP)
            DecastHP = MySettings.UseAntiMagicShellAtPercentage;

        if (MySettings.UseAntiMagicZoneAtPercentage > DecastHP)
            DecastHP = MySettings.UseAntiMagicZoneAtPercentage;

        if (MySettings.UseArcaneTorrentForDecastAtPercentage > DecastHP)
            DecastHP = MySettings.UseArcaneTorrentForDecastAtPercentage;

        if (MySettings.UseAsphyxiateAtPercentage > DecastHP)
            DecastHP = MySettings.UseAsphyxiateAtPercentage;

        if (MySettings.UseMindFreezeAtPercentage > DecastHP)
            DecastHP = MySettings.UseMindFreezeAtPercentage;

        if (MySettings.UseStrangulateAtPercentage > DecastHP)
            DecastHP = MySettings.UseStrangulateAtPercentage;
    }

    private void BuffPath()
    {
        if (MySettings.UsePathofFrost && !ObjectManager.Me.InCombat && _pathofFrostBuffTimer.IsReady 
            && (!PathofFrost.HaveBuff || ObjectManager.Me.AuraIsActiveAndExpireInLessThanMs(PathofFrostBuff, 10000)) && PathofFrost.IsSpellUsable)
        {
            PathofFrost.Cast();
            _pathofFrostBuffTimer = new Timer(1000*10);
        }
    }

    private void Pull()
    {
        if (MySettings.UseDeathGrip && DeathGrip.IsSpellUsable && ObjectManager.Target.GetDistance > Main.InternalRange && DeathGrip.IsHostileDistanceGood)
        {
            DeathGrip.Cast();
            MovementManager.StopMove();
            return;
        }
        if (MySettings.UseIcyTouch && IcyTouch.IsSpellUsable && IcyTouch.IsHostileDistanceGood)
            IcyTouch.Cast();
    }

    private void LowCombat()
    {
        Buff();

        if (MySettings.DoAvoidMelee)
            AvoidMelee();

        if (_onCd.IsReady && ObjectManager.Me.HealthPercent <= DefenseHP)
            DefenseCycle();

        if (ObjectManager.Me.HealthPercent <= HealHP)
            Heal();

        if (MySettings.UseHowlingBlast && HowlingBlast.IsSpellUsable && HowlingBlast.IsHostileDistanceGood)
        {
            HowlingBlast.Cast();
            return;
        }
        if (MySettings.UseFrostStrike && FrostStrike.IsSpellUsable && FrostStrike.IsHostileDistanceGood)
        {
            FrostStrike.Cast();
            return;
        }
        if (MySettings.UseDeathCoil && DeathCoil.IsSpellUsable && DeathCoil.IsHostileDistanceGood)
        {
            DeathCoil.Cast();
            return;
        }
        if (MySettings.UsePlagueStrike && PlagueStrike.IsSpellUsable && PlagueStrike.IsHostileDistanceGood)
        {
            PlagueStrike.Cast();
            return;
        }
        if (MySettings.UseBloodBoil && BloodBoil.IsSpellUsable && BloodBoil.IsHostileDistanceGood)
            BloodBoil.Cast();
    }

    private void Combat()
    {
        Buff();

        if (MySettings.DoAvoidMelee)
            AvoidMelee();

        DPSCycle();

        if (_onCd.IsReady && ObjectManager.Me.HealthPercent <= DefenseHP)
            DefenseCycle();

        if (ObjectManager.Me.HealthPercent <= HealHP)
            Heal();

        if (ObjectManager.Me.HealthPercent <= DecastHP || (MySettings.UseChainsofIce && ObjectManager.Target.GetMove))
            Decast();

        DPSBurst();
        DPSCycle();
    }

    private void Buff()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (MySettings.UseFrostPresence && LC != 1 && !FrostPresence.HaveBuff 
            && (ObjectManager.Me.HealthPercent > MySettings.UseBloodPresenceAtPercentage + 10 || !MySettings.UseBloodPresence) && FrostPresence.IsSpellUsable)
            FrostPresence.Cast();

        if (MySettings.UseUnholyPresence && MySettings.UseLowCombat && !UnholyPresence.HaveBuff && LC == 1
            && (ObjectManager.Me.HealthPercent > MySettings.UseBloodPresenceAtPercentage + 10 || !MySettings.UseBloodPresence) && UnholyPresence.IsSpellUsable)
            UnholyPresence.Cast();

        if (MySettings.UseBloodPresence && !BloodPresence.HaveBuff && ObjectManager.Me.HealthPercent <= MySettings.UseBloodPresenceAtPercentage 
            && BloodPresence.IsSpellUsable)
            BloodPresence.Cast();

        if (MySettings.UseHornofWinter && !HornofWinter.HaveBuff && HornofWinter.IsSpellUsable)
        {
            HornofWinter.Cast();
            return;
        }
        if (MySettings.UseDeathsAdvance && !ObjectManager.Me.InCombat && ObjectManager.Me.GetMove && DeathsAdvance.IsSpellUsable)
            DeathsAdvance.Cast();

        if (MySettings.UseAlchFlask && ItemsManager.GetItemCount(75525) > 0 && !ObjectManager.Me.HaveBuff(79638) && !ObjectManager.Me.HaveBuff(79640) 
            && !ObjectManager.Me.HaveBuff(79639) && !ItemsManager.IsItemOnCooldown(75525))
            ItemsManager.UseItem(75525);
    }

    private void AvoidMelee()
    {
        if (ObjectManager.Target.GetDistance < MySettings.DoAvoidMeleeDistance && ObjectManager.Target.InCombat)
        {
            Logging.WriteFight("Too Close. Moving Back");
            var maxTimeTimer = new Timer(1000*2);
            MovementsAction.MoveBackward(true);
            while (ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat && !maxTimeTimer.IsReady)
            {
                Others.SafeSleep(300);
            }
            MovementsAction.MoveBackward(false);
            if (maxTimeTimer.IsReady && ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat)
            {
                MovementsAction.MoveForward(true);
                Others.SafeSleep(1000);
                MovementsAction.MoveForward(false);
                MovementManager.Face(ObjectManager.Target.Position);
            }
        }
    }

    private void DefenseCycle()
    {
        if (MySettings.UseAsphyxiate && ObjectManager.Me.HealthPercent <= MySettings.UseAsphyxiateAtPercentage && Asphyxiate.IsSpellUsable
            && Asphyxiate.IsHostileDistanceGood)
        {
            Asphyxiate.Cast();
            _onCd = new Timer(1000*5);
            return;
        }
        if (MySettings.UseIceboundFortitude && ObjectManager.Me.HealthPercent <= MySettings.UseIceboundFortitudeAtPercentage
            && IceboundFortitude.IsSpellUsable)
        {
            IceboundFortitude.Cast();
            _onCd = new Timer(1000*12);
            return;
        }
        if (MySettings.UseRemorselessWinter && (ObjectManager.Me.HealthPercent <= MySettings.UseRemorselessWinterAtPercentage
            || ObjectManager.GetUnitInSpellRange(RemorselessWinter.MaxRangeHostile) > 1) && RemorselessWinter.IsSpellUsable)
        {
            RemorselessWinter.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (MySettings.UseStoneform && ObjectManager.Me.HealthPercent <= MySettings.UseStoneformAtPercentage && Stoneform.IsSpellUsable)
        {
            Stoneform.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (MySettings.UseWarStomp && ObjectManager.Me.HealthPercent <= MySettings.UseWarStompAtPercentage && WarStomp.IsSpellUsable
            && ObjectManager.GetUnitInSpellRange(WarStomp.MaxRangeHostile) > 0)
        {
            WarStomp.Cast();
            _onCd = new Timer(1000*2);
        }
    }

    private void Heal()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (MySettings.UseBloodTapForHeal && BloodTap.IsSpellUsable && BloodCharge.BuffStack > 4 && ObjectManager.Me.HealthPercent <= HealHP && ObjectManager.Target.GetDistance < 30)
            BloodTap.Cast();

        if (MySettings.UseConversion && ObjectManager.Me.RunicPower > 10 && ObjectManager.Me.HealthPercent <= MySettings.UseConversionAtPercentage
            && Conversion.IsSpellUsable)
        {
            Conversion.Cast();
            while (ObjectManager.Me.IsCast && (ObjectManager.Me.RunicPower > 4 || ObjectManager.Me.HealthPercent < 100))
                Others.SafeSleep(200);
            return;
        }
        if (MySettings.UseDeathPact && ObjectManager.Me.HealthPercent <= MySettings.UseDeathPactAtPercentage && DeathPact.IsSpellUsable)
        {
            DeathPact.Cast();
            return;
        }
        if (MySettings.UseDeathSiphon && ObjectManager.Me.HealthPercent <= MySettings.UseDeathSiphonAtPercentage && DeathSiphon.IsSpellUsable && DeathSiphon.IsHostileDistanceGood)
        {
            DeathSiphon.Cast();
            return;
        }
        if (MySettings.UseDeathStrike && ObjectManager.Target.IsValid && ObjectManager.Target.IsAlive
            && ObjectManager.Me.HealthPercent <= MySettings.UseDeathStrikeAtPercentage && DeathStrike.IsSpellUsable && DeathStrike.IsHostileDistanceGood)
        {
            DeathStrike.Cast();
            return;
        }
        if (MySettings.UseGiftoftheNaaru && ObjectManager.Me.HealthPercent <= MySettings.UseGiftoftheNaaruAtPercentage && GiftoftheNaaru.IsSpellUsable)
        {
            GiftoftheNaaru.Cast();
            return;
        }
        if (MySettings.UseLichborne && ObjectManager.Me.HealthPercent <= MySettings.UseLichborneAtPercentage && ObjectManager.Me.RunicPower > 39 && Lichborne.IsSpellUsable)
            Lichborne.Cast();
    }

    private void Decast()
    {
        if (MySettings.UseArcaneTorrentForDecast && ObjectManager.Me.HealthPercent <= MySettings.UseArcaneTorrentForDecastAtPercentage
            && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe && ArcaneTorrent.IsSpellUsable && ObjectManager.Target.GetDistance < 8)
        {
            ArcaneTorrent.Cast();
            return;
        }
        if (MySettings.UseAntiMagicShell && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe
            && ObjectManager.Me.HealthPercent <= MySettings.UseAntiMagicShellAtPercentage && AntiMagicShell.IsSpellUsable)
        {
            AntiMagicShell.Cast();
            return;
        }
        if (MySettings.UseAntiMagicZone && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe
            && ObjectManager.Me.HealthPercent <= MySettings.UseAntiMagicZoneAtPercentage && AntiMagicZone.IsSpellUsable)
        {
            SpellManager.CastSpellByIDAndPosition(51052, ObjectManager.Me.Position);
            return;
        }
        if (MySettings.UseAsphyxiate && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe
            && ObjectManager.Me.HealthPercent <= MySettings.UseAsphyxiateAtPercentage && Asphyxiate.IsSpellUsable && Asphyxiate.IsHostileDistanceGood)
        {
            Asphyxiate.Cast();
            return;
        }
        if (MySettings.UseMindFreeze && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe
            && ObjectManager.Me.HealthPercent <= MySettings.UseMindFreezeAtPercentage && MindFreeze.IsSpellUsable && MindFreeze.IsHostileDistanceGood)
        {
            MindFreeze.Cast();
            return;
        }
        if (MySettings.UseStrangulate && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe && (MySettings.UseStrangulate && ObjectManager.Me.HealthPercent <= MySettings.UseStrangulateAtPercentage
            || MySettings.UseAsphyxiate && ObjectManager.Me.HealthPercent <= MySettings.UseAsphyxiateAtPercentage) && Strangulate.IsSpellUsable && Strangulate.IsHostileDistanceGood)
        {
            Strangulate.Cast();
            return;
        }
        if (MySettings.UseChainsofIce && ObjectManager.Target.GetMove && !ChainsofIce.TargetHaveBuff && ChainsofIce.IsHostileDistanceGood
            && ChainsofIce.IsSpellUsable)
            ChainsofIce.Cast();
    }

    private void DPSBurst()
    {
        if (MySettings.UseTrinketOne && !ItemsManager.IsItemOnCooldown(_firstTrinket.Entry) && ItemsManager.IsItemUsable(_firstTrinket.Entry))
        {
            ItemsManager.UseItem(_firstTrinket.Name);
            Logging.WriteFight("Use First Trinket Slot");
        }
        if (MySettings.UseTrinketTwo && !ItemsManager.IsItemOnCooldown(_secondTrinket.Entry) && ItemsManager.IsItemUsable(_secondTrinket.Entry))
        {
            ItemsManager.UseItem(_secondTrinket.Name);
            Logging.WriteFight("Use Second Trinket Slot");
        }
        if (MySettings.UseBerserking && Berserking.IsSpellUsable && ObjectManager.Target.GetDistance < 30)
            Berserking.Cast();

        if (MySettings.UseBloodFury && BloodFury.IsSpellUsable && ObjectManager.Target.GetDistance < 30)
            BloodFury.Cast();

        if (MySettings.UseBloodTapForDPS && BloodTap.IsSpellUsable && BloodCharge.BuffStack > 9 && ObjectManager.Target.GetDistance < 30)
            BloodTap.Cast();

        if (MySettings.UsePillarofFrost && PillarofFrost.IsSpellUsable && ObjectManager.Target.GetDistance < 30)
            PillarofFrost.Cast();
    }

    private void DPSCycle()
    {
        Usefuls.SleepGlobalCooldown();
        try
        {
            Memory.WowMemory.GameFrameLock(); // !!! WARNING - DONT SLEEP WHILE LOCKED - DO FINALLY(GameFrameUnLock()) !!!

            if (Lichborne.HaveBuff && ObjectManager.Me.HealthPercent < 85 && DeathCoil.IsSpellUsable)
            {
                Lua.RunMacroText("/target Player");
                DeathCoil.Cast();
                return;
            }
            if (MySettings.UsePlagueLeech && MySettings.UseOutbreak && !NecroticPlague.KnownSpell && BloodPlague.TargetHaveBuff 
                && FrostFever.TargetHaveBuff && Outbreak.IsSpellUsable && PlagueLeech.IsSpellUsable && !Obliterate.IsSpellUsable && PlagueLeech.IsHostileDistanceGood)
            {
                PlagueLeech.Cast();
                Others.SafeSleep(1000);
                if (!BloodPlague.TargetHaveBuff && Outbreak.IsSpellUsable && Outbreak.IsHostileDistanceGood)
                    Outbreak.Cast();
                return;
            }

            if (MySettings.UseUnholyBlight && UnholyBlight.KnownSpell && NecroticPlague.KnownSpell && (!NecroticPlague.TargetHaveBuff || ObjectManager.Target.AuraIsActiveAndExpireInLessThanMs(NecroticPlague.Id, 4000))
                && UnholyBlight.IsSpellUsable && ObjectManager.Target.GetDistance < 9)
            {
                UnholyBlight.Cast();
                return;
            }
            else if (MySettings.UseUnholyBlight && UnholyBlight.KnownSpell && (!BloodPlague.TargetHaveBuff || ObjectManager.Target.AuraIsActiveAndExpireInLessThanMs(BloodPlague.Id, 4000)
                || !FrostFever.TargetHaveBuff || ObjectManager.Target.AuraIsActiveAndExpireInLessThanMs(FrostFever.Id, 4000)) && UnholyBlight.IsSpellUsable && ObjectManager.Target.GetDistance < 9)
            {
                UnholyBlight.Cast();
                return;
            }

            if (MySettings.UseOutbreak && Outbreak.KnownSpell && NecroticPlague.KnownSpell && (!NecroticPlague.TargetHaveBuff || ObjectManager.Target.AuraIsActiveAndExpireInLessThanMs(NecroticPlague.Id, 4000))
                && Outbreak.IsSpellUsable && Outbreak.IsHostileDistanceGood)
            {
                Outbreak.Cast();
                return;
            }
            else if (MySettings.UseOutbreak && Outbreak.KnownSpell && (!BloodPlague.TargetHaveBuff || ObjectManager.Target.AuraIsActiveAndExpireInLessThanMs(BloodPlague.Id, 4000)
                || !FrostFever.TargetHaveBuff || ObjectManager.Target.AuraIsActiveAndExpireInLessThanMs(FrostFever.Id, 4000)) && Outbreak.IsSpellUsable && Outbreak.IsHostileDistanceGood)
            {
                Outbreak.Cast();
                return;
            }

            if (MySettings.UsePlagueStrike && NecroticPlague.KnownSpell && (!NecroticPlague.TargetHaveBuff || ObjectManager.Target.AuraIsActiveAndExpireInLessThanMs(NecroticPlague.Id, 4000))
                && PlagueStrike.IsSpellUsable && PlagueStrike.IsHostileDistanceGood)
            {
                PlagueStrike.Cast();
                return;
            }
            else if (MySettings.UsePlagueStrike && (!BloodPlague.TargetHaveBuff || ObjectManager.Target.AuraIsActiveAndExpireInLessThanMs(BloodPlague.Id, 4000))
                && !Outbreak.IsSpellUsable && !UnholyBlight.IsSpellUsable && PlagueStrike.IsSpellUsable && PlagueStrike.IsHostileDistanceGood)
            {
                PlagueStrike.Cast();
                return;
            }

            if (MySettings.UseHowlingBlast && NecroticPlague.KnownSpell && (!NecroticPlague.TargetHaveBuff || ObjectManager.Target.AuraIsActiveAndExpireInLessThanMs(NecroticPlague.Id, 4000))
                && HowlingBlast.IsSpellUsable && HowlingBlast.IsHostileDistanceGood)
            {
                HowlingBlast.Cast();
                return;
            }
            else if (MySettings.UseHowlingBlast && (!FrostFever.TargetHaveBuff || ObjectManager.Target.AuraIsActiveAndExpireInLessThanMs(FrostFever.Id, 4000))
                && !Outbreak.IsSpellUsable && !UnholyBlight.IsSpellUsable && HowlingBlast.IsSpellUsable && HowlingBlast.IsHostileDistanceGood)
            {
                HowlingBlast.Cast();
                return;
            }

            if (MySettings.UseIcyTouch && !MySettings.UseHowlingBlast && NecroticPlague.KnownSpell && (!NecroticPlague.TargetHaveBuff || ObjectManager.Target.AuraIsActiveAndExpireInLessThanMs(NecroticPlague.Id, 4000))
                && IcyTouch.IsSpellUsable && IcyTouch.IsHostileDistanceGood)
            {
                IcyTouch.Cast();
                return;
            }
            else if (MySettings.UseIcyTouch && !MySettings.UseHowlingBlast && (!FrostFever.TargetHaveBuff || ObjectManager.Target.AuraIsActiveAndExpireInLessThanMs(FrostFever.Id, 4000))
                && !Outbreak.IsSpellUsable && !UnholyBlight.IsSpellUsable && IcyTouch.IsSpellUsable && IcyTouch.IsHostileDistanceGood)
            {
                IcyTouch.Cast();
                return;
            }

            if (MySettings.UseGorefiendsGrasp && GorefiendsGrasp.IsSpellUsable && ObjectManager.GetUnitInSpellRange(GorefiendsGrasp.MaxRangeHostile) > 2)
            {
                GorefiendsGrasp.Cast();
                return;
            }
            if ((ObjectManager.GetUnitInSpellRange() > 2 && MySettings.UseDualWield) || (ObjectManager.GetUnitInSpellRange() > 3 && MySettings.UseTwoHander))
            {
                if (MySettings.UseDeathandDecay && NecroticPlague.KnownSpell && NecroticPlague.TargetHaveBuff && DeathandDecay.IsSpellUsable
                    && ObjectManager.GetUnitInSpellRange(DeathandDecay.MaxRangeHostile) > 2)
                {
                    SpellManager.CastSpellByIDAndPosition(43265, ObjectManager.Target.Position);
                    return;
                }
                if (MySettings.UseArmyoftheDead && ArmyoftheDead.IsSpellUsable && ObjectManager.GetUnitInSpellRange(ArmyoftheDead.MaxRangeHostile) > 3)
                {
                    ArmyoftheDead.Cast();
                    Others.SafeSleep(4000);
                    return;
                }
                if (MySettings.UseBloodBoil && BloodPlague.TargetHaveBuff && ObjectManager.Target.AuraIsActiveAndExpireInLessThanMs(BloodPlague.Id, 4000) && BloodBoil.IsSpellUsable 
                    && BloodBoil.IsHostileDistanceGood)
                {
                    BloodBoil.Cast();
                    return;
                }
                if (MySettings.UseHowlingBlast && HowlingBlast.IsSpellUsable && HowlingBlast.IsHostileDistanceGood)
                {
                    HowlingBlast.Cast();
                    return;
                }
                if (MySettings.UseFrostStrike && FrostStrike.IsSpellUsable && FrostStrike.IsHostileDistanceGood)
                {
                    if ((MySettings.UseLichborne && ObjectManager.Me.HealthPercent <= MySettings.UseLichborneAtPercentage && Lichborne.IsSpellUsable)
                        || (MySettings.UseConversion && ObjectManager.Me.HealthPercent <= MySettings.UseConversionAtPercentage && Conversion.IsSpellUsable))
                        return;
                    FrostStrike.Cast();
                    return;
                }
            }

            if (MySettings.UseSoulReaper && ObjectManager.Target.HealthPercent < 35
                && (ObjectManager.Me.HealthPercent > MySettings.UseDeathStrikeAtPercentage || !MySettings.UseDeathStrike) 
                && SoulReaper.IsSpellUsable && SoulReaper.IsHostileDistanceGood)
            {
                SoulReaper.Cast();
                return;
            }

            if (MySettings.UseDualWield)
            {
                if (MySettings.UseFrostStrike && (KillingMachine.HaveBuff || ObjectManager.Me.RunicPower > 88)
                    && FrostStrike.IsSpellUsable && FrostStrike.IsHostileDistanceGood)
                {
                    if ((MySettings.UseLichborne && ObjectManager.Me.HealthPercent <= MySettings.UseLichborneAtPercentage && Lichborne.IsSpellUsable)
                        || (MySettings.UseConversion && ObjectManager.Me.HealthPercent <= MySettings.UseConversionAtPercentage && Conversion.IsSpellUsable))
                        return;
                    FrostStrike.Cast();
                    return;
                }
                if (MySettings.UseDefile && Defile.IsSpellUsable && Defile.IsHostileDistanceGood)
                {
                    SpellManager.CastSpellByIDAndPosition(152280, ObjectManager.Target.Position);
                    _defileTimer = new Timer(1000*30);
                    return;
                }
                if (MySettings.UseObliterate && KillingMachine.HaveBuff && ObjectManager.Me.RunicPower < 40 && Obliterate.IsSpellUsable
                    && Obliterate.IsHostileDistanceGood)
                {
                    if (Defile.KnownSpell && _defileTimer.IsReady)
                        return;
                    if (MySettings.UseDeathStrike && ObjectManager.Me.HealthPercent <= MySettings.UseDeathStrikeAtPercentage && DeathStrike.IsSpellUsable)
                        return;
                    Obliterate.Cast();
                    return;
                }
                if (MySettings.UseHowlingBlast && ObjectManager.Me.RunicPowerPercentage < 90 && HowlingBlast.IsSpellUsable && HowlingBlast.IsHostileDistanceGood)
                {
                    HowlingBlast.Cast();
                    return;
                }
                if (!MySettings.UseHowlingBlast && MySettings.UseIcyTouch && ObjectManager.Me.RunicPowerPercentage < 90 && IcyTouch.IsSpellUsable && IcyTouch.IsHostileDistanceGood)
                {
                    IcyTouch.Cast();
                    return;
                }
            }

            if (MySettings.UseTwoHander)
            {
                if (MySettings.UseDefile && Defile.IsSpellUsable && Defile.IsHostileDistanceGood)
                {
                    SpellManager.CastSpellByIDAndPosition(152280, ObjectManager.Target.Position);
                    _defileTimer = new Timer(1000*30);
                    return;
                }
                if (MySettings.UseObliterate && KillingMachine.HaveBuff && Obliterate.IsSpellUsable && Obliterate.IsHostileDistanceGood)
                {
                    if (Defile.KnownSpell && _defileTimer.IsReady)
                        return;
                    else if (MySettings.UseDeathStrike && ObjectManager.Me.HealthPercent <= MySettings.UseDeathStrikeAtPercentage && DeathStrike.IsSpellUsable)
                        return;
                    Obliterate.Cast();
                    return;
                }
                if (MySettings.UseHowlingBlast && FreezingFog.HaveBuff && ObjectManager.Me.RunicPowerPercentage < 90 
                    && HowlingBlast.IsSpellUsable && HowlingBlast.IsHostileDistanceGood)
                {
                    HowlingBlast.Cast();
                    return;
                }
                if (!MySettings.UseHowlingBlast && MySettings.UseIcyTouch && ObjectManager.Me.RunicPowerPercentage < 90 && IcyTouch.IsSpellUsable && IcyTouch.IsHostileDistanceGood)
                {
                    IcyTouch.Cast();
                    return;
                }
                if (MySettings.UseFrostStrike && (KillingMachine.HaveBuff || ObjectManager.Me.RunicPower > 76 || !Obliterate.IsSpellUsable)
                    && FrostStrike.IsSpellUsable && FrostStrike.IsHostileDistanceGood)
                {
                    if ((MySettings.UseLichborne && ObjectManager.Me.HealthPercent <= MySettings.UseLichborneAtPercentage && Lichborne.IsSpellUsable)
                        || (MySettings.UseConversion && ObjectManager.Me.HealthPercent <= MySettings.UseConversionAtPercentage && Conversion.IsSpellUsable))
                        return;
                    FrostStrike.Cast();
                    return;
                }
                if (MySettings.UseObliterate && Obliterate.IsSpellUsable && Obliterate.IsHostileDistanceGood)
                {
                    if (Defile.KnownSpell && _defileTimer.IsReady)
                        return;
                    else if (MySettings.UseDeathStrike && ObjectManager.Me.HealthPercent <= MySettings.UseDeathStrikeAtPercentage && DeathStrike.IsSpellUsable)
                        return;
                    Obliterate.Cast();
                    return;
                }
            }
            if (MySettings.UseArcaneTorrentForResource && ObjectManager.Me.RunicPowerPercentage < 85 && ArcaneTorrent.IsSpellUsable)
            {
                ArcaneTorrent.Cast();
                return;
            }
            if (MySettings.UseEmpowerRuneWeapon && ObjectManager.Me.RunicPowerPercentage < 75 && EmpowerRuneWeapon.IsSpellUsable)
                EmpowerRuneWeapon.Cast();
        }
        finally
        {
            Memory.WowMemory.GameFrameUnLock();
        }
    }

    private void Patrolling()
    {
        if (!ObjectManager.Me.IsMounted)
        {
            Buff();
            Heal();
        }
    }

    #region Nested type: DeathknightFrostSettings

    [Serializable]
    public class DeathknightFrostSettings : Settings
    {
        public bool DoAvoidMelee = false;
        public int DoAvoidMeleeDistance = 0;
        public bool UseAlchFlask = true;
        public bool UseAntiMagicShell = true;
        public int UseAntiMagicShellAtPercentage = 95;
        public bool UseAntiMagicZone = true;
        public int UseAntiMagicZoneAtPercentage = 95;
        public bool UseArcaneTorrentForDecast = true;
        public int UseArcaneTorrentForDecastAtPercentage = 95;
        public bool UseArcaneTorrentForResource = true;
        public bool UseArmyoftheDead = true;
        public bool UseAsphyxiate = true;
        public int UseAsphyxiateAtPercentage = 90;
        public bool UseBerserking = true;
        public bool UseBloodBoil = true;
        public bool UseBloodFury = true;
        public bool UseBloodPresence = true;
        public int UseBloodPresenceAtPercentage = 50;
        public bool UseBloodTapForDPS = true;
        public bool UseBloodTapForHeal = true;
        public bool UseChainsofIce = false;
        public bool UseConversion = true;
        public int UseConversionAtPercentage = 45;
        public bool UseDeathCoil = true;
        public bool UseDeathGrip = true;
        public bool UseDeathPact = true;
        public int UseDeathPactAtPercentage = 55;
        public bool UseDeathSiphon = true;
        public int UseDeathSiphonAtPercentage = 80;
        public bool UseDeathStrike = true;
        public int UseDeathStrikeAtPercentage = 80;
        public bool UseDeathandDecay = true;
        public bool UseDefile = true;
        public bool UseDeathsAdvance = true;
        public bool UseDualWield = false;
        public bool UseEmpowerRuneWeapon = true;
        public bool UseFrostPresence = true;
        public bool UseFrostStrike = true;
        public bool UseGiftoftheNaaru = true;
        public int UseGiftoftheNaaruAtPercentage = 80;
        public bool UseGorefiendsGrasp = true;
        public bool UseHornofWinter = true;
        public bool UseHowlingBlast = true;
        public bool UseIceboundFortitude = true;
        public int UseIceboundFortitudeAtPercentage = 80;
        public bool UseIcyTouch = true;
        public bool UseLichborne = true;
        public int UseLichborneAtPercentage = 45;
        public bool UseLowCombat = true;
        public int UseLowCombatAtPercentage = 15;
        public bool UseMindFreeze = true;
        public int UseMindFreezeAtPercentage = 100;
        public bool UseObliterate = true;
        public bool UseOutbreak = true;
        public bool UsePathofFrost = true;
        public bool UsePillarofFrost = true;
        public bool UsePlagueLeech = true;
        public bool UsePlagueStrike = true;
        public bool UseRemorselessWinter = true;
        public int UseRemorselessWinterAtPercentage = 70;
        public bool UseSoulReaper = true;
        public bool UseStoneform = true;
        public int UseStoneformAtPercentage = 80;
        public bool UseStrangulate = true;
        public int UseStrangulateAtPercentage = 100;
        public bool UseTrinketOne = true;
        public bool UseTrinketTwo = true;
        public bool UseTwoHander = true;
        public bool UseUnholyBlight = true;
        public bool UseUnholyPresence = true;
        public bool UseWarStomp = true;
        public int UseWarStompAtPercentage = 80;

        public DeathknightFrostSettings()
        {
            ConfigWinForm("Deathknight Frost Settings");
            /* Professions & Racials */
            AddControlInWinForm("Use Arcane Torrent for Interrupt", "UseArcaneTorrentForDecast", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Arcane Torrent for Resource", "UseArcaneTorrentForResource", "Professions & Racials");
            AddControlInWinForm("Use Berserking", "UseBerserking", "Professions & Racials");
            AddControlInWinForm("Use Blood Fury", "UseBloodFury", "Professions & Racials");
            AddControlInWinForm("Use Gift of the Naaru", "UseGiftoftheNaaru", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Stoneform", "UseStoneform", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use War Stomp", "UseWarStomp", "Professions & Racials", "AtPercentage");
            /* Deathknight Presence & Buffs */
            AddControlInWinForm("Use Frost Presence", "UseFrostPresence", "Deathknight Presence & Buffs");
            AddControlInWinForm("Use Blood Presence", "UseBloodPresence", "Deathknight Presence & Buffs", "AtPercentage");
            AddControlInWinForm("Use Horn of Winter", "UseHornofWinter", "Deathknight Presence & Buffs");
            AddControlInWinForm("Use Path of Frost", "UsePathofFrost", "Deathknight Presence & Buffs");
            AddControlInWinForm("Use Unholy Presence", "UseUnholyPresence", "Deathknight Presence & Buffs");
            /* Offensive Spell */
            AddControlInWinForm("Use Blood Boil", "UseBloodBoil", "Offensive Spell");
            AddControlInWinForm("Use Death Coil", "UseDeathCoil", "Offensive Spell");
            AddControlInWinForm("Use Death and Decay", "UseDeathandDecay", "Offensive Spell");
            AddControlInWinForm("Use Defile", "UseDefile", "Offensive Spell");
            AddControlInWinForm("Use Frost Strike", "UseFrostStrike", "Offensive Spell");
            AddControlInWinForm("Use Howling Blast", "UseHowlingBlast", "Offensive Spell");
            AddControlInWinForm("Use Icy Touch", "UseIcyTouch", "Offensive Spell");
            AddControlInWinForm("Use Plague Leech", "UsePlagueLeech", "Offensive Spell");
            AddControlInWinForm("Use Plague Strike", "UsePlagueStrike", "Offensive Spell");
            AddControlInWinForm("Use Obliterate", "UseObliterate", "Offensive Spell");
            AddControlInWinForm("Use Soul Reaper", "UseSoulReaper", "Offensive Spell");
            AddControlInWinForm("Use Unholy Blight", "UseUnholyBlight", "Offensive Spell");
            /* Offensive Cooldown */
            AddControlInWinForm("Use Blood Tap for DPS", "UseBloodTapForDPS", "Offensive Cooldown");
            AddControlInWinForm("Use Blood Tap for Heal", "UseBloodTapForHeal", "Offensive Cooldown");
            AddControlInWinForm("Use Death Grip", "UseDeathGrip", "Offensive Cooldown");
            AddControlInWinForm("Use Empower Rune Weapon", "UseEmpowerRuneWeapon", "Offensive Cooldown");
            AddControlInWinForm("Use Outbreak", "UseOutbreak", "Offensive Cooldown");
            AddControlInWinForm("Use Pillar of Frost", "UsePillarofFrost", "Offensive Cooldown");
            /* Defensive Cooldown */
            AddControlInWinForm("Use Anti-Magic Shell", "UseAntiMagicShell", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Anti-Magic Zone", "UseAntiMagicZone", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Army of the Dead", "UseArmyoftheDead", "Defensive Cooldown");
            AddControlInWinForm("Use Asphyxiate", "UseAsphyxiate", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Chains of Ice", "UseChainsofIce", "Defensive Cooldown");
            AddControlInWinForm("Use Death's Advance", "UseDeathsAdvance", "Defensive Cooldown");
            AddControlInWinForm("Use Gorefriend's Grasp", "UseGorefriendsGrasp", "Defensive Cooldown");
            AddControlInWinForm("Use Icebound Fortitude", "UseIceboundFortitude", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Mind Freeze", "UseMindFreeze", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Remorseless Winter", "UseRemorseless Winter", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Strangulate", "UseStrangulate", "Defensive Cooldown", "AtPercentage");
            /* Healing Spell */
            AddControlInWinForm("Use Conversion", "UseConversion", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Death Pact", "UseDeathPact", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Death Siphon", "UseDeathSiphon", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Death Strike", "UseDeathStrike", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Lichborne", "UseLichborne", "Healing Spell", "AtPercentage");
            /* Game Settings */
            AddControlInWinForm("Use Low Combat Settings - Level Difference", "UseLowCombat", "Game Settings", "AtPercentage");
            AddControlInWinForm("Use Trinket One", "UseTrinketOne", "Game Settings");
            AddControlInWinForm("Use Trinket Two", "UseTrinketTwo", "Game Settings");
            AddControlInWinForm("Use Alchemist Flask", "UseAlchFlask", "Game Settings");
            AddControlInWinForm("Use Dual Wield", "UseDualWield", "Game Settings");
            AddControlInWinForm("Use Two Hander", "UseTwoHander", "Game Settings");
            AddControlInWinForm("Do avoid melee (Off Advised!!)", "DoAvoidMelee", "Game Settings");
            AddControlInWinForm("Avoid melee distance (1 to 4)", "DoAvoidMeleeDistance", "Game Settings");
        }

        public static DeathknightFrostSettings CurrentSetting { get; set; }

        public static DeathknightFrostSettings GetSettings()
        {
            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Deathknight_Frost.xml";
            if (File.Exists(currentSettingsFile))
            {
                return
                    CurrentSetting = Load<DeathknightFrostSettings>(currentSettingsFile);
            }
            return new DeathknightFrostSettings();
        }
    }

    #endregion
}

#endregion

#region Mage

public class MageArcane
{
    private static MageArcaneSettings MySettings = MageArcaneSettings.GetSettings();

    #region General Timers & Variables

    private readonly WoWItem _firstTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET);
    private readonly WoWItem _secondTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET, 2);
    public int DecastHP = 0;
    public int DefenseHP = 0;
    public int HealHP = 0;
    public int HealMP = 0;
    public int LC = 0;

    private Timer _onCd = new Timer(0);

    #endregion

    #region Professions & Racials

    public readonly Spell ArcaneTorrent = new Spell("Arcane Torrent");
    public readonly Spell Berserking = new Spell("Berserking");
    public readonly Spell BloodFury = new Spell("Blood Fury");
    public readonly Spell GiftoftheNaaru = new Spell("Gift of the Naaru");
    public readonly Spell Stoneform = new Spell("Stoneform");
    public readonly Spell WarStomp = new Spell("War Stomp");

    #endregion

    #region Mage Buffs

    public readonly Spell ArcaneBrilliance = new Spell("Arcane Brilliance");
    public readonly Spell ArcaneChargePassive = new Spell("Arcane Charge");
    public readonly Spell BlazingSpeed = new Spell("Blazing Speed");
    public readonly Spell Cauterize = new Spell(87024);
    public readonly Spell DalaranBrilliance = new Spell("Dalaran Brilliance");
    public readonly Spell IceFloes = new Spell("Ice Floes");
    public readonly Spell Hypothermia = new Spell(41425);
    public readonly Spell RuneofPower = new Spell("Rune of Power");
    public readonly Spell RuneofPowerBuff = new Spell(116014);

    #endregion

    #region Offensive Spell

    public readonly Spell ArcaneOrb = new Spell("Arcane Orb");
    public readonly Spell ArcaneBarrage = new Spell("Arcane Barrage");
    public readonly Spell ArcaneBlast = new Spell("Arcane Blast");
    public readonly Spell ArcaneExplosion = new Spell("Arcane Explosion");
    public readonly Spell ArcaneMissiles = new Spell("Arcane Missiles");
    public readonly Spell NetherTempest = new Spell("Nether Tempest");

    #endregion

    #region Offensive Cooldown

    public readonly Spell ArcanePower = new Spell("Arcane Power");
    public readonly Spell MirrorImage = new Spell("Mirror Image");
    public readonly Spell PresenceofMind = new Spell("Presence of Mind");
    public readonly Spell PrismaticCrystal = new Spell("Prismatic Crystal");
    public readonly Spell Supernova = new Spell("Supernova");
    public readonly Spell TimeWarp = new Spell("Time Warp");

    #endregion

    #region Defensive Cooldown

    public readonly Spell AlterTime = new Spell("Alter Time");
    public readonly Spell Blink = new Spell("Blink");
    public readonly Spell ColdSnap = new Spell("Cold Snap");
    public readonly Spell ConeofCold = new Spell("Cone of Cold");
    public readonly Spell Counterspell = new Spell("Counterspell");
    public readonly Spell Evanesce = new Spell("Evanesce");
    public readonly Spell FrostNova = new Spell("Frost Nova");
    public readonly Spell Frostjaw = new Spell("Frostjaw");
    public readonly Spell GreaterInvisibility = new Spell("Greater Invisibility");
    public readonly Spell IceBarrier = new Spell("Ice Barrier");
    public readonly Spell IceBlock = new Spell("Ice Block");
    public readonly Spell IceWard = new Spell("Ice Ward");
    public readonly Spell Invisibility = new Spell("Invisibility");
    public readonly Spell RingofFrost = new Spell("Ring of Frost");
    public readonly Spell Slow = new Spell("Slow");

    #endregion

    #region Healing Spell

    public readonly Spell ConjureRefreshment = new Spell("Conjure Refreshment");
    public readonly Spell Evocation = new Spell("Evocation");
    public readonly Spell GlobalCooldown = new Spell("Global Cooldown");
    private Timer _conjureRefreshmentTimer = new Timer(0);
    private bool _burnPhaseStarted = false;

    #endregion

    public MageArcane()
    {
        Main.InternalRange = 39f;
        Main.InternalAggroRange = 39f;
        MySettings = MageArcaneSettings.GetSettings();
        Main.DumpCurrentSettings<MageArcaneSettings>(MySettings);
        UInt128 lastTarget = 0;
        LowHP();

        while (Main.InternalLoop)
        {
            try
            {
                if (!ObjectManager.Me.IsDeadMe)
                {
                    if (!ObjectManager.Me.IsMounted)
                    {
                        if (Fight.InFight && ObjectManager.Me.Target > 0)
                        {
                            if (ObjectManager.Me.Target != lastTarget && (ArcaneBarrage.IsHostileDistanceGood || ArcaneBlast.IsHostileDistanceGood))
                            {
                                Pull();
                                lastTarget = ObjectManager.Me.Target;
                            }

                            if (MySettings.UseLowCombat && (ObjectManager.Me.Level - ObjectManager.Target.Level >= MySettings.UseLowCombatAtPercentage))
                            {
                                LC = 1;
                                if (CombatClass.InSpellRange(ObjectManager.Target, 0, Main.InternalRange))
                                    LowCombat();
                            }
                            else
                            {
                                LC = 0;
                                if (CombatClass.InSpellRange(ObjectManager.Target, 0, Main.InternalRange))
                                    Combat();
                            }
                        }
                        if (!ObjectManager.Me.IsCast)
                            Patrolling();
                    }
                }
                else
                    Thread.Sleep(500);
            }
            catch
            {
            }
            Thread.Sleep(100);
        }
    }

    private void LowHP()
    {
        if (MySettings.UseAlterTimeAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseAlterTimeAtPercentage;

        if (MySettings.UseConeofColdAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseConeofColdAtPercentage;

        if (MySettings.UseFrostNovaAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseFrostNovaAtPercentage;

        if (MySettings.UseEvanesceAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseEvanesceAtPercentage;

        if (MySettings.UseGreaterInvisibilityAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseGreaterInvisibilityAtPercentage;

        if (MySettings.UseIceBarrierAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseIceBarrierAtPercentage;

        if (MySettings.UseIceWardAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseIceWardAtPercentage;

        if (MySettings.UseInvisibilityAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseInvisibilityAtPercentage;

        if (MySettings.UseStoneformAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseStoneformAtPercentage;

        if (MySettings.UseWarStompAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseWarStompAtPercentage;

        if (MySettings.UseArcaneTorrentForDecastAtPercentage > DecastHP)
            DecastHP = MySettings.UseArcaneTorrentForDecastAtPercentage;

        if (MySettings.UseCounterspellAtPercentage > DecastHP)
            DecastHP = MySettings.UseCounterspellAtPercentage;

        if (MySettings.UseFrostjawAtPercentage > DecastHP)
            DecastHP = MySettings.UseFrostjawAtPercentage;

        if (MySettings.UseArcaneTorrentForResourceAtPercentage > HealMP)
            HealMP = MySettings.UseArcaneTorrentForResourceAtPercentage;

        if (MySettings.UseColdSnapForHealAtPercentage > HealHP)
            HealHP = MySettings.UseColdSnapForHealAtPercentage;

        if (MySettings.UseGiftoftheNaaruAtPercentage > HealHP)
            HealHP = MySettings.UseGiftoftheNaaruAtPercentage;
    }

    private void Pull()
    {
        if (MySettings.UseRuneofPower && !RuneofPowerBuff.HaveBuff && RuneofPower.IsSpellUsable && ArcaneBlast.IsHostileDistanceGood)
            SpellManager.CastSpellByIDAndPosition(RuneofPower.Id, ObjectManager.Me.Position);

        if (MySettings.UseIceFloes && IceFloes.IsSpellUsable && ObjectManager.Me.GetMove)
            IceFloes.Cast();

        if (MySettings.UseArcaneBlast && ArcaneBlast.KnownSpell && ArcaneBlast.IsSpellUsable && ArcaneBlast.IsHostileDistanceGood)
            ArcaneBlast.Cast();
    }

    private void LowCombat()
    {
        Buff();

        if (MySettings.DoAvoidMelee)
            AvoidMelee();

        if (_onCd.IsReady && ObjectManager.Me.HealthPercent <= DefenseHP)
            DefenseCycle();

        if (ObjectManager.Me.HealthPercent <= HealHP)
            Heal();

        if (MySettings.UseArcaneBarrage && ArcaneBarrage.IsSpellUsable && ArcaneBarrage.IsHostileDistanceGood)
        {
            ArcaneBarrage.Cast();
            return;
        }
        if (MySettings.UseArcaneMissiles && ArcaneMissiles.IsSpellUsable && ArcaneMissiles.IsHostileDistanceGood)
        {
            ArcaneMissiles.Cast();
            return;
        }
        if (MySettings.UseArcaneBlast && ArcaneBlast.IsSpellUsable && ArcaneBlast.IsHostileDistanceGood)
        {
            ArcaneBlast.Cast();
            return;
        }
        if (MySettings.UseArcaneExplosion && ArcaneExplosion.IsSpellUsable && ArcaneExplosion.IsHostileDistanceGood)
            ArcaneExplosion.Cast();
    }

    private void Combat()
    {
        Buff();

        if (MySettings.DoAvoidMelee)
            AvoidMelee();

        DPSCycle();

        if (_onCd.IsReady && (ObjectManager.Me.HealthPercent <= DefenseHP || ObjectManager.GetNumberAttackPlayer() > 2))
            DefenseCycle();

        if (ObjectManager.Me.HealthPercent <= HealHP || ObjectManager.Me.ManaPercentage <= HealMP)
            Heal();

        if (ObjectManager.Me.HealthPercent <= DecastHP || (MySettings.UseSlow && ObjectManager.Target.GetMove))
            Decast();

        DPSBurst();
        DPSCycle();
    }

    private void Buff()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (MySettings.UseIceBlock && !Evanesce.KnownSpell && Cauterize.HaveBuff && !Hypothermia.HaveBuff)
        {
            if (MySettings.UseColdSnapForDefence && !IceBlock.IsSpellUsable && ColdSnap.IsSpellUsable)
            {
                ColdSnap.Cast();
                Others.SafeSleep(1000);
            }
            if (IceBlock.IsSpellUsable)
            {
                IceBlock.Cast();
                _onCd = new Timer(1000*10);
                return;
            }
        }
        if (MySettings.UseArcaneBrilliance && !ArcaneBrilliance.HaveBuff && !DalaranBrilliance.HaveBuff && ArcaneBrilliance.IsSpellUsable)
            ArcaneBrilliance.Cast();

        if (MySettings.UseBlazingSpeed && ObjectManager.Me.GetMove && BlazingSpeed.IsSpellUsable)
            BlazingSpeed.Cast();

        if (MySettings.UseAlchFlask && !ObjectManager.Me.HaveBuff(79638) && !ObjectManager.Me.HaveBuff(79640) && !ObjectManager.Me.HaveBuff(79639)
            && !ItemsManager.IsItemOnCooldown(75525) && ItemsManager.GetItemCount(75525) > 0)
            ItemsManager.UseItem(75525);

        if (MySettings.UseConjureRefreshment && _conjureRefreshmentTimer.IsReady
            && ItemsManager.GetItemCount(113509) == 0 // 100
            && ItemsManager.GetItemCount(80610) == 0 // 90
            && ItemsManager.GetItemCount(65499) == 0 // 85-89
            && ItemsManager.GetItemCount(43523) == 0 // 84-80
            && ItemsManager.GetItemCount(43518) == 0 // 79-74
            && ItemsManager.GetItemCount(65517) == 0 // 73-64
            && ItemsManager.GetItemCount(65516) == 0 // 63-54
            && ItemsManager.GetItemCount(65515) == 0 // 53-44
            && ItemsManager.GetItemCount(65500) == 0 // 43-38
            && ConjureRefreshment.IsSpellUsable)
        {
            ConjureRefreshment.Cast();
            _conjureRefreshmentTimer = new Timer(1000*60*10);
        }
    }

    private void AvoidMelee()
    {
        if (ObjectManager.Target.GetDistance < MySettings.DoAvoidMeleeDistance && ObjectManager.Target.InCombat)
        {
            Logging.WriteFight("Too Close. Moving Back");
            var maxTimeTimer = new Timer(1000*2);
            MovementsAction.MoveBackward(true);
            while (ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat && !maxTimeTimer.IsReady)
                Others.SafeSleep(300);
            MovementsAction.MoveBackward(false);
            if (maxTimeTimer.IsReady && ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat)
            {
                MovementsAction.MoveForward(true);
                Others.SafeSleep(1000);
                MovementsAction.MoveForward(false);
                MovementManager.Face(ObjectManager.Target.Position);
            }
        }
    }

    private void DefenseCycle()
    {
        if (MySettings.UseAlterTime && !AlterTime.HaveBuff && ObjectManager.Me.HealthPercent <= MySettings.UseAlterTimeAtPercentage && AlterTime.IsSpellUsable)
        {
            AlterTime.Cast();
            return;
        }
        if (MySettings.UseBlink && (FrostNova.TargetHaveBuff || ConeofCold.TargetHaveBuff || Slow.TargetHaveBuff || Frostjaw.TargetHaveBuff) && Blink.IsSpellUsable 
            && ObjectManager.Target.GetDistance < 5)
        {
            Blink.Cast();
            return;
        }
        if (MySettings.UseConeofCold && ObjectManager.Me.HealthPercent <= MySettings.UseConeofColdAtPercentage && ConeofCold.IsSpellUsable && ConeofCold.IsHostileDistanceGood)
        {
            ConeofCold.Cast();
            return;
        }
        if (MySettings.UseEvanesce && ObjectManager.Me.HealthPercent <= MySettings.UseEvanesceAtPercentage)
        {
            if (MySettings.UseColdSnapForDefence && !Evanesce.IsSpellUsable && ColdSnap.IsSpellUsable)
            {
                ColdSnap.Cast();
                Others.SafeSleep(1000);
            }
            if (Evanesce.IsSpellUsable)
            {
                Evanesce.Cast();
                _onCd = new Timer(1000*3);
            }
            return;
        }
        if (MySettings.UseFrostjaw && ObjectManager.Me.HealthPercent <= MySettings.UseFrostjawAtPercentage && Frostjaw.IsSpellUsable && ObjectManager.Target.GetDistance < 10)
        {
            Frostjaw.Cast();
            return;
        }
        if (MySettings.UseFrostNova && ObjectManager.Me.HealthPercent <= MySettings.UseFrostNovaAtPercentage && ObjectManager.GetUnitInSpellRange(RingofFrost.MaxRangeHostile) > 0)
        {
            if (MySettings.UseColdSnapForDefence && !FrostNova.IsSpellUsable && ColdSnap.IsSpellUsable)
            {
                ColdSnap.Cast();
                Others.SafeSleep(1000);
            }
            if (FrostNova.IsSpellUsable)
            {
                FrostNova.Cast();
                _onCd = new Timer(1000*8);
            }
            return;
        }
        if (MySettings.UseIceBarrier && !IceBarrier.HaveBuff && ObjectManager.Me.HealthPercent <= MySettings.UseIceBarrierAtPercentage && IceBarrier.IsSpellUsable)
        {
            IceBarrier.Cast();
            return;
        }
        if (MySettings.UseIceWard && ObjectManager.Me.HealthPercent <= MySettings.UseIceWardAtPercentage && IceWard.IsSpellUsable && ObjectManager.Target.GetDistance < 10)
        {
            IceWard.Cast();
            _onCd = new Timer(1000*5);
            return;
        }
        if (MySettings.UseInvisibility && ObjectManager.Me.HealthPercent <= MySettings.UseInvisibilityAtPercentage && Invisibility.IsSpellUsable)
        {
            Invisibility.Cast();
            Others.SafeSleep(8000);
            return;
        }
        if (MySettings.UseGreaterInvisibility && ObjectManager.Me.HealthPercent <= MySettings.UseGreaterInvisibilityAtPercentage && Invisibility.IsSpellUsable)
        {
            GreaterInvisibility.Cast();
            Others.SafeSleep(8000);
            return;
        }
        if (MySettings.UseRingofFrost && RingofFrost.IsSpellUsable && ObjectManager.GetUnitInSpellRange(RingofFrost.MaxRangeHostile) > 2)
        {
            SpellManager.CastSpellByIDAndPosition(113724, ObjectManager.Target.Position);
            _onCd = new Timer(1000*10);
            return;
        }
        if (MySettings.UseStoneform && ObjectManager.Me.HealthPercent <= MySettings.UseStoneformAtPercentage && Stoneform.IsSpellUsable)
        {
            Stoneform.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (MySettings.UseWarStomp && ObjectManager.Me.HealthPercent <= MySettings.UseWarStompAtPercentage && WarStomp.IsSpellUsable 
            && ObjectManager.GetUnitInSpellRange(WarStomp.MaxRangeHostile) > 0)
        {
            WarStomp.Cast();
            _onCd = new Timer(1000*2);
            return;
        }
    }

    private void Heal()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (MySettings.UseArcaneTorrentForResource && ObjectManager.Me.ManaPercentage <= MySettings.UseArcaneTorrentForResourceAtPercentage && ArcaneTorrent.IsSpellUsable)
        {
            ArcaneTorrent.Cast();
            return;
        }
        if (MySettings.UseGiftoftheNaaru && ObjectManager.Me.HealthPercent <= MySettings.UseGiftoftheNaaruAtPercentage && GiftoftheNaaru.IsSpellUsable)
        {
            GiftoftheNaaru.Cast();
            return;
        }
        if (MySettings.UseColdSnapForHeal && ObjectManager.Me.HealthPercent <= MySettings.UseColdSnapForHealAtPercentage && ColdSnap.IsSpellUsable)
        {
            ColdSnap.Cast();
            return;
        }
    }

    private void Decast()
    {
        if (MySettings.UseArcaneTorrentForDecast && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe && ObjectManager.Me.HealthPercent <= MySettings.UseArcaneTorrentForDecastAtPercentage
            && ArcaneTorrent.IsSpellUsable && ObjectManager.Target.GetDistance < 8)
        {
            ArcaneTorrent.Cast();
            return;
        }
        if (MySettings.UseCounterspell && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe && ObjectManager.Me.HealthPercent <= MySettings.UseCounterspellAtPercentage
            && Counterspell.IsSpellUsable && Counterspell.IsHostileDistanceGood)
        {
            Counterspell.Cast();
            return;
        }
        if (MySettings.UseFrostjaw && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe && ObjectManager.Me.HealthPercent <= MySettings.UseFrostjawAtPercentage
            && Frostjaw.IsSpellUsable && Frostjaw.IsHostileDistanceGood)
        {
            Frostjaw.Cast();
            return;
        }
        if (MySettings.UseSlow && !Slow.TargetHaveBuff && ObjectManager.Target.GetMove && Slow.IsSpellUsable && Slow.IsHostileDistanceGood)
            Slow.Cast();
    }

    private void DPSBurst()
    {
        if (MySettings.UseTrinketOne && !ItemsManager.IsItemOnCooldown(_firstTrinket.Entry) && ItemsManager.IsItemUsable(_firstTrinket.Entry))
        {
            ItemsManager.UseItem(_firstTrinket.Name);
            Logging.WriteFight("Use First Trinket Slot");
        }
        if (MySettings.UseTrinketTwo && !ItemsManager.IsItemOnCooldown(_secondTrinket.Entry) && ItemsManager.IsItemUsable(_secondTrinket.Entry))
        {
            ItemsManager.UseItem(_secondTrinket.Name);
            Logging.WriteFight("Use Second Trinket Slot");
        }
        if (MySettings.UseBerserking && Berserking.IsSpellUsable && ArcaneBlast.IsHostileDistanceGood)
        {
            if (ObjectManager.Me.IsCast)
                ObjectManager.Me.StopCast();

            Others.SafeSleep(500);
            Berserking.Cast();
        }
        if (MySettings.UseBloodFury && BloodFury.IsSpellUsable && ArcaneBlast.IsHostileDistanceGood)
        {
            if (ObjectManager.Me.IsCast)
                ObjectManager.Me.StopCast();

            Others.SafeSleep(500);
            BloodFury.Cast();
        }
        if (MySettings.UseMirrorImage && MirrorImage.IsSpellUsable && ArcaneBlast.IsHostileDistanceGood)
        {
            if (ObjectManager.Me.IsCast)
                ObjectManager.Me.StopCast();

            Others.SafeSleep(500);
            MirrorImage.Cast();
        }
        if (MySettings.UseRuneofPower && !RuneofPowerBuff.HaveBuff && !ObjectManager.Me.GetMove && RuneofPower.IsSpellUsable && ArcaneBlast.IsHostileDistanceGood)
        {
            if (ObjectManager.Me.IsCast)
                ObjectManager.Me.StopCast();

            Others.SafeSleep(500);
            SpellManager.CastSpellByIDAndPosition(116011, ObjectManager.Me.Position);
        }
        if (MySettings.UsePresenceofMind && ArcaneChargePassive.BuffStack < 2 && PresenceofMind.IsSpellUsable && ArcaneBlast.IsHostileDistanceGood)
        {
            if (ObjectManager.Me.IsCast)
                ObjectManager.Me.StopCast();

            Others.SafeSleep(500);
            PresenceofMind.Cast();
        }
        if (MySettings.UsePrismaticCrystal && _burnPhaseStarted && PrismaticCrystal.IsSpellUsable && PrismaticCrystal.IsHostileDistanceGood)
        {
            if (ObjectManager.Me.IsCast)
                ObjectManager.Me.StopCast();

            Others.SafeSleep(500);
            SpellManager.CastSpellByIDAndPosition(152087, ObjectManager.Target.Position);
            Lua.RunMacroText("/target Prismatic Crystal");
        }
        if (MySettings.UseTimeWarp && !ObjectManager.Me.HaveBuff(80354) && !ObjectManager.Me.HaveBuff(57724) && !ObjectManager.Me.HaveBuff(57723) && !ObjectManager.Me.HaveBuff(95809)
            && TimeWarp.IsSpellUsable && ArcaneBlast.IsHostileDistanceGood)
        {
            if (ObjectManager.Me.IsCast)
                ObjectManager.Me.StopCast();

            Others.SafeSleep(500);
            TimeWarp.Cast();
        }
    }

    private void DPSCycle()
    {
        Usefuls.SleepGlobalCooldown();
        try
        {
            Memory.WowMemory.GameFrameLock(); // !!! WARNING - DONT SLEEP WHILE LOCKED - DO FINALLY(GameFrameUnLock()) !!!

            if (MySettings.UseEvocation && ArcaneChargePassive.BuffStack >= 4 && Evocation.IsSpellUsable && ArcaneBlast.IsHostileDistanceGood)
            {
                _burnPhaseStarted = true;
                if (MySettings.UseArcanePower && ArcanePower.IsSpellUsable)
                    ArcanePower.Cast();
            }
            if (ObjectManager.Me.ManaPercentage < 50)
            {
                _burnPhaseStarted = false;
                Evocation.Launch(true, false, true);
                Others.SafeSleep(500);
                while (ObjectManager.Me.ManaPercentage < 96 && ObjectManager.Me.IsCast)
                    Others.SafeSleep(20);

                if (ObjectManager.Me.IsCast)
                    ObjectManager.Me.StopCast();
                return;
            }
            if (MySettings.UseIceFloes && !IceFloes.HaveBuff && ObjectManager.Me.GetMove && IceFloes.IsSpellUsable && ArcaneBlast.IsHostileDistanceGood)
                IceFloes.Cast();

            if (MySettings.UseNetherTempest && ArcaneChargePassive.BuffStack == 4 && (!NetherTempest.TargetHaveBuff || ObjectManager.Target.AuraIsActiveAndExpireInLessThanMs(NetherTempest.Id, 3599)) 
                && NetherTempest.IsSpellUsable && NetherTempest.IsHostileDistanceGood)
            {
                NetherTempest.Cast();
                return;
            }
            if (MySettings.UseSupernova && Supernova.GetSpellCharges > 0 && Supernova.IsSpellUsable && Supernova.IsHostileDistanceGood)
            {
                Supernova.Cast();
                return;
            }
            if (MySettings.UseArcaneOrb && ArcaneChargePassive.BuffStack <= 1 && ArcaneOrb.IsSpellUsable && ArcaneOrb.IsHostileDistanceGood)
            {
                ArcaneOrb.Cast();
                return;
            }
            if (MySettings.UseConeofCold && MySettings.UseConeofColdGlyph && ConeofCold.IsSpellUsable && ObjectManager.GetUnitInSpellRange(ConeofCold.MaxRangeHostile) >= 5)
            {
                ConeofCold.Cast();
                return;
            }
            if (MySettings.UseArcaneExplosion && ArcaneChargePassive.BuffStack < 4 && ArcaneExplosion.IsSpellUsable && ObjectManager.GetUnitInSpellRange(ArcaneExplosion.MaxRangeHostile) >= 5)
            {
                ArcaneExplosion.Cast();
                return;
            }
            if (MySettings.UseArcaneMissiles && (ArcaneChargePassive.BuffStack >= 4 || ArcaneMissiles.GetSpellCharges >= 3) && ArcaneMissiles.IsSpellUsable && ArcaneMissiles.IsHostileDistanceGood)
            {
                ArcaneMissiles.Cast();
                return;
            }
            if (MySettings.UseArcaneMissiles && ArcaneChargePassive.BuffStack >= 4 && ArcaneMissiles.IsSpellUsable && ArcaneMissiles.IsHostileDistanceGood)
            {
                ArcaneMissiles.Cast();
                return;
            }
            if (MySettings.UseArcaneBlast && (ObjectManager.Me.ManaPercentage >= 93 || ArcaneChargePassive.BuffStack < 4 || _burnPhaseStarted) && ArcaneBlast.IsSpellUsable && ArcaneBlast.IsHostileDistanceGood)
            {
                ArcaneBlast.Launch(true, false, true);
                return;
            }
            if (MySettings.UseArcaneBarrage && !_burnPhaseStarted && ArcaneChargePassive.BuffStack >= 4 && ArcaneBarrage.IsSpellUsable && ArcaneBarrage.IsHostileDistanceGood)
            {
                ArcaneBarrage.Cast();
                return;
            }
            if (MySettings.UseArcaneExplosion && ObjectManager.Me.GetMove && ObjectManager.Me.AuraIsActiveAndExpireInLessThanMs(ArcaneChargePassive.Id, 3500)
                && ArcaneExplosion.IsSpellUsable && ObjectManager.GetUnitInSpellRange(ArcaneExplosion.MaxRangeHostile) >= 1)
            {
                ArcaneExplosion.Cast();
                return;
            }
        }
        finally
        {
            Memory.WowMemory.GameFrameUnLock();
        }
    }

    private void Patrolling()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        Buff();
        Heal();
    }

    #region Nested type: MageArcaneSettings

    [Serializable]
    public class MageArcaneSettings : Settings
    {
        public bool DoAvoidMelee = false;
        public int DoAvoidMeleeDistance = 0;
        public bool UseAlchFlask = true;
        public bool UseAlterTime = true;
        public int UseAlterTimeAtPercentage = 80;
        public bool UseArcaneBarrage = true;
        public bool UseArcaneBlast = true;
        public bool UseArcaneBrilliance = true;
        public bool UseArcaneExplosion = true;
        public bool UseArcaneMissiles = true;
        public bool UseArcaneOrb = true;
        public bool UseArcanePower = true;
        public bool UseArcaneTorrentForDecast = true;
        public int UseArcaneTorrentForDecastAtPercentage = 100;
        public bool UseArcaneTorrentForResource = true;
        public int UseArcaneTorrentForResourceAtPercentage = 80;
        public bool UseBerserking = true;
        public bool UseBlazingSpeed = true;
        public bool UseBlink = true;
        public bool UseBloodFury = true;
        public bool UseColdSnapForDefence = true;
        public bool UseColdSnapForHeal = true;
        public int UseColdSnapForHealAtPercentage = 70;
        public bool UseConeofCold = true;
        public int UseConeofColdAtPercentage = 45;
        public bool UseConeofColdGlyph = false;
        public bool UseConjureRefreshment = true;
        public bool UseCounterspell = true;
        public int UseCounterspellAtPercentage = 100;
        public bool UseEvanesce = true;
        public int UseEvanesceAtPercentage = 90;
        public bool UseEvocation = true;
        public bool UseFrostNova = true;
        public int UseFrostNovaAtPercentage = 50;
        public bool UseFrostjaw = true;
        public int UseFrostjawAtPercentage = 100;
        public bool UseGiftoftheNaaru = true;
        public int UseGiftoftheNaaruAtPercentage = 80;
        public bool UseGreaterInvisibility = true;
        public int UseGreaterInvisibilityAtPercentage = 10;
        public bool UseIceBarrier = true;
        public int UseIceBarrierAtPercentage = 95;
        public bool UseIceBlock = true;
        public bool UseIceFloes = true;
        public bool UseIceWard = true;
        public int UseIceWardAtPercentage = 45;
        public bool UseInvisibility = true;
        public int UseInvisibilityAtPercentage = 10;
        public bool UseLowCombat = true;
        public int UseLowCombatAtPercentage = 15;
        public bool UseMirrorImage = true;
        public bool UseNetherTempest = true;
        public bool UsePresenceofMind = true;
        public bool UsePrismaticCrystal = true;
        public bool UseRingofFrost = true;
        public bool UseRuneofPower = true;
        public bool UseScorch = true;
        public bool UseSlow = false;
        public bool UseStoneform = true;
        public int UseStoneformAtPercentage = 80;
        public bool UseSupernova = true;
        public bool UseTimeWarp = true;
        public bool UseTrinketOne = true;
        public bool UseTrinketTwo = true;
        public bool UseWarStomp = true;
        public int UseWarStompAtPercentage = 80;

        public MageArcaneSettings()
        {
            ConfigWinForm("Mage Arcane Settings");
            /* Professions & Racials */
            AddControlInWinForm("Use Arcane Torrent for Interrupt", "UseArcaneTorrentForDecast", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Arcane Torrent for Resource", "UseArcaneTorrentForResource", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Berserking", "UseBerserking", "Professions & Racials");
            AddControlInWinForm("Use Blood Fury", "UseBloodFury", "Professions & Racials");
            AddControlInWinForm("Use Gift of the Naaru", "UseGiftoftheNaaru", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Stoneform", "UseStoneform", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use War Stomp", "UseWarStomp", "Professions & Racials", "AtPercentage");
            /* Mage Buffs */
            AddControlInWinForm("Use Arcane Brilliance", "UseArcaneBrilliance", "Mage Buffs");
            AddControlInWinForm("Use Blazing Speed", "UseBlazingSpeed", "Mage Buffs");
            AddControlInWinForm("Use Ice Floes", "UseIceFloes", "Mage Buffs");
            AddControlInWinForm("Use Rune of Power", "UseRuneofPower", "Mage Buffs");
            /* Offensive Spell */
            AddControlInWinForm("Use Arcane Barrage", "UseArcaneBarrage", "Offensive Spell");
            AddControlInWinForm("Use Arcane Blast", "UseArcaneBlast", "Offensive Spell");
            AddControlInWinForm("Use Arcane Explosion", "UseArcaneExplosion", "Offensive Spell");
            AddControlInWinForm("Use Arcane Missiles", "UseArcaneMissiles", "Offensive Spell");
            AddControlInWinForm("Use Arcane Orb", "UseArcaneOrb", "Offensive Spell");
            AddControlInWinForm("Use Nether Tempest", "UseNetherTempest", "Offensive Spell");
            /* Offensive Cooldown */
            AddControlInWinForm("Use Arcane Power", "UseArcanePower", "Offensive Cooldown");
            AddControlInWinForm("Use Mirror Image", "UseMirrorImage", "Offensive Cooldown");
            AddControlInWinForm("Use Presence of Mind", "UsePresenceofMind", "Offensive Cooldown");
            AddControlInWinForm("Use Prismatic Crystal", "UsePrismaticCrystal", "Offensive Cooldown");
            AddControlInWinForm("Use Supernova", "UseSupernova", "Offensive Cooldown");
            AddControlInWinForm("Use Time Warp", "UseTimeWarp", "Offensive Cooldown");
            /* Defensive Cooldown */
            AddControlInWinForm("Use Alter Time", "UseAlterTime", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Blink", "UseBlink", "Defensive Cooldown");
            AddControlInWinForm("Use Cone of Cold", "UseConeofCold", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Cold Snap For Defence", "UseColdSnapForDefence", "Defensive Cooldown");
            AddControlInWinForm("Use Counterspell", "UseCounterspell", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Evanesce", "UseEvanesce", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Frostjaw", "UseFrostjaw", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Frost Nova", "UseFrostNova", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Greater Invisiblity", "UseGreaterInvisibility", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Ice Barrier", "UseIceBarrier", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Ice Block", "UseIceBlock", "Defensive Cooldown");
            AddControlInWinForm("Use Ice Ward", "UseIceWard", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Invisibility", "UseInvisibility", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Ring of Frost", "UseRingofFrost", "Defensive Cooldown");
            AddControlInWinForm("Use Slow", "UseSlow", "Defensive Cooldown");
            /* Healing Spell */
            AddControlInWinForm("Use Cold Snap For Healing", "UseColdSnapForHeal", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Conjure Refreshment", "UseConjureRefreshment", "Healing Spell");
            AddControlInWinForm("Use Evocation", "UseEvocation", "Healing Spell"); 
            /* Game Settings */
            AddControlInWinForm("Use Cone of Cold Glyph", "UseConeofColdGlyph", "Game Settings");
            AddControlInWinForm("Use Low Combat - Level Difference", "UseLowCombat", "Game Settings", "AtPercentage");
            AddControlInWinForm("Use Trinket One", "UseTrinketOne", "Game Settings");
            AddControlInWinForm("Use Trinket Two", "UseTrinketTwo", "Game Settings");
            AddControlInWinForm("Use Alchemist Flask", "UseAlchFlask", "Game Settings");
            AddControlInWinForm("Do avoid melee (Off Advised!!)", "DoAvoidMelee", "Game Settings");
            AddControlInWinForm("Avoid melee distance (1 to 4)", "DoAvoidMeleeDistance", "Game Settings");
        }

        public static MageArcaneSettings CurrentSetting { get; set; }

        public static MageArcaneSettings GetSettings()
        {
            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Mage_Arcane.xml";
            if (File.Exists(currentSettingsFile))
            {
                return
                    CurrentSetting = Load<MageArcaneSettings>(currentSettingsFile);
            }
            return new MageArcaneSettings();
        }
    }

    #endregion
}

public class MageFrost
{
    private static MageFrostSettings MySettings = MageFrostSettings.GetSettings();

    #region General Timers & Variablesoffrostat

    private readonly WoWItem _firstTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET);
    private readonly WoWItem _secondTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET, 2);
    public int DecastHP = 0;
    public int DefenseHP = 0;
    public int HealHP = 0;
    public int HealMP = 0;
    public int LC = 0;

    private Timer _petAbilityTimer = new Timer(0);
    private Timer _onCd = new Timer(0);

    #endregion

    #region Professions & Racials

    public readonly Spell ArcaneTorrent = new Spell("Arcane Torrent");
    public readonly Spell Berserking = new Spell("Berserking");
    public readonly Spell BloodFury = new Spell("Blood Fury");
    public readonly Spell GiftoftheNaaru = new Spell("Gift of the Naaru");
    public readonly Spell Stoneform = new Spell("Stoneform");
    public readonly Spell WarStomp = new Spell("War Stomp");

    #endregion

    #region Mage Buffs

    public readonly Spell ArcaneBrilliance = new Spell("Arcane Brilliance");
    public readonly Spell BlazingSpeed = new Spell("Blazing Speed");
    public readonly Spell BrainFreeze = new Spell(57761);
    public readonly Spell Cauterize = new Spell(87024);
    public readonly Spell DalaranBrilliance = new Spell("Dalaran Brilliance");
    public readonly Spell FingersofFrost = new Spell(44544);
    public readonly Spell Hypothermia = new Spell(41425);
    public readonly Spell IceFloes = new Spell("Ice Floes");
    public readonly Spell RuneofPower = new Spell("Rune of Power");
    public readonly Spell RuneofPowerBuff = new Spell(116014);

    #endregion

    #region Offensive Spell

    public readonly Spell Blizzard = new Spell("Blizzard");
    public readonly Spell CometStorm = new Spell("Comet Storm");
    public readonly Spell ConeofCold = new Spell("Cone of Cold");
    public readonly Spell FireBlast = new Spell("Fire Blast");
    public readonly Spell Frostbolt = new Spell("Frostbolt");
    public readonly Spell FrostBomb = new Spell("Frost Bomb");
    public readonly Spell FrostfireBolt = new Spell("Frostfire Bolt");
    public readonly Spell IceLance = new Spell("Ice Lance");
    public readonly Spell IceNova = new Spell("Ice Nova");
    public readonly Spell WaterJet = new Spell(135029);
    public readonly Spell SummonWaterElemental = new Spell("Summon Water Elemental");
    private Timer _waterJetTimer = new Timer(0);

    #endregion

    #region Offensive Cooldown

    public readonly Spell FrozenOrb = new Spell("Frozen Orb");
    public readonly Spell IcyVeins = new Spell("Icy Veins");
    public readonly Spell MirrorImage = new Spell("Mirror Image");
    public readonly Spell PrismaticCrystal = new Spell("Prismatic Crystal");
    public readonly Spell TimeWarp = new Spell("Time Warp");
    private Timer _frozenOrbTimer = new Timer(0);

    #endregion

    #region Defensive Cooldown

    public readonly Spell AlterTime = new Spell("Alter Time");
    public readonly Spell Blink = new Spell("Blink");
    public readonly Spell Counterspell = new Spell("Counterspell");
    public readonly Spell DeepFreeze = new Spell("Deep Freeze");
    public readonly Spell Evanesce = new Spell("Evanesce");
    public readonly Spell Frostjaw = new Spell("Frostjaw");
    public readonly Spell FrostNova = new Spell("Frost Nova");
    public readonly Spell GreaterInvisibility = new Spell("Greater Invisibility");
    public readonly Spell IceBarrier = new Spell("Ice Barrier");
    public readonly Spell IceBlock = new Spell("Ice Block");
    public readonly Spell IceWard = new Spell("Ice Ward");
    public readonly Spell Invisibility = new Spell("Invisibility");
    public readonly Spell RingofFrost = new Spell("Ring of Frost");

    #endregion

    #region Healing Spell

    public readonly Spell ColdSnap = new Spell("Cold Snap");
    public readonly Spell ConjureRefreshment = new Spell("Conjure Refreshment");
    private Timer _conjureRefreshmentTimer = new Timer(0);

    #endregion

    public MageFrost()
    {
        Main.InternalRange = 39f;
        Main.InternalAggroRange = 39f;
        MySettings = MageFrostSettings.GetSettings();
        Main.DumpCurrentSettings<MageFrostSettings>(MySettings);
        UInt128 lastTarget = 0;
        LowHP();

        while (Main.InternalLoop)
        {
            try
            {
                if (!ObjectManager.Me.IsDeadMe)
                {
                    if (!ObjectManager.Me.IsMounted)
                    {
                        if (Fight.InFight && ObjectManager.Me.Target > 0)
                        {
                            if (ObjectManager.Me.Target != lastTarget && (Frostbolt.IsHostileDistanceGood || IceLance.IsHostileDistanceGood))
                            {
                                Pull();
                                lastTarget = ObjectManager.Me.Target;
                            }
                            if (MySettings.UseLowCombat && (ObjectManager.Me.Level - ObjectManager.Target.Level >= MySettings.UseLowCombatAtPercentage))
                            {
                                LC = 1;
                                if (CombatClass.InSpellRange(ObjectManager.Target, 0, Main.InternalRange))
                                    LowCombat();
                            }
                            else
                            {
                                LC = 0;
                                if (CombatClass.InSpellRange(ObjectManager.Target, 0, Main.InternalRange))
                                    Combat();
                            }
                        }

                        if (!ObjectManager.Me.IsCast)
                            Patrolling();
                    }
                }
                else
                    Thread.Sleep(500);
            }
            catch
            {
            }
            Thread.Sleep(100);
        }
    }

    private void LowHP()
    {
        if (MySettings.UseAlterTimeAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseAlterTimeAtPercentage;

        if (MySettings.UseConeofColdAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseConeofColdAtPercentage;

        if (MySettings.UseDeepFreezeAtPercentage < DefenseHP)
            DefenseHP = MySettings.UseDeepFreezeAtPercentage;

        if (MySettings.UseFrostNovaAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseFrostNovaAtPercentage;

        if (MySettings.UseEvanesceAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseEvanesceAtPercentage;

        if (MySettings.UseGreaterInvisibilityAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseGreaterInvisibilityAtPercentage;

        if (MySettings.UseIceBarrierAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseIceBarrierAtPercentage;

        if (MySettings.UseIceWardAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseIceWardAtPercentage;

        if (MySettings.UseInvisibilityAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseInvisibilityAtPercentage;

        if (MySettings.UseStoneformAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseStoneformAtPercentage;

        if (MySettings.UseWarStompAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseWarStompAtPercentage;

        if (MySettings.UseArcaneTorrentForDecastAtPercentage > DecastHP)
            DecastHP = MySettings.UseArcaneTorrentForDecastAtPercentage;

        if (MySettings.UseCounterspellAtPercentage > DecastHP)
            DecastHP = MySettings.UseCounterspellAtPercentage;

        if (MySettings.UseFrostjawAtPercentage > DecastHP)
            DecastHP = MySettings.UseFrostjawAtPercentage;

        if (MySettings.UseArcaneTorrentForResourceAtPercentage > HealMP)
            HealMP = MySettings.UseArcaneTorrentForResourceAtPercentage;

        if (MySettings.UseColdSnapForHealAtPercentage > HealHP)
            HealHP = MySettings.UseColdSnapForHealAtPercentage;

        if (MySettings.UseGiftoftheNaaruAtPercentage > HealHP)
            HealHP = MySettings.UseGiftoftheNaaruAtPercentage;
    }

    private void Pull()
    {
        if (ObjectManager.Pet.IsAlive)
        {
            Lua.RunMacroText("/petattack");
            Logging.WriteFight("Cast Pet Attack");
        }
        if (MySettings.UseRuneofPower && !RuneofPowerBuff.HaveBuff && RuneofPower.IsSpellUsable && Frostbolt.IsHostileDistanceGood)
            SpellManager.CastSpellByIDAndPosition(RuneofPower.Id, ObjectManager.Me.Position);

        if (MySettings.UseIceFloes && IceFloes.IsSpellUsable && ObjectManager.Me.GetMove)
            IceFloes.Cast();

        if (MySettings.UseFrostbolt && Frostbolt.KnownSpell && Frostbolt.IsSpellUsable && Frostbolt.IsHostileDistanceGood)
            Frostbolt.Cast();

        if (MySettings.UseFreeze && _petAbilityTimer.IsReady && (ObjectManager.Pet.Health != 0 || ObjectManager.Pet.Guid != 0)
            && !ObjectManager.Target.IsBoss && Frostbolt.IsHostileDistanceGood)
        {
            SpellManager.CastSpellByIDAndPosition(33395, ObjectManager.Target.Position);
            _petAbilityTimer = new Timer(1000 * 25);
            Others.SafeSleep(1000);

            if (MySettings.UseDeepFreeze && DeepFreeze.IsSpellUsable && DeepFreeze.IsHostileDistanceGood)
                DeepFreeze.Cast();
        }
    }

    private void LowCombat()
    {
        Buff();

        if (MySettings.DoAvoidMelee)
            AvoidMelee();

        if (_onCd.IsReady && ObjectManager.Me.HealthPercent <= DefenseHP)
            DefenseCycle();

        if (ObjectManager.Me.HealthPercent <= HealHP)
            Heal();

        if (MySettings.UseIceLance && IceLance.KnownSpell && FingersofFrost.HaveBuff && IceLance.IsSpellUsable && IceLance.IsHostileDistanceGood)
        {
            IceLance.Cast();
            return;
        }
        if (MySettings.UseFrostfireBolt && FrostfireBolt.KnownSpell && BrainFreeze.HaveBuff && FrostfireBolt.IsSpellUsable && FrostfireBolt.IsHostileDistanceGood)
        {
            FrostfireBolt.Cast();
            return;
        }
        if (MySettings.UseFrostbolt && Frostbolt.KnownSpell && Frostbolt.IsSpellUsable && Frostbolt.IsHostileDistanceGood)
        {
            Frostbolt.Cast();
            return;
        }
        if (MySettings.UseConeofCold && ConeofCold.IsSpellUsable && ConeofCold.IsHostileDistanceGood)
            ConeofCold.Cast();
    }

    private void Combat()
    {
        Buff();

        if (MySettings.DoAvoidMelee)
            AvoidMelee();

        DPSCycle();

        if (_onCd.IsReady && (ObjectManager.Me.HealthPercent <= DefenseHP || ObjectManager.GetNumberAttackPlayer() > 2))
            DefenseCycle();

        if (ObjectManager.Me.HealthPercent <= HealHP || ObjectManager.Me.ManaPercentage <= HealMP)
            Heal();

        if (ObjectManager.Me.HealthPercent <= DecastHP)
            Decast();

        DPSBurst();
        DPSCycle();
    }

    private void Buff()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (MySettings.UseSummonWaterElemental && (ObjectManager.Pet.Health == 0 || ObjectManager.Pet.Guid == 0) && SummonWaterElemental.IsSpellUsable)
        {
            Logging.WriteFight(" - PET DEAD - ");
            SummonWaterElemental.Cast();
        }

        if (MySettings.UseIceBlock && !Evanesce.KnownSpell && Cauterize.HaveBuff && !Hypothermia.HaveBuff)
        {
            if (MySettings.UseColdSnapForDefence && !IceBlock.IsSpellUsable && ColdSnap.IsSpellUsable)
            {
                ColdSnap.Cast();
                Others.SafeSleep(1000);
            }
            if (IceBlock.IsSpellUsable)
            {
                IceBlock.Cast();
                _onCd = new Timer(1000*10);
                return;
            }
        }
        if (MySettings.UseArcaneBrilliance && !ArcaneBrilliance.HaveBuff && !DalaranBrilliance.HaveBuff && ArcaneBrilliance.IsSpellUsable)
            ArcaneBrilliance.Cast();

        if (MySettings.UseBlazingSpeed && ObjectManager.Me.GetMove && BlazingSpeed.IsSpellUsable)
            BlazingSpeed.Cast();

        if (MySettings.UseAlchFlask && !ObjectManager.Me.HaveBuff(79638) && !ObjectManager.Me.HaveBuff(79640) && !ObjectManager.Me.HaveBuff(79639)
            && !ItemsManager.IsItemOnCooldown(75525) && ItemsManager.GetItemCount(75525) > 0)
            ItemsManager.UseItem(75525);

        if (MySettings.UseConjureRefreshment && _conjureRefreshmentTimer.IsReady
            && ItemsManager.GetItemCount(113509) == 0 // 100
            && ItemsManager.GetItemCount(80610) == 0 // 90
            && ItemsManager.GetItemCount(65499) == 0 // 85-89
            && ItemsManager.GetItemCount(43523) == 0 // 84-80
            && ItemsManager.GetItemCount(43518) == 0 // 79-74
            && ItemsManager.GetItemCount(65517) == 0 // 73-64
            && ItemsManager.GetItemCount(65516) == 0 // 63-54
            && ItemsManager.GetItemCount(65515) == 0 // 53-44
            && ItemsManager.GetItemCount(65500) == 0 // 43-38
            && ConjureRefreshment.IsSpellUsable)
        {
            ConjureRefreshment.Cast();
            _conjureRefreshmentTimer = new Timer(1000*60*10);
        }
    }

    private void AvoidMelee()
    {
        if (ObjectManager.Target.GetDistance < MySettings.DoAvoidMeleeDistance && ObjectManager.Target.InCombat)
        {
            Logging.WriteFight("Too Close. Moving Back");
            var maxTimeTimer = new Timer(1000*2);
            MovementsAction.MoveBackward(true);
            while (ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat && !maxTimeTimer.IsReady)
                Others.SafeSleep(300);
            MovementsAction.MoveBackward(false);
            if (maxTimeTimer.IsReady && ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat)
            {
                MovementsAction.MoveForward(true);
                Others.SafeSleep(1000);
                MovementsAction.MoveForward(false);
                MovementManager.Face(ObjectManager.Target.Position);
            }
        }
    }

    private void DefenseCycle()
    {
        if (MySettings.UseAlterTime && !AlterTime.HaveBuff && ObjectManager.Me.HealthPercent <= MySettings.UseAlterTimeAtPercentage && AlterTime.IsSpellUsable)
        {
            AlterTime.Cast();
            return;
        }
        if (MySettings.UseBlink && (FrostNova.TargetHaveBuff || ConeofCold.TargetHaveBuff || Frostjaw.TargetHaveBuff) && Blink.IsSpellUsable 
            && ObjectManager.Target.GetDistance < 5)
        {
            Blink.Cast();
            return;
        }
        if (MySettings.UseConeofCold && ObjectManager.Me.HealthPercent <= MySettings.UseConeofColdAtPercentage && ConeofCold.IsSpellUsable && ConeofCold.IsHostileDistanceGood)
        {
            ConeofCold.Cast();
            return;
        }
        if (MySettings.UseDeepFreeze && ObjectManager.Me.HealthPercent <= MySettings.UseDeepFreezeAtPercentage && DeepFreeze.IsSpellUsable && DeepFreeze.IsHostileDistanceGood )
        {
            DeepFreeze.Cast();
            _onCd = new Timer(1000*5);
            return;
        }
        if (MySettings.UseEvanesce && ObjectManager.Me.HealthPercent <= MySettings.UseEvanesceAtPercentage)
        {
            if (MySettings.UseColdSnapForDefence && !Evanesce.IsSpellUsable && ColdSnap.IsSpellUsable)
            {
                ColdSnap.Cast();
                Others.SafeSleep(1000);
            }
            if (Evanesce.IsSpellUsable)
            {
                Evanesce.Cast();
                _onCd = new Timer(1000*3);
            }
            return;
        }
        if (MySettings.UseFrostjaw && ObjectManager.Me.HealthPercent <= MySettings.UseFrostjawAtPercentage && Frostjaw.IsSpellUsable && ObjectManager.Target.GetDistance < 10)
        {
            Frostjaw.Cast();
            return;
        }
        if (MySettings.UseFrostNova && ObjectManager.Me.HealthPercent <= MySettings.UseFrostNovaAtPercentage && ObjectManager.GetUnitInSpellRange(RingofFrost.MaxRangeHostile) > 0)
        {
            if (MySettings.UseColdSnapForDefence && !FrostNova.IsSpellUsable && ColdSnap.IsSpellUsable)
            {
                ColdSnap.Cast();
                Others.SafeSleep(1000);
            }
            if (FrostNova.IsSpellUsable)
            {
                FrostNova.Cast();
                _onCd = new Timer(1000*8);
            }
            return;
        }
        if (MySettings.UseIceBarrier && !IceBarrier.HaveBuff && ObjectManager.Me.HealthPercent <= MySettings.UseIceBarrierAtPercentage && IceBarrier.IsSpellUsable)
        {
            IceBarrier.Cast();
            return;
        }
        if (MySettings.UseIceWard && ObjectManager.Me.HealthPercent <= MySettings.UseIceWardAtPercentage && IceWard.IsSpellUsable && ObjectManager.Target.GetDistance < 10)
        {
            IceWard.Cast();
            _onCd = new Timer(1000*5);
            return;
        }
        if (MySettings.UseInvisibility && ObjectManager.Me.HealthPercent <= MySettings.UseInvisibilityAtPercentage && Invisibility.IsSpellUsable)
        {
            Invisibility.Cast();
            Others.SafeSleep(8000);
            return;
        }
        if (MySettings.UseGreaterInvisibility && ObjectManager.Me.HealthPercent <= MySettings.UseGreaterInvisibilityAtPercentage && Invisibility.IsSpellUsable)
        {
            GreaterInvisibility.Cast();
            Others.SafeSleep(8000);
            return;
        }
        if (MySettings.UseRingofFrost && RingofFrost.IsSpellUsable && ObjectManager.GetUnitInSpellRange(RingofFrost.MaxRangeHostile) > 2)
        {
            SpellManager.CastSpellByIDAndPosition(113724, ObjectManager.Target.Position);
            _onCd = new Timer(1000*10);
            return;
        }
        if (MySettings.UseStoneform && ObjectManager.Me.HealthPercent <= MySettings.UseStoneformAtPercentage && Stoneform.IsSpellUsable)
        {
            Stoneform.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (MySettings.UseWarStomp && ObjectManager.Me.HealthPercent <= MySettings.UseWarStompAtPercentage && WarStomp.IsSpellUsable 
            && ObjectManager.GetUnitInSpellRange(WarStomp.MaxRangeHostile) > 0)
        {
            WarStomp.Cast();
            _onCd = new Timer(1000*2);
        }
    }

    private void Heal()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (MySettings.UseArcaneTorrentForResource && ObjectManager.Me.ManaPercentage <= MySettings.UseArcaneTorrentForResourceAtPercentage && ArcaneTorrent.IsSpellUsable)
        {
            ArcaneTorrent.Cast();
            return;
        }
        if (MySettings.UseGiftoftheNaaru && ObjectManager.Me.HealthPercent <= MySettings.UseGiftoftheNaaruAtPercentage && GiftoftheNaaru.IsSpellUsable)
        {
            GiftoftheNaaru.Cast();
            return;
        }
        if (MySettings.UseColdSnapForHeal && ObjectManager.Me.HealthPercent <= MySettings.UseColdSnapForHealAtPercentage && ColdSnap.IsSpellUsable)
        {
            ColdSnap.Cast();
            return;
        }
    }

    private void Decast()
    {
        if (MySettings.UseArcaneTorrentForDecast && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe && ObjectManager.Me.HealthPercent <= MySettings.UseArcaneTorrentForDecastAtPercentage
            && ArcaneTorrent.IsSpellUsable && ObjectManager.Target.GetDistance < 8)
        {
            ArcaneTorrent.Cast();
            return;
        }
        if (MySettings.UseCounterspell && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe && ObjectManager.Me.HealthPercent <= MySettings.UseCounterspellAtPercentage
            && Counterspell.IsSpellUsable && Counterspell.IsHostileDistanceGood)
        {
            Counterspell.Cast();
            return;
        }
        if (MySettings.UseFrostjaw && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe && ObjectManager.Me.HealthPercent <= MySettings.UseFrostjawAtPercentage
            && Frostjaw.IsSpellUsable && Frostjaw.IsHostileDistanceGood)
            Frostjaw.Cast();
    }

    private void DPSBurst()
    {
        if (MySettings.UseTrinketOne && !ItemsManager.IsItemOnCooldown(_firstTrinket.Entry) && ItemsManager.IsItemUsable(_firstTrinket.Entry))
        {
            ItemsManager.UseItem(_firstTrinket.Name);
            Logging.WriteFight("Use First Trinket Slot");
        }
        if (MySettings.UseTrinketTwo && !ItemsManager.IsItemOnCooldown(_secondTrinket.Entry) && ItemsManager.IsItemUsable(_secondTrinket.Entry))
        {
            ItemsManager.UseItem(_secondTrinket.Name);
            Logging.WriteFight("Use Second Trinket Slot");
        }
        if (MySettings.UseBerserking && Berserking.IsSpellUsable && Frostbolt.IsHostileDistanceGood)
        {
            if (ObjectManager.Me.IsCast)
                ObjectManager.Me.StopCast();

            Others.SafeSleep(500);
            Berserking.Cast();
        }
        if (MySettings.UseBloodFury && BloodFury.IsSpellUsable && Frostbolt.IsHostileDistanceGood)
        {
            if (ObjectManager.Me.IsCast)
                ObjectManager.Me.StopCast();

            Others.SafeSleep(500);
            BloodFury.Cast();
        }
        if (MySettings.UseIcyVeins && IcyVeins.IsSpellUsable && Frostbolt.IsHostileDistanceGood)
        {
            if (ObjectManager.Me.IsCast)
                ObjectManager.Me.StopCast();

            Others.SafeSleep(500);
            IcyVeins.Cast();
        }
        if (MySettings.UseMirrorImage && MirrorImage.IsSpellUsable && Frostbolt.IsHostileDistanceGood)
        {
            if (ObjectManager.Me.IsCast)
                ObjectManager.Me.StopCast();

            Others.SafeSleep(1000);
            MirrorImage.Cast();
        }
        if (MySettings.UseRuneofPower && !RuneofPowerBuff.HaveBuff && !ObjectManager.Me.GetMove && RuneofPower.IsSpellUsable && Frostbolt.IsHostileDistanceGood)
        {
            if (ObjectManager.Me.IsCast)
                ObjectManager.Me.StopCast();

            Others.SafeSleep(500);
            SpellManager.CastSpellByIDAndPosition(116011, ObjectManager.Me.Position);
        }
        if (MySettings.UsePrismaticCrystal && PrismaticCrystal.IsSpellUsable && PrismaticCrystal.IsHostileDistanceGood)
        {
            if (ObjectManager.Me.IsCast)
                ObjectManager.Me.StopCast();

            Others.SafeSleep(500);
            SpellManager.CastSpellByIDAndPosition(152087, ObjectManager.Target.Position);
            Lua.RunMacroText("/target Prismatic Crystal");

            if (ObjectManager.Pet.IsAlive)
            {
                Lua.RunMacroText("/petattack");
                Logging.WriteFight("Cast Pet Attack");
            }
        }
        if (MySettings.UseTimeWarp && !ObjectManager.Me.HaveBuff(80354) && !ObjectManager.Me.HaveBuff(57724) && !ObjectManager.Me.HaveBuff(57723) && !ObjectManager.Me.HaveBuff(95809)
            && TimeWarp.IsSpellUsable && Frostbolt.IsHostileDistanceGood)
        {
            if (ObjectManager.Me.IsCast)
                ObjectManager.Me.StopCast();

            Others.SafeSleep(500);
            TimeWarp.Cast();
        }
    }

    private void DPSCycle()
    {
        Usefuls.SleepGlobalCooldown();
        try
        {
            Memory.WowMemory.GameFrameLock(); // !!! WARNING - DONT SLEEP WHILE LOCKED - DO FINALLY(GameFrameUnLock()) !!!

            if (MySettings.UseIceFloes && !IceFloes.HaveBuff && ObjectManager.Me.GetMove && IceFloes.IsSpellUsable && Frostbolt.IsHostileDistanceGood)
                IceFloes.Cast();

            if (MySettings.UseFrozenOrb && FrozenOrb.IsSpellUsable && FrozenOrb.IsHostileDistanceGood)
            {
                FrozenOrb.Cast();
                _frozenOrbTimer = new Timer(1000*10);
                return;
            }
            if (MySettings.UseCometStorm && !ObjectManager.Target.GetMove && CometStorm.IsSpellUsable && CometStorm.IsHostileDistanceGood)
            {
                CometStorm.Cast();
                return;
            }
            if (MySettings.UseFrostBomb && !FrostBomb.TargetHaveBuff && FingersofFrost.BuffStack > 1 && FrostBomb.IsSpellUsable && Frostbolt.IsHostileDistanceGood)
            {
                FrostBomb.Cast();
                return;
            }
            if (MySettings.UseFreeze && _petAbilityTimer.IsReady && _frozenOrbTimer.IsReady && (ObjectManager.Pet.Health != 0 || ObjectManager.Pet.Guid != 0)
                && FingersofFrost.BuffStack < 2 && !ObjectManager.Target.IsBoss && Frostbolt.IsHostileDistanceGood)
            {
                SpellManager.CastSpellByIDAndPosition(33395, ObjectManager.Target.Position);
                _petAbilityTimer = new Timer(1000*25);
                return;
            }
            if (MySettings.UseIceNova && IceNova.GetSpellCharges > 1 && IceNova.IsSpellUsable && IceNova.IsHostileDistanceGood)
            {
                IceNova.Cast();
                return;
            }
            if (FrostBomb.KnownSpell)
            {
                if (MySettings.UseIceLance && FingersofFrost.HaveBuff && (FingersofFrost.BuffStack > 1 || FrostBomb.TargetHaveBuff
                    || ObjectManager.Me.UnitAura(44544).AuraTimeLeftInMs < 4000) && IceLance.IsSpellUsable && IceLance.IsHostileDistanceGood)
                {
                    IceLance.Cast();
                    return;
                }
            }
            else
            {
                if (MySettings.UseIceLance && FingersofFrost.HaveBuff && IceLance.IsSpellUsable && IceLance.IsHostileDistanceGood)
                {
                    IceLance.Cast();
                    return;
                }
            }
            if (MySettings.UseConeofCold && ConeofCold.IsSpellUsable && ObjectManager.GetUnitInSpellRange(ConeofCold.MaxRangeHostile) > 1)
            {
                ConeofCold.Cast();
                return;
            }
            if (MySettings.UseBlizzard && Blizzard.IsSpellUsable && ObjectManager.GetUnitInSpellRange(Blizzard.MaxRangeHostile) > 4)
            {
                SpellManager.CastSpellByIDAndPosition(10, ObjectManager.Target.Position);
                Others.SafeSleep(500);
                while (FingersofFrost.BuffStack < 2 && ObjectManager.Me.IsCast)
                    Others.SafeSleep(20);

                if (ObjectManager.Me.IsCast)
                    ObjectManager.Me.StopCast();
                return;
            }
            if (MySettings.UseFrostfireBolt && BrainFreeze.HaveBuff && FingersofFrost.BuffStack < 2 && FrostfireBolt.IsSpellUsable && FrostfireBolt.IsHostileDistanceGood)
            {
                FrostfireBolt.Cast();
                return;
            }
            if (MySettings.UseWaterJet && _petAbilityTimer.IsReady && _frozenOrbTimer.IsReady && ObjectManager.Me.Level > 99 && (ObjectManager.Pet.Health != 0 || ObjectManager.Pet.Guid != 0)
                && Frostbolt.IsHostileDistanceGood)
            {
                while (FingersofFrost.HaveBuff)
                    IceLance.Cast();

                WaterJet.Cast();
                _petAbilityTimer = new Timer(1000*25);
                _waterJetTimer = new Timer(1000*4);

                while (!_waterJetTimer.IsReady)
                {
                    if (MySettings.UseFrostbolt && Frostbolt.KnownSpell && Frostbolt.IsHostileDistanceGood && Frostbolt.IsSpellUsable)
                        Frostbolt.Cast();
                }
                return;
            }
            if (MySettings.UseIceNova && IceNova.GetSpellCharges > 0 && IceNova.IsSpellUsable && IceNova.IsHostileDistanceGood)
            {
                IceNova.Cast();
                return;
            }
            if (MySettings.UseFrostbolt && BrainFreeze.BuffStack < 2 && FingersofFrost.BuffStack < 2 && Frostbolt.IsSpellUsable && Frostbolt.IsHostileDistanceGood)
            {
                Frostbolt.Launch(true, false, true);
                return;
            }
            if (MySettings.UseFrostfireBolt && (!MySettings.UseFrostbolt || !Frostbolt.KnownSpell) && FrostfireBolt.IsSpellUsable && FrostfireBolt.IsHostileDistanceGood)
            {
                FrostfireBolt.Cast();
                return;
            }
            if (MySettings.UseFireBlast && !IceLance.KnownSpell && FireBlast.IsSpellUsable && FireBlast.IsHostileDistanceGood)
                FireBlast.Cast();
        }
        finally
        {
            Memory.WowMemory.GameFrameUnLock();
        }
    }

    private void Patrolling()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        Buff();
        Heal();
    }

    #region Nested type: MageFrostSettings

    [Serializable]
    public class MageFrostSettings : Settings
    {
        public bool DoAvoidMelee = false;
        public int DoAvoidMeleeDistance = 0;
        public bool UseAlchFlask = true;
        public bool UseAlterTime = true;
        public int UseAlterTimeAtPercentage = 80;
        public bool UseArcaneBrilliance = true;
        public bool UseArcaneExplosion = true;
        public bool UseArcaneTorrentForDecast = true;
        public int UseArcaneTorrentForDecastAtPercentage = 100;
        public bool UseArcaneTorrentForResource = true;
        public int UseArcaneTorrentForResourceAtPercentage = 80;
        public bool UseBerserking = true;
        public bool UseBlazingSpeed = true;
        public bool UseBlink = true;
        public bool UseBlizzard = true;
        public bool UseBloodFury = true;
        public bool UseColdSnapForDefence = true;
        public bool UseColdSnapForHeal = true;
        public int UseColdSnapForHealAtPercentage = 70;
        public bool UseCometStorm = true;
        public bool UseConeofCold = true;
        public int UseConeofColdAtPercentage = 45;
        public bool UseConjureRefreshment = true;
        public bool UseCounterspell = true;
        public int UseCounterspellAtPercentage = 100;
        public bool UseDeepFreeze = true;
        public int UseDeepFreezeAtPercentage = 50;
        public bool UseEvanesce = true;
        public int UseEvanesceAtPercentage = 50;
        public bool UseFireBlast = true;
        public bool UseFreeze = true;
        public bool UseFrostNova = true;
        public int UseFrostNovaAtPercentage = 50;
        public bool UseFrostbolt = true;
        public bool UseFrostBomb = true;
        public bool UseFrostfireBolt = true;
        public bool UseFrostjaw = true;
        public int UseFrostjawAtPercentage = 100;
        public bool UseFrozenOrb = true;
        public bool UseGiftoftheNaaru = true;
        public int UseGiftoftheNaaruAtPercentage = 80;
        public bool UseGreaterInvisibility = true;
        public int UseGreaterInvisibilityAtPercentage = 10;
        public bool UseIceBarrier = true;
        public int UseIceBarrierAtPercentage = 95;
        public bool UseIceBlock = true;
        public bool UseIceFloes = true;
        public bool UseIceLance = true;
        public bool UseIceNova = true;
        public bool UseIceWard = true;
        public int UseIceWardAtPercentage = 45;
        public bool UseIcyVeins = true;
        public bool UseInvisibility = true;
        public int UseInvisibilityAtPercentage = 10;
        public bool UseLowCombat = true;
        public int UseLowCombatAtPercentage = 15;
        public bool UseMirrorImage = true;
        public bool UsePrismaticCrystal = true;
        public bool UseRingofFrost = true;
        public bool UseRuneofPower = true;
        public bool UseStoneform = true;
        public int UseStoneformAtPercentage = 80;
        public bool UseSummonWaterElemental = true;
        public bool UseTimeWarp = true;
        public bool UseTrinketOne = true;
        public bool UseTrinketTwo = true;
        public bool UseWarStomp = true;
        public int UseWarStompAtPercentage = 80;
        public bool UseWaterJet = true;

        public MageFrostSettings()
        {
            ConfigWinForm("Mage Frost Settings");
            /* Professions & Racials */
            AddControlInWinForm("Use Arcane Torrent for Interrupt", "UseArcaneTorrentForDecast", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Arcane Torrent for Resource", "UseArcaneTorrentForResource", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Berserking", "UseBerserking", "Professions & Racials");
            AddControlInWinForm("Use Blood Fury", "UseBloodFury", "Professions & Racials");
            AddControlInWinForm("Use Gift of the Naaru", "UseGiftoftheNaaru", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Stoneform", "UseStoneform", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use War Stomp", "UseWarStomp", "Professions & Racials", "AtPercentage");
            /* Mage Buffs */
            AddControlInWinForm("Use Arcane Brilliance", "UseArcaneBrilliance", "Mage Buffs");
            AddControlInWinForm("Use Blazing Speed", "UseBlazingSpeed", "Mage Buffs");
            AddControlInWinForm("Use Ice Floes", "UseIceFloes", "Mage Buffs");
            AddControlInWinForm("Use Rune of Power", "UseRuneofPower", "Mage Buffs");
            /* Offensive Spell */
            AddControlInWinForm("Use Blizzard", "UseBlizzard", "Offensive Spell");
            AddControlInWinForm("Use Comet Storm", "UseCometStorm", "Offensive Spell");
            AddControlInWinForm("Use Fire Blast", "UseFireBlast", "Offensive Spell");
            AddControlInWinForm("Use Frost Bomb", "UseFrostBomb", "Offensive Spell");
            AddControlInWinForm("Use Frostbolt", "UseFrostbolt", "Offensive Spell");
            AddControlInWinForm("Use Frostfire Bolt", "UseFrostfireBolt", "Offensive Spell");
            AddControlInWinForm("Use Ice Lance", "UseIceLance", "Offensive Spell");
            AddControlInWinForm("Use Ice Nova", "UseIceNova", "Offensive Spell");
            AddControlInWinForm("Use Pet Freeze Ability", "UseFreeze", "Offensive Spell");
            AddControlInWinForm("Use Pet Water Jet Ability", "UseWaterJet", "Offensive Spell");
            AddControlInWinForm("Use Summon Water Elemental", "UseSummonWaterElemental", "Offensive Spell");
            /* Offensive Cooldown */
            AddControlInWinForm("Use Frozen Orb", "UseFrozenOrb", "Offensive Cooldown");
            AddControlInWinForm("Use Icy Veins", "UseIcyVeins", "Offensive Cooldown");
            AddControlInWinForm("Use Mirror Image", "UseMirrorImage", "Offensive Cooldown");
            AddControlInWinForm("Use Frost Bomb", "UseFrostBomb", "Offensive Cooldown");
            AddControlInWinForm("Use Prismatic Crystal", "UsePrismaticCrystal", "Offensive Cooldown");
            AddControlInWinForm("Use Time Warp", "UseTimeWarp", "Offensive Cooldown");
            /* Defensive Cooldown */
            AddControlInWinForm("Use Alter Time", "UseAlterTime", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Blink", "UseBlink", "Defensive Cooldown");
            AddControlInWinForm("Use Cold Snap For Defence", "UseColdSnapForDefence", "Defensive Cooldown");
            AddControlInWinForm("Use Cone of Cold", "UseConeofCold", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Counterspell", "UseCounterspell", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Deep Freeze", "UseDeepFreeze", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Evanesce", "UseEvanesce", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Frostjaw", "UseFrostjaw", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Frost Nova", "UseFrostNova", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use GreaterInvisibility", "UseGreaterInvisibility", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Ice Barrier", "UseIceBarrier", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Ice Block", "UseIceBlock", "Defensive Cooldown");
            AddControlInWinForm("Use Ice Ward", "UseIceWard", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Invisibility", "UseInvisibility", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Ring of Frost", "UseRingofFrost", "Defensive Cooldown");
            /* Healing Spell */
            AddControlInWinForm("Use Cold Snap For Heal", "UseColdSnapForHeal", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Conjure Refreshment", "UseConjureRefreshment", "Healing Spell");
            /* Game Settings */
            AddControlInWinForm("Use Low Combat Settings", "UseLowCombat", "Game Settings");
            AddControlInWinForm("Use Trinket One", "UseTrinketOne", "Game Settings");
            AddControlInWinForm("Use Trinket Two", "UseTrinketTwo", "Game Settings");
            AddControlInWinForm("Use Alchemist Flask", "UseAlchFlask", "Game Settings");
            AddControlInWinForm("Do avoid melee (Off Advised!!)", "DoAvoidMelee", "Game Settings");
            AddControlInWinForm("Avoid melee distance (1 to 4)", "DoAvoidMeleeDistance", "Game Settings");
        }

        public static MageFrostSettings CurrentSetting { get; set; }

        public static MageFrostSettings GetSettings()
        {
            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Mage_Frost.xml";
            if (File.Exists(currentSettingsFile))
            {
                return
                    CurrentSetting = Load<MageFrostSettings>(currentSettingsFile);
            }
            return new MageFrostSettings();
        }
    }

    #endregion
}

public class MageFire
{
    private static MageFireSettings MySettings = MageFireSettings.GetSettings();

    #region General Timers & Variables

    private readonly WoWItem _firstTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET);
    private readonly WoWItem _secondTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET, 2);
    public int DecastHP = 0;
    public int DefenseHP = 0;
    public int HealHP = 0;
    public int HealMP = 0;
    public int LC = 0;

    private Timer _onCd = new Timer(0);

    #endregion

    #region Professions & Racials

    public readonly Spell ArcaneTorrent = new Spell("Arcane Torrent");
    public readonly Spell Berserking = new Spell("Berserking");
    public readonly Spell BloodFury = new Spell("Blood Fury");
    public readonly Spell GiftoftheNaaru = new Spell("Gift of the Naaru");
    public readonly Spell Stoneform = new Spell("Stoneform");
    public readonly Spell WarStomp = new Spell("War Stomp");

    #endregion

    #region Mage Buffs

    public readonly Spell ArcaneBrilliance = new Spell("Arcane Brilliance");
    public readonly Spell BlazingSpeed = new Spell("Blazing Speed");
    public readonly Spell Cauterize = new Spell(87024);
    public readonly Spell DalaranBrilliance = new Spell("Dalaran Brilliance");
    public readonly Spell HeatingUp = new Spell(48107);
    public readonly Spell Hypothermia = new Spell(41425);
    public readonly Spell IceFloes = new Spell("Ice Floes");
    public readonly Spell Ignite = new Spell(12654);
    public readonly Spell PyroblastBuff = new Spell(48108);
    public readonly Spell RuneofPower = new Spell("Rune of Power");
    public readonly Spell RuneofPowerBuff = new Spell(116014);

    #endregion

    #region Offensive Spell

    public readonly Spell DragonsBreath = new Spell("Dragon's Breath");
    public readonly Spell Fireball = new Spell("Fireball");
    public readonly Spell Flamestrike = new Spell("Flamestrike");
    public readonly Spell InfernoBlast = new Spell("Inferno Blast");
    public readonly Spell Pyroblast = new Spell("Pyroblast");
    public readonly Spell Scorch = new Spell("Scorch");

    #endregion

    #region Offensive Cooldown

    public readonly Spell BlastWave = new Spell("Blast Wave");
    public readonly Spell Combustion = new Spell("Combustion");
    public readonly Spell LivingBomb = new Spell("Living Bomb");
    public readonly Spell Meteor = new Spell("Meteor");
    public readonly Spell MirrorImage = new Spell("Mirror Image");
    public readonly Spell PrismaticCrystal = new Spell("Prismatic Crystal");
    public readonly Spell TimeWarp = new Spell("Time Warp");

    #endregion

    #region Defensive Cooldown

    public readonly Spell AlterTime = new Spell("Alter Time");
    public readonly Spell Blink = new Spell("Blink");
    public readonly Spell ConeofCold = new Spell("Cone of Cold");
    public readonly Spell Counterspell = new Spell("Counterspell");
    public readonly Spell Evanesce = new Spell("Evanesce");
    public readonly Spell Frostjaw = new Spell("Frostjaw");
    public readonly Spell FrostNova = new Spell("Frost Nova");
    public readonly Spell GreaterInvisibility = new Spell("Greater Invisibility");
    public readonly Spell IceBarrier = new Spell("Ice Barrier");
    public readonly Spell IceBlock = new Spell("Ice Block");
    public readonly Spell IceWard = new Spell("Ice Ward");
    public readonly Spell Invisibility = new Spell("Invisibility");
    public readonly Spell RingofFrost = new Spell("Ring of Frost");

    #endregion

    #region Healing Spell

    public readonly Spell ColdSnap = new Spell("Cold Snap");
    public readonly Spell ConjureRefreshment = new Spell("Conjure Refreshment");
    private Timer _conjureRefreshmentTimer = new Timer(0);

    #endregion

    public MageFire()
    {
        Main.InternalRange = 39f;
        Main.InternalAggroRange = 39f;
        MySettings = MageFireSettings.GetSettings();
        Main.DumpCurrentSettings<MageFireSettings>(MySettings);
        UInt128 lastTarget = 0;
        LowHP();

        while (Main.InternalLoop)
        {
            try
            {
                if (!ObjectManager.Me.IsDeadMe)
                {
                    if (!ObjectManager.Me.IsMounted)
                    {
                        if (Fight.InFight && ObjectManager.Me.Target > 0)
                        {
                            if (ObjectManager.Me.Target != lastTarget
                                && (Scorch.IsHostileDistanceGood || Fireball.IsHostileDistanceGood))
                            {
                                Pull();
                                lastTarget = ObjectManager.Me.Target;
                            }

                            if (MySettings.UseLowCombat && (ObjectManager.Me.Level - ObjectManager.Target.Level >= MySettings.UseLowCombatAtPercentage))
                            {
                                LC = 1;
                                if (CombatClass.InSpellRange(ObjectManager.Target, 0, Main.InternalRange))
                                    LowCombat();
                            }
                            else
                            {
                                LC = 0;
                                if (CombatClass.InSpellRange(ObjectManager.Target, 0, Main.InternalRange))
                                    Combat();
                            }
                        }
                        else
                        {
                            if (!ObjectManager.Me.IsCast)
                                Patrolling();
                        }
                    }
                }
                else
                    Thread.Sleep(500);
            }
            catch
            {
            }
            Thread.Sleep(100);
        }
    }

    private void LowHP()
    {
        if (MySettings.UseAlterTimeAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseAlterTimeAtPercentage;

        if (MySettings.UseConeofColdAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseConeofColdAtPercentage;

        if (MySettings.UseFrostNovaAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseFrostNovaAtPercentage;

        if (MySettings.UseEvanesceAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseEvanesceAtPercentage;

        if (MySettings.UseGreaterInvisibilityAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseGreaterInvisibilityAtPercentage;

        if (MySettings.UseIceBarrierAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseIceBarrierAtPercentage;

        if (MySettings.UseIceWardAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseIceWardAtPercentage;

        if (MySettings.UseInvisibilityAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseInvisibilityAtPercentage;

        if (MySettings.UseStoneformAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseStoneformAtPercentage;

        if (MySettings.UseWarStompAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseWarStompAtPercentage;

        if (MySettings.UseArcaneTorrentForDecastAtPercentage > DecastHP)
            DecastHP = MySettings.UseArcaneTorrentForDecastAtPercentage;

        if (MySettings.UseCounterspellAtPercentage > DecastHP)
            DecastHP = MySettings.UseCounterspellAtPercentage;

        if (MySettings.UseFrostjawAtPercentage > DecastHP)
            DecastHP = MySettings.UseFrostjawAtPercentage;

        if (MySettings.UseArcaneTorrentForResourceAtPercentage > HealMP)
            HealMP = MySettings.UseArcaneTorrentForResourceAtPercentage;

        if (MySettings.UseColdSnapForHealAtPercentage > HealHP)
            HealHP = MySettings.UseColdSnapForHealAtPercentage;

        if (MySettings.UseGiftoftheNaaruAtPercentage > HealHP)
            HealHP = MySettings.UseGiftoftheNaaruAtPercentage;
    }

    private void Pull()
    {
        if (MySettings.UseRuneofPower && !RuneofPowerBuff.HaveBuff && RuneofPower.IsSpellUsable && Fireball.IsHostileDistanceGood)
            SpellManager.CastSpellByIDAndPosition(RuneofPower.Id, ObjectManager.Me.Position);

        if (MySettings.UseIceFloes && IceFloes.IsSpellUsable && ObjectManager.Me.GetMove)
            IceFloes.Cast();

        if (MySettings.UsePyroblast && PyroblastBuff.HaveBuff && Pyroblast.IsSpellUsable && Pyroblast.IsHostileDistanceGood)
        {
            Pyroblast.Cast();
            return;
        }
        if (MySettings.UseScorch && ObjectManager.Me.GetMove && Scorch.IsSpellUsable && Scorch.IsHostileDistanceGood)
        {
            Scorch.Cast();
            return;
        }
        if (MySettings.UseFireball && Fireball.IsSpellUsable && Fireball.IsHostileDistanceGood)
            Fireball.Cast();
    }

    private void LowCombat()
    {
        Buff();

        if (MySettings.DoAvoidMelee)
            AvoidMelee();

        if (_onCd.IsReady && ObjectManager.Me.HealthPercent <= DefenseHP)
            DefenseCycle();

        if (ObjectManager.Me.HealthPercent <= HealHP)
            Heal();

        if (MySettings.UsePyroblast && PyroblastBuff.HaveBuff && Pyroblast.IsSpellUsable && Pyroblast.IsHostileDistanceGood)
        {
            Pyroblast.Cast();
            return;
        }
        if (MySettings.UseInfernoBlast && InfernoBlast.IsSpellUsable && InfernoBlast.IsHostileDistanceGood)
        {
            InfernoBlast.Cast();
            return;
        }
        if (MySettings.UseFireball && Fireball.IsSpellUsable && Fireball.IsHostileDistanceGood)
        {
            Fireball.Cast();
            return;
        }
        if (MySettings.UseFlamestrike && Flamestrike.IsSpellUsable && Flamestrike.IsHostileDistanceGood)
            SpellManager.CastSpellByIDAndPosition(2120, ObjectManager.Target.Position);
    }

    private void Combat()
    {
        Buff();

        if (MySettings.DoAvoidMelee)
            AvoidMelee();

        DPSCycle();

        if (_onCd.IsReady && (ObjectManager.Me.HealthPercent <= DefenseHP || ObjectManager.GetNumberAttackPlayer() > 2))
            DefenseCycle();

        if (ObjectManager.Me.HealthPercent <= HealHP || ObjectManager.Me.ManaPercentage <= HealMP)
            Heal();

        if (ObjectManager.Me.HealthPercent <= DecastHP)
            Decast();

        DPSBurst();
        DPSCycle();
    }

    private void Buff()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (MySettings.UseIceBlock && !Evanesce.KnownSpell && Cauterize.HaveBuff && !Hypothermia.HaveBuff)
        {
            if (MySettings.UseColdSnapForDefence && !IceBlock.IsSpellUsable && ColdSnap.IsSpellUsable)
            {
                ColdSnap.Cast();
                Others.SafeSleep(1000);
            }
            if (IceBlock.IsSpellUsable)
            {
                IceBlock.Cast();
                _onCd = new Timer(1000*10);
                return;
            }
        }
        if (MySettings.UseArcaneBrilliance && !ArcaneBrilliance.HaveBuff && !DalaranBrilliance.HaveBuff && ArcaneBrilliance.IsSpellUsable)
            ArcaneBrilliance.Cast();

        if (MySettings.UseBlazingSpeed && ObjectManager.Me.GetMove && BlazingSpeed.IsSpellUsable)
            BlazingSpeed.Cast();

        if (MySettings.UseAlchFlask && !ObjectManager.Me.HaveBuff(79638) && !ObjectManager.Me.HaveBuff(79640) && !ObjectManager.Me.HaveBuff(79639)
            && !ItemsManager.IsItemOnCooldown(75525) && ItemsManager.GetItemCount(75525) > 0)
            ItemsManager.UseItem(75525);

        if (MySettings.UseConjureRefreshment && _conjureRefreshmentTimer.IsReady
            && ItemsManager.GetItemCount(113509) == 0 // 100
            && ItemsManager.GetItemCount(80610) == 0 // 90
            && ItemsManager.GetItemCount(65499) == 0 // 85-89
            && ItemsManager.GetItemCount(43523) == 0 // 84-80
            && ItemsManager.GetItemCount(43518) == 0 // 79-74
            && ItemsManager.GetItemCount(65517) == 0 // 73-64
            && ItemsManager.GetItemCount(65516) == 0 // 63-54
            && ItemsManager.GetItemCount(65515) == 0 // 53-44
            && ItemsManager.GetItemCount(65500) == 0 // 43-38
            && ConjureRefreshment.IsSpellUsable)
        {
            ConjureRefreshment.Cast();
            _conjureRefreshmentTimer = new Timer(1000*60*10);
        }
    }

    private void AvoidMelee()
    {
        if (ObjectManager.Target.GetDistance < MySettings.DoAvoidMeleeDistance && ObjectManager.Target.InCombat)
        {
            Logging.WriteFight("Too Close. Moving Back");
            var maxTimeTimer = new Timer(1000*2);
            MovementsAction.MoveBackward(true);
            while (ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat && !maxTimeTimer.IsReady)
                Others.SafeSleep(300);
            MovementsAction.MoveBackward(false);
            if (maxTimeTimer.IsReady && ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat)
            {
                MovementsAction.MoveForward(true);
                Others.SafeSleep(1000);
                MovementsAction.MoveForward(false);
                MovementManager.Face(ObjectManager.Target.Position);
            }
        }
    }

    private void DefenseCycle()
    {
        if (MySettings.UseAlterTime && !AlterTime.HaveBuff && ObjectManager.Me.HealthPercent <= MySettings.UseAlterTimeAtPercentage && AlterTime.IsSpellUsable)
        {
            AlterTime.Cast();
            return;
        }
        if (MySettings.UseBlink && (FrostNova.TargetHaveBuff || ConeofCold.TargetHaveBuff || Frostjaw.TargetHaveBuff) && Blink.IsSpellUsable 
            && ObjectManager.Target.GetDistance < 5)
        {
            Blink.Cast();
            return;
        }
        if (MySettings.UseConeofCold && ObjectManager.Me.HealthPercent <= MySettings.UseConeofColdAtPercentage && ConeofCold.IsSpellUsable && ConeofCold.IsHostileDistanceGood)
        {
            ConeofCold.Cast();
            return;
        }
        if (MySettings.UseEvanesce && ObjectManager.Me.HealthPercent <= MySettings.UseEvanesceAtPercentage)
        {
            if (MySettings.UseColdSnapForDefence && !Evanesce.IsSpellUsable && ColdSnap.IsSpellUsable)
            {
                ColdSnap.Cast();
                Others.SafeSleep(1000);
            }
            if (Evanesce.IsSpellUsable)
            {
                Evanesce.Cast();
                _onCd = new Timer(1000*3);
            }
            return;
        }
        if (MySettings.UseFrostjaw && ObjectManager.Me.HealthPercent <= MySettings.UseFrostjawAtPercentage && Frostjaw.IsSpellUsable && ObjectManager.Target.GetDistance < 10)
        {
            Frostjaw.Cast();
            return;
        }
        if (MySettings.UseFrostNova && ObjectManager.Me.HealthPercent <= MySettings.UseFrostNovaAtPercentage && ObjectManager.GetUnitInSpellRange(RingofFrost.MaxRangeHostile) > 0)
        {
            if (MySettings.UseColdSnapForDefence && !FrostNova.IsSpellUsable && ColdSnap.IsSpellUsable)
            {
                ColdSnap.Cast();
                Others.SafeSleep(1000);
            }
            if (FrostNova.IsSpellUsable)
            {
                FrostNova.Cast();
                _onCd = new Timer(1000*8);
            }
            return;
        }
        if (MySettings.UseIceBarrier && !IceBarrier.HaveBuff && ObjectManager.Me.HealthPercent <= MySettings.UseIceBarrierAtPercentage && IceBarrier.IsSpellUsable)
        {
            IceBarrier.Cast();
            return;
        }
        if (MySettings.UseIceWard && ObjectManager.Me.HealthPercent <= MySettings.UseIceWardAtPercentage && IceWard.IsSpellUsable && ObjectManager.Target.GetDistance < 10)
        {
            IceWard.Cast();
            _onCd = new Timer(1000*5);
            return;
        }
        if (MySettings.UseInvisibility && ObjectManager.Me.HealthPercent <= MySettings.UseInvisibilityAtPercentage && Invisibility.IsSpellUsable)
        {
            Invisibility.Cast();
            Others.SafeSleep(8000);
            return;
        }
        if (MySettings.UseGreaterInvisibility && ObjectManager.Me.HealthPercent <= MySettings.UseGreaterInvisibilityAtPercentage && Invisibility.IsSpellUsable)
        {
            GreaterInvisibility.Cast();
            Others.SafeSleep(8000);
            return;
        }
        if (MySettings.UseRingofFrost && RingofFrost.IsSpellUsable && ObjectManager.GetUnitInSpellRange(RingofFrost.MaxRangeHostile) > 2)
        {
            SpellManager.CastSpellByIDAndPosition(113724, ObjectManager.Target.Position);
            _onCd = new Timer(1000*10);
            return;
        }
        if (MySettings.UseStoneform && ObjectManager.Me.HealthPercent <= MySettings.UseStoneformAtPercentage && Stoneform.IsSpellUsable)
        {
            Stoneform.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (MySettings.UseWarStomp && ObjectManager.Me.HealthPercent <= MySettings.UseWarStompAtPercentage && WarStomp.IsSpellUsable 
            && ObjectManager.GetUnitInSpellRange(WarStomp.MaxRangeHostile) > 0)
        {
            WarStomp.Cast();
            _onCd = new Timer(1000*2);
        }
    }

    private void Heal()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (MySettings.UseArcaneTorrentForResource && ObjectManager.Me.ManaPercentage <= MySettings.UseArcaneTorrentForResourceAtPercentage && ArcaneTorrent.IsSpellUsable)
        {
            ArcaneTorrent.Cast();
            return;
        }
        if (MySettings.UseGiftoftheNaaru && ObjectManager.Me.HealthPercent <= MySettings.UseGiftoftheNaaruAtPercentage && GiftoftheNaaru.IsSpellUsable)
        {
            GiftoftheNaaru.Cast();
            return;
        }
        if (MySettings.UseColdSnapForHeal && ObjectManager.Me.HealthPercent <= MySettings.UseColdSnapForHealAtPercentage && ColdSnap.IsSpellUsable)
        {
            ColdSnap.Cast();
            return;
        }
    }

    private void Decast()
    {
        if (MySettings.UseArcaneTorrentForDecast && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe && ObjectManager.Me.HealthPercent <= MySettings.UseArcaneTorrentForDecastAtPercentage
            && ArcaneTorrent.IsSpellUsable && ObjectManager.Target.GetDistance < 8)
        {
            ArcaneTorrent.Cast();
            return;
        }
        if (MySettings.UseCounterspell && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe && ObjectManager.Me.HealthPercent <= MySettings.UseCounterspellAtPercentage
            && Counterspell.IsSpellUsable && Counterspell.IsHostileDistanceGood)
        {
            Counterspell.Cast();
            return;
        }
        if (MySettings.UseFrostjaw && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe && ObjectManager.Me.HealthPercent <= MySettings.UseFrostjawAtPercentage
            && Frostjaw.IsSpellUsable && Frostjaw.IsHostileDistanceGood)
            Frostjaw.Cast();
    }

    private void DPSBurst()
    {
        if (MySettings.UseTrinketOne && !ItemsManager.IsItemOnCooldown(_firstTrinket.Entry) && ItemsManager.IsItemUsable(_firstTrinket.Entry))
        {
            ItemsManager.UseItem(_firstTrinket.Name);
            Logging.WriteFight("Use First Trinket Slot");
        }
        if (MySettings.UseTrinketTwo && !ItemsManager.IsItemOnCooldown(_secondTrinket.Entry) && ItemsManager.IsItemUsable(_secondTrinket.Entry))
        {
            ItemsManager.UseItem(_secondTrinket.Name);
            Logging.WriteFight("Use Second Trinket Slot");
        }
        if (MySettings.UseBerserking && Berserking.IsSpellUsable && Fireball.IsHostileDistanceGood)
        {
            if (ObjectManager.Me.IsCast)
                ObjectManager.Me.StopCast();

            Others.SafeSleep(500);
            Berserking.Cast();
        }
        if (MySettings.UseBloodFury && BloodFury.IsSpellUsable && Fireball.IsHostileDistanceGood)
        {
            if (ObjectManager.Me.IsCast)
                ObjectManager.Me.StopCast();

            Others.SafeSleep(500);
            BloodFury.Cast();
        }
        if (MySettings.UseMirrorImage && MirrorImage.IsSpellUsable && Fireball.IsHostileDistanceGood)
        {
            if (ObjectManager.Me.IsCast)
                ObjectManager.Me.StopCast();

            Others.SafeSleep(1000);
            MirrorImage.Cast();
        }
        if (MySettings.UseRuneofPower && !RuneofPowerBuff.HaveBuff && !ObjectManager.Me.GetMove && RuneofPower.IsSpellUsable && Fireball.IsHostileDistanceGood)
        {
            if (ObjectManager.Me.IsCast)
                ObjectManager.Me.StopCast();

            Others.SafeSleep(500);
            SpellManager.CastSpellByIDAndPosition(116011, ObjectManager.Me.Position);
        }
        if (MySettings.UsePrismaticCrystal && PrismaticCrystal.IsSpellUsable && PrismaticCrystal.IsHostileDistanceGood)
        {
            if (ObjectManager.Me.IsCast)
                ObjectManager.Me.StopCast();

            Others.SafeSleep(500);
            SpellManager.CastSpellByIDAndPosition(152087, ObjectManager.Target.Position);
            Lua.RunMacroText("/target Prismatic Crystal");
        }
        if (MySettings.UseTimeWarp && !ObjectManager.Me.HaveBuff(80354) && !ObjectManager.Me.HaveBuff(57724) && !ObjectManager.Me.HaveBuff(57723) && !ObjectManager.Me.HaveBuff(95809)
            && TimeWarp.IsSpellUsable && Fireball.IsHostileDistanceGood)
        {
            if (ObjectManager.Me.IsCast)
                ObjectManager.Me.StopCast();

            Others.SafeSleep(500);
            TimeWarp.Cast();
        }
        if (MySettings.UseMeteor && Meteor.IsSpellUsable && Meteor.IsHostileDistanceGood)
        {
            if (ObjectManager.Me.IsCast)
                ObjectManager.Me.StopCast();

            Others.SafeSleep(1000);
            Meteor.Cast();
        }
        if (MySettings.UseCombustion && Ignite.TargetHaveBuff && Combustion.IsSpellUsable && Combustion.IsHostileDistanceGood)
        {
            if (ObjectManager.Me.IsCast)
                ObjectManager.Me.StopCast();

            Others.SafeSleep(1000);
            Combustion.Cast();
        }
    }

    private void DPSCycle()
    {
        Usefuls.SleepGlobalCooldown();
        try
        {
            Memory.WowMemory.GameFrameLock(); // !!! WARNING - DONT SLEEP WHILE LOCKED - DO FINALLY(GameFrameUnLock()) !!!

            if (MySettings.UseIceFloes && !IceFloes.HaveBuff && ObjectManager.Me.GetMove && IceFloes.IsSpellUsable && Fireball.IsHostileDistanceGood)
                IceFloes.Cast();

            if (MySettings.UseFlamestrike && Flamestrike.IsSpellUsable && ObjectManager.GetUnitInSpellRange(Flamestrike.MaxRangeHostile) > 4)
            {
                SpellManager.CastSpellByIDAndPosition(2120, ObjectManager.Target.Position);
                return;
            }
            if (MySettings.UsePyroblast && ((PyroblastBuff.HaveBuff && HeatingUp.HaveBuff) || ObjectManager.Me.UnitAura(48108).AuraTimeLeftInMs < 4000)
                && Pyroblast.IsSpellUsable && Pyroblast.IsHostileDistanceGood)
            {
                Pyroblast.Cast();
                return;
            }
            if (MySettings.UseLivingBomb && !LivingBomb.TargetHaveBuff && LivingBomb.IsSpellUsable && LivingBomb.IsHostileDistanceGood)
            {
                LivingBomb.Cast();
                return;
            }
            if (MySettings.UseInfernoBlast && HeatingUp.HaveBuff && !PyroblastBuff.HaveBuff && InfernoBlast.IsSpellUsable && InfernoBlast.IsHostileDistanceGood)
            {
                if (ObjectManager.Me.IsCast)
                    ObjectManager.Me.StopCast();

                Others.SafeSleep(1000);
                InfernoBlast.Cast();
                return;
            }
            if (MySettings.UseBlastWave && BlastWave.GetSpellCharges > 0 && BlastWave.IsSpellUsable && BlastWave.IsHostileDistanceGood)
            {
                BlastWave.Cast();
                return;
            }
            if (MySettings.UseDragonsBreath && DragonsBreath.IsSpellUsable && ObjectManager.Target.GetDistance < 12)
            {
                DragonsBreath.Cast();
                return;
            }
            if (MySettings.UseScorch && ObjectManager.Me.GetMove && !IceFloes.HaveBuff && Scorch.IsSpellUsable && Scorch.IsHostileDistanceGood)
            {
                Scorch.Cast();
                return;
            }
            if (MySettings.UseFireball && !Ignite.HaveBuff && Fireball.IsSpellUsable && Fireball.IsHostileDistanceGood)
            {
                Fireball.Launch(true, false, true);
                Others.SafeSleep(500);
                while (!Ignite.HaveBuff && ObjectManager.Me.IsCast)
                    Others.SafeSleep(20);

                if (ObjectManager.Me.IsCast)
                    ObjectManager.Me.StopCast();
                return;
            }
        }
        finally
        {
            Memory.WowMemory.GameFrameUnLock();
        }
    }

    private void Patrolling()
    {
        if (ObjectManager.Me.IsMounted) return;
        Buff();
        Heal();
    }

    #region Nested type: MageFireSettings

    [Serializable]
    public class MageFireSettings : Settings
    {
        public bool DoAvoidMelee = false;
        public int DoAvoidMeleeDistance = 0;
        public bool UseAlchFlask = true;
        public bool UseAlterTime = true;
        public int UseAlterTimeAtPercentage = 80;
        public bool UseArcaneBrilliance = true;
        public bool UseArcaneTorrentForDecast = true;
        public int UseArcaneTorrentForDecastAtPercentage = 100;
        public bool UseArcaneTorrentForResource = true;
        public int UseArcaneTorrentForResourceAtPercentage = 80;
        public bool UseBerserking = true;
        public bool UseBlastWave = true;
        public bool UseBlazingSpeed = true;
        public bool UseBlink = true;
        public bool UseBloodFury = true;
        public bool UseColdSnapForDefence = true;
        public bool UseColdSnapForHeal = true;
        public int UseColdSnapForHealAtPercentage = 70;
        public bool UseCombustion = true;
        public bool UseConeofCold = true;
        public int UseConeofColdAtPercentage = 45;
        public bool UseConjureRefreshment = true;
        public bool UseCounterspell = true;
        public int UseCounterspellAtPercentage = 100;
        public bool UseDragonsBreath = true;
        public bool UseEvanesce = true;
        public int UseEvanesceAtPercentage = 50;
        public bool UseFireball = true;
        public bool UseFlamestrike = true;
        public bool UseFrostNova = true;
        public int UseFrostNovaAtPercentage = 50;
        public bool UseFrostjaw = true;
        public int UseFrostjawAtPercentage = 40;
        public bool UseFrozenOrb = true;
        public bool UseGiftoftheNaaru = true;
        public int UseGiftoftheNaaruAtPercentage = 80;
        public bool UseGreaterInvisibility = true;
        public int UseGreaterInvisibilityAtPercentage = 10;
        public bool UseIceBarrier = true;
        public int UseIceBarrierAtPercentage = 95;
        public bool UseIceBlock = true;
        public bool UseIceFloes = false;
        public bool UseIceWard = true;
        public int UseIceWardAtPercentage = 45;
        public bool UseInfernoBlast = true;
        public bool UseInvisibility = true;
        public int UseInvisibilityAtPercentage = 10;
        public bool UseLivingBomb = true;
        public bool UseLowCombat = true;
        public int UseLowCombatAtPercentage = 15;
        public bool UseMeteor = true;
        public bool UseMirrorImage = true;
        public bool UsePrismaticCrystal = true;
        public bool UsePyroblast = true;
        public bool UseRingofFrost = true;
        public bool UseRuneofPower = true;
        public bool UseScorch = true;
        public bool UseStoneform = true;
        public int UseStoneformAtPercentage = 80;
        public bool UseTimeWarp = true;
        public bool UseTrinketOne = true;
        public bool UseTrinketTwo = true;
        public bool UseWarStomp = true;
        public int UseWarStompAtPercentage = 80;

        public MageFireSettings()
        {
            ConfigWinForm("Mage Fire Settings");
            /* Professions & Racials */
            AddControlInWinForm("Use Arcane Torrent for Interrupt", "UseArcaneTorrentForDecast", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Arcane Torrent for Resource", "UseArcaneTorrentForResource", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Berserking", "UseBerserking", "Professions & Racials");
            AddControlInWinForm("Use Blood Fury", "UseBloodFury", "Professions & Racials");
            AddControlInWinForm("Use Gift of the Naaru", "UseGiftoftheNaaru", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Stoneform", "UseStoneform", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use War Stomp", "UseWarStomp", "Professions & Racials", "AtPercentage");
            /* Mage Buffs */
            AddControlInWinForm("Use Arcane Brilliance", "UseArcaneBrilliance", "Mage Buffs");
            AddControlInWinForm("Use Blazing Speed", "UseBlazingSpeed", "Mage Buffs");
            AddControlInWinForm("Use Ice Floes", "UseIceFloes", "Mage Buffs");
            AddControlInWinForm("Use Rune of Power", "UseRuneofPower", "Mage Buffs");
            /* Offensive Spell */
            AddControlInWinForm("Use Dragon's Breath", "UseDragonsBreath", "Offensive Spell");
            AddControlInWinForm("Use Fireball", "UseFireball", "Offensive Spell");
            AddControlInWinForm("Use Flamestrike", "UseFlamestrike", "Offensive Spell");
            AddControlInWinForm("Use Inferno Blast", "UseInfernoBlast", "Offensive Spell");
            AddControlInWinForm("Use Pyroblast", "UsePyroblast", "Offensive Spell");
            AddControlInWinForm("Use Scorch", "UseScorch", "Offensive Spell");
            /* Offensive Cooldown */
            AddControlInWinForm("Use Blast Wave", "UseBlastWave", "Offensive Cooldown");
            AddControlInWinForm("Use Combustion", "UseCombustion", "Offensive Cooldown");
            AddControlInWinForm("Use Living Bomb", "UseLivingBomb", "Offensive Cooldown");
            AddControlInWinForm("Use Meteor", "UseMeteor", "Offensive Cooldown");
            AddControlInWinForm("Use Mirror Image", "UseMirrorImage", "Offensive Cooldown");
            AddControlInWinForm("Use Prismatic Crystal", "UsePrismaticCrystal", "Offensive Cooldown");
            AddControlInWinForm("Use Time Warp", "UseTimeWarp", "Offensive Cooldown");
            /* Defensive Cooldown */
            AddControlInWinForm("Use Alter Time", "UseAlterTime", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Blink", "UseBlink", "Defensive Cooldown");
            AddControlInWinForm("Use Cold Snap", "UseColdSnap", "Defensive Cooldown");
            AddControlInWinForm("Use Cone of Cold", "UseConeofCold", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Counterspell", "UseCounterspell", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Evanesce", "UseEvanesce", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Frostjaw", "UseFrostjaw", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Frost Nova", "UseFrostNova", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Greater Invisibility", "UseGreaterInvisibility", "Defensive Cooldown");
            AddControlInWinForm("Use Ice Barrier", "UseIceBarrier", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Ice Block", "UseIceBlock", "Defensive Cooldown");
            AddControlInWinForm("Use Ice Ward", "UseIceWard", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Invisibility", "UseInvisibility", "Defensive Cooldown");
            AddControlInWinForm("Use Ring of Frost", "UseRingofFrost", "Defensive Cooldown");
            /* Healing Spell */
            AddControlInWinForm("Use Cold SnapForHeal", "UseColdSnap", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Conjure Refreshment", "UseConjureRefreshment", "Healing Spell");
            /* Game Settings */
            AddControlInWinForm("Use Low Combat Settings", "UseLowCombat", "Game Settings");
            AddControlInWinForm("Use Trinket One", "UseTrinketOne", "Game Settings");
            AddControlInWinForm("Use Trinket Two", "UseTrinketTwo", "Game Settings");
            AddControlInWinForm("Use Alchemist Flask", "UseAlchFlask", "Game Settings");
            AddControlInWinForm("Do avoid melee (Off Advised!!)", "DoAvoidMelee", "Game Settings");
            AddControlInWinForm("Avoid melee distance (1 to 4)", "DoAvoidMeleeDistance", "Game Settings");
        }

        public static MageFireSettings CurrentSetting { get; set; }

        public static MageFireSettings GetSettings()
        {
            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Mage_Fire.xml";
            if (File.Exists(currentSettingsFile))
            {
                return
                    CurrentSetting = Load<MageFireSettings>(currentSettingsFile);
            }
            return new MageFireSettings();
        }
    }

    #endregion
}

#endregion

#region Warlock

public class WarlockDemonology
{
    private static WarlockDemonologySettings MySettings = WarlockDemonologySettings.GetSettings();

    #region General Timers & Variables

    private readonly WoWItem _firstTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET);
    private readonly WoWItem _secondTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET, 2);
    public int DecastHP = 0;
    public int DefenseHP = 0;
    public int HealHP = 0;
    public int HealMP = 0;
    public int LC = 0;

    private Timer _onCd = new Timer(0);

    #endregion

    #region Professions & Racials

    public readonly Spell ArcaneTorrent = new Spell("Arcane Torrent");
    public readonly Spell Berserking = new Spell("Berserking");
    public readonly Spell BloodFury = new Spell("Blood Fury");
    public readonly Spell GiftoftheNaaru = new Spell("Gift of the Naaru");
    public readonly Spell Stoneform = new Spell("Stoneform");
    public readonly Spell WarStomp = new Spell("War Stomp");

    #endregion

    #region Warlock Buffs

    public readonly Spell CorruptionDebuff = new Spell(146739);
    public readonly Spell BurningRush = new Spell("Burning Rush");
    public readonly Spell DarkIntent = new Spell("Dark Intent");
    public readonly Spell KilJaedensCunning = new Spell("Kil'Jaeden's Cunning");
    public readonly Spell Metamorphosis = new Spell("Metamorphosis");
    public readonly Spell MoltenCore = new Spell("Molten Core");
    public readonly Spell Soulstone = new Spell("Soulstone");
    public readonly Spell UnendingBreath = new Spell("Unending Breath");

    #endregion

    #region Offensive Spell

    public readonly Spell Corruption = new Spell("Corruption");
    public readonly Spell ChaosWave = new Spell(124916);
    public readonly Spell CommandDemon = new Spell("Command Demon");
    public readonly Spell DemonicServitude = new Spell("Demonic Servitude");
    public readonly Spell Demonbolt = new Spell("Demonbolt");
    public readonly Spell Doom = new Spell(603);
    public readonly Spell HandofGuldan = new Spell("Hand of Gul'dan");
    public readonly Spell Hellfire = new Spell("Hellfire");
    public readonly Spell ImmolationAura = new Spell(104025);
    public readonly Spell ShadowBolt = new Spell("Shadow Bolt");
    public readonly Spell SoulFire = new Spell("Soul Fire");
    public readonly Spell SummonFelguard = new Spell("Summon Felguard");
    public readonly Spell SummonFelhunter = new Spell("Summon Felhunter");
    public readonly Spell SummonImp = new Spell("Summon Imp");
    public readonly Spell SummonSuccubus = new Spell("Summon Succubus");
    public readonly Spell SummonVoidwalker = new Spell("Summon Voidwalker");
    public readonly Spell TouchofChaos = new Spell(103964);

    #endregion

    #region Offensive Cooldown

    public readonly Spell Cataclysm = new Spell("Cataclysm");
    public readonly Spell DarkSoulKnowledge = new Spell("Dark Soul: Knowledge");
    public readonly Spell GrimoireofService = new Spell("Grimoire of Service");
    public readonly Spell MannarothsFury = new Spell("Mannaroth's Fury");
    public readonly Spell SummonDoomguard = new Spell("Summon Doomguard");
    public readonly Spell SummonInfernal = new Spell("Summon Infernal");

    #endregion

    #region Defensive Cooldown

    public readonly Spell BloodHorror = new Spell("Blood Horror");
    public readonly Spell DarkBargain = new Spell("Dark Bargain");
    public readonly Spell Fear = new Spell("Fear");
    public readonly Spell HowlofTerror = new Spell("HowlofTerror");
    public readonly Spell SacrificialPact = new Spell("Sacrificial Pact");
    public readonly Spell Shadowfury = new Spell("Shadowfury");
    public readonly Spell UnendingResolve = new Spell("Unending Resolve");
    private Timer _fearTimer = new Timer(0);

    #endregion

    #region Healing Spell

    public readonly Spell CreateHealthstone = new Spell("Create Healthstone");
    public readonly Spell DarkRegeneration = new Spell("Dark Regeneration");
    public readonly Spell DrainLife = new Spell("Drain Life");
    public readonly Spell HealthFunnel = new Spell("Health Funnel");
    public readonly Spell LifeTap = new Spell("Life Tap");
    public readonly Spell MortalCoil = new Spell("Mortal Coil");
    private Timer _healthstoneTimer = new Timer(0);

    #endregion

    public WarlockDemonology()
    {
        Main.InternalRange = 39f;
        Main.InternalAggroRange = 39f;
        MySettings = WarlockDemonologySettings.GetSettings();
        Main.DumpCurrentSettings<WarlockDemonologySettings>(MySettings);
        UInt128 lastTarget = 0;
        LowHP();

        while (Main.InternalLoop)
        {
            try
            {
                if (!ObjectManager.Me.IsDeadMe)
                {
                    if (!ObjectManager.Me.IsMounted)
                    {
                        if (Fight.InFight && ObjectManager.Me.Target > 0)
                        {
                            if (ObjectManager.Me.Target != lastTarget
                                && (SoulFire.IsHostileDistanceGood || ShadowBolt.IsHostileDistanceGood))
                            {
                                Pull();
                                lastTarget = ObjectManager.Me.Target;
                            }

                            if (MySettings.UseLowCombat && (ObjectManager.Me.Level - ObjectManager.Target.Level >= MySettings.UseLowCombatAtPercentage))
                            {
                                LC = 1;
                                if (CombatClass.InSpellRange(ObjectManager.Target, 0, Main.InternalRange))
                                    LowCombat();
                            }
                            else
                            {
                                LC = 0;
                                if (CombatClass.InSpellRange(ObjectManager.Target, 0, Main.InternalRange))
                                    Combat();
                            }
                        }
                        if (!ObjectManager.Me.IsCast)
                            Patrolling();
                    }
                }
                else
                    Thread.Sleep(500);
            }
            catch
            {
            }
            Thread.Sleep(100);
        }
    }

    private void LowHP()
    {
        if (MySettings.UseBloodHorrorAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseBloodHorrorAtPercentage;

        if (MySettings.UseDarkBargainAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseDarkBargainAtPercentage;

        if (MySettings.UseFearAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseFearAtPercentage;

        if (MySettings.UseHowlofTerrorAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseHowlofTerrorAtPercentage;

        if (MySettings.UseSacrificialPactAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseSacrificialPactAtPercentage;

        if (MySettings.UseShadowfuryAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseShadowfuryAtPercentage;

        if (MySettings.UseStoneformAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseStoneformAtPercentage;

        if (MySettings.UseUnendingResolveAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseUnendingResolveAtPercentage;

        if (MySettings.UseWarStompAtPercentage > DefenseHP)
            DefenseHP = MySettings.UseWarStompAtPercentage;

        if (MySettings.UseArcaneTorrentForDecastAtPercentage > DecastHP)
            DecastHP = MySettings.UseArcaneTorrentForDecastAtPercentage;

        if (MySettings.UseArcaneTorrentForResourceAtPercentage > HealMP)
            HealMP = MySettings.UseArcaneTorrentForResourceAtPercentage;

        if (MySettings.UseLifeTapAtPercentage > HealMP)
            HealMP = MySettings.UseLifeTapAtPercentage;

        if (MySettings.UseCreateHealthstoneAtPercentage > HealHP)
            HealHP = MySettings.UseCreateHealthstoneAtPercentage;

        if (MySettings.UseDarkRegenerationAtPercentage > HealHP)
            HealHP = MySettings.UseDarkRegenerationAtPercentage;

        if (MySettings.UseDrainLifeAtPercentage > HealHP)
            HealHP = MySettings.UseGiftoftheNaaruAtPercentage;

        if (MySettings.UseGiftoftheNaaruAtPercentage > HealHP)
            HealHP = MySettings.UseGiftoftheNaaruAtPercentage;

        if (MySettings.UseMortalCoilAtPercentage > HealHP)
            HealHP = MySettings.UseMortalCoilAtPercentage;
    }
    
    private void Pull()
    {
        if (ObjectManager.Pet.IsAlive)
        {
            Lua.RunMacroText("/petattack");
            Logging.WriteFight("Cast Pet Attack");
        }
        if (MySettings.UseSoulFire && SoulFire.IsSpellUsable && SoulFire.IsHostileDistanceGood)
        {
            SoulFire.Cast();
            return;
        }

        if (MySettings.UseShadowBolt && ShadowBolt.IsSpellUsable && ShadowBolt.IsHostileDistanceGood)
            ShadowBolt.Cast();
    }

    private void LowCombat()
    {
        Buff();

        if (MySettings.DoAvoidMelee)
            AvoidMelee();

        if (_onCd.IsReady && ObjectManager.Me.HealthPercent <= DefenseHP)
            DefenseCycle();

        if (ObjectManager.Me.HealthPercent <= HealHP)
            Heal();

        if (MySettings.UseHandofGuldan && !HandofGuldan.TargetHaveBuff && HandofGuldan.GetSpellCharges > 0 && HandofGuldan.IsSpellUsable && HandofGuldan.IsHostileDistanceGood)
        {
            HandofGuldan.Cast();
            return;
        }
        if (MySettings.UseCommandDemon && CommandDemon.IsSpellUsable && ShadowBolt.IsHostileDistanceGood)
        {
            CommandDemon.Cast();
            return;
        }
        if (MySettings.UseHellfire && Hellfire.IsSpellUsable && ObjectManager.Me.HealthPercent > MySettings.UseHellfireAbovePercentage 
            && ObjectManager.GetUnitInSpellRange(Hellfire.MaxRangeHostile) > 4)
        {
            Hellfire.Cast();
            Others.SafeSleep(200);
            while (ObjectManager.Me.IsCast && ObjectManager.GetUnitInSpellRange(Hellfire.MaxRangeHostile) > 4 && ObjectManager.Me.HealthPercent > MySettings.UseHellfireAbovePercentage)
                Others.SafeSleep(200);
            return;
        }
        if (MySettings.UseShadowBolt && ShadowBolt.IsSpellUsable && ShadowBolt.IsHostileDistanceGood)
        {
            ShadowBolt.Cast();
            return;
        }
    }

    private void Combat()
    {
        Buff();

        if (MySettings.DoAvoidMelee)
            AvoidMelee();

        DPSCycle();

        if (_onCd.IsReady && (ObjectManager.Me.HealthPercent <= DefenseHP || ObjectManager.GetNumberAttackPlayer() > 2))
            DefenseCycle();

        if (ObjectManager.Me.HealthPercent <= HealHP || ObjectManager.Me.ManaPercentage <= HealMP)
            Heal();

        if (ObjectManager.Me.HealthPercent <= DecastHP)
            Decast();

        DPSBurst();
        DPSCycle();
    }

    private void Buff()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        Pet();

        if (MySettings.UseBurningRush && !BurningRush.HaveBuff && ObjectManager.Me.GetMove && !ObjectManager.Me.InCombat && BurningRush.IsSpellUsable)
            BurningRush.Cast();

        if (MySettings.UseBurningRush && BurningRush.HaveBuff && (!ObjectManager.Me.GetMove || ObjectManager.Me.InCombat
            || ObjectManager.Me.HealthPercent < MySettings.UseBurningRushAbovePercentage) && BurningRush.IsSpellUsable)
            BurningRush.Cast();

        if (MySettings.UseCreateHealthstone && ItemsManager.GetItemCount(5512) == 0 && Usefuls.GetContainerNumFreeSlots > 0 && CreateHealthstone.IsSpellUsable)
        {
            Logging.WriteFight(" - Create Healthstone - ");
            CreateHealthstone.Cast();
            Others.SafeSleep(500);

            while (ObjectManager.Me.IsCast)
                Others.SafeSleep(200);
        }

        if (MySettings.UseDarkIntent && !DarkIntent.HaveBuff && DarkIntent.IsSpellUsable)
            DarkIntent.Cast();

        if (MySettings.UseSoulstone && !Soulstone.HaveBuff && Soulstone.IsSpellUsable)
        {
            Soulstone.Cast();
            Others.SafeSleep(500);

            while (ObjectManager.Me.IsCast)
                Others.SafeSleep(20);
        }

        if (MySettings.UseUnendingBreath && ObjectManager.Me.UnitAura(5697).AuraTimeLeftInMs < 1 && UnendingBreath.IsSpellUsable)
            UnendingBreath.Cast();

        if (MySettings.UseAlchFlask && !ObjectManager.Me.HaveBuff(79638) && !ObjectManager.Me.HaveBuff(79640) && !ObjectManager.Me.HaveBuff(79639)
            && !ItemsManager.IsItemOnCooldown(75525) && ItemsManager.GetItemCount(75525) > 0)
            ItemsManager.UseItem(75525);
    }

    private void Pet()
    {
        if (MySettings.UseHealthFunnel && ObjectManager.Pet.HealthPercent > 0 && HealthFunnel.IsSpellUsable 
            && ObjectManager.Pet.HealthPercent <= MySettings.UseHealthFunnelAtPercentage)
        {
            HealthFunnel.Launch(true, false, true);
            Others.SafeSleep(500);

            while (ObjectManager.Me.IsCast && (ObjectManager.Pet.HealthPercent > 81 || ObjectManager.Pet.IsDead))
                Others.SafeSleep(20);

            if (ObjectManager.Me.IsCast)
                ObjectManager.Me.StopCast();
            return;
        }

        if (MySettings.UseSummonDoomguard && DemonicServitude.KnownSpell && (ObjectManager.Pet.Health == 0 || ObjectManager.Pet.Guid == 0) && SummonDoomguard.IsSpellUsable)
        {
            Logging.WriteFight(" - PET DEAD - ");
            SummonDoomguard.Cast();
            Others.SafeSleep(500);

            while (ObjectManager.Me.IsCast)
                Others.SafeSleep(20);
        }

        else if (MySettings.UseSummonInfernal && DemonicServitude.KnownSpell && (ObjectManager.Pet.Health == 0 || ObjectManager.Pet.Guid == 0) && SummonInfernal.IsSpellUsable)
        {
            Logging.WriteFight(" - PET DEAD - ");
            SpellManager.CastSpellByIDAndPosition(1122, ObjectManager.Target.Position);
            Others.SafeSleep(500);

            while (ObjectManager.Me.IsCast)
                Others.SafeSleep(20);
        }
        else if (MySettings.UseSummonFelguard && (ObjectManager.Pet.Health == 0 || ObjectManager.Pet.Guid == 0) && SummonFelguard.IsSpellUsable)
        {
            Logging.WriteFight(" - PET DEAD - ");
            SummonFelguard.Cast();
            Others.SafeSleep(500);

            while (ObjectManager.Me.IsCast)
                Others.SafeSleep(20);
        }
        else if (MySettings.UseSummonFelhunter && (ObjectManager.Pet.Health == 0 || ObjectManager.Pet.Guid == 0) && SummonFelhunter.IsSpellUsable)
        {
            Logging.WriteFight(" - PET DEAD - ");
            SummonFelhunter.Cast();
            Others.SafeSleep(500);

            while (ObjectManager.Me.IsCast)
                Others.SafeSleep(20);
        }
        else if (MySettings.UseSummonImp && (ObjectManager.Pet.Health == 0 || ObjectManager.Pet.Guid == 0) && SummonImp.IsSpellUsable)
        {
            Logging.WriteFight(" - PET DEAD - ");
            SummonImp.Cast();
            Others.SafeSleep(500);

            while (ObjectManager.Me.IsCast)
                Others.SafeSleep(20);
        }
        else if (MySettings.UseSummonVoidwalker && (ObjectManager.Pet.Health == 0 || ObjectManager.Pet.Guid == 0) && SummonVoidwalker.IsSpellUsable)
        {
            Logging.WriteFight(" - PET DEAD - ");
            SummonVoidwalker.Cast();
            Others.SafeSleep(500);

            while (ObjectManager.Me.IsCast)
                Others.SafeSleep(20);
        }
        else if (MySettings.UseSummonSuccubus && (ObjectManager.Pet.Health == 0 || ObjectManager.Pet.Guid == 0) && SummonSuccubus.IsSpellUsable)
        {
            Logging.WriteFight(" - PET DEAD - ");
            SummonSuccubus.Cast();
            Others.SafeSleep(500);

            while (ObjectManager.Me.IsCast)
                Others.SafeSleep(20);
        }
    }

    private void AvoidMelee()
    {
        if (ObjectManager.Target.GetDistance < MySettings.DoAvoidMeleeDistance && ObjectManager.Target.InCombat)
        {
            Logging.WriteFight("Too Close. Moving Back");
            var maxTimeTimer = new Timer(1000*2);
            MovementsAction.MoveBackward(true);
            while (ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat && !maxTimeTimer.IsReady)
                Others.SafeSleep(300);
            MovementsAction.MoveBackward(false);
            if (maxTimeTimer.IsReady && ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat)
            {
                MovementsAction.MoveForward(true);
                Others.SafeSleep(1000);
                MovementsAction.MoveForward(false);
                MovementManager.Face(ObjectManager.Target.Position);
            }
        }
    }

    private void DefenseCycle()
    {
        if (MySettings.UseBloodHorror && ObjectManager.Me.HealthPercent <= MySettings.UseBloodHorrorAtPercentage && BloodHorror.IsSpellUsable && ObjectManager.Target.GetDistance < 6)
        {
            BloodHorror.Cast();
            return;
        }
        if (MySettings.UseDarkBargain && ObjectManager.Me.HealthPercent <= MySettings.UseDarkBargainAtPercentage && DarkBargain.IsSpellUsable)
        {
            DarkBargain.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (MySettings.UseFear && ObjectManager.Me.HealthPercent <= MySettings.UseFearAtPercentage && _fearTimer.IsReady && Fear.IsSpellUsable)
        {
            Fear.Cast();
            _fearTimer = new Timer(1000*10);
            _onCd = new Timer(1000*2);
            return;
        }
        if (MySettings.UseHowlofTerror && ObjectManager.Me.HealthPercent <= MySettings.UseHowlofTerrorAtPercentage && HowlofTerror.IsSpellUsable 
            && ObjectManager.GetUnitInSpellRange(HowlofTerror.MaxRangeHostile) > 0)
        {
            HowlofTerror.Cast();
            return;
        }
        if (MySettings.UseMeteorStrike && MySettings.UseSummonInfernal && ObjectManager.Me.HealthPercent <= MySettings.UseMeteorStrikeAtPercentage 
            && (ObjectManager.Pet.Health != 0 || ObjectManager.Pet.Guid != 0) && CommandDemon.IsSpellUsable)
        {
            CommandDemon.Cast();
            return;
        }
        if (MySettings.UseSacrificialPact && ObjectManager.Me.HealthPercent <= MySettings.UseSacrificialPactAtPercentage && (ObjectManager.Pet.Health != 0 || ObjectManager.Pet.Guid != 0)
            && SacrificialPact.IsSpellUsable)
        {
            SacrificialPact.Cast();
            _onCd = new Timer(1000*10);
            return;
        }
        if (MySettings.UseShadowfury && ObjectManager.Me.HealthPercent <= MySettings.UseShadowfuryAtPercentage && Shadowfury.IsSpellUsable 
            && Shadowfury.IsHostileDistanceGood)
        {
            SpellManager.CastSpellByIDAndPosition(30283, ObjectManager.Target.Position);
            _onCd = new Timer(1000*3);
            return;
        }
        if (MySettings.UseStoneform && ObjectManager.Me.HealthPercent <= MySettings.UseStoneformAtPercentage && Stoneform.IsSpellUsable)
        {
            Stoneform.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (MySettings.UseUnendingResolve && ObjectManager.Me.HealthPercent <= MySettings.UseUnendingResolveAtPercentage && UnendingResolve.IsSpellUsable)
        {
            UnendingResolve.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (MySettings.UseWarStomp && ObjectManager.Me.HealthPercent <= MySettings.UseWarStompAtPercentage && WarStomp.IsSpellUsable 
            && ObjectManager.GetUnitInSpellRange(WarStomp.MaxRangeHostile) > 0)
        {
            WarStomp.Cast();
            _onCd = new Timer(1000*2);
            return;
        }
        if (MySettings.UseWhiplash && MySettings.UseSummonSuccubus && ObjectManager.Me.HealthPercent <= MySettings.UseWhiplashAtPercentage && CommandDemon.IsSpellUsable 
            && ObjectManager.Target.GetDistance < 6)
        {
            CommandDemon.Cast();
            _onCd = new Timer(1000*2);
        }
    }

    private void Heal()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (MySettings.UseCauterizeMaster && MySettings.UseSummonImp && ObjectManager.Me.HealthPercent <= MySettings.UseCauterizeMasterAtPercentage 
            && (ObjectManager.Pet.Health != 0 || ObjectManager.Pet.Guid != 0) && CommandDemon.IsSpellUsable)
        {
            CommandDemon.Cast();
            return;
        }
        if (MySettings.UseCreateHealthstone && _healthstoneTimer.IsReady && ObjectManager.Me.HealthPercent <= MySettings.UseCreateHealthstoneAtPercentage
            && ItemsManager.GetItemCount(5512) > 0)
        {
            Logging.WriteFight("Use Healthstone.");
            ItemsManager.UseItem("Healthstone");
            _healthstoneTimer = new Timer(1000*60);
            return;
        }
        if (MySettings.UseDarkRegeneration && ObjectManager.Me.HealthPercent <= MySettings.UseDarkRegenerationAtPercentage && DarkRegeneration.IsSpellUsable)
        {
            DarkRegeneration.Cast();
            return;
        }
        if (MySettings.UseDrainLife && DrainLife.KnownSpell && DrainLife.IsHostileDistanceGood && DrainLife.IsSpellUsable
            && ObjectManager.Me.HealthPercent <= MySettings.UseDrainLifeAtPercentage)
        {
            DrainLife.Launch(true, false, true);
            while (ObjectManager.Me.IsCast && ObjectManager.Pet.HealthPercent < 96)
                Others.SafeSleep(20);

            if (ObjectManager.Me.IsCast)
                ObjectManager.Me.StopCast();
            return;
        }
        if (MySettings.UseGiftoftheNaaru && ObjectManager.Me.HealthPercent <= MySettings.UseGiftoftheNaaruAtPercentage && GiftoftheNaaru.IsSpellUsable)
        {
            GiftoftheNaaru.Cast();
            return;
        }
        if (MySettings.UseMortalCoil && ObjectManager.Me.HealthPercent <= MySettings.UseMortalCoilAtPercentage && MortalCoil.IsSpellUsable && MortalCoil.IsHostileDistanceGood)
        {
            MortalCoil.Cast();
            return;
        }
        if (MySettings.UseArcaneTorrentForResource && ObjectManager.Me.ManaPercentage <= MySettings.UseArcaneTorrentForResourceAtPercentage && ArcaneTorrent.IsSpellUsable)
        {
            ArcaneTorrent.Cast();
            return;
        }
        if (MySettings.UseLifeTap && ObjectManager.Me.ManaPercentage <= MySettings.UseLifeTapAtPercentage && LifeTap.IsSpellUsable)
            LifeTap.Cast();
    }

    private void Decast()
    {
        if (MySettings.UseArcaneTorrentForDecast && ArcaneTorrent.KnownSpell && ObjectManager.Target.GetDistance < 8 && ArcaneTorrent.IsSpellUsable
            && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe
            && ObjectManager.Me.HealthPercent <= MySettings.UseArcaneTorrentForDecastAtPercentage)
        {
            ArcaneTorrent.Cast();
            return;
        }
        if (MySettings.UseShadowLock && MySettings.UseSummonDoomguard && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe 
            && (ObjectManager.Pet.Health != 0 || ObjectManager.Pet.Guid != 0) && CommandDemon.IsSpellUsable && ShadowBolt.IsHostileDistanceGood)
        {
            CommandDemon.Cast();
            return;
        }

        if (MySettings.UseSpellLock && MySettings.UseSummonFelhunter && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe 
            && (ObjectManager.Pet.Health != 0 || ObjectManager.Pet.Guid != 0) && CommandDemon.IsSpellUsable && ShadowBolt.IsHostileDistanceGood)
            CommandDemon.Cast();
    }

    private void DPSBurst()
    {
        if (MySettings.UseTrinketOne && !ItemsManager.IsItemOnCooldown(_firstTrinket.Entry) && ItemsManager.IsItemUsable(_firstTrinket.Entry))
        {
            ItemsManager.UseItem(_firstTrinket.Name);
            Logging.WriteFight("Use First Trinket Slot");
        }
        if (MySettings.UseTrinketTwo && !ItemsManager.IsItemOnCooldown(_secondTrinket.Entry) && ItemsManager.IsItemUsable(_secondTrinket.Entry))
        {
            ItemsManager.UseItem(_secondTrinket.Name);
            Logging.WriteFight("Use Second Trinket Slot");
        }
        if (MySettings.UseBerserking && Berserking.IsSpellUsable && ShadowBolt.IsHostileDistanceGood)
            Berserking.Cast();

        if (MySettings.UseBloodFury && BloodFury.IsSpellUsable && ShadowBolt.IsHostileDistanceGood)
            BloodFury.Cast();

        if (MySettings.UseDarkSoulKnowledge && !MySettings.UseMetamorphosis && !DarkSoulKnowledge.HaveBuff && DarkSoulKnowledge.IsSpellUsable && ShadowBolt.IsHostileDistanceGood)
            DarkSoulKnowledge.Cast();

        if (MySettings.UseSummonDoomguard && !DemonicServitude.KnownSpell && SummonDoomguard.IsSpellUsable && ObjectManager.GetUnitInSpellRange(Hellfire.MaxRangeHostile) < 8)
            SummonDoomguard.Cast();

        if (MySettings.UseSummonInfernal && !DemonicServitude.KnownSpell && SummonInfernal.IsSpellUsable && ObjectManager.GetUnitInSpellRange(Hellfire.MaxRangeHostile) > 7)
            SpellManager.CastSpellByIDAndPosition(1122, ObjectManager.Target.Position);

        if (MySettings.UseGrimoireofService && GrimoireofService.IsSpellUsable && ShadowBolt.IsHostileDistanceGood)
            GrimoireofService.Cast();
    }

    private void DPSCycle()
    {
        Usefuls.SleepGlobalCooldown();
        try
        {
            Memory.WowMemory.GameFrameLock(); // !!! WARNING - DONT SLEEP WHILE LOCKED - DO FINALLY(GameFrameUnLock()) !!!

            if (ObjectManager.Pet.Health == 0 || ObjectManager.Pet.Guid == 0)
                Pet();

            if (MySettings.UseKilJaedensCunning && !KilJaedensCunning.HaveBuff && ObjectManager.Me.GetMove && KilJaedensCunning.IsSpellUsable && ShadowBolt.IsHostileDistanceGood)
                KilJaedensCunning.Cast();

            if (MySettings.UseMannarothsFury && MannarothsFury.IsSpellUsable && ObjectManager.GetUnitInSpellRange(Hellfire.MaxRangeHostile) > 2)
                MannarothsFury.Cast();

            if (MySettings.UseMetamorphosis && ObjectManager.Me.DemonicFury > 899 || !Doom.TargetHaveBuff || DarkSoulKnowledge.IsSpellUsable)
            {
                if (ObjectManager.Me.DemonicFury > 450)
                {
                    if (MySettings.UseCorruption && !CorruptionDebuff.TargetHaveBuff && Corruption.IsSpellUsable && Corruption.IsHostileDistanceGood)
                        Corruption.Cast();

                    if (MySettings.UseMetamorphosis && Metamorphosis.KnownSpell)
                    {
                        if (MySettings.UseCataclysm && Cataclysm.KnownSpell && (!Cataclysm.IsSpellUsable || ObjectManager.Me.DemonicFury < 950))
                            Others.SafeSleep(200);
                        else
                            MetamorphosisCombat();
                    }
                }
            }

            if (Metamorphosis.HaveBuff)
                MetamorphosisCombat();

            if (MySettings.UseCorruption && (!CorruptionDebuff.TargetHaveBuff || ObjectManager.Target.UnitAura(146739).AuraTimeLeftInMs < 5400) && Corruption.IsSpellUsable 
                && Corruption.IsHostileDistanceGood)
            {
                Corruption.Cast();
                return;
            }
            if (MySettings.UseHandofGuldan && (!HandofGuldan.TargetHaveBuff || ObjectManager.Target.UnitAura(105174).AuraTimeLeftInMs < 3000) && HandofGuldan.GetSpellCharges > 0  
                && HandofGuldan.IsSpellUsable && HandofGuldan.IsHostileDistanceGood)
            {
                HandofGuldan.Cast();
                return;
            }
            if (MySettings.UseSoulFire && ((MoltenCore.BuffStack > 0 && Demonbolt.KnownSpell) || MoltenCore.BuffStack > 4 || ObjectManager.Target.HealthPercent < 25) 
                && SoulFire.IsSpellUsable && SoulFire.IsHostileDistanceGood && ObjectManager.GetUnitInSpellRange(Hellfire.MaxRangeHostile) < 8)
            {
                SoulFire.Cast();
                return;
            }
            if (MySettings.UseCommandDemon && MySettings.UseSummonFelguard && CommandDemon.IsSpellUsable && ObjectManager.Pet.Health > 0 
                && ObjectManager.GetUnitInSpellRange(Hellfire.MaxRangeHostile) > 1)
            {
                CommandDemon.Cast();
                return;
            }
            if (MySettings.UseHellfire && Hellfire.IsSpellUsable && ObjectManager.Me.HealthPercent > MySettings.UseHellfireAbovePercentage && (ObjectManager.GetUnitInSpellRange(Hellfire.MaxRangeHostile) > 4 
                || (ObjectManager.GetUnitInSpellRange(Hellfire.MaxRangeHostile) > 2 || MannarothsFury.HaveBuff)))
            {
                Hellfire.Cast();
                Others.SafeSleep(200);
                while (ObjectManager.Me.IsCast && ObjectManager.GetUnitInSpellRange(Hellfire.MaxRangeHostile) > 2 && ObjectManager.Me.HealthPercent > MySettings.UseHellfireAbovePercentage)
                    Others.SafeSleep(200);
                return;
            }
            if (MySettings.UseShadowBolt && ShadowBolt.IsSpellUsable && ShadowBolt.IsHostileDistanceGood)
                ShadowBolt.Cast();
        }
        finally
        {
            Memory.WowMemory.GameFrameUnLock();
        }
    }

    private void MetamorphosisCombat()
    {
        while (ObjectManager.Me.DemonicFury > 100)
        {
            if (MySettings.UseMetamorphosis && !Metamorphosis.HaveBuff && Metamorphosis.IsSpellUsable)
                Metamorphosis.Cast();

            if (MySettings.UseDarkSoulKnowledge && !DarkSoulKnowledge.HaveBuff && DarkSoulKnowledge.IsSpellUsable && ShadowBolt.IsHostileDistanceGood)
                DarkSoulKnowledge.Cast();

            if (MySettings.UseCataclysm && Cataclysm.IsSpellUsable && Cataclysm.IsHostileDistanceGood)
                SpellManager.CastSpellByIDAndPosition(152108, ObjectManager.Target.Position);

            if (MySettings.UseDoom && (!Doom.TargetHaveBuff || ObjectManager.Target.UnitAura(603).AuraTimeLeftInMs < 18000)
                && !SpellManager.IsSpellOnCooldown(603) && Corruption.IsHostileDistanceGood)
            {
                if (Cataclysm.KnownSpell && Cataclysm.IsSpellUsable && Cataclysm.IsHostileDistanceGood)
                    SpellManager.CastSpellByIDAndPosition(152108, ObjectManager.Target.Position);
                else
                    Doom.Cast();
            }

            if (MySettings.UseCommandDemon && MySettings.UseSummonFelguard && CommandDemon.IsSpellUsable && ObjectManager.Pet.Health > 0 
                && ObjectManager.GetUnitInSpellRange(Hellfire.MaxRangeHostile) > 1)
                CommandDemon.Cast();

            if (MySettings.UseImmolationAura && !ImmolationAura.HaveBuff && Hellfire.IsSpellUsable 
                && !SpellManager.IsSpellOnCooldown(104025) && ObjectManager.GetUnitInSpellRange(Hellfire.MaxRangeHostile) > 2)
                ImmolationAura.Cast();

            if (MySettings.UseDemonbolt && Demonbolt.BuffStack < 4 && Demonbolt.IsSpellUsable && Demonbolt.IsHostileDistanceGood)
                Demonbolt.Cast();

            if (MySettings.UseChaosWave && DarkSoulKnowledge.HaveBuff && ChaosWave.GetSpellCharges > 0 && ObjectManager.Me.DemonicFury > 79
                && !SpellManager.IsSpellOnCooldown(124916) && HandofGuldan.IsHostileDistanceGood)
                ChaosWave.Cast();

            if (MySettings.UseTouchofChaos && (CorruptionDebuff.TargetHaveBuff && ObjectManager.Target.UnitAura(146739).AuraTimeLeftInMs < 5400
                || MoltenCore.BuffStack < 1) && ObjectManager.Me.DemonicFury > 39 && !SpellManager.IsSpellOnCooldown(103964) && ShadowBolt.IsHostileDistanceGood)
                TouchofChaos.Cast();

            if (MySettings.UseSoulFire && MoltenCore.BuffStack > 0 && SoulFire.IsSpellUsable && SoulFire.IsHostileDistanceGood && ObjectManager.GetUnitInSpellRange(Hellfire.MaxRangeHostile) < 8)
                SoulFire.Cast();

            Others.SafeSleep(1000);
        }

        Others.SafeSleep(1000);
        if (Metamorphosis.HaveBuff)
        {
            Metamorphosis.Cast();
            Others.SafeSleep(1000);
        }
    }

    private void Patrolling()
    {
        if (!ObjectManager.Me.IsMounted)
        {
            Buff();
            Heal();
        }
    }

    #region Nested type: WarlockDemonologySettings

    [Serializable]
    public class WarlockDemonologySettings : Settings
    {
        public bool DoAvoidMelee = false;
        public int DoAvoidMeleeDistance = 0;
        public bool UseAlchFlask = true;
        public bool UseArcaneTorrentForDecast = true;
        public int UseArcaneTorrentForDecastAtPercentage = 100;
        public bool UseArcaneTorrentForResource = true;
        public int UseArcaneTorrentForResourceAtPercentage = 80;
        public bool UseBerserking = true;
        public bool UseBloodFury = true;
        public bool UseBloodHorror = true;
        public int UseBloodHorrorAtPercentage = 20;
        public bool UseBurningRush = true;
        public int UseBurningRushAbovePercentage = 50;
        public bool UseCataclysm = true;
        public bool UseCauterizeMaster = true;
        public int UseCauterizeMasterAtPercentage = 90;
        public bool UseChaosWave = true;
        public bool UseCommandDemon = true;
        public bool UseCorruption = true;
        public bool UseCreateHealthstone = true;
        public int UseCreateHealthstoneAtPercentage = 80;
        public bool UseDarkBargain = true;
        public int UseDarkBargainAtPercentage = 60;
        public bool UseDarkIntent = true;
        public bool UseDarkRegeneration = true;
        public int UseDarkRegenerationAtPercentage = 70;
        public bool UseDarkSoulKnowledge = true;
        public bool UseDemonbolt = true;
        public bool UseDoom = true;
        public bool UseDrainLife = true;
        public int UseDrainLifeAtPercentage = 65;
        public bool UseFear = true;
        public int UseFearAtPercentage = 20;
        public bool UseGiftoftheNaaru = true;
        public int UseGiftoftheNaaruAtPercentage = 80;
        public bool UseGrimoireofService = true;
        public bool UseHandofGuldan = true;
        public bool UseHarvestLife = false;
        public bool UseHealthFunnel = true;
        public int UseHealthFunnelAtPercentage = 50;
        public bool UseHellfire = true;
        public int UseHellfireAbovePercentage = 50;
        public bool UseHowlofTerror = true;
        public int UseHowlofTerrorAtPercentage = 20;
        public bool UseImmolationAura = true;
        public bool UseKilJaedensCunning = true;
        public bool UseLifeTap = true;
        public int UseLifeTapAtPercentage = 70;
        public bool UseLowCombat = true;
        public int UseLowCombatAtPercentage = 15;
        public bool UseMannarothsFury = true;
        public bool UseMetamorphosis = true;
        public bool UseMeteorStrike = true;
        public int UseMeteorStrikeAtPercentage = 85;
        public bool UseMortalCoil = true;
        public int UseMortalCoilAtPercentage = 85;
        public bool UseSacrificialPact = true;
        public int UseSacrificialPactAtPercentage = 70;
        public bool UseShadowBolt = true;
        public bool UseShadowfury = true;
        public int UseShadowfuryAtPercentage = 90;
        public bool UseShadowLock = true;
        public int UseShadowLockAtPercentage = 100;
        public bool UseSoulFire = true;
        public bool UseSoulstone = true;
        public bool UseSpellLock = true;
        public int UseSpellLockAtPercentage = 100;
        public bool UseStoneform = true;
        public int UseStoneformAtPercentage = 80;
        public bool UseSummonDoomguard = true;
        public bool UseSummonFelguard = true;
        public bool UseSummonFelhunter = false;
        public bool UseSummonImp = false;
        public bool UseSummonInfernal = true;
        public bool UseSummonSuccubus = false;
        public bool UseSummonVoidwalker = false;
        public bool UseTouchofChaos = true;
        public bool UseTrinketOne = true;
        public bool UseTrinketTwo = true;
        public bool UseUnendingBreath = false;
        public bool UseUnendingResolve = true;
        public int UseUnendingResolveAtPercentage = 70;
        public bool UseVoidRay = true;
        public bool UseWarStomp = true;
        public int UseWarStompAtPercentage = 80;
        public bool UseWhiplash = true;
        public int UseWhiplashAtPercentage = 85;

        public WarlockDemonologySettings()
        {
            ConfigWinForm("Warlock Demonology Settings");
            /* Professions & Racials */
            AddControlInWinForm("Use Arcane Torrent for Interrupt", "UseArcaneTorrentForDecast", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Arcane Torrent for Resource", "UseArcaneTorrentForResource", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Berserking", "UseBerserking", "Professions & Racials");
            AddControlInWinForm("Use Blood Fury", "UseBloodFury", "Professions & Racials");
            AddControlInWinForm("Use Gift of the Naaru", "UseGiftoftheNaaru", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Stoneform", "UseStoneform", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use War Stomp", "UseWarStomp", "Professions & Racials", "AtPercentage");
            /* Warlock Buffs */
            AddControlInWinForm("Use Burning Rush", "UseBurningRush", "Warlock Buffs", "BelowPercentage");
            AddControlInWinForm("Use Dark Intent", "UseDarkIntent", "Warlock Buffs");
            AddControlInWinForm("Use Grimoire of Sacrifice", "UseGrimoireofSacrifice", "Warlock Buffs");
            AddControlInWinForm("Use Kil'Jaeden's Cunning", "UseKilJaedensCunning", "Warlock Buffs");
            AddControlInWinForm("Use Metamorphosis", "UseMetamorphosis", "Warlock Buffs");
            AddControlInWinForm("Use Soulstone", "UseSoulstone", "Warlock Buffs");
            AddControlInWinForm("Use Unending Breath", "UseUnendingBreath", "Warlock Buffs");
            /* Offensive Spell */
            AddControlInWinForm("Use Chaos Wave", "UseChaosWave", "Offensive Spell");
            AddControlInWinForm("Use Command Demon", "UseCommandDemon", "Offensive Spell");
            AddControlInWinForm("Use Corruption", "UseCorruption", "Offensive Spell");
            AddControlInWinForm("Use Demonbolt", "UseDemonbolt", "Offensive Spell");
            AddControlInWinForm("Use Doom", "UseDoom", "Offensive Spell");
            AddControlInWinForm("Use Hand of Guldan", "UseHandofGuldan", "Offensive Spell");
            AddControlInWinForm("Use Hellfire", "UseHellfire", "Offensive Spell", "AbovePercentage");
            AddControlInWinForm("Use Immolation Aura", "UseImmolationAura", "Offensive Spell");
            AddControlInWinForm("Use Shadow Bolt", "UseShadowBolt", "Offensive Spell");
            AddControlInWinForm("Use Soul Fire", "UseSoulFire", "Offensive Spell");
            AddControlInWinForm("Use Summon Felguard", "UseSummonFelguard", "Offensive Spell");
            AddControlInWinForm("Use Summon Felhunter", "UseSummonFelhunter", "Offensive Spell");
            AddControlInWinForm("Use Summon Imp", "UseSummonImp", "Offensive Spell");
            AddControlInWinForm("Use Summon Succubus", "UseSummonSuccubus", "Offensive Spell");
            AddControlInWinForm("Use Summon Voidwalker", "UseSummonVoidwalker", "Offensive Spell");
            AddControlInWinForm("Use Touch of Chaos", "UseTouchofChaos", "Offensive Spell");
            /* Offensive Cooldown */
            AddControlInWinForm("Use Cataclysm", "UseCataclysm", "Offensive Cooldown");
            AddControlInWinForm("Use Dark Soul: Knowledge", "UseDarkSoulKnowledge", "Offensive Cooldown");
            AddControlInWinForm("Use Grimoire of Service", "UseGrimoireofService", "Offensive Cooldown");
            AddControlInWinForm("Use Mannaroth's Fury", "UseMannarothsFury", "Offensive Cooldown");
            AddControlInWinForm("Use Summon Doomguard", "UseSummonDoomguard", "Offensive Cooldown");
            AddControlInWinForm("Use Summon Infernal", "UseSummonInfernal", "Offensive Cooldown");
            /* Defensive Cooldown */
            AddControlInWinForm("Use Blood Horror", "UseBloodHorror", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Dark Bargain", "UseDarkBargain", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Fear", "UseFear", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Howl of Terror", "UseHowlofTerror", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Meteor Strike", "UseMeteorStrike", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Sacrificial Pact", "UseSacrificialPact", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Shadowfury", "UseShadowfury", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Shadow Lock", "UseShadowLock", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Spell Lock", "UseSpellLock", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Unending Resolve", "UseUnendingResolve", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Whiplash", "UseWhiplash", "Defensive Cooldown", "AtPercentage");
            /* Healing Spell */
            AddControlInWinForm("Use Cauterize Master", "UseCauterizeMaster", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Create Healthstone", "UseCreateHealthstone", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Dark Regeneration", "UseDarkRegeneration", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Drain Life", "UseDrainLife", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Health Funnel", "UseHealthFunnel", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Life Tap", "UseLifeTap", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Mortal Coil", "UseMortalCoil", "Healing Spell", "AtPercentage");
            /* Game Settings */
            AddControlInWinForm("Use Low Combat Settings - At Level", "UseLowCombat", "Game Settings", "AtPercentage");
            AddControlInWinForm("Use Trinket One", "UseTrinketOne", "Game Settings");
            AddControlInWinForm("Use Trinket Two", "UseTrinketTwo", "Game Settings");
            AddControlInWinForm("Use Alchemist Flask", "UseAlchFlask", "Game Settings");
            AddControlInWinForm("Do avoid melee (Off Advised!!)", "DoAvoidMelee", "Game Settings");
            AddControlInWinForm("Avoid melee distance (1 to 4)", "DoAvoidMeleeDistance", "Game Settings");
        }

        public static WarlockDemonologySettings CurrentSetting { get; set; }

        public static WarlockDemonologySettings GetSettings()
        {
            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Warlock_Demonology.xml";
            if (File.Exists(currentSettingsFile))
            {
                return
                    CurrentSetting = Load<WarlockDemonologySettings>(currentSettingsFile);
            }
            return new WarlockDemonologySettings();
        }
    }

    #endregion
}

public class WarlockDestruction
{
    private static WarlockDestructionSettings MySettings = WarlockDestructionSettings.GetSettings();

    #region General Timers & Variables

    private readonly WoWItem _firstTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET);
    private readonly WoWItem _secondTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET, 2);
    public int LC = 0;

    private Timer _onCd = new Timer(0);

    #endregion

    #region Professions & Racials

    public readonly Spell Alchemy = new Spell("Alchemy");
    public readonly Spell ArcaneTorrent = new Spell("Arcane Torrent");
    public readonly Spell Berserking = new Spell("Berserking");
    public readonly Spell BloodFury = new Spell("Blood Fury");

    public readonly Spell GiftoftheNaaru = new Spell("Gift of the Naaru");

    public readonly Spell Stoneform = new Spell("Stoneform");
    public readonly Spell WarStomp = new Spell("War Stomp");

    #endregion

    #region Warlock Buffs

    public readonly Spell CurseofEnfeeblement = new Spell("Curse of Enfeeblement");
    public readonly Spell CurseoftheElements = new Spell("Curse of the Elements");
    public readonly Spell DarkIntent = new Spell("Dark Intent");
    public readonly Spell GrimoireofSacrifice = new Spell("Grimoire of Sacrifice");
    public readonly Spell SoulLink = new Spell("Soul Link");
    public readonly Spell Soulstone = new Spell("Soulstone");

    #endregion

    #region Offensive Spell

    public readonly Spell ChaosBolt = new Spell("Chaos Bolt");
    public readonly Spell CommandDemon = new Spell("Command Demon");
    public readonly Spell Conflagrate = new Spell("Conflagrate");
    public readonly Spell Corruption = new Spell("Corruption");
    public readonly Spell FelFlame = new Spell("Fel Flame");
    public readonly Spell FireandBrimstone = new Spell("Fire and Brimstone");
    public readonly Spell HarvestLife = new Spell("Harvest Life");
    public readonly Spell Immolate = new Spell("Immolate");
    public readonly Spell Incinerate = new Spell("Incinerate");
    public readonly Spell RainofFire = new Spell("Rain of Fire");
    public readonly Spell ShadowBolt = new Spell("Shadow Bolt");
    public readonly Spell Shadowburn = new Spell("Shadowburn");
    public readonly Spell SummonFelhunter = new Spell("Summon Felhunter");
    public readonly Spell SummonImp = new Spell("Summon Imp");
    public readonly Spell SummonSuccubus = new Spell("Summon Succubus");
    public readonly Spell SummonVoidwalker = new Spell("Summon Voidwalker");
    private Timer _immolateTimer = new Timer(0);
    private Timer _rainOfFireTimer = new Timer(0);

    #endregion

    #region Offensive Cooldown

    public readonly Spell ArchimondesVengeance = new Spell("Archimonde's Vengeance");
    public readonly Spell DarkSoul = new Spell("Dark Soul: Instability");
    public readonly Spell GrimoireofService = new Spell("Grimoire of Service");
    public readonly Spell SummonDoomguard = new Spell("Summon Doomguard");
    public readonly Spell SummonInfernal = new Spell("Summon Infernal");

    #endregion

    #region Defensive Cooldown

    public readonly Spell DarkBargain = new Spell("Dark Bargain");
    public readonly Spell HowlofTerror = new Spell("HowlofTerror");
    public readonly Spell SacrificialPact = new Spell("Sacrificial Pact");
    public readonly Spell Shadowfury = new Spell("Shadowfury");
    public readonly Spell TwilightWard = new Spell("Twilight Ward");
    public readonly Spell UnboundWill = new Spell("Unbound Will");
    public readonly Spell UnendingResolve = new Spell("Unending Resolve");

    #endregion

    #region Healing Spell

    public readonly Spell CreateHealthstone = new Spell("Create Healthstone");
    public readonly Spell DarkRegeneration = new Spell("Dark Regeneration");
    public readonly Spell DrainLife = new Spell("Drain Life");
    public readonly Spell EmberTap = new Spell("Ember Tap");
    public readonly Spell FlamesofXoroth = new Spell("Flames of Xoroth");
    public readonly Spell HealthFunnel = new Spell("Health Funnel");
    public readonly Spell LifeTap = new Spell("Life Tap");
    public readonly Spell MortalCoil = new Spell("Mortal Coil");
    private Timer _healthstoneTimer = new Timer(0);

    #endregion

    #region Procs

    public readonly uint Backdraft = 117828; // Reduce cast time of chaos bolt and incinerate
    public readonly uint DarkSoulInstability = 113858;
    public readonly uint FourT16Parts = 145091;

    #endregion

    public WarlockDestruction()
    {
        Main.InternalRange = 39f;
        Main.InternalAggroRange = 39f;
        MySettings = WarlockDestructionSettings.GetSettings();
        Main.DumpCurrentSettings<WarlockDestructionSettings>(MySettings);
        UInt128 lastTarget = 0;

        while (Main.InternalLoop)
        {
            try
            {
                if (!ObjectManager.Me.IsDeadMe)
                {
                    if (!ObjectManager.Me.IsMounted)
                    {
                        if (Fight.InFight && ObjectManager.Me.Target > 0)
                        {
                            if (ObjectManager.Me.Target != lastTarget
                                && (CurseoftheElements.IsHostileDistanceGood))
                            {
                                Pull();
                                lastTarget = ObjectManager.Me.Target;
                            }

                            if (MySettings.UseLowCombat && ObjectManager.Target.Level < 70 && ObjectManager.Me.Level > 84)
                            {
                                LC = 1;
                                if (CombatClass.InSpellRange(ObjectManager.Target, 0, Main.InternalRange))
                                    LowCombat();
                            }
                            else
                            {
                                LC = 0;
                                if (CombatClass.InSpellRange(ObjectManager.Target, 0, Main.InternalRange))
                                    Combat();
                            }
                        }
                        if (!ObjectManager.Me.IsCast)
                            Patrolling();
                    }
                }
                else
                    Thread.Sleep(500);
            }
            catch
            {
            }
            Thread.Sleep(100);
        }
    }

    private void Pull()
    {
        if (MySettings.UseCurseoftheElements && CurseoftheElements.KnownSpell && CurseoftheElements.IsSpellUsable
            && CurseoftheElements.IsHostileDistanceGood && !CurseoftheElements.TargetHaveBuff)
        {
            CurseoftheElements.Cast();
        }
    }

    private void LowCombat()
    {
        Buff();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        if (_onCd.IsReady)
            DefenseCycle();
        Heal();

        if (MySettings.UseIncinerate && Incinerate.KnownSpell && Incinerate.IsHostileDistanceGood && Incinerate.IsSpellUsable)
        {
            Incinerate.Cast();
            return;
        }
        if (MySettings.UseRainofFire && RainofFire.KnownSpell && _rainOfFireTimer.IsReady
            && RainofFire.IsHostileDistanceGood && RainofFire.IsSpellUsable)
        {
            SpellManager.CastSpellByIDAndPosition(RainofFire.Id, ObjectManager.Target.Position);
            _rainOfFireTimer = new Timer(1000*6.5);
        }
    }

    private void Combat()
    {
        Buff();
        DPSBurst();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        DPSCycle();
        Decast();
        if (_onCd.IsReady)
            DefenseCycle();
        Heal();
    }

    private void Buff()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        Pet();

        if (MySettings.UseDarkIntent && DarkIntent.KnownSpell && !DarkIntent.HaveBuff && DarkIntent.IsSpellUsable)
            DarkIntent.Cast();

        if (MySettings.UseSoulLink && SoulLink.KnownSpell && !SoulLink.HaveBuff && SoulLink.IsSpellUsable && (ObjectManager.Pet.Health != 0 || ObjectManager.Pet.Guid != 0) &&
            ObjectManager.Me.InCombat)
            SoulLink.Cast();

        if (MySettings.UseSoulstone && Soulstone.KnownSpell && !Soulstone.HaveBuff && Soulstone.IsSpellUsable && Usefuls.GetContainerNumFreeSlots > 0)
            Soulstone.Cast();

        if (MySettings.UseCreateHealthstone && CreateHealthstone.KnownSpell && CreateHealthstone.IsSpellUsable && ItemsManager.GetItemCount(5512) == 0 &&
            Usefuls.GetContainerNumFreeSlots > 0)
        {
            Logging.WriteFight(" - Create Healthstone - ");
            CreateHealthstone.Cast();
            while (ObjectManager.Me.IsCast)
                Others.SafeSleep(200);
        }

        if (MySettings.UseAlchFlask && !ObjectManager.Me.HaveBuff(79638) && !ObjectManager.Me.HaveBuff(79640) && !ObjectManager.Me.HaveBuff(79639) &&
            !ItemsManager.IsItemOnCooldown(75525) && ItemsManager.GetItemCount(75525) > 0)
            ItemsManager.UseItem(75525);
    }

    private void Pet()
    {
        if (MySettings.UseHealthFunnel && HealthFunnel.KnownSpell && ObjectManager.Pet.HealthPercent > 0 && HealthFunnel.IsSpellUsable && ObjectManager.Pet.HealthPercent < 50)
        {
            HealthFunnel.Cast();
            while (ObjectManager.Me.IsCast)
            {
                if (ObjectManager.Pet.HealthPercent > 85 || ObjectManager.Pet.IsDead)
                    break;
                Others.SafeSleep(100);
            }
        }

        if (MySettings.UseFlamesofXoroth && FlamesofXoroth.KnownSpell && ObjectManager.Me.InCombat && FlamesofXoroth.IsSpellUsable &&
            (ObjectManager.Pet.Health == 0 || ObjectManager.Pet.Guid == 0) && !GrimoireofSacrifice.HaveBuff)
        {
            FlamesofXoroth.Cast();
            Logging.WriteFight(" - PET DEAD - ");
        }
        else if (MySettings.UseSummonFelhunter && SummonFelhunter.KnownSpell && !GrimoireofSacrifice.HaveBuff && SummonFelhunter.IsSpellUsable && ObjectManager.Me.InCombat &&
                 (ObjectManager.Pet.Health == 0 || ObjectManager.Pet.Guid == 0))
        {
            Logging.WriteFight(" - PET DEAD - ");
            SummonFelhunter.Cast();
        }
        else if (MySettings.UseSummonImp && SummonImp.KnownSpell && !GrimoireofSacrifice.HaveBuff && SummonImp.IsSpellUsable && ObjectManager.Me.InCombat &&
                 (ObjectManager.Pet.Health == 0 || ObjectManager.Pet.Guid == 0))
        {
            Logging.WriteFight(" - PET DEAD - ");
            SummonImp.Cast();
        }
        else if (MySettings.UseSummonVoidwalker && SummonVoidwalker.KnownSpell && !GrimoireofSacrifice.HaveBuff && SummonVoidwalker.IsSpellUsable &&
                 ObjectManager.Me.InCombat && (ObjectManager.Pet.Health == 0 || ObjectManager.Pet.Guid == 0))
        {
            Logging.WriteFight(" - PET DEAD - ");
            SummonVoidwalker.Cast();
        }
        else if (MySettings.UseSummonSuccubus && SummonSuccubus.KnownSpell && !GrimoireofSacrifice.HaveBuff && SummonSuccubus.IsSpellUsable && ObjectManager.Me.InCombat &&
                 (ObjectManager.Pet.Health == 0 || ObjectManager.Pet.Guid == 0))
        {
            Logging.WriteFight(" - PET DEAD - ");
            SummonSuccubus.Cast();
        }
        Others.SafeSleep(200);
        if (MySettings.UseGrimoireofSacrifice && GrimoireofSacrifice.KnownSpell && !GrimoireofSacrifice.HaveBuff && GrimoireofSacrifice.IsSpellUsable &&
            (ObjectManager.Pet.Health != 0 || ObjectManager.Pet.Guid != 0))
        {
            GrimoireofSacrifice.Cast();
        }
    }

    private void AvoidMelee()
    {
        if (ObjectManager.Target.GetDistance < MySettings.DoAvoidMeleeDistance && ObjectManager.Target.InCombat)
        {
            Logging.WriteFight("Too Close. Moving Back");
            var maxTimeTimer = new Timer(1000*2);
            MovementsAction.MoveBackward(true);
            while (ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat && !maxTimeTimer.IsReady)
                Others.SafeSleep(300);
            MovementsAction.MoveBackward(false);
            if (maxTimeTimer.IsReady && ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat)
            {
                MovementsAction.MoveForward(true);
                Others.SafeSleep(1000);
                MovementsAction.MoveForward(false);
                MovementManager.Face(ObjectManager.Target.Position);
            }
        }
    }

    private void DefenseCycle()
    {
        if (MySettings.UseUnendingResolve && UnendingResolve.KnownSpell && UnendingResolve.IsSpellUsable
            && ObjectManager.Me.HealthPercent <= MySettings.UseUnendingResolveAtPercentage)
        {
            UnendingResolve.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (MySettings.UseHowlofTerror && HowlofTerror.KnownSpell && ObjectManager.Target.GetDistance < 8 && HowlofTerror.IsSpellUsable
            && ObjectManager.Me.HealthPercent <= MySettings.UseHowlofTerrorAtPercentage)
        {
            HowlofTerror.Cast();
            return;
        }
        if (MySettings.UseDarkBargain && DarkBargain.KnownSpell && DarkBargain.IsSpellUsable
            && ObjectManager.Me.HealthPercent <= MySettings.UseDarkBargainAtPercentage)
        {
            DarkBargain.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (MySettings.UseSacrificialPact && SacrificialPact.KnownSpell && SacrificialPact.IsSpellUsable
            && ObjectManager.Me.HealthPercent <= MySettings.UseSacrificialPactAtPercentage
            && (ObjectManager.Pet.Health != 0 || ObjectManager.Pet.Guid != 0))
        {
            SacrificialPact.Cast();
            _onCd = new Timer(1000*10);
            return;
        }
        if (MySettings.UseShadowfury && Shadowfury.KnownSpell && Shadowfury.IsHostileDistanceGood && Shadowfury.IsSpellUsable
            && ObjectManager.Me.HealthPercent <= MySettings.UseShadowfuryAtPercentage)
        {
            SpellManager.CastSpellByIDAndPosition(30283, ObjectManager.Target.Position);
            _onCd = new Timer(1000*3);
            return;
        }
        if (MySettings.UseWarStomp && WarStomp.KnownSpell && ObjectManager.Me.HealthPercent <= MySettings.UseWarStompAtPercentage && WarStomp.IsSpellUsable)
        {
            WarStomp.Cast();
            _onCd = new Timer(1000*2);
            return;
        }
        if (MySettings.UseStoneform && Stoneform.KnownSpell && ObjectManager.Me.HealthPercent <= MySettings.UseStoneformAtPercentage && Stoneform.IsSpellUsable)
        {
            Stoneform.Cast();
            _onCd = new Timer(1000*8);
        }
    }

    private void Heal()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (MySettings.UseArcaneTorrentForResource && ArcaneTorrent.KnownSpell && ArcaneTorrent.IsSpellUsable
            && ObjectManager.Me.ManaPercentage <= MySettings.UseArcaneTorrentForResourceAtPercentage)
        {
            ArcaneTorrent.Cast();
            return;
        }
        if (MySettings.UseGiftoftheNaaru && GiftoftheNaaru.KnownSpell && GiftoftheNaaru.IsSpellUsable
            && ObjectManager.Me.HealthPercent <= MySettings.UseGiftoftheNaaruAtPercentage)
        {
            GiftoftheNaaru.Cast();
            return;
        }
        if (MySettings.UseEmberTap && EmberTap.KnownSpell && ObjectManager.Me.HealthPercent <= MySettings.UseEmberTapAtPercentage && EmberTap.IsSpellUsable)
        {
            EmberTap.Cast();
            return;
        }
        if (MySettings.UseDarkRegeneration && DarkRegeneration.KnownSpell && DarkRegeneration.IsSpellUsable
            && ObjectManager.Me.HealthPercent <= MySettings.UseDarkRegenerationAtPercentage)
        {
            DarkRegeneration.Cast();
            return;
        }
        if (MySettings.UseCreateHealthstone && _healthstoneTimer.IsReady && ItemsManager.GetItemCount(5512) > 0
            && ObjectManager.Me.HealthPercent <= MySettings.UseCreateHealthstoneAtPercentage)
        {
            Logging.WriteFight("Use Healthstone.");
            ItemsManager.UseItem(5512); // "Healthstone" works only with US or UK client
            _healthstoneTimer = new Timer(1000*60*2);
            return;
        }
        if (MySettings.UseMortalCoil && MortalCoil.KnownSpell && MortalCoil.IsHostileDistanceGood && MortalCoil.IsSpellUsable
            && ObjectManager.Me.HealthPercent <= MySettings.UseMortalCoilAtPercentage)
        {
            MortalCoil.Cast();
            return;
        }
        if (MySettings.UseDrainLife && DrainLife.KnownSpell && DrainLife.IsHostileDistanceGood && DrainLife.IsSpellUsable
            && ObjectManager.Me.HealthPercent <= MySettings.UseDrainLifeAtPercentage)
        {
            DrainLife.Cast();
            while (ObjectManager.Me.IsCast)
                Others.SafeSleep(200);
        }
    }

    private void Decast()
    {
        if (MySettings.UseArcaneTorrentForDecast && ArcaneTorrent.KnownSpell && ObjectManager.Target.GetDistance < 8 && ArcaneTorrent.IsSpellUsable
            && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe
            && ObjectManager.Me.HealthPercent <= MySettings.UseArcaneTorrentForDecastAtPercentage)
        {
            ArcaneTorrent.Cast();
            return;
        }
        if (MySettings.UseTwilightWard && TwilightWard.KnownSpell && TwilightWard.IsSpellUsable
            && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe
            && ObjectManager.Me.HealthPercent <= MySettings.UseTwilightWardAtPercentage)
        {
            TwilightWard.Cast();
            return;
        }
        if (MySettings.UseCommandDemon && MySettings.UseSummonFelhunter && CommandDemon.KnownSpell && ObjectManager.Target.GetDistance <= 40f && CommandDemon.IsSpellUsable
            && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe)
        {
            CommandDemon.Cast();
        }
    }

    private void DPSBurst()
    {
        if (MySettings.UseTrinketOne && !ItemsManager.IsItemOnCooldown(_firstTrinket.Entry) && ItemsManager.IsItemUsable(_firstTrinket.Entry))
        {
            ItemsManager.UseItem(_firstTrinket.Name);
            Logging.WriteFight("Use First Trinket Slot");
        }

        if (MySettings.UseTrinketTwo && !ItemsManager.IsItemOnCooldown(_secondTrinket.Entry) && ItemsManager.IsItemUsable(_secondTrinket.Entry))
        {
            ItemsManager.UseItem(_secondTrinket.Name);
            Logging.WriteFight("Use Second Trinket Slot");
        }

        if (MySettings.UseBerserking && Berserking.KnownSpell && ObjectManager.Target.GetDistance <= 40f && Berserking.IsSpellUsable)
        {
            Berserking.Cast();
            return;
        }
        if (MySettings.UseBloodFury && BloodFury.KnownSpell && ObjectManager.Target.GetDistance <= 40f && BloodFury.IsSpellUsable)
        {
            BloodFury.Cast();
        }
        if (DarkSoul.KnownSpell && DarkSoul.IsSpellUsable
            && MySettings.UseDarkSoul && ObjectManager.Target.GetDistance <= 40f)
        {
            DarkSoul.Cast();
        }
        if (MySettings.UseSummonDoomguard && SummonDoomguard.KnownSpell && SummonDoomguard.IsHostileDistanceGood && SummonDoomguard.IsSpellUsable)
        {
            SummonDoomguard.Cast();
        }
        else if (MySettings.UseSummonInfernal && SummonInfernal.KnownSpell && SummonInfernal.IsHostileDistanceGood && SummonInfernal.IsSpellUsable)
        {
            SpellManager.CastSpellByIDAndPosition(1122, ObjectManager.Target.Position);
        }
        if (MySettings.UseArchimondesVengeance && ArchimondesVengeance.KnownSpell && ObjectManager.Target.GetDistance <= 40f && ArchimondesVengeance.IsSpellUsable)
        {
            ArchimondesVengeance.Cast();
        }
        if (MySettings.UseGrimoireofService && GrimoireofService.KnownSpell && ObjectManager.Target.GetDistance <= 40f && GrimoireofService.IsSpellUsable)
        {
            GrimoireofService.Cast();
        }
    }

    private void DPSCycle()
    {
        Usefuls.SleepGlobalCooldown();
        try
        {
            Memory.WowMemory.GameFrameLock(); // !!! WARNING - DONT SLEEP WHILE LOCKED - DO FINALLY(GameFrameUnLock()) !!!

            if (MySettings.UseCurseoftheElements && CurseoftheElements.KnownSpell && CurseoftheElements.IsHostileDistanceGood && CurseoftheElements.IsSpellUsable
                && !CurseoftheElements.TargetHaveBuff)
            {
                CurseoftheElements.Cast();
                return;
            }
            if (MySettings.UseCurseofEnfeeblement && !MySettings.UseCurseoftheElements && CurseofEnfeeblement.KnownSpell && CurseofEnfeeblement.IsHostileDistanceGood &&
                CurseofEnfeeblement.IsSpellUsable
                && !CurseofEnfeeblement.TargetHaveBuff)
            {
                CurseofEnfeeblement.Cast();
                return;
            }

            bool hasImmolateBuff = Immolate.TargetHaveBuff;
            if (ObjectManager.GetNumberAttackPlayer() > 4)
            {
                if (MySettings.UseFireandBrimstone && MySettings.UseImmolate && FireandBrimstone.KnownSpell
                    && !hasImmolateBuff && Immolate.KnownSpell && Immolate.IsHostileDistanceGood
                    && FireandBrimstone.IsSpellUsable && Immolate.IsSpellUsable)
                {
                    FireandBrimstone.Cast();
                    Others.SafeSleep(200);
                    Immolate.Cast();
                    _immolateTimer = new Timer(1000*12);
                    return;
                }
                if (MySettings.UseHarvestLife && hasImmolateBuff && HarvestLife.KnownSpell
                    && HarvestLife.IsHostileDistanceGood && HarvestLife.IsSpellUsable)
                {
                    HarvestLife.Cast();
                    while (ObjectManager.Me.IsCast)
                        Others.SafeSleep(200);
                    return;
                }
                if (MySettings.UseHarvestLife && hasImmolateBuff && DrainLife.KnownSpell
                    && DrainLife.IsHostileDistanceGood && DrainLife.IsSpellUsable && !HarvestLife.KnownSpell)
                {
                    DrainLife.Cast();
                    while (ObjectManager.Me.IsCast)
                        Others.SafeSleep(200);
                    return;
                }
                if (MySettings.UseFireandBrimstone && MySettings.UseIncinerate && FireandBrimstone.KnownSpell
                    && Incinerate.KnownSpell && Incinerate.IsHostileDistanceGood && FireandBrimstone.IsSpellUsable && Incinerate.IsSpellUsable)
                {
                    FireandBrimstone.Cast();
                    Others.SafeSleep(200);
                    Incinerate.Cast();
                    return;
                }
                if (MySettings.UseRainofFire && RainofFire.KnownSpell && RainofFire.IsHostileDistanceGood && RainofFire.IsSpellUsable)
                {
                    SpellManager.CastSpellByIDAndPosition(5740, ObjectManager.Target.Position);
                    return;
                }
            }

            // 1) Cast Shadowburn, when your target has less than 20% health and the conditions below for Chaos Bolt are met.
            if (ObjectManager.Target.HealthPercent <= 20f && Shadowburn.KnownSpell && Shadowburn.IsSpellUsable && Shadowburn.IsHostileDistanceGood
                && MySettings.UseShadowburn)
            {
                Shadowburn.Cast();
                return;
            }
            // 2) Apply Immolate and refresh it, if it is about to drop.
            if (MySettings.UseImmolate && (!hasImmolateBuff || _immolateTimer.IsReady) &&
                Immolate.KnownSpell && Immolate.IsHostileDistanceGood && Immolate.IsSpellUsable)
            {
                Immolate.Cast();
                _immolateTimer = new Timer(1000*12);
                return;
            }
            // 3) Cast Conflagrate if you have two charges. // But I don't know how to know number of charges
            if (MySettings.UseConflagrate && Conflagrate.KnownSpell && Conflagrate.IsHostileDistanceGood && Conflagrate.IsSpellUsable
                && ObjectManager.Me.BurningEmbers < 31 && !ObjectManager.Me.HaveBuff(Backdraft))
            {
                Conflagrate.Cast();
                return;
            }
            // 4) Cast Chaos Bolt if
            //    * you have more than 3.5 Burning Embers or
            //    * you have an Intellect/Critical Strike/Mastery/Spell Power proc or
            //    * Dark Soul: Instability is up or
            //    * your Tier 16 4-piece bonus is up and you have more than 3 Burning Embers.
            if (MySettings.UseChaosBolt && ChaosBolt.KnownSpell && ChaosBolt.IsHostileDistanceGood && ChaosBolt.IsSpellUsable &&
                (ObjectManager.Me.BurningEmbers > 35 ||
                 false ||
                 ObjectManager.Me.HaveBuff(DarkSoulInstability) || ObjectManager.Me.HaveBuff(Backdraft) ||
                 ObjectManager.Me.HaveBuff(FourT16Parts)
                    )
                )
            {
                ChaosBolt.Cast();
                return;
            }
            // 5) Cast Rain of Fire if it is not ticking.
            if (MySettings.UseRainofFire && RainofFire.KnownSpell && _rainOfFireTimer.IsReady && RainofFire.IsHostileDistanceGood
                && !RainofFire.TargetHaveBuff && RainofFire.IsSpellUsable)
            {
                SpellManager.CastSpellByIDAndPosition(RainofFire.Id, ObjectManager.Target.Position);
                _rainOfFireTimer = new Timer(1000*6.5);
                return;
            }
            // 6) Cast Conflagrate if you have one charge.
            if (MySettings.UseConflagrate && Conflagrate.KnownSpell && Conflagrate.IsHostileDistanceGood && Conflagrate.IsSpellUsable)
            {
                Conflagrate.Cast();
                return;
            }
            // 7) Filler: Incinerate
            if (MySettings.UseIncinerate && Incinerate.KnownSpell && Incinerate.IsSpellUsable && Incinerate.IsHostileDistanceGood)
            {
                Incinerate.Cast();
            }
        }
        finally
        {
            Memory.WowMemory.GameFrameUnLock();
        }
    }

    private void Patrolling()
    {
        if (ObjectManager.Me.IsMounted) return;
        Buff();
        Heal();
    }

    #region Nested type: WarlockDestructionSettings

    [Serializable]
    public class WarlockDestructionSettings : Settings
    {
        public bool DoAvoidMelee = false;
        public int DoAvoidMeleeDistance = 0;
        public bool UseAlchFlask = true;
        public bool UseArcaneTorrentForDecast = true;
        public int UseArcaneTorrentForDecastAtPercentage = 100;
        public bool UseArcaneTorrentForResource = true;
        public int UseArcaneTorrentForResourceAtPercentage = 80;
        public bool UseArchimondesVengeance = true;
        public bool UseBerserking = true;
        public bool UseBloodFury = true;
        public bool UseChaosBolt = true;
        public bool UseCommandDemon = true;
        public bool UseConflagrate = true;
        public bool UseCreateHealthstone = true;
        public int UseCreateHealthstoneAtPercentage = 75;
        public bool UseCurseofEnfeeblement = false;
        public bool UseCurseoftheElements = true;
        public bool UseDarkBargain = true;
        public int UseDarkBargainAtPercentage = 40;
        public bool UseDarkIntent = true;
        public bool UseDarkRegeneration = true;
        public int UseDarkRegenerationAtPercentage = 65;
        public bool UseDarkSoul = true;
        public bool UseDrainLife = true;
        public int UseDrainLifeAtPercentage = 70;
        public bool UseEmberTap = true;
        public int UseEmberTapAtPercentage = 60;

        public bool UseFelFlame = true;
        public bool UseFireandBrimstone = true;
        public bool UseFlamesofXoroth = true;
        public bool UseGiftoftheNaaru = true;
        public int UseGiftoftheNaaruAtPercentage = 80;
        public bool UseGrimoireofSacrifice = true;
        public bool UseGrimoireofService = true;
        public bool UseHarvestLife = false;
        public bool UseHealthFunnel = true;
        public bool UseHowlofTerror = true;
        public int UseHowlofTerrorAtPercentage = 20;
        public bool UseImmolate = true;
        public bool UseIncinerate = true;
        public bool UseLifeTap = true;
        public int UseLifeTapAtPercentage = 75;

        public bool UseLowCombat = true;
        public bool UseMortalCoil = true;
        public int UseMortalCoilAtPercentage = 85;
        public bool UseRainofFire = true;
        public bool UseSacrificialPact = true;
        public int UseSacrificialPactAtPercentage = 95;
        public bool UseShadowburn = true;
        public bool UseShadowfury = true;
        public int UseShadowfuryAtPercentage = 90;
        public bool UseSoulLink = true;
        public bool UseSoulstone = true;
        public int UseSpellLockAtPercentage = 100;
        public bool UseStoneform = true;
        public int UseStoneformAtPercentage = 80;
        public bool UseSummonDoomguard = true;
        public bool UseSummonFelhunter = true;
        public bool UseSummonImp = false;
        public bool UseSummonInfernal = false;
        public bool UseSummonSuccubus = false;
        public bool UseSummonVoidwalker = false;
        public bool UseTrinketOne = true;
        public bool UseTrinketTwo = true;
        public bool UseTwilightWard = true;
        public int UseTwilightWardAtPercentage = 100;
        public bool UseUnboundWill = true;
        public bool UseUnendingResolve = true;
        public int UseUnendingResolveAtPercentage = 70;
        public bool UseWarStomp = true;
        public int UseWarStompAtPercentage = 80;

        public WarlockDestructionSettings()
        {
            /* Professions & Racials */
            AddControlInWinForm("Use Arcane Torrent for Interrupt", "UseArcaneTorrentForDecast", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Arcane Torrent for Resource", "UseArcaneTorrentForResource", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Berserking", "UseBerserking", "Professions & Racials");
            AddControlInWinForm("Use Blood Fury", "UseBloodFury", "Professions & Racials");
            AddControlInWinForm("Use Gift of the Naaru", "UseGiftoftheNaaru", "Professions & Racials", "AtPercentage");

            AddControlInWinForm("Use Stoneform", "UseStoneform", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use War Stomp", "UseWarStomp", "Professions & Racials", "AtPercentage");
            /* Warlock Buffs */
            AddControlInWinForm("Use Curse of Enfeeblement", "UseCurseofEnfeeblement", "Warlock Buffs");
            AddControlInWinForm("Use Curse of the Elements", "UseCurseoftheElements", "Warlock Buffs");
            AddControlInWinForm("Use Dark Intent", "UseDarkIntent", "Warlock Buffs");
            AddControlInWinForm("Use Grimoire of Sacrifice", "UseGrimoireofSacrifice", "Warlock Buffs");
            AddControlInWinForm("Use Soul Link ", "UseSoulLink ", "Warlock Buffs");
            AddControlInWinForm("Use Soulstone", "UseSoulstone", "Warlock Buffs");
            /* Offensive Spell */
            AddControlInWinForm("Use Chaos Bolt", "UseChaosBolt", "Offensive Spell");
            AddControlInWinForm("Use Command Demon", "UseCommandDemon", "Offensive Spell");
            AddControlInWinForm("Use Conflagrate", "UseConflagrate", "Offensive Spell");
            AddControlInWinForm("Use Fel Flame", "UseFelFlame", "Offensive Spell");
            AddControlInWinForm("Use Fire and Brimstone", "UseFireandBrimstone", "Offensive Spell");
            AddControlInWinForm("Use Harvest Life", "UseHarvestLife", "Offensive Spell");
            AddControlInWinForm("Use Immolate", "UseImmolate", "Offensive Spell");
            AddControlInWinForm("Use Incinerate", "UseIncinerate", "Offensive Spell");
            AddControlInWinForm("Use Rain of Fire", "UseRainofFire", "Offensive Spell");
            AddControlInWinForm("Use Shadowburn", "UseShadowburn", "Offensive Spell");
            AddControlInWinForm("Use Summon Imp", "UseSummonImp", "Offensive Spell");
            AddControlInWinForm("Use Summon Voidwalker", "UseSummonVoidwalker", "Offensive Spell");
            AddControlInWinForm("Use Summon Felhunter", "UseSummonFelhunter", "Offensive Spell");
            AddControlInWinForm("Use Summon Succubus", "UseSummonSuccubus", "Offensive Spell");
            /* Offensive Cooldown */
            AddControlInWinForm("Use Archimonde's Vengeance", "UseArchimondesVengeance", "Offensive Cooldown");
            AddControlInWinForm("Use Dark Soul", "UseDarkSoul", "Offensive Cooldown");
            AddControlInWinForm("Use Grimoire of Service", "UseGrimoireofService", "Offensive Cooldown");
            AddControlInWinForm("Use Summon Doomguard", "UseSummonDoomguard", "Offensive Cooldown");
            AddControlInWinForm("Use Summon Infernal", "UseSummonInfernal", "Offensive Cooldown");
            /* Defensive Cooldown */
            AddControlInWinForm("Use Dark Bargain", "UseDarkBargain", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Howl of Terror", "UseHowlofTerror", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Sacrificial Pact", "UseSacrificialPact", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Shadowfury", "UseShadowfury", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Spell Lock", "UseSpellLock", "Offensive Spell", "AtPercentage");
            AddControlInWinForm("Use Twilight Ward", "UseTwilightWard", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Unbound Will", "UseUnboundWill", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Unending Resolve", "UseUnendingResolve", "Defensive Cooldown", "AtPercentage");
            /* Healing Spell */
            AddControlInWinForm("Use Create Healthstone", "UseCreateHealthstone", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Dark Regeneration", "UseDarkRegeneration", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Drain Life", "UseDrainLife", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Ember Tap", "UseEmberTap", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Flames of Xoroth", "UseFlamesofXoroth", "Healing Spell");
            AddControlInWinForm("Use Health Funnel", "UseHealthFunnel", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Life Tap", "UseLifeTap", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Mortal Coil", "UseMortalCoil", "Healing Spell", "AtPercentage");
            /* Game Settings */
            AddControlInWinForm("Use Low Combat Settings", "UseLowCombat", "Game Settings");
            AddControlInWinForm("Use Trinket One", "UseTrinketOne", "Game Settings");
            AddControlInWinForm("Use Trinket Two", "UseTrinketTwo", "Game Settings");

            AddControlInWinForm("Use Alchemist Flask", "UseAlchFlask", "Game Settings");
            AddControlInWinForm("Do avoid melee (Off Advised!!)", "DoAvoidMelee", "Game Settings");
            AddControlInWinForm("Avoid melee distance (1 to 4)", "DoAvoidMeleeDistance", "Game Settings");
        }

        public static WarlockDestructionSettings CurrentSetting { get; set; }

        public static WarlockDestructionSettings GetSettings()
        {
            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Warlock_Destruction.xml";
            if (File.Exists(currentSettingsFile))
            {
                return
                    CurrentSetting = Load<WarlockDestructionSettings>(currentSettingsFile);
            }
            return new WarlockDestructionSettings();
        }
    }

    #endregion
}

public class WarlockAffliction
{
    private static WarlockAfflictionSettings MySettings = WarlockAfflictionSettings.GetSettings();

    #region General Timers & Variables

    private readonly WoWItem _firstTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET);
    private readonly WoWItem _secondTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET, 2);
    public int LC = 0;

    private Timer _onCd = new Timer(0);

    #endregion

    #region Professions & Racials

    public readonly Spell Alchemy = new Spell("Alchemy");
    public readonly Spell ArcaneTorrent = new Spell("Arcane Torrent");
    public readonly Spell Berserking = new Spell("Berserking");
    public readonly Spell BloodFury = new Spell("Blood Fury");

    public readonly Spell GiftoftheNaaru = new Spell("Gift of the Naaru");

    public readonly Spell Stoneform = new Spell("Stoneform");
    public readonly Spell WarStomp = new Spell("War Stomp");

    #endregion

    #region Warlock Buffs

    public readonly Spell CurseofEnfeeblement = new Spell("Curse of Enfeeblement");
    public readonly Spell CurseofExhaustion = new Spell("Curse of Exhaustion");
    public readonly Spell CurseoftheElements = new Spell("Curse of the Elements");
    public readonly Spell DarkIntent = new Spell("Dark Intent");
    public readonly Spell GrimoireofSacrifice = new Spell("Grimoire of Sacrifice");
    public readonly Spell SoulLink = new Spell("Soul Link");
    public readonly Spell Soulstone = new Spell("Soulstone");

    #endregion

    #region Offensive Spell

    public readonly Spell Agony = new Spell("Agony");
    public readonly Spell CommandDemon = new Spell("Command Demon");
    public readonly Spell Corruption = new Spell("Corruption");
    public readonly Spell DrainSoul = new Spell("Drain Soul");
    public readonly Spell FelFlame = new Spell("Fel Flame");
    public readonly Spell HarvestLife = new Spell("Harvest Life");
    public readonly Spell Haunt = new Spell("Haunt");
    public readonly Spell MaleficGrasp = new Spell("Malefic Grasp");
    public readonly Spell RainofFire = new Spell("Rain of Fire");
    public readonly Spell SeedofCorruption = new Spell("Seed of Corruption");
    public readonly Spell ShadowBolt = new Spell("Shadow Bolt");
    public readonly Spell SoulSwap = new Spell("Soul Swap");
    public readonly Spell Soulburn = new Spell("Soulburn");
    public readonly Spell SummonFelguard = new Spell("Summon Felguard");
    public readonly Spell SummonFelhunter = new Spell("Summon Felhunter");
    public readonly Spell SummonImp = new Spell("Summon Imp");
    public readonly Spell SummonSuccubus = new Spell("Summon Succubus");
    public readonly Spell SummonVoidwalker = new Spell("Summon Voidwalker");
    public readonly Spell UnstableAffliction = new Spell("Unstable Affliction");
    private Timer _agonyTimer = new Timer(0);
    private Timer _corruptionTimer = new Timer(0);
    private Timer _unstableAfflictionTimer = new Timer(0);

    #endregion

    #region Offensive Cooldown

    public readonly Spell ArchimondesVengeance = new Spell("Archimonde's Vengeance");
    public readonly Spell DarkSoul = new Spell("Dark Soul");
    public readonly Spell GrimoireofService = new Spell("Grimoire of Service");
    public readonly Spell SummonDoomguard = new Spell("Summon Doomguard");
    public readonly Spell SummonInfernal = new Spell("Summon Infernal");

    #endregion

    #region Defensive Cooldown

    public readonly Spell DarkBargain = new Spell("Dark Bargain");
    public readonly Spell HowlofTerror = new Spell("HowlofTerror");
    public readonly Spell SacrificialPact = new Spell("Sacrificial Pact");
    public readonly Spell Shadowfury = new Spell("Shadowfury");
    public readonly Spell TwilightWard = new Spell("Twilight Ward");
    public readonly Spell UnboundWill = new Spell("Unbound Will");
    public readonly Spell UnendingResolve = new Spell("Unending Resolve");

    #endregion

    #region Healing Spell

    public readonly Spell CreateHealthstone = new Spell("Create Healthstone");
    public readonly Spell DarkRegeneration = new Spell("Dark Regeneration");
    public readonly Spell DrainLife = new Spell("Drain Life");
    public readonly Spell HealthFunnel = new Spell("Health Funnel");
    public readonly Spell LifeTap = new Spell("Life Tap");
    public readonly Spell MortalCoil = new Spell("Mortal Coil");
    private Timer _healthstoneTimer = new Timer(0);

    #endregion

    public WarlockAffliction()
    {
        Main.InternalRange = 39f;
        Main.InternalAggroRange = 39f;
        MySettings = WarlockAfflictionSettings.GetSettings();
        Main.DumpCurrentSettings<WarlockAfflictionSettings>(MySettings);
        UInt128 lastTarget = 0;

        while (Main.InternalLoop)
        {
            try
            {
                if (!ObjectManager.Me.IsDeadMe)
                {
                    if (!ObjectManager.Me.IsMounted)
                    {
                        if (Fight.InFight && ObjectManager.Me.Target > 0)
                        {
                            if (ObjectManager.Me.Target != lastTarget
                                && (SoulSwap.IsHostileDistanceGood || Agony.IsHostileDistanceGood))
                            {
                                Pull();
                                lastTarget = ObjectManager.Me.Target;
                            }

                            if (MySettings.UseLowCombat && ObjectManager.Target.Level < 70 && ObjectManager.Me.Level > 84)
                            {
                                LC = 1;
                                if (CombatClass.InSpellRange(ObjectManager.Target, 0, Main.InternalRange))
                                    LowCombat();
                            }
                            else
                            {
                                LC = 0;
                                if (CombatClass.InSpellRange(ObjectManager.Target, 0, Main.InternalRange))
                                    Combat();
                            }
                        }
                        if (!ObjectManager.Me.IsCast)
                            Patrolling();
                    }
                }
                else
                    Thread.Sleep(500);
            }
            catch
            {
            }
            Thread.Sleep(100);
        }
    }

    private void Pull()
    {
        if (!Agony.TargetHaveBuff && !Corruption.TargetHaveBuff && !UnstableAffliction.TargetHaveBuff)
        {
            if (MySettings.UseSoulSwap && MySettings.UseSoulburn && Soulburn.KnownSpell && SoulSwap.KnownSpell && Soulburn.IsSpellUsable && SoulSwap.IsSpellUsable
                && SoulSwap.IsHostileDistanceGood)
            {
                if (!Soulburn.HaveBuff)
                {
                    Soulburn.Cast();
                    Others.SafeSleep(200);
                }

                SoulSwap.Cast();
                _agonyTimer = new Timer(1000*21);
                _corruptionTimer = new Timer(1000*15);
                _unstableAfflictionTimer = new Timer(1000*11);
            }
        }
    }

    private void LowCombat()
    {
        Buff();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        if (_onCd.IsReady)
            DefenseCycle();
        Heal();

        if (MySettings.UseLifeTap && LifeTap.KnownSpell && ObjectManager.Me.ManaPercentage < 75 && LifeTap.IsSpellUsable)
        {
            LifeTap.Cast();
            return;
        }

        if (MySettings.UseMaleficGrasp && MaleficGrasp.KnownSpell && MaleficGrasp.IsHostileDistanceGood && MaleficGrasp.IsSpellUsable)
        {
            MaleficGrasp.Cast();
            Others.SafeSleep(200);
            while (ObjectManager.Me.IsCast)
                Others.SafeSleep(200);
            return;
        }
        if (MySettings.UseRainofFire && RainofFire.KnownSpell && RainofFire.IsHostileDistanceGood && RainofFire.IsSpellUsable)
        {
            SpellManager.CastSpellByIDAndPosition(5740, ObjectManager.Target.Position);
            while (ObjectManager.Me.IsCast)
                Others.SafeSleep(200);
        }
    }

    private void Combat()
    {
        Buff();
        DPSBurst();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        DPSCycle();
        Decast();
        if (_onCd.IsReady)
            DefenseCycle();
        Heal();
    }

    private void Buff()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        Pet();

        if (MySettings.UseDarkIntent && DarkIntent.KnownSpell && !DarkIntent.HaveBuff && DarkIntent.IsSpellUsable)
            DarkIntent.Cast();

        if (MySettings.UseSoulLink && SoulLink.KnownSpell && !SoulLink.HaveBuff && SoulLink.IsSpellUsable
            && (ObjectManager.Pet.Health != 0 || ObjectManager.Pet.Guid != 0) && ObjectManager.Me.InCombat)
            SoulLink.Cast();

        if (MySettings.UseSoulstone && Soulstone.KnownSpell && !Soulstone.HaveBuff && Soulstone.IsSpellUsable && Usefuls.GetContainerNumFreeSlots > 0)
            Soulstone.Cast();

        if (MySettings.UseCreateHealthstone && CreateHealthstone.KnownSpell && CreateHealthstone.IsSpellUsable && ItemsManager.GetItemCount(5512) == 0 &&
            Usefuls.GetContainerNumFreeSlots > 0)
        {
            Logging.WriteFight(" - Create Healthstone - ");
            CreateHealthstone.Cast();
            while (ObjectManager.Me.IsCast)
                Others.SafeSleep(200);
        }

        if (MySettings.UseAlchFlask && !ObjectManager.Me.HaveBuff(79638) && !ObjectManager.Me.HaveBuff(79640) && !ObjectManager.Me.HaveBuff(79639)
            && !ItemsManager.IsItemOnCooldown(75525) && ItemsManager.GetItemCount(75525) > 0)
            ItemsManager.UseItem(75525);
    }

    private void Pet()
    {
        if (MySettings.UseHealthFunnel && HealthFunnel.KnownSpell && ObjectManager.Pet.HealthPercent > 0 && HealthFunnel.IsSpellUsable
            && ObjectManager.Pet.HealthPercent < 50)
        {
            HealthFunnel.Cast();
            while (ObjectManager.Me.IsCast)
            {
                if (ObjectManager.Pet.HealthPercent > 85 || ObjectManager.Pet.IsDead)
                    break;
                Others.SafeSleep(100);
            }
        }

        if (MySettings.UseSummonFelhunter && SummonFelhunter.KnownSpell && !GrimoireofSacrifice.HaveBuff && SummonFelhunter.IsSpellUsable
            && ObjectManager.Me.InCombat && (ObjectManager.Pet.Health == 0 || ObjectManager.Pet.Guid == 0))
        {
            Logging.WriteFight(" - PET DEAD - ");
            SummonFelhunter.Cast();
        }
        else if (MySettings.UseSummonImp && SummonImp.KnownSpell && !GrimoireofSacrifice.HaveBuff && SummonImp.IsSpellUsable
                 && ObjectManager.Me.InCombat && (ObjectManager.Pet.Health == 0 || ObjectManager.Pet.Guid == 0))
        {
            Logging.WriteFight(" - PET DEAD - ");
            SummonImp.Cast();
        }
        else if (MySettings.UseSummonVoidwalker && SummonVoidwalker.KnownSpell && !GrimoireofSacrifice.HaveBuff && SummonVoidwalker.IsSpellUsable
                 && ObjectManager.Me.InCombat && (ObjectManager.Pet.Health == 0 || ObjectManager.Pet.Guid == 0))
        {
            Logging.WriteFight(" - PET DEAD - ");
            SummonVoidwalker.Cast();
        }
        else if (MySettings.UseSummonSuccubus && SummonSuccubus.KnownSpell && !GrimoireofSacrifice.HaveBuff && SummonSuccubus.IsSpellUsable
                 && ObjectManager.Me.InCombat && (ObjectManager.Pet.Health == 0 || ObjectManager.Pet.Guid == 0))
        {
            Logging.WriteFight(" - PET DEAD - ");
            SummonSuccubus.Cast();
        }

        Others.SafeSleep(200);
        if (MySettings.UseGrimoireofSacrifice && GrimoireofSacrifice.KnownSpell && !GrimoireofSacrifice.HaveBuff && GrimoireofSacrifice.IsSpellUsable
            && (ObjectManager.Pet.Health != 0 || ObjectManager.Pet.Guid != 0))
            GrimoireofSacrifice.Cast();
    }

    private void AvoidMelee()
    {
        if (ObjectManager.Target.GetDistance < MySettings.DoAvoidMeleeDistance && ObjectManager.Target.InCombat)
        {
            Logging.WriteFight("Too Close. Moving Back");
            var maxTimeTimer = new Timer(1000*2);
            MovementsAction.MoveBackward(true);
            while (ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat && !maxTimeTimer.IsReady)
                Others.SafeSleep(300);
            MovementsAction.MoveBackward(false);
            if (maxTimeTimer.IsReady && ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat)
            {
                MovementsAction.MoveForward(true);
                Others.SafeSleep(1000);
                MovementsAction.MoveForward(false);
                MovementManager.Face(ObjectManager.Target.Position);
            }
        }
    }

    private void DefenseCycle()
    {
        if (MySettings.UseUnendingResolve && UnendingResolve.KnownSpell && UnendingResolve.IsSpellUsable
            && ObjectManager.Me.HealthPercent <= MySettings.UseUnendingResolveAtPercentage)
        {
            UnendingResolve.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (MySettings.UseHowlofTerror && HowlofTerror.KnownSpell && ObjectManager.Target.GetDistance < 8 && HowlofTerror.IsSpellUsable
            && ObjectManager.Me.HealthPercent <= MySettings.UseHowlofTerrorAtPercentage)
        {
            HowlofTerror.Cast();
            return;
        }
        if (MySettings.UseDarkBargain && DarkBargain.KnownSpell && DarkBargain.IsSpellUsable
            && ObjectManager.Me.HealthPercent <= MySettings.UseDarkBargainAtPercentage)
        {
            DarkBargain.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (MySettings.UseSacrificialPact && SacrificialPact.KnownSpell && SacrificialPact.IsSpellUsable
            && ObjectManager.Me.HealthPercent <= MySettings.UseSacrificialPactAtPercentage
            && (ObjectManager.Pet.Health != 0 || ObjectManager.Pet.Guid != 0))
        {
            SacrificialPact.Cast();
            _onCd = new Timer(1000*10);
            return;
        }
        if (MySettings.UseShadowfury && Shadowfury.KnownSpell && Shadowfury.IsHostileDistanceGood && Shadowfury.IsSpellUsable
            && ObjectManager.Me.HealthPercent <= MySettings.UseShadowfuryAtPercentage)
        {
            SpellManager.CastSpellByIDAndPosition(30283, ObjectManager.Target.Position);
            _onCd = new Timer(1000*3);
            return;
        }
        if (MySettings.UseWarStomp && WarStomp.KnownSpell && ObjectManager.Me.HealthPercent <= MySettings.UseWarStompAtPercentage && WarStomp.IsSpellUsable)
        {
            WarStomp.Cast();
            _onCd = new Timer(1000*2);
            return;
        }
        if (MySettings.UseStoneform && Stoneform.KnownSpell && ObjectManager.Me.HealthPercent <= MySettings.UseStoneformAtPercentage && Stoneform.IsSpellUsable)
        {
            Stoneform.Cast();
            _onCd = new Timer(1000*8);
        }
    }

    private void Heal()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (MySettings.UseArcaneTorrentForResource && ArcaneTorrent.KnownSpell && ArcaneTorrent.IsSpellUsable
            && ObjectManager.Me.ManaPercentage <= MySettings.UseArcaneTorrentForResourceAtPercentage)
        {
            ArcaneTorrent.Cast();
            return;
        }
        if (MySettings.UseGiftoftheNaaru && GiftoftheNaaru.KnownSpell && GiftoftheNaaru.IsSpellUsable
            && ObjectManager.Me.HealthPercent <= MySettings.UseGiftoftheNaaruAtPercentage)
        {
            GiftoftheNaaru.Cast();
            return;
        }
        if (MySettings.UseDarkRegeneration && DarkRegeneration.KnownSpell && DarkRegeneration.IsSpellUsable
            && ObjectManager.Me.HealthPercent <= MySettings.UseDarkRegenerationAtPercentage)
        {
            DarkRegeneration.Cast();
            return;
        }
        if (MySettings.UseCreateHealthstone && _healthstoneTimer.IsReady && ItemsManager.GetItemCount(5512) > 0
            && ObjectManager.Me.HealthPercent <= MySettings.UseCreateHealthstoneAtPercentage)
        {
            Logging.WriteFight("Use Healthstone.");
            ItemsManager.UseItem("Healthstone");
            _healthstoneTimer = new Timer(1000*60*2);
            return;
        }
        if (MySettings.UseMortalCoil && MortalCoil.KnownSpell && MortalCoil.IsHostileDistanceGood && MortalCoil.IsSpellUsable
            && ObjectManager.Me.HealthPercent <= MySettings.UseMortalCoilAtPercentage)
        {
            MortalCoil.Cast();
            return;
        }
        if (MySettings.UseDrainLife && DrainLife.KnownSpell && DrainLife.IsHostileDistanceGood && DrainLife.IsSpellUsable
            && ObjectManager.Me.HealthPercent <= MySettings.UseDrainLifeAtPercentage)
        {
            DrainLife.Cast();
            while (ObjectManager.Me.IsCast)
                Others.SafeSleep(200);
        }
    }

    private void Decast()
    {
        if (MySettings.UseArcaneTorrentForDecast && ArcaneTorrent.KnownSpell && ObjectManager.Target.GetDistance < 8 && ArcaneTorrent.IsSpellUsable
            && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe
            && ObjectManager.Me.HealthPercent <= MySettings.UseArcaneTorrentForDecastAtPercentage)
        {
            ArcaneTorrent.Cast();
            return;
        }
        if (MySettings.UseTwilightWard && TwilightWard.KnownSpell && TwilightWard.IsSpellUsable
            && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe
            && ObjectManager.Me.HealthPercent <= MySettings.UseTwilightWardAtPercentage)
        {
            TwilightWard.Cast();
            return;
        }
        if (MySettings.UseCommandDemon && MySettings.UseSummonFelhunter && CommandDemon.KnownSpell && ObjectManager.Target.GetDistance <= 40f && CommandDemon.IsSpellUsable
            && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe)
        {
            CommandDemon.Cast();
        }
    }

    private void DPSBurst()
    {
        if (MySettings.UseTrinketOne && !ItemsManager.IsItemOnCooldown(_firstTrinket.Entry) && ItemsManager.IsItemUsable(_firstTrinket.Entry))
        {
            ItemsManager.UseItem(_firstTrinket.Name);
            Logging.WriteFight("Use First Trinket Slot");
        }
        if (MySettings.UseTrinketTwo && !ItemsManager.IsItemOnCooldown(_secondTrinket.Entry) && ItemsManager.IsItemUsable(_secondTrinket.Entry))
        {
            ItemsManager.UseItem(_secondTrinket.Name);
            Logging.WriteFight("Use Second Trinket Slot");
        }
        if (MySettings.UseBerserking && Berserking.KnownSpell && ObjectManager.Target.GetDistance <= 40f && Berserking.IsSpellUsable)
        {
            Berserking.Cast();
            return;
        }
        if (MySettings.UseBloodFury && BloodFury.KnownSpell && ObjectManager.Target.GetDistance <= 40f && BloodFury.IsSpellUsable)
        {
            BloodFury.Cast();
        }
        if (DarkSoul.KnownSpell && DarkSoul.IsSpellUsable
            && MySettings.UseDarkSoul && ObjectManager.Target.GetDistance <= 40f)
        {
            DarkSoul.Cast();
        }
        if (MySettings.UseSummonDoomguard && SummonDoomguard.KnownSpell && SummonDoomguard.IsHostileDistanceGood && SummonDoomguard.IsSpellUsable)
        {
            SummonDoomguard.Cast();
            return;
        }
        if (MySettings.UseSummonInfernal && SummonInfernal.KnownSpell && SummonInfernal.IsHostileDistanceGood && SummonInfernal.IsSpellUsable)
        {
            SpellManager.CastSpellByIDAndPosition(1122, ObjectManager.Target.Position);
        }
        if (MySettings.UseArchimondesVengeance && ArchimondesVengeance.KnownSpell && ObjectManager.Target.GetDistance <= 40f && ArchimondesVengeance.IsSpellUsable)
        {
            ArchimondesVengeance.Cast();
        }
        if (MySettings.UseGrimoireofService && GrimoireofService.KnownSpell && ObjectManager.Target.GetDistance <= 40f && GrimoireofService.IsSpellUsable)
        {
            GrimoireofService.Cast();
        }
    }

    private void DPSCycle()
    {
        Usefuls.SleepGlobalCooldown();
        try
        {
            Memory.WowMemory.GameFrameLock(); // !!! WARNING - DONT SLEEP WHILE LOCKED - DO FINALLY(GameFrameUnLock()) !!!

            if (MySettings.UseCurseoftheElements && CurseoftheElements.KnownSpell && CurseoftheElements.IsHostileDistanceGood && CurseoftheElements.IsSpellUsable
                && !CurseoftheElements.TargetHaveBuff)
            {
                CurseoftheElements.Cast();
                return;
            }
            if (MySettings.UseCurseofEnfeeblement && !MySettings.UseCurseoftheElements && CurseofEnfeeblement.KnownSpell && CurseofEnfeeblement.IsSpellUsable
                && CurseofEnfeeblement.IsHostileDistanceGood && !CurseofEnfeeblement.TargetHaveBuff)
            {
                CurseofEnfeeblement.Cast();
                return;
            }
            if (MySettings.UseCurseofExhaustion && !MySettings.UseCurseoftheElements && !MySettings.UseCurseofEnfeeblement && CurseofExhaustion.KnownSpell &&
                CurseofExhaustion.IsSpellUsable
                && CurseofExhaustion.IsHostileDistanceGood && !CurseofExhaustion.TargetHaveBuff)
            {
                CurseofExhaustion.Cast();
                return;
            }

            if (MySettings.UseLifeTap && LifeTap.KnownSpell && ObjectManager.Me.ManaPercentage <= MySettings.UseLifeTapAtPercentage && LifeTap.IsSpellUsable)
            {
                LifeTap.Cast();
                return;
            }

            if (ObjectManager.Target.HealthPercent < 20 && MySettings.UseDrainSoul)
            {
                if (DrainSoul.KnownSpell && DrainSoul.IsHostileDistanceGood && DrainSoul.IsSpellUsable)
                {
                    DrainSoul.Cast();
                    while (ObjectManager.Me.IsCast && !_agonyTimer.IsReady && !_corruptionTimer.IsReady && !_unstableAfflictionTimer.IsReady)
                        Others.SafeSleep(200);
                }

                if (_agonyTimer.IsReady || _corruptionTimer.IsReady || _unstableAfflictionTimer.IsReady)
                {
                    if (MySettings.UseSoulburn && MySettings.UseSoulSwap && Soulburn.KnownSpell && SoulSwap.KnownSpell && Soulburn.IsSpellUsable && SoulSwap.IsSpellUsable
                        && SoulSwap.IsHostileDistanceGood)
                    {
                        Soulburn.Cast();
                        Others.SafeSleep(200);
                        SoulSwap.Cast();
                        _agonyTimer = new Timer(1000*21);
                        _corruptionTimer = new Timer(1000*15);
                        _unstableAfflictionTimer = new Timer(1000*11);
                    }
                }
            }

            if (ObjectManager.GetNumberAttackPlayer() > 4)
            {
                if (MySettings.UseSoulburn && MySettings.UseSeedofCorruption && Soulburn.KnownSpell && SeedofCorruption.KnownSpell
                    && !Corruption.TargetHaveBuff && Soulburn.IsSpellUsable && SeedofCorruption.IsSpellUsable && SeedofCorruption.IsHostileDistanceGood)
                {
                    Soulburn.Cast();
                    Others.SafeSleep(200);
                    SeedofCorruption.Cast();
                    return;
                }
                if (MySettings.UseHarvestLife && HarvestLife.KnownSpell && HarvestLife.IsHostileDistanceGood && HarvestLife.IsSpellUsable)
                {
                    HarvestLife.Cast();
                    while (ObjectManager.Me.IsCast)
                        Others.SafeSleep(200);
                    return;
                }
                if (MySettings.UseHarvestLife && DrainLife.KnownSpell && DrainLife.IsSpellUsable && DrainLife.IsHostileDistanceGood && !HarvestLife.KnownSpell)
                {
                    DrainLife.Cast();
                    while (ObjectManager.Me.IsCast)
                        Others.SafeSleep(200);
                    return;
                }
                if (MySettings.UseRainofFire && RainofFire.KnownSpell && RainofFire.IsHostileDistanceGood && RainofFire.IsSpellUsable)
                {
                    SpellManager.CastSpellByIDAndPosition(5740, ObjectManager.Target.Position);
                    while (ObjectManager.Me.IsCast)
                        Others.SafeSleep(200);
                    return;
                }
            }

            if (MySettings.UseAgony && Agony.KnownSpell && Agony.IsHostileDistanceGood && Agony.IsSpellUsable && (!Agony.TargetHaveBuff || _agonyTimer.IsReady))
            {
                Agony.Cast();
                _agonyTimer = new Timer(1000*21);
            }

            if (MySettings.UseCorruption && Corruption.KnownSpell && Corruption.IsHostileDistanceGood && Corruption.IsSpellUsable
                && (!Corruption.TargetHaveBuff || _corruptionTimer.IsReady))
            {
                Corruption.Cast();
                _corruptionTimer = new Timer(1000*15);
            }

            if (MySettings.UseUnstableAffliction && UnstableAffliction.KnownSpell && UnstableAffliction.IsHostileDistanceGood && UnstableAffliction.IsSpellUsable
                && (!UnstableAffliction.TargetHaveBuff || _unstableAfflictionTimer.IsReady))
            {
                UnstableAffliction.Cast();
                _unstableAfflictionTimer = new Timer(1000*11);
            }

            if (MySettings.UseHaunt && Haunt.KnownSpell && Haunt.IsHostileDistanceGood && !Haunt.TargetHaveBuff && Haunt.IsSpellUsable)
            {
                Haunt.Cast();
                return;
            }
            // Blizzard API Calls for Malefic Grasp using Shadow Bolt Function
            if (MySettings.UseMaleficGrasp && !ObjectManager.Me.IsCast && ShadowBolt.KnownSpell && ShadowBolt.IsHostileDistanceGood && ShadowBolt.IsSpellUsable
                && !_agonyTimer.IsReady && !_corruptionTimer.IsReady && !_unstableAfflictionTimer.IsReady)
            {
                ShadowBolt.Cast();
            }
        }
        finally
        {
            Memory.WowMemory.GameFrameUnLock();
        }
    }

    private void Patrolling()
    {
        if (ObjectManager.Me.IsMounted) return;
        Buff();
        Heal();
    }

    #region Nested type: WarlockAfflictionSettings

    [Serializable]
    public class WarlockAfflictionSettings : Settings
    {
        public bool DoAvoidMelee = false;
        public int DoAvoidMeleeDistance = 0;
        public bool UseAgony = true;
        public bool UseAlchFlask = true;
        public bool UseArcaneTorrentForDecast = true;
        public int UseArcaneTorrentForDecastAtPercentage = 100;
        public bool UseArcaneTorrentForResource = true;
        public int UseArcaneTorrentForResourceAtPercentage = 80;
        public bool UseArchimondesVengeance = true;
        public bool UseBerserking = true;
        public bool UseBloodFury = true;
        public bool UseCommandDemon = true;
        public bool UseCorruption = true;
        public bool UseCreateHealthstone = true;
        public int UseCreateHealthstoneAtPercentage = 75;
        public bool UseCurseofEnfeeblement = false;
        public bool UseCurseofExhaustion = false;
        public bool UseCurseoftheElements = true;
        public bool UseDarkBargain = true;
        public int UseDarkBargainAtPercentage = 40;
        public bool UseDarkIntent = true;
        public bool UseDarkRegeneration = true;
        public int UseDarkRegenerationAtPercentage = 65;
        public bool UseDarkSoul = true;
        public bool UseDrainLife = true;
        public int UseDrainLifeAtPercentage = 70;
        public bool UseDrainSoul = true;

        public bool UseFelFlame = true;
        public bool UseGiftoftheNaaru = true;
        public int UseGiftoftheNaaruAtPercentage = 80;
        public bool UseGrimoireofSacrifice = true;
        public bool UseGrimoireofService = true;
        public bool UseHarvestLife = false;
        public bool UseHaunt = true;
        public bool UseHealthFunnel = true;
        public bool UseHowlofTerror = true;
        public int UseHowlofTerrorAtPercentage = 20;
        public bool UseLifeTap = true;
        public int UseLifeTapAtPercentage = 75;
        public bool UseLowCombat = true;
        public bool UseMaleficGrasp = true;
        public bool UseMortalCoil = true;
        public int UseMortalCoilAtPercentage = 85;
        public bool UseRainofFire = true;
        public bool UseSacrificialPact = true;
        public int UseSacrificialPactAtPercentage = 95;
        public bool UseSeedofCorruption = true;
        public bool UseShadowBolt = true;
        public bool UseShadowfury = true;
        public int UseShadowfuryAtPercentage = 90;
        public bool UseSoulLink = true;
        public bool UseSoulSwap = true;
        public bool UseSoulburn = true;
        public bool UseSoulstone = true;
        public bool UseStoneform = true;
        public int UseStoneformAtPercentage = 80;
        public bool UseSummonDoomguard = true;
        public bool UseSummonFelhunter = true;
        public bool UseSummonImp = false;
        public bool UseSummonInfernal = false;
        public bool UseSummonSuccubus = false;
        public bool UseSummonVoidwalker = false;
        public bool UseTrinketOne = true;
        public bool UseTrinketTwo = true;
        public bool UseTwilightWard = true;
        public int UseTwilightWardAtPercentage = 100;
        public bool UseUnboundWill = true;
        public bool UseUnendingResolve = true;
        public int UseUnendingResolveAtPercentage = 70;
        public bool UseUnstableAffliction = true;
        public bool UseWarStomp = true;
        public int UseWarStompAtPercentage = 80;

        public WarlockAfflictionSettings()
        {
            ConfigWinForm("Warlock Affliction Settings");
            /* Professions & Racials */
            AddControlInWinForm("Use Arcane Torrent for Interrupt", "UseArcaneTorrentForDecast", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Arcane Torrent for Resource", "UseArcaneTorrentForResource", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Berserking", "UseBerserking", "Professions & Racials");
            AddControlInWinForm("Use Blood Fury", "UseBloodFury", "Professions & Racials");
            AddControlInWinForm("Use Gift of the Naaru", "UseGiftoftheNaaru", "Professions & Racials");

            AddControlInWinForm("Use Stoneform", "UseStoneform", "Professions & Racials");
            AddControlInWinForm("Use War Stomp", "UseWarStomp", "Professions & Racials");
            /* Warlock Buffs */
            AddControlInWinForm("Use Curse of Enfeeblement", "UseCurseofEnfeeblement", "Warlock Buffs");
            AddControlInWinForm("Use Curse of Exhaustion", "UseCurseofExhaustion", "Warlock Buffs");
            AddControlInWinForm("Use Curse of the Elements", "UseCurseoftheElements", "Warlock Buffs");
            AddControlInWinForm("Use Dark Intent", "UseDarkIntent", "Warlock Buffs");
            AddControlInWinForm("Use Grimoire of Sacrifice", "UseGrimoireofSacrifice", "Warlock Buffs");
            AddControlInWinForm("Use Soul Link ", "UseSoulLink ", "Warlock Buffs");
            AddControlInWinForm("Use Soulstone", "UseSoulstone", "Warlock Buffs");
            /* Offensive Spell */
            AddControlInWinForm("Use Agony", "UseAgony", "Offensive Spell");
            AddControlInWinForm("Use Command Demon", "UseCommandDemon", "Offensive Spell");
            AddControlInWinForm("Use Corruption", "UseCorruption", "Offensive Spell");
            AddControlInWinForm("Use Drain Soul", "UseDrainSoul", "Offensive Spell");
            AddControlInWinForm("Use Fel Flame", "UseFelFlame", "Offensive Spell");
            AddControlInWinForm("Use Harvest Life", "UseHarvestLife", "Offensive Spell");
            AddControlInWinForm("Use Haunt", "UseHaunt", "Offensive Spell");
            AddControlInWinForm("Use Malefic Grasp", "UseMaleficGrasp", "Offensive Spell");
            AddControlInWinForm("Use Rain of Fire", "UseRainofFire", "Offensive Spell");
            AddControlInWinForm("Use Seed of Corruption", "UseSeedofCorruption", "Offensive Spell");
            AddControlInWinForm("Use Shadow Bolt", "UseShadowBolt", "Offensive Spell");
            AddControlInWinForm("Use Soul Swap", "UseSoulSwap", "Offensive Spell");
            AddControlInWinForm("Use Soulburn", "UseSoulburn", "Offensive Spell");
            AddControlInWinForm("Use Summon Imp", "UseSummonImp", "Offensive Spell");
            AddControlInWinForm("Use Summon Voidwalker", "UseSummonVoidwalker", "Offensive Spell");
            AddControlInWinForm("Use Summon Felhunter", "UseSummonFelhunter", "Offensive Spell");
            AddControlInWinForm("Use Summon Succubus", "UseSummonSuccubus", "Offensive Spell");
            AddControlInWinForm("Use Unstable Affliction", "UseUnstableAffliction", "Offensive Spell");
            /* Offensive Cooldown */
            AddControlInWinForm("Use Archimonde's Vengeance", "UseArchimondesVengeance", "Offensive Cooldown");
            AddControlInWinForm("Use Dark Soul", "UseDarkSoul", "Offensive Cooldown");
            AddControlInWinForm("Use Grimoire of Service", "UseGrimoireofService", "Offensive Cooldown");
            AddControlInWinForm("Use Summon Doomguard", "UseSummonDoomguard", "Offensive Cooldown");
            AddControlInWinForm("Use Summon Infernal", "UseSummonInfernal", "Offensive Cooldown");
            /* Defensive Cooldown */
            AddControlInWinForm("Use Dark Bargain", "UseDarkBargain", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Howl of Terror", "UseHowlofTerror", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Sacrificial Pact", "UseSacrificialPact", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Shadowfury", "UseShadowfury", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Twilight Ward", "UseTwilightWard", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Unbound Will", "UseUnboundWill", "Defensive Cooldown");
            AddControlInWinForm("Use Unending Resolve", "UseUnendingResolve", "Defensive Cooldown", "AtPercentage");
            /* Healing Spell */
            AddControlInWinForm("Use Create Healthstone", "UseCreateHealthstone", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Dark Regeneration", "UseDarkRegeneration", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Drain Life", "UseDrainLife", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Health Funnel", "UseHealthFunnel", "Healing Spell");
            AddControlInWinForm("Use Life Tap", "UseLifeTap", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Mortal Coil", "UseMortalCoil", "Healing Spell", "AtPercentage");
            /* Game Settings */
            AddControlInWinForm("Use Low Combat Settings", "UseLowCombat", "Game Settings");
            AddControlInWinForm("Use Trinket One", "UseTrinketOne", "Game Settings");
            AddControlInWinForm("Use Trinket Two", "UseTrinketTwo", "Game Settings");

            AddControlInWinForm("Use Alchemist Flask", "UseAlchFlask", "Game Settings");
            AddControlInWinForm("Do avoid melee (Off Advised!!)", "DoAvoidMelee", "Game Settings");
            AddControlInWinForm("Avoid melee distance (1 to 4)", "DoAvoidMeleeDistance", "Game Settings");
        }

        public static WarlockAfflictionSettings CurrentSetting { get; set; }

        public static WarlockAfflictionSettings GetSettings()
        {
            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Warlock_Affliction.xml";
            if (File.Exists(currentSettingsFile))
            {
                return
                    CurrentSetting = Load<WarlockAfflictionSettings>(currentSettingsFile);
            }
            return new WarlockAfflictionSettings();
        }
    }

    #endregion
}

#endregion

#region Druid

public class DruidBalance
{
    private static DruidBalanceSettings MySettings = DruidBalanceSettings.GetSettings();

    #region General Timers & Variables

    private readonly WoWItem _firstTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET);
    private readonly WoWItem _secondTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET, 2);

    private Timer _onCd = new Timer(0);

    #endregion

    #region Professions & Racials

    public readonly Spell Alchemy = new Spell("Alchemy");
    public readonly Spell ArcaneTorrent = new Spell("Arcane Torrent");
    public readonly Spell Berserking = new Spell("Berserking");
    public readonly Spell BloodFury = new Spell("Blood Fury");

    public readonly Spell GiftoftheNaaru = new Spell("Gift of the Naaru");

    public readonly Spell Stoneform = new Spell("Stoneform");
    public readonly Spell WarStomp = new Spell("War Stomp");

    #endregion

    #region Druid Buffs

    public readonly Spell Dash = new Spell("Dash");
    public readonly Spell FaerieFire = new Spell("Faerie Fire");
    public readonly Spell MarkoftheWild = new Spell("Mark of the Wild");
    public readonly Spell MoonkinForm = new Spell("Moonkin Form");
    public readonly Spell StampedingRoar = new Spell("Stampeding Roar");
    public readonly Spell Euphoria = new Spell("Euphoria");

    #endregion

    #region Offensive Spell

    public readonly Spell Hurricane = new Spell("Hurricane");
    public readonly Spell Moonfire = new Spell("Moonfire");
    public readonly Spell Starfall = new Spell("Starfall");
    public readonly Spell Starfire = new Spell("Starfire");
    public readonly Spell Starsurge = new Spell("Starsurge");
    public readonly Spell Sunfire = new Spell("Sunfire");
    public readonly Spell WildMushroom = new Spell("Wild Mushroom");
    public readonly Spell WildMushroomDetonate = new Spell("Wild Mushroom: Detonate");
    public readonly Spell Wrath = new Spell("Wrath");
    private Timer _moonfireTimer = new Timer(0);
    private Timer _sunfireTimer = new Timer(0);
    private Timer _starsurgeTimer = new Timer(0);
    private Timer _starfallTimer = new Timer(0);

    #endregion

    #region Offensive Cooldown

    public readonly Spell AstralCommunion = new Spell("Astral Communion");
    public readonly Spell CelestialAlignment = new Spell("Celestial Alignment");
    public readonly Spell ForceofNature = new Spell("Force of Nature");
    public readonly Spell HeartoftheWild = new Spell("Heart of the Wild");
    public readonly Spell Incarnation = new Spell("Incarnation: Chosen of Elune");
    public readonly Spell NaturesVigil = new Spell("Nature's Vigil");

    #endregion

    #region Defensive Cooldown

    public readonly Spell Barkskin = new Spell("Barkskin");
    public readonly Spell DisorientingRoar = new Spell("Disorienting Roar");
    public readonly Spell EntanglingRoots = new Spell("Entangling Roots");
    public readonly Spell MassEntanglement = new Spell("Mass Entanglement");
    public readonly Spell MightyBash = new Spell("Mighty Bash");
    public readonly Spell NaturesGrasp = new Spell("Nature's Grasp");
    public readonly Spell SolarBeam = new Spell("Solar Beam");
    public readonly Spell Typhoon = new Spell("Typhoon");
    public readonly Spell UrsolsVortex = new Spell("Ursol's Vortex");
    public readonly Spell WildCharge = new Spell("Wild Charge");

    #endregion

    #region Healing Spell

    public readonly Spell CenarionWard = new Spell("Cenarion Ward");
    public readonly Spell HealingTouch = new Spell("Healing Touch");
    public readonly Spell Innervate = new Spell("Innervate");
    public readonly Spell MightofUrsoc = new Spell("Might of Ursoc");
    public readonly Spell NaturesSwiftness = new Spell("Nature's Swiftness");
    public readonly Spell Rejuvenation = new Spell("Rejuvenation");
    public readonly Spell Renewal = new Spell("Renewal");
    public readonly Spell Tranquility = new Spell("Tranquility");
    private Timer _healingTouchTimer = new Timer(0);

    #endregion

    public DruidBalance()
    {
        Main.InternalRange = 39f;
        Main.InternalAggroRange = 39f;
        MySettings = DruidBalanceSettings.GetSettings();
        Main.DumpCurrentSettings<DruidBalanceSettings>(MySettings);
        UInt128 lastTarget = 0;

        while (Main.InternalLoop)
        {
            try
            {
                if (!ObjectManager.Me.IsMounted)
                {
                    if (Fight.InFight && ObjectManager.Me.Target > 0)
                    {
                        if (ObjectManager.Me.Target != lastTarget
                            && (Moonfire.IsHostileDistanceGood || Sunfire.IsHostileDistanceGood))
                        {
                            Pull();
                            lastTarget = ObjectManager.Me.Target;
                        }

                        if (ObjectManager.Target.Level < 70 && ObjectManager.Me.Level > 84
                            && MySettings.UseLowCombat)
                        {
                            if (CombatClass.InSpellRange(ObjectManager.Target, 0, Main.InternalRange))
                                LowCombat();
                        }
                        else
                        {
                            if (CombatClass.InSpellRange(ObjectManager.Target, 0, Main.InternalRange))
                                Combat();
                        }
                    }
                    if (!ObjectManager.Me.IsCast)
                        Patrolling();
                }
            }
            catch
            {
            }
            Thread.Sleep(100);
        }
    }

    private void Pull()
    {
        if (!ObjectManager.Me.HaveBuff(24858) && MySettings.UseMoonkinForm)
        {
            MoonkinForm.Cast();
        }
        if (Moonfire.KnownSpell && Moonfire.IsHostileDistanceGood && Moonfire.IsSpellUsable
            && MySettings.UseMoonfire)
        {
            Moonfire.Cast();
            _moonfireTimer = new Timer(1000*37);
            return;
        }
        if (Sunfire.IsHostileDistanceGood && Sunfire.IsSpellUsable && MySettings.UseSunfire)
        {
            Sunfire.Cast();
            _sunfireTimer = new Timer(1000*21);
        }
    }

    private void LowCombat()
    {
        Buff();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        DefenseCycle();
        Heal(); 

        if (!ObjectManager.Me.HaveBuff(24858) && MySettings.UseMoonkinForm)
        {
            MoonkinForm.Cast();
            return;
        }

        if (Moonfire.KnownSpell && Moonfire.IsHostileDistanceGood && Moonfire.IsSpellUsable
            && !ObjectManager.Target.HaveBuff(164812) && MySettings.UseMoonfire)
        {
            Moonfire.Cast();
            return;
        }
        if (Sunfire.IsHostileDistanceGood && Sunfire.IsSpellUsable
            && !ObjectManager.Target.HaveBuff(164815) && MySettings.UseSunfire)
        {
            Sunfire.Cast();
            return;
        }
        if (Starsurge.KnownSpell && Starsurge.IsHostileDistanceGood && Starsurge.IsSpellUsable && _starsurgeTimer.IsReady
            && MySettings.UseStarsurge && !ObjectManager.Me.HaveBuff(164547) && !ObjectManager.Me.HaveBuff(164545))
        {
            Starsurge.Cast();
            _starsurgeTimer = new Timer(1000*5);
            return;
        }
        if (Starfire.KnownSpell && Starfire.IsHostileDistanceGood && Starfire.IsSpellUsable
            && MySettings.UseStarfire)
        {
            Starfire.Cast();
            return;
        }
        if (Wrath.KnownSpell && Wrath.IsHostileDistanceGood && Wrath.IsSpellUsable
            && MySettings.UseWrath)
        {
            Wrath.Cast();
            return;
        }

        if (Hurricane.KnownSpell && Hurricane.IsHostileDistanceGood && Hurricane.IsSpellUsable
            && MySettings.UseHurricane)
        {
            Hurricane.Cast();
        }
    }

    private void Combat()
    {
        Buff();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        if (_onCd.IsReady)
            DefenseCycle();
        DPSCycle();
        Heal();
        Decast();
        DPSCycle();
        DPSBurst();
        DPSCycle();
    }

    private void Buff()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (MySettings.UseAlchFlask && !ObjectManager.Me.HaveBuff(79638) && !ObjectManager.Me.HaveBuff(79640) && !ObjectManager.Me.HaveBuff(79639)
            && !ItemsManager.IsItemOnCooldown(75525) && ItemsManager.GetItemCount(75525) > 0)
        {
            ItemsManager.UseItem(75525);
            return;
        }
        if (MarkoftheWild.KnownSpell && MarkoftheWild.IsSpellUsable && !MarkoftheWild.HaveBuff
            && MySettings.UseMarkoftheWild)
        {
            MarkoftheWild.Cast();
            return;
        }
        if (!ObjectManager.Me.InCombat && MySettings.UseDash
            && Dash.KnownSpell && Dash.IsSpellUsable && !Dash.HaveBuff && !StampedingRoar.HaveBuff
            && ObjectManager.Me.GetMove)
        {
            Dash.Cast();
            return;
        }
        if (!ObjectManager.Me.InCombat && MySettings.UseStampedingRoar
            && StampedingRoar.KnownSpell && StampedingRoar.IsSpellUsable && !Dash.HaveBuff
            && !StampedingRoar.HaveBuff && ObjectManager.Me.GetMove)
        {
            StampedingRoar.Cast();
        }

        if (MySettings.UseMoonkinForm && MoonkinForm.KnownSpell && !ObjectManager.Me.HaveBuff(24858))
        {
            MoonkinForm.Cast();
            return;
        }
    }

    private void AvoidMelee()
    {
        if (ObjectManager.Target.GetDistance < MySettings.DoAvoidMeleeDistance && ObjectManager.Target.InCombat)
        {
            Logging.WriteFight("Too Close. Moving Back");
            var maxTimeTimer = new Timer(1000*2);
            MovementsAction.MoveBackward(true);
            while (ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat && !maxTimeTimer.IsReady)
                Others.SafeSleep(300);
            MovementsAction.MoveBackward(false);
            if (maxTimeTimer.IsReady && ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat)
            {
                MovementsAction.MoveForward(true);
                Others.SafeSleep(1000);
                MovementsAction.MoveForward(false);
                MovementManager.Face(ObjectManager.Target.Position);
            }
        }
    }

    private void DefenseCycle()
    {
        if (MySettings.UseMoonkinForm && MoonkinForm.KnownSpell && !ObjectManager.Me.HaveBuff(24858))
        {
            MoonkinForm.Cast();
        }

        if (ObjectManager.Me.HealthPercent <= MySettings.UseStoneformAtPercentage && Stoneform.IsSpellUsable &&
            Stoneform.KnownSpell
            && MySettings.UseStoneform)
        {
            Stoneform.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 80 && Barkskin.KnownSpell && Barkskin.IsSpellUsable
            && MySettings.UseBarkskin)
        {
            Barkskin.Cast();
            _onCd = new Timer(1000*12);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 80 && MightyBash.KnownSpell && MightyBash.IsSpellUsable
            && MySettings.UseMightyBash && MightyBash.IsHostileDistanceGood)
        {
            MightyBash.Cast();
            _onCd = new Timer(1000*5);
            return;
        }
        if (MassEntanglement.KnownSpell && MassEntanglement.IsSpellUsable && MassEntanglement.IsHostileDistanceGood
            && MySettings.UseMassEntanglement && ObjectManager.Me.HealthPercent < 80)
        {
            MassEntanglement.Cast();

            if (WildCharge.KnownSpell && WildCharge.IsHostileDistanceGood && WildCharge.IsSpellUsable
                && MySettings.UseWildCharge)
            {
                Others.SafeSleep(200);
                WildCharge.Cast();
            }
            return;
        }
        if (UrsolsVortex.KnownSpell && UrsolsVortex.IsSpellUsable && UrsolsVortex.IsHostileDistanceGood
            && MySettings.UseUrsolsVortex && ObjectManager.Me.HealthPercent < 80)
        {
            UrsolsVortex.Cast();

            if (WildCharge.KnownSpell && WildCharge.IsHostileDistanceGood && WildCharge.IsSpellUsable
                && MySettings.UseWildCharge)
            {
                Others.SafeSleep(200);
                WildCharge.Cast();
            }
            return;
        }
        if (NaturesGrasp.KnownSpell && NaturesGrasp.IsSpellUsable
            && ObjectManager.Target.IsCast && MySettings.UseNaturesGrasp && ObjectManager.Me.HealthPercent < 80)
        {
            NaturesGrasp.Cast();

            if (WildCharge.KnownSpell && WildCharge.IsHostileDistanceGood && WildCharge.IsSpellUsable
                && MySettings.UseWildCharge)
            {
                Others.SafeSleep(200);
                WildCharge.Cast();
            }
            return;
        }
        if (Typhoon.KnownSpell && Typhoon.IsSpellUsable && ObjectManager.GetNumberAttackPlayer() > 2
            && ObjectManager.Target.GetDistance <= 40f && ObjectManager.Me.HealthPercent < 70
            && MySettings.UseTyphoon)
        {
            Typhoon.Cast();
            return;
        }
        if (DisorientingRoar.KnownSpell && DisorientingRoar.IsSpellUsable &&
            ObjectManager.GetNumberAttackPlayer() > 2
            && ObjectManager.Target.GetDistance < 10 && ObjectManager.Me.HealthPercent < 70
            && MySettings.UseDisorientingRoar)
        {
            DisorientingRoar.Cast();
            _onCd = new Timer(1000*3);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseWarStompAtPercentage && WarStomp.IsSpellUsable &&
            WarStomp.KnownSpell
            && MySettings.UseWarStomp)
        {
            WarStomp.Cast();
            _onCd = new Timer(1000*2);
        }
    }

    private void Heal()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (ArcaneTorrent.IsSpellUsable && ArcaneTorrent.KnownSpell &&
            ObjectManager.Me.ManaPercentage <= MySettings.UseArcaneTorrentForResourceAtPercentage
            && MySettings.UseArcaneTorrentForResource)
        {
            ArcaneTorrent.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 80 && NaturesSwiftness.IsSpellUsable && NaturesSwiftness.KnownSpell
            && MySettings.UseNaturesSwiftness && MySettings.UseHealingTouch)
        {
            NaturesSwiftness.Cast();
            Others.SafeSleep(400);
            HealingTouch.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 70 && Renewal.IsSpellUsable && Renewal.KnownSpell
            && MySettings.UseRenewal)
        {
            Renewal.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 95 && !ObjectManager.Me.InCombat
            && HealingTouch.IsSpellUsable && HealingTouch.KnownSpell && MySettings.UseHealingTouch)
        {
            HealingTouch.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 90 && CenarionWard.IsSpellUsable && CenarionWard.KnownSpell
            && MySettings.UseCenarionWard)
        {
            CenarionWard.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseGiftoftheNaaruAtPercentage &&
            GiftoftheNaaru.IsSpellUsable && GiftoftheNaaru.KnownSpell
            && MySettings.UseGiftoftheNaaru)
        {
            GiftoftheNaaru.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 70 && Rejuvenation.IsSpellUsable && Rejuvenation.KnownSpell
            && !Rejuvenation.HaveBuff && MySettings.UseRejuvenation)
        {
            Rejuvenation.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 40 && HealingTouch.IsSpellUsable && HealingTouch.KnownSpell
            && _healingTouchTimer.IsReady && MySettings.UseHealingTouch)
        {
            HealingTouch.Cast();
            _healingTouchTimer = new Timer(1000*15);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 35 && MightofUrsoc.IsSpellUsable && MightofUrsoc.KnownSpell
            && MySettings.UseMightofUrsoc)
        {
            MightofUrsoc.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 30 && Tranquility.IsSpellUsable && Tranquility.KnownSpell
            && MySettings.UseTranquility)
        {
            Tranquility.Cast(false, true);
            return;
        }

        if (ObjectManager.Me.ManaPercentage < 50 && MySettings.UseInnervate)
        {
            Innervate.Cast();
        }
    }

    private void Decast()
    {
        if (ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe
            && SolarBeam.KnownSpell && SolarBeam.IsSpellUsable && SolarBeam.IsHostileDistanceGood
            && MySettings.UseSolarBeam)
        {
            if (EntanglingRoots.KnownSpell && EntanglingRoots.IsHostileDistanceGood && EntanglingRoots.IsSpellUsable
                && MySettings.UseEntanglingRoots)
            {
                EntanglingRoots.Cast();
                Others.SafeSleep(200);
            }

            SolarBeam.Cast();
            return;
        }
        if (ArcaneTorrent.IsSpellUsable && ArcaneTorrent.KnownSpell && ObjectManager.Target.GetDistance < 8
            && ObjectManager.Me.HealthPercent <= MySettings.UseArcaneTorrentForDecastAtPercentage
            && MySettings.UseArcaneTorrentForDecast && ObjectManager.Target.IsCast &&
            ObjectManager.Target.IsTargetingMe)
        {
            ArcaneTorrent.Cast();
        }
    }

    private void DPSBurst()
    {
        if (MySettings.UseTrinketOne && !ItemsManager.IsItemOnCooldown(_firstTrinket.Entry) && ItemsManager.IsItemUsable(_firstTrinket.Entry))
        {
            ItemsManager.UseItem(_firstTrinket.Name);
            Logging.WriteFight("Use First Trinket Slot");
        }

        if (MySettings.UseTrinketTwo && !ItemsManager.IsItemOnCooldown(_secondTrinket.Entry) && ItemsManager.IsItemUsable(_secondTrinket.Entry))
        {
            ItemsManager.UseItem(_secondTrinket.Name);
            Logging.WriteFight("Use Second Trinket Slot");
            return;
        }
        if (Berserking.IsSpellUsable && Berserking.KnownSpell && ObjectManager.Target.GetDistance <= 40f
            && MySettings.UseBerserking)
        {
            Berserking.Cast();
            return;
        }
        if (BloodFury.IsSpellUsable && BloodFury.KnownSpell && ObjectManager.Target.GetDistance <= 40f
            && MySettings.UseBloodFury)
        {
            BloodFury.Cast();
            return;
        }
        if (ForceofNature.IsSpellUsable && ForceofNature.KnownSpell && ForceofNature.IsHostileDistanceGood
            && MySettings.UseForceofNature)
        {
            SpellManager.CastSpellByIDAndPosition(106737, ObjectManager.Target.Position);
            return;
        }
        if (Incarnation.IsSpellUsable && Incarnation.KnownSpell && MySettings.UseIncarnation
            && ObjectManager.Target.GetDistance <= 40f)
        {
            Incarnation.Cast();
            return;
        }
        if (HeartoftheWild.IsSpellUsable && HeartoftheWild.KnownSpell && MySettings.UseHeartoftheWild
            && ObjectManager.Target.GetDistance <= 40f)
        {
            HeartoftheWild.Cast();
            return;
        }
        if (NaturesVigil.IsSpellUsable && NaturesVigil.KnownSpell && MySettings.UseNaturesVigil
            && ObjectManager.Target.GetDistance <= 40f)
        {
            NaturesVigil.Cast();
            return;
        }
        if (CelestialAlignment.KnownSpell && MySettings.UseCelestialAlignment &&
            ObjectManager.Target.GetDistance <= 40f
            && (CelestialAlignment.IsSpellUsable || ObjectManager.Me.HaveBuff(112071)))
        {
            if (!ObjectManager.Me.HaveBuff(112071))
                CelestialAlignment.Cast();
            CelestialAlignmentCombat();
        }
    }

    private void DPSCycle()
    {
        Usefuls.SleepGlobalCooldown();
        try
        {
            Memory.WowMemory.GameFrameLock(); // !!! WARNING - DONT SLEEP WHILE LOCKED - DO FINALLY(GameFrameUnLock()) !!!

            if (Moonfire.KnownSpell && Moonfire.IsHostileDistanceGood && Moonfire.IsSpellUsable && ObjectManager.Me.Eclipse <= 0
                && MySettings.UseMoonfire && (!ObjectManager.Target.HaveBuff(164812) || _moonfireTimer.IsReady))
            {
                Moonfire.Cast();
                _moonfireTimer = new Timer(1000*37);
                return;
            }
            if (Moonfire.KnownSpell && Moonfire.IsHostileDistanceGood && Moonfire.IsSpellUsable && ObjectManager.Me.Eclipse > 0
                && MySettings.UseSunfire && (!ObjectManager.Target.HaveBuff(164815) || _sunfireTimer.IsReady))
            {
                Moonfire.Cast();
                _sunfireTimer = new Timer(1000*18);
                return;
            }
            if (Starsurge.IsHostileDistanceGood && Starsurge.IsSpellUsable && Starsurge.KnownSpell && MySettings.UseStarsurge
                && (!ObjectManager.Me.HaveBuff(164547) || !ObjectManager.Me.HaveBuff(164545)) && _starsurgeTimer.IsReady)
            {
                Starsurge.Cast();
                _starsurgeTimer = new Timer(1000*5);
                return;
            }
            if (Starfall.KnownSpell && Starfall.IsSpellUsable && ObjectManager.GetNumberAttackPlayer() > 2 &&
                ObjectManager.Target.GetDistance <= 40f && MySettings.UseStarfall && _starfallTimer.IsReady)
            {
                Starfall.Cast();
                _starfallTimer = new Timer(1000*5);
                return;
            }
            if (Hurricane.KnownSpell && Hurricane.IsSpellUsable && ObjectManager.GetNumberAttackPlayer() > 2 &&
                ObjectManager.Target.GetDistance <= 40f && MySettings.UseHurricane)
            {
                SpellManager.CastSpellByIDAndPosition(16914, ObjectManager.Target.Position);
                return;
            }
            if (Starfire.KnownSpell && Starfire.IsSpellUsable && Starfire.IsHostileDistanceGood
                && MySettings.UseStarfire && ObjectManager.Target.HaveBuff(164812) && ObjectManager.Me.Eclipse < -20)
            {
                if (Starsurge.IsHostileDistanceGood && Starsurge.IsSpellUsable && Starsurge.KnownSpell && MySettings.UseStarsurge
                    && !ObjectManager.Me.HaveBuff(164547) && _starsurgeTimer.IsReady)
                {
                    Starsurge.Cast();
                    _starsurgeTimer = new Timer(1000*5);
                    return;
                }

                Starfire.Cast();
                return;
            }
            if (Wrath.KnownSpell && Wrath.IsSpellUsable && Wrath.IsHostileDistanceGood
                && MySettings.UseWrath && ObjectManager.Target.HaveBuff(164815) && ObjectManager.Me.Eclipse > 10)
            {
                if (Starsurge.IsHostileDistanceGood && Starsurge.IsSpellUsable && Starsurge.KnownSpell && MySettings.UseStarsurge 
                    && !ObjectManager.Me.HaveBuff(164545) && _starsurgeTimer.IsReady)
                {
                    Starsurge.Cast();
                    _starsurgeTimer = new Timer(1000*5);
                    return;
                }

                Wrath.Cast();
                return;
            }
        }
        finally
        {
            Memory.WowMemory.GameFrameUnLock();
        }
    }

    public void CelestialAlignmentCombat()
    {
        Moonfire.Cast();

        while (ObjectManager.Me.HaveBuff(112071))
        {
            if (!ObjectManager.Target.HaveBuff(164812) || _moonfireTimer.IsReady || !ObjectManager.Target.HaveBuff(164815) || _sunfireTimer.IsReady)
            {
                Moonfire.Cast();
                _moonfireTimer = new Timer(1000*37);
                _sunfireTimer = new Timer(1000*21);
            }

            if (Starfire.KnownSpell && Starfire.IsSpellUsable && Starfire.IsHostileDistanceGood && MySettings.UseStarfire 
                && (!_starsurgeTimer.IsReady || ObjectManager.Me.HaveBuff(164547)))
                Starfire.Cast();

            if (Starsurge.IsHostileDistanceGood && Starsurge.IsSpellUsable && Starsurge.KnownSpell && MySettings.UseStarsurge
                && !ObjectManager.Me.HaveBuff(164547) && _starsurgeTimer.IsReady)
            {
                Starsurge.Cast();
                _starsurgeTimer = new Timer(1000*3);
            }
        }
    }

    private void Patrolling()
    {
        if (!ObjectManager.Me.IsMounted)
        {
            Buff();
            Heal();
        }
    }

    #region Nested type: DruidBalanceSettings

    [Serializable]
    public class DruidBalanceSettings : Settings
    {
        public bool DoAvoidMelee = false;
        public int DoAvoidMeleeDistance = 0;
        public bool UseAlchFlask = true;
        public bool UseArcaneTorrentForDecast = true;
        public int UseArcaneTorrentForDecastAtPercentage = 100;
        public bool UseArcaneTorrentForResource = true;
        public int UseArcaneTorrentForResourceAtPercentage = 80;
        public bool UseAstralCommunion = true;
        public bool UseBarkskin = true;
        public bool UseBerserking = true;
        public bool UseBloodFury = true;
        public bool UseCelestialAlignment = true;
        public bool UseCenarionWard = true;
        public bool UseDash = true;
        public bool UseDisorientingRoar = true;

        public bool UseEntanglingRoots = true;
        public bool UseFaerieFire = true;
        public bool UseForceofNature = true;
        public bool UseGiftoftheNaaru = true;
        public int UseGiftoftheNaaruAtPercentage = 80;
        public bool UseHealingTouch = true;
        public bool UseHeartoftheWild = true;
        public bool UseHurricane = true;
        public bool UseIncarnation = true;
        public bool UseInnervate = true;

        public bool UseLowCombat = true;
        public bool UseMarkoftheWild = true;
        public bool UseMassEntanglement = true;
        public bool UseMightofUrsoc = true;
        public bool UseMightyBash = true;
        public bool UseMoonfire = true;
        public bool UseMoonkinForm = true;
        public bool UseNaturesGrasp = true;
        public bool UseNaturesSwiftness = true;
        public bool UseNaturesVigil = true;
        public bool UseRejuvenation = true;
        public bool UseRenewal = true;
        public bool UseSolarBeam = true;
        public bool UseStampedingRoar = true;
        public bool UseStarfall = true;
        public bool UseStarfire = true;
        public bool UseStarsurge = true;
        public bool UseStoneform = true;
        public int UseStoneformAtPercentage = 80;
        public bool UseSunfire = true;
        public bool UseTranquility = true;
        public bool UseTrinketOne = true;
        public bool UseTrinketTwo = true;
        public bool UseTyphoon = true;
        public bool UseUrsolsVortex = true;
        public bool UseWarStomp = true;
        public int UseWarStompAtPercentage = 80;
        public bool UseWildCharge = true;
        public bool UseWildMushroom = true;
        public bool UseWrath = true;

        public DruidBalanceSettings()
        {
            ConfigWinForm("Druid Balance Settings");
            /* Professions & Racials */
            AddControlInWinForm("Use Arcane Torrent for Interrupt", "UseArcaneTorrentForDecast", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Arcane Torrent for Resource", "UseArcaneTorrentForResource", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Berserking", "UseBerserking", "Professions & Racials");
            AddControlInWinForm("Use Blood Fury", "UseBloodFury", "Professions & Racials");
            AddControlInWinForm("Use Gift of the Naaru", "UseGiftoftheNaaru", "Professions & Racials");

            AddControlInWinForm("Use Stoneform", "UseStoneform", "Professions & Racials");
            AddControlInWinForm("Use War Stomp", "UseWarStomp", "Professions & Racials");
            /* Druid Buffs */
            AddControlInWinForm("Use Dash", "UseDash", "Druid Buffs");
            AddControlInWinForm("Use Faerie Fire", "UseFaerieFire", "Druid Buffs");
            AddControlInWinForm("Use Mark of the Wild", "UseMarkoftheWild", "Druid Buffs");
            AddControlInWinForm("Use Moonkin Form", "UseMoonkinForm", "Druid Buffs");
            AddControlInWinForm("Use Stampeding Roar", "UseStampedingRoar", "Druid Buffs");
            /* Offensive Spell */
            AddControlInWinForm("Use Hurricane", "UseHurricane", "Offensive Spell");
            AddControlInWinForm("Use Moonfire", "UseMoonfire", "Offensive Spell");
            AddControlInWinForm("Use Starfall", "UseStarfall", "Offensive Spell");
            AddControlInWinForm("Use Starfire", "UseStarfire", "Offensive Spell");
            AddControlInWinForm("Use Starsurge", "UseStarsurge", "Offensive Spell");
            AddControlInWinForm("Use Sunfire", "UseSunfire", "Offensive Spell");
            AddControlInWinForm("Use WildMushroom", "UseWildMushroom", "Offensive Spell");
            AddControlInWinForm("Use Wrath", "UseWrath", "Offensive Spell");
            /* Offensive Cooldown */
            AddControlInWinForm("Use Astral Communion", "UseAstralCommunion", "Offensive Cooldown");
            AddControlInWinForm("Use Celestial Alignment", "UseCelestialAlignment", "Offensive Cooldown");
            AddControlInWinForm("Use Force of Nature", "UseForceofNature", "Offensive Cooldown");
            AddControlInWinForm("Use Heart of the Wild", "UseHeartoftheWild", "Offensive Cooldown");
            AddControlInWinForm("Use Incarnation", "UseIncarnation", "Offensive Cooldown");
            AddControlInWinForm("Use Nature's Vigil", "UseNaturesVigil", "Offensive Cooldown");
            /* Defensive Cooldown */
            AddControlInWinForm("Use Barkskin", "UseBarkskin", "Defensive Cooldown");
            AddControlInWinForm("Use Disorienting Roar", "UseDisorientingRoar", "Defensive Cooldown");
            AddControlInWinForm("Use Entangling Roots", "UseEntanglingRoots", "Defensive Cooldown");
            AddControlInWinForm("Use Mass Entanglement", "UseMassEntanglement", "Defensive Cooldown");
            AddControlInWinForm("Use Mighty Bash", "UseMightyBash", "Defensive Cooldown");
            AddControlInWinForm("Use Nature's Grasp", "UseNaturesGrasp", "Defensive Cooldown");
            AddControlInWinForm("Use Solar Beam", "UseSolarBeam", "Defensive Cooldown");
            AddControlInWinForm("Use Typhoon", "UseTyphoon", "Defensive Cooldown");
            AddControlInWinForm("Use Ursol's Vortex", "UseUrsolsVortex", "Defensive Cooldown");
            AddControlInWinForm("Use Wild Charge", "UseWildCharge", "Defensive Cooldown");
            /* Healing Spell */
            AddControlInWinForm("Use Cenarion Ward", "UseCenarionWard", "Healing Spell");
            AddControlInWinForm("Use Healing Touch", "UseHealingTouch", "Healing Spell");
            AddControlInWinForm("Use Innervate", "UseInnervate", "Healing Spell");
            AddControlInWinForm("Use Might of Ursoc", "UseMightofUrsoc", "Healing Spell");
            AddControlInWinForm("Use Nature's Swiftness", "UseNaturesSwiftness", "Healing Spell");
            AddControlInWinForm("Use Rejuvenation", "UseRejuvenation", "Healing Spell");
            AddControlInWinForm("Use Renewal", "UseRenewal", "Healing Spell");
            AddControlInWinForm("Use Tranquility", "UseTranquility", "Healing Spell");
            /* Game Settings */
            AddControlInWinForm("Use Low Combat Settings", "UseLowCombat", "Game Settings");
            AddControlInWinForm("Use Trinket One", "UseTrinketOne", "Game Settings");
            AddControlInWinForm("Use Trinket Two", "UseTrinketTwo", "Game Settings");

            AddControlInWinForm("Use Alchemist Flask", "UseAlchFlask", "Game Settings");
            AddControlInWinForm("Do avoid melee (Off Advised!!)", "DoAvoidMelee", "Game Settings");
            AddControlInWinForm("Avoid melee distance (1 to 4)", "DoAvoidMeleeDistance", "Game Settings");
        }

        public static DruidBalanceSettings CurrentSetting { get; set; }

        public static DruidBalanceSettings GetSettings()
        {
            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Druid_Balance.xml";
            if (File.Exists(currentSettingsFile))
            {
                return
                    CurrentSetting = Load<DruidBalanceSettings>(currentSettingsFile);
            }
            return new DruidBalanceSettings();
        }
    }

    #endregion
}

public class DruidFeral
{
    private static DruidFeralSettings MySettings = DruidFeralSettings.GetSettings();

    #region General Timers & Variables

    private readonly WoWItem _firstTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET);
    private readonly WoWItem _secondTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET, 2);
    public uint CP;

    private Timer _onCd = new Timer(0);

    #endregion

    #region Professions & Racials

    public readonly Spell Alchemy = new Spell("Alchemy");
    public readonly Spell ArcaneTorrent = new Spell("Arcane Torrent");
    public readonly Spell Berserking = new Spell("Berserking");
    public readonly Spell BloodFury = new Spell("Blood Fury");

    public readonly Spell GiftoftheNaaru = new Spell("Gift of the Naaru");

    public readonly Spell Stoneform = new Spell("Stoneform");
    public readonly Spell WarStomp = new Spell("War Stomp");

    #endregion

    #region Druid Buffs

    public readonly Spell CatForm = new Spell("Cat Form");
    public readonly Spell Dash = new Spell("Dash");
    public readonly Spell DisplacerBeast = new Spell("Displacer Beast");
    public readonly Spell FaerieFire = new Spell("Faerie Fire");
    public readonly Spell MarkoftheWild = new Spell("Mark of the Wild");
    public readonly Spell Prowl = new Spell("Prowl");
    public readonly Spell SavageRoar = new Spell("Savage Roar");
    public readonly Spell StampedingRoar = new Spell("Stampeding Roar");
    private Timer _savageRoarTimer = new Timer(0);

    #endregion

    #region Offensive Spell

    public readonly Spell FerociousBite = new Spell("Ferocious Bite");
    public readonly Spell Maim = new Spell("Maim");
    public readonly Spell Mangle = new Spell("Mangle");
    public readonly Spell Pounce = new Spell("Pounce");
    public readonly Spell Rake = new Spell("Rake");
    public readonly Spell Ravage = new Spell("Ravage");
    public readonly Spell Rip = new Spell("Rip");
    public readonly Spell Shred = new Spell("Shred");
    public readonly Spell Swipe = new Spell("Swipe");
    public readonly Spell Thrash = new Spell("Thrash");
    private bool _fivePtRip;
    private Timer _rakeTimer = new Timer(0);
    private Timer _ripTimer = new Timer(0);

    #endregion

    #region Offensive Cooldown

    public readonly Spell Berserk = new Spell("Berserk");
    public readonly Spell ForceofNature = new Spell("Force of Nature");
    public readonly Spell HeartoftheWild = new Spell("Heart of the Wild");
    public readonly Spell Incarnation = new Spell("Incarnation: King of the Jungle");
    public readonly Spell NaturesVigil = new Spell("Nature's Vigil");
    public readonly Spell TigersFury = new Spell("Tiger's Fury");

    #endregion

    #region Defensive Cooldown

    public readonly Spell Barkskin = new Spell("Barkskin");
    public readonly Spell DisorientingRoar = new Spell("Disorienting Roar");
    public readonly Spell MassEntanglement = new Spell("Mass Entanglement");
    public readonly Spell MightyBash = new Spell("Mighty Bash");
    public readonly Spell NaturesGrasp = new Spell("Nature's Grasp");
    public readonly Spell SkullBash = new Spell("Skull Bash");
    public readonly Spell SurvivalInstincts = new Spell("Survival Instincts");
    public readonly Spell Typhoon = new Spell("Typhoon");
    public readonly Spell UrsolsVortex = new Spell("Ursol's Vortex");
    public readonly Spell WildCharge = new Spell("Wild Charge");

    #endregion

    #region Healing Spell

    public readonly Spell CenarionWard = new Spell("Cenarion Ward");
    public readonly Spell HealingTouch = new Spell("Healing Touch");
    public readonly Spell Innervate = new Spell("Innervate");
    public readonly Spell MightofUrsoc = new Spell("Might of Ursoc");
    public readonly Spell NaturesSwiftness = new Spell("Nature's Swiftness");
    public readonly Spell Rejuvenation = new Spell("Rejuvenation");
    public readonly Spell Renewal = new Spell("Renewal");
    public readonly Spell Tranquility = new Spell("Tranquility");
    private Timer _healingTouchTimer = new Timer(0);

    #endregion

    public DruidFeral()
    {
        Main.InternalRange = ObjectManager.Me.GetCombatReach;
        MySettings = DruidFeralSettings.GetSettings();
        Main.DumpCurrentSettings<DruidFeralSettings>(MySettings);
        UInt128 lastTarget = 0;

        while (Main.InternalLoop)
        {
            try
            {
                if (!ObjectManager.Me.IsDeadMe)
                {
                    if (!ObjectManager.Me.IsMounted)
                    {
                        if (Fight.InFight && ObjectManager.Me.Target > 0)
                        {
                            if (ObjectManager.Me.Target != lastTarget
                                && (FaerieFire.IsHostileDistanceGood || WildCharge.IsHostileDistanceGood))
                            {
                                Pull();
                                lastTarget = ObjectManager.Me.Target;
                            }

                            if (ObjectManager.Target.Level < 70 && ObjectManager.Me.Level > 84 && MySettings.UseLowCombat)
                            {
                                if (ObjectManager.Target.GetDistance < 30)
                                    LowCombat();
                            }
                            else
                            {
                                if (ObjectManager.Target.GetDistance < 30)
                                    Combat();
                            }
                        }
                        if (!ObjectManager.Me.IsCast)
                            Patrolling();
                    }
                }
                else
                    Thread.Sleep(500);
            }
            catch
            {
            }
            Thread.Sleep(100);
        }
    }

    private void Pull()
    {
        if (!ObjectManager.Me.HaveBuff(768) && MySettings.UseCatForm)
            CatForm.Cast();
        if (!SavageRoar.HaveBuff && MySettings.UseSavageRoar && SavageRoar.IsSpellUsable && SavageRoar.KnownSpell && ObjectManager.Target.GetDistance < 30)
        {
            SavageRoar.Cast();
            _savageRoarTimer = new Timer(1000*12);
        }
        if (Prowl.IsSpellUsable && Prowl.KnownSpell && Prowl.IsHostileDistanceGood && MySettings.UseProwl && !ObjectManager.Me.InCombat)
        {
            if (DisplacerBeast.IsSpellUsable && DisplacerBeast.KnownSpell && DisplacerBeast.IsHostileDistanceGood && MySettings.UseDisplacerBeast)
            {
                DisplacerBeast.Cast();
                Others.SafeSleep(200);
            }

            if (Pounce.IsSpellUsable && Pounce.KnownSpell && Pounce.IsHostileDistanceGood && MySettings.UsePounce)
            {
                Pounce.Cast();
                return;
            }
            return;
        }
        if (WildCharge.KnownSpell && WildCharge.IsSpellUsable && WildCharge.IsHostileDistanceGood && MySettings.UseWildCharge &&
            ObjectManager.Target.GetDistance > Main.InternalRange)
        {
            WildCharge.Cast();
            return;
        }
        if (FaerieFire.KnownSpell && FaerieFire.IsSpellUsable && FaerieFire.IsHostileDistanceGood && MySettings.UseFaerieFire)
        {
            FaerieFire.Cast();
        }
    }

    private void LowCombat()
    {
        Buff();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        DefenseCycle();
        Heal();

        if (!ObjectManager.Me.HaveBuff(768) && MySettings.UseCatForm)
        {
            CatForm.Cast();
            return;
        }

        if (Shred.IsSpellUsable && Shred.KnownSpell && Shred.IsHostileDistanceGood && MySettings.UseShred)
        {
            Shred.Cast();
            if (ObjectManager.Target.HealthPercent < 50 && ObjectManager.Target.HealthPercent > 0)
            {
                Shred.Cast();
            }
            return;
        }
        if (Swipe.IsSpellUsable && Swipe.KnownSpell && Swipe.IsHostileDistanceGood && MySettings.UseSwipe)
        {
            Swipe.Cast();
        }
    }

    private void Combat()
    {
        Buff();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        if (_onCd.IsReady)
            DefenseCycle();
        DPSCycle();
        Heal();
        Decast();
        DPSBurst();
        DPSCycle();
    }

    private void Buff()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (MarkoftheWild.KnownSpell && MarkoftheWild.IsSpellUsable && !MarkoftheWild.HaveBuff)
        {
            MarkoftheWild.Cast();
            return;
        }
        if (MySettings.UseAlchFlask && !ObjectManager.Me.HaveBuff(79638) && !ObjectManager.Me.HaveBuff(79640) && !ObjectManager.Me.HaveBuff(79639)
            && !ItemsManager.IsItemOnCooldown(75525) && ItemsManager.GetItemCount(75525) > 0)
        {
            ItemsManager.UseItem(75525);
            return;
        }
        if (!ObjectManager.Me.InCombat && MySettings.UseDash
            && Dash.KnownSpell && Dash.IsSpellUsable && !Dash.HaveBuff && !StampedingRoar.HaveBuff
            && ObjectManager.Me.GetMove)
        {
            Dash.Cast();
            return;
        }
        if (!ObjectManager.Me.InCombat && MySettings.UseStampedingRoar
            && StampedingRoar.KnownSpell && StampedingRoar.IsSpellUsable && !Dash.HaveBuff
            && !StampedingRoar.HaveBuff && ObjectManager.Me.GetMove)
        {
            StampedingRoar.Cast();
        }
    }

    private void AvoidMelee()
    {
        if (ObjectManager.Target.GetDistance < MySettings.DoAvoidMeleeDistance && ObjectManager.Target.InCombat)
        {
            Logging.WriteFight("Too Close. Moving Back");
            var maxTimeTimer = new Timer(1000*2);
            MovementsAction.MoveBackward(true);
            while (ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat && !maxTimeTimer.IsReady)
                Others.SafeSleep(300);
            MovementsAction.MoveBackward(false);
            if (maxTimeTimer.IsReady && ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat)
            {
                MovementsAction.MoveForward(true);
                Others.SafeSleep(1000);
                MovementsAction.MoveForward(false);
                MovementManager.Face(ObjectManager.Target.Position);
            }
        }
    }

    private void DefenseCycle()
    {
        if (ObjectManager.Me.HealthPercent < 80 && MySettings.UseBarkskin
            && Barkskin.KnownSpell && Barkskin.IsSpellUsable)
        {
            Barkskin.Cast();
            _onCd = new Timer(1000*12);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 90 && MightyBash.IsHostileDistanceGood
            && MightyBash.KnownSpell && MightyBash.IsSpellUsable && MySettings.UseMightyBash)
        {
            MightyBash.Cast();
            _onCd = new Timer(1000*5);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 70 && ObjectManager.Me.ComboPoint > 2
            && Maim.KnownSpell && Maim.IsSpellUsable && MySettings.UseMaim && Maim.IsHostileDistanceGood)
        {
            CP = ObjectManager.Me.ComboPoint;
            Maim.Cast();
            _onCd = new Timer(1000*CP);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 70 && MySettings.UseSurvivalInstincts
            && SurvivalInstincts.KnownSpell && SurvivalInstincts.IsSpellUsable)
        {
            SurvivalInstincts.Cast();
            _onCd = new Timer(1000*12);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseStoneformAtPercentage && Stoneform.IsSpellUsable &&
            Stoneform.KnownSpell
            && MySettings.UseStoneform)
        {
            Stoneform.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (MassEntanglement.KnownSpell && MassEntanglement.IsSpellUsable && MassEntanglement.IsHostileDistanceGood
            && ObjectManager.Target.IsCast && MySettings.UseMassEntanglement &&
            ObjectManager.GetNumberAttackPlayer() > 2
            && ObjectManager.Me.HealthPercent < 70)
        {
            if (Typhoon.KnownSpell && Typhoon.IsSpellUsable && MySettings.UseTyphoon
                && ObjectManager.Target.GetDistance <= 40f && MySettings.UseTyphoon)
            {
                Typhoon.Cast();
                Others.SafeSleep(200);
            }

            MassEntanglement.Cast();
            return;
        }
        if (UrsolsVortex.KnownSpell && UrsolsVortex.IsSpellUsable && UrsolsVortex.IsHostileDistanceGood
            && MySettings.UseUrsolsVortex && ObjectManager.Me.HealthPercent < 80
            && ObjectManager.GetNumberAttackPlayer() > 2)
        {
            UrsolsVortex.Cast();

            if (WildCharge.KnownSpell && WildCharge.IsHostileDistanceGood && WildCharge.IsSpellUsable
                && MySettings.UseWildCharge && ObjectManager.Target.GetDistance > Main.InternalRange)
            {
                Others.SafeSleep(200);
                WildCharge.Cast();
            }
            return;
        }
        if (NaturesGrasp.KnownSpell && NaturesGrasp.IsSpellUsable && ObjectManager.GetNumberAttackPlayer() > 2
            && ObjectManager.Target.IsCast && MySettings.UseNaturesGrasp && ObjectManager.Me.HealthPercent < 80)
        {
            NaturesGrasp.Cast();
            return;
        }
        if (Typhoon.KnownSpell && Typhoon.IsSpellUsable && ObjectManager.GetNumberAttackPlayer() > 2
            && ObjectManager.Target.GetDistance <= 40f && ObjectManager.Me.HealthPercent < 70
            && MySettings.UseTyphoon)
        {
            Typhoon.Cast();
            return;
        }
        if (DisorientingRoar.KnownSpell && DisorientingRoar.IsSpellUsable &&
            ObjectManager.GetNumberAttackPlayer() > 2
            && ObjectManager.Target.GetDistance < 10 && ObjectManager.Me.HealthPercent < 70
            && MySettings.UseDisorientingRoar)
        {
            DisorientingRoar.Cast();
            _onCd = new Timer(1000*3);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseWarStompAtPercentage && WarStomp.IsSpellUsable &&
            WarStomp.KnownSpell
            && MySettings.UseWarStomp)
        {
            WarStomp.Cast();
            _onCd = new Timer(1000*2);
        }
    }

    private void Heal()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (ObjectManager.Me.HealthPercent < 80 && NaturesSwiftness.IsSpellUsable && NaturesSwiftness.KnownSpell
            && MySettings.UseNaturesSwiftness && MySettings.UseHealingTouch)
        {
            NaturesSwiftness.Cast();
            Others.SafeSleep(400);
            HealingTouch.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 70 && Renewal.IsSpellUsable && Renewal.KnownSpell
            && MySettings.UseRenewal)
        {
            Renewal.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 90 && CenarionWard.IsSpellUsable && CenarionWard.KnownSpell
            && MySettings.UseCenarionWard)
        {
            CenarionWard.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 50 && !ObjectManager.Me.InCombat
            && HealingTouch.IsSpellUsable && HealingTouch.KnownSpell && MySettings.UseHealingTouch)
        {
            while (ObjectManager.Me.HealthPercent < 95 && HealingTouch.IsSpellUsable)
            {
                HealingTouch.Cast();
                Others.SafeSleep(1500);
            }
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseGiftoftheNaaruAtPercentage &&
            GiftoftheNaaru.IsSpellUsable && GiftoftheNaaru.KnownSpell)
        {
            GiftoftheNaaru.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 70 && HealingTouch.IsSpellUsable && HealingTouch.KnownSpell
            && ObjectManager.Me.HaveBuff(69369) && MySettings.UseHealingTouch)
        {
            HealingTouch.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 50 && Rejuvenation.IsSpellUsable && Rejuvenation.KnownSpell
            && !Rejuvenation.HaveBuff && MySettings.UseRejuvenation)
        {
            Rejuvenation.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 40 && HealingTouch.IsSpellUsable && HealingTouch.KnownSpell
            && _healingTouchTimer.IsReady && MySettings.UseHealingTouch)
        {
            HealingTouch.Cast();
            _healingTouchTimer = new Timer(1000*15);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 35 && MightofUrsoc.IsSpellUsable && MightofUrsoc.KnownSpell
            && MySettings.UseMightofUrsoc)
        {
            MightofUrsoc.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 30 && Tranquility.IsSpellUsable && Tranquility.KnownSpell
            && MySettings.UseTranquility)
        {
            Tranquility.Cast(false, true);
            return;
        }
        if (ObjectManager.Me.ManaPercentage < 10 && MySettings.UseInnervate)
        {
            Innervate.Cast();
        }
    }

    private void Decast()
    {
        if (ObjectManager.Target.IsCast && MySettings.UseSkullBash
            && ObjectManager.Target.IsTargetingMe
            && SkullBash.KnownSpell && SkullBash.IsSpellUsable && SkullBash.IsHostileDistanceGood)
        {
            SkullBash.Cast();
            return;
        }
        if (ArcaneTorrent.IsSpellUsable && ArcaneTorrent.KnownSpell && ObjectManager.Target.GetDistance < 8
            && ObjectManager.Me.HealthPercent <= MySettings.UseArcaneTorrentForDecastAtPercentage
            && MySettings.UseArcaneTorrentForDecast && ObjectManager.Target.IsCast &&
            ObjectManager.Target.IsTargetingMe)
        {
            ArcaneTorrent.Cast();
        }
    }

    private void DPSBurst()
    {
        if (MySettings.UseTrinketOne && !ItemsManager.IsItemOnCooldown(_firstTrinket.Entry) && ItemsManager.IsItemUsable(_firstTrinket.Entry))
        {
            ItemsManager.UseItem(_firstTrinket.Name);
            Logging.WriteFight("Use First Trinket Slot");
        }

        if (MySettings.UseTrinketTwo && !ItemsManager.IsItemOnCooldown(_secondTrinket.Entry) && ItemsManager.IsItemUsable(_secondTrinket.Entry))
        {
            ItemsManager.UseItem(_secondTrinket.Name);
            Logging.WriteFight("Use Second Trinket Slot");
            return;
        }
        if (Berserking.IsSpellUsable && Berserking.KnownSpell && ObjectManager.Target.GetDistance < 30
            && MySettings.UseBerserking)
        {
            Berserking.Cast();
            return;
        }
        if (BloodFury.IsSpellUsable && BloodFury.KnownSpell && ObjectManager.Target.GetDistance < 30
            && MySettings.UseBloodFury)
        {
            BloodFury.Cast();
            return;
        }
        if (ForceofNature.IsSpellUsable && ForceofNature.KnownSpell && ForceofNature.IsHostileDistanceGood
            && MySettings.UseForceofNature)
        {
            SpellManager.CastSpellByIDAndPosition(106737, ObjectManager.Target.Position);
            return;
        }
        if (Incarnation.IsSpellUsable && Incarnation.KnownSpell && MySettings.UseIncarnation
            && ObjectManager.Target.GetDistance < 30)
        {
            Incarnation.Cast();
            return;
        }
        if (NaturesVigil.IsSpellUsable && NaturesVigil.KnownSpell && MySettings.UseNaturesVigil
            && ObjectManager.Target.GetDistance < 30)
        {
            NaturesVigil.Cast();
            return;
        }
        if (TigersFury.KnownSpell && TigersFury.IsSpellUsable && ObjectManager.Me.Energy < 35
            && !Berserk.HaveBuff && MySettings.UseTigersFury && ObjectManager.Target.GetDistance < 30)
        {
            TigersFury.Cast();
            return;
        }
        if (Berserk.KnownSpell && Berserk.IsSpellUsable && MySettings.UseBerserk
            && ObjectManager.Target.GetDistance < 30)
        {
            Berserk.Cast();
        }
    }

    private void DPSCycle()
    {
        Usefuls.SleepGlobalCooldown();
        try
        {
            Memory.WowMemory.GameFrameLock(); // !!! WARNING - DONT SLEEP WHILE LOCKED - DO FINALLY(GameFrameUnLock()) !!!

            if (!ObjectManager.Me.HaveBuff(768) && MySettings.UseCatForm)
            {
                CatForm.Cast();
                return;
            }
            if (ObjectManager.GetNumberAttackPlayer() > 2 && Thrash.IsSpellUsable && Thrash.KnownSpell
                && Thrash.IsHostileDistanceGood && !Thrash.TargetHaveBuff && MySettings.UseThrash)
            {
                Thrash.Cast();
                return;
            }
            if (ObjectManager.GetNumberAttackPlayer() > 2 && Swipe.IsSpellUsable && Swipe.KnownSpell
                && Swipe.IsHostileDistanceGood && MySettings.UseSwipe)
            {
                Swipe.Cast();
                return;
            }
            if (HealingTouch.IsSpellUsable && HealingTouch.KnownSpell && ObjectManager.Me.HaveBuff(69369)
                && MySettings.UseHealingTouch)
            {
                HealingTouch.Cast();
                return;
            }
            if (Rake.IsSpellUsable && Rake.KnownSpell && Rake.IsHostileDistanceGood &&
                (!ObjectManager.Target.HaveBuff(155722) || _rakeTimer.IsReady)
                && MySettings.UseRake)
            {
                Rake.Cast();
                _rakeTimer = new Timer(1000*10);
                if (MySettings.UseGlyphofSavageRoar && Incarnation.KnownSpell && ObjectManager.Me.HaveBuff(102543))
                    _savageRoarTimer = new Timer(1000*37);
                return;
            }
            if (SavageRoar.IsSpellUsable && SavageRoar.KnownSpell && SavageRoar.IsHostileDistanceGood
                && (!SavageRoar.HaveBuff || _savageRoarTimer.IsReady) && MySettings.UseSavageRoar
                && ObjectManager.Me.ComboPoint > 0)
            {
                CP = ObjectManager.Me.ComboPoint;
                SavageRoar.Cast();
                _savageRoarTimer = new Timer(1000*(7 + (6*CP)));
                return;
            }

            if (ObjectManager.Target.HealthPercent > 24)
            {
                if (Rip.IsSpellUsable && Rip.KnownSpell && Rip.IsHostileDistanceGood && !_fivePtRip
                    && ObjectManager.Me.ComboPoint > 4 && MySettings.UseRip)
                {
                    Rip.Cast();
                    _ripTimer = new Timer(1000*19);
                    _fivePtRip = true;
                    return;
                }

                if (Rip.IsSpellUsable && Rip.KnownSpell && Rip.IsHostileDistanceGood && MySettings.UseRip
                    && (!Rip.TargetHaveBuff || _ripTimer.IsReady) && ObjectManager.Me.ComboPoint > 0)
                {
                    CP = ObjectManager.Me.ComboPoint;
                    Rip.Cast();
                    _ripTimer = new Timer(1000*19);
                    if (CP == 5)
                        _fivePtRip = true;
                    else
                        _fivePtRip = false;
                    return;
                }
            }
            else
            {
                if (Rip.IsSpellUsable && Rip.KnownSpell && Rip.IsHostileDistanceGood && !Rip.TargetHaveBuff
                    && MySettings.UseRip && ObjectManager.Me.ComboPoint > 0)
                {
                    CP = ObjectManager.Me.ComboPoint;
                    Rip.Cast();
                    _ripTimer = new Timer(1000*19);
                    if (CP == 5)
                        _fivePtRip = true;
                    else
                        _fivePtRip = false;
                    return;
                }

                if (FerociousBite.IsSpellUsable && FerociousBite.KnownSpell && FerociousBite.IsHostileDistanceGood
                    && ObjectManager.Me.ComboPoint > 4 && MySettings.UseFerociousBite)
                {
                    FerociousBite.Cast();
                    _ripTimer = new Timer(1000*19);
                    _fivePtRip = true;
                    return;
                }

                if (FerociousBite.IsSpellUsable && FerociousBite.KnownSpell && FerociousBite.IsHostileDistanceGood
                    && MySettings.UseFerociousBite && _ripTimer.IsReady && Rip.TargetHaveBuff
                    && ObjectManager.Me.ComboPoint < 5 && ObjectManager.Me.ComboPoint > 0)
                {
                    FerociousBite.Cast();
                    _ripTimer = new Timer(1000*19);
                    _fivePtRip = false;
                    return;
                }
            }

            if (FerociousBite.IsSpellUsable && FerociousBite.KnownSpell && FerociousBite.IsHostileDistanceGood
                && MySettings.UseFerociousBite && !_ripTimer.IsReady && ObjectManager.Me.ComboPoint > 4
                && ObjectManager.Target.HealthPercent > 24 && !_savageRoarTimer.IsReady
                && ObjectManager.Me.Energy > 49 && _fivePtRip)
            {
                FerociousBite.Cast();
                return;
            }

            if (Shred.KnownSpell && Shred.IsSpellUsable && Shred.IsHostileDistanceGood
                && MySettings.UseShred && ObjectManager.Me.ComboPoint < 5 && !_rakeTimer.IsReady)
            {
                if (Rip.IsSpellUsable && Rip.KnownSpell && Rip.IsHostileDistanceGood && !Rip.TargetHaveBuff
                    && MySettings.UseRip && ObjectManager.Me.ComboPoint > 0)
                {
                    CP = ObjectManager.Me.ComboPoint;
                    Rip.Cast();
                    _ripTimer = new Timer(1000*19);
                    if (CP == 5)
                        _fivePtRip = true;
                    else
                        _fivePtRip = false;
                    return;
                }

                Shred.Cast();
                if (MySettings.UseGlyphofSavageRoar && Incarnation.KnownSpell && ObjectManager.Me.HaveBuff(102543))
                    _savageRoarTimer = new Timer(1000*37);
                return;
            }

            if (ArcaneTorrent.IsSpellUsable && ArcaneTorrent.KnownSpell
                && MySettings.UseArcaneTorrentForResource)
            {
                ArcaneTorrent.Cast();
            }
        }
        finally
        {
            Memory.WowMemory.GameFrameUnLock();
        }
    }

    private void Patrolling()
    {
        if (ObjectManager.Me.IsMounted) return;
        Buff();
        Heal();
    }

    #region Nested type: DruidFeralSettings

    [Serializable]
    public class DruidFeralSettings : Settings
    {
        public bool DoAvoidMelee = false;
        public int DoAvoidMeleeDistance = 0;
        public bool UseAlchFlask = true;
        public bool UseArcaneTorrentForDecast = true;
        public int UseArcaneTorrentForDecastAtPercentage = 100;
        public bool UseArcaneTorrentForResource = true;
        public bool UseBarkskin = true;
        public bool UseBerserk = true;
        public bool UseBerserking = true;
        public bool UseBloodFury = true;
        public bool UseCatForm = true;
        public bool UseCenarionWard = true;
        public bool UseDash = true;
        public bool UseDisorientingRoar = true;
        public bool UseDisplacerBeast = false;

        public bool UseFaerieFire = true;
        public bool UseFerociousBite = true;
        public bool UseForceofNature = true;
        public bool UseGiftoftheNaaru = true;
        public int UseGiftoftheNaaruAtPercentage = 80;
        public bool UseGlyphofSavageRoar = false;
        public bool UseHealingTouch = true;
        public bool UseHeartoftheWild = true;
        public bool UseIncarnation = true;
        public bool UseInnervate = true;

        public bool UseLowCombat = true;
        public bool UseMaim = true;
        public bool UseMangle = true;
        public bool UseMarkoftheWild = true;
        public bool UseMassEntanglement = true;
        public bool UseMightofUrsoc = true;
        public bool UseMightyBash = true;
        public bool UseNaturesGrasp = true;
        public bool UseNaturesSwiftness = true;
        public bool UseNaturesVigil = true;
        public bool UsePounce = true;
        public bool UseProwl = false;
        public bool UseRake = true;
        public bool UseRavage = true;
        public bool UseRejuvenation = true;
        public bool UseRenewal = true;
        public bool UseRip = true;
        public bool UseSavageRoar = true;
        public bool UseShred = true;
        public bool UseSkullBash = true;
        public bool UseStampedingRoar = true;
        public bool UseStoneform = true;
        public int UseStoneformAtPercentage = 80;
        public bool UseSurvivalInstincts = true;
        public bool UseSwipe = true;
        public bool UseThrash = true;
        public bool UseTigersFury = true;
        public bool UseTranquility = true;
        public bool UseTrinketOne = true;
        public bool UseTrinketTwo = true;
        public bool UseTyphoon = true;
        public bool UseUrsolsVortex = true;
        public bool UseWarStomp = true;
        public int UseWarStompAtPercentage = 80;
        public bool UseWildCharge = true;

        public DruidFeralSettings()
        {
            ConfigWinForm("Druid Feral Settings");
            /* Professions & Racials */
            AddControlInWinForm("Use Arcane Torrent for Interrupt", "UseArcaneTorrentForDecast", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Arcane Torrent for Resource", "UseArcaneTorrentForResource", "Professions & Racials");
            AddControlInWinForm("Use Berserking", "UseBerserking", "Professions & Racials");
            AddControlInWinForm("Use Blood Fury", "UseBloodFury", "Professions & Racials");
            AddControlInWinForm("Use Gift of the Naaru", "UseGiftoftheNaaru", "Professions & Racials");

            AddControlInWinForm("Use Stoneform", "UseStoneform", "Professions & Racials");
            AddControlInWinForm("Use War Stomp", "UseWarStomp", "Professions & Racials");
            /* Druid Buffs */
            AddControlInWinForm("Use Cat Form", "UseCatForm", "Druid Buffs");
            AddControlInWinForm("Use Dash", "UseDash", "Druid Buffs");
            AddControlInWinForm("Use Displacer Beast", "UseDisplacerBeast", "Druid Buffs");
            AddControlInWinForm("Use Faerie Fire", "UseFaerieFire", "Druid Buffs");
            AddControlInWinForm("Use Mark of the Wild", "UseMarkoftheWild", "Druid Buffs");
            AddControlInWinForm("Use Prowl", "UseProwl", "Druid Buffs");
            AddControlInWinForm("Use Savage Roar", "UseSavageRoar", "Druid Buffs");
            AddControlInWinForm("Use Stampeding Roar", "UseStampedingRoar", "Druid Buffs");
            /* Offensive Spell */
            AddControlInWinForm("Use Ferocious Bite", "UseFerociousBite", "Offensive Spell");
            AddControlInWinForm("Use Maim ", "UseMaim ", "Offensive Spell");
            AddControlInWinForm("Use Mangle", "UseMangle", "Offensive Spell");
            AddControlInWinForm("Use Pounce", "UsePounce", "Offensive Spell");
            AddControlInWinForm("Use Rake", "UseRake", "Offensive Spell");
            AddControlInWinForm("Use Ravage", "UseRavage", "Offensive Spell");
            AddControlInWinForm("Use Rip", "UseRip", "Offensive Spell");
            AddControlInWinForm("Use Shred", "UseShred", "Offensive Spell");
            AddControlInWinForm("Use Swipe", "UseSwipe", "Offensive Spell");
            AddControlInWinForm("Use Thrash", "UseThrash", "Offensive Spell");
            /* Offensive Cooldown */
            AddControlInWinForm("Use Berserk", "UseBerserk", "Offensive Cooldown");
            AddControlInWinForm("Use Force of Nature", "UseForceofNature", "Offensive Cooldown");
            AddControlInWinForm("Use Heart of the Wild", "UseHeartoftheWild", "Offensive Cooldown");
            AddControlInWinForm("Use Incarnation", "UseIncarnation", "Offensive Cooldown");
            AddControlInWinForm("Use Nature's Vigil", "UseNaturesVigil", "Offensive Cooldown");
            AddControlInWinForm("Use Tiger's Fury", "UseTigersFury", "Offensive Cooldown");
            /* Defensive Cooldown */
            AddControlInWinForm("Use Barkskin", "UseBarkskin", "Defensive Cooldown");
            AddControlInWinForm("Use Disorienting Roar", "UseDisorientingRoar", "Defensive Cooldown");
            AddControlInWinForm("Use Mass Entanglement", "UseMassEntanglement", "Defensive Cooldown");
            AddControlInWinForm("Use Mighty Bash", "UseMightyBash", "Defensive Cooldown");
            AddControlInWinForm("Use Nature's Grasp", "UseNaturesGrasp", "Defensive Cooldown");
            AddControlInWinForm("Use Skull Bash", "UseSkullBash", "Defensive Cooldown");
            AddControlInWinForm("Use Survival Instincts", "UseSurvivalInstincts", "Defensive Cooldown");
            AddControlInWinForm("Use Typhoon", "UseTyphoon", "Defensive Cooldown");
            AddControlInWinForm("Use Ursol's Vortex", "UseUrsolsVortex", "Defensive Cooldown");
            AddControlInWinForm("Use Wild Charge", "UseWildCharge", "Defensive Cooldown");
            /* Healing Spell */
            AddControlInWinForm("Use Cenarion Ward", "UseCenarionWard", "Healing Spell");
            AddControlInWinForm("Use Healing Touch", "UseHealingTouch", "Healing Spell");
            AddControlInWinForm("Use Innervate", "UseInnervate", "Healing Spell");
            AddControlInWinForm("Use Might of Ursoc", "UseMightofUrsoc", "Healing Spell");
            AddControlInWinForm("Use Nature's Swiftness", "UseNaturesSwiftness", "Healing Spell");
            AddControlInWinForm("Use Rejuvenation", "UseRejuvenation", "Healing Spell");
            AddControlInWinForm("Use Renewal", "UseRenewal", "Healing Spell");
            AddControlInWinForm("Use Tranquility", "UseTranquility", "Healing Spell");
            /* Game Settings */
            AddControlInWinForm("Using Glyph of Savage Roar?", "UseGlyphofSavageRoar", "Game Settings");
            AddControlInWinForm("Use Low Combat Settings", "UseLowCombat", "Game Settings");
            AddControlInWinForm("Use Trinket One", "UseTrinketOne", "Game Settings");
            AddControlInWinForm("Use Trinket Two", "UseTrinketTwo", "Game Settings");

            AddControlInWinForm("Use Alchemist Flask", "UseAlchFlask", "Game Settings");
            AddControlInWinForm("Do avoid melee (Off Advised!!)", "DoAvoidMelee", "Game Settings");
            AddControlInWinForm("Avoid melee distance (1 to 4)", "DoAvoidMeleeDistance", "Game Settings");
        }

        public static DruidFeralSettings CurrentSetting { get; set; }

        public static DruidFeralSettings GetSettings()
        {
            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Druid_Feral.xml";
            if (File.Exists(currentSettingsFile))
            {
                return
                    CurrentSetting = Load<DruidFeralSettings>(currentSettingsFile);
            }
            return new DruidFeralSettings();
        }
    }

    #endregion
}

public class DruidRestoration
{
    private static DruidRestorationSettings MySettings = DruidRestorationSettings.GetSettings();

    #region General Timers & Variables

    private readonly WoWItem _firstTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET);
    private readonly WoWItem _secondTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET, 2);

    private Timer _onCd = new Timer(0);

    #endregion

    #region Professions & Racials

    public readonly Spell Alchemy = new Spell("Alchemy");
    public readonly Spell ArcaneTorrent = new Spell("Arcane Torrent");
    public readonly Spell Berserking = new Spell("Berserking");
    public readonly Spell BloodFury = new Spell("Blood Fury");

    public readonly Spell GiftoftheNaaru = new Spell("Gift of the Naaru");

    public readonly Spell Stoneform = new Spell("Stoneform");
    public readonly Spell WarStomp = new Spell("War Stomp");

    #endregion

    #region Druid Buffs

    public readonly Spell Dash = new Spell("Dash");
    public readonly Spell FaerieFire = new Spell("Faerie Fire");
    public readonly Spell MarkoftheWild = new Spell("Mark of the Wild");
    public readonly Spell StampedingRoar = new Spell("Stampeding Roar");

    #endregion

    #region Offensive Spell

    public readonly Spell Hurricane = new Spell("Hurricane");
    public readonly Spell Moonfire = new Spell("Moonfire");
    public readonly Spell Wrath = new Spell("Wrath");
    private Timer _moonfireTimer = new Timer(0);

    #endregion

    #region Healing Cooldown

    public readonly Spell ForceofNature = new Spell("Force of Nature");
    public readonly Spell Incarnation = new Spell("Incarnation");

    #endregion

    #region Defensive Cooldown

    public readonly Spell Barkskin = new Spell("Barkskin");
    public readonly Spell DisorientingRoar = new Spell("Disorienting Roar");
    public readonly Spell EntanglingRoots = new Spell("Entangling Roots");
    public readonly Spell Ironbark = new Spell("Ironbark");
    public readonly Spell MassEntanglement = new Spell("Mass Entanglement");
    public readonly Spell MightyBash = new Spell("Mighty Bash");
    public readonly Spell NaturesGrasp = new Spell("Nature's Grasp");
    public readonly Spell SolarBeam = new Spell("Solar Beam");
    public readonly Spell Typhoon = new Spell("Typhoon");
    public readonly Spell UrsolsVortex = new Spell("Ursol's Vortex");
    public readonly Spell WildCharge = new Spell("Wild Charge");

    #endregion

    #region Healing Spell

    public readonly Spell CenarionWard = new Spell("Cenarion Ward");
    public readonly Spell HealingTouch = new Spell("Healing Touch");
    public readonly Spell Innervate = new Spell("Innervate");
    public readonly Spell Lifebloom = new Spell("Lifebloom");
    public readonly Spell MightofUrsoc = new Spell("Might of Ursoc");
    public readonly Spell NaturesSwiftness = new Spell("Nature's Swiftness");
    public readonly Spell Nourish = new Spell("Nourish");
    public readonly Spell Regrowth = new Spell("Regrowth");
    public readonly Spell Rejuvenation = new Spell("Rejuvenation");
    public readonly Spell Renewal = new Spell("Renewal");
    public readonly Spell Swiftmend = new Spell("Swiftmend");
    public readonly Spell Tranquility = new Spell("Tranquility");
    public readonly Spell WildGrowth = new Spell("Wild Growth");
    public readonly Spell WildMushroom = new Spell("Wild Mushroom");
    public readonly Spell WildMushroomBloom = new Spell("Wild Mushroom: Bloom");
    private Timer _healingTouchTimer = new Timer(0);
    private Timer _nourishTimer = new Timer(0);

    #endregion

    public DruidRestoration()
    {
        Main.InternalRange = 30.0f;
        Main.InternalAggroRange = 30f;
        MySettings = DruidRestorationSettings.GetSettings();
        Main.DumpCurrentSettings<DruidRestorationSettings>(MySettings);
        UInt128 lastTarget = 0;

        while (Main.InternalLoop)
        {
            try
            {
                if (!ObjectManager.Me.IsDeadMe)
                {
                    if (!ObjectManager.Me.IsMounted)
                    {
                        if (Fight.InFight && ObjectManager.Me.Target > 0)
                        {
                            if (ObjectManager.Me.Target != lastTarget
                                && (Moonfire.IsHostileDistanceGood || Wrath.IsHostileDistanceGood))
                            {
                                Pull();
                                lastTarget = ObjectManager.Me.Target;
                            }

                            if (ObjectManager.Target.GetDistance <= 40f)
                                Combat();
                        }
                        if (!ObjectManager.Me.IsCast)
                            Patrolling();
                    }
                }
                else
                    Thread.Sleep(500);
            }
            catch
            {
            }
            Thread.Sleep(100);
        }
    }

    private void Pull()
    {
        if (Moonfire.KnownSpell && Moonfire.IsHostileDistanceGood && Moonfire.IsSpellUsable
            && MySettings.UseMoonfire)
        {
            Moonfire.Cast();
            _moonfireTimer = new Timer(1000*11);
            return;
        }
        if (Wrath.KnownSpell && Wrath.IsHostileDistanceGood && Wrath.IsSpellUsable
            && MySettings.UseWrath)
        {
            Wrath.Cast();
        }
    }

    private void Combat()
    {
        Buff();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        if (_onCd.IsReady)
            DefenseCycle();
        DPSCycle();
        Heal();
        Decast();
        DPSCycle();
        HealingBurst();
        DPSCycle();
    }

    private void Buff()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (MySettings.UseAlchFlask && !ObjectManager.Me.HaveBuff(79638) && !ObjectManager.Me.HaveBuff(79640) && !ObjectManager.Me.HaveBuff(79639)
            && !ItemsManager.IsItemOnCooldown(75525) && ItemsManager.GetItemCount(75525) > 0)
        {
            ItemsManager.UseItem(75525);
            return;
        }
        if (MarkoftheWild.KnownSpell && MarkoftheWild.IsSpellUsable && !MarkoftheWild.HaveBuff
            && MySettings.UseMarkoftheWild)
        {
            MarkoftheWild.Cast();
            return;
        }
        if (!ObjectManager.Me.InCombat && MySettings.UseDash
            && Dash.KnownSpell && Dash.IsSpellUsable && !Dash.HaveBuff && !StampedingRoar.HaveBuff
            && ObjectManager.Me.GetMove)
        {
            Dash.Cast();
            return;
        }
        if (!ObjectManager.Me.InCombat && MySettings.UseStampedingRoar
            && StampedingRoar.KnownSpell && StampedingRoar.IsSpellUsable && !Dash.HaveBuff
            && !StampedingRoar.HaveBuff && ObjectManager.Me.GetMove)
        {
            StampedingRoar.Cast();
        }
    }

    private void AvoidMelee()
    {
        if (ObjectManager.Target.GetDistance < MySettings.DoAvoidMeleeDistance && ObjectManager.Target.InCombat)
        {
            Logging.WriteFight("Too Close. Moving Back");
            var maxTimeTimer = new Timer(1000*2);
            MovementsAction.MoveBackward(true);
            while (ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat && !maxTimeTimer.IsReady)
                Others.SafeSleep(300);
            MovementsAction.MoveBackward(false);
            if (maxTimeTimer.IsReady && ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat)
            {
                MovementsAction.MoveForward(true);
                Others.SafeSleep(1000);
                MovementsAction.MoveForward(false);
                MovementManager.Face(ObjectManager.Target.Position);
            }
        }
    }

    private void DefenseCycle()
    {
        if (ObjectManager.Me.HealthPercent <= MySettings.UseStoneformAtPercentage && Stoneform.IsSpellUsable &&
            Stoneform.KnownSpell
            && MySettings.UseStoneform)
        {
            Stoneform.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 80 && Barkskin.KnownSpell && Barkskin.IsSpellUsable
            && MySettings.UseBarkskin)
        {
            Barkskin.Cast();
            _onCd = new Timer(1000*12);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 80 && Ironbark.KnownSpell && Ironbark.IsSpellUsable
            && MySettings.UseIronbark)
        {
            Ironbark.Cast();
            _onCd = new Timer(1000*12);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 80 && MightyBash.KnownSpell && MightyBash.IsSpellUsable
            && MySettings.UseMightyBash && MightyBash.IsHostileDistanceGood)
        {
            MightyBash.Cast();
            _onCd = new Timer(1000*5);
            return;
        }
        if (MassEntanglement.KnownSpell && MassEntanglement.IsSpellUsable && MassEntanglement.IsHostileDistanceGood
            && MySettings.UseMassEntanglement && ObjectManager.Me.HealthPercent < 80)
        {
            MassEntanglement.Cast();

            if (WildCharge.KnownSpell && WildCharge.IsHostileDistanceGood && WildCharge.IsSpellUsable
                && MySettings.UseWildCharge)
            {
                Others.SafeSleep(200);
                WildCharge.Cast();
            }
            return;
        }
        if (UrsolsVortex.KnownSpell && UrsolsVortex.IsSpellUsable && UrsolsVortex.IsHostileDistanceGood
            && MySettings.UseUrsolsVortex && ObjectManager.Me.HealthPercent < 80)
        {
            UrsolsVortex.Cast();

            if (WildCharge.KnownSpell && WildCharge.IsHostileDistanceGood && WildCharge.IsSpellUsable
                && MySettings.UseWildCharge)
            {
                Others.SafeSleep(200);
                WildCharge.Cast();
            }
            return;
        }
        if (NaturesGrasp.KnownSpell && NaturesGrasp.IsSpellUsable
            && ObjectManager.Target.IsCast && MySettings.UseNaturesGrasp && ObjectManager.Me.HealthPercent < 80)
        {
            NaturesGrasp.Cast();

            if (WildCharge.KnownSpell && WildCharge.IsHostileDistanceGood && WildCharge.IsSpellUsable
                && MySettings.UseWildCharge)
            {
                Others.SafeSleep(200);
                WildCharge.Cast();
            }
            return;
        }
        if (Typhoon.KnownSpell && Typhoon.IsSpellUsable && ObjectManager.GetNumberAttackPlayer() > 2
            && ObjectManager.Target.GetDistance <= 40f && ObjectManager.Me.HealthPercent < 70
            && MySettings.UseTyphoon)
        {
            Typhoon.Cast();
            return;
        }
        if (DisorientingRoar.KnownSpell && DisorientingRoar.IsSpellUsable &&
            ObjectManager.GetNumberAttackPlayer() > 2
            && ObjectManager.Target.GetDistance < 10 && ObjectManager.Me.HealthPercent < 70
            && MySettings.UseDisorientingRoar)
        {
            DisorientingRoar.Cast();
            _onCd = new Timer(1000*3);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseWarStompAtPercentage && WarStomp.IsSpellUsable &&
            WarStomp.KnownSpell
            && MySettings.UseWarStomp)
        {
            WarStomp.Cast();
            _onCd = new Timer(1000*2);
        }
    }

    private void Heal()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (ArcaneTorrent.IsSpellUsable && ArcaneTorrent.KnownSpell &&
            ObjectManager.Me.ManaPercentage <= MySettings.UseArcaneTorrentForResourceAtPercentage
            && MySettings.UseArcaneTorrentForResource)
        {
            ArcaneTorrent.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 80 && NaturesSwiftness.IsSpellUsable && NaturesSwiftness.KnownSpell
            && MySettings.UseNaturesSwiftness && MySettings.UseHealingTouch)
        {
            NaturesSwiftness.Cast();
            Others.SafeSleep(400);
            HealingTouch.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 70 && Renewal.IsSpellUsable && Renewal.KnownSpell
            && MySettings.UseRenewal)
        {
            Renewal.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 95 && !ObjectManager.Me.InCombat && HealingTouch.IsSpellUsable && HealingTouch.KnownSpell && MySettings.UseHealingTouch)
        {
            HealingTouch.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 90 && CenarionWard.IsSpellUsable && CenarionWard.KnownSpell
            && MySettings.UseCenarionWard)
        {
            CenarionWard.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseGiftoftheNaaruAtPercentage &&
            GiftoftheNaaru.IsSpellUsable && GiftoftheNaaru.KnownSpell
            && MySettings.UseGiftoftheNaaru)
        {
            GiftoftheNaaru.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 90 && Rejuvenation.IsSpellUsable && Rejuvenation.KnownSpell
            && !Rejuvenation.HaveBuff && MySettings.UseRejuvenation)
        {
            Rejuvenation.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 60 && Regrowth.IsSpellUsable && Regrowth.KnownSpell
            && !Regrowth.HaveBuff && MySettings.UseRegrowth)
        {
            Regrowth.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 80 && Swiftmend.IsSpellUsable && Swiftmend.KnownSpell
            && MySettings.UseSwiftmend)
        {
            Swiftmend.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 50 && WildGrowth.IsSpellUsable && WildGrowth.KnownSpell
            && MySettings.UseWildGrowth)
        {
            WildGrowth.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 40 && HealingTouch.IsSpellUsable && HealingTouch.KnownSpell
            && _healingTouchTimer.IsReady && MySettings.UseHealingTouch)
        {
            HealingTouch.Cast();
            _healingTouchTimer = new Timer(1000*15);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 40 && Nourish.IsSpellUsable && Nourish.KnownSpell
            && _nourishTimer.IsReady && MySettings.UseNourish && !MySettings.UseHealingTouch)
        {
            Nourish.Cast();
            _nourishTimer = new Timer(1000*15);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 35 && MightofUrsoc.IsSpellUsable && MightofUrsoc.KnownSpell
            && MySettings.UseMightofUrsoc)
        {
            MightofUrsoc.Cast();
            return;
        }
        if (WildMushroom.KnownSpell && WildMushroom.IsSpellUsable && ObjectManager.GetNumberAttackPlayer() > 3
            && WildMushroomBloom.KnownSpell && WildMushroom.IsSpellUsable && MySettings.UseWildMushroom
            && ObjectManager.Me.HealthPercent < 80)
        {
            for (int i = 0; i < 3; i++)
            {
                SpellManager.CastSpellByIDAndPosition(88747, ObjectManager.Target.Position);
                Others.SafeSleep(200);
            }

            WildMushroomBloom.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 30 && Tranquility.IsSpellUsable && Tranquility.KnownSpell
            && MySettings.UseTranquility)
        {
            Tranquility.Cast(false, true);
            return;
        }

        if (ObjectManager.Me.ManaPercentage < 50 && MySettings.UseInnervate)
        {
            Innervate.Cast();
        }
    }

    private void Decast()
    {
        if (ArcaneTorrent.IsSpellUsable && ArcaneTorrent.KnownSpell && ObjectManager.Target.GetDistance < 8
            && ObjectManager.Me.HealthPercent <= MySettings.UseArcaneTorrentForDecastAtPercentage
            && MySettings.UseArcaneTorrentForDecast && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe)
        {
            ArcaneTorrent.Cast();
        }
    }

    public void HealingBurst()
    {
        if (MySettings.UseTrinketOne && !ItemsManager.IsItemOnCooldown(_firstTrinket.Entry) && ItemsManager.IsItemUsable(_firstTrinket.Entry))
        {
            ItemsManager.UseItem(_firstTrinket.Name);
            Logging.WriteFight("Use First Trinket Slot");
        }

        if (MySettings.UseTrinketTwo && !ItemsManager.IsItemOnCooldown(_secondTrinket.Entry) && ItemsManager.IsItemUsable(_secondTrinket.Entry))
        {
            ItemsManager.UseItem(_secondTrinket.Name);
            Logging.WriteFight("Use Second Trinket Slot");
            return;
        }
        if (Berserking.IsSpellUsable && Berserking.KnownSpell && ObjectManager.Target.GetDistance <= 40f
            && MySettings.UseBerserking)
        {
            Berserking.Cast();
            return;
        }
        if (BloodFury.IsSpellUsable && BloodFury.KnownSpell && ObjectManager.Target.GetDistance <= 40f
            && MySettings.UseBloodFury)
        {
            BloodFury.Cast();
            return;
        }
        if (ForceofNature.IsSpellUsable && ForceofNature.KnownSpell && ForceofNature.IsHostileDistanceGood
            && MySettings.UseForceofNature)
        {
            SpellManager.CastSpellByIDAndPosition(106737, ObjectManager.Target.Position);
            return;
        }
        if (Incarnation.IsSpellUsable && Incarnation.KnownSpell && MySettings.UseIncarnation
            && ObjectManager.Target.GetDistance <= 40f)
        {
            Incarnation.Cast();
        }
    }

    private void DPSCycle()
    {
        Usefuls.SleepGlobalCooldown();
        try
        {
            Memory.WowMemory.GameFrameLock(); // !!! WARNING - DONT SLEEP WHILE LOCKED - DO FINALLY(GameFrameUnLock()) !!!

            if (Moonfire.KnownSpell && Moonfire.IsHostileDistanceGood && Moonfire.IsSpellUsable
                && MySettings.UseMoonfire && (!Moonfire.TargetHaveBuff || _moonfireTimer.IsReady))
            {
                Moonfire.Cast();
                _moonfireTimer = new Timer(1000*11);
                return;
            }
            if (Hurricane.KnownSpell && Hurricane.IsSpellUsable && ObjectManager.GetNumberAttackPlayer() > 2 &&
                ObjectManager.Target.GetDistance <= 40f && MySettings.UseHurricane)
            {
                SpellManager.CastSpellByIDAndPosition(16914, ObjectManager.Target.Position);
                return;
            }
            if (Wrath.KnownSpell && Wrath.IsSpellUsable && Wrath.IsHostileDistanceGood
                && MySettings.UseWrath)
            {
                Wrath.Cast();
            }
        }
        finally
        {
            Memory.WowMemory.GameFrameUnLock();
        }
    }

    private void Patrolling()
    {
        if (ObjectManager.Me.IsMounted) return;
        Buff();
        Heal();
    }

    #region Nested type: DruidRestorationSettings

    [Serializable]
    public class DruidRestorationSettings : Settings
    {
        public bool DoAvoidMelee = false;
        public int DoAvoidMeleeDistance = 0;
        public bool UseAlchFlask = true;
        public bool UseArcaneTorrentForDecast = true;
        public int UseArcaneTorrentForDecastAtPercentage = 100;
        public bool UseArcaneTorrentForResource = true;
        public int UseArcaneTorrentForResourceAtPercentage = 80;
        public bool UseBarkskin = true;
        public bool UseBerserking = true;
        public bool UseBloodFury = true;
        public bool UseCenarionWard = true;
        public bool UseDash = true;
        public bool UseDisorientingRoar = true;

        public bool UseEntanglingRoots = true;
        public bool UseFaerieFire = true;
        public bool UseForceofNature = true;
        public bool UseGiftoftheNaaru = true;
        public int UseGiftoftheNaaruAtPercentage = 80;
        public bool UseHealingTouch = true;
        public bool UseHurricane = true;
        public bool UseIncarnation = true;
        public bool UseInnervate = true;
        public bool UseIronbark = true;

        public bool UseLifebloom = true;
        public bool UseLowCombat = true;
        public bool UseMarkoftheWild = true;
        public bool UseMassEntanglement = true;
        public bool UseMightofUrsoc = true;
        public bool UseMightyBash = true;
        public bool UseMoonfire = true;
        public bool UseNaturesGrasp = true;
        public bool UseNaturesSwiftness = true;
        public bool UseNourish = false;
        public bool UseRegrowth = true;
        public bool UseRejuvenation = true;
        public bool UseRenewal = true;
        public bool UseSolarBeam = true;
        public bool UseStampedingRoar = true;
        public bool UseStoneform = true;
        public int UseStoneformAtPercentage = 80;
        public bool UseSwiftmend = true;
        public bool UseTranquility = true;
        public bool UseTrinketOne = true;
        public bool UseTrinketTwo = true;
        public bool UseTyphoon = true;
        public bool UseUrsolsVortex = true;
        public bool UseWarStomp = true;
        public int UseWarStompAtPercentage = 80;
        public bool UseWildCharge = true;
        public bool UseWildGrowth = true;
        public bool UseWildMushroom = false;
        public bool UseWrath = true;

        public DruidRestorationSettings()
        {
            ConfigWinForm("Druid Restoration Settings");
            /* Professions & Racials */
            AddControlInWinForm("Use Arcane Torrent for Interrupt", "UseArcaneTorrentForDecast", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Arcane Torrent for Resource", "UseArcaneTorrentForResource", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Berserking", "UseBerserking", "Professions & Racials");
            AddControlInWinForm("Use Blood Fury", "UseBloodFury", "Professions & Racials");
            AddControlInWinForm("Use Gift of the Naaru", "UseGiftoftheNaaru", "Professions & Racials");

            AddControlInWinForm("Use Stoneform", "UseStoneform", "Professions & Racials");
            AddControlInWinForm("Use War Stomp", "UseWarStomp", "Professions & Racials");
            /* Druid Buffs */
            AddControlInWinForm("Use Dash", "UseDash", "Druid Buffs");
            AddControlInWinForm("Use Faerie Fire", "UseFaerieFire", "Druid Buffs");
            AddControlInWinForm("Use Mark of the Wild", "UseMarkoftheWild", "Druid Buffs");
            AddControlInWinForm("Use Stampeding Roar", "UseStampedingRoar", "Druid Buffs");
            /* Offensive Spell */
            AddControlInWinForm("Use Hurricane", "UseHurricane", "Offensive Spell");
            AddControlInWinForm("Use Moonfire", "UseMoonfire", "Offensive Spell");
            AddControlInWinForm("Use Wrath", "UseWrath", "Offensive Spell");
            /* Healing Cooldown */
            AddControlInWinForm("Use Force of Nature", "UseForceofNature", "Offensive Cooldown");
            AddControlInWinForm("Use Incarnation", "UseIncarnation", "Offensive Cooldown");
            /* Defensive Cooldown */
            AddControlInWinForm("Use Barkskin", "UseBarkskin", "Defensive Cooldown");
            AddControlInWinForm("Use Disorienting Roar", "UseDisorientingRoar", "Defensive Cooldown");
            AddControlInWinForm("Use Entangling Roots", "UseEntanglingRoots", "Defensive Cooldown");
            AddControlInWinForm("Use Ironbark", "UseIronbark", "Defensive Cooldown");
            AddControlInWinForm("Use Mass Entanglement", "UseMassEntanglement", "Defensive Cooldown");
            AddControlInWinForm("Use Mighty Bash", "UseMightyBash", "Defensive Cooldown");
            AddControlInWinForm("Use Nature's Grasp", "UseNaturesGrasp", "Defensive Cooldown");
            AddControlInWinForm("Use Solar Beam", "UseSolarBeam", "Defensive Cooldown");
            AddControlInWinForm("Use Typhoon", "UseTyphoon", "Defensive Cooldown");
            AddControlInWinForm("Use Ursol's Vortex", "UseUrsolsVortex", "Defensive Cooldown");
            AddControlInWinForm("Use Wild Charge", "UseWildCharge", "Defensive Cooldown");
            /* Healing Spell */
            AddControlInWinForm("Use Cenarion Ward", "UseCenarionWard", "Healing Spell");
            AddControlInWinForm("Use Healing Touch", "UseHealingTouch", "Healing Spell");
            AddControlInWinForm("Use Innervate", "UseInnervate", "Healing Spell");
            AddControlInWinForm("Use Lifebloom", "UseLifebloom", "Offensive Spell");
            AddControlInWinForm("Use Might of Ursoc", "UseMightofUrsoc", "Healing Spell");
            AddControlInWinForm("Use Nature's Swiftness", "UseNaturesSwiftness", "Healing Spell");
            AddControlInWinForm("Use Nourish", "UseNourish", "Offensive Spell");
            AddControlInWinForm("Use Regrowth", "UseRegrowth", "Offensive Spell");
            AddControlInWinForm("Use Rejuvenation", "UseRejuvenation", "Healing Spell");
            AddControlInWinForm("Use Renewal", "UseRenewal", "Healing Spell");
            AddControlInWinForm("Use Swiftmend", "UseSwiftmend", "Offensive Spell");
            AddControlInWinForm("Use Tranquility", "UseTranquility", "Healing Spell");
            AddControlInWinForm("Use Wild Growth", "UseWildGrowth", "Offensive Spell");
            AddControlInWinForm("Use WildMushroom", "UseWildMushroom", "Offensive Spell");
            /* Game Settings */
            AddControlInWinForm("Use Low Combat Settings", "UseLowCombat", "Game Settings");
            AddControlInWinForm("Use Trinket One", "UseTrinketOne", "Game Settings");
            AddControlInWinForm("Use Trinket Two", "UseTrinketTwo", "Game Settings");

            AddControlInWinForm("Use Alchemist Flask", "UseAlchFlask", "Game Settings");
            AddControlInWinForm("Do avoid melee (Off Advised!!)", "DoAvoidMelee", "Game Settings");
            AddControlInWinForm("Avoid melee distance (1 to 4)", "DoAvoidMeleeDistance", "Game Settings");
        }

        public static DruidRestorationSettings CurrentSetting { get; set; }

        public static DruidRestorationSettings GetSettings()
        {
            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Druid_Restoration.xml";
            if (File.Exists(currentSettingsFile))
            {
                return
                    CurrentSetting = Load<DruidRestorationSettings>(currentSettingsFile);
            }
            return new DruidRestorationSettings();
        }
    }

    #endregion
}

public class DruidGuardian
{
    private static DruidGuardianSettings MySettings = DruidGuardianSettings.GetSettings();

    #region General Timers & Variables

    private readonly WoWItem _firstTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET);
    private readonly WoWItem _secondTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET, 2);

    private Timer _onCd = new Timer(0);

    #endregion

    #region Professions & Racials

    public readonly Spell Alchemy = new Spell("Alchemy");
    public readonly Spell ArcaneTorrent = new Spell("Arcane Torrent");
    public readonly Spell Berserking = new Spell("Berserking");
    public readonly Spell BloodFury = new Spell("Blood Fury");

    public readonly Spell GiftoftheNaaru = new Spell("Gift of the Naaru");

    public readonly Spell Stoneform = new Spell("Stoneform");
    public readonly Spell WarStomp = new Spell("War Stomp");

    #endregion

    #region Druid Buffs

    public readonly Spell BearForm = new Spell("Bear Form");
    public readonly Spell Dash = new Spell("Dash");
    public readonly Spell FaerieFire = new Spell("Faerie Fire");
    public readonly Spell MarkoftheWild = new Spell("Mark of the Wild");
    public readonly Spell StampedingRoar = new Spell("Stampeding Roar");

    #endregion

    #region Offensive Spell

    public readonly Spell Growl = new Spell("Growl");
    public readonly Spell Lacerate = new Spell("Lacerate");
    public readonly Spell Mangle = new Spell("Mangle");
    public readonly Spell Maul = new Spell("Maul");
    public readonly Spell Swipe = new Spell("Swipe");
    public readonly Spell Thrash = new Spell("Thrash");

    #endregion

    #region Offensive Cooldown

    public readonly Spell Berserk = new Spell("Berserk");
    public readonly Spell Enrage = new Spell("Enrage");
    public readonly Spell ForceofNature = new Spell("Force of Nature");
    public readonly Spell HeartoftheWild = new Spell("Heart of the Wild");
    public readonly Spell Incarnation = new Spell("Incarnation");
    public readonly Spell NaturesVigil = new Spell("Nature's Vigil");

    #endregion

    #region Defensive Cooldown

    public readonly Spell Barkskin = new Spell("Barkskin");
    public readonly Spell BearHug = new Spell("Bear Hug");
    public readonly Spell DisorientingRoar = new Spell("Disorienting Roar");
    public readonly Spell MassEntanglement = new Spell("Mass Entanglement");
    public readonly Spell MightyBash = new Spell("Mighty Bash");
    public readonly Spell NaturesGrasp = new Spell("Nature's Grasp");
    public readonly Spell SavageDefense = new Spell("Savage Defense");
    public readonly Spell SkullBash = new Spell("Skull Bash");
    public readonly Spell SurvivalInstincts = new Spell("Survival Instincts");
    public readonly Spell Typhoon = new Spell("Typhoon");
    public readonly Spell UrsolsVortex = new Spell("Ursol's Vortex");
    public readonly Spell WildCharge = new Spell("Wild Charge");

    #endregion

    #region Healing Spell

    public readonly Spell CenarionWard = new Spell("Cenarion Ward");
    public readonly Spell FrenziedRegeneration = new Spell("FrenziedRegeneration");
    public readonly Spell HealingTouch = new Spell("Healing Touch");
    public readonly Spell Innervate = new Spell("Innervate");
    public readonly Spell MightofUrsoc = new Spell("Might of Ursoc");
    public readonly Spell NaturesSwiftness = new Spell("Nature's Swiftness");
    public readonly Spell Rejuvenation = new Spell("Rejuvenation");
    public readonly Spell Renewal = new Spell("Renewal");
    public readonly Spell Tranquility = new Spell("Tranquility");
    private Timer _healingTouchTimer = new Timer(0);

    #endregion

    public DruidGuardian()
    {
        Main.InternalRange = ObjectManager.Me.GetCombatReach;
        MySettings = DruidGuardianSettings.GetSettings();
        Main.DumpCurrentSettings<DruidGuardianSettings>(MySettings);
        UInt128 lastTarget = 0;

        while (Main.InternalLoop)
        {
            try
            {
                if (!ObjectManager.Me.IsDeadMe)
                {
                    if (!ObjectManager.Me.IsMounted)
                    {
                        if (Fight.InFight && ObjectManager.Me.Target > 0)
                        {
                            if (ObjectManager.Me.Target != lastTarget
                                && (FaerieFire.IsHostileDistanceGood || WildCharge.IsHostileDistanceGood))
                            {
                                Pull();
                                lastTarget = ObjectManager.Me.Target;
                            }

                            if (ObjectManager.Target.Level < 70 && ObjectManager.Me.Level > 84
                                && MySettings.UseLowCombat)
                            {
                                if (ObjectManager.Target.GetDistance < 30)
                                    LowCombat();
                            }
                            else
                            {
                                if (ObjectManager.Target.GetDistance < 30)
                                    Combat();
                            }
                        }
                        if (!ObjectManager.Me.IsCast)
                            Patrolling();
                    }
                }
                else
                    Thread.Sleep(500);
            }
            catch
            {
            }
            Thread.Sleep(100);
        }
    }

    private void Pull()
    {
        if (!ObjectManager.Me.HaveBuff(5487) && MySettings.UseBearForm)
            BearForm.Cast();

        if (WildCharge.KnownSpell && WildCharge.IsSpellUsable && WildCharge.IsHostileDistanceGood
            && MySettings.UseWildCharge && ObjectManager.Target.GetDistance > Main.InternalRange)
        {
            WildCharge.Cast();
            return;
        }
        if (FaerieFire.KnownSpell && FaerieFire.IsSpellUsable && FaerieFire.IsHostileDistanceGood
            && MySettings.UseFaerieFire)
        {
            FaerieFire.Cast();
        }
    }

    private void LowCombat()
    {
        Buff();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        DefenseCycle();
        Heal();

        if (!ObjectManager.Me.HaveBuff(5487) && MySettings.UseBearForm)
        {
            BearForm.Cast();
            return;
        }

        if (Mangle.IsSpellUsable && Mangle.KnownSpell && Mangle.IsHostileDistanceGood
            && MySettings.UseMangle)
        {
            Mangle.Cast();
            if (ObjectManager.Target.HealthPercent < 50 && ObjectManager.Target.HealthPercent > 0)
            {
                Mangle.Cast();
            }
            return;
        }
        if (Maul.IsSpellUsable && Maul.KnownSpell && Maul.IsHostileDistanceGood
            && MySettings.UseMaul)
        {
            Maul.Cast();
            return;
        }
        if (Swipe.IsSpellUsable && Swipe.KnownSpell && Swipe.IsHostileDistanceGood
            && MySettings.UseSwipe)
        {
            Swipe.Cast();
        }
    }

    private void Combat()
    {
        Buff();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        if (_onCd.IsReady)
            DefenseCycle();
        DPSCycle();
        Heal();
        Decast();
        DPSCycle();
        DPSBurst();
        DPSCycle();
    }

    private void Buff()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (MarkoftheWild.KnownSpell && MarkoftheWild.IsSpellUsable && !MarkoftheWild.HaveBuff)
        {
            MarkoftheWild.Cast();
            return;
        }
        if (MySettings.UseAlchFlask && !ObjectManager.Me.HaveBuff(79638) && !ObjectManager.Me.HaveBuff(79640) && !ObjectManager.Me.HaveBuff(79639)
            && !ItemsManager.IsItemOnCooldown(75525) && ItemsManager.GetItemCount(75525) > 0)
        {
            ItemsManager.UseItem(75525);
            return;
        }
        if (!ObjectManager.Me.InCombat && MySettings.UseDash
            && Dash.KnownSpell && Dash.IsSpellUsable && !Dash.HaveBuff && !StampedingRoar.HaveBuff
            && ObjectManager.Me.GetMove)
        {
            Dash.Cast();
            return;
        }
        if (!ObjectManager.Me.InCombat && MySettings.UseStampedingRoar
            && StampedingRoar.KnownSpell && StampedingRoar.IsSpellUsable && !Dash.HaveBuff
            && !StampedingRoar.HaveBuff && ObjectManager.Me.GetMove)
        {
            StampedingRoar.Cast();
        }
    }

    private void AvoidMelee()
    {
        if (ObjectManager.Target.GetDistance < MySettings.DoAvoidMeleeDistance && ObjectManager.Target.InCombat)
        {
            Logging.WriteFight("Too Close. Moving Back");
            var maxTimeTimer = new Timer(1000*2);
            MovementsAction.MoveBackward(true);
            while (ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat && !maxTimeTimer.IsReady)
                Others.SafeSleep(300);
            MovementsAction.MoveBackward(false);
            if (maxTimeTimer.IsReady && ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat)
            {
                MovementsAction.MoveForward(true);
                Others.SafeSleep(1000);
                MovementsAction.MoveForward(false);
                MovementManager.Face(ObjectManager.Target.Position);
            }
        }
    }

    private void Heal()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (ObjectManager.Me.HealthPercent < 80 && NaturesSwiftness.IsSpellUsable && NaturesSwiftness.KnownSpell
            && MySettings.UseNaturesSwiftness && MySettings.UseHealingTouch)
        {
            NaturesSwiftness.Cast();
            Others.SafeSleep(400);
            HealingTouch.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 75 && FrenziedRegeneration.IsSpellUsable &&
            FrenziedRegeneration.KnownSpell
            && MySettings.UseFrenziedRegeneration)
        {
            FrenziedRegeneration.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 70 && Renewal.IsSpellUsable && Renewal.KnownSpell
            && MySettings.UseRenewal)
        {
            Renewal.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 90 && CenarionWard.IsSpellUsable && CenarionWard.KnownSpell
            && MySettings.UseCenarionWard)
        {
            CenarionWard.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 50 && !ObjectManager.Me.InCombat
            && HealingTouch.IsSpellUsable && HealingTouch.KnownSpell && MySettings.UseHealingTouch)
        {
            while (ObjectManager.Me.HealthPercent < 95 && HealingTouch.IsSpellUsable)
            {
                HealingTouch.Cast();
                Others.SafeSleep(1500);
            }
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseGiftoftheNaaruAtPercentage &&
            GiftoftheNaaru.IsSpellUsable && GiftoftheNaaru.KnownSpell)
        {
            GiftoftheNaaru.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 50 && Rejuvenation.IsSpellUsable && Rejuvenation.KnownSpell
            && !Rejuvenation.HaveBuff && MySettings.UseRejuvenation)
        {
            Rejuvenation.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 40 && HealingTouch.IsSpellUsable && HealingTouch.KnownSpell
            && _healingTouchTimer.IsReady && MySettings.UseHealingTouch)
        {
            HealingTouch.Cast();
            _healingTouchTimer = new Timer(1000*15);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 35 && MightofUrsoc.IsSpellUsable && MightofUrsoc.KnownSpell
            && MySettings.UseMightofUrsoc)
        {
            MightofUrsoc.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 30 && Tranquility.IsSpellUsable && Tranquility.KnownSpell
            && MySettings.UseTranquility)
        {
            Tranquility.Cast(false, true);
            return;
        }
        if (ObjectManager.Me.ManaPercentage < 10 && MySettings.UseInnervate)
        {
            Innervate.Cast();
        }
    }

    private void DefenseCycle()
    {
        if (ObjectManager.Me.HealthPercent < 80 && MySettings.UseBarkskin
            && Barkskin.KnownSpell && Barkskin.IsSpellUsable)
        {
            Barkskin.Cast();
            _onCd = new Timer(1000*12);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 90 && MySettings.UseSavageDefense
            && SavageDefense.KnownSpell && SavageDefense.IsSpellUsable)
        {
            SavageDefense.Cast();
            _onCd = new Timer(1000*6);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 90 && MightyBash.IsHostileDistanceGood
            && MightyBash.KnownSpell && MightyBash.IsSpellUsable && MySettings.UseMightyBash)
        {
            MightyBash.Cast();
            _onCd = new Timer(1000*5);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 70 && BearHug.KnownSpell && BearHug.IsSpellUsable
            && MySettings.UseBearHug && BearHug.IsHostileDistanceGood)
        {
            BearHug.Cast();
            _onCd = new Timer(1000*3);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 70 && MySettings.UseSurvivalInstincts
            && SurvivalInstincts.KnownSpell && SurvivalInstincts.IsSpellUsable)
        {
            SurvivalInstincts.Cast();
            _onCd = new Timer(1000*12);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseStoneformAtPercentage && Stoneform.IsSpellUsable &&
            Stoneform.KnownSpell
            && MySettings.UseStoneform)
        {
            Stoneform.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (MassEntanglement.KnownSpell && MassEntanglement.IsSpellUsable && MassEntanglement.IsHostileDistanceGood
            && ObjectManager.Target.IsCast && MySettings.UseMassEntanglement &&
            ObjectManager.GetNumberAttackPlayer() > 2
            && ObjectManager.Me.HealthPercent < 70)
        {
            if (Typhoon.KnownSpell && Typhoon.IsSpellUsable && MySettings.UseTyphoon
                && ObjectManager.Target.GetDistance <= 40f && MySettings.UseTyphoon)
            {
                Typhoon.Cast();
                Others.SafeSleep(200);
            }

            MassEntanglement.Cast();
            return;
        }
        if (UrsolsVortex.KnownSpell && UrsolsVortex.IsSpellUsable && UrsolsVortex.IsHostileDistanceGood
            && MySettings.UseUrsolsVortex && ObjectManager.Me.HealthPercent < 80
            && ObjectManager.GetNumberAttackPlayer() > 2)
        {
            UrsolsVortex.Cast();

            if (WildCharge.KnownSpell && WildCharge.IsHostileDistanceGood && WildCharge.IsSpellUsable
                && MySettings.UseWildCharge && ObjectManager.Target.GetDistance > Main.InternalRange)
            {
                Others.SafeSleep(200);
                WildCharge.Cast();
            }
            return;
        }
        if (NaturesGrasp.KnownSpell && NaturesGrasp.IsSpellUsable && ObjectManager.GetNumberAttackPlayer() > 2
            && ObjectManager.Target.IsCast && MySettings.UseNaturesGrasp && ObjectManager.Me.HealthPercent < 80)
        {
            NaturesGrasp.Cast();
            return;
        }
        if (Typhoon.KnownSpell && Typhoon.IsSpellUsable && ObjectManager.GetNumberAttackPlayer() > 2
            && ObjectManager.Target.GetDistance <= 40f && ObjectManager.Me.HealthPercent < 70
            && MySettings.UseTyphoon)
        {
            Typhoon.Cast();
            return;
        }
        if (DisorientingRoar.KnownSpell && DisorientingRoar.IsSpellUsable &&
            ObjectManager.GetNumberAttackPlayer() > 2
            && ObjectManager.Target.GetDistance < 10 && ObjectManager.Me.HealthPercent < 70
            && MySettings.UseDisorientingRoar)
        {
            DisorientingRoar.Cast();
            _onCd = new Timer(1000*3);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseWarStompAtPercentage && WarStomp.IsSpellUsable &&
            WarStomp.KnownSpell
            && MySettings.UseWarStomp)
        {
            WarStomp.Cast();
            _onCd = new Timer(1000*2);
        }
    }

    private void Decast()
    {
        if (ObjectManager.Target.IsCast && MySettings.UseSkullBash
            && ObjectManager.Target.IsTargetingMe
            && SkullBash.KnownSpell && SkullBash.IsSpellUsable && SkullBash.IsHostileDistanceGood)
        {
            SkullBash.Cast();
            return;
        }
        if (ArcaneTorrent.IsSpellUsable && ArcaneTorrent.KnownSpell && ObjectManager.Target.GetDistance < 8
            && ObjectManager.Me.HealthPercent <= MySettings.UseArcaneTorrentForDecastAtPercentage
            && MySettings.UseArcaneTorrentForDecast && ObjectManager.Target.IsCast &&
            ObjectManager.Target.IsTargetingMe)
        {
            ArcaneTorrent.Cast();
        }
    }

    private void DPSBurst()
    {
        if (MySettings.UseTrinketOne && !ItemsManager.IsItemOnCooldown(_firstTrinket.Entry) && ItemsManager.IsItemUsable(_firstTrinket.Entry))
        {
            ItemsManager.UseItem(_firstTrinket.Name);
            Logging.WriteFight("Use First Trinket Slot");
        }

        if (MySettings.UseTrinketTwo && !ItemsManager.IsItemOnCooldown(_secondTrinket.Entry) && ItemsManager.IsItemUsable(_secondTrinket.Entry))
        {
            ItemsManager.UseItem(_secondTrinket.Name);
            Logging.WriteFight("Use Second Trinket Slot");
            return;
        }
        if (Berserking.IsSpellUsable && Berserking.KnownSpell && ObjectManager.Target.GetDistance < 30 && MySettings.UseBerserking)
        {
            Berserking.Cast();
            return;
        }
        if (BloodFury.IsSpellUsable && BloodFury.KnownSpell && ObjectManager.Target.GetDistance < 30 && MySettings.UseBloodFury)
        {
            BloodFury.Cast();
            return;
        }
        if (Enrage.IsSpellUsable && Enrage.KnownSpell && Enrage.IsHostileDistanceGood
            && MySettings.UseEnrage && ObjectManager.Me.RagePercentage < 70)
        {
            Enrage.Cast();
            return;
        }
        if (ForceofNature.IsSpellUsable && ForceofNature.KnownSpell && ForceofNature.IsHostileDistanceGood
            && MySettings.UseForceofNature)
        {
            SpellManager.CastSpellByIDAndPosition(106737, ObjectManager.Target.Position);
            return;
        }
        if (Incarnation.IsSpellUsable && Incarnation.KnownSpell && MySettings.UseIncarnation
            && ObjectManager.Target.GetDistance < 30)
        {
            Incarnation.Cast();
            return;
        }
        if (HeartoftheWild.IsSpellUsable && HeartoftheWild.KnownSpell && MySettings.UseHeartoftheWild
            && ObjectManager.Target.GetDistance < 30)
        {
            HeartoftheWild.Cast();
            return;
        }
        if (NaturesVigil.IsSpellUsable && NaturesVigil.KnownSpell && MySettings.UseNaturesVigil
            && ObjectManager.Target.GetDistance < 30)
        {
            NaturesVigil.Cast();
            return;
        }
        if (Berserk.KnownSpell && Berserk.IsSpellUsable && MySettings.UseBerserk
            && ObjectManager.Target.GetDistance < 30)
        {
            Berserk.Cast();
        }
    }

    private void DPSCycle()
    {
        Usefuls.SleepGlobalCooldown();
        try
        {
            Memory.WowMemory.GameFrameLock(); // !!! WARNING - DONT SLEEP WHILE LOCKED - DO FINALLY(GameFrameUnLock()) !!!

            if (!ObjectManager.Me.HaveBuff(5487) && MySettings.UseBearForm)
            {
                BearForm.Cast();
                return;
            }
            if (FaerieFire.KnownSpell && FaerieFire.IsSpellUsable && FaerieFire.IsHostileDistanceGood
                && MySettings.UseFaerieFire && (!FaerieFire.TargetHaveBuff || !ObjectManager.Target.HaveBuff(113746)))
            {
                FaerieFire.Cast();
                return;
            }
            if (Growl.KnownSpell && Growl.IsSpellUsable && Growl.IsHostileDistanceGood
                && MySettings.UseGrowl && !ObjectManager.Target.InCombat)
            {
                Growl.Cast();
                return;
            }
            if (Mangle.KnownSpell && Mangle.IsSpellUsable && Mangle.IsHostileDistanceGood
                && MySettings.UseMangle)
            {
                Mangle.Cast();
                return;
            }
            if (Thrash.IsSpellUsable && Thrash.KnownSpell
                && Thrash.IsHostileDistanceGood && !Thrash.TargetHaveBuff && MySettings.UseThrash)
            {
                Thrash.Cast();
                return;
            }
            if (ObjectManager.GetNumberAttackPlayer() > 1 && Swipe.IsSpellUsable && Swipe.KnownSpell
                && Swipe.IsHostileDistanceGood && MySettings.UseSwipe)
            {
                Swipe.Cast();
                return;
            }
            if (Lacerate.KnownSpell && Lacerate.IsSpellUsable && Lacerate.IsHostileDistanceGood
                && MySettings.UseLacerate)
            {
                Lacerate.Cast();
                return;
            }
            if (Maul.KnownSpell && Maul.IsSpellUsable && Maul.IsHostileDistanceGood
                && MySettings.UseMaul && ObjectManager.Me.RagePercentage > 90
                && ObjectManager.Me.HealthPercent > 90)
            {
                Maul.Cast();
                return;
            }
            if (ArcaneTorrent.IsSpellUsable && ArcaneTorrent.KnownSpell
                && MySettings.UseArcaneTorrentForResource)
            {
                ArcaneTorrent.Cast();
            }
        }
        finally
        {
            Memory.WowMemory.GameFrameUnLock();
        }
    }

    private void Patrolling()
    {
        if (ObjectManager.Me.IsMounted) return;
        Buff();
        Heal();
    }

    #region Nested type: DruidGuardianSettings

    [Serializable]
    public class DruidGuardianSettings : Settings
    {
        public bool DoAvoidMelee = false;
        public int DoAvoidMeleeDistance = 0;
        public bool UseAlchFlask = true;
        public bool UseArcaneTorrentForDecast = true;
        public int UseArcaneTorrentForDecastAtPercentage = 100;
        public bool UseArcaneTorrentForResource = true;
        public bool UseBarkskin = true;
        public bool UseBearForm = true;
        public bool UseBearHug = true;
        public bool UseBerserk = true;
        public bool UseBerserking = true;
        public bool UseBloodFury = true;
        public bool UseCenarionWard = true;
        public bool UseDash = true;
        public bool UseDisorientingRoar = true;

        public bool UseEnrage = true;
        public bool UseFaerieFire = true;
        public bool UseForceofNature = true;
        public bool UseFrenziedRegeneration = true;
        public bool UseGiftoftheNaaru = true;
        public int UseGiftoftheNaaruAtPercentage = 80;
        public bool UseGrowl = true;
        public bool UseHealingTouch = true;
        public bool UseHeartoftheWild = true;
        public bool UseIncarnation = true;
        public bool UseInnervate = true;
        public bool UseLacerate = true;

        public bool UseLowCombat = true;
        public bool UseMangle = true;
        public bool UseMarkoftheWild = true;
        public bool UseMassEntanglement = true;
        public bool UseMaul = true;
        public bool UseMightofUrsoc = true;
        public bool UseMightyBash = true;
        public bool UseNaturesGrasp = true;
        public bool UseNaturesSwiftness = true;
        public bool UseNaturesVigil = true;
        public bool UseRejuvenation = true;
        public bool UseRenewal = true;
        public bool UseSavageDefense = true;
        public bool UseSkullBash = true;
        public bool UseStampedingRoar = true;
        public bool UseStoneform = true;
        public int UseStoneformAtPercentage = 80;
        public bool UseSurvivalInstincts = true;
        public bool UseSwipe = true;
        public bool UseThrash = true;
        public bool UseTranquility = true;
        public bool UseTrinketOne = true;
        public bool UseTrinketTwo = true;
        public bool UseTyphoon = true;
        public bool UseUrsolsVortex = true;
        public bool UseWarStomp = true;
        public int UseWarStompAtPercentage = 80;
        public bool UseWildCharge = true;

        public DruidGuardianSettings()
        {
            ConfigWinForm("Druid Guardian Settings");
            /* Professions & Racials */
            AddControlInWinForm("Use Arcane Torrent for Interrupt", "UseArcaneTorrentForDecast", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Arcane Torrent for Resource", "UseArcaneTorrentForResource", "Professions & Racials");
            AddControlInWinForm("Use Berserking", "UseBerserking", "Professions & Racials");
            AddControlInWinForm("Use Blood Fury", "UseBloodFury", "Professions & Racials");
            AddControlInWinForm("Use Gift of the Naaru", "UseGiftoftheNaaru", "Professions & Racials");

            AddControlInWinForm("Use Stoneform", "UseStoneform", "Professions & Racials");
            AddControlInWinForm("Use War Stomp", "UseWarStomp", "Professions & Racials");
            /* Druid Buffs */
            AddControlInWinForm("Use Bear Form", "UseBearForm", "Druid Buffs");
            AddControlInWinForm("Use Dash", "UseDash", "Druid Buffs");
            AddControlInWinForm("Use Faerie Fire", "UseFaerieFire", "Druid Buffs");
            AddControlInWinForm("Use Mark of the Wild", "UseMarkoftheWild", "Druid Buffs");
            AddControlInWinForm("Use Stampeding Roar", "UseStampedingRoar", "Druid Buffs");
            /* Offensive Spell */
            AddControlInWinForm("Use Growl", "UseGrowl", "Offensive Spell");
            AddControlInWinForm("Use Lacerate", "UseLacerate", "Offensive Spell");
            AddControlInWinForm("Use Mangle", "UseMangle", "Offensive Spell");
            AddControlInWinForm("Use Maul", "UseMaul", "Offensive Spell");
            AddControlInWinForm("Use Swipe", "UseSwipe", "Offensive Spell");
            AddControlInWinForm("Use Thrash", "UseThrash", "Offensive Spell");
            /* Offensive Cooldown */
            AddControlInWinForm("Use Berserk", "UseBerserk", "Offensive Cooldown");
            AddControlInWinForm("Use Enrage", "UseEnrage", "Offensive Cooldown");
            AddControlInWinForm("Use Force of Nature", "UseForceofNature", "Offensive Cooldown");
            AddControlInWinForm("Use Heart of the Wild", "UseHeartoftheWild", "Offensive Cooldown");
            AddControlInWinForm("Use Incarnation", "UseIncarnation", "Offensive Cooldown");
            AddControlInWinForm("Use Nature's Vigil", "UseNaturesVigil", "Offensive Cooldown");
            /* Defensive Cooldown */
            AddControlInWinForm("Use Bear Hug", "UseBearHug", "Defensive Cooldown");
            AddControlInWinForm("Use Barkskin", "UseBarkskin", "Defensive Cooldown");
            AddControlInWinForm("Use Disorienting Roar", "UseDisorientingRoar", "Defensive Cooldown");
            AddControlInWinForm("Use Mass Entanglement", "UseMassEntanglement", "Defensive Cooldown");
            AddControlInWinForm("Use Mighty Bash", "UseMightyBash", "Defensive Cooldown");
            AddControlInWinForm("Use Nature's Grasp", "UseNaturesGrasp", "Defensive Cooldown");
            AddControlInWinForm("Use Savage Defense", "UseSavageDefense", "Defensive Cooldown");
            AddControlInWinForm("Use Skull Bash", "UseSkullBash", "Defensive Cooldown");
            AddControlInWinForm("Use Survival Instincts", "UseSurvivalInstincts", "Defensive Cooldown");
            AddControlInWinForm("Use Typhoon", "UseTyphoon", "Defensive Cooldown");
            AddControlInWinForm("Use Ursol's Vortex", "UseUrsolsVortex", "Defensive Cooldown");
            AddControlInWinForm("Use Wild Charge", "UseWildCharge", "Defensive Cooldown");
            /* Healing Spell */
            AddControlInWinForm("Use Cenarion Ward", "UseCenarionWard", "Healing Spell");
            AddControlInWinForm("Use Frenzied Regeneration", "UseFrenziedRegeneration", "Healing Spell");
            AddControlInWinForm("Use Healing Touch", "UseHealingTouch", "Healing Spell");
            AddControlInWinForm("Use Innervate", "UseInnervate", "Healing Spell");
            AddControlInWinForm("Use Might of Ursoc", "UseMightofUrsoc", "Healing Spell");
            AddControlInWinForm("Use Nature's Swiftness", "UseNaturesSwiftness", "Healing Spell");
            AddControlInWinForm("Use Rejuvenation", "UseRejuvenation", "Healing Spell");
            AddControlInWinForm("Use Renewal", "UseRenewal", "Healing Spell");
            AddControlInWinForm("Use Tranquility", "UseTranquility", "Healing Spell");
            /* Game Settings */
            AddControlInWinForm("Using Glyph of Shred?", "UseGlyphofShred", "Game Settings");
            AddControlInWinForm("Use Low Combat Settings", "UseLowCombat", "Game Settings");
            AddControlInWinForm("Use Trinket One", "UseTrinketOne", "Game Settings");
            AddControlInWinForm("Use Trinket Two", "UseTrinketTwo", "Game Settings");

            AddControlInWinForm("Use Alchemist Flask", "UseAlchFlask", "Game Settings");
            AddControlInWinForm("Do avoid melee (Off Advised!!)", "DoAvoidMelee", "Game Settings");
            AddControlInWinForm("Avoid melee distance (1 to 4)", "DoAvoidMeleeDistance", "Game Settings");
        }

        public static DruidGuardianSettings CurrentSetting { get; set; }

        public static DruidGuardianSettings GetSettings()
        {
            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Druid_Guardian.xml";
            if (File.Exists(currentSettingsFile))
            {
                return
                    CurrentSetting = Load<DruidGuardianSettings>(currentSettingsFile);
            }
            return new DruidGuardianSettings();
        }
    }

    #endregion
}

#endregion

#region Paladin

public class PaladinHoly
{
    private static PaladinHolySettings MySettings = PaladinHolySettings.GetSettings();

    #region Professions & Racial

    public readonly Spell ArcaneTorrent = new Spell("Arcane Torrent");
    public readonly Spell Berserking = new Spell("Berserking");
    public readonly Spell GiftoftheNaaru = new Spell("Gift of the Naaru");

    public readonly Spell Stoneform = new Spell("Stoneform");
    public readonly Spell WarStomp = new Spell("War Stomp");
    private readonly WoWItem _firstTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET);
    private readonly WoWItem _secondTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET, 2);

    #endregion

    #region Paladin Seals & Buffs

    public readonly Spell BlessingOfKings = new Spell("Blessing of Kings");
    public readonly Spell BlessingOfMight = new Spell("Blessing of Might");
    public readonly Spell SealOfInsight = new Spell("Seal of Insight");
    public readonly Spell SealOfTheRighteousness = new Spell("Seal of Righteousness");
    public readonly Spell SealOfTruth = new Spell("Seal of Truth");

    #endregion

    #region Offensive Spell

    public readonly Spell Denounce = new Spell("Denounce");
    public readonly Spell HammerOfJustice = new Spell("Hammer of Justice");
    public readonly Spell HammerOfWrath = new Spell("Hammer of Wrath");
    public readonly Spell HolyShock = new Spell("Holy Shock");

    #endregion

    #region Offensive Cooldown

    public readonly Spell AvengingWrath = new Spell("Avenging Wrath");
    public readonly Spell HolyAvenger = new Spell("HolyAvenger");

    #endregion

    #region Defensive Cooldown

    public readonly Spell DevotionAura = new Spell("Devotion Aura");
    public readonly Spell DivineProtection = new Spell("Divine Protection");
    public readonly Spell DivineShield = new Spell("Divine Shield");
    public readonly Spell HandOfProtection = new Spell("Hand of Protection");
    public readonly Spell HandOfPurity = new Spell("Hand of Purity");
    public readonly Spell SacredShield = new Spell("Sacred Shield");

    #endregion

    #region Healing Spell

    public readonly Spell BeaconOfLight = new Spell("Beacon of Light");
    public readonly Spell FlashOfLight = new Spell("Flash of Light");
    public readonly Spell GlyphOfHarshWords = new Spell("Glyph of Harsh Words");
    public readonly Spell HolyLight = new Spell("Holy Light");
    public readonly Spell HolyRadiance = new Spell("Holy Radiance");
    public readonly Spell LayOnHands = new Spell("Lay on Hands");
    public readonly Spell WordOfGlory = new Spell("Word of Glory");

    #endregion

    public PaladinHoly()
    {
        Main.InternalRange = 30f;
        Main.InternalAggroRange = 30f;
        MySettings = PaladinHolySettings.GetSettings();
        Main.DumpCurrentSettings<PaladinHolySettings>(MySettings);
        UInt128 lastTarget = 0;

        while (Main.InternalLoop)
        {
            try
            {
                if (!ObjectManager.Me.IsDeadMe)
                {
                    if (!ObjectManager.Me.IsMounted)
                    {
                        if (Fight.InFight && ObjectManager.Me.Target > 0)
                        {
                            if (ObjectManager.Me.Target != lastTarget && HolyShock.IsHostileDistanceGood)
                            {
                                Pull();
                                lastTarget = ObjectManager.Me.Target;
                            }
                            if (ObjectManager.Target.GetDistance <= 40f)
                                Combat();
                        }
                        if (!ObjectManager.Me.IsCast)
                            Patrolling();
                    }
                }
                else
                    Thread.Sleep(500);
            }
            catch
            {
            }
            Thread.Sleep(100);
        }
    }

    private void Pull()
    {
        if (HolyShock.KnownSpell && HolyShock.IsHostileDistanceGood && HolyShock.IsSpellUsable && MySettings.UseHolyShock)
        {
            HolyShock.Cast();
        }
    }

    private void Combat()
    {
        Buffs();
        DPSBurst();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        DPSCycle();
        Heal();
    }

    private void Patrolling()
    {
        if (!ObjectManager.Me.IsMounted)
        {
            Blessing();
            Heal();
        }

        Seal();
    }

    private void Buffs()
    {
        if (!ObjectManager.Me.IsMounted)
        {
            Blessing();
            if (MySettings.UseAlchFlask && !ObjectManager.Me.HaveBuff(79638) && !ObjectManager.Me.HaveBuff(79640) && !ObjectManager.Me.HaveBuff(79639)
                && !ItemsManager.IsItemOnCooldown(75525) && ItemsManager.GetItemCount(75525) > 0)
                ItemsManager.UseItem(75525);
        }

        Seal();
    }

    private void Seal()
    {
        if (SealOfInsight.KnownSpell && MySettings.UseSealOfInsight)
        {
            if (!SealOfInsight.HaveBuff && SealOfInsight.IsSpellUsable)
            {
                SealOfInsight.Cast();
            }
            return;
        }
        if (SealOfTruth.KnownSpell && MySettings.UseSealOfTruth)
        {
            if (!SealOfTruth.HaveBuff && SealOfTruth.IsSpellUsable)
            {
                SealOfTruth.Cast();
            }
            return;
        }
        if (SealOfTheRighteousness.KnownSpell && MySettings.UseSealOfTheRighteousness)
        {
            if (!SealOfTheRighteousness.HaveBuff && SealOfTheRighteousness.IsSpellUsable)
            {
                SealOfTheRighteousness.Cast();
            }
        }
    }

    private void Blessing()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (BlessingOfKings.KnownSpell && MySettings.UseBlessingOfKings)
        {
            if (!BlessingOfKings.HaveBuff && BlessingOfKings.IsSpellUsable)
            {
                BlessingOfKings.Cast();
            }
            return;
        }
        if (BlessingOfMight.KnownSpell && MySettings.UseBlessingOfMight)
        {
            if (!BlessingOfMight.HaveBuff && BlessingOfMight.IsSpellUsable)
            {
                BlessingOfMight.Cast();
            }
            return;
        }
        if (BeaconOfLight.KnownSpell && MySettings.UseBeaconOfLight)
        {
            if (!BeaconOfLight.HaveBuff && BeaconOfLight.IsSpellUsable)
            {
                BeaconOfLight.Cast();
            }
        }
    }

    private void Heal()
    {
        if (ObjectManager.Me.HealthPercent < 95 && !ObjectManager.Me.InCombat)
        {
            if (HolyLight.KnownSpell && HolyLight.IsSpellUsable && MySettings.UseHolyLight)
            {
                HolyLight.Cast(true, true, true);
                return;
            }
            if (FlashOfLight.KnownSpell && FlashOfLight.IsSpellUsable && MySettings.UseFlashOfLight)
            {
                FlashOfLight.Cast(true, true, true);
                return;
            }
        }
        if (!ObjectManager.Me.HaveBuff(25771))
        {
            if (DivineShield.KnownSpell && ObjectManager.Me.HealthPercent > 0 && ObjectManager.Me.HealthPercent <= 20 &&
                DivineShield.IsSpellUsable && MySettings.UseDivineShield)
            {
                DivineShield.Cast();
                return;
            }
            if (LayOnHands.KnownSpell && ObjectManager.Me.HealthPercent > 0 && ObjectManager.Me.HealthPercent <= 20 &&
                LayOnHands.IsSpellUsable && MySettings.UseLayOnHands)
            {
                LayOnHands.Cast();
                return;
            }
            if (HandOfProtection.KnownSpell && ObjectManager.Me.HealthPercent > 0 &&
                ObjectManager.Me.HealthPercent <= 20 &&
                HandOfProtection.IsSpellUsable && MySettings.UseHandOfProtection)
            {
                HandOfProtection.Cast();
                return;
            }
        }
        if (ObjectManager.Me.ManaPercentage < 30)
        {
            if (ArcaneTorrent.KnownSpell && ArcaneTorrent.IsSpellUsable && MySettings.UseArcaneTorrentForResource)
                ArcaneTorrent.Cast();
        }
        if (ObjectManager.Me.HealthPercent > 0 && ObjectManager.Me.HealthPercent < 50)
        {
            if (WordOfGlory.KnownSpell && WordOfGlory.IsSpellUsable &&
                (!GlyphOfHarshWords.KnownSpell /* || cast on me */) && MySettings.UseWordOfGlory)
                WordOfGlory.Cast();
            if (HolyLight.KnownSpell && HolyLight.IsSpellUsable && MySettings.UseHolyLight)
            {
                HolyLight.Cast();
                return;
            }
            if (FlashOfLight.KnownSpell && FlashOfLight.IsSpellUsable && MySettings.UseFlashOfLight)
            {
                FlashOfLight.Cast();
                return;
            }
        }
        if (ObjectManager.Me.HealthPercent >= 0 && ObjectManager.Me.HealthPercent < 30)
        {
            if (WordOfGlory.KnownSpell && WordOfGlory.IsSpellUsable &&
                (!GlyphOfHarshWords.KnownSpell /* || cast on me */) && MySettings.UseWordOfGlory)
                WordOfGlory.Cast();
            if (DivineProtection.KnownSpell && DivineProtection.IsSpellUsable && MySettings.UseDivineProtection)
                DivineProtection.Cast();
            if (FlashOfLight.KnownSpell && FlashOfLight.IsSpellUsable && MySettings.UseFlashOfLight)
            {
                FlashOfLight.Cast();
                return;
            }
            if (HolyLight.KnownSpell && HolyLight.IsSpellUsable && MySettings.UseHolyLight)
            {
                HolyLight.Cast();
            }
        }
    }

    private void DPSBurst()
    {
        if (MySettings.UseAvengingWrath && AvengingWrath.KnownSpell && AvengingWrath.IsSpellUsable)
        {
            AvengingWrath.Cast();
            if (MySettings.UseHolyAvenger && HolyAvenger.KnownSpell && HolyAvenger.IsSpellUsable)
            {
                HolyAvenger.Cast();
            }
            return;
        }
        if (!MySettings.UseAvengingWrath || !AvengingWrath.KnownSpell || !AvengingWrath.IsSpellUsable)
        {
            if (MySettings.UseHolyAvenger && HolyAvenger.KnownSpell && HolyAvenger.IsSpellUsable)
            {
                HolyAvenger.Cast();
                return;
            }
        }
        if (MySettings.UseTrinketOne && !ItemsManager.IsItemOnCooldown(_firstTrinket.Entry) && ItemsManager.IsItemUsable(_firstTrinket.Entry))
        {
            ItemsManager.UseItem(_firstTrinket.Name);
            Logging.WriteFight("Use First Trinket Slot");
            return;
        }
        if (MySettings.UseTrinketTwo && !ItemsManager.IsItemOnCooldown(_secondTrinket.Entry) && ItemsManager.IsItemUsable(_secondTrinket.Entry))
        {
            ItemsManager.UseItem(_secondTrinket.Name);
            Logging.WriteFight("Use Second Trinket Slot");
        }
    }

    private void DPSCycle()
    {
        Usefuls.SleepGlobalCooldown();
        try
        {
            Memory.WowMemory.GameFrameLock(); // !!! WARNING - DONT SLEEP WHILE LOCKED - DO FINALLY(GameFrameUnLock()) !!!

            if (HolyShock.KnownSpell && HolyShock.IsHostileDistanceGood && HolyShock.IsSpellUsable && MySettings.UseHolyShock)
            {
                HolyShock.Cast();
                return;
            }
            if (HammerOfWrath.KnownSpell && HammerOfWrath.IsHostileDistanceGood && ObjectManager.Target.IsAlive && HammerOfWrath.IsSpellUsable &&
                MySettings.UseHammerOfWrath)
            {
                HammerOfWrath.Cast();
                return;
            }
            if (HammerOfJustice.KnownSpell && HammerOfJustice.IsHostileDistanceGood && HammerOfJustice.IsSpellUsable &&
                MySettings.UseHammerOfJustice)
            {
                HammerOfJustice.Cast();
                return;
            }
            if (Denounce.KnownSpell && Denounce.IsHostileDistanceGood && Denounce.IsSpellUsable && MySettings.UseDenounce)
            {
                Denounce.Cast();
            }
        }
        finally
        {
            Memory.WowMemory.GameFrameUnLock();
        }
    }

    private void AvoidMelee()
    {
        if (ObjectManager.Target.GetDistance < MySettings.DoAvoidMeleeDistance && ObjectManager.Target.InCombat)
        {
            Logging.WriteFight("Too Close. Moving Back");
            var maxTimeTimer = new Timer(1000*2);
            MovementsAction.MoveBackward(true);
            while (ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat && !maxTimeTimer.IsReady)
                Others.SafeSleep(300);
            MovementsAction.MoveBackward(false);
            if (maxTimeTimer.IsReady && ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat)
            {
                MovementsAction.MoveForward(true);
                Others.SafeSleep(1000);
                MovementsAction.MoveForward(false);
                MovementManager.Face(ObjectManager.Target.Position);
            }
        }
    }

    #region Nested type: PaladinHolySettings

    [Serializable]
    public class PaladinHolySettings : Settings
    {
        public bool DoAvoidMelee = false;
        public int DoAvoidMeleeDistance = 0;
        public bool UseAlchFlask = true;
        public bool UseArcaneTorrentForDecast = true;
        public int UseArcaneTorrentForDecastAtPercentage = 100;
        public bool UseArcaneTorrentForResource = true;
        public int UseArcaneTorrentForResourceAtPercentage = 80;
        public bool UseAvengingWrath = true;
        public bool UseBeaconOfLight = true;
        public bool UseBerserking = true;
        public bool UseBlessingOfKings = true;
        public bool UseBlessingOfMight = true;
        public bool UseDenounce = true;
        public bool UseDevotionAura = true;
        public bool UseDivineProtection = true;
        public bool UseDivineShield = true;
        public bool UseFlashOfLight = true;
        public bool UseGiftoftheNaaru = true;
        public int UseGiftoftheNaaruAtPercentage = 80;
        public bool UseHammerOfJustice = true;
        public bool UseHammerOfWrath = true;
        public bool UseHandOfProtection = true;
        public bool UseHandOfPurity = true;
        public bool UseHolyAvenger = true;
        public bool UseHolyLight = true;
        public bool UseHolyRadiance = true;
        public bool UseHolyShock = true;
        public bool UseLayOnHands = true;

        public bool UseSacredShield = true;
        public bool UseSealOfInsight = true;
        public bool UseSealOfTheRighteousness = true;
        public bool UseSealOfTruth = true;
        public bool UseStoneform = true;
        public int UseStoneformAtPercentage = 80;
        public bool UseTrinketOne = true;
        public bool UseTrinketTwo = true;
        public bool UseWarStomp = true;
        public int UseWarStompAtPercentage = 80;
        public bool UseWordOfGlory = true;

        public PaladinHolySettings()
        {
            ConfigWinForm("Paladin Protection Settings");
            /* Professions & Racials */
            AddControlInWinForm("Use Alchemist Flask", "UseAlchFlask", "Game Settings");
            AddControlInWinForm("Use Arcane Torrent for Interrupt", "UseArcaneTorrentForDecast", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Arcane Torrent for Resource", "UseArcaneTorrentForResource", "Professions & Racials", "AtPercentage");

            AddControlInWinForm("Use Stoneform", "UseStoneform", "Professions & Racials");
            AddControlInWinForm("Use Gift of the Naaru", "UseGiftoftheNaaru", "Professions & Racials");
            AddControlInWinForm("Use War Stomp", "UseWarStomp", "Professions & Racials");
            AddControlInWinForm("Use Berserking", "UseBerserking", "Professions & Racials");
            /* Paladin Seals & Buffs */
            AddControlInWinForm("Use Seal of the Righteousness", "UseSealOfTheRighteousness", "Paladin Seals & Buffs");
            AddControlInWinForm("Use Seal of Truth", "UseSealOfTruth", "Paladin Seals & Buffs");
            AddControlInWinForm("Use Seal of Insight", "UseSealOfInsight", "Paladin Seals & Buffs");
            AddControlInWinForm("Use Blessing of Might", "UseBlessingOfMight", "Paladin Seals & Buffs");
            AddControlInWinForm("Use Blessing of Kings", "UseBlessingOfKings", "Paladin Seals & Buffs");
            /* Offensive Spell */
            AddControlInWinForm("Use Holy Shock", "UseHolyShock", "Offensive Spell");
            AddControlInWinForm("Use Denounce", "UseDenounce", "Offensive Spell");
            AddControlInWinForm("Use Hammer of Justice", "UseHammerOfJustice", "Offensive Spell");
            AddControlInWinForm("Use Hammer of Wrath", "UseHammerOfWrath", "Offensive Spell");
            /* Offensive Cooldown */
            AddControlInWinForm("Use Holy Avenger", "UseHolyAvenger", "Offensive Cooldown");
            AddControlInWinForm("Use Avenging Wrath", "UseAvengingWrath", "Offensive Cooldown");
            /* Defensive Cooldown */
            AddControlInWinForm("Use Sacred Shield", "UseSacredShield", "Defensive Cooldown");
            AddControlInWinForm("Use Hand of Purity", "UseHandOfPurity", "Defensive Cooldown");
            AddControlInWinForm("Use Devotion Aura", "UseDevotionAura", "Defensive Cooldown");
            AddControlInWinForm("Use Divine Protection", "UseDivineProtection", "Defensive Cooldown");
            AddControlInWinForm("Use Divine Shield", "UseDivineShield", "Defensive Cooldown");
            AddControlInWinForm("Use Hand of Protection", "UseHandOfProtection", "Defensive Cooldown");
            /* Healing Spell */
            AddControlInWinForm("Use Holy Radiance", "UseHolyRadiance", "Healing Spell");
            AddControlInWinForm("Use Flash of Light", "UseFlashOfLight", "Healing Spell");
            AddControlInWinForm("Use Holy Light", "UseHolyLight", "Healing Spell");
            AddControlInWinForm("Use Lay on Hands", "UseLayOnHands", "Healing Spell");
            AddControlInWinForm("Use Word of Glory", "UseWordOfGlory", "Healing Spell");
            AddControlInWinForm("Use Beacon of Light", "UseBeaconOfLight", "Healing Spell");
            AddControlInWinForm("Use Trinket One", "UseTrinketOne", "Game Settings");
            AddControlInWinForm("Use Trinket Two", "UseTrinketTwo", "Game Settings");
            AddControlInWinForm("Do avoid melee (Off Advised!!)", "DoAvoidMelee", "Game Settings");
            AddControlInWinForm("Avoid melee distance (1 to 4)", "DoAvoidMeleeDistance", "Game Settings");
        }

        public static PaladinHolySettings CurrentSetting { get; set; }

        public static PaladinHolySettings GetSettings()
        {
            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Paladin_Holy.xml";
            if (File.Exists(currentSettingsFile))
            {
                return
                    CurrentSetting = Load<PaladinHolySettings>(currentSettingsFile);
            }
            return new PaladinHolySettings();
        }
    }

    #endregion
}

public class PaladinProtection
{
    private static PaladinProtectionSettings MySettings = PaladinProtectionSettings.GetSettings();

    #region Professions & Racial

    public readonly Spell ArcaneTorrent = new Spell("Arcane Torrent");
    public readonly Spell Berserking = new Spell("Berserking");
    public readonly Spell GiftoftheNaaru = new Spell("Gift of the Naaru");

    public readonly Spell Stoneform = new Spell("Stoneform");
    public readonly Spell WarStomp = new Spell("War Stomp");
    private readonly WoWItem _firstTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET);
    private readonly WoWItem _secondTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET, 2);

    #endregion

    #region Paladin Seals & Buffs

    public readonly Spell BlessingOfKings = new Spell("Blessing of Kings");
    public readonly Spell BlessingOfMight = new Spell("Blessing of Might");
    public readonly Spell SealOfInsight = new Spell("Seal of Insight");
    public readonly Spell SealOfTheRighteousness = new Spell("Seal of Righteousness");
    public readonly Spell SealOfTruth = new Spell("Seal of Truth");

    #endregion

    #region Offensive Spell

    public readonly Spell AvengersShield = new Spell("Avenger's Shield");
    public readonly Spell Consecration = new Spell("Consecration");
    public readonly Spell CrusaderStrike = new Spell("Crusader Strike");
    public readonly Spell HammerOfJustice = new Spell("Hammer of Justice");
    public readonly Spell HammerOfTheRighteous = new Spell("Hammer of the Righteous"); // 115798 = Weakened Blows
    public readonly Spell HammerOfWrath = new Spell("Hammer of Wrath");
    public readonly Spell HolyWrath = new Spell("Holy Wrath");
    public readonly Spell Judgment = new Spell("Judgment");
    public readonly Spell ShieldOfTheRighteous = new Spell("Shield of the Righteous");

    #endregion

    #region Offensive Cooldown

    public readonly Spell HolyAvenger = new Spell("Holy Avenger");

    #endregion

    #region Defensive Cooldown

    public readonly Spell ArdentDefender = new Spell("Ardent Defender");
    public readonly Spell DivineProtection = new Spell("Divine Protection");
    public readonly Spell DivineShield = new Spell("Divine Shield");
    public readonly Spell GuardianOfAncientKings = new Spell("Guardian of Ancient Kings");
    public readonly Spell HandOfProtection = new Spell("Hand of Protection");
    public readonly Spell HandOfPurity = new Spell("Hand Of Purity");
    public readonly Spell SacredShield = new Spell("Sacred Shield");
    private Timer _onCd = new Timer(0);

    #endregion

    #region Healing Spell

    public readonly Spell FlashOfLight = new Spell("Flash of Light");
    public readonly Spell LayOnHands = new Spell("Lay on Hands");
    public readonly Spell WordOfGlory = new Spell("Word of Glory");

    #endregion

    public PaladinProtection()
    {
        Main.InternalRange = ObjectManager.Me.GetCombatReach;
        MySettings = PaladinProtectionSettings.GetSettings();
        Main.DumpCurrentSettings<PaladinProtectionSettings>(MySettings);
        UInt128 lastTarget = 0;

        while (Main.InternalLoop)
        {
            try
            {
                if (!ObjectManager.Me.IsDeadMe)
                {
                    if (!ObjectManager.Me.IsMounted)
                    {
                        if (Fight.InFight && ObjectManager.Me.Target > 0)
                        {
                            if (ObjectManager.Me.Target != lastTarget && Judgment.IsHostileDistanceGood)
                            {
                                Pull();
                                lastTarget = ObjectManager.Me.Target;
                            }
                            if (ObjectManager.Target.GetDistance <= 40f)
                                Combat();
                        }
                        if (!ObjectManager.Me.IsCast)
                            Patrolling();
                    }
                }
                else
                    Thread.Sleep(500);
            }
            catch
            {
            }
            Thread.Sleep(100);
        }
    }

    private void Pull()
    {
        if (AvengersShield.KnownSpell && MySettings.UseAvengersShield && AvengersShield.IsHostileDistanceGood &&
            AvengersShield.IsSpellUsable)
        {
            AvengersShield.Cast();
        }
        if (Judgment.KnownSpell && MySettings.UseJudgment && Judgment.IsHostileDistanceGood && Judgment.IsSpellUsable)
        {
            Judgment.Cast();
            Others.SafeSleep(1000);
        }
        DPSBurst();
    }

    private void Combat()
    {
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        if (_onCd.IsReady)
            DefenseCycle();
        DPSCycle();
        Heal();
        DPSCycle();
        Buffs();
        DPSBurst();
        DPSCycle();
    }

    private void Patrolling()
    {
        if (!ObjectManager.Me.IsMounted)
        {
            Blessing();
            Heal();
        }
        Seal();
    }

    private void Buffs()
    {
        if (!ObjectManager.Me.IsMounted)
        {
            Blessing();
            if (MySettings.UseAlchFlask && !ObjectManager.Me.HaveBuff(79638) && !ObjectManager.Me.HaveBuff(79640) && !ObjectManager.Me.HaveBuff(79639)
                && !ItemsManager.IsItemOnCooldown(75525) && ItemsManager.GetItemCount(75525) > 0)
                ItemsManager.UseItem(75525);
        }
        Seal();
    }

    private void Seal()
    {
        if (ObjectManager.Me.IsMounted)
            return;
        if (SealOfTruth.KnownSpell && MySettings.UseSealOfTruth &&
            (ObjectManager.GetNumberAttackPlayer() <= 7 || !MySettings.UseSealOfTheRighteousness))
        {
            if (!SealOfTruth.HaveBuff && SealOfTruth.IsSpellUsable)
            {
                SealOfTruth.Cast();
            }
            return;
        }
        if (SealOfTheRighteousness.KnownSpell && MySettings.UseSealOfTheRighteousness)
        {
            if (!SealOfTheRighteousness.HaveBuff && SealOfTheRighteousness.IsSpellUsable)
            {
                SealOfTheRighteousness.Cast();
            }
            return;
        }
        if (SealOfInsight.KnownSpell && MySettings.UseSealOfInsight)
        {
            if (!SealOfInsight.HaveBuff && SealOfInsight.IsSpellUsable)
            {
                SealOfInsight.Cast();
            }
        }
    }

    private void Blessing()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (BlessingOfMight.KnownSpell && MySettings.UseBlessingOfMight)
        {
            if (!BlessingOfMight.HaveBuff && BlessingOfMight.IsSpellUsable)
            {
                BlessingOfMight.Cast();
            }
            return;
        }
        if (BlessingOfKings.KnownSpell && MySettings.UseBlessingOfKings)
        {
            if (!BlessingOfKings.HaveBuff && BlessingOfKings.IsSpellUsable)
            {
                BlessingOfKings.Cast();
            }
        }
    }

    private void Heal()
    {
        if (ObjectManager.Me.HealthPercent < 85 && !ObjectManager.Me.InCombat && !ObjectManager.Me.GetMove && !ObjectManager.Me.IsCast)
        {
            if (FlashOfLight.KnownSpell && FlashOfLight.IsSpellUsable && MySettings.UseFlashOfLight)
            {
                FlashOfLight.CastOnSelf(true, true, true);
                return;
            }
        }
        if (DivineShield.KnownSpell && MySettings.UseDivineShield && ObjectManager.Me.HealthPercent > 0 &&
            ObjectManager.Me.HealthPercent <= 20 && !ObjectManager.Me.HaveBuff(25771) && DivineShield.IsSpellUsable)
        {
            DivineShield.Cast();
            return;
        }
        if (LayOnHands.KnownSpell && MySettings.UseLayOnHands && ObjectManager.Me.HealthPercent > 0 &&
            ObjectManager.Me.HealthPercent <= 20 && !ObjectManager.Me.HaveBuff(25771) && LayOnHands.IsSpellUsable)
        {
            LayOnHands.CastOnSelf();
            return;
        }
        if (HandOfProtection.KnownSpell && MySettings.UseHandOfProtection && ObjectManager.Me.HealthPercent > 0 &&
            ObjectManager.Me.HealthPercent <= 20 && !ObjectManager.Me.HaveBuff(25771) && HandOfProtection.IsSpellUsable)
        {
            HandOfProtection.CastOnSelf();
            return;
        }
        if (ObjectManager.Me.ManaPercentage < 10)
        {
            if (ArcaneTorrent.KnownSpell && MySettings.UseArcaneTorrentForResource && ArcaneTorrent.IsSpellUsable)
            {
                ArcaneTorrent.Cast();
                return;
            }
        }
        if (ObjectManager.Me.HealthPercent > 0 && ObjectManager.Me.HealthPercent < 50)
        {
            if (WordOfGlory.KnownSpell && MySettings.UseWordOfGlory && WordOfGlory.IsSpellUsable && ObjectManager.Me.HolyPower >= 3)
                WordOfGlory.Cast();
            if (FlashOfLight.KnownSpell && MySettings.UseFlashOfLight && FlashOfLight.IsSpellUsable)
            {
                FlashOfLight.CastOnSelf();
                return;
            }
        }
        if (ObjectManager.Me.HealthPercent >= 0 && ObjectManager.Me.HealthPercent < 30)
        {
            if (WordOfGlory.KnownSpell && MySettings.UseWordOfGlory && WordOfGlory.IsSpellUsable && ObjectManager.Me.HolyPower >= 3)
                WordOfGlory.Cast();
            if (DivineProtection.KnownSpell && MySettings.UseDivineProtection && DivineProtection.IsSpellUsable)
                DivineProtection.Cast();
            if (FlashOfLight.KnownSpell && MySettings.UseFlashOfLight && FlashOfLight.IsSpellUsable)
            {
                FlashOfLight.CastOnSelf();
            }
        }
    }

    private void DPSBurst()
    {
        if (HolyAvenger.KnownSpell && MySettings.UseHolyAvenger && HolyAvenger.IsSpellUsable)
        {
            HolyAvenger.Cast();
        }
        if (MySettings.UseTrinketOne && !ItemsManager.IsItemOnCooldown(_firstTrinket.Entry) && ItemsManager.IsItemUsable(_firstTrinket.Entry))
        {
            ItemsManager.UseItem(_firstTrinket.Name);
            Logging.WriteFight("Use First Trinket Slot");
        }
        if (MySettings.UseTrinketTwo && !ItemsManager.IsItemOnCooldown(_secondTrinket.Entry) && ItemsManager.IsItemUsable(_secondTrinket.Entry))
        {
            ItemsManager.UseItem(_secondTrinket.Name);
            Logging.WriteFight("Use Second Trinket Slot");
        }
    }

    private void DefenseCycle()
    {
        if (HandOfPurity.KnownSpell && MySettings.UseHandOfPurity && HandOfPurity.IsSpellUsable && !HandOfPurity.HaveBuff)
        {
            HandOfPurity.Cast();
            _onCd = new Timer(1000*6);
            return;
        }
        if (HammerOfJustice.KnownSpell && MySettings.UseHammerOfJustice && HammerOfJustice.IsSpellUsable)
        {
            HammerOfJustice.Cast();
            _onCd = new Timer(1000*6);
            return;
        }
        if (DivineProtection.KnownSpell && MySettings.UseDivineProtection && DivineProtection.IsSpellUsable)
        {
            DivineProtection.Cast();
            _onCd = new Timer(1000*10);
            return;
        }
        if (GuardianOfAncientKings.KnownSpell && MySettings.UseGuardianOfAncientKings &&
            GuardianOfAncientKings.IsSpellUsable)
        {
            GuardianOfAncientKings.Cast();
            _onCd = new Timer(1000*12);
            return;
        }
        if (ArdentDefender.KnownSpell && MySettings.UseArdentDefender &&
            ArdentDefender.IsSpellUsable)
        {
            ArdentDefender.Cast();
            _onCd = new Timer(1000*10);
            return;
        }
        if (WordOfGlory.KnownSpell && MySettings.UseWordOfGlory && WordOfGlory.IsSpellUsable)
        {
            WordOfGlory.Cast();
            _onCd = new Timer(1000*5);
        }
    }

    private void DPSCycle()
    {
        Usefuls.SleepGlobalCooldown();
        try
        {
            Memory.WowMemory.GameFrameLock(); // !!! WARNING - DONT SLEEP WHILE LOCKED - DO FINALLY(GameFrameUnLock()) !!!

            if (ShieldOfTheRighteous.KnownSpell && MySettings.UseShieldOfTheRighteous && ShieldOfTheRighteous.IsSpellUsable &&
                ShieldOfTheRighteous.IsHostileDistanceGood && (ObjectManager.Me.HaveBuff(90174) || ObjectManager.Me.HolyPower >= 3))
            {
                ShieldOfTheRighteous.Cast();
                return;
            }
            if ((ObjectManager.GetNumberAttackPlayer() >= 2 || !ObjectManager.Target.HaveBuff(115798)) &&
                !ObjectManager.Me.HaveBuff(90174) && ObjectManager.Me.HolyPower < 3)
            {
                if (HammerOfTheRighteous.KnownSpell && MySettings.UseHammerOfTheRighteous &&
                    HammerOfTheRighteous.IsHostileDistanceGood && HammerOfTheRighteous.IsSpellUsable)
                {
                    HammerOfTheRighteous.Cast();
                    return;
                }
            }
            else
            {
                if (CrusaderStrike.KnownSpell && MySettings.UseCrusaderStrike && CrusaderStrike.IsHostileDistanceGood &&
                    CrusaderStrike.IsSpellUsable && !ObjectManager.Me.HaveBuff(90174) && ObjectManager.Me.HolyPower < 3)
                {
                    CrusaderStrike.Cast();
                    return;
                }
            }
            if (AvengersShield.KnownSpell && MySettings.UseAvengersShield && AvengersShield.IsHostileDistanceGood &&
                AvengersShield.IsSpellUsable && !ObjectManager.Me.HaveBuff(90174) && ObjectManager.Me.HolyPower < 3)
            {
                AvengersShield.Cast();
                return;
            }
            if (HammerOfWrath.KnownSpell && MySettings.UseHammerOfWrath && HammerOfWrath.IsHostileDistanceGood &&
                HammerOfWrath.IsSpellUsable && !ObjectManager.Me.HaveBuff(90174) && ObjectManager.Me.HolyPower < 3)
            {
                HammerOfWrath.Cast();
                return;
            }
            if (Judgment.KnownSpell && MySettings.UseJudgment && Judgment.IsHostileDistanceGood && Judgment.IsSpellUsable &&
                !ObjectManager.Me.HaveBuff(90174) && ObjectManager.Me.HolyPower < 3)
            {
                Judgment.Cast();
                return;
            }
            if (Consecration.KnownSpell && MySettings.UseConsecration && Consecration.IsSpellUsable &&
                !ObjectManager.Me.HaveBuff(90174) && ObjectManager.Me.HolyPower < 3 && ObjectManager.Target.GetDistance < 8)
            {
                Consecration.Cast();
                return;
            }
            if (HolyWrath.KnownSpell && MySettings.UseHolyWrath && HolyWrath.IsSpellUsable &&
                !ObjectManager.Me.HaveBuff(90174) && ObjectManager.Me.HolyPower < 3 && !Judgment.IsSpellUsable &&
                !CrusaderStrike.IsSpellUsable && !Consecration.IsSpellUsable)
            {
                HolyWrath.Cast();
            }
        }
        finally
        {
            Memory.WowMemory.GameFrameUnLock();
        }
    }

    private void AvoidMelee()
    {
        if (ObjectManager.Target.GetDistance < MySettings.DoAvoidMeleeDistance && ObjectManager.Target.InCombat)
        {
            Logging.WriteFight("Too Close. Moving Back");
            var maxTimeTimer = new Timer(1000*2);
            MovementsAction.MoveBackward(true);
            while (ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat && !maxTimeTimer.IsReady)
                Others.SafeSleep(300);
            MovementsAction.MoveBackward(false);
            if (maxTimeTimer.IsReady && ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat)
            {
                MovementsAction.MoveForward(true);
                Others.SafeSleep(1000);
                MovementsAction.MoveForward(false);
                MovementManager.Face(ObjectManager.Target.Position);
            }
        }
    }

    #region Nested type: PaladinProtectionSettings

    [Serializable]
    public class PaladinProtectionSettings : Settings
    {
        public bool DoAvoidMelee = false;
        public int DoAvoidMeleeDistance = 0;
        public bool UseAlchFlask = true;
        public bool UseArcaneTorrentForDecast = true;
        public int UseArcaneTorrentForDecastAtPercentage = 100;
        public bool UseArcaneTorrentForResource = true;
        public int UseArcaneTorrentForResourceAtPercentage = 80;
        public bool UseArdentDefender = true;
        public bool UseAvengersShield = true;
        public bool UseBerserking = true;
        public bool UseBlessingOfKings = true;
        public bool UseBlessingOfMight = true;
        public bool UseConsecration = true;
        public bool UseCrusaderStrike = true;
        public bool UseDivineProtection = true;
        public bool UseDivineShield = true;
        public bool UseFlashOfLight = true;
        public bool UseGiftoftheNaaru = true;
        public int UseGiftoftheNaaruAtPercentage = 80;
        public bool UseGuardianOfAncientKings = true;
        public bool UseHammerOfJustice = true;
        public bool UseHammerOfTheRighteous = true;
        public bool UseHammerOfWrath = true;
        public bool UseHandOfProtection = true;
        public bool UseHandOfPurity = true;
        public bool UseHolyAvenger = true;
        public bool UseHolyWrath = true;
        public bool UseJudgment = true;
        public bool UseLayOnHands = true;

        public bool UseSacredShield = true;
        public bool UseSealOfInsight = false;
        public bool UseSealOfTheRighteousness = true;
        public bool UseSealOfTruth = true;
        public bool UseShieldOfTheRighteous = true;
        public bool UseStoneform = true;
        public int UseStoneformAtPercentage = 80;
        public bool UseTrinketOne = true;
        public bool UseTrinketTwo = true;
        public bool UseWarStomp = true;
        public int UseWarStompAtPercentage = 80;
        public bool UseWordOfGlory = true;

        public PaladinProtectionSettings()
        {
            ConfigWinForm("Paladin Protection Settings");
            /* Professions & Racials */
            AddControlInWinForm("Use Alchemist Flask", "UseAlchFlask", "Game Settings");
            AddControlInWinForm("Use Arcane Torrent for Interrupt", "UseArcaneTorrentForDecast", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Arcane Torrent for Resource", "UseArcaneTorrentForResource", "Professions & Racials", "AtPercentage");

            AddControlInWinForm("Use Stoneform", "UseStoneform", "Professions & Racials");
            AddControlInWinForm("Use Gift of the Naaru", "UseGiftoftheNaaru", "Professions & Racials");
            AddControlInWinForm("Use War Stomp", "UseWarStomp", "Professions & Racials");
            AddControlInWinForm("Use Berserking", "UseBerserking", "Professions & Racials");
            /* Paladin Seals & Buffs */
            AddControlInWinForm("Use Seal of the Righteousness", "UseSealOfTheRighteousness", "Paladin Seals & Buffs");
            AddControlInWinForm("Use Seal of Truth", "UseSealOfTruth", "Paladin Seals & Buffs");
            AddControlInWinForm("Use Seal of Insight", "UseSealOfInsight", "Paladin Seals & Buffs");
            AddControlInWinForm("Use Blessing of Might", "UseBlessingOfMight", "Paladin Seals & Buffs");
            AddControlInWinForm("Use Blessing of Kings", "UseBlessingOfKings", "Paladin Seals & Buffs");
            /* Offensive Spell */
            AddControlInWinForm("Use Shield of the Righteous", "UseShieldOfTheRighteous", "Offensive Spell");
            AddControlInWinForm("Use Consecration", "UseConsecration", "Offensive Spell");
            AddControlInWinForm("Use Avenger's Shield", "UseAvengersShield", "Offensive Spell");
            AddControlInWinForm("Use Hammer of Wrath", "UseHammerOfWrath", "Offensive Spell");
            AddControlInWinForm("Use Crusader Strike", "UseCrusaderStrike", "Offensive Spell");
            AddControlInWinForm("Use Hammer of the Righteous", "UseHammerOfTheRighteous", "Offensive Spell");
            AddControlInWinForm("Use Judgment", "UseJudgment", "Offensive Spell");
            AddControlInWinForm("Use Hammer of Justice", "UseHammerOfJustice", "Offensive Spell");
            AddControlInWinForm("Use Holy Wrath", "UseHolyWrath", "Offensive Spell");
            /* Offensive Cooldown */
            AddControlInWinForm("Use Holy Avenger", "UseHolyAvenger", "Offensive Cooldown");
            /* Defensive Cooldown */
            AddControlInWinForm("Use Guardian of Ancient Kings", "UseGuardianOfAncientKings", "Defensive Cooldown");
            AddControlInWinForm("Use Ardent Defender", "UseArdentDefender", "Defensive Cooldown");
            AddControlInWinForm("Use Sacred Shield", "UseSacredShield", "Defensive Cooldown");
            AddControlInWinForm("Use Hand of Purity", "UseHandOfPurity", "Defensive Cooldown");
            AddControlInWinForm("Use Divine Protection", "UseDivineProtection", "Defensive Cooldown");
            AddControlInWinForm("Use Divine Shield", "UseDivineShield", "Defensive Cooldown");
            AddControlInWinForm("Use Hand of Protection", "UseHandOfProtection", "Defensive Cooldown");
            /* Healing Spell */
            AddControlInWinForm("Use Flash of Light", "UseFlashOfLight", "Healing Spell");
            AddControlInWinForm("Use Lay on Hands", "UseLayOnHands", "Healing Spell");
            AddControlInWinForm("Use Word of Glory", "UseWordOfGlory", "Healing Spell");
            AddControlInWinForm("Use Trinket One", "UseTrinketOne", "Game Settings");
            AddControlInWinForm("Use Trinket Two", "UseTrinketTwo", "Game Settings");
            AddControlInWinForm("Do avoid melee (Off Advised!!)", "DoAvoidMelee", "Game Settings");
            AddControlInWinForm("Avoid melee distance (1 to 4)", "DoAvoidMeleeDistance", "Game Settings");
        }

        public static PaladinProtectionSettings CurrentSetting { get; set; }

        public static PaladinProtectionSettings GetSettings()
        {
            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Paladin_Protection.xml";
            if (File.Exists(currentSettingsFile))
            {
                return
                    CurrentSetting = Load<PaladinProtectionSettings>(currentSettingsFile);
            }
            return new PaladinProtectionSettings();
        }
    }

    #endregion
}

public class PaladinRetribution
{
    private static PaladinRetributionSettings MySettings = PaladinRetributionSettings.GetSettings();

    #region Professions & Racials

    public readonly Spell ArcaneTorrent = new Spell("Arcane Torrent");
    public readonly Spell Berserking = new Spell("Berserking");
    public readonly Spell GiftoftheNaaru = new Spell("Gift of the Naaru");

    public readonly Spell Stoneform = new Spell("Stoneform");
    public readonly Spell WarStomp = new Spell("War Stomp");

    public readonly Spell SanctifiedWrath = new Spell(53376);
    public Timer AvengingWrathTimer = new Timer(0);

    #endregion

    #region Paladin Seals & Buffs

    public readonly Spell BlessingOfKings = new Spell("Blessing of Kings");
    public readonly Spell BlessingOfMight = new Spell("Blessing of Might");
    public readonly Spell SealOfCommand = new Spell("Seal of Command");
    public readonly Spell SealOfInsight = new Spell("Seal of Insight");
    public readonly Spell SealOfJustice = new Spell("Seal of Justice");
    public readonly Spell SealOfTheRighteousness = new Spell("Seal of Righteousness");
    public readonly Spell SealOfTruth = new Spell("Seal of Truth");

    #endregion

    #region Offensive Spell

    public readonly bool BoundlessConviction = ObjectManager.Me.Level >= 85;
    public readonly Spell CrusaderStrike = new Spell("Crusader Strike");
    public readonly uint DivineCrusaderBuff = 144595;
    public readonly uint DivinePurposeBuff = 90174;
    public readonly Spell DivineStorm = new Spell("Divine Storm");
    public readonly Spell ExecutionSentence = new Spell("Execution Sentence");
    public readonly Spell Exorcism = new Spell("Exorcism");
    public readonly Spell FinalVerdict = new Spell("Final Verdict");
    public readonly Spell HammerOfJustice = new Spell("Hammer of Justice");
    public readonly Spell HammerOfTheRighteous = new Spell("Hammer of the Righteous");
    public readonly Spell HammerOfWrath = new Spell("Hammer of Wrath");
    public readonly Spell Judgment = new Spell("Judgment");
    public readonly Spell TemplarsVerdict = new Spell("Templar's Verdict");

    #endregion

    #region Offensive Cooldown

    public readonly Spell AvengingWrath = new Spell("Avenging Wrath");
    public readonly Spell HolyAvenger = new Spell("Holy Avenger");

    #endregion

    #region Defensive Cooldown

    public readonly Spell DivineProtection = new Spell("Divine Protection");
    public readonly Spell DivineShield = new Spell("Divine Shield");
    public readonly Spell HandOfProtection = new Spell("Hand of Protection");
    public readonly Spell Reckoning = new Spell("Reckoning");
    public readonly Spell SacredShield = new Spell("Sacred Shield");

    #endregion

    #region Healing Spell

    public readonly Spell FlashOfLight = new Spell("Flash of Light");
    public readonly Spell LayOnHands = new Spell("Lay on Hands");
    public readonly Spell WordOfGlory = new Spell("Word of Glory");

    #endregion

    #region Flask & Potion Management

/*
        private readonly int _combatPotion = ItemsManager.GetIdByName(MySettings.CombatPotion);
*/
    private readonly WoWItem _firstTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET);
    private readonly int _flaskOrBattleElixir = ItemsManager.GetItemIdByName(MySettings.FlaskOrBattleElixir);
    private readonly int _guardianElixir = ItemsManager.GetItemIdByName(MySettings.GuardianElixir);

/*
        private readonly WoWItem _hands = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_HAND);
*/
    private readonly WoWItem _secondTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET, 2);
/*
        private readonly int _teasureFindingPotion = ItemsManager.GetIdByName(MySettings.TeasureFindingPotion);
*/
/*
        private readonly int _wellFedBuff = ItemsManager.GetIdByName(MySettings.WellFedBuff);
*/

    #endregion

    public PaladinRetribution()
    {
        Main.InternalRange = ObjectManager.Me.GetCombatReach;
        MySettings = PaladinRetributionSettings.GetSettings();
        Main.DumpCurrentSettings<PaladinRetributionSettings>(MySettings);
        UInt128 lastTarget = 0;

        while (Main.InternalLoop)
        {
            try
            {
                if (!ObjectManager.Me.IsDeadMe)
                {
                    if (!ObjectManager.Me.IsMounted)
                    {
                        if (Fight.InFight && ObjectManager.Me.Target > 0)
                        {
                            if (ObjectManager.Me.Target != lastTarget
                                && (Judgment.IsHostileDistanceGood || Exorcism.IsHostileDistanceGood))
                            {
                                Pull();
                                lastTarget = ObjectManager.Me.Target;
                            }
                            if (ObjectManager.Target.GetDistance <= 40f)
                                Combat();
                        }
                        if (!ObjectManager.Me.IsCast)
                            Patrolling();
                    }
                }
                else
                    Thread.Sleep(500);
            }
            catch
            {
            }
            Thread.Sleep(100);
        }
    }

    private void Pull()
    {
        if (MySettings.UseHammerOfWrath && ObjectManager.Target.IsAlive && HammerOfWrath.IsSpellUsable && HammerOfWrath.IsHostileDistanceGood)
        {
            HammerOfWrath.Cast();
            return;
        }
        if (MySettings.UseCrusaderStrike && CrusaderStrike.IsSpellUsable && CrusaderStrike.IsHostileDistanceGood)
        {
            CrusaderStrike.Cast();
            return;
        }
        if (MySettings.UseJudgment && Judgment.IsSpellUsable && Judgment.IsHostileDistanceGood)
        {
            Judgment.Cast();
            return;
        }
        if (MySettings.UseExorcism && Exorcism.IsSpellUsable && Exorcism.IsHostileDistanceGood)
        {
            Exorcism.Cast();
            return;
        }
        if (MySettings.UseReckoning && Reckoning.IsSpellUsable && Reckoning.IsHostileDistanceGood)
        {
            Reckoning.Cast();
        }
    }

    private void Combat()
    {
        Buffs();
        DPSBurst();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        DPSCycle();
        Heal();
    }

    private void Patrolling()
    {
        if (!ObjectManager.Me.IsMounted)
        {
            if (MySettings.UseFlaskOrBattleElixir && MySettings.FlaskOrBattleElixir != string.Empty)
                if (!SpellManager.HaveBuffLua(ItemsManager.GetItemSpell(MySettings.FlaskOrBattleElixir)) &&
                    !ItemsManager.IsItemOnCooldown(_flaskOrBattleElixir) &&
                    ItemsManager.IsItemUsable(_flaskOrBattleElixir))
                    ItemsManager.UseItem(MySettings.FlaskOrBattleElixir);
            if (MySettings.UseGuardianElixir && MySettings.GuardianElixir != string.Empty)
                if (!SpellManager.HaveBuffLua(ItemsManager.GetItemSpell(MySettings.GuardianElixir)) &&
                    !ItemsManager.IsItemOnCooldown(_guardianElixir) && ItemsManager.IsItemUsable(_guardianElixir))
                    ItemsManager.UseItem(MySettings.GuardianElixir);
            Blessing();
            Heal();
        }
        Seal();
    }

    private void Buffs()
    {
        if (!ObjectManager.Me.IsMounted)
        {
            if (MySettings.UseFlaskOrBattleElixir && MySettings.FlaskOrBattleElixir != string.Empty)
                if (!SpellManager.HaveBuffLua(ItemsManager.GetItemSpell(MySettings.FlaskOrBattleElixir)) &&
                    !ItemsManager.IsItemOnCooldown(_flaskOrBattleElixir) &&
                    ItemsManager.IsItemUsable(_flaskOrBattleElixir))
                    ItemsManager.UseItem(MySettings.FlaskOrBattleElixir);
            if (MySettings.UseGuardianElixir && MySettings.GuardianElixir != string.Empty)
                if (!SpellManager.HaveBuffLua(ItemsManager.GetItemSpell(MySettings.GuardianElixir)) &&
                    !ItemsManager.IsItemOnCooldown(_guardianElixir) && ItemsManager.IsItemUsable(_guardianElixir))
                    ItemsManager.UseItem(MySettings.GuardianElixir);
            Blessing();

            if (MySettings.UseAlchFlask && !ObjectManager.Me.HaveBuff(79638) && !ObjectManager.Me.HaveBuff(79640) && !ObjectManager.Me.HaveBuff(79639)
                && !ItemsManager.IsItemOnCooldown(75525) && ItemsManager.GetItemCount(75525) > 0)
                ItemsManager.UseItem(75525);
        }
        Seal();
    }

    private void Seal()
    {
        Usefuls.SleepGlobalCooldown();
        if (MySettings.UseSealOfTruth && SealOfTruth.KnownSpell &&
            (ObjectManager.GetUnitInSpellRange(8) <= 5 || !MySettings.UseSealOfTheRighteousness || !SealOfTheRighteousness.KnownSpell))
        {
            if (!SealOfTruth.HaveBuff && SealOfTruth.IsSpellUsable)
            {
                SealOfTruth.Cast();
            }
            return;
        }
        if (MySettings.UseSealOfTheRighteousness && SealOfTheRighteousness.KnownSpell)
        {
            if (!SealOfTheRighteousness.HaveBuff && SealOfTheRighteousness.IsSpellUsable)
            {
                SealOfTheRighteousness.Cast();
            }
            return;
        }
        if (MySettings.UseSealOfJustice && SealOfJustice.KnownSpell)
        {
            if (!SealOfJustice.HaveBuff && SealOfJustice.IsSpellUsable)
            {
                SealOfJustice.Cast();
            }
            return;
        }
        if (MySettings.UseSealOfInsight && SealOfInsight.KnownSpell)
        {
            if (!SealOfInsight.HaveBuff && SealOfInsight.IsSpellUsable)
            {
                SealOfInsight.Cast();
            }
            return;
        }
        if (MySettings.UseSealOfCommand && SealOfCommand.KnownSpell)
        {
            if (!SealOfCommand.HaveBuff && SealOfCommand.IsSpellUsable)
            {
                SealOfCommand.Cast();
            }
        }
    }

    private void Blessing()
    {
        if (ObjectManager.Me.IsMounted)
            return;
        Usefuls.SleepGlobalCooldown();

        if (MySettings.UseBlessingOfKings && BlessingOfKings.KnownSpell)
        {
            if (!BlessingOfKings.HaveBuff && BlessingOfKings.IsSpellUsable)
            {
                BlessingOfKings.Cast();
            }
            return;
        }
        if (MySettings.UseBlessingOfMight && BlessingOfMight.KnownSpell)
        {
            if (!BlessingOfMight.HaveBuff && BlessingOfMight.IsSpellUsable)
            {
                BlessingOfMight.Cast();
            }
        }
    }

    private void Heal()
    {
        if (ObjectManager.Me.HealthPercent < 85 && !ObjectManager.Me.InCombat && !ObjectManager.Me.GetMove && !ObjectManager.Me.IsCast)
        {
            if (FlashOfLight.KnownSpell && FlashOfLight.IsSpellUsable && MySettings.UseFlashOfLight)
            {
                FlashOfLight.CastOnSelf(true, true, true);
                return;
            }
        }
        if (DivineShield.KnownSpell && MySettings.UseDivineShield && ObjectManager.Me.HealthPercent > 0 &&
            ObjectManager.Me.HealthPercent <= 20 && !ObjectManager.Me.HaveBuff(25771) && DivineShield.IsSpellUsable)
        {
            DivineShield.Cast();
            return;
        }
        if (LayOnHands.KnownSpell && MySettings.UseLayOnHands && ObjectManager.Me.HealthPercent > 0 &&
            ObjectManager.Me.HealthPercent <= 20 && !ObjectManager.Me.HaveBuff(25771) && LayOnHands.IsSpellUsable)
        {
            LayOnHands.CastOnSelf();
            return;
        }
        if (HandOfProtection.KnownSpell && MySettings.UseHandOfProtection && ObjectManager.Me.HealthPercent > 0 &&
            ObjectManager.Me.HealthPercent <= 20 && !ObjectManager.Me.HaveBuff(25771) && HandOfProtection.IsSpellUsable)
        {
            HandOfProtection.CastOnSelf();
            return;
        }
        if (ObjectManager.Me.ManaPercentage < 10)
        {
            if (ArcaneTorrent.KnownSpell && MySettings.UseArcaneTorrentForResource && ArcaneTorrent.IsSpellUsable)
            {
                ArcaneTorrent.Cast();
                return;
            }
        }
        if (ObjectManager.Me.HealthPercent > 0 && ObjectManager.Me.HealthPercent < 50)
        {
            if (WordOfGlory.KnownSpell && MySettings.UseWordOfGlory && WordOfGlory.IsSpellUsable && ObjectManager.Me.HolyPower >= 3)
                WordOfGlory.Cast();
            if (FlashOfLight.KnownSpell && MySettings.UseFlashOfLight && FlashOfLight.IsSpellUsable)
            {
                FlashOfLight.CastOnSelf();
                return;
            }
        }
        if (ObjectManager.Me.HealthPercent >= 0 && ObjectManager.Me.HealthPercent < 30)
        {
            if (WordOfGlory.KnownSpell && MySettings.UseWordOfGlory && WordOfGlory.IsSpellUsable && ObjectManager.Me.HolyPower >= 3)
                WordOfGlory.Cast();
            if (DivineProtection.KnownSpell && MySettings.UseDivineProtection && DivineProtection.IsSpellUsable)
                DivineProtection.Cast();
            if (FlashOfLight.KnownSpell && MySettings.UseFlashOfLight && FlashOfLight.IsSpellUsable)
            {
                FlashOfLight.CastOnSelf();
            }
        }
    }

    private void DPSBurst()
    {
        if (MySettings.UseHolyAvenger && HolyAvenger.IsSpellUsable)
        {
            HolyAvenger.Cast();
            if (MySettings.UseAvengingWrath && AvengingWrath.KnownSpell && AvengingWrathTimer.IsReady && AvengingWrath.IsSpellUsable)
            {
                AvengingWrathTimer = new Timer(120000);
                AvengingWrathTimer.Reset();
                AvengingWrath.Cast();
            }
        }
        else if (MySettings.UseAvengingWrath && AvengingWrathTimer.IsReady && AvengingWrath.IsSpellUsable)
        {
            AvengingWrathTimer = new Timer(120000);
            AvengingWrathTimer.Reset();
            AvengingWrath.Cast();
        }
        if (MySettings.UseTrinketOne && !ItemsManager.IsItemOnCooldown(_firstTrinket.Entry) && ItemsManager.IsItemUsable(_firstTrinket.Entry))
        {
            ItemsManager.UseItem(_firstTrinket.Name);
            Logging.WriteFight("Use First Trinket Slot");
        }
        if (MySettings.UseTrinketTwo && !ItemsManager.IsItemOnCooldown(_secondTrinket.Entry) && ItemsManager.IsItemUsable(_secondTrinket.Entry))
        {
            ItemsManager.UseItem(_secondTrinket.Name);
            Logging.WriteFight("Use Second Trinket Slot");
        }
    }

    private void DPSCycle()
    {
        Usefuls.SleepGlobalCooldown();
        try
        {
            Memory.WowMemory.GameFrameLock(); // !!! WARNING - DONT SLEEP WHILE LOCKED - DO FINALLY(GameFrameUnLock()) !!!

            if (MySettings.UseDivineStorm && MySettings.UseTemplarsVerdict && FinalVerdict.KnownSpell && DivineStorm.KnownSpell && FinalVerdict.HaveBuff &&
                DivineStorm.IsSpellUsable &&
                ((ObjectManager.Me.AuraIsActiveAndExpireInLessThanMs(DivinePurposeBuff, 4000) || ObjectManager.Me.HolyPower == 5 || ObjectManager.Me.HaveBuff(DivineCrusaderBuff)) &&
                 (ObjectManager.Me.HaveBuff(DivineCrusaderBuff) || ObjectManager.GetUnitInSpellRange(DivineStorm.MaxRangeHostile*2) >= 2)) &&
                DivineStorm.IsHostileDistanceGood)
            {
                DivineStorm.Cast();
                return;
            }
            if (MySettings.UseTemplarsVerdict && FinalVerdict.KnownSpell && FinalVerdict.IsSpellUsable &&
                (ObjectManager.Me.HolyPower == 5 || ObjectManager.Me.AuraIsActiveAndExpireInLessThanMs(DivinePurposeBuff, 4000)) &&
                FinalVerdict.IsHostileDistanceGood)
            {
                FinalVerdict.Cast();
                return;
            }
            if (MySettings.UseExecutionSentence && ExecutionSentence.IsSpellUsable && ExecutionSentence.IsHostileDistanceGood)
            {
                ExecutionSentence.Cast();
                return;
            }
            if ((!MySettings.UseDivineStorm && MySettings.UseTemplarsVerdict && TemplarsVerdict.IsSpellUsable) ||
                (TemplarsVerdict.IsSpellUsable && ObjectManager.GetUnitInSpellRange(DivineStorm.MaxRangeHostile) <= 2) &&
                (ObjectManager.Me.AuraIsActiveAndExpireInLessThanMs(DivinePurposeBuff, 4000) || ObjectManager.Me.HolyPower == 5 || (!BoundlessConviction || HolyAvenger.HaveBuff)) &&
                TemplarsVerdict.IsHostileDistanceGood)
            {
                TemplarsVerdict.Cast();
                return;
            }
            if ((!MySettings.UseDivineStorm && MySettings.UseTemplarsVerdict && DivineStorm.IsSpellUsable) || (DivineStorm.IsSpellUsable && ObjectManager.GetUnitInSpellRange(DivineStorm.MaxRangeHostile) > 2) &&
                (ObjectManager.Me.AuraIsActiveAndExpireInLessThanMs(DivinePurposeBuff, 4000) || ObjectManager.Me.HolyPower == 5 || (!BoundlessConviction || HolyAvenger.HaveBuff)) && DivineStorm.IsHostileDistanceGood)
            {
                DivineStorm.Cast();
                return;
            }
            if (MySettings.UseExorcism && ObjectManager.Me.HaveBuff(166831) && ObjectManager.Me.HolyPower <= 3 && Exorcism.IsSpellUsable && Exorcism.IsHostileDistanceGood)
            {
                Exorcism.Cast();
                return;
            }
            if (MySettings.UseHammerOfWrath && ObjectManager.Me.HolyPower < 5 && ObjectManager.Target.IsAlive && HammerOfWrath.IsSpellUsable && HammerOfWrath.IsHostileDistanceGood)
            {
                HammerOfWrath.Cast();
                return;
            }
            if (MySettings.UseCrusaderStrike && ObjectManager.Me.HolyPower < 5 && CrusaderStrike.IsSpellUsable && CrusaderStrike.IsHostileDistanceGood &&
                (!MySettings.UseHammerOfTheRighteous || !HammerOfTheRighteous.KnownSpell || ObjectManager.GetUnitInSpellRange(HammerOfTheRighteous.MaxRangeHostile) <= 6))
            {
                CrusaderStrike.Cast();
                return;
            }
            if (MySettings.UseHammerOfTheRighteous && ObjectManager.Me.HolyPower < 5 && HammerOfTheRighteous.IsSpellUsable && HammerOfTheRighteous.IsHostileDistanceGood &&
                (!MySettings.UseCrusaderStrike || !CrusaderStrike.KnownSpell || ObjectManager.GetUnitInSpellRange(HammerOfTheRighteous.MaxRangeHostile) >= 7))
            {
                HammerOfTheRighteous.Cast();
                return;
            }
            if (MySettings.UseJudgment && ObjectManager.Me.HolyPower < 5 && Judgment.IsSpellUsable && Judgment.IsHostileDistanceGood)
            {
                Judgment.Cast();
                return;
            }

            if (MySettings.UseExorcism && ObjectManager.Me.HolyPower < 5 && Exorcism.IsSpellUsable && Exorcism.IsHostileDistanceGood)
            {
                Exorcism.Cast();
                return;
            }
            if (MySettings.UseDivineStorm && MySettings.UseTemplarsVerdict && FinalVerdict.KnownSpell && FinalVerdict.HaveBuff && DivineStorm.IsSpellUsable &&
                ObjectManager.GetUnitInSpellRange(DivineStorm.MaxRangeHostile) >= 2 &&
                DivineStorm.IsHostileDistanceGood)
            {
                DivineStorm.Cast();
                return;
            }
            if (MySettings.UseTemplarsVerdict && FinalVerdict.IsSpellUsable && FinalVerdict.IsHostileDistanceGood)
            {
                FinalVerdict.Cast();
                return;
            }
            if ((!MySettings.UseDivineStorm && MySettings.UseTemplarsVerdict && TemplarsVerdict.IsSpellUsable) ||
                (TemplarsVerdict.IsSpellUsable && ObjectManager.GetUnitInSpellRange(DivineStorm.MaxRangeHostile) <= 2) &&
                TemplarsVerdict.IsHostileDistanceGood)
            {
                TemplarsVerdict.Cast();
                return;
            }
            if ((MySettings.UseDivineStorm && !MySettings.UseTemplarsVerdict && DivineStorm.IsSpellUsable) || (DivineStorm.IsSpellUsable && ObjectManager.GetUnitInSpellRange(DivineStorm.MaxRangeHostile) > 2) &&
                DivineStorm.IsHostileDistanceGood)
            {
                DivineStorm.Cast();
                return;
            }
            if (MySettings.UseHammerOfJustice && HammerOfJustice.IsSpellUsable && ObjectManager.Target.IsStunnable && HammerOfJustice.IsHostileDistanceGood)
            {
                HammerOfJustice.Cast();
                return;
            }
            if ((MySettings.UseTemplarsVerdict && TemplarsVerdict.IsSpellUsable) || (MySettings.UseTemplarsVerdict && FinalVerdict.IsSpellUsable) || (MySettings.UseDivineStorm && DivineStorm.IsSpellUsable) ||
                (MySettings.UseJudgment && Judgment.IsSpellUsable) || (MySettings.UseCrusaderStrike && CrusaderStrike.IsSpellUsable) || (MySettings.UseHammerOfWrath && ObjectManager.Target.IsAlive && HammerOfWrath.IsSpellUsable) ||
                (MySettings.UseExorcism && Exorcism.IsSpellUsable))
            {
                return;
            }
            // We have a hole in our rotation, so a GCD is available here, use a free talent level 45.

            if (MySettings.UseSacredShield && SacredShield.IsSpellUsable)
            {
                SacredShield.Cast();
                return;
            }
            if (MySettings.UseFlashOfLight && ObjectManager.Me.BuffStack(114250) == 3 && ObjectManager.Me.HealthPercent < 95 && FlashOfLight.IsSpellUsable)
            {
                FlashOfLight.Cast();
            }
        }
        finally
        {
            Memory.WowMemory.GameFrameUnLock();
        }
    }

    private void AvoidMelee()
    {
        if (ObjectManager.Target.GetDistance < MySettings.DoAvoidMeleeDistance && ObjectManager.Target.InCombat)
        {
            Logging.WriteFight("Too Close. Moving Back");
            var maxTimeTimer = new Timer(1000*2);
            MovementsAction.MoveBackward(true);
            while (ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat && !maxTimeTimer.IsReady)
                Others.SafeSleep(300);
            MovementsAction.MoveBackward(false);
            if (maxTimeTimer.IsReady && ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat)
            {
                MovementsAction.MoveForward(true);
                Others.SafeSleep(1000);
                MovementsAction.MoveForward(false);
                MovementManager.Face(ObjectManager.Target.Position);
            }
        }
    }

    #region Nested type: PaladinRetributionSettings

    [Serializable]
    public class PaladinRetributionSettings : Settings
    {
        public string CombatPotion = "Potion of Mogu Power";
        public bool DoAvoidMelee = false;
        public int DoAvoidMeleeDistance = 0;
        public string FlaskOrBattleElixir = "Flask of Winter's Bite";
        public string GuardianElixir = "";
        public bool RefreshWeakenedBlows = true;
        public string TeasureFindingPotion = "Potion of Luck";
        public bool UseAlchFlask = true;
        public bool UseArcaneTorrentForDecast = true;
        public int UseArcaneTorrentForDecastAtPercentage = 100;
        public bool UseArcaneTorrentForResource = true;
        public int UseArcaneTorrentForResourceAtPercentage = 80;
        public bool UseAvengingWrath = true;
        public bool UseBerserking = true;
        public bool UseBlessingOfKings = true;
        public bool UseBlessingOfMight = true;
        public bool UseCombatPotion = false;
        public bool UseCrusaderStrike = true;
        public bool UseDivineProtection = true;
        public bool UseDivineShield = true;
        public bool UseDivineStorm = true;
        public bool UseExecutionSentence = true;
        public bool UseExorcism = true;
        public bool UseFlashOfLight = true;
        public bool UseFlaskOrBattleElixir = false;
        public bool UseGiftoftheNaaru = true;
        public int UseGiftoftheNaaruAtPercentage = 80;
        public bool UseGuardianElixir = false;
        public bool UseHammerOfJustice = true;
        public bool UseHammerOfTheRighteous = true;
        public bool UseHammerOfWrath = true;
        public bool UseHandOfProtection = false;
        public bool UseHolyAvenger = true;
        public bool UseJudgment = true;
        public bool UseLayOnHands = true;

        public bool UseReckoning = true;
        public bool UseSacredShield = true;
        public bool UseSealOfCommand = true;
        public bool UseSealOfInsight = false;
        public bool UseSealOfJustice = false;
        public bool UseSealOfTheRighteousness = true;
        public bool UseSealOfTruth = true;
        public bool UseStoneform = true;
        public int UseStoneformAtPercentage = 80;
        public bool UseTeasureFindingPotion = false;
        public bool UseTemplarsVerdict = true;
        public bool UseTrinketOne = true;
        public bool UseTrinketTwo = true;
        public bool UseWarStomp = true;
        public int UseWarStompAtPercentage = 80;
        public bool UseWellFedBuff = false;
        public bool UseWordOfGlory = true;

        public string WellFedBuff = "Black Pepper Ribs and Shrimp";

        public PaladinRetributionSettings()
        {
            ConfigWinForm("Paladin Retribution Settings");
            /* Professions & Racials */
            AddControlInWinForm("Use Arcane Torrent for Interrupt", "UseArcaneTorrentForDecast", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Arcane Torrent for Resource", "UseArcaneTorrentForResource", "Professions & Racials", "AtPercentage");

            AddControlInWinForm("Use Stoneform", "UseStoneform", "Professions & Racials");
            AddControlInWinForm("Use Gift of the Naaru", "UseGiftoftheNaaru", "Professions & Racials");
            AddControlInWinForm("Use War Stomp", "UseWarStomp", "Professions & Racials");
            AddControlInWinForm("Use Berserking", "UseBerserking", "Professions & Racials");
            /* Paladin Seals & Buffs */
            AddControlInWinForm("Use Seal of the Righteousness", "UseSealOfTheRighteousness", "Paladin Seals & Buffs");
            AddControlInWinForm("Use Seal of Truth", "UseSealOfTruth", "Paladin Seals & Buffs");
            AddControlInWinForm("Use Seal of Justice", "UseSealOfJustice", "Paladin Seals & Buffs");
            AddControlInWinForm("Use Seal of Insight", "UseSealOfInsight", "Paladin Seals & Buffs");
            AddControlInWinForm("Use Seal of Command", "UseSealOfCommand", "Paladin Seals & Buffs");
            AddControlInWinForm("Use Blessing of Might", "UseBlessingOfMight", "Paladin Seals & Buffs");
            AddControlInWinForm("Use Blessing of Kings", "UseBlessingOfKings", "Paladin Seals & Buffs");
            /* Offensive Spell */
            AddControlInWinForm("Use Templar's Verdict", "UseTemplarsVerdict", "Offensive Spell");
            AddControlInWinForm("Use Divine Storm", "UseDivineStorm", "Offensive Spell");
            AddControlInWinForm("Use Exorcism", "UseExorcism", "Offensive Spell");
            AddControlInWinForm("Use Hammer of Wrath", "UseHammerOfWrath", "Offensive Spell");
            AddControlInWinForm("Use Crusader Strike", "UseCrusaderStrike", "Offensive Spell");
            AddControlInWinForm("Use Hammer of the Righteous", "UseHammerOfTheRighteous", "Offensive Spell");
            AddControlInWinForm("Use Judgment", "UseJudgment", "Offensive Spell");
            AddControlInWinForm("Use Hammer of Justice", "UseHammerOfJustice", "Offensive Spell");
            AddControlInWinForm("Use Execution Sentence", "UseExecutionSentence", "Offensive Spell");
            /* Offensive Cooldown */
            AddControlInWinForm("Use Holy Avenger", "UseHolyAvenger", "Offensive Cooldown");
            AddControlInWinForm("Use Avenging Wrath", "UseAvengingWrath", "Offensive Cooldown");
            /* Defensive Cooldown */
            AddControlInWinForm("Use Reckoning", "UseReckoning", "Defensive Cooldown");
            AddControlInWinForm("Refresh Weakened Blows", "RefreshWeakenedBlows", "Defensive Cooldown");
            AddControlInWinForm("Use Divine Protection", "UseDivineProtection", "Defensive Cooldown");
            AddControlInWinForm("Use Sacred Shield", "UseSacredShield", "Defensive Cooldown");
            AddControlInWinForm("Use Divine Shield", "UseDivineShield", "Defensive Cooldown");
            AddControlInWinForm("Use Hand of Protection", "UseHandOfProtection", "Defensive Cooldown");
            /* Healing Spell */
            AddControlInWinForm("Use Flash of Light", "UseFlashOfLight", "Healing Spell");
            AddControlInWinForm("Use Lay on Hands", "UseLayOnHands", "Healing Spell");
            AddControlInWinForm("Use Word of Glory", "UseWordOfGlory", "Healing Spell");
            /* Flask & Potion Management */
            AddControlInWinForm("Use Alchemist Flask", "UseAlchFlask", "Game Settings");
            AddControlInWinForm("Use Trinket One", "UseTrinketOne", "Game Settings");
            AddControlInWinForm("Use Trinket Two", "UseTrinketTwo", "Game Settings");
            AddControlInWinForm("Use Flask or Battle Elixir", "UseFlaskOrBattleElixir", "Flask & Potion Management");
            AddControlInWinForm("Flask or Battle Elixir Name", "FlaskOrBattleElixir", "Flask & Potion Management");
            AddControlInWinForm("Use Guardian Elixir", "UseGuardianElixir", "Flask & Potion Management");
            AddControlInWinForm("Guardian Elixir Name", "GuardianElixir", "Flask & Potion Management");
            AddControlInWinForm("Use Combat Potion", "UseCombatPotion", "Flask & Potion Management");
            AddControlInWinForm("Combat Potion Name", "CombatPotion", "Flask & Potion Management");
            AddControlInWinForm("Use Teasure Finding Potion", "UseTeasureFindingPotion", "Flask & Potion Management");
            AddControlInWinForm("Teasure Finding Potion Name", "TeasureFindingPotion", "Flask & Potion Management");
            AddControlInWinForm("Use Well Fed Buff", "UseWellFedBuff", "Flask & Potion Management");
            AddControlInWinForm("Well Fed Buff Name", "WellFedBuff", "Flask & Potion Management");
            AddControlInWinForm("Do avoid melee (Off Advised!!)", "DoAvoidMelee", "Game Settings");
            AddControlInWinForm("Avoid melee distance (1 to 4)", "DoAvoidMeleeDistance", "Game Settings");
        }

        public static PaladinRetributionSettings CurrentSetting { get; set; }

        public static PaladinRetributionSettings GetSettings()
        {
            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Paladin_Retribution.xml";
            if (File.Exists(currentSettingsFile))
            {
                return
                    CurrentSetting = Load<PaladinRetributionSettings>(currentSettingsFile);
            }
            return new PaladinRetributionSettings();
        }
    }

    #endregion
}

#endregion

#region Shaman

public class ShamanEnhancement
{
    private static ShamanEnhancementSettings MySettings = ShamanEnhancementSettings.GetSettings();

    #region General Timers & Variables

    private readonly WoWItem _firstTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET);
    private readonly WoWItem _secondTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET, 2);
    public int LC = 0;

    private Timer _onCd = new Timer(0);

    #endregion

    #region Professions & Racials

    public readonly Spell Alchemy = new Spell("Alchemy");
    public readonly Spell ArcaneTorrent = new Spell("Arcane Torrent");
    public readonly Spell Berserking = new Spell("Berserking");
    public readonly Spell BloodFury = new Spell("Blood Fury");

    public readonly Spell GiftoftheNaaru = new Spell("Gift of the Naaru");

    public readonly Spell Stoneform = new Spell("Stoneform");
    public readonly Spell WarStomp = new Spell("War Stomp");

    #endregion

    #region Shaman Buffs

    public readonly Spell FlametongueWeapon = new Spell("Flametongue Weapon");
    public readonly Spell FrostbrandWeapon = new Spell("Frostbrand Weapon");
    public readonly Spell GhostWolf = new Spell("Ghost Wolf");
    public readonly Spell LightningShield = new Spell("Lightning Shield");
    public readonly Spell RockbiterWeapon = new Spell("Rockbiter Weapon");
    public readonly Spell SpiritwalkersGrace = new Spell("Spiritwalker's Grace");
    public readonly Spell WaterShield = new Spell("Water Shield");
    public readonly Spell WaterWalking = new Spell("Water Walking");
    public readonly Spell WindfuryWeapon = new Spell("Windfury Weapon");
    private Timer _waterWalkingTimer = new Timer(0);

    #endregion

    #region Offensive Spell

    public readonly Spell ChainLightning = new Spell("Chain Lightning");
    public readonly Spell EarthShock = new Spell("Earth Shock");
    public readonly Spell FireNova = new Spell("Fire Nova");
    public readonly Spell FlameShock = new Spell("Flame Shock");
    public readonly Spell FrostShock = new Spell("Frost Shock");
    public readonly Spell LavaLash = new Spell("Lava Lash");
    public readonly Spell LightningBolt = new Spell("Lightning Bolt");
    public readonly Spell MagmaTotem = new Spell("Magma Totem");
    public readonly Spell SearingTotem = new Spell("Searing Totem");
    public readonly Timer FireTotemTimer = new Timer(40000);
    public readonly Spell Stormstrike = new Spell("Stormstrike");

    #endregion

    #region Offensive Cooldown

    public readonly Spell AncestralSwiftness = new Spell("Ancestral Swiftness");
    public readonly Spell Ascendance = new Spell("Ascendance");
    public readonly Spell Bloodlust = new Spell("Bloodlust");
    public readonly Spell CalloftheElements = new Spell("Call of the Elements");
    public readonly Spell EarthElementalTotem = new Spell("Earth Elemental Totem");
    public readonly Spell ElementalBlast = new Spell("Elemental Blast");
    public readonly Spell ElementalMastery = new Spell("Elemental Mastery");
    public readonly Spell FeralSpirit = new Spell("Feral Spirit");
    public readonly Spell FireElementalTotem = new Spell("Fire Elemental Totem");
    public readonly Spell Heroism = new Spell("Heroism");
    public readonly Spell StormlashTotem = new Spell("Stormlash Totem");
    public readonly Spell TotemicProjection = new Spell("Totemic Projection");
    public readonly Spell UnleashElements = new Spell("Unleash Elements");
    public readonly Spell UnleashedFury = new Spell("Unleashed Fury");

    #endregion

    #region Defensive Cooldown

    public readonly Spell AstralShift = new Spell("Astral Shift");
    public readonly Spell CapacitorTotem = new Spell("Capacitor Totem");
    public readonly Spell EarthbindTotem = new Spell("Earthbind Totem");
    public readonly Spell GroundingTotem = new Spell("Grounding Totem");
    public readonly Spell ShamanisticRage = new Spell("Shamanistic Rage");
    public readonly Spell StoneBulwarkTotem = new Spell("Stone Bulwark Totem");
    public readonly Spell WindShear = new Spell("Wind Shear");

    #endregion

    #region Healing Spell

    public readonly Spell AncestralGuidance = new Spell("Ancestral Guidance");
    public readonly Spell ChainHeal = new Spell("Chain Heal");
    public readonly Spell HealingRain = new Spell("Healing Rain");
    public readonly Spell HealingStreamTotem = new Spell("Healing Stream Totem");
    public readonly Spell HealingSurge = new Spell("Healing Surge");
    public readonly Spell HealingTideTotem = new Spell("Healing Tide Totem");
    public readonly Spell TotemicRecall = new Spell("Totemic Recall");

    #endregion

    public ShamanEnhancement()
    {
        Main.InternalRange = ObjectManager.Me.GetCombatReach;
        MySettings = ShamanEnhancementSettings.GetSettings();
        Main.DumpCurrentSettings<ShamanEnhancementSettings>(MySettings);
        UInt128 lastTarget = 0;

        while (Main.InternalLoop)
        {
            try
            {
                if (!ObjectManager.Me.IsDeadMe)
                {
                    if (!ObjectManager.Me.IsMounted)
                    {
                        if (Fight.InFight && ObjectManager.Me.Target > 0)
                        {
                            if (ObjectManager.Me.Target != lastTarget
                                && (FlameShock.IsHostileDistanceGood || EarthShock.IsHostileDistanceGood))
                            {
                                Pull();
                                lastTarget = ObjectManager.Me.Target;
                            }

                            if (ObjectManager.Target.Level < 70 && ObjectManager.Me.Level > 84
                                && MySettings.UseLowCombat)
                            {
                                LC = 1;
                                if (ObjectManager.Target.GetDistance <= 40f)
                                    LowCombat();
                            }
                            else
                            {
                                LC = 0;
                                if (ObjectManager.Target.GetDistance <= 40f)
                                    Combat();
                            }
                        }
                        if (!ObjectManager.Me.IsCast)
                            Patrolling();
                    }
                }
                else
                    Thread.Sleep(500);
            }
            catch
            {
            }
            Thread.Sleep(100);
        }
    }

    private void Pull()
    {
        if (TotemicProjection.KnownSpell && TotemicProjection.IsSpellUsable && MySettings.UseTotemicProjection)
            TotemicProjection.Cast();

        if (FlameShock.KnownSpell && FlameShock.IsSpellUsable && FlameShock.IsHostileDistanceGood
            && MySettings.UseFlameShock && LC != 1)
        {
            FlameShock.Cast();
            return;
        }
        if (EarthShock.KnownSpell && EarthShock.IsSpellUsable && EarthShock.IsHostileDistanceGood
            && MySettings.UseEarthShock)
        {
            EarthShock.Cast();
        }
    }

    private void LowCombat()
    {
        Buff();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        DefenseCycle();
        Heal();

        if (EarthShock.KnownSpell && EarthShock.IsSpellUsable && EarthShock.IsHostileDistanceGood
            && MySettings.UseEarthShock)
        {
            EarthShock.Cast();
            return;
        }
        if (Stormstrike.KnownSpell && Stormstrike.IsSpellUsable && Stormstrike.IsHostileDistanceGood && MySettings.UseStormstrike)
        {
            Stormstrike.Cast();
            return;
        }
        if (ChainLightning.KnownSpell && ChainLightning.IsSpellUsable && ChainLightning.IsHostileDistanceGood
            && MySettings.UseChainLightning)
        {
            ChainLightning.Cast();
            return;
        }
        if (SearingTotem.KnownSpell && SearingTotem.IsSpellUsable && MySettings.UseSearingTotem
            && FireTotemReady() && !SearingTotem.CreatedBySpellInRange(25) && ObjectManager.Target.GetDistance < 31)
        {
            SearingTotem.Cast();
            return;
        }
        if (MagmaTotem.KnownSpell && MagmaTotem.IsSpellUsable && ObjectManager.Target.GetDistance < 8
            && MySettings.UseMagmaTotem && FireTotemReady())
        {
            MagmaTotem.Cast();
        }
    }

    private void Combat()
    {
        Buff();
        DPSBurst();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        DPSCycle();
        Decast();
        if (_onCd.IsReady)
            DefenseCycle();
        Heal();
    }


    private void Buff()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (WaterWalking.IsSpellUsable && WaterWalking.KnownSpell &&
            (!WaterWalking.HaveBuff || _waterWalkingTimer.IsReady)
            && !ObjectManager.Me.InCombat && MySettings.UseWaterWalking)
        {
            WaterWalking.CastOnSelf();
            _waterWalkingTimer = new Timer(1000*60*9);
            return;
        }
        if (MySettings.UseWaterShield && !WaterShield.HaveBuff && WaterShield.KnownSpell && WaterShield.IsSpellUsable && (!MySettings.UseLightningShield || ObjectManager.Me.ManaPercentage < 5))
        {
            WaterShield.CastOnSelf();
            return;
        }
        if (MySettings.UseLightningShield && (ObjectManager.Me.ManaPercentage > 10 || !MySettings.UseWaterShield) && LightningShield.KnownSpell && LightningShield.IsSpellUsable && !LightningShield.HaveBuff)
        {
            LightningShield.CastOnSelf();
            return;
        }
        if (ObjectManager.Me.InCombat && SpiritwalkersGrace.IsSpellUsable
            && SpiritwalkersGrace.KnownSpell && MySettings.UseSpiritwalkersGrace && ObjectManager.Me.GetMove)
        {
            SpiritwalkersGrace.Cast();
            return;
        }
        if (WindfuryWeapon.KnownSpell && WindfuryWeapon.IsSpellUsable && !ObjectManager.Me.HaveBuff(33757)
            && MySettings.UseWindfuryWeapon)
        {
            WindfuryWeapon.Cast();
            return;
        }
        if (FrostbrandWeapon.KnownSpell && FrostbrandWeapon.IsSpellUsable && !ObjectManager.Me.HaveBuff(8034)
            && MySettings.UseFrostbrandWeapon && !MySettings.UseWindfuryWeapon)
        {
            FrostbrandWeapon.Cast();
            return;
        }
        if (RockbiterWeapon.KnownSpell && RockbiterWeapon.IsSpellUsable && !ObjectManager.Me.HaveBuff(36494)
            && MySettings.UseRockbiterWeapon && !MySettings.UseWindfuryWeapon
            && !MySettings.UseFrostbrandWeapon)
        {
            RockbiterWeapon.Cast();
            return;
        }
        if (FlametongueWeapon.KnownSpell && FlametongueWeapon.IsSpellUsable && !ObjectManager.Me.HaveBuff(10400)
            && MySettings.UseFlametongueWeapon && (ObjectManager.Me.HaveBuff(33757)
                                                   || ObjectManager.Me.HaveBuff(8034) ||
                                                   ObjectManager.Me.HaveBuff(36494)))
        {
            FlametongueWeapon.Cast();
            return;
        }
        if (MountTask.GetMountCapacity() == MountCapacity.Ground && !ObjectManager.Me.InCombat && GhostWolf.IsSpellUsable && GhostWolf.KnownSpell
            && MySettings.UseGhostWolf && ObjectManager.Me.GetMove && !GhostWolf.HaveBuff
            && ObjectManager.Target.GetDistance > 10)
        {
            GhostWolf.Cast();
            return;
        }
        if (MySettings.UseAlchFlask && !ObjectManager.Me.HaveBuff(79638) && !ObjectManager.Me.HaveBuff(79640) && !ObjectManager.Me.HaveBuff(79639)
            && !ItemsManager.IsItemOnCooldown(75525) && ItemsManager.GetItemCount(75525) > 0)
        {
            ItemsManager.UseItem(75525);
        }
    }

    private void AvoidMelee()
    {
        if (ObjectManager.Target.GetDistance < MySettings.DoAvoidMeleeDistance && ObjectManager.Target.InCombat)
        {
            Logging.WriteFight("Too Close. Moving Back");
            var maxTimeTimer = new Timer(1000*2);
            MovementsAction.MoveBackward(true);
            while (ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat && !maxTimeTimer.IsReady)
                Others.SafeSleep(300);
            MovementsAction.MoveBackward(false);
            if (maxTimeTimer.IsReady && ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat)
            {
                MovementsAction.MoveForward(true);
                Others.SafeSleep(1000);
                MovementsAction.MoveForward(false);
                MovementManager.Face(ObjectManager.Target.Position);
            }
        }
    }

    private void DefenseCycle()
    {
        if (MySettings.UseHealingRain && HealingRain.IsSpellUsable)
        {
            SpellManager.CastSpellByIDAndPosition(HealingRain.Id, ObjectManager.Me.Position);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 50 && CapacitorTotem.KnownSpell && CapacitorTotem.IsSpellUsable
            && AirTotemReady() && MySettings.UseCapacitorTotem)
        {
            CapacitorTotem.Cast();
            _onCd = new Timer(1000*5);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 50 && StoneBulwarkTotem.KnownSpell &&
            StoneBulwarkTotem.IsSpellUsable
            && EarthTotemReady() && MySettings.UseStoneBulwarkTotem)
        {
            StoneBulwarkTotem.Cast();
            _onCd = new Timer(1000*10);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseWarStompAtPercentage && WarStomp.IsSpellUsable &&
            WarStomp.KnownSpell
            && MySettings.UseWarStomp)
        {
            WarStomp.Cast();
            _onCd = new Timer(1000*2);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseStoneformAtPercentage && Stoneform.IsSpellUsable &&
            Stoneform.KnownSpell
            && MySettings.UseStoneform)
        {
            Stoneform.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 90 && ShamanisticRage.IsSpellUsable
            && ShamanisticRage.KnownSpell && MySettings.UseShamanisticRage)
        {
            ShamanisticRage.Cast();
            _onCd = new Timer(1000*15);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 70 && AstralShift.KnownSpell && AstralShift.IsSpellUsable
            && MySettings.UseAstralShift)
        {
            AstralShift.Cast();
            _onCd = new Timer(1000*6);
        }
    }

    private void Heal()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (ObjectManager.Me.ManaPercentage < 50 && TotemicRecall.KnownSpell && TotemicRecall.IsSpellUsable
            && MySettings.UseTotemicRecall && !ObjectManager.Me.InCombat
            && TotemicRecallReady())
        {
            TotemicRecall.Cast();
            return;
        }

        if (ObjectManager.Me.HealthPercent < 95 && HealingSurge.KnownSpell && HealingSurge.IsSpellUsable
            && !ObjectManager.Me.InCombat && MySettings.UseHealingSurge)
        {
            HealingSurge.Cast();
            while (ObjectManager.Me.IsCast)
            {
                Others.SafeSleep(200);
            }
            return;
        }
        if (HealingSurge.KnownSpell && HealingSurge.IsSpellUsable && ObjectManager.Me.HealthPercent < 50
            && MySettings.UseHealingSurge)
        {
            HealingSurge.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseGiftoftheNaaruAtPercentage &&
            GiftoftheNaaru.KnownSpell && GiftoftheNaaru.IsSpellUsable
            && MySettings.UseGiftoftheNaaru)
        {
            GiftoftheNaaru.Cast();
            return;
        }
        if (HealingTideTotem.KnownSpell && HealingTideTotem.IsSpellUsable &&
            ObjectManager.Me.HealthPercent < 70
            && WaterTotemReady() && MySettings.UseHealingTideTotem)
        {
            HealingTideTotem.Cast();
            return;
        }
        if (AncestralGuidance.KnownSpell && AncestralGuidance.IsSpellUsable &&
            ObjectManager.Me.HealthPercent < 70
            && MySettings.UseAncestralGuidance)
        {
            AncestralGuidance.Cast();
            return;
        }
        if (ChainHeal.KnownSpell && ChainHeal.IsSpellUsable && ObjectManager.Me.HealthPercent < 80
            && MySettings.UseChainHeal)
        {
            ChainHeal.Cast();
            return;
        }
        if (HealingStreamTotem.KnownSpell && HealingStreamTotem.IsSpellUsable &&
            ObjectManager.Me.HealthPercent < 90
            && WaterTotemReady() && MySettings.UseHealingStreamTotem)
        {
            HealingStreamTotem.Cast();
        }
    }

    private void Decast()
    {
        if (ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe && MySettings.UseWindShear
            && WindShear.KnownSpell && WindShear.IsSpellUsable && WindShear.IsHostileDistanceGood)
        {
            WindShear.Cast();
            return;
        }
        if (ArcaneTorrent.IsSpellUsable && ArcaneTorrent.KnownSpell && ObjectManager.Target.GetDistance < 8
            && ObjectManager.Me.HealthPercent <= MySettings.UseArcaneTorrentForDecastAtPercentage
            && MySettings.UseArcaneTorrentForDecast && ObjectManager.Target.IsCast &&
            ObjectManager.Target.IsTargetingMe)
        {
            ArcaneTorrent.Cast();
            return;
        }
        if (ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe && MySettings.UseGroundingTotem
            && GroundingTotem.KnownSpell && GroundingTotem.IsSpellUsable && AirTotemReady())
        {
            GroundingTotem.Cast();
            return;
        }
        if (ObjectManager.Target.GetMove && !FrostShock.TargetHaveBuff && MySettings.UseFrostShock
            && FrostShock.KnownSpell && FrostShock.IsSpellUsable && FrostShock.IsHostileDistanceGood)
        {
            FrostShock.Cast();
            return;
        }
        if (ObjectManager.Target.GetMove && MySettings.UseEarthbindTotem && EarthTotemReady()
            && EarthbindTotem.KnownSpell && EarthbindTotem.IsSpellUsable && EarthbindTotem.IsHostileDistanceGood)
        {
            EarthbindTotem.Cast();
        }
    }

    private void DPSBurst()
    {
        if (MySettings.UseTrinketOne && !ItemsManager.IsItemOnCooldown(_firstTrinket.Entry) && ItemsManager.IsItemUsable(_firstTrinket.Entry))
        {
            ItemsManager.UseItem(_firstTrinket.Name);
            Logging.WriteFight("Use First Trinket Slot");
        }

        if (MySettings.UseTrinketTwo && !ItemsManager.IsItemOnCooldown(_secondTrinket.Entry) && ItemsManager.IsItemUsable(_secondTrinket.Entry))
        {
            ItemsManager.UseItem(_secondTrinket.Name);
            Logging.WriteFight("Use Second Trinket Slot");
            return;
        }
        if (Berserking.IsSpellUsable && Berserking.KnownSpell && ObjectManager.Target.GetDistance < 30
            && MySettings.UseBerserking)
        {
            Berserking.Cast();
            return;
        }
        if (BloodFury.IsSpellUsable && BloodFury.KnownSpell && ObjectManager.Target.GetDistance < 30
            && MySettings.UseBloodFury)
        {
            BloodFury.Cast();
            return;
        }
        if (UnleashElements.KnownSpell && UnleashElements.IsSpellUsable && UnleashedFury.KnownSpell
            && MySettings.UseUnleashElements && UnleashElements.IsHostileDistanceGood)
        {
            UnleashElements.Cast();
            return;
        }
        if (ElementalBlast.KnownSpell && ElementalBlast.IsSpellUsable
            && MySettings.UseElementalBlast && ElementalBlast.IsHostileDistanceGood)
        {
            ElementalBlast.Cast();
            return;
        }
        if (Ascendance.KnownSpell && Ascendance.IsSpellUsable
            && MySettings.UseAscendance && ObjectManager.Target.GetDistance < 30)
        {
            Ascendance.Cast();
            return;
        }
        if (FireElementalTotem.KnownSpell && FireElementalTotem.IsSpellUsable
            && MySettings.UseFireElementalTotem && ObjectManager.Target.GetDistance < 30)
        {
            FireElementalTotem.Cast();
            return;
        }
        if (StormlashTotem.KnownSpell && AirTotemReady()
            && MySettings.UseStormlashTotem && ObjectManager.Target.GetDistance < 30)
        {
            if (!StormlashTotem.IsSpellUsable && MySettings.UseCalloftheElements
                && CalloftheElements.KnownSpell && CalloftheElements.IsSpellUsable)
            {
                CalloftheElements.Cast();
                Others.SafeSleep(200);
            }

            if (StormlashTotem.IsSpellUsable)
                StormlashTotem.Cast();
            return;
        }
        if (FeralSpirit.KnownSpell && FeralSpirit.IsSpellUsable
            && MySettings.UseFeralSpirit && ObjectManager.Target.GetDistance < 30)
        {
            FeralSpirit.Cast();
            return;
        }
        if (Bloodlust.KnownSpell && Bloodlust.IsSpellUsable && MySettings.UseBloodlustHeroism
            && ObjectManager.Target.GetDistance < 30 && !ObjectManager.Me.HaveBuff(57724))
        {
            Bloodlust.Cast();
            return;
        }
        if (Heroism.KnownSpell && Heroism.IsSpellUsable && MySettings.UseBloodlustHeroism
            && ObjectManager.Target.GetDistance < 30 && !ObjectManager.Me.HaveBuff(57723))
        {
            Heroism.Cast();
            return;
        }
        if (ElementalMastery.KnownSpell && ElementalMastery.IsSpellUsable
            && !ObjectManager.Me.HaveBuff(2825) && MySettings.UseElementalMastery
            && !ObjectManager.Me.HaveBuff(32182))
        {
            ElementalMastery.Cast();
        }
    }

    private void DPSCycle()
    {
        Usefuls.SleepGlobalCooldown();
        try
        {
            Memory.WowMemory.GameFrameLock(); // !!! WARNING - DONT SLEEP WHILE LOCKED - DO FINALLY(GameFrameUnLock()) !!!

            if (MySettings.UseMagmaTotem && MagmaTotem.IsSpellUsable && ObjectManager.GetUnitInSpellRange(8f) > 1 && FireTotemReady() && !MagmaTotem.CreatedBySpellInRange(8))
            {
                MagmaTotem.Cast();
                FireTotemTimer.Reset();
                return;
            }
            if (MySettings.UseSearingTotem && SearingTotem.IsSpellUsable && ObjectManager.GetUnitInSpellRange(8f) <= 1 && !SearingTotem.CreatedBySpellInRange(25) && FireTotemReady())
            {
                SearingTotem.Cast();
                FireTotemTimer.Reset();
                return;
            }
            if (MySettings.UseChainLightning && ObjectManager.GetUnitInSpellRange(30f) > 1 && ChainLightning.IsSpellUsable && ChainLightning.IsHostileDistanceGood && ObjectManager.Me.BuffStack(53817) == 5)
            {
                ChainLightning.Cast();
                return;
            }
            else if (MySettings.UseLightningBolt && LightningBolt.IsHostileDistanceGood && LightningBolt.IsSpellUsable && ObjectManager.Me.BuffStack(53817) == 5)
            {
                LightningBolt.Cast();
                return;
            }
            if (MySettings.UseStormstrike && Ascendance.HaveBuff && Stormstrike.IsSpellUsable && Stormstrike.IsHostileDistanceGood)
            {
                Stormstrike.Cast();
                return;
            }
            if (MySettings.UseLavaLash && LavaLash.IsSpellUsable && LavaLash.IsHostileDistanceGood)
            {
                LavaLash.Cast();
                return;
            }
            if (MySettings.UseUnleashElements && UnleashElements.IsSpellUsable)
            {
                UnleashElements.Cast();
                return;
            }
            if (MySettings.UseFlameShock && (!FlameShock.HaveBuff || ObjectManager.Me.AuraIsActiveAndExpireInLessThanMs(FlameShock.Id, 9000)) && (ObjectManager.Me.HaveBuff(73683) || !UnleashElements.KnownSpell) &&
                FlameShock.IsSpellUsable && FlameShock.IsHostileDistanceGood)
            {
                FlameShock.Cast();
                return;
            }
            if (MySettings.UseFrostShock && FrostShock.IsSpellUsable && FrostShock.IsHostileDistanceGood)
            {
                FrostShock.Cast();
                return;
            }
            if (MySettings.UseChainLightning && ObjectManager.GetUnitInSpellRange(30f) > 1 && ChainLightning.IsSpellUsable && ChainLightning.IsHostileDistanceGood && ObjectManager.Me.BuffStack(53817) >= 1)
            {
                ChainLightning.Cast();
                return;
            }
            else if (MySettings.UseLightningBolt && LightningBolt.IsHostileDistanceGood && LightningBolt.IsSpellUsable && ObjectManager.Me.BuffStack(53817) >= 1)
            {
                LightningBolt.Cast();
                return;
            }
            if (MySettings.UseMagmaTotem && MagmaTotem.IsSpellUsable && (FireTotemTimer.IsReady || !MagmaTotem.CreatedBySpellInRange(8)) && ObjectManager.GetUnitInSpellRange(8f) > 1 && FireTotemReady())
            {
                MagmaTotem.Cast();
                FireTotemTimer.Reset();
                return;
            }
            if (MySettings.UseSearingTotem && SearingTotem.IsSpellUsable && ObjectManager.GetUnitInSpellRange(8f) <= 1 && (FireTotemTimer.IsReady || !SearingTotem.CreatedBySpellInRange(25)) && FireTotemReady())
            {
                SearingTotem.Cast();
                FireTotemTimer.Reset();
                return;
            }
        }
        finally
        {
            Memory.WowMemory.GameFrameUnLock();
        }
    }

    private bool FireTotemReady()
    {
        if (FireElementalTotem.CreatedBySpell || MagmaTotem.CreatedBySpell)
            return false;
        return true;
    }

    private bool EarthTotemReady()
    {
        if (EarthbindTotem.CreatedBySpell || EarthElementalTotem.CreatedBySpell
            || StoneBulwarkTotem.CreatedBySpell)
            return false;
        return true;
    }

    private bool WaterTotemReady()
    {
        if (HealingStreamTotem.CreatedBySpell || HealingTideTotem.CreatedBySpell)
            return false;
        return true;
    }

    private bool AirTotemReady()
    {
        if (CapacitorTotem.CreatedBySpell || GroundingTotem.CreatedBySpell
            || StormlashTotem.CreatedBySpell)
            return false;
        return true;
    }

    private bool TotemicRecallReady()
    {
        if (FireElementalTotem.CreatedBySpell)
            return false;
        if (EarthElementalTotem.CreatedBySpell)
            return false;
        if (SearingTotem.CreatedBySpell)
            return true;
        if (FireTotemReady() && EarthTotemReady() && WaterTotemReady() && AirTotemReady())
            return false;
        return true;
    }

    private void Patrolling()
    {
        if (!ObjectManager.Me.IsMounted)
        {
            Buff();
            Heal();
        }
    }

    #region Nested type: ShamanEnhancementSettings

    [Serializable]
    public class ShamanEnhancementSettings : Settings
    {
        public bool DoAvoidMelee = false;
        public int DoAvoidMeleeDistance = 0;
        public bool UseAlchFlask = true;
        public bool UseAncestralGuidance = true;
        public bool UseAncestralSwiftness = true;
        public bool UseArcaneTorrentForDecast = true;
        public int UseArcaneTorrentForDecastAtPercentage = 100;
        public bool UseArcaneTorrentForResource = true;
        public int UseArcaneTorrentForResourceAtPercentage = 80;
        public bool UseAscendance = true;
        public bool UseAstralShift = true;
        public bool UseBerserking = true;
        public bool UseBloodFury = true;
        public bool UseBloodlustHeroism = true;
        public bool UseCalloftheElements = true;
        public bool UseCapacitorTotem = true;
        public bool UseChainHeal = false;
        public bool UseChainLightning = true;
        public bool UseEarthElementalTotem = true;
        public bool UseEarthShock = true;
        public bool UseEarthbindTotem = false;
        public bool UseElementalBlast = true;
        public bool UseElementalMastery = true;

        public bool UseFeralSpirit = true;
        public bool UseFireElementalTotem = true;
        public bool UseFireNova = true;
        public bool UseFlameShock = true;
        public bool UseFlametongueWeapon = true;
        public bool UseFrostShock = false;
        public bool UseFrostbrandWeapon = false;
        public bool UseGhostWolf = true;
        public bool UseGiftoftheNaaru = true;
        public int UseGiftoftheNaaruAtPercentage = 80;
        public bool UseGroundingTotem = true;
        public bool UseHealingRain = true;
        public bool UseHealingStreamTotem = true;
        public bool UseHealingSurge = true;
        public bool UseHealingTideTotem = true;
        public bool UseLavaLash = true;

        public bool UseLightningBolt = true;
        public bool UseLightningShield = true;
        public bool UseLowCombat = true;
        public bool UseMagmaTotem = true;
        public bool UseRockbiterWeapon = false;
        public bool UseSearingTotem = true;
        public bool UseShamanisticRage = true;
        public bool UseSpiritwalkersGrace = true;
        public bool UseStoneBulwarkTotem = true;
        public bool UseStoneform = true;
        public int UseStoneformAtPercentage = 80;
        public bool UseStormlashTotem = true;
        public bool UseStormstrike = true;
        public bool UseTotemicProjection = true;
        public bool UseTotemicRecall = true;
        public bool UseTrinketOne = true;
        public bool UseTrinketTwo = true;
        public bool UseUnleashElements = true;
        public bool UseWarStomp = true;
        public int UseWarStompAtPercentage = 80;
        public bool UseWaterShield = true;
        public bool UseWaterWalking = true;
        public bool UseWindShear = true;
        public bool UseWindfuryWeapon = true;

        public ShamanEnhancementSettings()
        {
            ConfigWinForm("Shaman Enhancement Settings");
            /* Professions & Racials */
            AddControlInWinForm("Use Arcane Torrent for Interrupt", "UseArcaneTorrentForDecast", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Arcane Torrent for Resource", "UseArcaneTorrentForResource", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Berserking", "UseBerserking", "Professions & Racials");
            AddControlInWinForm("Use Blood Fury", "UseBloodFury", "Professions & Racials");
            AddControlInWinForm("Use Gift of the Naaru", "UseGiftoftheNaaru", "Professions & Racials");

            AddControlInWinForm("Use Stoneform", "UseStoneform", "Professions & Racials");
            AddControlInWinForm("Use War Stomp", "UseWarStomp", "Professions & Racials");
            /* Shaman Buffs */
            AddControlInWinForm("Use Flametongue Weapon", "UseFlametongueWeapon", "Shaman Buffs");
            AddControlInWinForm("Use Frostbrand Weapon", "UseFrostbrandWeapon", "Shaman Buffs");
            AddControlInWinForm("Use Ghost Wolf", "UseGhostWolf", "Shaman Buffs");
            AddControlInWinForm("Use Lightning Shield", "UseLightningShield", "Shaman Buffs");
            AddControlInWinForm("Use Rockbiter Weapon", "UseRockbiterWeapon", "Shaman Buffs");
            AddControlInWinForm("Use Spiritwalker's Grace", "UseSpiritwalkersGrace", "Shaman Buffs");
            AddControlInWinForm("Use Water Shield", "UseWaterShield", "Shaman Buffs");
            AddControlInWinForm("Use Water Walking", "UseWaterWalking", "Shaman Buffs");
            AddControlInWinForm("Use Windfury Weapon", "UseWindfuryWeapon", "Shaman Buffs");
            /* Offensive Spell */
            AddControlInWinForm("Use Chain Lightning", "UseChainLightning", "Offensive Spell");
            AddControlInWinForm("Use Earth Shock", "UseEarthShock", "Offensive Spell");
            AddControlInWinForm("Use Fire Nova", "UseFireNova", "Offensive Spell");
            AddControlInWinForm("Use Flame Shock", "UseFlameShock", "Offensive Spell");
            AddControlInWinForm("Use Frost Shock", "UseFrostShock", "Offensive Spell");
            AddControlInWinForm("Use Lava Lash", "UseLavaLash", "Offensive Spell");
            AddControlInWinForm("Use Lightning Bolt", "UseLightningBolt", "Offensive Spell");
            AddControlInWinForm("Use Magma Totem", "UseMagmaTotem", "Offensive Spell");
            AddControlInWinForm("Use Searing Totem", "UseSearingTotem", "Offensive Spell");
            AddControlInWinForm("Use Stormstrike", "UseStormstrike", "Offensive Spell");
            /* Offensive Cooldown */
            AddControlInWinForm("Use Ancestral Swiftness", "UseAncestralSwiftness", "Offensive Cooldown");
            AddControlInWinForm("Use Ascendance", "UseAscendance", "Offensive Cooldown");
            AddControlInWinForm("Use Bloodlust / Heroism", "UseBloodlustHeroism", "Offensive Cooldown");
            AddControlInWinForm("Use Call of the Elements", "UseCalloftheElements", "Offensive Cooldown");
            AddControlInWinForm("Use Earth Elemental Totem", "UseEarthElementalTotem", "Offensive Cooldown");
            AddControlInWinForm("Use Elemental Blast", "UseElementalBlast", "Offensive Cooldown");
            AddControlInWinForm("Use Elemental Mastery", "UseElementalMastery", "Offensive Cooldown");
            AddControlInWinForm("Use Feral Spirit", "UseFeralSpirit", "Offensive Cooldown");
            AddControlInWinForm("Use Fire Elemental Totem", "UseFireElementalTotem", "Offensive Cooldown");
            AddControlInWinForm("Use Stormlash Totem", "UseStormlashTotem", "Offensive Cooldown");
            AddControlInWinForm("Use Totemic Projection", "UseTotemicProjection", "Offensive Cooldown");
            AddControlInWinForm("Use Unleash Elements", "UseUnleashElements", "Offensive Cooldown");
            /* Defensive Cooldown */
            AddControlInWinForm("Use Astral Shift", "UseAstralShift", "Defensive Cooldown");
            AddControlInWinForm("Use Capacitor Totem", "UseCapacitorTotem", "Defensive Cooldown");
            AddControlInWinForm("Use Earthbind Totem", "UseEarthbindTotem", "Defensive Cooldown");
            AddControlInWinForm("Use Grounding Totem", "UseGroundingTotem", "Defensive Cooldown");
            AddControlInWinForm("Use Shamanistic Rage", "UseShamanisticRage", "Defensive Cooldown");
            AddControlInWinForm("Use StoneBulwark Totem", "UseStoneBulwarkTotem", "Defensive Cooldown");
            AddControlInWinForm("Use Wind Shear", "UseWindShear", "Defensive Cooldown");
            /* Healing Spell */
            AddControlInWinForm("Use Ancestral Guidance", "UseAncestralGuidance", "Healing Spell");
            AddControlInWinForm("Use Chain Heal", "UseChainHeal", "Healing Spell");
            AddControlInWinForm("Use Healing Rain", "UseHealingRain", "Healing Spell");
            AddControlInWinForm("Use Healing Surge", "UseHealingSurge", "Healing Spell");
            AddControlInWinForm("Use Healing Stream Totem", "UseHealingStreamTotem", "Healing Spell");
            AddControlInWinForm("Use Healing Tide Totem", "UsHealingTideTotem", "Healing Spell");
            AddControlInWinForm("Use Totemic Recall", "UseTotemicRecall", "Healing Spell");
            /* Game Settings */
            AddControlInWinForm("Use Low Combat Settings", "UseLowCombat", "Game Settings");
            AddControlInWinForm("Use Trinket One", "UseTrinketOne", "Game Settings");
            AddControlInWinForm("Use Trinket Two", "UseTrinketTwo", "Game Settings");

            AddControlInWinForm("Use Alchemist Flask", "UseAlchFlask", "Game Settings");
            AddControlInWinForm("Do avoid melee (Off Advised!!)", "DoAvoidMelee", "Game Settings");
            AddControlInWinForm("Avoid melee distance (1 to 4)", "DoAvoidMeleeDistance", "Game Settings");
        }

        public static ShamanEnhancementSettings CurrentSetting { get; set; }

        public static ShamanEnhancementSettings GetSettings()
        {
            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Shaman_Enhancement.xml";
            if (File.Exists(currentSettingsFile))
            {
                return
                    CurrentSetting = Load<ShamanEnhancementSettings>(currentSettingsFile);
            }
            return new ShamanEnhancementSettings();
        }
    }

    #endregion
}

public class ShamanRestoration
{
    private static ShamanRestorationSettings MySettings = ShamanRestorationSettings.GetSettings();

    #region General Timers & Variables

    private readonly WoWItem _firstTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET);
    private readonly WoWItem _secondTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET, 2);
    public int LC = 0;

    private Timer _onCd = new Timer(0);

    #endregion

    #region Professions & Racials

    public readonly Spell Alchemy = new Spell("Alchemy");
    public readonly Spell ArcaneTorrent = new Spell("Arcane Torrent");
    public readonly Spell Berserking = new Spell("Berserking");
    public readonly Spell BloodFury = new Spell("Blood Fury");
    public readonly Spell GiftoftheNaaru = new Spell("Gift of the Naaru");
    public readonly Spell Stoneform = new Spell("Stoneform");
    public readonly Spell WarStomp = new Spell("War Stomp");

    #endregion

    #region Shaman Buffs

    public readonly Spell EarthShield = new Spell("Earth Shield");
    public readonly Spell EarthlivingWeapon = new Spell("Earthliving Weapon");
    public readonly Spell FlametongueWeapon = new Spell("Flametongue Weapon");
    public readonly Spell FrostbrandWeapon = new Spell("Frostbrand Weapon");
    public readonly Spell GhostWolf = new Spell("Ghost Wolf");
    public readonly Spell LightningShield = new Spell("Lightning Shield");
    public readonly Spell RockbiterWeapon = new Spell("Rockbiter Weapon");
    public readonly Spell SpiritwalkersGrace = new Spell("Spiritwalker's Grace");
    public readonly Spell WaterShield = new Spell("Water Shield");
    public readonly Spell WaterWalking = new Spell("Water Walking");
    private Timer _waterWalkingTimer = new Timer(0);

    #endregion

    #region Offensive Spell

    public readonly Spell ChainLightning = new Spell("Chain Lightning");
    public readonly Spell EarthShock = new Spell("Earth Shock");
    public readonly Spell FlameShock = new Spell("Flame Shock");
    public readonly Spell FrostShock = new Spell("Frost Shock");
    public readonly Spell LavaBurst = new Spell("Lava Burst");
    public readonly Spell LightningBolt = new Spell("Lightning Bolt");
    public readonly Spell MagmaTotem = new Spell("Magma Totem");
    public readonly Spell PrimalStrike = new Spell("Primal Strike");
    public readonly Spell SearingTotem = new Spell("Searing Totem");
    private Timer _flameShockTimer = new Timer(0);

    #endregion

    #region Offensive Cooldown

    public readonly Spell AncestralSwiftness = new Spell("Ancestral Swiftness");
    public readonly Spell Ascendance = new Spell("Ascendance");
    public readonly Spell Bloodlust = new Spell("Bloodlust");
    public readonly Spell CalloftheElements = new Spell("Call of the Elements");
    public readonly Spell EarthElementalTotem = new Spell("Earth Elemental Totem");
    public readonly Spell ElementalBlast = new Spell("Elemental Blast");
    public readonly Spell ElementalMastery = new Spell("Elemental Mastery");
    public readonly Spell FireElementalTotem = new Spell("Fire Elemental Totem");
    public readonly Spell Heroism = new Spell("Heroism");
    public readonly Spell StormlashTotem = new Spell("Stormlash Totem");
    public readonly Spell TotemicProjection = new Spell("Totemic Projection");
    public readonly Spell UnleashElements = new Spell("Unleash Elements");
    public readonly Spell UnleashedFury = new Spell("Unleashed Fury");

    #endregion

    #region Defensive Cooldown

    public readonly Spell AstralShift = new Spell("Astral Shift");
    public readonly Spell CapacitorTotem = new Spell("Capacitor Totem");
    public readonly Spell EarthbindTotem = new Spell("Earthbind Totem");
    public readonly Spell GroundingTotem = new Spell("Grounding Totem");
    public readonly Spell StoneBulwarkTotem = new Spell("Stone Bulwark Totem");
    public readonly Spell WindShear = new Spell("Wind Shear");

    #endregion

    #region Healing Spell

    public readonly Spell AncestralGuidance = new Spell("Ancestral Guidance");
    public readonly Spell ChainHeal = new Spell("Chain Heal");
    public readonly Spell GreaterHealingWave = new Spell("Greater Healing Wave");
    public readonly Spell HealingRain = new Spell("Healing Rain");
    public readonly Spell HealingStreamTotem = new Spell("Healing Stream Totem");
    public readonly Spell HealingSurge = new Spell("Healing Surge");
    public readonly Spell HealingTideTotem = new Spell("Healing Tide Totem");
    public readonly Spell HealingWave = new Spell("HealingWave");
    public readonly Spell ManaTideTotem = new Spell("Mana Tide Totem");
    public readonly Spell Riptide = new Spell("Riptide");
    public readonly Spell SpiritLinkTotem = new Spell("Spirit Link Totem");
    public readonly Spell TotemicRecall = new Spell("Totemic Recall");

    #endregion

    public ShamanRestoration()
    {
        Main.InternalRange = 30.0f;
        Main.InternalAggroRange = 30f;
        MySettings = ShamanRestorationSettings.GetSettings();
        Main.DumpCurrentSettings<ShamanRestorationSettings>(MySettings);
        UInt128 lastTarget = 0;

        while (Main.InternalLoop)
        {
            try
            {
                if (!ObjectManager.Me.IsDeadMe)
                {
                    if (!ObjectManager.Me.IsMounted)
                    {
                        if (Fight.InFight && ObjectManager.Me.Target > 0)
                        {
                            if (ObjectManager.Me.Target != lastTarget
                                && (FlameShock.IsHostileDistanceGood || EarthShock.IsHostileDistanceGood))
                            {
                                Pull();
                                lastTarget = ObjectManager.Me.Target;
                            }

                            if (ObjectManager.Target.Level < 70 && ObjectManager.Me.Level > 84
                                && MySettings.UseLowCombat)
                            {
                                LC = 1;
                                if (ObjectManager.Target.GetDistance <= 40f)
                                    LowCombat();
                            }
                            else
                            {
                                LC = 0;
                                if (ObjectManager.Target.GetDistance <= 40f)
                                    Combat();
                            }
                        }
                        if (!ObjectManager.Me.IsCast)
                            Patrolling();
                    }
                }
                else
                    Thread.Sleep(500);
            }
            catch
            {
            }
            Thread.Sleep(100);
        }
    }

    private void Pull()
    {
        if (TotemicProjection.KnownSpell && TotemicProjection.IsSpellUsable && MySettings.UseTotemicProjection)
            TotemicProjection.Cast();

        if (FlameShock.KnownSpell && FlameShock.IsSpellUsable && FlameShock.IsHostileDistanceGood
            && MySettings.UseFlameShock && LC != 1)
        {
            FlameShock.Cast();
            return;
        }
        if (EarthShock.KnownSpell && EarthShock.IsSpellUsable && EarthShock.IsHostileDistanceGood
            && MySettings.UseEarthShock)
        {
            EarthShock.Cast();
        }
    }

    private void LowCombat()
    {
        Buff();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        DefenseCycle();
        Heal();

        if (EarthShock.KnownSpell && EarthShock.IsSpellUsable && EarthShock.IsHostileDistanceGood
            && MySettings.UseEarthShock)
        {
            EarthShock.Cast();
            return;
        }
        if (LavaBurst.KnownSpell && LavaBurst.IsSpellUsable && LavaBurst.IsHostileDistanceGood
            && MySettings.UseLavaBurst)
        {
            LavaBurst.Cast();
            return;
        }
        if (ChainLightning.KnownSpell && ChainLightning.IsSpellUsable && ChainLightning.IsHostileDistanceGood
            && MySettings.UseChainLightning)
        {
            ChainLightning.Cast();
            return;
        }
        if (SearingTotem.KnownSpell && SearingTotem.IsSpellUsable && MySettings.UseSearingTotem
            && FireTotemReady() && !SearingTotem.CreatedBySpellInRange(25) && ObjectManager.Target.GetDistance < 31)
        {
            SearingTotem.Cast();
            return;
        }
        if (MagmaTotem.KnownSpell && MagmaTotem.IsSpellUsable && ObjectManager.Target.GetDistance < 8
            && MySettings.UseMagmaTotem && FireTotemReady())
        {
            MagmaTotem.Cast();
        }
    }

    private void Combat()
    {
        Buff();
        DPSBurst();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        DPSCycle();
        Decast();
        if (_onCd.IsReady)
            DefenseCycle();
        Heal();
    }


    private void Buff()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (WaterWalking.IsSpellUsable && WaterWalking.KnownSpell &&
            (!WaterWalking.HaveBuff || _waterWalkingTimer.IsReady)
            && !ObjectManager.Me.InCombat && MySettings.UseWaterWalking)
        {
            WaterWalking.CastOnSelf();
            _waterWalkingTimer = new Timer(1000*60*9);
            return;
        }
        if (MySettings.UseWaterShield && !WaterShield.HaveBuff && WaterShield.KnownSpell && WaterShield.IsSpellUsable &&
            (!MySettings.UseLightningShield && !MySettings.UseEarthShield || ObjectManager.Me.ManaPercentage < 5))
        {
            WaterShield.CastOnSelf();
            return;
        }
        if (MySettings.UseEarthShield && !MySettings.UseLightningShield && !EarthShield.HaveBuff && EarthShield.KnownSpell && ObjectManager.Me.HealthPercent < 50 && EarthShield.IsSpellUsable)
        {
            EarthShield.Cast();
            return;
        }
        if (MySettings.UseLightningShield && !MySettings.UseEarthShield && (ObjectManager.Me.ManaPercentage > 10 || !MySettings.UseWaterShield) && LightningShield.KnownSpell && LightningShield.IsSpellUsable &&
            !LightningShield.HaveBuff)
        {
            LightningShield.CastOnSelf();
            return;
        }
        if (ObjectManager.Me.InCombat && SpiritwalkersGrace.IsSpellUsable
            && SpiritwalkersGrace.KnownSpell && MySettings.UseSpiritwalkersGrace && ObjectManager.Me.GetMove)
        {
            SpiritwalkersGrace.Cast();
            return;
        }
        if (FlametongueWeapon.KnownSpell && FlametongueWeapon.IsSpellUsable && !ObjectManager.Me.HaveBuff(10400)
            && MySettings.UseFlametongueWeapon)
        {
            FlametongueWeapon.Cast();
            return;
        }
        if (EarthlivingWeapon.KnownSpell && EarthlivingWeapon.IsSpellUsable &&
            !ObjectManager.Me.HaveBuff(52007)
            && MySettings.UseEarthlivingWeapon && !MySettings.UseFlametongueWeapon)
        {
            EarthlivingWeapon.Cast();
            return;
        }
        if (FrostbrandWeapon.KnownSpell && FrostbrandWeapon.IsSpellUsable &&
            !ObjectManager.Me.HaveBuff(8034)
            && MySettings.UseFrostbrandWeapon && !MySettings.UseFlametongueWeapon &&
            !MySettings.UseEarthlivingWeapon)
        {
            FrostbrandWeapon.Cast();
            return;
        }
        if (RockbiterWeapon.KnownSpell && RockbiterWeapon.IsSpellUsable &&
            !ObjectManager.Me.HaveBuff(36494)
            && MySettings.UseRockbiterWeapon && !MySettings.UseFlametongueWeapon
            && !MySettings.UseFrostbrandWeapon && !MySettings.UseEarthlivingWeapon)
        {
            RockbiterWeapon.Cast();
            return;
        }

        if (MountTask.GetMountCapacity() == MountCapacity.Ground && !ObjectManager.Me.InCombat && GhostWolf.IsSpellUsable && GhostWolf.KnownSpell
            && MySettings.UseGhostWolf && ObjectManager.Me.GetMove && !GhostWolf.HaveBuff
            && ObjectManager.Target.GetDistance > 50)
        {
            GhostWolf.Cast();
            return;
        }

        if (MySettings.UseAlchFlask && !ObjectManager.Me.HaveBuff(79638) && !ObjectManager.Me.HaveBuff(79640) && !ObjectManager.Me.HaveBuff(79639)
            && !ItemsManager.IsItemOnCooldown(75525) && ItemsManager.GetItemCount(75525) > 0)
        {
            ItemsManager.UseItem(75525);
        }
    }

    private void AvoidMelee()
    {
        if (ObjectManager.Target.GetDistance < MySettings.DoAvoidMeleeDistance && ObjectManager.Target.InCombat)
        {
            Logging.WriteFight("Too Close. Moving Back");
            var maxTimeTimer = new Timer(1000*2);
            MovementsAction.MoveBackward(true);
            while (ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat && !maxTimeTimer.IsReady)
                Others.SafeSleep(300);
            MovementsAction.MoveBackward(false);
            if (maxTimeTimer.IsReady && ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat)
            {
                MovementsAction.MoveForward(true);
                Others.SafeSleep(1000);
                MovementsAction.MoveForward(false);
                MovementManager.Face(ObjectManager.Target.Position);
            }
        }
    }

    private void DefenseCycle()
    {
        if (ObjectManager.Me.HealthPercent < 50 && CapacitorTotem.KnownSpell && CapacitorTotem.IsSpellUsable
            && AirTotemReady() && MySettings.UseCapacitorTotem)
        {
            CapacitorTotem.Cast();
            _onCd = new Timer(1000*5);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 50 && StoneBulwarkTotem.KnownSpell &&
            StoneBulwarkTotem.IsSpellUsable
            && EarthTotemReady() && MySettings.UseStoneBulwarkTotem)
        {
            StoneBulwarkTotem.Cast();
            _onCd = new Timer(1000*10);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 70 && SpiritLinkTotem.KnownSpell &&
            SpiritLinkTotem.IsSpellUsable
            && AirTotemReady() && MySettings.UseSpiritLinkTotem)
        {
            SpiritLinkTotem.Cast();
            _onCd = new Timer(1000*6);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseWarStompAtPercentage && WarStomp.IsSpellUsable &&
            WarStomp.KnownSpell
            && MySettings.UseWarStomp)
        {
            WarStomp.Cast();
            _onCd = new Timer(1000*2);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseStoneformAtPercentage && Stoneform.IsSpellUsable &&
            Stoneform.KnownSpell
            && MySettings.UseStoneform)
        {
            Stoneform.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 70 && AstralShift.KnownSpell && AstralShift.IsSpellUsable
            && MySettings.UseAstralShift)
        {
            AstralShift.Cast();
            _onCd = new Timer(1000*6);
        }
    }

    private void Heal()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (ArcaneTorrent.IsSpellUsable && ArcaneTorrent.KnownSpell &&
            ObjectManager.Me.ManaPercentage <= MySettings.UseArcaneTorrentForResourceAtPercentage
            && MySettings.UseArcaneTorrentForResource)
        {
            ArcaneTorrent.Cast();
            return;
        }
        if (ObjectManager.Me.ManaPercentage < 50 && TotemicRecall.KnownSpell && TotemicRecall.IsSpellUsable
            && MySettings.UseTotemicRecall && !ObjectManager.Me.InCombat
            && TotemicRecallReady())
        {
            TotemicRecall.Cast();
            return;
        }
        if (ObjectManager.Me.ManaPercentage < 80 && ManaTideTotem.KnownSpell && ManaTideTotem.IsSpellUsable
            && MySettings.UseManaTideTotem && WaterTotemReady())
        {
            ManaTideTotem.Cast();
            return;
        }

        if (ObjectManager.Me.HealthPercent < 95 && HealingSurge.KnownSpell && HealingSurge.IsSpellUsable
            && !ObjectManager.Me.InCombat && MySettings.UseHealingSurge)
        {
            HealingSurge.Cast();
            while (ObjectManager.Me.IsCast)
            {
                Others.SafeSleep(200);
            }
            return;
        }
        if (HealingSurge.KnownSpell && HealingSurge.IsSpellUsable && ObjectManager.Me.HealthPercent < 50
            && MySettings.UseHealingSurge)
        {
            HealingSurge.Cast();
            return;
        }
        if (GreaterHealingWave.KnownSpell && GreaterHealingWave.IsSpellUsable
            && ObjectManager.Me.HealthPercent < 60 && MySettings.UseGreaterHealingWave)
        {
            GreaterHealingWave.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseGiftoftheNaaruAtPercentage &&
            GiftoftheNaaru.KnownSpell && GiftoftheNaaru.IsSpellUsable
            && MySettings.UseGiftoftheNaaru)
        {
            GiftoftheNaaru.Cast();
            return;
        }
        if (HealingTideTotem.KnownSpell && HealingTideTotem.IsSpellUsable &&
            ObjectManager.Me.HealthPercent < 70
            && WaterTotemReady() && MySettings.UseHealingTideTotem)
        {
            HealingTideTotem.Cast();
            return;
        }
        if (AncestralGuidance.KnownSpell && AncestralGuidance.IsSpellUsable &&
            ObjectManager.Me.HealthPercent < 70
            && MySettings.UseAncestralGuidance)
        {
            AncestralGuidance.Cast();
            return;
        }
        if (ChainHeal.KnownSpell && ChainHeal.IsSpellUsable && ObjectManager.Me.HealthPercent < 80
            && MySettings.UseChainHeal)
        {
            ChainHeal.Cast();
            return;
        }
        if (HealingStreamTotem.KnownSpell && HealingStreamTotem.IsSpellUsable &&
            ObjectManager.Me.HealthPercent < 90
            && WaterTotemReady() && MySettings.UseHealingStreamTotem)
        {
            HealingStreamTotem.Cast();
            return;
        }
        if (Riptide.KnownSpell && Riptide.IsSpellUsable && ObjectManager.Me.HealthPercent < 90
            && MySettings.UseRiptide && !Riptide.HaveBuff)
        {
            Riptide.Cast();
            return;
        }
        if (HealingWave.KnownSpell && HealingWave.IsSpellUsable && ObjectManager.Me.HealthPercent < 80
            && MySettings.UseHealingWave)
        {
            HealingWave.Cast();
        }
    }

    private void Decast()
    {
        if (ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe && MySettings.UseWindShear
            && WindShear.KnownSpell && WindShear.IsSpellUsable && WindShear.IsHostileDistanceGood)
        {
            WindShear.Cast();
            return;
        }
        if (ArcaneTorrent.IsSpellUsable && ArcaneTorrent.KnownSpell && ObjectManager.Target.GetDistance < 8
            && ObjectManager.Me.HealthPercent <= MySettings.UseArcaneTorrentForDecastAtPercentage
            && MySettings.UseArcaneTorrentForDecast && ObjectManager.Target.IsCast &&
            ObjectManager.Target.IsTargetingMe)
        {
            ArcaneTorrent.Cast();
            return;
        }
        if (ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe && MySettings.UseGroundingTotem
            && GroundingTotem.KnownSpell && GroundingTotem.IsSpellUsable && AirTotemReady())
        {
            GroundingTotem.Cast();
            return;
        }

        if (ObjectManager.Target.GetMove && !FrostShock.TargetHaveBuff && MySettings.UseFrostShock
            && FrostShock.KnownSpell && FrostShock.IsSpellUsable && FrostShock.IsHostileDistanceGood)
        {
            FrostShock.Cast();
            return;
        }
        if (ObjectManager.Target.GetMove && MySettings.UseEarthbindTotem && EarthTotemReady()
            && EarthbindTotem.KnownSpell && EarthbindTotem.IsSpellUsable && EarthbindTotem.IsHostileDistanceGood)
        {
            EarthbindTotem.Cast();
        }
    }

    private void DPSBurst()
    {
        if (MySettings.UseTrinketOne && !ItemsManager.IsItemOnCooldown(_firstTrinket.Entry) && ItemsManager.IsItemUsable(_firstTrinket.Entry))
        {
            ItemsManager.UseItem(_firstTrinket.Name);
            Logging.WriteFight("Use First Trinket Slot");
        }

        if (MySettings.UseTrinketTwo && !ItemsManager.IsItemOnCooldown(_secondTrinket.Entry) && ItemsManager.IsItemUsable(_secondTrinket.Entry))
        {
            ItemsManager.UseItem(_secondTrinket.Name);
            Logging.WriteFight("Use Second Trinket Slot");
            return;
        }
        if (Berserking.IsSpellUsable && Berserking.KnownSpell && ObjectManager.Target.GetDistance <= 40f
            && MySettings.UseBerserking)
        {
            Berserking.Cast();
            return;
        }
        if (BloodFury.IsSpellUsable && BloodFury.KnownSpell && ObjectManager.Target.GetDistance <= 40f
            && MySettings.UseBloodFury)
        {
            BloodFury.Cast();
            return;
        }
        if (UnleashElements.KnownSpell && UnleashElements.IsSpellUsable && UnleashedFury.KnownSpell
            && MySettings.UseUnleashElements && UnleashElements.IsHostileDistanceGood)
        {
            UnleashElements.Cast();
            return;
        }
        if (ElementalBlast.KnownSpell && ElementalBlast.IsSpellUsable
            && MySettings.UseElementalBlast && ElementalBlast.IsHostileDistanceGood)
        {
            ElementalBlast.Cast();
            return;
        }
        if (Ascendance.KnownSpell && Ascendance.IsSpellUsable && ObjectManager.Me.HealthPercent < 80
            && MySettings.UseAscendance && ObjectManager.Target.GetDistance <= 40f)
        {
            Ascendance.Cast();
            return;
        }
        if (FireElementalTotem.KnownSpell && FireElementalTotem.IsSpellUsable
            && MySettings.UseFireElementalTotem && ObjectManager.Target.GetDistance <= 40f)
        {
            FireElementalTotem.Cast();
            return;
        }
        if (StormlashTotem.KnownSpell && AirTotemReady()
            && MySettings.UseStormlashTotem && ObjectManager.Target.GetDistance <= 40f)
        {
            if (!StormlashTotem.IsSpellUsable && MySettings.UseCalloftheElements
                && CalloftheElements.KnownSpell && CalloftheElements.IsSpellUsable)
            {
                CalloftheElements.Cast();
                Others.SafeSleep(200);
            }

            if (StormlashTotem.IsSpellUsable)
                StormlashTotem.Cast();
            return;
        }
        if (Bloodlust.KnownSpell && Bloodlust.IsSpellUsable && MySettings.UseBloodlustHeroism
            && ObjectManager.Target.GetDistance <= 40f && !ObjectManager.Me.HaveBuff(57724))
        {
            Bloodlust.Cast();
            return;
        }
        if (Heroism.KnownSpell && Heroism.IsSpellUsable && MySettings.UseBloodlustHeroism
            && ObjectManager.Target.GetDistance <= 40f && !ObjectManager.Me.HaveBuff(57723))
        {
            Heroism.Cast();
            return;
        }
        if (ElementalMastery.KnownSpell && ElementalMastery.IsSpellUsable
            && !ObjectManager.Me.HaveBuff(2825) && MySettings.UseElementalMastery
            && !ObjectManager.Me.HaveBuff(32182))
        {
            ElementalMastery.Cast();
        }
    }

    private void DPSCycle()
    {
        Usefuls.SleepGlobalCooldown();
        try
        {
            Memory.WowMemory.GameFrameLock(); // !!! WARNING - DONT SLEEP WHILE LOCKED - DO FINALLY(GameFrameUnLock()) !!!

            if (PrimalStrike.KnownSpell && PrimalStrike.IsSpellUsable && PrimalStrike.IsHostileDistanceGood
                && MySettings.UsePrimalStrike && ObjectManager.Me.Level < 11)
            {
                PrimalStrike.Cast();
                return;
            }

            if (EarthElementalTotem.KnownSpell && EarthElementalTotem.IsSpellUsable
                && ObjectManager.GetNumberAttackPlayer() > 3 && MySettings.UseEarthElementalTotem)
            {
                EarthElementalTotem.Cast();
                return;
            }
            if (FlameShock.IsSpellUsable && FlameShock.IsHostileDistanceGood && FlameShock.KnownSpell
                && MySettings.UseFlameShock && (!FlameShock.TargetHaveBuff || _flameShockTimer.IsReady))
            {
                FlameShock.Cast();
                _flameShockTimer = new Timer(1000*27);
                return;
            }
            if (LavaBurst.KnownSpell && LavaBurst.IsSpellUsable && LavaBurst.IsHostileDistanceGood
                && MySettings.UseLavaBurst && FlameShock.TargetHaveBuff)
            {
                LavaBurst.Cast();
                return;
            }
            if (EarthShock.IsSpellUsable && EarthShock.KnownSpell && EarthShock.IsHostileDistanceGood
                && MySettings.UseEarthShock && FlameShock.TargetHaveBuff)
            {
                EarthShock.Cast();
                return;
            }
            if (ObjectManager.GetNumberAttackPlayer() > 1 && MagmaTotem.KnownSpell
                && MagmaTotem.IsSpellUsable && MySettings.UseMagmaTotem
                && !FireElementalTotem.CreatedBySpell)
            {
                MagmaTotem.Cast();
                return;
            }
            if (SearingTotem.KnownSpell && SearingTotem.IsSpellUsable && MySettings.UseSearingTotem
                && FireTotemReady() && !SearingTotem.CreatedBySpellInRange(25) && ObjectManager.Target.GetDistance < 31)
            {
                SearingTotem.Cast();
                return;
            }
            if (ObjectManager.GetNumberAttackPlayer() > 1 && ChainLightning.KnownSpell
                && ChainLightning.IsSpellUsable && ChainLightning.IsHostileDistanceGood
                && MySettings.UseChainLightning && !ObjectManager.Me.HaveBuff(77762))
            {
                if (AncestralSwiftness.KnownSpell && AncestralSwiftness.IsSpellUsable
                    && MySettings.UseAncestralSwiftness)
                {
                    AncestralSwiftness.Cast();
                    Others.SafeSleep(200);
                }
                ChainLightning.Cast();
                return;
            }
            if (LightningBolt.IsHostileDistanceGood && LightningBolt.KnownSpell && LightningBolt.IsSpellUsable
                && MySettings.UseLightningBolt && !ObjectManager.Me.HaveBuff(77762))
            {
                if (AncestralSwiftness.KnownSpell && AncestralSwiftness.IsSpellUsable
                    && MySettings.UseAncestralSwiftness)
                {
                    AncestralSwiftness.Cast();
                    Others.SafeSleep(200);
                }
                LightningBolt.Cast();
            }
        }
        finally
        {
            Memory.WowMemory.GameFrameUnLock();
        }
    }

    private bool FireTotemReady()
    {
        return !FireElementalTotem.CreatedBySpell && !MagmaTotem.CreatedBySpell;
    }

    private bool EarthTotemReady()
    {
        return !EarthbindTotem.CreatedBySpell && !EarthElementalTotem.CreatedBySpell && !StoneBulwarkTotem.CreatedBySpell;
    }

    private bool WaterTotemReady()
    {
        return !HealingStreamTotem.CreatedBySpell && !HealingTideTotem.CreatedBySpell && !ManaTideTotem.CreatedBySpell;
    }

    private bool AirTotemReady()
    {
        return !CapacitorTotem.CreatedBySpell && !GroundingTotem.CreatedBySpell && !StormlashTotem.CreatedBySpell && !SpiritLinkTotem.CreatedBySpell;
    }

    private bool TotemicRecallReady()
    {
        if (FireElementalTotem.CreatedBySpell)
            return false;
        if (EarthElementalTotem.CreatedBySpell)
            return false;
        if (SearingTotem.CreatedBySpell)
            return true;
        if (FireTotemReady() && EarthTotemReady() && WaterTotemReady() && AirTotemReady())
            return false;
        return true;
    }

    private void Patrolling()
    {
        if (ObjectManager.Me.IsMounted) return;
        Buff();
        Heal();
    }

    #region Nested type: ShamanRestorationSettings

    [Serializable]
    public class ShamanRestorationSettings : Settings
    {
        public bool DoAvoidMelee = false;
        public int DoAvoidMeleeDistance = 0;
        public bool UseAlchFlask = true;
        public bool UseAncestralGuidance = true;
        public bool UseAncestralSwiftness = true;
        public bool UseArcaneTorrentForDecast = true;
        public int UseArcaneTorrentForDecastAtPercentage = 100;
        public bool UseArcaneTorrentForResource = true;
        public int UseArcaneTorrentForResourceAtPercentage = 80;
        public bool UseAscendance = true;
        public bool UseAstralShift = true;
        public bool UseBerserking = true;
        public bool UseBloodFury = true;
        public bool UseBloodlustHeroism = true;
        public bool UseCalloftheElements = true;
        public bool UseCapacitorTotem = true;
        public bool UseChainHeal = false;
        public bool UseChainLightning = true;
        public bool UseEarthElementalTotem = true;
        public bool UseEarthShield = true;
        public bool UseEarthShock = true;
        public bool UseEarthbindTotem = false;
        public bool UseEarthlivingWeapon = true;
        public bool UseElementalBlast = true;
        public bool UseElementalMastery = true;

        public bool UseFireElementalTotem = true;
        public bool UseFlameShock = true;
        public bool UseFlametongueWeapon = true;
        public bool UseFrostShock = false;
        public bool UseFrostbrandWeapon = false;
        public bool UseGhostWolf = true;
        public bool UseGiftoftheNaaru = true;
        public int UseGiftoftheNaaruAtPercentage = 80;
        public bool UseGreaterHealingWave = true;
        public bool UseGroundingTotem = true;
        public bool UseHealingRain = true;
        public bool UseHealingStreamTotem = true;
        public bool UseHealingSurge = true;
        public bool UseHealingTideTotem = true;
        public bool UseHealingWave = false;
        public bool UseLavaBurst = true;

        public bool UseLightningBolt = true;
        public bool UseLightningShield = true;
        public bool UseLowCombat = true;
        public bool UseMagmaTotem = true;
        public bool UseManaTideTotem = true;
        public bool UsePrimalStrike = true;
        public bool UseRiptide = true;
        public bool UseRockbiterWeapon = false;
        public bool UseSearingTotem = true;
        public bool UseSpiritLinkTotem = true;
        public bool UseSpiritwalkersGrace = true;
        public bool UseStoneBulwarkTotem = true;
        public bool UseStoneform = true;
        public int UseStoneformAtPercentage = 80;
        public bool UseStormlashTotem = true;
        public bool UseTotemicProjection = true;
        public bool UseTotemicRecall = true;
        public bool UseTrinketOne = true;
        public bool UseTrinketTwo = true;
        public bool UseUnleashElements = true;
        public bool UseWarStomp = true;
        public int UseWarStompAtPercentage = 80;
        public bool UseWaterShield = true;
        public bool UseWaterWalking = true;
        public bool UseWindShear = true;

        public ShamanRestorationSettings()
        {
            ConfigWinForm("Shaman Restoration Settings");
            /* Professions & Racials */
            AddControlInWinForm("Use Arcane Torrent for Interrupt", "UseArcaneTorrentForDecast", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Arcane Torrent for Resource", "UseArcaneTorrentForResource", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Berserking", "UseBerserking", "Professions & Racials");
            AddControlInWinForm("Use Blood Fury", "UseBloodFury", "Professions & Racials");
            AddControlInWinForm("Use Gift of the Naaru", "UseGiftoftheNaaru", "Professions & Racials");

            AddControlInWinForm("Use Stoneform", "UseStoneform", "Professions & Racials");
            AddControlInWinForm("Use War Stomp", "UseWarStomp", "Professions & Racials");
            /* Shaman Buffs */
            AddControlInWinForm("Use Earth Shield", "UseEarthShield", "Shaman Buffs");
            AddControlInWinForm("Use Earthliving Weapon", "UseEarthlivingWeapon", "Shaman Buffs");
            AddControlInWinForm("Use Flametongue Weapon", "UseFlametongueWeapon", "Shaman Buffs");
            AddControlInWinForm("Use Frostbrand Weapon", "UseFrostbrandWeapon", "Shaman Buffs");
            AddControlInWinForm("Use Ghost Wolf", "UseGhostWolf", "Shaman Buffs");
            AddControlInWinForm("Use Lightning Shield", "UseLightningShield", "Shaman Buffs");
            AddControlInWinForm("Use Rockbiter Weapon", "UseRockbiterWeapon", "Shaman Buffs");
            AddControlInWinForm("Use Spiritwalker's Grace", "UseSpiritwalkersGrace", "Shaman Buffs");
            AddControlInWinForm("Use Water Shield", "UseWaterShield", "Shaman Buffs");
            AddControlInWinForm("Use Water Walking", "UseWaterWalking", "Shaman Buffs");
            /* Offensive Spell */
            AddControlInWinForm("Use Chain Lightning", "UseChainLightning", "Offensive Spell");
            AddControlInWinForm("Use Earth Shock", "UseEarthShock", "Offensive Spell");
            AddControlInWinForm("Use Flame Shock", "UseFlameShock", "Offensive Spell");
            AddControlInWinForm("Use Frost Shock", "UseFrostShock", "Offensive Spell");
            AddControlInWinForm("Use Lava Burst", "UseLavaBurst", "Offensive Spell");
            AddControlInWinForm("Use Lightning Bolt", "UseLightningBolt", "Offensive Spell");
            AddControlInWinForm("Use Magma Totem", "UseMagmaTotem", "Offensive Spell");
            AddControlInWinForm("Use Searing Totem", "UseSearingTotem", "Offensive Spell");
            /* Offensive Cooldown */
            AddControlInWinForm("Use Ancestral Swiftness", "UseAncestralSwiftness", "Offensive Cooldown");
            AddControlInWinForm("Use Ascendance", "UseAscendance", "Offensive Cooldown");
            AddControlInWinForm("Use Bloodlust / Heroism", "UseBloodlustHeroism", "Offensive Cooldown");
            AddControlInWinForm("Use Call of the Elements", "UseCalloftheElements", "Offensive Cooldown");
            AddControlInWinForm("Use Earth Elemental Totem", "UseEarthElementalTotem", "Offensive Cooldown");
            AddControlInWinForm("Use Elemental Blast", "UseElementalBlast", "Offensive Cooldown");
            AddControlInWinForm("Use Elemental Mastery", "UseElementalMastery", "Offensive Cooldown");
            AddControlInWinForm("Use Fire Elemental Totem", "UseFireElementalTotem", "Offensive Cooldown");
            AddControlInWinForm("Use Stormlash Totem", "UseStormlashTotem", "Offensive Cooldown");
            AddControlInWinForm("Use Totemic Projection", "UseTotemicProjection", "Offensive Cooldown");
            AddControlInWinForm("Use Unleash Elements", "UseUnleashElements", "Offensive Cooldown");
            /* Defensive Cooldown */
            AddControlInWinForm("Use Astral Shift", "UseAstralShift", "Defensive Cooldown");
            AddControlInWinForm("Use Capacitor Totem", "UseCapacitorTotem", "Defensive Cooldown");
            AddControlInWinForm("Use Earthbind Totem", "UseEarthbindTotem", "Defensive Cooldown");
            AddControlInWinForm("Use Grounding Totem", "UseGroundingTotem", "Defensive Cooldown");
            AddControlInWinForm("Use StoneBulwark Totem", "UseStoneBulwarkTotem", "Defensive Cooldown");
            AddControlInWinForm("Use Wind Shear", "UseWindShear", "Defensive Cooldown");
            /* Healing Spell */
            AddControlInWinForm("Use Ancestral Guidance", "UseAncestralGuidance", "Healing Spell");
            AddControlInWinForm("Use Chain Heal", "UseChainHeal", "Healing Spell");
            AddControlInWinForm("Use Greater Healing Wave", "UseGreaterHealingWave", "Healing Spell");
            AddControlInWinForm("Use Healing Rain", "UseHealingRain", "Healing Spell");
            AddControlInWinForm("Use Healing Surge", "UseHealingSurge", "Healing Spell");
            AddControlInWinForm("Use Healing Stream Totem", "UseHealingStreamTotem", "Healing Spell");
            AddControlInWinForm("Use Healing Tide Totem", "UsHealingTideTotem", "Healing Spell");
            AddControlInWinForm("Use Healing Wave", "UseHealingWave", "Healing Spell");
            AddControlInWinForm("Use Mana Tide Totem", "UseManaTideTotem", "Healing Spell");
            AddControlInWinForm("Use Riptide", "UseRiptide", "Healing Spell");
            AddControlInWinForm("Use Spirit Link Totem", "UseSpiritLinkTotem", "Healing Spell");
            AddControlInWinForm("Use Totemic Recall", "UseTotemicRecall", "Healing Spell");
            /* Game Settings */
            AddControlInWinForm("Use Low Combat Settings", "UseLowCombat", "Game Settings");
            AddControlInWinForm("Use Trinket One", "UseTrinketOne", "Game Settings");
            AddControlInWinForm("Use Trinket Two", "UseTrinketTwo", "Game Settings");

            AddControlInWinForm("Use Alchemist Flask", "UseAlchFlask", "Game Settings");
            AddControlInWinForm("Do avoid melee (Off Advised!!)", "DoAvoidMelee", "Game Settings");
            AddControlInWinForm("Avoid melee distance (1 to 4)", "DoAvoidMeleeDistance", "Game Settings");
        }

        public static ShamanRestorationSettings CurrentSetting { get; set; }

        public static ShamanRestorationSettings GetSettings()
        {
            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Shaman_Restoration.xml";
            if (File.Exists(currentSettingsFile))
            {
                return
                    CurrentSetting = Load<ShamanRestorationSettings>(currentSettingsFile);
            }
            return new ShamanRestorationSettings();
        }
    }

    #endregion
}

public class ShamanElemental
{
    private static ShamanElementalSettings MySettings = ShamanElementalSettings.GetSettings();

    #region General Timers & Variables

    private readonly WoWItem _firstTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET);
    private readonly WoWItem _secondTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET, 2);
    public int LC = 0;

    private Timer _onCd = new Timer(0);

    #endregion

    #region Professions & Racials

    public readonly Spell Alchemy = new Spell("Alchemy");
    public readonly Spell ArcaneTorrent = new Spell("Arcane Torrent");
    public readonly Spell Berserking = new Spell("Berserking");
    public readonly Spell BloodFury = new Spell("Blood Fury");

    public readonly Spell GiftoftheNaaru = new Spell("Gift of the Naaru");

    public readonly Spell Stoneform = new Spell("Stoneform");
    public readonly Spell WarStomp = new Spell("War Stomp");

    #endregion

    #region Shaman Buffs

    public readonly Spell FlametongueWeapon = new Spell("Flametongue Weapon");
    public readonly Spell FrostbrandWeapon = new Spell("Frostbrand Weapon");
    public readonly Spell GhostWolf = new Spell("Ghost Wolf");
    public readonly Spell LightningShield = new Spell("Lightning Shield");
    public readonly Spell ImprovedLightningShield = new Spell("Improved Lightning Shield");
    public readonly Spell RockbiterWeapon = new Spell("Rockbiter Weapon");
    public readonly Spell SpiritwalkersGrace = new Spell("Spiritwalker's Grace");
    public readonly Spell WaterShield = new Spell("Water Shield");
    public readonly Spell WaterWalking = new Spell("Water Walking");
    private Timer _waterWalkingTimer = new Timer(0);

    #endregion

    #region Offensive Spell

    public readonly Spell ChainLightning = new Spell("Chain Lightning");
    public readonly Spell EarthShock = new Spell("Earth Shock");
    public readonly Spell FlameShock = new Spell("Flame Shock");
    public readonly Spell FrostShock = new Spell("Frost Shock");
    public readonly Spell LavaBurst = new Spell("Lava Burst");
    public readonly Spell LightningBolt = new Spell("Lightning Bolt");
    public readonly Spell SearingTotem = new Spell("Searing Totem");
    public readonly Spell Thunderstorm = new Spell("Thunderstorm");

    #endregion

    #region Offensive Cooldown

    public readonly Spell AncestralSwiftness = new Spell("Ancestral Swiftness");
    public readonly Spell Ascendance = new Spell("Ascendance");
    public readonly Spell Bloodlust = new Spell("Bloodlust");
    public readonly Spell CalloftheElements = new Spell("Call of the Elements");
    public readonly Spell EarthElementalTotem = new Spell("Earth Elemental Totem");
    public readonly Spell ElementalBlast = new Spell("Elemental Blast");
    public readonly Spell ElementalMastery = new Spell("Elemental Mastery");
    public readonly Spell FireElementalTotem = new Spell("Fire Elemental Totem");
    public readonly Spell Heroism = new Spell("Heroism");
    public readonly Spell StormlashTotem = new Spell("Stormlash Totem");
    public readonly Spell TotemicProjection = new Spell("Totemic Projection");
    public readonly Spell UnleashElements = new Spell("Unleash Elements");
    public readonly Spell UnleashedFury = new Spell("Unleashed Fury");

    #endregion

    #region Defensive Cooldown

    public readonly Spell AstralShift = new Spell("Astral Shift");
    public readonly Spell CapacitorTotem = new Spell("Capacitor Totem");
    public readonly Spell EarthbindTotem = new Spell("Earthbind Totem");
    public readonly Spell GroundingTotem = new Spell("Grounding Totem");
    public readonly Spell StoneBulwarkTotem = new Spell("Stone Bulwark Totem");
    public readonly Spell WindShear = new Spell("Wind Shear");

    #endregion

    #region Healing Spell

    public readonly Spell AncestralGuidance = new Spell("Ancestral Guidance");
    public readonly Spell ChainHeal = new Spell("Chain Heal");
    public readonly Spell HealingRain = new Spell("Healing Rain");
    public readonly Spell HealingStreamTotem = new Spell("Healing Stream Totem");
    public readonly Spell HealingSurge = new Spell("Healing Surge");
    public readonly Spell HealingTideTotem = new Spell("Healing Tide Totem");
    public readonly Spell TotemicRecall = new Spell("Totemic Recall");

    #endregion

    #region Talent

    public readonly Spell Conductivity = new Spell("Conductivity");

    #endregion

    public ShamanElemental()
    {
        Main.InternalRange = 39f;
        Main.InternalAggroRange = 39f;
        MySettings = ShamanElementalSettings.GetSettings();
        Main.DumpCurrentSettings<ShamanElementalSettings>(MySettings);
        UInt128 lastTarget = 0;

        while (Main.InternalLoop)
        {
            try
            {
                if (!ObjectManager.Me.IsDeadMe)
                {
                    if (!ObjectManager.Me.IsMounted)
                    {
                        if (Fight.InFight && ObjectManager.Me.Target > 0)
                        {
                            if (ObjectManager.Me.Target != lastTarget && FlameShock.IsHostileDistanceGood)
                            {
                                Pull();
                                lastTarget = ObjectManager.Me.Target;
                            }

                            if (ObjectManager.Target.Level < 70 && ObjectManager.Me.Level > 84
                                && MySettings.UseLowCombat)
                            {
                                LC = 1;
                                if (CombatClass.InSpellRange(ObjectManager.Target, 0, Main.InternalRange))
                                    LowCombat();
                            }
                            else
                            {
                                LC = 0;
                                if (CombatClass.InSpellRange(ObjectManager.Target, 0, Main.InternalRange))
                                    Combat();
                            }
                        }
                        if (!ObjectManager.Me.IsCast)
                            Patrolling();
                    }
                }
                else
                    Thread.Sleep(500);
            }
            catch
            {
            }
            Thread.Sleep(100);
        }
    }

    private void Pull()
    {
        if (TotemicProjection.KnownSpell && TotemicProjection.IsSpellUsable && MySettings.UseTotemicProjection)
            TotemicProjection.Cast();

        if (FlameShock.KnownSpell && FlameShock.IsSpellUsable && FlameShock.IsHostileDistanceGood
            && MySettings.UseFlameShock && LC != 1)
        {
            FlameShock.Cast();
            return;
        }
        if (EarthShock.KnownSpell && EarthShock.IsSpellUsable && EarthShock.IsHostileDistanceGood
            && MySettings.UseEarthShock)
        {
            EarthShock.Cast();
        }
    }

    private void LowCombat()
    {
        Buff();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        DefenseCycle();
        Heal();

        if (EarthShock.KnownSpell && EarthShock.IsSpellUsable && EarthShock.IsHostileDistanceGood
            && MySettings.UseEarthShock)
        {
            EarthShock.Cast();
            return;
        }
        if (LavaBurst.KnownSpell && LavaBurst.IsSpellUsable && LavaBurst.IsHostileDistanceGood
            && MySettings.UseLavaBurst)
        {
            LavaBurst.Cast();
            return;
        }
        if (ChainLightning.KnownSpell && ChainLightning.IsSpellUsable && ChainLightning.IsHostileDistanceGood
            && MySettings.UseChainLightning)
        {
            ChainLightning.Cast();
            return;
        }
        if (SearingTotem.KnownSpell && SearingTotem.IsSpellUsable && MySettings.UseSearingTotem && !SearingTotem.CreatedBySpellInRange(25) && ObjectManager.GetUnitInSpellRange(30) > 0)
        {
            SearingTotem.Cast();
            return;
        }
    }

    private void Combat()
    {
        Buff();
        DPSBurst();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        DPSCycle();
        Decast();
        if (_onCd.IsReady)
            DefenseCycle();
        Heal();
    }


    private void Buff()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (WaterWalking.IsSpellUsable && WaterWalking.KnownSpell &&
            (!WaterWalking.HaveBuff || _waterWalkingTimer.IsReady)
            && !ObjectManager.Me.InCombat && MySettings.UseWaterWalking)
        {
            WaterWalking.CastOnSelf();
            _waterWalkingTimer = new Timer(1000*60*9);
            return;
        }
        if (MySettings.UseWaterShield && !WaterShield.HaveBuff && WaterShield.KnownSpell && WaterShield.IsSpellUsable && (!MySettings.UseLightningShield || ObjectManager.Me.ManaPercentage < 5))
        {
            WaterShield.CastOnSelf();
            return;
        }
        if (MySettings.UseLightningShield && (ObjectManager.Me.ManaPercentage > 10 || !MySettings.UseWaterShield) && LightningShield.KnownSpell && LightningShield.IsSpellUsable && !LightningShield.HaveBuff)
        {
            LightningShield.CastOnSelf();
            return;
        }
        if (ObjectManager.Me.InCombat && SpiritwalkersGrace.IsSpellUsable
            && SpiritwalkersGrace.KnownSpell && MySettings.UseSpiritwalkersGrace && ObjectManager.Me.GetMove)
        {
            SpiritwalkersGrace.Cast();
            return;
        }
        if (FlametongueWeapon.KnownSpell && FlametongueWeapon.IsSpellUsable && !ObjectManager.Me.HaveBuff(10400)
            && MySettings.UseFlametongueWeapon)
        {
            FlametongueWeapon.Cast();
            return;
        }
        if (FrostbrandWeapon.KnownSpell && FrostbrandWeapon.IsSpellUsable && !ObjectManager.Me.HaveBuff(8034)
            && MySettings.UseFrostbrandWeapon && !MySettings.UseFlametongueWeapon)
        {
            FrostbrandWeapon.Cast();
            return;
        }
        if (RockbiterWeapon.KnownSpell && RockbiterWeapon.IsSpellUsable && !ObjectManager.Me.HaveBuff(36494)
            && MySettings.UseRockbiterWeapon && !MySettings.UseFlametongueWeapon
            && !MySettings.UseFrostbrandWeapon)
        {
            RockbiterWeapon.Cast();
            return;
        }
        if (MountTask.GetMountCapacity() == MountCapacity.Ground && !ObjectManager.Me.InCombat && GhostWolf.IsSpellUsable && GhostWolf.KnownSpell
            && MySettings.UseGhostWolf && ObjectManager.Me.GetMove && !GhostWolf.HaveBuff
            && ObjectManager.Target.GetDistance > 50)
        {
            GhostWolf.Cast();
            return;
        }
        if (MySettings.UseAlchFlask && !ObjectManager.Me.HaveBuff(79638) && !ObjectManager.Me.HaveBuff(79640) && !ObjectManager.Me.HaveBuff(79639)
            && !ItemsManager.IsItemOnCooldown(75525) && ItemsManager.GetItemCount(75525) > 0)
        {
            ItemsManager.UseItem(75525);
        }
    }

    private void AvoidMelee()
    {
        if (ObjectManager.Target.GetDistance < MySettings.DoAvoidMeleeDistance && ObjectManager.Target.InCombat)
        {
            Logging.WriteFight("Too Close. Moving Back");
            var maxTimeTimer = new Timer(1000*2);
            MovementsAction.MoveBackward(true);
            while (ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat && !maxTimeTimer.IsReady)
                Others.SafeSleep(300);
            MovementsAction.MoveBackward(false);
            if (maxTimeTimer.IsReady && ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat)
            {
                MovementsAction.MoveForward(true);
                Others.SafeSleep(1000);
                MovementsAction.MoveForward(false);
                MovementManager.Face(ObjectManager.Target.Position);
            }
        }
    }

    private void DefenseCycle()
    {
        if (MySettings.UseHealingRain && HealingRain.IsSpellUsable)
        {
            SpellManager.CastSpellByIDAndPosition(HealingRain.Id, ObjectManager.Me.Position);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 50 && CapacitorTotem.KnownSpell && CapacitorTotem.IsSpellUsable && AirTotemReady() && MySettings.UseCapacitorTotem)
        {
            CapacitorTotem.Cast();
            _onCd = new Timer(1000*5);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 50 && StoneBulwarkTotem.KnownSpell && StoneBulwarkTotem.IsSpellUsable && EarthTotemReady() && MySettings.UseStoneBulwarkTotem)
        {
            StoneBulwarkTotem.Cast();
            _onCd = new Timer(1000*10);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseWarStompAtPercentage && WarStomp.IsSpellUsable && WarStomp.KnownSpell
            && MySettings.UseWarStomp)
        {
            WarStomp.Cast();
            _onCd = new Timer(1000*2);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseStoneformAtPercentage && Stoneform.IsSpellUsable && Stoneform.KnownSpell
            && MySettings.UseStoneform)
        {
            Stoneform.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 70 && AstralShift.KnownSpell && AstralShift.IsSpellUsable && MySettings.UseAstralShift)
        {
            AstralShift.Cast();
            _onCd = new Timer(1000*6);
        }
    }

    private void Heal()
    {
        if (ObjectManager.Me.IsMounted)
            return;
        if (ArcaneTorrent.IsSpellUsable && ArcaneTorrent.KnownSpell &&
            ObjectManager.Me.ManaPercentage <= MySettings.UseArcaneTorrentForResourceAtPercentage
            && MySettings.UseArcaneTorrentForResource)
        {
            ArcaneTorrent.Cast();
            return;
        }
        if (ObjectManager.Me.ManaPercentage < 50 && TotemicRecall.KnownSpell && TotemicRecall.IsSpellUsable
            && MySettings.UseTotemicRecall && !ObjectManager.Me.InCombat
            && TotemicRecallReady())
        {
            TotemicRecall.Cast();
            return;
        }
        if (Conductivity.KnownSpell && HealingRain.KnownSpell && MySettings.UseHealingRain
            && HealingRain.IsSpellUsable && ObjectManager.Me.InCombat
            && (ObjectManager.GetNumberAttackPlayer() > 1 || ObjectManager.Target.Health > ObjectManager.Me.MaxHealth))
        {
            SpellManager.CastSpellByIDAndPosition(73920, ObjectManager.Me.Position);
            while (ObjectManager.Me.IsCast)
            {
                Others.SafeSleep(200);
            }
            return;
        }
        if (ObjectManager.Me.HealthPercent < 95 && HealingSurge.KnownSpell && HealingSurge.IsSpellUsable
            && !ObjectManager.Me.InCombat && MySettings.UseHealingSurge)
        {
            HealingSurge.Cast();
            while (ObjectManager.Me.IsCast)
            {
                Others.SafeSleep(200);
            }
            return;
        }
        if (HealingSurge.KnownSpell && HealingSurge.IsSpellUsable && ObjectManager.Me.HealthPercent < 50
            && MySettings.UseHealingSurge)
        {
            HealingSurge.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseGiftoftheNaaruAtPercentage &&
            GiftoftheNaaru.KnownSpell && GiftoftheNaaru.IsSpellUsable
            && MySettings.UseGiftoftheNaaru)
        {
            GiftoftheNaaru.Cast();
            return;
        }
        if (HealingTideTotem.KnownSpell && HealingTideTotem.IsSpellUsable &&
            ObjectManager.Me.HealthPercent < 70
            && WaterTotemReady() && MySettings.UseHealingTideTotem)
        {
            HealingTideTotem.Cast();
            return;
        }
        if (AncestralGuidance.KnownSpell && AncestralGuidance.IsSpellUsable &&
            ObjectManager.Me.HealthPercent < 70
            && MySettings.UseAncestralGuidance)
        {
            AncestralGuidance.Cast();
            return;
        }
        if (ChainHeal.KnownSpell && ChainHeal.IsSpellUsable && ObjectManager.Me.HealthPercent < 80
            && MySettings.UseChainHeal)
        {
            ChainHeal.Cast();
            return;
        }
        if (HealingStreamTotem.KnownSpell && HealingStreamTotem.IsSpellUsable &&
            ObjectManager.Me.HealthPercent < 90
            && WaterTotemReady() && MySettings.UseHealingStreamTotem)
        {
            HealingStreamTotem.Cast();
        }
    }

    private void Decast()
    {
        if (ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe && MySettings.UseWindShear
            && WindShear.KnownSpell && WindShear.IsSpellUsable && WindShear.IsHostileDistanceGood)
        {
            WindShear.Cast();
            return;
        }
        if (ArcaneTorrent.IsSpellUsable && ArcaneTorrent.KnownSpell && ObjectManager.Target.GetDistance < 8
            && ObjectManager.Me.HealthPercent <= MySettings.UseArcaneTorrentForDecastAtPercentage
            && MySettings.UseArcaneTorrentForDecast && ObjectManager.Target.IsCast &&
            ObjectManager.Target.IsTargetingMe)
        {
            ArcaneTorrent.Cast();
            return;
        }
        if (ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe && MySettings.UseGroundingTotem
            && GroundingTotem.KnownSpell && GroundingTotem.IsSpellUsable && AirTotemReady())
        {
            GroundingTotem.Cast();
            return;
        }
        if (ObjectManager.Target.GetMove && !FrostShock.TargetHaveBuff && MySettings.UseFrostShock
            && FrostShock.KnownSpell && FrostShock.IsSpellUsable && FrostShock.IsHostileDistanceGood)
        {
            FrostShock.Cast();
            return;
        }
        if (ObjectManager.Target.GetMove && MySettings.UseEarthbindTotem && EarthTotemReady()
            && EarthbindTotem.KnownSpell && EarthbindTotem.IsSpellUsable && EarthbindTotem.IsHostileDistanceGood)
        {
            EarthbindTotem.Cast();
        }
    }

    private void DPSBurst()
    {
        if (MySettings.UseTrinketOne && !ItemsManager.IsItemOnCooldown(_firstTrinket.Entry) && ItemsManager.IsItemUsable(_firstTrinket.Entry))
        {
            ItemsManager.UseItem(_firstTrinket.Name);
            Logging.WriteFight("Use First Trinket Slot");
        }

        if (MySettings.UseTrinketTwo && !ItemsManager.IsItemOnCooldown(_secondTrinket.Entry) && ItemsManager.IsItemUsable(_secondTrinket.Entry))
        {
            ItemsManager.UseItem(_secondTrinket.Name);
            Logging.WriteFight("Use Second Trinket Slot");
            return;
        }
        if (Berserking.IsSpellUsable && Berserking.KnownSpell && ObjectManager.Target.GetDistance <= 40f
            && MySettings.UseBerserking)
        {
            Berserking.Cast();
            return;
        }
        if (BloodFury.IsSpellUsable && BloodFury.KnownSpell && ObjectManager.Target.GetDistance <= 40f
            && MySettings.UseBloodFury)
        {
            BloodFury.Cast();
            return;
        }
        if (UnleashElements.KnownSpell && UnleashElements.IsSpellUsable && UnleashedFury.KnownSpell
            && MySettings.UseUnleashElements && UnleashElements.IsHostileDistanceGood)
        {
            UnleashElements.Cast();
            return;
        }
        if (ElementalBlast.KnownSpell && ElementalBlast.IsSpellUsable
            && MySettings.UseElementalBlast && ElementalBlast.IsHostileDistanceGood)
        {
            ElementalBlast.Cast();
            return;
        }
        if (MySettings.UseAscendance && Ascendance.IsSpellUsable && ObjectManager.GetUnitInSpellRange(Main.InternalRange) > 0)
        {
            Ascendance.Cast();
            return;
        }
        if (FireElementalTotem.KnownSpell && FireElementalTotem.IsSpellUsable
            && MySettings.UseFireElementalTotem && ObjectManager.Target.GetDistance <= 40f)
        {
            FireElementalTotem.Cast();
            return;
        }
        if (StormlashTotem.KnownSpell && AirTotemReady()
            && MySettings.UseStormlashTotem && ObjectManager.Target.GetDistance <= 40f)
        {
            if (!StormlashTotem.IsSpellUsable && MySettings.UseCalloftheElements
                && CalloftheElements.KnownSpell && CalloftheElements.IsSpellUsable)
            {
                CalloftheElements.Cast();
                Others.SafeSleep(200);
            }

            if (StormlashTotem.IsSpellUsable)
                StormlashTotem.Cast();
            return;
        }
        if (Bloodlust.KnownSpell && Bloodlust.IsSpellUsable && MySettings.UseBloodlustHeroism
            && ObjectManager.Target.GetDistance <= 40f && !ObjectManager.Me.HaveBuff(57724))
        {
            Bloodlust.Cast();
            return;
        }

        if (Heroism.KnownSpell && Heroism.IsSpellUsable && MySettings.UseBloodlustHeroism
            && ObjectManager.Target.GetDistance <= 40f && !ObjectManager.Me.HaveBuff(57723))
        {
            Heroism.Cast();
            return;
        }
        if (ElementalMastery.KnownSpell && ElementalMastery.IsSpellUsable
            && !ObjectManager.Me.HaveBuff(2825) && MySettings.UseElementalMastery
            && !ObjectManager.Me.HaveBuff(32182))
        {
            ElementalMastery.Cast();
        }
    }

    private void DPSCycle()
    {
        Usefuls.SleepGlobalCooldown();
        try
        {
            Memory.WowMemory.GameFrameLock(); // !!! WARNING - DONT SLEEP WHILE LOCKED - DO FINALLY(GameFrameUnLock()) !!!

            if (MySettings.UseLavaBurst && LavaBurst.IsSpellUsable && LavaBurst.IsHostileDistanceGood && (FlameShock.TargetHaveBuff || !FlameShock.KnownSpell || !MySettings.UseFlameShock))
            {
                LavaBurst.Cast();
                return;
            }
            if (MySettings.UseFlameShock && FlameShock.IsSpellUsable && FlameShock.IsHostileDistanceGood && (!FlameShock.TargetHaveBuff || ObjectManager.Target.AuraIsActiveAndExpireInLessThanMs(FlameShock.Id, 9000)))
            {
                FlameShock.Cast();
                return;
            }
            if (MySettings.UseEarthShock && EarthShock.IsHostileDistanceGood && EarthShock.IsSpellUsable &&
                (LightningShield.BuffStack >= 17 || (ImprovedLightningShield.KnownSpell && LightningShield.BuffStack >= 15) || !MySettings.UseLightningShield || !LightningShield.KnownSpell))
            {
                EarthShock.Cast();
                return;
            }
            if (MySettings.UseElementalBlast && ElementalBlast.IsSpellUsable && ElementalBlast.IsHostileDistanceGood)
            {
                ElementalBlast.Cast();
                return;
            }
            if (MySettings.UseLavaBurst && LavaBurst.IsSpellUsable && LavaBurst.IsHostileDistanceGood)
            {
                LavaBurst.Cast();
                return;
            }
            if (MySettings.UseSearingTotem && SearingTotem.IsSpellUsable && FireTotemReady() && !SearingTotem.CreatedBySpellInRange(25) && ObjectManager.Target.GetDistance < 31)
            {
                SearingTotem.Cast();
                return;
            }
            if (MySettings.UseChainLightning && ChainLightning.IsSpellUsable && ChainLightning.IsHostileDistanceGood && ObjectManager.GetUnitInSpellRange(ChainLightning.MaxRangeHostile) > 1)
            {
                if (MySettings.UseAncestralSwiftness && AncestralSwiftness.IsSpellUsable)
                {
                    AncestralSwiftness.Cast();
                    Others.SafeSleep(200);
                }
                ChainLightning.Cast();
                return;
            }
            if (MySettings.UseLightningBolt && LightningBolt.IsSpellUsable && LightningBolt.IsHostileDistanceGood)
            {
                if (MySettings.UseAncestralSwiftness && AncestralSwiftness.IsSpellUsable)
                {
                    AncestralSwiftness.Cast();
                    Others.SafeSleep(200);
                }
                LightningBolt.Cast();
                return;
            }
        }
        finally
        {
            Memory.WowMemory.GameFrameUnLock();
        }
    }

    private bool FireTotemReady()
    {
        return !FireElementalTotem.CreatedBySpell;
    }

    private bool EarthTotemReady()
    {
        return !EarthbindTotem.CreatedBySpell && !EarthElementalTotem.CreatedBySpell && !StoneBulwarkTotem.CreatedBySpell;
    }

    private bool WaterTotemReady()
    {
        return !HealingStreamTotem.CreatedBySpell && !HealingTideTotem.CreatedBySpell;
    }

    private bool AirTotemReady()
    {
        return !CapacitorTotem.CreatedBySpell && !GroundingTotem.CreatedBySpell && !StormlashTotem.CreatedBySpell;
    }

    private bool TotemicRecallReady()
    {
        if (FireElementalTotem.CreatedBySpell)
            return false;
        if (EarthElementalTotem.CreatedBySpell)
            return false;
        if (SearingTotem.CreatedBySpell)
            return true;
        if (FireTotemReady() && EarthTotemReady() && WaterTotemReady() && AirTotemReady())
            return false;
        return true;
    }

    private void Patrolling()
    {
        if (ObjectManager.Me.IsMounted) return;
        Buff();
        Heal();
    }

    #region Nested type: ShamanElementalSettings

    [Serializable]
    public class ShamanElementalSettings : Settings
    {
        public bool DoAvoidMelee = false;
        public int DoAvoidMeleeDistance = 0;
        public bool UseAlchFlask = true;
        public bool UseAncestralGuidance = true;
        public bool UseAncestralSwiftness = true;
        public bool UseArcaneTorrentForDecast = true;
        public int UseArcaneTorrentForDecastAtPercentage = 100;
        public bool UseArcaneTorrentForResource = true;
        public int UseArcaneTorrentForResourceAtPercentage = 80;
        public bool UseAscendance = true;
        public bool UseAstralShift = true;
        public bool UseBerserking = true;
        public bool UseBloodFury = true;
        public bool UseBloodlustHeroism = true;
        public bool UseCalloftheElements = true;
        public bool UseCapacitorTotem = true;
        public bool UseChainHeal = false;
        public bool UseChainLightning = true;
        public bool UseEarthElementalTotem = true;
        public bool UseEarthShock = true;
        public bool UseEarthbindTotem = false;
        public bool UseEarthquake = true;
        public bool UseElementalBlast = true;
        public bool UseElementalMastery = true;

        public bool UseFireElementalTotem = true;
        public bool UseFlameShock = true;
        public bool UseFlametongueWeapon = true;
        public bool UseFrostShock = false;
        public bool UseFrostbrandWeapon = false;
        public bool UseGhostWolf = true;
        public bool UseGiftoftheNaaru = true;
        public int UseGiftoftheNaaruAtPercentage = 80;
        public bool UseGroundingTotem = true;
        public bool UseHealingRain = true;
        public bool UseHealingStreamTotem = true;
        public bool UseHealingSurge = true;
        public bool UseHealingTideTotem = true;
        public bool UseLavaBurst = true;

        public bool UseLightningBolt = true;
        public bool UseLightningShield = true;
        public bool UseLowCombat = true;
        public bool UseMagmaTotem = true;
        public bool UseRockbiterWeapon = false;
        public bool UseSearingTotem = true;
        public bool UseSpiritwalkersGrace = true;
        public bool UseStoneBulwarkTotem = true;
        public bool UseStoneform = true;
        public int UseStoneformAtPercentage = 80;
        public bool UseStormlashTotem = true;
        public bool UseThunderstorm = true;
        public bool UseTotemicProjection = true;
        public bool UseTotemicRecall = true;
        public bool UseTrinketOne = true;
        public bool UseTrinketTwo = true;
        public bool UseUnleashElements = true;
        public bool UseWarStomp = true;
        public int UseWarStompAtPercentage = 70;
        public bool UseWaterShield = true;
        public bool UseWaterWalking = true;
        public bool UseWindShear = true;

        public ShamanElementalSettings()
        {
            ConfigWinForm("Shaman Elemental Settings");
            /* Professions & Racials */
            AddControlInWinForm("Use Arcane Torrent for Interrupt", "UseArcaneTorrentForDecast", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Arcane Torrent for Resource", "UseArcaneTorrentForResource", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Berserking", "UseBerserking", "Professions & Racials");
            AddControlInWinForm("Use Blood Fury", "UseBloodFury", "Professions & Racials");
            AddControlInWinForm("Use Gift of the Naaru", "UseGiftoftheNaaru", "Professions & Racials");

            AddControlInWinForm("Use Stoneform", "UseStoneform", "Professions & Racials");
            AddControlInWinForm("Use War Stomp", "UseWarStomp", "Professions & Racials");
            /* Shaman Buffs */
            AddControlInWinForm("Use Flametongue Weapon", "UseFlametongueWeapon", "Shaman Buffs");
            AddControlInWinForm("Use Frostbrand Weapon", "UseFrostbrandWeapon", "Shaman Buffs");
            AddControlInWinForm("Use Ghost Wolf", "UseGhostWolf", "Shaman Buffs");
            AddControlInWinForm("Use Lightning Shield", "UseLightningShield", "Shaman Buffs");
            AddControlInWinForm("Use Rockbiter Weapon", "UseRockbiterWeapon", "Shaman Buffs");
            AddControlInWinForm("Use Spiritwalker's Grace", "UseSpiritwalkersGrace", "Shaman Buffs");
            AddControlInWinForm("Use Water Shield", "UseWaterShield", "Shaman Buffs");
            AddControlInWinForm("Use Water Walking", "UseWaterWalking", "Shaman Buffs");
            /* Offensive Spell */
            AddControlInWinForm("Use Chain Lightning", "UseChainLightning", "Offensive Spell");
            AddControlInWinForm("Use Earthquake", "UseEarthquake", "Offensive Spell");
            AddControlInWinForm("Use Earth Shock", "UseEarthShock", "Offensive Spell");
            AddControlInWinForm("Use Flame Shock", "UseFlameShock", "Offensive Spell");
            AddControlInWinForm("Use Frost Shock", "UseFrostShock", "Offensive Spell");
            AddControlInWinForm("Use Lava Burst", "UseLavaBurst", "Offensive Spell");
            AddControlInWinForm("Use Lightning Bolt", "UseLightningBolt", "Offensive Spell");
            AddControlInWinForm("Use Magma Totem", "UseMagmaTotem", "Offensive Spell");
            AddControlInWinForm("Use Searing Totem", "UseSearingTotem", "Offensive Spell");
            AddControlInWinForm("Use Thunderstorm", "UseThunderstorm", "Offensive Spell");
            /* Offensive Cooldown */
            AddControlInWinForm("Use Ancestral Swiftness", "UseAncestralSwiftness", "Offensive Cooldown");
            AddControlInWinForm("Use Ascendance", "UseAscendance", "Offensive Cooldown");
            AddControlInWinForm("Use Bloodlust / Heroism", "UseBloodlustHeroism", "Offensive Cooldown");
            AddControlInWinForm("Use Call of the Elements", "UseCalloftheElements", "Offensive Cooldown");
            AddControlInWinForm("Use Earth Elemental Totem", "UseEarthElementalTotem", "Offensive Cooldown");
            AddControlInWinForm("Use Elemental Blast", "UseElementalBlast", "Offensive Cooldown");
            AddControlInWinForm("Use Elemental Mastery", "UseElementalMastery", "Offensive Cooldown");
            AddControlInWinForm("Use Fire Elemental Totem", "UseFireElementalTotem", "Offensive Cooldown");
            AddControlInWinForm("Use Stormlash Totem", "UseStormlashTotem", "Offensive Cooldown");
            AddControlInWinForm("Use Totemic Projection", "UseTotemicProjection", "Offensive Cooldown");
            AddControlInWinForm("Use Unleash Elements", "UseUnleashElements", "Offensive Cooldown");
            /* Defensive Cooldown */
            AddControlInWinForm("Use Astral Shift", "UseAstralShift", "Defensive Cooldown");
            AddControlInWinForm("Use Capacitor Totem", "UseCapacitorTotem", "Defensive Cooldown");
            AddControlInWinForm("Use Earthbind Totem", "UseEarthbindTotem", "Defensive Cooldown");
            AddControlInWinForm("Use Grounding Totem", "UseGroundingTotem", "Defensive Cooldown");
            AddControlInWinForm("Use StoneBulwark Totem", "UseStoneBulwarkTotem", "Defensive Cooldown");
            AddControlInWinForm("Use Wind Shear", "UseWindShear", "Defensive Cooldown");
            /* Healing Spell */
            AddControlInWinForm("Use Ancestral Guidance", "UseAncestralGuidance", "Healing Spell");
            AddControlInWinForm("Use Chain Heal", "UseChainHeal", "Healing Spell");
            AddControlInWinForm("Use Healing Rain", "UseHealingRain", "Healing Spell");
            AddControlInWinForm("Use Healing Surge", "UseHealingSurge", "Healing Spell");
            AddControlInWinForm("Use Healing Stream Totem", "UseHealingStreamTotem", "Healing Spell");
            AddControlInWinForm("Use Healing Tide Totem", "UsHealingTideTotem", "Healing Spell");
            AddControlInWinForm("Use Totemic Recall", "UseTotemicRecall", "Healing Spell");
            /* Game Settings */
            AddControlInWinForm("Use Low Combat Settings", "UseLowCombat", "Game Settings");
            AddControlInWinForm("Use Trinket One", "UseTrinketOne", "Game Settings");
            AddControlInWinForm("Use Trinket Two", "UseTrinketTwo", "Game Settings");

            AddControlInWinForm("Use Alchemist Flask", "UseAlchFlask", "Game Settings");
            AddControlInWinForm("Do avoid melee (Off Advised!!)", "DoAvoidMelee", "Game Settings");
            AddControlInWinForm("Avoid melee distance (1 to 4)", "DoAvoidMeleeDistance", "Game Settings");
        }

        public static ShamanElementalSettings CurrentSetting { get; set; }

        public static ShamanElementalSettings GetSettings()
        {
            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Shaman_Elemental.xml";
            if (File.Exists(currentSettingsFile))
            {
                return
                    CurrentSetting = Load<ShamanElementalSettings>(currentSettingsFile);
            }
            return new ShamanElementalSettings();
        }
    }

    #endregion
}

#endregion

#region Priest

public class PriestShadow
{
    private static PriestShadowSettings MySettings = PriestShadowSettings.GetSettings();

    #region General Timers & Variables

    private readonly WoWItem _firstTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET);
    private readonly WoWItem _secondTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET, 2);
    public int LC = 0;

    private Timer _onCd = new Timer(0);

    #endregion

    #region Professions and Racials

    public readonly Spell Alchemy = new Spell("Alchemy");
    public readonly Spell ArcaneTorrent = new Spell("Arcane Torrent");
    public readonly Spell Berserking = new Spell("Berserking");
    public readonly Spell BloodFury = new Spell("Blood Fury");

    public readonly Spell GiftoftheNaaru = new Spell("Gift of the Naaru");

    public readonly Spell Stoneform = new Spell("Stoneform");
    public readonly Spell WarStomp = new Spell("War Stomp");

    #endregion

    #region Priest Buffs

    public readonly Spell InnerFire = new Spell("Inner Fire");
    public readonly Spell InnerWill = new Spell("Inner Will");
    public readonly Spell Levitate = new Spell("Levitate");
    public readonly Spell PowerWordFortitude = new Spell("Power Word: Fortitude");
    public readonly Spell Shadowform = new Spell("Shadowform");
    public readonly Spell ClarityofPower = new Spell("Clarity of Power");
    private Timer _levitateTimer = new Timer(0);

    #endregion

    #region Offensive Spell

    public readonly Spell Cascade = new Spell("Cascade");
    public readonly Spell DevouringPlague = new Spell("Devouring Plague");
    public readonly Spell DivineStar = new Spell("Divine Star");
    public readonly Spell Halo = new Spell("Halo");
    public readonly Spell MindBlast = new Spell("Mind Blast");
    public readonly Spell MindFlay = new Spell("Mind Flay");
    public readonly Spell MindSear = new Spell("Mind Sear");
    public readonly Spell MindSpike = new Spell("Mind Spike");
    public readonly Spell ShadowWordDeath = new Spell("Shadow Word: Death");
    public readonly Spell Insanity = new Spell("Insanity");
    public readonly Spell ShadowWordPain = new Spell("Shadow Word: Pain");
    public readonly Spell Smite = new Spell("Smite");
    public readonly Spell VampiricTouch = new Spell("Vampiric Touch");
    public readonly Spell VoidEntropy = new Spell("Void Entropy");
    private Timer _devouringPlagueTimer = new Timer(0);
    private Timer _shadowWordPainTimer = new Timer(0);
    private Timer _vampiricTouchTimer = new Timer(0);
    private Timer _voidEntropyTimer = new Timer(0);

    #endregion

    #region Offensive Cooldown

    public readonly Spell PowerInfusion = new Spell("Power Infusion");
    public readonly Spell Shadowfiend = new Spell("Shadowfiend");

    #endregion

    #region Defensive Cooldown

    public readonly Spell Dispersion = new Spell("Dispersion");
    public readonly Spell PowerWordShield = new Spell("Power Word: Shield");
    public readonly Spell PsychicHorror = new Spell("Psychic Horror");
    public readonly Spell PsychicScream = new Spell("Psychic Scream");
    public readonly Spell Psyfiend = new Spell("Psyfiend");
    public readonly Spell Silence = new Spell("Silence");
    public readonly Spell SpectralGuise = new Spell("Spectral Guise");
    public readonly Spell VoidTendrils = new Spell("Void Tendrils");

    #endregion

    #region Healing Spell

    public readonly Spell DesperatePrayer = new Spell("Desperate Prayer");
    public readonly Spell FlashHeal = new Spell("Flash Heal");
    public readonly Spell HymnofHope = new Spell("Hymn of Hope");
    public readonly Spell PrayerofMending = new Spell("Prayer of Mending");
    public readonly Spell Renew = new Spell("Renew");
    public readonly Spell VampiricEmbrace = new Spell("Vampiric Embrace");
/*
        private Timer _renewTimer = new Timer(0);
*/

    #endregion

    public PriestShadow()
    {
        Main.InternalRange = 39f;
        Main.InternalAggroRange = 39f;
        MySettings = PriestShadowSettings.GetSettings();
        Main.DumpCurrentSettings<PriestShadowSettings>(MySettings);
        UInt128 lastTarget = 0;

        while (Main.InternalLoop)
        {
            try
            {
                if (!ObjectManager.Me.IsDead)
                {
                    if (!ObjectManager.Me.IsMounted)
                    {
                        BuffLevitate();
                        if (Fight.InFight && ObjectManager.Me.Target > 0)
                        {
                            if (ObjectManager.Me.Target != lastTarget &&
                                (MindSpike.IsHostileDistanceGood || ShadowWordPain.IsHostileDistanceGood))
                            {
                                Pull();
                                lastTarget = ObjectManager.Me.Target;
                            }

                            if (ObjectManager.Target.Level < 70 && ObjectManager.Me.Level > 84
                                && MySettings.UseLowCombat)
                            {
                                LC = 1;
                                if (CombatClass.InSpellRange(ObjectManager.Target, 0, Main.InternalRange))
                                    LowCombat();
                            }
                            else
                            {
                                LC = 0;
                                if (CombatClass.InSpellRange(ObjectManager.Target, 0, Main.InternalRange))
                                    Combat();
                            }
                        }
                        if (!ObjectManager.Me.IsCast)
                            Patrolling();
                    }
                }
                else
                    Thread.Sleep(500);
            }
            catch
            {
            }
            Thread.Sleep(100);
        }
    }

    private void BuffLevitate()
    {
        if (!ObjectManager.Me.InCombat && Levitate.KnownSpell && Levitate.IsSpellUsable && MySettings.UseLevitate
            && (!Levitate.HaveBuff || _levitateTimer.IsReady))
        {
            Levitate.Cast();
            _levitateTimer = new Timer(1000*60*9);
        }
    }

    private void Pull()
    {
        if (DevouringPlague.IsSpellUsable && DevouringPlague.KnownSpell && DevouringPlague.IsHostileDistanceGood
            && ObjectManager.Me.ShadowOrbs == 3 && MySettings.UseDevouringPlague)
        {
            DevouringPlague.Cast();
            return;
        }
        if (ShadowWordPain.IsSpellUsable && ShadowWordPain.KnownSpell && ShadowWordPain.IsHostileDistanceGood
            && MySettings.UseShadowWordPain)
        {
            ShadowWordPain.Cast();
            _shadowWordPainTimer = new Timer(1000*14);
        }
    }

    private void LowCombat()
    {
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        Heal();
        DefenseCycle();
        Buff();

        if (DevouringPlague.IsSpellUsable && DevouringPlague.KnownSpell && DevouringPlague.IsHostileDistanceGood
            && ObjectManager.Me.ShadowOrbs == 3 && MySettings.UseDevouringPlague)
        {
            DevouringPlague.Cast();
            return;
        }
        if (MindSpike.KnownSpell && MindSpike.IsSpellUsable && MindSpike.IsHostileDistanceGood
            && MySettings.UseMindSpike)
        {
            MindSpike.Cast();
            if (ObjectManager.Target.HealthPercent < 50 && ObjectManager.Target.HealthPercent > 0)
            {
                MindSpike.Cast();
                return;
            }
            return;
        }
        if (MindSear.KnownSpell && MindSear.IsSpellUsable && MindSear.IsHostileDistanceGood
            && MySettings.UseMindSear)
        {
            MindSear.Cast();
        }
    }

    private void Combat()
    {
        Buff();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        if (_onCd.IsReady)
            DefenseCycle();
        DPSCycle();
        Heal();
        Decast();
        DPSCycle();
        DPSBurst();
        DPSCycle();
    }

    private void Buff()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (PowerWordFortitude.KnownSpell && PowerWordFortitude.IsSpellUsable &&
            !PowerWordFortitude.HaveBuff && MySettings.UsePowerWordFortitude)
        {
            PowerWordFortitude.Cast();
            return;
        }
        if (InnerFire.KnownSpell && InnerFire.IsSpellUsable && !InnerFire.HaveBuff
            && MySettings.UseInnerFire)
        {
            InnerFire.Cast();
            return;
        }
        if (InnerWill.KnownSpell && InnerWill.IsSpellUsable && !InnerWill.HaveBuff
            && !MySettings.UseInnerFire && MySettings.UseInnerWill)
        {
            InnerWill.Cast();
            return;
        }
        if (MySettings.UseAlchFlask && !ObjectManager.Me.HaveBuff(79638) && !ObjectManager.Me.HaveBuff(79640) && !ObjectManager.Me.HaveBuff(79639)
            && !ItemsManager.IsItemOnCooldown(75525) && ItemsManager.GetItemCount(75525) > 0)
        {
            ItemsManager.UseItem(75525);
            return;
        }
        if (!Shadowform.HaveBuff && Shadowform.KnownSpell && Shadowform.IsSpellUsable
            && MySettings.UseShadowform)
        {
            Shadowform.Cast();
        }
    }

    private void AvoidMelee()
    {
        if (ObjectManager.Target.GetDistance < MySettings.DoAvoidMeleeDistance && ObjectManager.Target.InCombat)
        {
            Logging.WriteFight("Too Close. Moving Back");
            var maxTimeTimer = new Timer(1000*2);
            MovementsAction.MoveBackward(true);
            while (ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat && !maxTimeTimer.IsReady)
                Others.SafeSleep(300);
            MovementsAction.MoveBackward(false);
            if (maxTimeTimer.IsReady && ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat)
            {
                MovementsAction.MoveForward(true);
                Others.SafeSleep(1000);
                MovementsAction.MoveForward(false);
                MovementManager.Face(ObjectManager.Target.Position);
            }
        }
    }

    private void DefenseCycle()
    {
        if (ObjectManager.Me.HealthPercent <= MySettings.UsePsychicScreamAtPercentage && PsychicScream.IsSpellUsable &&
            PsychicScream.KnownSpell
            && MySettings.UsePsychicScream)
        {
            PsychicScream.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseDispersionHealthAtPercentage && Dispersion.KnownSpell &&
            Dispersion.IsSpellUsable
            && MySettings.UseDispersionHealth)
        {
            if (Renew.KnownSpell && Renew.IsSpellUsable && MySettings.UseRenew)
            {
                Renew.Cast();
                Others.SafeSleep(1500);
            }
            Dispersion.Cast();
            _onCd = new Timer(1000*6);
            return;
        }
        if (ObjectManager.GetNumberAttackPlayer() >= 2 &&
            ObjectManager.Me.HealthPercent <= MySettings.UseVoidTendrilsAtPercentage &&
            VoidTendrils.IsSpellUsable && VoidTendrils.KnownSpell && MySettings.UseVoidTendrils)
        {
            VoidTendrils.Cast();
            _onCd = new Timer(1000*10);
            return;
        }
        if (ObjectManager.GetNumberAttackPlayer() >= 2 &&
            ObjectManager.Me.HealthPercent <= MySettings.UsePsyfiendAtPercentage &&
            Psyfiend.IsSpellUsable && Psyfiend.KnownSpell && MySettings.UsePsyfiend)
        {
            Psyfiend.Cast();
            _onCd = new Timer(1000*10);
            return;
        }
        if (PowerWordShield.KnownSpell && PowerWordShield.IsSpellUsable
            && !PowerWordShield.HaveBuff && MySettings.UsePowerWordShield
            && !ObjectManager.Me.HaveBuff(6788) &&
            ObjectManager.Me.HealthPercent <= MySettings.UsePowerWordShieldAtPercentage
            && (ObjectManager.Me.InCombat || ObjectManager.Me.GetMove))
        {
            PowerWordShield.Cast();
            _onCd = new Timer(1000*6);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseSpectralGuiseAtPercentage &&
            SpectralGuise.IsSpellUsable && SpectralGuise.KnownSpell
            && MySettings.UseSpectralGuise)
        {
            if (Renew.KnownSpell && Renew.IsSpellUsable && MySettings.UseRenew)
            {
                Renew.Cast();
                Others.SafeSleep(1500);
            }
            SpectralGuise.Cast();
            _onCd = new Timer(1000*3);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseStoneformAtPercentage &&
            Stoneform.IsSpellUsable && Stoneform.KnownSpell
            && MySettings.UseStoneform)
        {
            Stoneform.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseWarStompAtPercentage &&
            WarStomp.IsSpellUsable && WarStomp.KnownSpell
            && MySettings.UseWarStomp)
        {
            WarStomp.Cast();
            _onCd = new Timer(1000*2);
        }
    }

    private void Heal()
    {
        if (MySettings.UseArcaneTorrentForResource && ArcaneTorrent.KnownSpell && ArcaneTorrent.IsSpellUsable
            && ObjectManager.Me.ManaPercentage <= MySettings.UseArcaneTorrentForResourceAtPercentage)
        {
            ArcaneTorrent.Cast();
            return;
        }

        if (ObjectManager.Me.HealthPercent <= MySettings.UseFlashHealNonCombatAtPercentage &&
            !ObjectManager.Me.InCombat
            && FlashHeal.KnownSpell && FlashHeal.IsSpellUsable && MySettings.UseFlashHealNonCombat)
        {
            FlashHeal.Cast(false);
            return;
        }
        if (ObjectManager.Me.ManaPercentage <= MySettings.UseHymnofHopeAtPercentage &&
            HymnofHope.KnownSpell
            && HymnofHope.IsSpellUsable && !ObjectManager.Me.InCombat && MySettings.UseHymnofHope)
        {
            HymnofHope.Cast(false);
            return;
        }
        if (ObjectManager.Me.ManaPercentage <= MySettings.UseDispersionManaAtPercentage &&
            !ObjectManager.Me.InCombat
            && Dispersion.KnownSpell && Dispersion.IsSpellUsable && MySettings.UseDispersionMana)
        {
            Dispersion.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseDesperatePrayerAtPercentage &&
            DesperatePrayer.KnownSpell && DesperatePrayer.IsSpellUsable
            && MySettings.UseDesperatePrayer)
        {
            DesperatePrayer.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseFlashHealInCombatAtPercentage &&
            FlashHeal.KnownSpell && FlashHeal.IsSpellUsable
            && MySettings.UseFlashHealInCombat)
        {
            FlashHeal.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseGiftoftheNaaruAtPercentage &&
            GiftoftheNaaru.IsSpellUsable && GiftoftheNaaru.KnownSpell
            && MySettings.UseGiftoftheNaaru)
        {
            GiftoftheNaaru.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseVampiricEmbraceAtPercentage &&
            VampiricEmbrace.IsSpellUsable && VampiricEmbrace.KnownSpell
            && MySettings.UseVampiricEmbrace)
        {
            VampiricEmbrace.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UsePrayerofMendingAtPercentage &&
            PrayerofMending.KnownSpell && PrayerofMending.IsSpellUsable
            && MySettings.UsePrayerofMending)
        {
            PrayerofMending.Cast();
            return;
        }
        if (Renew.KnownSpell && Renew.IsSpellUsable && !Renew.HaveBuff &&
            ObjectManager.Me.HealthPercent <= MySettings.UseRenewAtPercentage &&
            MySettings.UseRenew)
        {
            Renew.Cast();
        }
    }

    private void Decast()
    {
        if (MySettings.UseArcaneTorrentForDecast && ArcaneTorrent.KnownSpell && ObjectManager.Target.GetDistance < 8 && ArcaneTorrent.IsSpellUsable
            && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe
            && ObjectManager.Me.HealthPercent <= MySettings.UseArcaneTorrentForDecastAtPercentage)
        {
            ArcaneTorrent.Cast();
            return;
        }
        if (ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe && MySettings.UseSilence
            && Silence.KnownSpell && Silence.IsSpellUsable && Silence.IsHostileDistanceGood
            && ObjectManager.Target.HealthPercent <= MySettings.UseSilenceAtPercentage)
        {
            Silence.Cast();
            return;
        }
        if (ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe && MySettings.UsePsychicHorror
            && PsychicHorror.KnownSpell && PsychicHorror.IsSpellUsable && PsychicHorror.IsHostileDistanceGood
            && ObjectManager.Target.HealthPercent <= MySettings.UsePsychicHorrorAtPercentage)
        {
            PsychicHorror.Cast();
        }
    }

    private void DPSBurst()
    {
        if (MySettings.UseTrinketOne && !ItemsManager.IsItemOnCooldown(_firstTrinket.Entry) && ItemsManager.IsItemUsable(_firstTrinket.Entry))
        {
            ItemsManager.UseItem(_firstTrinket.Name);
            Logging.WriteFight("Use First Trinket Slot");
        }

        if (MySettings.UseTrinketTwo && !ItemsManager.IsItemOnCooldown(_secondTrinket.Entry) && ItemsManager.IsItemUsable(_secondTrinket.Entry))
        {
            ItemsManager.UseItem(_secondTrinket.Name);
            Logging.WriteFight("Use Second Trinket Slot");
            return;
        }
        if (Berserking.IsSpellUsable && Berserking.KnownSpell && ObjectManager.Target.GetDistance <= 40f
            && MySettings.UseBerserking)
        {
            Berserking.Cast();
            return;
        }
        if (BloodFury.IsSpellUsable && BloodFury.KnownSpell && ObjectManager.Target.GetDistance <= 40f
            && MySettings.UseBloodFury)
        {
            BloodFury.Cast();
            return;
        }
        if (PowerInfusion.IsSpellUsable && PowerInfusion.KnownSpell
            && MySettings.UsePowerInfusion && ObjectManager.Target.GetDistance <= 40f)
        {
            PowerInfusion.Cast();
            return;
        }
        if (Shadowfiend.IsSpellUsable && Shadowfiend.KnownSpell && Shadowfiend.IsHostileDistanceGood
            && MySettings.UseShadowfiend)
        {
            Shadowfiend.Cast();
        }
    }

    private void DPSCycle()
    {
        Usefuls.SleepGlobalCooldown();
        try
        {
            Memory.WowMemory.GameFrameLock(); // !!! WARNING - DONT SLEEP WHILE LOCKED - DO FINALLY(GameFrameUnLock()) !!!

            if (ObjectManager.Me.ManaPercentage <= MySettings.UseArcaneTorrentForResourceAtPercentage && ArcaneTorrent.KnownSpell && ArcaneTorrent.IsSpellUsable
                && MySettings.UseArcaneTorrentForResource)
            {
                ArcaneTorrent.Cast();
                return;
            }
            if (ObjectManager.GetNumberAttackPlayer() > 2 && Cascade.IsSpellUsable && Cascade.KnownSpell
                && Cascade.IsHostileDistanceGood && MySettings.UseCascade)
            {
                Cascade.Cast();
                return;
            }
            if (ObjectManager.GetNumberAttackPlayer() > 2 && DivineStar.IsSpellUsable && DivineStar.KnownSpell
                && DivineStar.IsHostileDistanceGood && MySettings.UseDivineStar)
            {
                DivineStar.Cast();
                return;
            }
            if (ObjectManager.GetNumberAttackPlayer() > 2 && Halo.IsSpellUsable && Halo.KnownSpell
                && Halo.IsHostileDistanceGood && MySettings.UseHalo)
            {
                Halo.Cast();
                return;
            }
            if (ObjectManager.GetNumberAttackPlayer() > 4 && MindSear.IsSpellUsable && MindSear.KnownSpell
                && MindSear.IsHostileDistanceGood && !ObjectManager.Me.IsCast && MySettings.UseMindSear)
            {
                MindSear.Cast();
                return;
            }
            if (ShadowWordDeath.IsSpellUsable && ShadowWordDeath.IsHostileDistanceGood && ShadowWordDeath.KnownSpell
                && ObjectManager.Target.HealthPercent < 20 && MySettings.UseShadowWordDeath && ObjectManager.Me.ShadowOrbs < 5)
            {
                ShadowWordDeath.Cast();
                return;
            }
            if (ShadowWordPain.KnownSpell && ShadowWordPain.IsSpellUsable
                && ShadowWordPain.IsHostileDistanceGood && MySettings.UseShadowWordPain && !ClarityofPower.KnownSpell
                && (!ShadowWordPain.TargetHaveBuff || _shadowWordPainTimer.IsReady))
            {
                ShadowWordPain.Cast();
                _shadowWordPainTimer = new Timer(1000*15);
                return;
            }
            if (VampiricTouch.KnownSpell && VampiricTouch.IsSpellUsable
                && VampiricTouch.IsHostileDistanceGood && MySettings.UseVampiricTouch && !ClarityofPower.KnownSpell
                && (!VampiricTouch.TargetHaveBuff || _vampiricTouchTimer.IsReady))
            {
                VampiricTouch.Cast();
                _vampiricTouchTimer = new Timer(1000*12);
                return;
            }
            if (VoidEntropy.KnownSpell && VoidEntropy.IsSpellUsable
                && VoidEntropy.IsHostileDistanceGood && MySettings.UseVoidEntropy
                && (!VoidEntropy.TargetHaveBuff || _voidEntropyTimer.IsReady))
            {
                VoidEntropy.Cast();
                _voidEntropyTimer = new Timer(1000*57);
                return;
            }
            if (MindSpike.IsSpellUsable && MindSpike.IsHostileDistanceGood && MindSpike.KnownSpell &&
                ObjectManager.Me.HaveBuff(87160) && MySettings.UseMindSpike)
            {
                MindSpike.Cast();
                return;
            }
            if (DevouringPlague.KnownSpell && DevouringPlague.IsSpellUsable && DevouringPlague.IsHostileDistanceGood &&
                ObjectManager.Me.ShadowOrbs > 2 && MySettings.UseDevouringPlague
                && (!DevouringPlague.TargetHaveBuff || _devouringPlagueTimer.IsReady))
            {
                DevouringPlague.Cast();
                _devouringPlagueTimer = new Timer(1000*3);
                if (Insanity.KnownSpell)
                {
                    Others.SafeSleep(1000);
                    MindFlay.Cast();
                }
                return;
            }
            if (MindBlast.KnownSpell && MindBlast.IsSpellUsable && MindBlast.IsHostileDistanceGood
                && ObjectManager.Me.ShadowOrbs < 5 && MySettings.UseMindBlast)
            {
                MindBlast.Cast();
                return;
            }
            if (MindSpike.IsSpellUsable && MindSpike.IsHostileDistanceGood && MindSpike.KnownSpell &&
                (ObjectManager.Me.HaveBuff(87160) || ClarityofPower.KnownSpell) && MySettings.UseMindSpike)
            {
                MindSpike.Cast();
                return;
            }
            if (MySettings.UseMindFlay && MindFlay.KnownSpell && MindFlay.IsHostileDistanceGood && MindFlay.IsSpellUsable && !ObjectManager.Me.IsCast
                && (ShadowWordPain.TargetHaveBuff || !MySettings.UseShadowWordPain || !ShadowWordPain.KnownSpell) &&
                (VampiricTouch.TargetHaveBuff || !MySettings.UseVampiricTouch || !VampiricTouch.KnownSpell)
                && !ObjectManager.Me.HaveBuff(87160) && ObjectManager.GetNumberAttackPlayer() < 5
                && ObjectManager.Me.ShadowOrbs < 3 && !ClarityofPower.KnownSpell)
            {
                MindFlay.Cast();
                return;
            }
            // Blizzard API Calls for Mind Flay using Smite Function
            if (MySettings.UseMindFlay && Smite.KnownSpell && Smite.IsHostileDistanceGood && Smite.IsSpellUsable && !ObjectManager.Me.IsCast
                && (ShadowWordPain.TargetHaveBuff || !MySettings.UseShadowWordPain || !ShadowWordPain.KnownSpell) &&
                (VampiricTouch.TargetHaveBuff || !MySettings.UseVampiricTouch || !VampiricTouch.KnownSpell || !_vampiricTouchTimer.IsReady)
                && !ObjectManager.Me.HaveBuff(87160) && ObjectManager.GetNumberAttackPlayer() < 5
                && ObjectManager.Me.ShadowOrbs < 3 && !ClarityofPower.KnownSpell)
            {
                Smite.Cast();
            }
        }
        finally
        {
            Memory.WowMemory.GameFrameUnLock();
        }
    }

    private void Patrolling()
    {
        if (ObjectManager.Me.IsMounted) return;
        Buff();
        Heal();
    }

    #region Nested type: PriestShadowSettings

    [Serializable]
    public class PriestShadowSettings : Settings
    {
        public bool DoAvoidMelee = false;
        public int DoAvoidMeleeDistance = 0;
        public bool UseAlchFlask = true;
        public bool UseArcaneTorrentForDecast = true;
        public int UseArcaneTorrentForDecastAtPercentage = 100;
        public bool UseArcaneTorrentForResource = true;
        public int UseArcaneTorrentForResourceAtPercentage = 80;
        public bool UseBerserking = true;
        public bool UseBloodFury = true;
        public bool UseCascade = true;
        public bool UseDesperatePrayer = true;
        public int UseDesperatePrayerAtPercentage = 65;
        public bool UseDevouringPlague = true;
        public bool UseDispersionHealth = true;
        public int UseDispersionHealthAtPercentage = 20;
        public bool UseDispersionMana = true;
        public int UseDispersionManaAtPercentage = 60;
        public bool UseDivineStar = true;

        public bool UseFlashHealInCombat = true;
        public int UseFlashHealInCombatAtPercentage = 60;
        public bool UseFlashHealNonCombat = true;
        public int UseFlashHealNonCombatAtPercentage = 95;
        public bool UseGiftoftheNaaru = true;
        public int UseGiftoftheNaaruAtPercentage = 80;
        public bool UseHalo = true;
        public bool UseHymnofHope = true;
        public int UseHymnofHopeAtPercentage = 40;
        public bool UseInnerFire = true;
        public bool UseInnerWill = false;
        public bool UseLevitate = false;

        public bool UseLowCombat = true;
        public bool UseMindBlast = true;
        public bool UseMindFlay = true;
        public bool UseMindSear = true;
        public bool UseMindSpike = true;
        public bool UsePowerInfusion = true;
        public bool UsePowerWordFortitude = true;
        public bool UsePowerWordShield = true;
        public int UsePowerWordShieldAtPercentage = 100;
        public bool UsePrayerofMending = true;
        public int UsePrayerofMendingAtPercentage = 50;
        public bool UsePsychicHorror = true;
        public int UsePsychicHorrorAtPercentage = 100;
        public bool UsePsychicScream = true;
        public int UsePsychicScreamAtPercentage = 20;
        public bool UsePsyfiend = true;
        public int UsePsyfiendAtPercentage = 35;
        public bool UseRenew = true;
        public int UseRenewAtPercentage = 90;
        public bool UseShadowWordDeath = true;
        public bool UseShadowWordInsanity = true;
        public bool UseShadowWordPain = true;
        public bool UseShadowfiend = true;
        public bool UseShadowform = true;
        public bool UseSilence = true;
        public int UseSilenceAtPercentage = 100;
        public bool UseSpectralGuise = true;
        public int UseSpectralGuiseAtPercentage = 70;
        public bool UseStoneform = true;
        public int UseStoneformAtPercentage = 80;
        public bool UseTrinketOne = true;
        public bool UseTrinketTwo = true;
        public bool UseVampiricEmbrace = true;
        public int UseVampiricEmbraceAtPercentage = 80;
        public bool UseVampiricTouch = true;
        public bool UseVoidEntropy = true;
        public bool UseVoidTendrils = true;
        public int UseVoidTendrilsAtPercentage = 35;
        public bool UseWarStomp = true;
        public int UseWarStompAtPercentage = 80;

        public PriestShadowSettings()
        {
            ConfigWinForm("Shadow Priest Settings");
            /* Professions and Racials */
            AddControlInWinForm("Use Arcane Torrent for Interrupt", "UseArcaneTorrentForDecast", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Arcane Torrent for Resource", "UseArcaneTorrentForResource", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Berserking", "UseBerserking", "Professions and Racials");
            AddControlInWinForm("Use Blood Fury", "UseBloodFury", "Professions and Racials");
            AddControlInWinForm("Use Gift of the Naaru", "UseGiftoftheNaaru", "Professions and Racials", "AtPercentage");
            AddControlInWinForm("Use Lifeblood", "UseLifeblood", "Professions and Racials");
            AddControlInWinForm("Use Stoneform", "UseStoneform", "Professions and Racials", "AtPercentage");
            AddControlInWinForm("Use War Stomp", "UseWarStomp", "Professions and Racials", "AtPercentage");
            /* Priest Buffs */
            AddControlInWinForm("Use Inner Fire", "UseInnerFire", "Priest Buffs");
            AddControlInWinForm("Use Inner Will", "UseInnerWill", "Priest Buffs");
            AddControlInWinForm("Use Levitate", "UseLevitate", "Priest Buffs");
            AddControlInWinForm("Use Power Word: Fortitude", "UsePowerWordFortitude", "Priest Buffs");
            AddControlInWinForm("Use Shadowform", "UseShadowform", "Priest Buffs");
            /* Offensive Spell */
            AddControlInWinForm("Use Cascade", "UseCascade", "Offensive Spell");
            AddControlInWinForm("Use Devouring Plague", "UseDevoringPlague", "Offensive Spell");
            AddControlInWinForm("Use DivineStar", "UseDivineStar", "Offensive Spell");
            AddControlInWinForm("Use Halo", "UseHalo", "Offensive Spell");
            AddControlInWinForm("Use Mind Blast", "UseMindBlast", "Offensive Spell");
            AddControlInWinForm("Use Mind Flay", "UseMindFlay", "Offensive Spell");
            AddControlInWinForm("Use Mind Sear", "UseMindSear", "Offensive Spell");
            AddControlInWinForm("Use Mind Spike", "UseMindSpike", "Offensive Spell");
            AddControlInWinForm("Use Shadow Word: Death", "UseShadowWordDeath", "Offensive Spell");
            AddControlInWinForm("Use Shadow Word: Insanity", "UseShadowWordInsanity", "Offensive Spell");
            AddControlInWinForm("Use Shadow Word: Pain", "UseShadowWordPain", "Offensive Spell");
            AddControlInWinForm("Use Vampiric Touch", "UseVampiricTouch", "Offensive Spell");
            AddControlInWinForm("Use Void Entropy", "UseVoidEntropy", "Offensive Spell");
            /* Offensive Cooldown */
            AddControlInWinForm("Use Power Infusion", "UsePowerInfusion", "Offensive Cooldown");
            AddControlInWinForm("Use Shadowfiend", "UseShadowfiend", "Offensive Cooldown");
            /* Defensive Cooldown */
            AddControlInWinForm("Use Dispersion when health low", "UseDispersionHealth", "Defensive Cooldown",
                "AtPercentage");
            AddControlInWinForm("Use Dispersion when mana low", "UseDispersionMana", "Defensive Cooldown",
                "AtPercentage");
            AddControlInWinForm("Use Power Word: Shield", "UsePowerWordShield", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Psychic Horror", "UsePsychicHorror", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Psychic Scream", "UsePsychicScream", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Psyfiend", "UsePsyfiend", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Silence", "UseSilence", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Spectral Guise", "UseSpectralGuise", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Void Tendrils", "UseVoidTendrils", "Defensive Cooldown", "AtPercentage");
            /* Healing Spell */
            AddControlInWinForm("Use Desperate Prayer", "UseDesperatePrayer", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Flash Heal for Regeneration after combat", "UseFlashHealNonCombat", "Healing Spell",
                "AtPercentage");
            AddControlInWinForm("Use Flash Heal during combat", "UseFlashHealInCombat", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Hymn of Hope", "UseHymnofHope", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Prayer of Mending", "UsePrayerofMending", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Renew", "UseRenew", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Vampiric Embrace", "UseVampiricEmbrace", "Healing Spell", "AtPercentage");
            /* Game Settings */
            AddControlInWinForm("Use Low Combat Settings", "UseLowCombat", "Game Settings");
            AddControlInWinForm("Use Trinket One", "UseTrinketOne", "Game Settings");
            AddControlInWinForm("Use Trinket Two", "UseTrinketTwo", "Game Settings");

            AddControlInWinForm("Use Alchemist Flask", "UseAlchFlask", "Game Settings");
            AddControlInWinForm("Do avoid melee (Off Advised!!)", "DoAvoidMelee", "Game Settings");
            AddControlInWinForm("Avoid melee distance (1 to 4)", "DoAvoidMeleeDistance", "Game Settings");
        }

        public static PriestShadowSettings CurrentSetting { get; set; }

        public static PriestShadowSettings GetSettings()
        {
            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Priest_Shadow.xml";
            if (File.Exists(currentSettingsFile))
            {
                return
                    CurrentSetting = Load<PriestShadowSettings>(currentSettingsFile);
            }
            return new PriestShadowSettings();
        }
    }

    #endregion
}

public class PriestDiscipline
{
    private static PriestDisciplineSettings MySettings = PriestDisciplineSettings.GetSettings();

    #region General Timers & Variables

    private readonly WoWItem _firstTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET);
    private readonly WoWItem _secondTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET, 2);

    private Timer _onCd = new Timer(0);

    #endregion

    #region Professions and Racials

    public readonly Spell Alchemy = new Spell("Alchemy");
    public readonly Spell ArcaneTorrent = new Spell("Arcane Torrent");
    public readonly Spell Berserking = new Spell("Berserking");
    public readonly Spell BloodFury = new Spell("Blood Fury");

    public readonly Spell GiftoftheNaaru = new Spell("Gift of the Naaru");

    public readonly Spell Stoneform = new Spell("Stoneform");
    public readonly Spell WarStomp = new Spell("War Stomp");

    #endregion

    #region Priest Buffs

    public readonly Spell InnerFire = new Spell("Inner Fire");
    public readonly Spell InnerWill = new Spell("Inner Will");
    public readonly Spell Levitate = new Spell("Levitate");
    public readonly Spell PowerWordFortitude = new Spell("Power Word: Fortitude");
    private Timer _levitateTimer = new Timer(0);

    #endregion

    #region Offensive Spell

    public readonly Spell Cascade = new Spell("Cascade");
    public readonly Spell DivineStar = new Spell("Divine Star");
    public readonly Spell Halo = new Spell("Halo");
    public readonly Spell MindSear = new Spell("Mind Sear");
    public readonly Spell PowerWordSolace = new Spell("Power Word: Solace");
    public readonly Spell ShadowWordDeath = new Spell("Shadow Word: Death");
    public readonly Spell ShadowWordPain = new Spell("Shadow Word: Pain");
    public readonly Spell Smite = new Spell("Smite");
    private Timer _shadowWordPainTimer = new Timer(0);

    #endregion

    #region Healing Cooldown

    public readonly Spell Archangel = new Spell("Archangel");
    public readonly Spell InnerFocus = new Spell("Inner Focus");
    public readonly Spell PowerInfusion = new Spell("Power Infusion");
    public readonly Spell Shadowfiend = new Spell("Shadowfiend");

    #endregion

    #region Defensive Cooldown

    public readonly Spell PainSuppression = new Spell("Pain Suppression");
    public readonly Spell PowerWordBarrier = new Spell("Power Word: Barrier");
    public readonly Spell PowerWordShield = new Spell("Power Word: Shield");
    public readonly Spell PsychicScream = new Spell("Psychic Scream");
    public readonly Spell Psyfiend = new Spell("Psyfiend");
    public readonly Spell SpectralGuise = new Spell("Spectral Guise");
    public readonly Spell VoidTendrils = new Spell("Void Tendrils");

    #endregion

    #region Healing Spell

    public readonly Spell DesperatePrayer = new Spell("Desperate Prayer");
    public readonly Spell FlashHeal = new Spell("Flash Heal");
    public readonly Spell GreaterHeal = new Spell("Greater Heal");
    public readonly Spell HealSpell = new Spell("Heal");
    public readonly Spell HolyFire = new Spell("Holy Fire");
    public readonly Spell HymnofHope = new Spell("Hymn of Hope");
    public readonly Spell Penance = new Spell("Penance");
    public readonly Spell PrayerofHealing = new Spell("Prayer of Healing");
    public readonly Spell PrayerofMending = new Spell("Prayer of Mending");
    public readonly Spell Renew = new Spell("Renew");
    public readonly Spell SpiritShell = new Spell("Spirit Shell");
/*
        private Timer _renewTimer = new Timer(0);
*/

    #endregion

    public PriestDiscipline()
    {
        Main.InternalRange = 30.0f;
        Main.InternalAggroRange = 30f;
        MySettings = PriestDisciplineSettings.GetSettings();
        Main.DumpCurrentSettings<PriestDisciplineSettings>(MySettings);
        UInt128 lastTarget = 0;

        while (Main.InternalLoop)
        {
            try
            {
                if (!ObjectManager.Me.IsDead)
                {
                    if (!ObjectManager.Me.IsMounted)
                    {
                        BuffLevitate();
                        if (Fight.InFight && ObjectManager.Me.Target > 0)
                        {
                            if (ObjectManager.Me.Target != lastTarget &&
                                (HolyFire.IsHostileDistanceGood || ShadowWordPain.IsHostileDistanceGood))
                            {
                                Pull();
                                lastTarget = ObjectManager.Me.Target;
                            }
                            else
                            {
                                if (ObjectManager.Target.GetDistance <= 40f)
                                    Combat();
                            }
                        }
                        if (!ObjectManager.Me.IsCast)
                            Patrolling();
                    }
                }
                else
                    Thread.Sleep(500);
            }
            catch
            {
            }
            Thread.Sleep(100);
        }
    }

    private void BuffLevitate()
    {
        if (!ObjectManager.Me.InCombat && Levitate.KnownSpell && Levitate.IsSpellUsable && MySettings.UseLevitate
            && (!Levitate.HaveBuff || _levitateTimer.IsReady))
        {
            Levitate.Cast();
            _levitateTimer = new Timer(1000*60*9);
        }
    }

    private void Pull()
    {
        if (HolyFire.IsSpellUsable && HolyFire.KnownSpell && HolyFire.IsHostileDistanceGood
            && MySettings.UseHolyFire)
        {
            HolyFire.Cast();
            return;
        }
        if (ShadowWordPain.IsSpellUsable && ShadowWordPain.KnownSpell && ShadowWordPain.IsHostileDistanceGood
            && MySettings.UseShadowWordPain)
        {
            ShadowWordPain.Cast();
            _shadowWordPainTimer = new Timer(1000*14);
        }
    }

    private void Combat()
    {
        Buff();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        if (_onCd.IsReady)
            DefenseCycle();
        DPSCycle();
        Heal();
        Decast();
        DPSCycle();
        HealingBurst();
        DPSCycle();
    }

    private void Buff()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (PowerWordFortitude.KnownSpell && PowerWordFortitude.IsSpellUsable &&
            !PowerWordFortitude.HaveBuff && MySettings.UsePowerWordFortitude)
        {
            PowerWordFortitude.Cast();
            return;
        }
        if (InnerFire.KnownSpell && InnerFire.IsSpellUsable && !InnerFire.HaveBuff
            && MySettings.UseInnerFire)
        {
            InnerFire.Cast();
            return;
        }
        if (InnerWill.KnownSpell && InnerWill.IsSpellUsable && !InnerWill.HaveBuff
            && !MySettings.UseInnerFire && MySettings.UseInnerWill)
        {
            InnerWill.Cast();
            return;
        }
        if (MySettings.UseAlchFlask && !ObjectManager.Me.HaveBuff(79638) && !ObjectManager.Me.HaveBuff(79640) && !ObjectManager.Me.HaveBuff(79639)
            && !ItemsManager.IsItemOnCooldown(75525) && ItemsManager.GetItemCount(75525) > 0)
        {
            ItemsManager.UseItem(75525);
        }
    }

    private void AvoidMelee()
    {
        if (ObjectManager.Target.GetDistance < MySettings.DoAvoidMeleeDistance && ObjectManager.Target.InCombat)
        {
            Logging.WriteFight("Too Close. Moving Back");
            var maxTimeTimer = new Timer(1000*2);
            MovementsAction.MoveBackward(true);
            while (ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat && !maxTimeTimer.IsReady)
                Others.SafeSleep(300);
            MovementsAction.MoveBackward(false);
            if (maxTimeTimer.IsReady && ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat)
            {
                MovementsAction.MoveForward(true);
                Others.SafeSleep(1000);
                MovementsAction.MoveForward(false);
                MovementManager.Face(ObjectManager.Target.Position);
            }
        }
    }

    private void DefenseCycle()
    {
        if (ObjectManager.Me.HealthPercent <= MySettings.UsePsychicScreamAtPercentage && PsychicScream.IsSpellUsable &&
            PsychicScream.KnownSpell
            && MySettings.UsePsychicScream)
        {
            PsychicScream.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (ObjectManager.GetNumberAttackPlayer() >= 2 &&
            ObjectManager.Me.HealthPercent <= MySettings.UseVoidTendrilsAtPercentage &&
            VoidTendrils.IsSpellUsable && VoidTendrils.KnownSpell && MySettings.UseVoidTendrils)
        {
            VoidTendrils.Cast();
            _onCd = new Timer(1000*10);
            return;
        }
        if (ObjectManager.GetNumberAttackPlayer() >= 2 &&
            ObjectManager.Me.HealthPercent <= MySettings.UsePsyfiendAtPercentage &&
            Psyfiend.IsSpellUsable && Psyfiend.KnownSpell && MySettings.UsePsyfiend)
        {
            Psyfiend.Cast();
            _onCd = new Timer(1000*10);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseSpectralGuiseAtPercentage &&
            SpectralGuise.IsSpellUsable && SpectralGuise.KnownSpell
            && MySettings.UseSpectralGuise)
        {
            if (Renew.KnownSpell && Renew.IsSpellUsable && MySettings.UseRenew)
            {
                Renew.Cast();
                Others.SafeSleep(1500);
            }
            SpectralGuise.Cast();
            _onCd = new Timer(1000*3);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UsePowerWordBarrierAtPercentage &&
            PowerWordBarrier.IsSpellUsable && PowerWordBarrier.KnownSpell
            && MySettings.UsePowerWordBarrier)
        {
            SpellManager.CastSpellByIDAndPosition(62618, ObjectManager.Me.Position);
            _onCd = new Timer(1000*10);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UsePainSuppressionAtPercentage &&
            PainSuppression.IsSpellUsable && PainSuppression.KnownSpell
            && MySettings.UsePainSuppression)
        {
            PainSuppression.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseStoneformAtPercentage &&
            Stoneform.IsSpellUsable && Stoneform.KnownSpell
            && MySettings.UseStoneform)
        {
            Stoneform.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseWarStompAtPercentage &&
            WarStomp.IsSpellUsable && WarStomp.KnownSpell
            && MySettings.UseWarStomp)
        {
            WarStomp.Cast();
            _onCd = new Timer(1000*2);
        }
    }

    private void Heal()
    {
        if (MySettings.UseArcaneTorrentForResource && ArcaneTorrent.KnownSpell && ArcaneTorrent.IsSpellUsable
            && ObjectManager.Me.ManaPercentage <= MySettings.UseArcaneTorrentForResourceAtPercentage)
        {
            ArcaneTorrent.Cast();
            return;
        }

        if (ObjectManager.Me.HealthPercent <= MySettings.UseFlashHealNonCombatAtPercentage &&
            !ObjectManager.Me.InCombat
            && FlashHeal.KnownSpell && FlashHeal.IsSpellUsable && MySettings.UseFlashHealNonCombat)
        {
            FlashHeal.Cast(false);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseInnerFocusAtPercentage && InnerFocus.KnownSpell &&
            InnerFocus.IsSpellUsable
            && MySettings.UseInnerFocus && !InnerFocus.HaveBuff)
        {
            InnerFocus.Cast();
            return;
        }
        if (ObjectManager.Me.ManaPercentage <= MySettings.UseHymnofHopeAtPercentage &&
            HymnofHope.KnownSpell
            && HymnofHope.IsSpellUsable && !ObjectManager.Me.InCombat &&
            MySettings.UseHymnofHope)
        {
            HymnofHope.Cast(false);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseDesperatePrayerAtPercentage &&
            DesperatePrayer.KnownSpell && DesperatePrayer.IsSpellUsable
            && MySettings.UseDesperatePrayer)
        {
            DesperatePrayer.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseFlashHealInCombatAtPercentage &&
            FlashHeal.KnownSpell && FlashHeal.IsSpellUsable
            && MySettings.UseFlashHealInCombat)
        {
            FlashHeal.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseGreaterHealAtPercentage &&
            GreaterHeal.KnownSpell && GreaterHeal.IsSpellUsable
            && MySettings.UseGreaterHeal)
        {
            GreaterHeal.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseGiftoftheNaaruAtPercentage &&
            GiftoftheNaaru.IsSpellUsable && GiftoftheNaaru.KnownSpell
            && MySettings.UseGiftoftheNaaru)
        {
            GiftoftheNaaru.Cast();
            return;
        }
        if (PowerWordShield.KnownSpell && PowerWordShield.IsSpellUsable
            && !PowerWordShield.HaveBuff && MySettings.UsePowerWordShield
            && !ObjectManager.Me.HaveBuff(6788) &&
            ObjectManager.Me.HealthPercent <= MySettings.UsePowerWordShieldAtPercentage
            && (ObjectManager.Me.InCombat || ObjectManager.Me.GetMove))
        {
            PowerWordShield.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UsePrayerofHealingAtPercentage &&
            PrayerofHealing.KnownSpell && PrayerofHealing.IsSpellUsable
            && MySettings.UsePrayerofHealing)
        {
            PrayerofHealing.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UsePrayerofMendingAtPercentage &&
            PrayerofMending.KnownSpell && PrayerofMending.IsSpellUsable
            && MySettings.UsePrayerofMending)
        {
            PrayerofMending.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseHealAtPercentage &&
            HealSpell.KnownSpell && HealSpell.IsSpellUsable
            && (MySettings.UseHeal || !GreaterHeal.KnownSpell))
        {
            HealSpell.Cast();
            return;
        }
        if (Renew.KnownSpell && Renew.IsSpellUsable && !Renew.HaveBuff &&
            ObjectManager.Me.HealthPercent <= MySettings.UseRenewAtPercentage &&
            MySettings.UseRenew)
        {
            Renew.Cast();
        }
    }

    private void Decast()
    {
        if (MySettings.UseArcaneTorrentForDecast && ArcaneTorrent.KnownSpell && ObjectManager.Target.GetDistance < 8 && ArcaneTorrent.IsSpellUsable
            && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe
            && ObjectManager.Me.HealthPercent <= MySettings.UseArcaneTorrentForDecastAtPercentage)
        {
            ArcaneTorrent.Cast();
        }
    }

    private void HealingBurst()
    {
        if (MySettings.UseTrinketOne && !ItemsManager.IsItemOnCooldown(_firstTrinket.Entry) && ItemsManager.IsItemUsable(_firstTrinket.Entry))
        {
            ItemsManager.UseItem(_firstTrinket.Name);
            Logging.WriteFight("Use First Trinket Slot");
        }

        if (MySettings.UseTrinketTwo && !ItemsManager.IsItemOnCooldown(_secondTrinket.Entry) && ItemsManager.IsItemUsable(_secondTrinket.Entry))
        {
            ItemsManager.UseItem(_secondTrinket.Name);
            Logging.WriteFight("Use Second Trinket Slot");
            return;
        }
        if (Berserking.IsSpellUsable && Berserking.KnownSpell && ObjectManager.Target.GetDistance <= 40f
            && MySettings.UseBerserking)
        {
            Berserking.Cast();
            return;
        }
        if (BloodFury.IsSpellUsable && BloodFury.KnownSpell && ObjectManager.Target.GetDistance <= 40f
            && MySettings.UseBloodFury)
        {
            BloodFury.Cast();
            return;
        }
        if (PowerInfusion.IsSpellUsable && PowerInfusion.KnownSpell
            && MySettings.UsePowerInfusion && ObjectManager.Target.GetDistance <= 40f)
        {
            PowerInfusion.Cast();
            return;
        }
        if (Archangel.IsSpellUsable && Archangel.KnownSpell && ObjectManager.Me.BuffStack(81661) > 4
            && MySettings.UseArchangel && ObjectManager.Target.GetDistance <= 40f)
        {
            Archangel.Cast();
            return;
        }
        if (SpiritShell.IsSpellUsable && SpiritShell.KnownSpell && ObjectManager.Me.HealthPercent > 80
            && MySettings.UseSpiritShell && ObjectManager.Target.InCombat)
        {
            SpiritShell.Cast();
            return;
        }
        if (Shadowfiend.IsSpellUsable && Shadowfiend.KnownSpell && Shadowfiend.IsHostileDistanceGood
            && MySettings.UseShadowfiend)
        {
            Shadowfiend.Cast();
        }
    }

    private void DPSCycle()
    {
        Usefuls.SleepGlobalCooldown();
        try
        {
            Memory.WowMemory.GameFrameLock(); // !!! WARNING - DONT SLEEP WHILE LOCKED - DO FINALLY(GameFrameUnLock()) !!!

            if (ObjectManager.Me.ManaPercentage <= MySettings.UseArcaneTorrentForResourceAtPercentage && ArcaneTorrent.KnownSpell && ArcaneTorrent.IsSpellUsable
                && MySettings.UseArcaneTorrentForResource)
            {
                ArcaneTorrent.Cast();
                return;
            }
            if (ObjectManager.GetNumberAttackPlayer() > 2 && Cascade.IsSpellUsable && Cascade.KnownSpell
                && Cascade.IsHostileDistanceGood && MySettings.UseCascade)
            {
                Cascade.Cast();
                return;
            }
            if (ObjectManager.GetNumberAttackPlayer() > 2 && DivineStar.IsSpellUsable && DivineStar.KnownSpell
                && DivineStar.IsHostileDistanceGood && MySettings.UseDivineStar)
            {
                DivineStar.Cast();
                return;
            }
            if (ObjectManager.GetNumberAttackPlayer() > 2 && Halo.IsSpellUsable && Halo.KnownSpell
                && Halo.IsHostileDistanceGood && MySettings.UseHalo)
            {
                Halo.Cast();
                return;
            }
            if (ObjectManager.GetNumberAttackPlayer() > 4 && MindSear.IsSpellUsable && MindSear.KnownSpell
                && MindSear.IsHostileDistanceGood && !ObjectManager.Me.IsCast && MySettings.UseMindSear)
            {
                MindSear.Cast();
                return;
            }
            if (ShadowWordDeath.IsSpellUsable && ShadowWordDeath.IsHostileDistanceGood && ShadowWordDeath.KnownSpell
                && ObjectManager.Target.HealthPercent < 20 && MySettings.UseShadowWordDeath)
            {
                ShadowWordDeath.Cast();
                return;
            }
            if (ShadowWordPain.KnownSpell && ShadowWordPain.IsSpellUsable
                && ShadowWordPain.IsHostileDistanceGood && MySettings.UseShadowWordPain
                && (!ShadowWordPain.TargetHaveBuff || _shadowWordPainTimer.IsReady))
            {
                ShadowWordPain.Cast();
                _shadowWordPainTimer = new Timer(1000*14);
                return;
            }
            if (PowerWordSolace.KnownSpell && PowerWordSolace.IsHostileDistanceGood
                && PowerWordSolace.IsSpellUsable && MySettings.UsePowerWordSolace
                && ObjectManager.Me.ManaPercentage < 50)
            {
                PowerWordSolace.Cast();
                return;
            }
            if (Penance.IsSpellUsable && Penance.IsHostileDistanceGood && Penance.KnownSpell
                && MySettings.UsePenance)
            {
                Penance.Cast();
                return;
            }
            if (HolyFire.IsSpellUsable && HolyFire.IsHostileDistanceGood && HolyFire.KnownSpell
                && MySettings.UseHolyFire)
            {
                HolyFire.Cast();
                return;
            }
            if (Smite.IsSpellUsable && Smite.KnownSpell && Smite.IsHostileDistanceGood
                && MySettings.UseSmite && ShadowWordPain.TargetHaveBuff
                && ObjectManager.GetNumberAttackPlayer() < 5)
            {
                Smite.Cast();
            }
        }
        finally
        {
            Memory.WowMemory.GameFrameUnLock();
        }
    }

    private void Patrolling()
    {
        if (ObjectManager.Me.IsMounted) return;
        Buff();
        Heal();
    }

    #region Nested type: PriestDisciplineSettings

    [Serializable]
    public class PriestDisciplineSettings : Settings
    {
        public bool DoAvoidMelee = false;
        public int DoAvoidMeleeDistance = 0;
        public bool UseAlchFlask = true;
        public bool UseArcaneTorrentForDecast = true;
        public int UseArcaneTorrentForDecastAtPercentage = 100;
        public bool UseArcaneTorrentForResource = true;
        public int UseArcaneTorrentForResourceAtPercentage = 80;
        public bool UseArchangel = true;
        public bool UseBerserking = true;
        public bool UseBloodFury = true;
        public bool UseCascade = true;
        public bool UseDesperatePrayer = true;
        public int UseDesperatePrayerAtPercentage = 65;
        public bool UseDivineStar = true;

        public bool UseFlashHealInCombat = true;
        public int UseFlashHealInCombatAtPercentage = 60;
        public bool UseFlashHealNonCombat = true;
        public int UseFlashHealNonCombatAtPercentage = 95;
        public bool UseGiftoftheNaaru = true;
        public int UseGiftoftheNaaruAtPercentage = 80;
        public bool UseGreaterHeal = true;
        public int UseGreaterHealAtPercentage = 70;
        public bool UseHalo = true;
        public bool UseHeal = true;
        public int UseHealAtPercentage = 70;
        public bool UseHolyFire = true;
        public bool UseHymnofHope = true;
        public int UseHymnofHopeAtPercentage = 40;
        public bool UseInnerFire = true;
        public bool UseInnerFocus = true;
        public int UseInnerFocusAtPercentage = 90;
        public bool UseInnerWill = false;
        public bool UseLevitate = false;

        public bool UseMindSear = true;
        public bool UsePainSuppression = true;
        public int UsePainSuppressionAtPercentage = 70;
        public bool UsePenance = true;
        public bool UsePowerInfusion = true;
        public bool UsePowerWordBarrier = true;
        public int UsePowerWordBarrierAtPercentage = 60;
        public bool UsePowerWordFortitude = true;
        public bool UsePowerWordShield = true;
        public int UsePowerWordShieldAtPercentage = 100;
        public bool UsePowerWordSolace = true;
        public bool UsePrayerofHealing = false;
        public int UsePrayerofHealingAtPercentage = 50;
        public bool UsePrayerofMending = true;
        public int UsePrayerofMendingAtPercentage = 50;
        public bool UsePsychicScream = true;
        public int UsePsychicScreamAtPercentage = 20;
        public bool UsePsyfiend = true;
        public int UsePsyfiendAtPercentage = 35;
        public bool UseRenew = true;
        public int UseRenewAtPercentage = 90;
        public bool UseShadowWordDeath = true;
        public bool UseShadowWordPain = true;
        public bool UseShadowfiend = true;
        public bool UseSmite = true;
        public bool UseSpectralGuise = true;
        public int UseSpectralGuiseAtPercentage = 70;
        public bool UseSpiritShell = true;
        public bool UseStoneform = true;
        public int UseStoneformAtPercentage = 80;
        public bool UseTrinketOne = true;
        public bool UseTrinketTwo = true;
        public bool UseVoidTendrils = true;
        public int UseVoidTendrilsAtPercentage = 35;
        public bool UseWarStomp = true;
        public int UseWarStompAtPercentage = 80;

        public PriestDisciplineSettings()
        {
            ConfigWinForm("Discipline Priest Settings");
            /* Professions and Racials */
            AddControlInWinForm("Use Arcane Torrent for Interrupt", "UseArcaneTorrentForDecast", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Arcane Torrent for Resource", "UseArcaneTorrentForResource", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Berserking", "UseBerserking", "Professions and Racials");
            AddControlInWinForm("Use Blood Fury", "UseBloodFury", "Professions and Racials");
            AddControlInWinForm("Use Gift of the Naaru", "UseGiftoftheNaaru", "Professions and Racials", "AtPercentage");
            AddControlInWinForm("Use Lifeblood", "UseLifeblood", "Professions and Racials");
            AddControlInWinForm("Use Stoneform", "UseStoneform", "Professions and Racials", "AtPercentage");
            AddControlInWinForm("Use War Stomp", "UseWarStomp", "Professions and Racials", "AtPercentage");
            /* Priest Buffs */
            AddControlInWinForm("Use Inner Fire", "UseInnerFire", "Priest Buffs");
            AddControlInWinForm("Use Inner Will", "UseInnerWill", "Priest Buffs");
            AddControlInWinForm("Use Levitate", "UseLevitate", "Priest Buffs");
            AddControlInWinForm("Use Power Word: Fortitude", "UsePowerWordFortitude", "Priest Buffs");
            /* Offensive Spell */
            AddControlInWinForm("Use Cascade", "UseCascade", "Offensive Spell");
            AddControlInWinForm("Use Divine Star", "Use Divine Star", "Offensive Spell");
            AddControlInWinForm("Use Halo", "UseHalo", "Offensive Spell");
            AddControlInWinForm("Use Holy Fire", "UseHolyFire", "Offensive Spell");
            AddControlInWinForm("Use Mind Sear", "UseMindSear", "Offensive Spell");
            AddControlInWinForm("Use Penance", "UsePenance", "Offensive Spell");
            AddControlInWinForm("Use Shadow Word: Death", "UseShadowWordDeath", "Offensive Spell");
            AddControlInWinForm("Use Shadow Word: Pain", "UseShadowWordPain", "Offensive Spell");
            AddControlInWinForm("Use Smite", "UseSmite", "Offensive Spell");
            /* Healing Cooldown */
            AddControlInWinForm("Use Archangel", "UseArchangel", "Healing Cooldown");
            AddControlInWinForm("Use Power Infusion", "UsePowerInfusion", "Healing Cooldown");
            AddControlInWinForm("Use Shadowfiend", "UseShadowfiend", "Healing Cooldown");
            AddControlInWinForm("Use Spirit Shell", "UseSpiritShell", "Healing Cooldown");
            /* Defensive Cooldown */
            AddControlInWinForm("Use Pain Suppression", "UsePainSuppression", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Power Word: Barrier", "UsePowerWordBarrier", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Power Word: Shield", "UsePowerWordShield", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Psychic Scream", "UsePsychicScream", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Psyfiend", "UsePsyfiend", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Spectral Guise", "UseSpectralGuise", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Void Tendrils", "UseVoidTendrils", "Defensive Cooldown", "AtPercentage");
            /* Healing Spell */
            AddControlInWinForm("Use Desperate Prayer", "UseDesperatePrayer", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Flash Heal for Regeneration after combat", "UseFlashHealNonCombat", "Healing Spell",
                "AtPercentage");
            AddControlInWinForm("Use Flash Heal during combat", "UseFlashHealInCombat", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Greater Heal", "UseGreaterHeal", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Heal", "UseHeal", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Hymn of Hope", "UseHymnofHope", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Inner Focus", "UseInnerFocus", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Prayer of Mending", "UsePrayerofMending", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Renew", "UseRenew", "Healing Spell", "AtPercentage");
            /* Game Settings */
            AddControlInWinForm("Use Trinket One", "UseTrinketOne", "Game Settings");
            AddControlInWinForm("Use Trinket Two", "UseTrinketTwo", "Game Settings");

            AddControlInWinForm("Use Alchemist Flask", "UseAlchFlask", "Game Settings");
            AddControlInWinForm("Do avoid melee (Off Advised!!)", "DoAvoidMelee", "Game Settings");
            AddControlInWinForm("Avoid melee distance (1 to 4)", "DoAvoidMeleeDistance", "Game Settings");
        }

        public static PriestDisciplineSettings CurrentSetting { get; set; }

        public static PriestDisciplineSettings GetSettings()
        {
            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Priest_Discipline.xml";
            if (File.Exists(currentSettingsFile))
            {
                return
                    CurrentSetting = Load<PriestDisciplineSettings>(currentSettingsFile);
            }
            return new PriestDisciplineSettings();
        }
    }

    #endregion
}

public class PriestHoly
{
    private static PriestHolySettings MySettings = PriestHolySettings.GetSettings();

    #region General Timers & Variables

    private readonly WoWItem _firstTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET);
    private readonly WoWItem _secondTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET, 2);

    private Timer _onCd = new Timer(0);

    #endregion

    #region Professions and Racials

    public readonly Spell Alchemy = new Spell("Alchemy");
    public readonly Spell ArcaneTorrent = new Spell("Arcane Torrent");
    public readonly Spell Berserking = new Spell("Berserking");
    public readonly Spell BloodFury = new Spell("Blood Fury");

    public readonly Spell GiftoftheNaaru = new Spell("Gift of the Naaru");

    public readonly Spell Stoneform = new Spell("Stoneform");
    public readonly Spell WarStomp = new Spell("War Stomp");

    #endregion

    #region Priest Buffs

    public readonly Spell ChakraChastise = new Spell("Chakra: Chastise");
    public readonly Spell ChakraSanctuary = new Spell("Chakra: Sanctuary");
    public readonly Spell ChakraSerenity = new Spell("Chakra: Serenity");
    public readonly Spell InnerFire = new Spell("Inner Fire");
    public readonly Spell InnerWill = new Spell("Inner Will");
    public readonly Spell Levitate = new Spell("Levitate");
    public readonly Spell PowerWordFortitude = new Spell("Power Word: Fortitude");
    private Timer _levitateTimer = new Timer(0);

    #endregion

    #region Offensive Spell

    public readonly Spell Cascade = new Spell("Cascade");
    public readonly Spell DivineStar = new Spell("Divine Star");
    public readonly Spell Halo = new Spell("Halo");
    public readonly Spell HolyWordChastise = new Spell("Holy Word: Chastise");
    public readonly Spell MindSear = new Spell("Mind Sear");
    public readonly Spell PowerWordSolace = new Spell("Power Word: Solace");
    public readonly Spell ShadowWordDeath = new Spell("Shadow Word: Death");
    public readonly Spell ShadowWordPain = new Spell("Shadow Word: Pain");
    public readonly Spell Smite = new Spell("Smite");
    private Timer _shadowWordPainTimer = new Timer(0);

    #endregion

    #region Healing Cooldown

    public readonly Spell DivineHymn = new Spell("Divine Hymn");
    public readonly Spell LightWell = new Spell("Light Well");
    public readonly Spell PowerInfusion = new Spell("Power Infusion");
    public readonly Spell Shadowfiend = new Spell("Shadowfiend");

    #endregion

    #region Defensive Cooldown

    public readonly Spell GuardianSpirit = new Spell("Guardian Spirit");
    public readonly Spell PowerWordShield = new Spell("Power Word: Shield");
    public readonly Spell PsychicScream = new Spell("Psychic Scream");
    public readonly Spell Psyfiend = new Spell("Psyfiend");
    public readonly Spell SpectralGuise = new Spell("Spectral Guise");
    public readonly Spell VoidTendrils = new Spell("Void Tendrils");

    #endregion

    #region Healing Spell

    public readonly Spell CircleofHealing = new Spell("Circle of Healing");
    public readonly Spell DesperatePrayer = new Spell("Desperate Prayer");
    public readonly Spell FlashHeal = new Spell("Flash Heal");
    public readonly Spell GreaterHeal = new Spell("Greater Heal");
    public readonly Spell HealSpell = new Spell("Heal");
    public readonly Spell HolyFire = new Spell("Holy Fire");
    public readonly Spell HymnofHope = new Spell("Hymn of Hope");
    public readonly Spell PrayerofHealing = new Spell("Prayer of Healing");
    public readonly Spell PrayerofMending = new Spell("Prayer of Mending");
    public readonly Spell Renew = new Spell("Renew");
/*
        private Timer _renewTimer = new Timer(0);
*/

    #endregion

    public PriestHoly()
    {
        Main.InternalRange = 30.0f;
        Main.InternalAggroRange = 30.0f;
        MySettings = PriestHolySettings.GetSettings();
        Main.DumpCurrentSettings<PriestHolySettings>(MySettings);
        UInt128 lastTarget = 0;

        while (Main.InternalLoop)
        {
            try
            {
                if (!ObjectManager.Me.IsDead)
                {
                    if (!ObjectManager.Me.IsMounted)
                    {
                        BuffLevitate();
                        if (Fight.InFight && ObjectManager.Me.Target > 0)
                        {
                            if (ObjectManager.Me.Target != lastTarget &&
                                (HolyFire.IsHostileDistanceGood || ShadowWordPain.IsHostileDistanceGood))
                            {
                                Pull();
                                lastTarget = ObjectManager.Me.Target;
                            }
                            else
                            {
                                if (ObjectManager.Target.GetDistance <= 40f)
                                    Combat();
                            }
                        }
                        if (!ObjectManager.Me.IsCast)
                            Patrolling();
                    }
                }
                else
                    Thread.Sleep(500);
            }
            catch
            {
            }
            Thread.Sleep(100);
        }
    }

    private void BuffLevitate()
    {
        if (!ObjectManager.Me.InCombat && Levitate.KnownSpell && Levitate.IsSpellUsable && MySettings.UseLevitate
            && (!Levitate.HaveBuff || _levitateTimer.IsReady))
        {
            Levitate.Cast();
            _levitateTimer = new Timer(1000*60*9);
        }
    }

    private void Pull()
    {
        if (HolyFire.IsSpellUsable && HolyFire.KnownSpell && HolyFire.IsHostileDistanceGood
            && MySettings.UseHolyFire)
        {
            HolyFire.Cast();
            return;
        }
        if (ShadowWordPain.IsSpellUsable && ShadowWordPain.KnownSpell && ShadowWordPain.IsHostileDistanceGood
            && MySettings.UseShadowWordPain)
        {
            ShadowWordPain.Cast();
            _shadowWordPainTimer = new Timer(1000*14);
        }
    }

    private void Combat()
    {
        Buff();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        if (_onCd.IsReady)
            DefenseCycle();
        DPSCycle();
        Heal();
        Decast();
        DPSCycle();
        HealingBurst();
        DPSCycle();
    }

    private void Buff()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (PowerWordFortitude.KnownSpell && PowerWordFortitude.IsSpellUsable &&
            !PowerWordFortitude.HaveBuff && MySettings.UsePowerWordFortitude)
        {
            PowerWordFortitude.Cast();
            return;
        }
        if (InnerFire.KnownSpell && InnerFire.IsSpellUsable && !InnerFire.HaveBuff
            && MySettings.UseInnerFire)
        {
            InnerFire.Cast();
            return;
        }
        if (InnerWill.KnownSpell && InnerWill.IsSpellUsable && !InnerWill.HaveBuff
            && !MySettings.UseInnerFire && MySettings.UseInnerWill)
        {
            InnerWill.Cast();
            return;
        }
        if (ChakraChastise.KnownSpell && ChakraChastise.IsSpellUsable && !ChakraChastise.HaveBuff
            && MySettings.UseChakraChastise)
        {
            ChakraChastise.Cast();
            return;
        }
        if (ChakraSanctuary.KnownSpell && ChakraSanctuary.IsSpellUsable && !ChakraSanctuary.HaveBuff
            && !MySettings.UseChakraChastise && MySettings.UseChakraSanctuary)
        {
            ChakraSanctuary.Cast();
            return;
        }
        if (ChakraSerenity.KnownSpell && ChakraSerenity.IsSpellUsable && !ChakraSerenity.HaveBuff
            && !MySettings.UseChakraChastise && !MySettings.UseChakraSanctuary && MySettings.UseChakraSerenity)
        {
            ChakraSerenity.Cast();
            return;
        }
        if (MySettings.UseAlchFlask && !ObjectManager.Me.HaveBuff(79638) && !ObjectManager.Me.HaveBuff(79640) && !ObjectManager.Me.HaveBuff(79639)
            && !ItemsManager.IsItemOnCooldown(75525) && ItemsManager.GetItemCount(75525) > 0)
        {
            ItemsManager.UseItem(75525);
        }
    }

    private void AvoidMelee()
    {
        if (ObjectManager.Target.GetDistance < MySettings.DoAvoidMeleeDistance && ObjectManager.Target.InCombat)
        {
            Logging.WriteFight("Too Close. Moving Back");
            var maxTimeTimer = new Timer(1000*2);
            MovementsAction.MoveBackward(true);
            while (ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat && !maxTimeTimer.IsReady)
                Others.SafeSleep(300);
            MovementsAction.MoveBackward(false);
            if (maxTimeTimer.IsReady && ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat)
            {
                MovementsAction.MoveForward(true);
                Others.SafeSleep(1000);
                MovementsAction.MoveForward(false);
                MovementManager.Face(ObjectManager.Target.Position);
            }
        }
    }

    private void DefenseCycle()
    {
        if (ObjectManager.Me.HealthPercent <= MySettings.UsePsychicScreamAtPercentage && PsychicScream.IsSpellUsable &&
            PsychicScream.KnownSpell
            && MySettings.UsePsychicScream)
        {
            PsychicScream.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseGuardianSpiritAtPercentage && GuardianSpirit.KnownSpell &&
            GuardianSpirit.IsSpellUsable
            && MySettings.UseGuardianSpirit)
        {
            GuardianSpirit.Cast();
            return;
        }
        if (ObjectManager.GetNumberAttackPlayer() >= 2 &&
            ObjectManager.Me.HealthPercent <= MySettings.UseVoidTendrilsAtPercentage &&
            VoidTendrils.IsSpellUsable && VoidTendrils.KnownSpell && MySettings.UseVoidTendrils)
        {
            VoidTendrils.Cast();
            _onCd = new Timer(1000*10);
            return;
        }
        if (ObjectManager.GetNumberAttackPlayer() >= 2 &&
            ObjectManager.Me.HealthPercent <= MySettings.UsePsyfiendAtPercentage &&
            Psyfiend.IsSpellUsable && Psyfiend.KnownSpell && MySettings.UsePsyfiend)
        {
            Psyfiend.Cast();
            _onCd = new Timer(1000*10);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseSpectralGuiseAtPercentage &&
            SpectralGuise.IsSpellUsable && SpectralGuise.KnownSpell
            && MySettings.UseSpectralGuise)
        {
            if (Renew.KnownSpell && Renew.IsSpellUsable && MySettings.UseRenew)
            {
                Renew.Cast();
                Others.SafeSleep(1500);
            }
            SpectralGuise.Cast();
            _onCd = new Timer(1000*3);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseStoneformAtPercentage &&
            Stoneform.IsSpellUsable && Stoneform.KnownSpell
            && MySettings.UseStoneform)
        {
            Stoneform.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseWarStompAtPercentage &&
            WarStomp.IsSpellUsable && WarStomp.KnownSpell
            && MySettings.UseWarStomp)
        {
            WarStomp.Cast();
            _onCd = new Timer(1000*2);
        }
    }

    private void Heal()
    {
        if (MySettings.UseArcaneTorrentForResource && ArcaneTorrent.KnownSpell && ArcaneTorrent.IsSpellUsable
            && ObjectManager.Me.ManaPercentage <= MySettings.UseArcaneTorrentForResourceAtPercentage)
        {
            ArcaneTorrent.Cast();
            return;
        }

        if (ObjectManager.Me.HealthPercent <= MySettings.UseFlashHealNonCombatAtPercentage &&
            !ObjectManager.Me.InCombat
            && FlashHeal.KnownSpell && FlashHeal.IsSpellUsable && MySettings.UseFlashHealNonCombat)
        {
            FlashHeal.Cast(false);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseDivineHymnAtPercentage && DivineHymn.KnownSpell &&
            DivineHymn.IsSpellUsable
            && MySettings.UseDivineHymn)
        {
            DivineHymn.Cast();
            return;
        }
        if (ObjectManager.Me.ManaPercentage <= MySettings.UseHymnofHopeAtPercentage &&
            HymnofHope.KnownSpell
            && HymnofHope.IsSpellUsable && !ObjectManager.Me.InCombat &&
            MySettings.UseHymnofHope)
        {
            HymnofHope.Cast(false);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseDesperatePrayerAtPercentage &&
            DesperatePrayer.KnownSpell && DesperatePrayer.IsSpellUsable
            && MySettings.UseDesperatePrayer)
        {
            DesperatePrayer.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseFlashHealInCombatAtPercentage &&
            FlashHeal.KnownSpell && FlashHeal.IsSpellUsable
            && MySettings.UseFlashHealInCombat)
        {
            FlashHeal.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseGreaterHealAtPercentage &&
            GreaterHeal.KnownSpell && GreaterHeal.IsSpellUsable
            && MySettings.UseGreaterHeal)
        {
            GreaterHeal.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseGiftoftheNaaruAtPercentage &&
            GiftoftheNaaru.IsSpellUsable && GiftoftheNaaru.KnownSpell
            && MySettings.UseGiftoftheNaaru)
        {
            GiftoftheNaaru.Cast();
            return;
        }
        if (PowerWordShield.KnownSpell && PowerWordShield.IsSpellUsable
            && !PowerWordShield.HaveBuff && MySettings.UsePowerWordShield
            && !ObjectManager.Me.HaveBuff(6788) &&
            ObjectManager.Me.HealthPercent <= MySettings.UsePowerWordShieldAtPercentage
            && (ObjectManager.Me.InCombat || ObjectManager.Me.GetMove))
        {
            PowerWordShield.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UsePrayerofHealingAtPercentage &&
            PrayerofHealing.KnownSpell && PrayerofHealing.IsSpellUsable
            && MySettings.UsePrayerofHealing)
        {
            PrayerofHealing.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseCircleofHealingAtPercentage &&
            CircleofHealing.KnownSpell && CircleofHealing.IsSpellUsable
            && MySettings.UseCircleofHealing)
        {
            SpellManager.CastSpellByIDAndPosition(34861, ObjectManager.Me.Position);
            return;
        }
        if (ObjectManager.Me.HealthPercent <=
            MySettings.UsePrayerofMendingAtPercentage &&
            PrayerofMending.KnownSpell && PrayerofMending.IsSpellUsable
            && MySettings.UsePrayerofMending)
        {
            PrayerofMending.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseHealAtPercentage &&
            HealSpell.KnownSpell && HealSpell.IsSpellUsable
            && (MySettings.UseHeal || !GreaterHeal.KnownSpell))
        {
            HealSpell.Cast();
            return;
        }
        if (LightWell.KnownSpell && LightWell.IsSpellUsable &&
            MySettings.UseGlyphofLightspring
            &&
            ObjectManager.Me.HealthPercent <=
            MySettings.UseLightWellAtPercentage && MySettings.UseLightWell)
        {
            SpellManager.CastSpellByIDAndPosition(724,
                ObjectManager.Target
                    .Position);
            return;
        }
        if (Renew.KnownSpell && Renew.IsSpellUsable && !Renew.HaveBuff &&
            ObjectManager.Me.HealthPercent <=
            MySettings.UseRenewAtPercentage && MySettings.UseRenew)
        {
            Renew.Cast();
        }
    }

    private void Decast()
    {
        if (MySettings.UseArcaneTorrentForDecast && ArcaneTorrent.KnownSpell && ObjectManager.Target.GetDistance < 8 && ArcaneTorrent.IsSpellUsable
            && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe
            && ObjectManager.Me.HealthPercent <= MySettings.UseArcaneTorrentForDecastAtPercentage)
        {
            ArcaneTorrent.Cast();
        }
    }

    private void HealingBurst()
    {
        if (MySettings.UseTrinketOne && !ItemsManager.IsItemOnCooldown(_firstTrinket.Entry) && ItemsManager.IsItemUsable(_firstTrinket.Entry))
        {
            ItemsManager.UseItem(_firstTrinket.Name);
            Logging.WriteFight("Use First Trinket Slot");
        }
        if (MySettings.UseTrinketTwo && !ItemsManager.IsItemOnCooldown(_secondTrinket.Entry) && ItemsManager.IsItemUsable(_secondTrinket.Entry))
        {
            ItemsManager.UseItem(_secondTrinket.Name);
            Logging.WriteFight("Use Second Trinket Slot");
            return;
        }
        if (Berserking.IsSpellUsable && Berserking.KnownSpell && ObjectManager.Target.GetDistance <= 40f
            && MySettings.UseBerserking)
        {
            Berserking.Cast();
            return;
        }
        if (BloodFury.IsSpellUsable && BloodFury.KnownSpell && ObjectManager.Target.GetDistance <= 40f
            && MySettings.UseBloodFury)
        {
            BloodFury.Cast();
            return;
        }
        if (PowerInfusion.IsSpellUsable && PowerInfusion.KnownSpell
            && MySettings.UsePowerInfusion && ObjectManager.Target.GetDistance <= 40f)
        {
            PowerInfusion.Cast();
            return;
        }
        if (Shadowfiend.IsSpellUsable && Shadowfiend.KnownSpell && Shadowfiend.IsHostileDistanceGood
            && MySettings.UseShadowfiend)
        {
            Shadowfiend.Cast();
        }
    }

    private void DPSCycle()
    {
        Usefuls.SleepGlobalCooldown();
        try
        {
            Memory.WowMemory.GameFrameLock(); // !!! WARNING - DONT SLEEP WHILE LOCKED - DO FINALLY(GameFrameUnLock()) !!!

            if (ObjectManager.Me.ManaPercentage <= MySettings.UseArcaneTorrentForResourceAtPercentage && ArcaneTorrent.KnownSpell && ArcaneTorrent.IsSpellUsable
                && MySettings.UseArcaneTorrentForResource)
            {
                ArcaneTorrent.Cast();
                return;
            }
            if (ObjectManager.GetNumberAttackPlayer() > 2 && Cascade.IsSpellUsable && Cascade.KnownSpell
                && Cascade.IsHostileDistanceGood && MySettings.UseCascade)
            {
                Cascade.Cast();
                return;
            }
            if (ObjectManager.GetNumberAttackPlayer() > 2 && DivineStar.IsSpellUsable && DivineStar.KnownSpell
                && DivineStar.IsHostileDistanceGood && MySettings.UseDivineStar)
            {
                DivineStar.Cast();
                return;
            }
            if (ObjectManager.GetNumberAttackPlayer() > 2 && Halo.IsSpellUsable && Halo.KnownSpell
                && Halo.IsHostileDistanceGood && MySettings.UseHalo)
            {
                Halo.Cast();
                return;
            }
            if (ObjectManager.GetNumberAttackPlayer() > 4 && MindSear.IsSpellUsable && MindSear.KnownSpell
                && MindSear.IsHostileDistanceGood && !ObjectManager.Me.IsCast && MySettings.UseMindSear)
            {
                MindSear.Cast();
                return;
            }
            if (ShadowWordDeath.IsSpellUsable && ShadowWordDeath.IsHostileDistanceGood && ShadowWordDeath.KnownSpell
                && ObjectManager.Target.HealthPercent < 20 && MySettings.UseShadowWordDeath)
            {
                ShadowWordDeath.Cast();
                return;
            }
            if (ShadowWordPain.KnownSpell && ShadowWordPain.IsSpellUsable
                && ShadowWordPain.IsHostileDistanceGood && MySettings.UseShadowWordPain
                && (!ShadowWordPain.TargetHaveBuff || _shadowWordPainTimer.IsReady))
            {
                ShadowWordPain.Cast();
                _shadowWordPainTimer = new Timer(1000*14);
                return;
            }
            if (PowerWordSolace.KnownSpell && PowerWordSolace.IsHostileDistanceGood
                && PowerWordSolace.IsSpellUsable && MySettings.UsePowerWordSolace
                && ObjectManager.Me.ManaPercentage < 50)
            {
                PowerWordSolace.Cast();
                return;
            }
            if (HolyWordChastise.IsSpellUsable && HolyWordChastise.IsHostileDistanceGood && HolyWordChastise.KnownSpell
                && MySettings.UseHolyWordChastise)
            {
                HolyWordChastise.Cast();
                return;
            }
            if (HolyFire.IsSpellUsable && HolyFire.IsHostileDistanceGood && HolyFire.KnownSpell
                && MySettings.UseHolyFire)
            {
                HolyFire.Cast();
                return;
            }
            if (Smite.IsSpellUsable && Smite.KnownSpell && Smite.IsHostileDistanceGood
                && MySettings.UseSmite && ShadowWordPain.TargetHaveBuff
                && ObjectManager.GetNumberAttackPlayer() < 5)
            {
                Smite.Cast();
            }
        }
        finally
        {
            Memory.WowMemory.GameFrameUnLock();
        }
    }

    private void Patrolling()
    {
        if (ObjectManager.Me.IsMounted) return;
        Buff();
        Heal();
    }

    #region Nested type: PriestHolySettings

    [Serializable]
    public class PriestHolySettings : Settings
    {
        public bool DoAvoidMelee = false;
        public int DoAvoidMeleeDistance = 0;
        public bool UseAlchFlask = true;
        public bool UseArcaneTorrentForDecast = true;
        public int UseArcaneTorrentForDecastAtPercentage = 100;
        public bool UseArcaneTorrentForResource = true;
        public int UseArcaneTorrentForResourceAtPercentage = 80;
        public bool UseArchangel = true;
        public bool UseBerserking = true;
        public bool UseBloodFury = true;
        public bool UseCascade = true;
        public bool UseChakraChastise = true;
        public bool UseChakraSanctuary = false;
        public bool UseChakraSerenity = false;
        public bool UseCircleofHealing = false;
        public int UseCircleofHealingAtPercentage = 50;
        public bool UseDesperatePrayer = true;
        public int UseDesperatePrayerAtPercentage = 65;
        public bool UseDivineHymn = true;
        public int UseDivineHymnAtPercentage = 30;
        public bool UseDivineStar = true;

        public bool UseFlashHealInCombat = true;
        public int UseFlashHealInCombatAtPercentage = 60;
        public bool UseFlashHealNonCombat = true;
        public int UseFlashHealNonCombatAtPercentage = 95;
        public bool UseGiftoftheNaaru = true;
        public int UseGiftoftheNaaruAtPercentage = 80;
        public bool UseGlyphofLightspring = false;
        public bool UseGreaterHeal = true;
        public int UseGreaterHealAtPercentage = 70;
        public bool UseGuardianSpirit = true;
        public int UseGuardianSpiritAtPercentage = 20;
        public bool UseHalo = true;
        public bool UseHeal = true;
        public int UseHealAtPercentage = 70;
        public bool UseHolyFire = true;
        public bool UseHolyWordChastise = true;
        public bool UseHymnofHope = true;
        public int UseHymnofHopeAtPercentage = 40;
        public bool UseInnerFire = true;
        public bool UseInnerWill = false;
        public bool UseLevitate = false;

        public bool UseLightWell = true;
        public int UseLightWellAtPercentage = 95;
        public bool UseMindSear = true;
        public bool UsePowerInfusion = true;
        public bool UsePowerWordFortitude = true;
        public bool UsePowerWordShield = true;
        public int UsePowerWordShieldAtPercentage = 100;
        public bool UsePowerWordSolace = true;
        public bool UsePrayerofHealing = false;
        public int UsePrayerofHealingAtPercentage = 50;
        public bool UsePrayerofMending = true;
        public int UsePrayerofMendingAtPercentage = 50;
        public bool UsePsychicScream = true;
        public int UsePsychicScreamAtPercentage = 20;
        public bool UsePsyfiend = true;
        public int UsePsyfiendAtPercentage = 35;
        public bool UseRenew = true;
        public int UseRenewAtPercentage = 90;
        public bool UseShadowWordDeath = true;
        public bool UseShadowWordPain = true;
        public bool UseShadowfiend = true;
        public bool UseSmite = true;
        public bool UseSpectralGuise = true;
        public int UseSpectralGuiseAtPercentage = 70;
        public bool UseStoneform = true;
        public int UseStoneformAtPercentage = 80;
        public bool UseTrinketOne = true;
        public bool UseTrinketTwo = true;
        public bool UseVoidTendrils = true;
        public int UseVoidTendrilsAtPercentage = 35;
        public bool UseWarStomp = true;
        public int UseWarStompAtPercentage = 80;

        public PriestHolySettings()
        {
            ConfigWinForm("Holy Priest Settings");
            /* Professions and Racials */
            AddControlInWinForm("Use Arcane Torrent for Interrupt", "UseArcaneTorrentForDecast", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Arcane Torrent for Resource", "UseArcaneTorrentForResource", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Berserking", "UseBerserking", "Professions and Racials");
            AddControlInWinForm("Use Blood Fury", "UseBloodFury", "Professions and Racials");
            AddControlInWinForm("Use Gift of the Naaru", "UseGiftoftheNaaru", "Professions and Racials", "AtPercentage");
            AddControlInWinForm("Use Lifeblood", "UseLifeblood", "Professions and Racials");
            AddControlInWinForm("Use Stoneform", "UseStoneform", "Professions and Racials", "AtPercentage");
            AddControlInWinForm("Use War Stomp", "UseWarStomp", "Professions and Racials", "AtPercentage");
            /* Priest Buffs */
            AddControlInWinForm("Use Chakra: Chastise", "UseChakraChastise", "Priest Buffs");
            AddControlInWinForm("Use Chakra: Sanctuary", "UseChakraSanctuary", "Priest Buffs");
            AddControlInWinForm("Use Chakra: Serenity", "UseChakraSerenity", "Priest Buffs");
            AddControlInWinForm("Use Inner Fire", "UseInnerFire", "Priest Buffs");
            AddControlInWinForm("Use Inner Will", "UseInnerWill", "Priest Buffs");
            AddControlInWinForm("Use Levitate", "UseLevitate", "Priest Buffs");
            AddControlInWinForm("Use Power Word: Fortitude", "UsePowerWordFortitude", "Priest Buffs");
            /* Offensive Spell */
            AddControlInWinForm("Use Cascade", "UseCascade", "Offensive Spell");
            AddControlInWinForm("Use Divine Star", "Use Divine Star", "Offensive Spell");
            AddControlInWinForm("Use Halo", "UseHalo", "Offensive Spell");
            AddControlInWinForm("Use Holy Fire", "UseHolyFire", "Offensive Spell");
            AddControlInWinForm("Use Holy Word: Chastise", "UseHolyWordChastise", "Offensive Spell");
            AddControlInWinForm("Use Mind Sear", "UseMindSear", "Offensive Spell");
            AddControlInWinForm("Use Shadow Word: Death", "UseShadowWordDeath", "Offensive Spell");
            AddControlInWinForm("Use Shadow Word: Pain", "UseShadowWordPain", "Offensive Spell");
            AddControlInWinForm("Use Smite", "UseSmite", "Offensive Spell");
            /* Healing Cooldown */
            AddControlInWinForm("Use Divine Hymn", "UseDivineHymn", "Healing Cooldown", "AtPercentage");
            AddControlInWinForm("Use Light Well", "UseLightWell", "Healing Cooldown", "AtPercentage");
            AddControlInWinForm("Use Power Infusion", "UsePowerInfusion", "Healing Cooldown");
            AddControlInWinForm("Use Shadowfiend", "UseShadowfiend", "Healing Cooldown");
            /* Defensive Cooldown */
            AddControlInWinForm("Use Guardian Spirit", "UseGuardianSpirit", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Power Word: Shield", "UsePowerWordShield", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Psychic Scream", "UsePsychicScream", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Psyfiend", "UsePsyfiend", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Spectral Guise", "UseSpectralGuise", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Void Tendrils", "UseVoidTendrils", "Defensive Cooldown", "AtPercentage");
            /* Healing Spell */
            AddControlInWinForm("Use Circle of Healing", "UseCircleofHealing", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Desperate Prayer", "UseDesperatePrayer", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Flash Heal for Regeneration after combat", "UseFlashHealNonCombat", "Healing Spell",
                "AtPercentage");
            AddControlInWinForm("Use Flash Heal during combat", "UseFlashHealInCombat", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Greater Heal", "UseGreaterHeal", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Heal", "UseHeal", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Hymn of Hope", "UseHymnofHope", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Prayer of Mending", "UsePrayerofMending", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Renew", "UseRenew", "Healing Spell");
            /* Game Settings */
            AddControlInWinForm("Use Trinket One", "UseTrinketOne", "Game Settings");
            AddControlInWinForm("Use Trinket Two", "UseTrinketTwo", "Game Settings");

            AddControlInWinForm("Use Alchemist Flask", "UseAlchFlask", "Game Settings");
            AddControlInWinForm("Use Glyph of Lightspring", "UseGlyphofLightspring", "Game Settings");
            AddControlInWinForm("Do avoid melee (Off Advised!!)", "DoAvoidMelee", "Game Settings");
            AddControlInWinForm("Avoid melee distance (1 to 4)", "DoAvoidMeleeDistance", "Game Settings");
        }

        public static PriestHolySettings CurrentSetting { get; set; }

        public static PriestHolySettings GetSettings()
        {
            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Priest_Holy.xml";
            if (File.Exists(currentSettingsFile))
            {
                return
                    CurrentSetting = Load<PriestHolySettings>(currentSettingsFile);
            }
            return new PriestHolySettings();
        }
    }

    #endregion
}

#endregion

#region Rogue

public class RogueCombat
{
    private static RogueCombatSettings MySettings = RogueCombatSettings.GetSettings();

    #region General Timers & Variables

    private readonly WoWItem _firstTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET);
    private readonly WoWItem _secondTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET, 2);
    public uint CP = 0;
    public int LC = 0;

    private Timer _onCd = new Timer(0);

    #endregion

    #region Professions & Racials

    public readonly Spell Alchemy = new Spell("Alchemy");
    public readonly Spell ArcaneTorrent = new Spell("Arcane Torrent");
    public readonly Spell Berserking = new Spell("Berserking");
    public readonly Spell BloodFury = new Spell("Blood Fury");

    public readonly Spell GiftoftheNaaru = new Spell("Gift of the Naaru");

    public readonly Spell Stoneform = new Spell("Stoneform");
    public readonly Spell WarStomp = new Spell("War Stomp");

    #endregion

    #region Rogue Buffs

    public readonly Spell BladeFlurry = new Spell("Blade Flurry");
    public readonly Spell BurstofSpeed = new Spell("Burst of Speed");
    public readonly Spell CripplingPoison = new Spell("Crippling Poison");
    public readonly Spell DeadlyPoison = new Spell("Deadly Poison");
    public readonly Spell LeechingPoison = new Spell("Leeching Poison");
    public readonly Spell MindnumbingPoison = new Spell("Mind-numbing Poison");
    public readonly Spell ParalyticPoison = new Spell("Paralytic Poison");
    public readonly Spell SliceandDice = new Spell("Slice and Dice");
    public readonly Spell Sprint = new Spell("Sprint");
    public readonly Spell Stealth = new Spell("Stealth");
    public readonly Spell WoundPoison = new Spell("Wound Poison");
/*
        private Timer _sliceandDiceTimer = new Timer(0);
*/

    #endregion

    #region Offensive Spell

    public readonly Spell Ambush = new Spell("Ambush");
    public readonly Spell CrimsonTempest = new Spell("Crimson Tempest");
    public readonly Spell DeadlyThrow = new Spell("Deadly Throw");
    public readonly Spell Eviscerate = new Spell("Eviscerate");
    public readonly Spell ExposeArmor = new Spell("Expose Armor");
    public readonly Spell FanofKnives = new Spell("Fan of Knives");
    public readonly Spell Garrote = new Spell("Garrote");
    public readonly Spell RevealingStrike = new Spell("Revealing Strike");
    public readonly Spell Rupture = new Spell("Rupture");
    public readonly Spell Shiv = new Spell("Shiv");
    public readonly Spell ShurikenToss = new Spell("Shuriken Toss");
    public readonly Spell SinisterStrike = new Spell("Sinister Strike");
    public readonly Spell Throw = new Spell("Throw");
    private Timer _ruptureTimer = new Timer(0);

    #endregion

    #region Offensive Cooldown

    public readonly Spell AdrenalineRush = new Spell("Adrenaline Rush");
    public readonly Spell KillingSpree = new Spell("Killing Spree");
    public readonly Spell Redirect = new Spell("Redirect");
    public readonly Spell ShadowBlades = new Spell("Shadow Blades");
    public readonly Spell ShadowStep = new Spell("Shadow Step");
    public readonly Spell Vendetta = new Spell("Vendetta");

    #endregion

    #region Defensive Cooldown

    public readonly Spell CheapShot = new Spell("Cheap Shot");
    public readonly Spell CloakofShadows = new Spell("Cloak of Shadows");
    public readonly Spell CombatReadiness = new Spell("Combat Readiness");
    public readonly Spell Dismantle = new Spell("Dismantle");
    public readonly Spell Evasion = new Spell("Evasion");
    public readonly Spell Kick = new Spell("Kick");
    public readonly Spell KidneyShot = new Spell("Kidney Shot");
    public readonly Spell Preparation = new Spell("Preparation");
    public readonly Spell SmokeBomb = new Spell("Smoke Bomb");
    public readonly Spell Vanish = new Spell("Vanish");
/*
        private Timer _dismantleTimer = new Timer(0);
*/

    #endregion

    #region Healing Spell

    public readonly Spell Recuperate = new Spell("Recuperate");

    #endregion

    public RogueCombat()
    {
        Main.InternalRange = ObjectManager.Me.GetCombatReach;
        MySettings = RogueCombatSettings.GetSettings();
        Main.DumpCurrentSettings<RogueCombatSettings>(MySettings);
        UInt128 lastTarget = 0;

        while (Main.InternalLoop)
        {
            try
            {
                if (!ObjectManager.Me.IsDeadMe)
                {
                    if (!ObjectManager.Me.IsMounted)
                    {
                        if (Fight.InFight && ObjectManager.Me.Target > 0)
                        {
                            if (ObjectManager.Me.Target != lastTarget
                                && (Throw.IsHostileDistanceGood || CheapShot.IsHostileDistanceGood))
                            {
                                Pull();
                                lastTarget = ObjectManager.Me.Target;
                            }

                            if (ObjectManager.Target.Level < 70 && ObjectManager.Me.Level > 84
                                && MySettings.UseLowCombat)
                            {
                                LC = 1;
                                if (ObjectManager.Target.GetDistance < 30)
                                    LowCombat();
                            }
                            else
                            {
                                LC = 0;
                                if (ObjectManager.Target.GetDistance < 30 && ObjectManager.Me.Level < 10)
                                    LowCombat();
                                else if (ObjectManager.Target.GetDistance < 30)
                                    Combat();
                            }
                        }
                        if (!ObjectManager.Me.IsCast)
                            Patrolling();
                    }
                }
                else
                    Thread.Sleep(500);
            }
            catch
            {
            }
            Thread.Sleep(100);
        }
    }

    private void Pull()
    {
        if (Redirect.IsSpellUsable && Redirect.IsHostileDistanceGood && Redirect.KnownSpell
            && MySettings.UseRedirect && ObjectManager.Me.ComboPoint > 0)
        {
            Redirect.Cast();
            Others.SafeSleep(200);
        }

        if (((Stealth.KnownSpell && Stealth.IsSpellUsable && !Stealth.HaveBuff && MySettings.UseStealth)
             || Stealth.HaveBuff) && LC != 1)
        {
            if (!Stealth.HaveBuff)
            {
                Stealth.Cast();
                Others.SafeSleep(200);
            }

            if (ShadowStep.IsSpellUsable && ShadowStep.IsHostileDistanceGood && ShadowStep.KnownSpell
                && MySettings.UseShadowStep)
            {
                ShadowStep.Cast();
                Others.SafeSleep(200);
            }

            if (Garrote.IsSpellUsable && Garrote.IsHostileDistanceGood && Garrote.KnownSpell
                && MySettings.UseGarrote)
            {
                Garrote.Cast();
                return;
            }
            if (CheapShot.IsSpellUsable && CheapShot.IsHostileDistanceGood && CheapShot.KnownSpell
                && MySettings.UseCheapShot)
            {
                CheapShot.Cast();
                return;
            }
            return;
        }
        if (ShurikenToss.IsSpellUsable && ShurikenToss.IsHostileDistanceGood && ShurikenToss.KnownSpell
            && MySettings.UseShurikenToss && !MySettings.UseStealth)
        {
            ShurikenToss.Cast();
            return;
        }
        if (Throw.IsSpellUsable && Throw.IsHostileDistanceGood && Throw.KnownSpell
            && MySettings.UseThrow && !MySettings.UseStealth)
        {
            MovementManager.StopMove();
            Throw.Cast();
            Others.SafeSleep(1000);
        }
    }

    private void LowCombat()
    {
        Buff();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        DefenseCycle();
        Heal();

        if (Throw.IsSpellUsable && Throw.IsHostileDistanceGood && Throw.KnownSpell && !ObjectManager.Target.InCombat
            && MySettings.UseThrow)
        {
            Throw.Cast();
            return;
        }

        if (Eviscerate.KnownSpell && Eviscerate.IsSpellUsable && Eviscerate.IsHostileDistanceGood && MySettings.UseEviscerate && ObjectManager.Me.ComboPoint >= 2)
        {
            Eviscerate.Cast();
            return;
        }
        if (RevealingStrike.KnownSpell && RevealingStrike.IsSpellUsable && RevealingStrike.IsHostileDistanceGood
            && MySettings.UseRevealingStrike)
        {
            RevealingStrike.Cast();
            return;
        }
        if (SinisterStrike.KnownSpell && SinisterStrike.IsSpellUsable && SinisterStrike.IsHostileDistanceGood
            && MySettings.UseSinisterStrike)
        {
            SinisterStrike.Cast();
            return;
        }
        if (SliceandDice.KnownSpell && SliceandDice.IsSpellUsable && SliceandDice.IsHostileDistanceGood
            && MySettings.UseSliceandDice && !SliceandDice.HaveBuff)
        {
            CP = ObjectManager.Me.ComboPoint;
            SliceandDice.Cast();
            //_sliceandDiceTimer = new Timer(1000*(6 + (CP*6)));
            return;
        }
        if (FanofKnives.KnownSpell && FanofKnives.IsSpellUsable && FanofKnives.IsHostileDistanceGood
            && MySettings.UseFanofKnives)
        {
            FanofKnives.Cast();
        }
    }

    private void Combat()
    {
        Buff();
        DPSBurst();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        DPSCycle();
        Decast();
        if (_onCd.IsReady)
            DefenseCycle();
        Heal();
    }

    private void Buff()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (MySettings.UseDeadlyPoison && DeadlyPoison.KnownSpell && DeadlyPoison.IsSpellUsable
            && !DeadlyPoison.HaveBuff)
        {
            DeadlyPoison.Cast();
            return;
        }
        if (!WoundPoison.HaveBuff && WoundPoison.KnownSpell && WoundPoison.IsSpellUsable
            && MySettings.UseWoundPoison && !DeadlyPoison.HaveBuff)
        {
            WoundPoison.Cast();
            return;
        }
        if (!LeechingPoison.HaveBuff && LeechingPoison.KnownSpell && LeechingPoison.IsSpellUsable
            && MySettings.UseLeechingPoison)
        {
            LeechingPoison.Cast();
            return;
        }
        if (!ParalyticPoison.HaveBuff && ParalyticPoison.KnownSpell && ParalyticPoison.IsSpellUsable
            && MySettings.UseParalyticPoison && !LeechingPoison.HaveBuff)
        {
            ParalyticPoison.Cast();
            return;
        }
        if (!CripplingPoison.HaveBuff && CripplingPoison.KnownSpell && CripplingPoison.IsSpellUsable
            && MySettings.UseCripplingPoison && !LeechingPoison.HaveBuff && ParalyticPoison.HaveBuff)
        {
            CripplingPoison.Cast();
            return;
        }
        if (!MindnumbingPoison.HaveBuff && MindnumbingPoison.KnownSpell && MindnumbingPoison.IsSpellUsable
            && MySettings.UseMindnumbingPoison && !CripplingPoison.HaveBuff && !ParalyticPoison.HaveBuff
            && !LeechingPoison.HaveBuff)
        {
            MindnumbingPoison.Cast();
            return;
        }
        if (!ObjectManager.Me.InCombat && BurstofSpeed.IsSpellUsable && BurstofSpeed.KnownSpell
            && MySettings.UseBurstofSpeed && ObjectManager.Me.GetMove)
        {
            BurstofSpeed.Cast();
            return;
        }
        if (!ObjectManager.Me.InCombat && Sprint.IsSpellUsable && Sprint.KnownSpell
            && MySettings.UseSprint && ObjectManager.Me.GetMove)
        {
            Sprint.Cast();
            return;
        }
        if (MySettings.UseAlchFlask && !ObjectManager.Me.HaveBuff(79638) && !ObjectManager.Me.HaveBuff(79640) && !ObjectManager.Me.HaveBuff(79639) &&
            !ItemsManager.IsItemOnCooldown(75525) && ItemsManager.GetItemCount(75525) > 0)
        {
            ItemsManager.UseItem(75525);
        }
    }

    private void AvoidMelee()
    {
        if (ObjectManager.Target.GetDistance < MySettings.DoAvoidMeleeDistance && ObjectManager.Target.InCombat)
        {
            Logging.WriteFight("Too Close. Moving Back");
            var maxTimeTimer = new Timer(1000*2);
            MovementsAction.MoveBackward(true);
            while (ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat && !maxTimeTimer.IsReady)
                Others.SafeSleep(300);
            MovementsAction.MoveBackward(false);
            if (maxTimeTimer.IsReady && ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat)
            {
                MovementsAction.MoveForward(true);
                Others.SafeSleep(1000);
                MovementsAction.MoveForward(false);
                MovementManager.Face(ObjectManager.Target.Position);
            }
        }
    }

    private void DefenseCycle()
    {
        if (ObjectManager.Me.HealthPercent <= 80 && !KidneyShot.TargetHaveBuff && KidneyShot.KnownSpell
            && KidneyShot.IsSpellUsable && KidneyShot.IsHostileDistanceGood && ObjectManager.Me.ComboPoint <= 3
            && Recuperate.HaveBuff && MySettings.UseKidneyShot)
        {
            CP = ObjectManager.Me.ComboPoint;
            KidneyShot.Cast();
            _onCd = new Timer(1000*CP);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= 80 && Evasion.KnownSpell && Evasion.IsSpellUsable
            && MySettings.UseEvasion)
        {
            Evasion.Cast();
            _onCd = new Timer(1000*15);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= 90 && CombatReadiness.KnownSpell && CombatReadiness.IsSpellUsable
            && MySettings.UseCombatReadiness)
        {
            CombatReadiness.Cast();
            _onCd = new Timer(1000*20);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= 95 && Dismantle.KnownSpell && Dismantle.IsSpellUsable
            && MySettings.UseDismantle)
        {
            Dismantle.Cast();
            //_dismantleTimer = new Timer(1000*60);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseWarStompAtPercentage && WarStomp.IsSpellUsable &&
            WarStomp.KnownSpell
            && MySettings.UseWarStomp)
        {
            WarStomp.Cast();
            _onCd = new Timer(1000*2);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseStoneformAtPercentage && Stoneform.IsSpellUsable &&
            Stoneform.KnownSpell
            && MySettings.UseStoneform)
        {
            Stoneform.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (ObjectManager.GetNumberAttackPlayer() >= 3 && Vanish.KnownSpell && Vanish.IsSpellUsable
            && MySettings.UseVanish)
        {
            Vanish.Cast();
            Others.SafeSleep(5000);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= 70 && Preparation.KnownSpell && Preparation.IsSpellUsable
            && MySettings.UsePreparation && !Evasion.IsSpellUsable)
        {
            Preparation.Cast();
        }
    }

    private void Heal()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (ObjectManager.Me.HealthPercent <= MySettings.UseGiftoftheNaaruAtPercentage && GiftoftheNaaru.KnownSpell &&
            GiftoftheNaaru.IsSpellUsable
            && MySettings.UseGiftoftheNaaru)
        {
            GiftoftheNaaru.Cast();
            return;
        }
        if (!Recuperate.HaveBuff && ObjectManager.Me.ComboPoint > 1 && MySettings.UseRecuperate
            && ObjectManager.Me.HealthPercent <= 90 && Recuperate.KnownSpell && Recuperate.IsSpellUsable)
        {
            Recuperate.Cast();
        }
    }

    private void Decast()
    {
        if (ObjectManager.Target.IsCast && Kick.KnownSpell && Kick.IsSpellUsable
            && Kick.IsHostileDistanceGood && MySettings.UseKick && ObjectManager.Target.IsTargetingMe)
        {
            Kick.Cast();
            return;
        }
        if (ArcaneTorrent.IsSpellUsable && ArcaneTorrent.KnownSpell && ObjectManager.Target.GetDistance < 8
            && ObjectManager.Me.HealthPercent <= MySettings.UseArcaneTorrentForDecastAtPercentage
            && MySettings.UseArcaneTorrentForDecast && ObjectManager.Target.IsCast &&
            ObjectManager.Target.IsTargetingMe)
        {
            ArcaneTorrent.Cast();
            return;
        }
        if (ObjectManager.Target.IsCast && CloakofShadows.KnownSpell && CloakofShadows.IsSpellUsable
            && ObjectManager.Target.IsTargetingMe && MySettings.UseCloakofShadows)
        {
            CloakofShadows.Cast();
            return;
        }
        if (ObjectManager.Target.IsCast && SmokeBomb.KnownSpell && SmokeBomb.IsSpellUsable
            && ObjectManager.Target.IsTargetingMe && MySettings.UseSmokeBomb
            && !CloakofShadows.HaveBuff)
        {
            SmokeBomb.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent <= 70 && Preparation.KnownSpell && Preparation.IsSpellUsable
            && MySettings.UsePreparation && !CloakofShadows.IsSpellUsable && ObjectManager.Target.IsCast
            && ObjectManager.Target.IsTargetingMe)
        {
            Preparation.Cast();
        }
    }

    private void DPSBurst()
    {
        if (MySettings.UseTrinketOne && !ItemsManager.IsItemOnCooldown(_firstTrinket.Entry) && ItemsManager.IsItemUsable(_firstTrinket.Entry))
        {
            ItemsManager.UseItem(_firstTrinket.Name);
            Logging.WriteFight("Use First Trinket Slot");
        }

        if (MySettings.UseTrinketTwo && !ItemsManager.IsItemOnCooldown(_secondTrinket.Entry) && ItemsManager.IsItemUsable(_secondTrinket.Entry))
        {
            ItemsManager.UseItem(_secondTrinket.Name);
            Logging.WriteFight("Use Second Trinket Slot");
            return;
        }
        if (Berserking.IsSpellUsable && Berserking.KnownSpell && ObjectManager.Target.GetDistance < 30
            && MySettings.UseBerserking)
        {
            Berserking.Cast();
            return;
        }
        if (BloodFury.IsSpellUsable && BloodFury.KnownSpell && ObjectManager.Target.GetDistance < 30
            && MySettings.UseBloodFury)
        {
            BloodFury.Cast();
            return;
        }
        if (AdrenalineRush.KnownSpell && AdrenalineRush.IsSpellUsable
            && MySettings.UseAdrenalineRush && ObjectManager.Target.GetDistance < 30)
        {
            AdrenalineRush.Cast();
            return;
        }
        if (KillingSpree.KnownSpell && KillingSpree.IsSpellUsable
            && MySettings.UseKillingSpree && ObjectManager.Target.GetDistance < 10
            && ObjectManager.Me.EnergyPercentage < 35)
        {
            KillingSpree.Cast();
            return;
        }
        if (ShadowBlades.KnownSpell && ShadowBlades.IsSpellUsable
            && MySettings.UseShadowBlades && ObjectManager.Target.GetDistance < 30)
        {
            ShadowBlades.Cast();
        }
    }

    private void DPSCycle()
    {
        Usefuls.SleepGlobalCooldown();
        try
        {
            Memory.WowMemory.GameFrameLock(); // !!! WARNING - DONT SLEEP WHILE LOCKED - DO FINALLY(GameFrameUnLock()) !!!

            if (Garrote.IsSpellUsable && Garrote.IsHostileDistanceGood && Garrote.KnownSpell
                && MySettings.UseGarrote && ObjectManager.Me.HaveBuff(115192))
            {
                Garrote.Cast();
                return;
            }
            if (Throw.IsSpellUsable && Throw.IsHostileDistanceGood && Throw.KnownSpell && !ObjectManager.Target.InCombat
                && MySettings.UseThrow)
            {
                Throw.Cast();
                return;
            }
            if (BladeFlurry.KnownSpell && BladeFlurry.IsSpellUsable && ObjectManager.Target.GetDistance < 10
                && MySettings.UseBladeFlurry && !BladeFlurry.HaveBuff && ObjectManager.GetNumberAttackPlayer() > 1)
            {
                BladeFlurry.Cast();
                return;
            }
            if (BladeFlurry.KnownSpell && BladeFlurry.IsSpellUsable && SinisterStrike.IsHostileDistanceGood
                && BladeFlurry.HaveBuff && ObjectManager.GetNumberAttackPlayer() < 2)
            {
                BladeFlurry.Cast();
                return;
            }
            if (Eviscerate.KnownSpell && Eviscerate.IsSpellUsable && Eviscerate.IsHostileDistanceGood
                && MySettings.UseEviscerate && ObjectManager.Me.ComboPoint > 4)
            {
                Eviscerate.Cast();
                return;
            }
            if (RevealingStrike.KnownSpell && RevealingStrike.IsSpellUsable && RevealingStrike.IsHostileDistanceGood
                && MySettings.UseRevealingStrike && !RevealingStrike.TargetHaveBuff)
            {
                RevealingStrike.Cast();
                return;
            }
            if (SliceandDice.KnownSpell && SliceandDice.IsSpellUsable && SliceandDice.IsHostileDistanceGood
                && MySettings.UseSliceandDice && !SliceandDice.HaveBuff)
            {
                CP = ObjectManager.Me.ComboPoint;
                SliceandDice.Cast();
                //_sliceandDiceTimer = new Timer(1000*(6 + (CP*6)));
                return;
            }
            if (Rupture.KnownSpell && Rupture.IsHostileDistanceGood && Rupture.IsSpellUsable
                && MySettings.UseRupture && (!Rupture.TargetHaveBuff || _ruptureTimer.IsReady))
            {
                CP = ObjectManager.Me.ComboPoint;
                Rupture.Cast();
                _ruptureTimer = new Timer(1000*(4 + (CP*4)));
                return;
            }
            if (ExposeArmor.IsSpellUsable && ExposeArmor.IsHostileDistanceGood && ExposeArmor.KnownSpell
                && MySettings.UseExposeArmor && !ObjectManager.Target.HaveBuff(113746))
            {
                ExposeArmor.Cast();
                return;
            }
            if (SinisterStrike.KnownSpell && SinisterStrike.IsSpellUsable && SinisterStrike.IsHostileDistanceGood
                && MySettings.UseSinisterStrike)
            {
                SinisterStrike.Cast();
                return;
            }
            if (ArcaneTorrent.IsSpellUsable && ArcaneTorrent.KnownSpell
                && MySettings.UseArcaneTorrentForResource)
            {
                ArcaneTorrent.Cast();
            }
        }
        finally
        {
            Memory.WowMemory.GameFrameUnLock();
        }
    }

    private void Patrolling()
    {
        if (ObjectManager.Me.IsMounted) return;
        Buff();
        Heal();
    }

    #region Nested type: RogueCombatSettings

    [Serializable]
    public class RogueCombatSettings : Settings
    {
        public bool DoAvoidMelee = false;
        public int DoAvoidMeleeDistance = 0;
        public bool UseAdrenalineRush = true;
        public bool UseAlchFlask = true;
        public bool UseAmbush = true;
        public bool UseArcaneTorrentForDecast = true;
        public int UseArcaneTorrentForDecastAtPercentage = 100;
        public bool UseArcaneTorrentForResource = true;
        public bool UseBerserking = true;
        public bool UseBladeFlurry = true;
        public bool UseBloodFury = true;
        public bool UseBurstofSpeed = true;
        public bool UseCheapShot = true;
        public bool UseCloakofShadows = true;
        public bool UseCombatReadiness = true;
        public bool UseCrimsonTempest = true;
        public bool UseCripplingPoison = false;
        public bool UseDeadlyPoison = true;
        public bool UseDeadlyThrow = true;
        public bool UseDismantle = true;

        public bool UseEvasion = true;
        public bool UseEviscerate = true;
        public bool UseExposeArmor = false;
        public bool UseFanofKnives = true;
        public bool UseGarrote = true;
        public bool UseGiftoftheNaaru = true;
        public int UseGiftoftheNaaruAtPercentage = 80;
        public bool UseKick = true;
        public bool UseKidneyShot = true;
        public bool UseKillingSpree = true;
        public bool UseLeechingPoison = true;

        public bool UseLowCombat = true;
        public bool UseMindnumbingPoison = true;
        public bool UseParalyticPoison = false;
        public bool UsePreparation = true;
        public bool UseRecuperate = true;
        public bool UseRedirect = true;
        public bool UseRevealingStrike = true;
        public bool UseRupture = true;
        public bool UseShadowBlades = true;
        public bool UseShadowStep = true;
        public bool UseShiv = true;
        public bool UseShurikenToss = true;
        public bool UseSinisterStrike = true;
        public bool UseSliceandDice = true;
        public bool UseSmokeBomb = true;
        public bool UseSprint = true;
        public bool UseStealth = false;
        public bool UseStoneform = true;
        public int UseStoneformAtPercentage = 80;
        public bool UseThrow = true;
        public bool UseTrinketOne = true;
        public bool UseTrinketTwo = true;
        public bool UseVanish = true;
        public bool UseWarStomp = true;
        public int UseWarStompAtPercentage = 80;
        public bool UseWoundPoison = false;

        public RogueCombatSettings()
        {
            ConfigWinForm("Rogue Combat Settings");
            /* Professions & Racials */
            AddControlInWinForm("Use Arcane Torrent for Interrupt", "UseArcaneTorrentForDecast", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Arcane Torrent for Resource", "UseArcaneTorrentForResource", "Professions & Racials");
            AddControlInWinForm("Use Berserking", "UseBerserking", "Professions & Racials");
            AddControlInWinForm("Use Blood Fury", "UseBloodFury", "Professions & Racials");
            AddControlInWinForm("Use Gift of the Naaru", "UseGiftoftheNaaru", "Professions & Racials");

            AddControlInWinForm("Use Stoneform", "UseStoneform", "Professions & Racials");
            AddControlInWinForm("Use War Stomp", "UseWarStomp", "Professions & Racials");
            /* Rogue Buffs */
            AddControlInWinForm("Use Blade Flurry", "UseBladeFlurry", "Rogue Buffs");
            AddControlInWinForm("Use Burst of Speed", "UseBurstofSpeed", "Rogue Buffs");
            AddControlInWinForm("Use Crippling Poison", "UseCripplingPoison", "Rogue Buffs");
            AddControlInWinForm("Use Deadly Poison", "UseDeadlyPoison", "Rogue Buffs");
            AddControlInWinForm("Use Leeching Poison", "UseLeechingPoison", "Rogue Buffs");
            AddControlInWinForm("Use Mindnumbing Poison", "UseMindnumbingPoison", "Rogue Buffs");
            AddControlInWinForm("Use Paralytic Poison", "UseParalyticPoison", "Rogue Buffs");
            AddControlInWinForm("Use Slice and Dice", "UseSliceandDice", "Rogue Buffs");
            AddControlInWinForm("Use Sprint", "UseSprint", "Rogue Buffs");
            AddControlInWinForm("Use Stealth", "UseStealth", "Rogue Buffs");
            AddControlInWinForm("Use Wound Poison", "UseWoundPoison", "Rogue Buffs");
            /* Offensive Spell */
            AddControlInWinForm("Use Ambush", "UseAmbush", "Offensive Spell");
            AddControlInWinForm("Use Crimson Tempest", "UseCrimsonTempest", "Offensive Spell");
            AddControlInWinForm("Use Deadly Throw", "UseDeadlyThrow", "Offensive Spell");
            AddControlInWinForm("Use Eviscerate", "UseEviscerate", "Offensive Spell");
            AddControlInWinForm("Use Expose Armor", "UseExposeArmor", "Offensive Spell");
            AddControlInWinForm("Use Fan of Knives", "UseFanofKnives", "Offensive Spell");
            AddControlInWinForm("Use Garrote", "UseGarrote", "Offensive Spell");
            AddControlInWinForm("Use Revealing Strike", "UseRevealingStrike", "Offensive Spell");
            AddControlInWinForm("Use Rupture", "UseRupture", "Offensive Spell");
            AddControlInWinForm("Use Shiv", "UseShiv", "Offensive Spell");
            AddControlInWinForm("Use Shuriken Toss", "UseShurikenToss", "Offensive Spell");
            AddControlInWinForm("Use Sinister Strike", "UseSinisterStrike", "Offensive Spell");
            AddControlInWinForm("Use Throw", "UseThrow", "Offensive Spell");
            /* Offensive Cooldown */
            AddControlInWinForm("Use Adrenaline Rush", "UseAdrenalineRush", "Offensive Cooldown");
            AddControlInWinForm("Use Killing Spree", "UseKillingSpree", "Offensive Cooldown");
            AddControlInWinForm("Use Redirect", "UseRedirect", "Offensive Cooldown");
            AddControlInWinForm("Use Shadow Blades", "UseShadowBlades", "Offensive Cooldown");
            AddControlInWinForm("Use Shadow Step", "UseShadowStep", "Offensive Cooldown");
            AddControlInWinForm("Use Vendetta", "UseVendetta", "Offensive Cooldown");
            /* Defensive Cooldown */
            AddControlInWinForm("Use CheapShot", "UseCheapShot", "Defensive Cooldown");
            AddControlInWinForm("Use CloakofShadows", "UseCloakofShadows", "Defensive Cooldown");
            AddControlInWinForm("Use CombatReadiness", "UseCombatReadiness", "Defensive Cooldown");
            AddControlInWinForm("Use Dismantle", "UseDismantle", "Defensive Cooldown");
            AddControlInWinForm("Use Evasion", "UseEvasion", "Defensive Cooldown");
            AddControlInWinForm("Use Kick", "UseKick", "Defensive Cooldown");
            AddControlInWinForm("Use KidneyShot", "UseKidneyShot", "Defensive Cooldown");
            AddControlInWinForm("Use Preparation", "UsePreparation", "Defensive Cooldown");
            AddControlInWinForm("Use SmokeBomb", "UseSmokeBomb", "Defensive Cooldown");
            AddControlInWinForm("Use Vanish", "UseVanish", "Defensive Cooldown");
            /* Healing Spell */
            AddControlInWinForm("Use Recuperate", "UseRecuperate", "Healing Spell");
            /* Game Settings */
            AddControlInWinForm("Use Low Combat Settings", "UseLowCombat", "Game Settings");
            AddControlInWinForm("Use Trinket One", "UseTrinketOne", "Game Settings");
            AddControlInWinForm("Use Trinket Two", "UseTrinketTwo", "Game Settings");

            AddControlInWinForm("Use Alchemist Flask", "UseAlchFlask", "Game Settings");
            AddControlInWinForm("Do avoid melee (Off Advised!!)", "DoAvoidMelee", "Game Settings");
            AddControlInWinForm("Avoid melee distance (1 to 4)", "DoAvoidMeleeDistance", "Game Settings");
        }

        public static RogueCombatSettings CurrentSetting { get; set; }

        public static RogueCombatSettings GetSettings()
        {
            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Rogue_Combat.xml";
            if (File.Exists(currentSettingsFile))
            {
                return
                    CurrentSetting = Load<RogueCombatSettings>(currentSettingsFile);
            }
            return new RogueCombatSettings();
        }
    }

    #endregion
}

public class RogueSubtlety
{
    private static RogueSubtletySettings MySettings = RogueSubtletySettings.GetSettings();

    #region General Timers & Variables

    private readonly WoWItem _firstTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET);
    private readonly WoWItem _secondTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET, 2);
    public uint CP = 0;
    public int LC = 0;

    private Timer _onCd = new Timer(0);

    #endregion

    #region Professions & Racials

    public readonly Spell Alchemy = new Spell("Alchemy");
    public readonly Spell ArcaneTorrent = new Spell("Arcane Torrent");
    public readonly Spell Berserking = new Spell("Berserking");
    public readonly Spell BloodFury = new Spell("Blood Fury");

    public readonly Spell GiftoftheNaaru = new Spell("Gift of the Naaru");

    public readonly Spell Stoneform = new Spell("Stoneform");
    public readonly Spell WarStomp = new Spell("War Stomp");

    #endregion

    #region Rogue Buffs

    public readonly Spell BurstofSpeed = new Spell("Burst of Speed");
    public readonly Spell CripplingPoison = new Spell("Crippling Poison");
    public readonly Spell DeadlyPoison = new Spell("Deadly Poison");
    public readonly Spell LeechingPoison = new Spell("Leeching Poison");
    public readonly Spell MindnumbingPoison = new Spell("Mind-numbing Poison");
    public readonly Spell ParalyticPoison = new Spell("Paralytic Poison");
    public readonly Spell SliceandDice = new Spell("Slice and Dice");
    public readonly Spell Sprint = new Spell("Sprint");
    public readonly Spell Stealth = new Spell("Stealth");
    public readonly Spell WoundPoison = new Spell("Wound Poison");
/*
        private Timer _sliceandDiceTimer = new Timer(0);
*/

    #endregion

    #region Offensive Spell

    public readonly Spell Ambush = new Spell("Ambush");
    public readonly Spell CrimsonTempest = new Spell("Crimson Tempest");
    public readonly Spell DeadlyThrow = new Spell("Deadly Throw");
    public readonly Spell Eviscerate = new Spell("Eviscerate");
    public readonly Spell ExposeArmor = new Spell("Expose Armor");
    public readonly Spell FanofKnives = new Spell("Fan of Knives");
    public readonly Spell Garrote = new Spell("Garrote");
    public readonly Spell Hemorrhage = new Spell("Hemorrhage");
    public readonly Spell Rupture = new Spell("Rupture");
    public readonly Spell Shiv = new Spell("Shiv");
    public readonly Spell ShurikenToss = new Spell("Shuriken Toss");
    public readonly Spell SinisterStrike = new Spell("Sinister Strike");
    public readonly Spell Throw = new Spell("Throw");
    private Timer _ruptureTimer = new Timer(0);

    #endregion

    #region Offensive Cooldown

    public readonly Spell Premeditation = new Spell("Premeditation");
    public readonly Spell Redirect = new Spell("Redirect");
    public readonly Spell ShadowBlades = new Spell("Shadow Blades");
    public readonly Spell ShadowDance = new Spell("Shadow Dance");
    public readonly Spell ShadowStep = new Spell("Shadow Step");

    #endregion

    #region Defensive Cooldown

    public readonly Spell CheapShot = new Spell("Cheap Shot");
    public readonly Spell CloakofShadows = new Spell("Cloak of Shadows");
    public readonly Spell CombatReadiness = new Spell("Combat Readiness");
    public readonly Spell Dismantle = new Spell("Dismantle");
    public readonly Spell Evasion = new Spell("Evasion");
    public readonly Spell Kick = new Spell("Kick");
    public readonly Spell KidneyShot = new Spell("Kidney Shot");
    public readonly Spell Preparation = new Spell("Preparation");
    public readonly Spell SmokeBomb = new Spell("Smoke Bomb");
    public readonly Spell Vanish = new Spell("Vanish");
/*
        private Timer _dismantleTimer = new Timer(0);
*/

    #endregion

    #region Healing Spell

    public readonly Spell Recuperate = new Spell("Recuperate");

    #endregion

    public RogueSubtlety()
    {
        Main.InternalRange = ObjectManager.Me.GetCombatReach;
        MySettings = RogueSubtletySettings.GetSettings();
        Main.DumpCurrentSettings<RogueSubtletySettings>(MySettings);
        UInt128 lastTarget = 0;

        while (Main.InternalLoop)
        {
            try
            {
                if (!ObjectManager.Me.IsDeadMe)
                {
                    if (!ObjectManager.Me.IsMounted)
                    {
                        if (Fight.InFight && ObjectManager.Me.Target > 0)
                        {
                            if (ObjectManager.Me.Target != lastTarget
                                && (Throw.IsHostileDistanceGood || CheapShot.IsHostileDistanceGood))
                            {
                                Pull();
                                lastTarget = ObjectManager.Me.Target;
                            }

                            if (ObjectManager.Target.Level < 70 && ObjectManager.Me.Level > 84
                                && MySettings.UseLowCombat)
                            {
                                LC = 1;
                                if (ObjectManager.Target.GetDistance < 30)
                                    LowCombat();
                            }
                            else
                            {
                                LC = 0;
                                if (ObjectManager.Target.GetDistance < 30)
                                    Combat();
                            }
                        }
                        if (!ObjectManager.Me.IsCast)
                            Patrolling();
                    }
                }
                else
                    Thread.Sleep(500);
            }
            catch
            {
            }
            Thread.Sleep(100);
        }
    }

    private void Pull()
    {
        if (Redirect.IsSpellUsable && Redirect.IsHostileDistanceGood && Redirect.KnownSpell
            && MySettings.UseRedirect && ObjectManager.Me.ComboPoint > 0)
        {
            Redirect.Cast();
            Others.SafeSleep(200);
        }

        if (((Stealth.KnownSpell && Stealth.IsSpellUsable && !Stealth.HaveBuff && MySettings.UseStealth)
             || Stealth.HaveBuff) && LC != 1)
        {
            if (!Stealth.HaveBuff)
            {
                Stealth.Cast();
                Others.SafeSleep(200);
            }

            if (Premeditation.IsSpellUsable && Premeditation.IsHostileDistanceGood && Premeditation.KnownSpell
                && MySettings.UsePremeditation && ObjectManager.Me.ComboPoint == 0)
            {
                Premeditation.Cast();
                Others.SafeSleep(200);
            }

            if (ShadowStep.IsSpellUsable && ShadowStep.IsHostileDistanceGood && ShadowStep.KnownSpell
                && MySettings.UseShadowStep)
            {
                ShadowStep.Cast();
                Others.SafeSleep(200);
            }

            if (Garrote.IsSpellUsable && Garrote.IsHostileDistanceGood && Garrote.KnownSpell
                && MySettings.UseGarrote)
            {
                Garrote.Cast();
                return;
            }
            if (CheapShot.IsSpellUsable && CheapShot.IsHostileDistanceGood && CheapShot.KnownSpell
                && MySettings.UseCheapShot)
            {
                CheapShot.Cast();
                return;
            }
            return;
        }
        if (ShurikenToss.IsSpellUsable && ShurikenToss.IsHostileDistanceGood && ShurikenToss.KnownSpell
            && MySettings.UseShurikenToss && !MySettings.UseStealth)
        {
            ShurikenToss.Cast();
            return;
        }
        if (Throw.IsSpellUsable && Throw.IsHostileDistanceGood && Throw.KnownSpell
            && MySettings.UseThrow && !MySettings.UseStealth)
        {
            MovementManager.StopMove();
            Throw.Cast();
            Others.SafeSleep(1000);
        }
    }

    private void LowCombat()
    {
        Buff();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        DefenseCycle();
        Heal();

        if (Throw.IsSpellUsable && Throw.IsHostileDistanceGood && Throw.KnownSpell && !ObjectManager.Target.InCombat
            && MySettings.UseThrow)
        {
            Throw.Cast();
            return;
        }

        if (Eviscerate.KnownSpell && Eviscerate.IsSpellUsable && Eviscerate.IsHostileDistanceGood
            && MySettings.UseEviscerate && ObjectManager.Me.ComboPoint > 4)
        {
            Eviscerate.Cast();
            return;
        }
        if (SliceandDice.KnownSpell && SliceandDice.IsSpellUsable && SliceandDice.IsHostileDistanceGood
            && MySettings.UseSliceandDice && !SliceandDice.HaveBuff)
        {
            CP = ObjectManager.Me.ComboPoint;
            SliceandDice.Cast();
            //_sliceandDiceTimer = new Timer(1000*(6 + (CP*6)));
            return;
        }
        // Blizzard API Calls for Hemorrhage using Sinister Strike Function
        if (SinisterStrike.KnownSpell && SinisterStrike.IsSpellUsable && SinisterStrike.IsHostileDistanceGood
            && MySettings.UseHemorrhage)
        {
            SinisterStrike.Cast();
            return;
        }
        if (FanofKnives.KnownSpell && FanofKnives.IsSpellUsable && FanofKnives.IsHostileDistanceGood
            && MySettings.UseFanofKnives)
        {
            FanofKnives.Cast();
        }
    }

    private void Combat()
    {
        Buff();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        if (_onCd.IsReady)
            DefenseCycle();
        DPSCycle();
        Heal();
        Decast();
        DPSCycle();
        DPSBurst();
        DPSCycle();
    }

    private void Buff()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (MySettings.UseDeadlyPoison && DeadlyPoison.KnownSpell && DeadlyPoison.IsSpellUsable
            && !DeadlyPoison.HaveBuff)
        {
            DeadlyPoison.Cast();
            return;
        }
        if (!WoundPoison.HaveBuff && WoundPoison.KnownSpell && WoundPoison.IsSpellUsable
            && MySettings.UseWoundPoison && !DeadlyPoison.HaveBuff)
        {
            WoundPoison.Cast();
            return;
        }
        if (!LeechingPoison.HaveBuff && LeechingPoison.KnownSpell && LeechingPoison.IsSpellUsable
            && MySettings.UseLeechingPoison)
        {
            LeechingPoison.Cast();
            return;
        }
        if (!ParalyticPoison.HaveBuff && ParalyticPoison.KnownSpell && ParalyticPoison.IsSpellUsable
            && MySettings.UseParalyticPoison && !LeechingPoison.HaveBuff)
        {
            ParalyticPoison.Cast();
            return;
        }
        if (!CripplingPoison.HaveBuff && CripplingPoison.KnownSpell && CripplingPoison.IsSpellUsable
            && MySettings.UseCripplingPoison && !LeechingPoison.HaveBuff && ParalyticPoison.HaveBuff)
        {
            CripplingPoison.Cast();
            return;
        }
        if (!MindnumbingPoison.HaveBuff && MindnumbingPoison.KnownSpell && MindnumbingPoison.IsSpellUsable
            && MySettings.UseMindnumbingPoison && !CripplingPoison.HaveBuff && !ParalyticPoison.HaveBuff
            && !LeechingPoison.HaveBuff)
        {
            MindnumbingPoison.Cast();
            return;
        }
        if (!ObjectManager.Me.InCombat && BurstofSpeed.IsSpellUsable && BurstofSpeed.KnownSpell
            && MySettings.UseBurstofSpeed && ObjectManager.Me.GetMove)
        {
            BurstofSpeed.Cast();
            return;
        }
        if (!ObjectManager.Me.InCombat && Sprint.IsSpellUsable && Sprint.KnownSpell
            && MySettings.UseSprint && ObjectManager.Me.GetMove)
        {
            Sprint.Cast();
            return;
        }
        if (MySettings.UseAlchFlask && !ObjectManager.Me.HaveBuff(79638) && !ObjectManager.Me.HaveBuff(79640) && !ObjectManager.Me.HaveBuff(79639) &&
            !ItemsManager.IsItemOnCooldown(75525) && ItemsManager.GetItemCount(75525) > 0)
        {
            ItemsManager.UseItem(75525);
        }
    }

    private void AvoidMelee()
    {
        if (ObjectManager.Target.GetDistance < MySettings.DoAvoidMeleeDistance && ObjectManager.Target.InCombat)
        {
            Logging.WriteFight("Too Close. Moving Back");
            var maxTimeTimer = new Timer(1000*2);
            MovementsAction.MoveBackward(true);
            while (ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat && !maxTimeTimer.IsReady)
                Others.SafeSleep(300);
            MovementsAction.MoveBackward(false);
            if (maxTimeTimer.IsReady && ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat)
            {
                MovementsAction.MoveForward(true);
                Others.SafeSleep(1000);
                MovementsAction.MoveForward(false);
                MovementManager.Face(ObjectManager.Target.Position);
            }
        }
    }

    private void DefenseCycle()
    {
        if (ObjectManager.Me.HealthPercent <= 80 && !KidneyShot.TargetHaveBuff && KidneyShot.KnownSpell
            && KidneyShot.IsSpellUsable && KidneyShot.IsHostileDistanceGood && ObjectManager.Me.ComboPoint <= 3
            && Recuperate.HaveBuff && MySettings.UseKidneyShot)
        {
            CP = ObjectManager.Me.ComboPoint;
            KidneyShot.Cast();
            _onCd = new Timer(1000*CP);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= 80 && Evasion.KnownSpell && Evasion.IsSpellUsable
            && MySettings.UseEvasion)
        {
            Evasion.Cast();
            _onCd = new Timer(1000*15);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= 90 && CombatReadiness.KnownSpell && CombatReadiness.IsSpellUsable
            && MySettings.UseCombatReadiness)
        {
            CombatReadiness.Cast();
            _onCd = new Timer(1000*20);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= 95 && Dismantle.KnownSpell && Dismantle.IsSpellUsable
            && MySettings.UseDismantle)
        {
            Dismantle.Cast();
            //_dismantleTimer = new Timer(1000*60);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseWarStompAtPercentage && WarStomp.IsSpellUsable &&
            WarStomp.KnownSpell
            && MySettings.UseWarStomp)
        {
            WarStomp.Cast();
            _onCd = new Timer(1000*2);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseStoneformAtPercentage && Stoneform.IsSpellUsable &&
            Stoneform.KnownSpell
            && MySettings.UseStoneform)
        {
            Stoneform.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (ObjectManager.GetNumberAttackPlayer() >= 3 && Vanish.KnownSpell && Vanish.IsSpellUsable
            && MySettings.UseVanish)
        {
            Vanish.Cast();
            Others.SafeSleep(5000);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= 70 && Preparation.KnownSpell && Preparation.IsSpellUsable
            && MySettings.UsePreparation && !Evasion.IsSpellUsable)
        {
            Preparation.Cast();
        }
    }

    private void Heal()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (ObjectManager.Me.HealthPercent <= MySettings.UseGiftoftheNaaruAtPercentage && GiftoftheNaaru.KnownSpell &&
            GiftoftheNaaru.IsSpellUsable
            && MySettings.UseGiftoftheNaaru)
        {
            GiftoftheNaaru.Cast();
            return;
        }
        if (!Recuperate.HaveBuff && ObjectManager.Me.ComboPoint > 1 && MySettings.UseRecuperate
            && ObjectManager.Me.HealthPercent <= 90 && Recuperate.KnownSpell && Recuperate.IsSpellUsable)
        {
            Recuperate.Cast();
        }
    }

    private void Decast()
    {
        if (ObjectManager.Target.IsCast && Kick.KnownSpell && Kick.IsSpellUsable
            && Kick.IsHostileDistanceGood && MySettings.UseKick && ObjectManager.Target.IsTargetingMe)
        {
            Kick.Cast();
            return;
        }
        if (ArcaneTorrent.IsSpellUsable && ArcaneTorrent.KnownSpell && ObjectManager.Target.GetDistance < 8
            && ObjectManager.Me.HealthPercent <= MySettings.UseArcaneTorrentForDecastAtPercentage
            && MySettings.UseArcaneTorrentForDecast && ObjectManager.Target.IsCast &&
            ObjectManager.Target.IsTargetingMe)
        {
            ArcaneTorrent.Cast();
            return;
        }
        if (ObjectManager.Target.IsCast && CloakofShadows.KnownSpell && CloakofShadows.IsSpellUsable
            && ObjectManager.Target.IsTargetingMe && MySettings.UseCloakofShadows)
        {
            CloakofShadows.Cast();
            return;
        }
        if (ObjectManager.Target.IsCast && SmokeBomb.KnownSpell && SmokeBomb.IsSpellUsable
            && ObjectManager.Target.IsTargetingMe && MySettings.UseSmokeBomb
            && !CloakofShadows.HaveBuff)
        {
            SmokeBomb.Cast();
            return;
        }

        if (ObjectManager.Me.HealthPercent <= 70 && Preparation.KnownSpell && Preparation.IsSpellUsable
            && MySettings.UsePreparation && !CloakofShadows.IsSpellUsable && ObjectManager.Target.IsCast
            && ObjectManager.Target.IsTargetingMe)
        {
            Preparation.Cast();
        }
    }

    private void DPSBurst()
    {
        if (MySettings.UseTrinketOne && !ItemsManager.IsItemOnCooldown(_firstTrinket.Entry) && ItemsManager.IsItemUsable(_firstTrinket.Entry))
        {
            ItemsManager.UseItem(_firstTrinket.Name);
            Logging.WriteFight("Use First Trinket Slot");
        }

        if (MySettings.UseTrinketTwo && !ItemsManager.IsItemOnCooldown(_secondTrinket.Entry) && ItemsManager.IsItemUsable(_secondTrinket.Entry))
        {
            ItemsManager.UseItem(_secondTrinket.Name);
            Logging.WriteFight("Use Second Trinket Slot");
            return;
        }
        if (Berserking.IsSpellUsable && Berserking.KnownSpell && ObjectManager.Target.GetDistance < 30
            && MySettings.UseBerserking)
        {
            Berserking.Cast();
            return;
        }
        if (BloodFury.IsSpellUsable && BloodFury.KnownSpell && ObjectManager.Target.GetDistance < 30
            && MySettings.UseBloodFury)
        {
            BloodFury.Cast();
            return;
        }
        if (ShadowDance.KnownSpell && ShadowDance.IsSpellUsable
            && MySettings.UseShadowDance && ObjectManager.Target.GetDistance < 10)
        {
            ShadowDance.Cast();
            return;
        }
        if (ShadowBlades.KnownSpell && ShadowBlades.IsSpellUsable
            && MySettings.UseShadowBlades && ObjectManager.Target.GetDistance < 30)
        {
            ShadowBlades.Cast();
        }
    }

    private void DPSCycle()
    {
        Usefuls.SleepGlobalCooldown();
        try
        {
            Memory.WowMemory.GameFrameLock(); // !!! WARNING - DONT SLEEP WHILE LOCKED - DO FINALLY(GameFrameUnLock()) !!!

            if (ObjectManager.Me.HaveBuff(115192) || ObjectManager.Me.HaveBuff(51713))
            {
                if (Garrote.IsSpellUsable && Garrote.IsHostileDistanceGood && Garrote.KnownSpell
                    && MySettings.UseGarrote && !ObjectManager.Target.HaveBuff(703))
                {
                    Garrote.Cast();
                    return;
                }
            }

            if (Throw.IsSpellUsable && Throw.IsHostileDistanceGood && Throw.KnownSpell && !ObjectManager.Target.InCombat
                && MySettings.UseThrow)
            {
                Throw.Cast();
                return;
            }

            if (Eviscerate.KnownSpell && Eviscerate.IsSpellUsable && Eviscerate.IsHostileDistanceGood
                && MySettings.UseEviscerate && ObjectManager.Me.ComboPoint > 4)
            {
                Eviscerate.Cast();
                return;
            }
            if (SliceandDice.KnownSpell && SliceandDice.IsSpellUsable && SliceandDice.IsHostileDistanceGood
                && MySettings.UseSliceandDice && !SliceandDice.HaveBuff)
            {
                CP = ObjectManager.Me.ComboPoint;
                SliceandDice.Cast();
                //_sliceandDiceTimer = new Timer(1000*(6 + (CP*6)));
                return;
            }
            if (Rupture.KnownSpell && Rupture.IsHostileDistanceGood && Rupture.IsSpellUsable
                && MySettings.UseRupture && (!Rupture.TargetHaveBuff || _ruptureTimer.IsReady))
            {
                CP = ObjectManager.Me.ComboPoint;
                Rupture.Cast();
                _ruptureTimer = new Timer(1000*(4 + (CP*4)));
                return;
            }
            if (ExposeArmor.IsSpellUsable && ExposeArmor.IsHostileDistanceGood && ExposeArmor.KnownSpell
                && MySettings.UseExposeArmor && !ObjectManager.Target.HaveBuff(113746))
            {
                ExposeArmor.Cast();
                return;
            }
            if (SinisterStrike.KnownSpell && SinisterStrike.IsSpellUsable && SinisterStrike.IsHostileDistanceGood
                && MySettings.UseHemorrhage)
            {
                SinisterStrike.Cast();
                return;
            }
            if (ArcaneTorrent.IsSpellUsable && ArcaneTorrent.KnownSpell
                && MySettings.UseArcaneTorrentForResource)
            {
                ArcaneTorrent.Cast();
            }
        }
        finally
        {
            Memory.WowMemory.GameFrameUnLock();
        }
    }

    private void Patrolling()
    {
        if (!ObjectManager.Me.IsMounted)
        {
            Buff();
            Heal();
        }
    }

    #region Nested type: RogueSubtletySettings

    [Serializable]
    public class RogueSubtletySettings : Settings
    {
        public bool DoAvoidMelee = false;
        public int DoAvoidMeleeDistance = 0;
        public bool UseAlchFlask = true;
        public bool UseAmbush = true;
        public bool UseArcaneTorrentForDecast = true;
        public int UseArcaneTorrentForDecastAtPercentage = 100;
        public bool UseArcaneTorrentForResource = true;
        public bool UseBerserking = true;
        public bool UseBloodFury = true;
        public bool UseBurstofSpeed = true;
        public bool UseCheapShot = true;
        public bool UseCloakofShadows = true;
        public bool UseCombatReadiness = true;
        public bool UseCrimsonTempest = true;
        public bool UseCripplingPoison = false;
        public bool UseDeadlyPoison = true;
        public bool UseDeadlyThrow = true;
        public bool UseDismantle = true;

        public bool UseEvasion = true;
        public bool UseEviscerate = true;
        public bool UseExposeArmor = false;
        public bool UseFanofKnives = true;
        public bool UseGarrote = true;
        public bool UseGiftoftheNaaru = true;
        public int UseGiftoftheNaaruAtPercentage = 80;
        public bool UseHemorrhage = true;
        public bool UseKick = true;
        public bool UseKidneyShot = true;
        public bool UseLeechingPoison = true;

        public bool UseLowCombat = true;
        public bool UseMindnumbingPoison = true;
        public bool UseParalyticPoison = false;
        public bool UsePremeditation = true;
        public bool UsePreparation = true;
        public bool UseRecuperate = true;
        public bool UseRedirect = true;
        public bool UseRupture = true;
        public bool UseShadowBlades = true;
        public bool UseShadowDance = true;
        public bool UseShadowStep = true;
        public bool UseShiv = true;
        public bool UseShurikenToss = true;
        public bool UseSliceandDice = true;
        public bool UseSmokeBomb = true;
        public bool UseSprint = true;
        public bool UseStealth = false;
        public bool UseStoneform = true;
        public int UseStoneformAtPercentage = 80;
        public bool UseThrow = true;
        public bool UseTrinketOne = true;
        public bool UseTrinketTwo = true;
        public bool UseVanish = true;
        public bool UseWarStomp = true;
        public int UseWarStompAtPercentage = 80;
        public bool UseWoundPoison = false;

        public RogueSubtletySettings()
        {
            ConfigWinForm("Rogue Subtlety Settings");
            /* Professions & Racials */
            AddControlInWinForm("Use Arcane Torrent for Interrupt", "UseArcaneTorrentForDecast", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Arcane Torrent for Resource", "UseArcaneTorrentForResource", "Professions & Racials");
            AddControlInWinForm("Use Berserking", "UseBerserking", "Professions & Racials");
            AddControlInWinForm("Use Blood Fury", "UseBloodFury", "Professions & Racials");
            AddControlInWinForm("Use Gift of the Naaru", "UseGiftoftheNaaru", "Professions & Racials");

            AddControlInWinForm("Use Stoneform", "UseStoneform", "Professions & Racials");
            AddControlInWinForm("Use War Stomp", "UseWarStomp", "Professions & Racials");
            /* Rogue Buffs */
            AddControlInWinForm("Use Burst of Speed", "UseBurstofSpeed", "Rogue Buffs");
            AddControlInWinForm("Use Crippling Poison", "UseCripplingPoison", "Rogue Buffs");
            AddControlInWinForm("Use Deadly Poison", "UseDeadlyPoison", "Rogue Buffs");
            AddControlInWinForm("Use Leeching Poison", "UseLeechingPoison", "Rogue Buffs");
            AddControlInWinForm("Use Mindnumbing Poison", "UseMindnumbingPoison", "Rogue Buffs");
            AddControlInWinForm("Use Paralytic Poison", "UseParalyticPoison", "Rogue Buffs");
            AddControlInWinForm("Use Slice and Dice", "UseSliceandDice", "Rogue Buffs");
            AddControlInWinForm("Use Sprint", "UseSprint", "Rogue Buffs");
            AddControlInWinForm("Use Stealth", "UseStealth", "Rogue Buffs");
            AddControlInWinForm("Use Wound Poison", "UseWoundPoison", "Rogue Buffs");
            /* Offensive Spell */
            AddControlInWinForm("Use Ambush", "UseAmbush", "Offensive Spell");
            AddControlInWinForm("Use Crimson Tempest", "UseCrimsonTempest", "Offensive Spell");
            AddControlInWinForm("Use Deadly Throw", "UseDeadlyThrow", "Offensive Spell");
            AddControlInWinForm("Use Expose Armor", "UseExposeArmor", "Offensive Spell");
            AddControlInWinForm("Use Fan of Knives", "UseFanofKnives", "Offensive Spell");
            AddControlInWinForm("Use Eviscerate", "UseEviscerate", "Offensive Spell");
            AddControlInWinForm("Use Garrote", "UseGarrote", "Offensive Spell");
            AddControlInWinForm("Use Hemorrhage", "UseHemorrhage", "Offensive Spell");
            AddControlInWinForm("Use Rupture", "UseRupture", "Offensive Spell");
            AddControlInWinForm("Use Shiv", "UseShiv", "Offensive Spell");
            AddControlInWinForm("Use Shuriken Toss", "UseShurikenToss", "Offensive Spell");
            AddControlInWinForm("Use Throw", "UseThrow", "Offensive Spell");
            /* Offensive Cooldown */
            AddControlInWinForm("Use Premeditation", "UsePremeditation", "Offensive Cooldown");
            AddControlInWinForm("Use Redirect", "UseRedirect", "Offensive Cooldown");
            AddControlInWinForm("Use Shadow Blades", "UseShadowBlades", "Offensive Cooldown");
            AddControlInWinForm("Use Shadow Dance", "UseShadowDance", "Offensive Cooldown");
            AddControlInWinForm("Use Shadow Step", "UseShadowStep", "Offensive Cooldown");
            /* Defensive Cooldown */
            AddControlInWinForm("Use CheapShot", "UseCheapShot", "Defensive Cooldown");
            AddControlInWinForm("Use CloakofShadows", "UseCloakofShadows", "Defensive Cooldown");
            AddControlInWinForm("Use CombatReadiness", "UseCombatReadiness", "Defensive Cooldown");
            AddControlInWinForm("Use Dismantle", "UseDismantle", "Defensive Cooldown");
            AddControlInWinForm("Use Evasion", "UseEvasion", "Defensive Cooldown");
            AddControlInWinForm("Use Kick", "UseKick", "Defensive Cooldown");
            AddControlInWinForm("Use KidneyShot", "UseKidneyShot", "Defensive Cooldown");
            AddControlInWinForm("Use Preparation", "UsePreparation", "Defensive Cooldown");
            AddControlInWinForm("Use SmokeBomb", "UseSmokeBomb", "Defensive Cooldown");
            AddControlInWinForm("Use Vanish", "UseVanish", "Defensive Cooldown");
            /* Healing Spell */
            AddControlInWinForm("Use Recuperate", "UseRecuperate", "Healing Spell");
            /* Game Settings */
            AddControlInWinForm("Use Low Combat Settings", "UseLowCombat", "Game Settings");
            AddControlInWinForm("Use Trinket One", "UseTrinketOne", "Game Settings");
            AddControlInWinForm("Use Trinket Two", "UseTrinketTwo", "Game Settings");

            AddControlInWinForm("Use Alchemist Flask", "UseAlchFlask", "Game Settings");
            AddControlInWinForm("Do avoid melee (Off Advised!!)", "DoAvoidMelee", "Game Settings");
            AddControlInWinForm("Avoid melee distance (1 to 4)", "DoAvoidMeleeDistance", "Game Settings");
        }

        public static RogueSubtletySettings CurrentSetting { get; set; }

        public static RogueSubtletySettings GetSettings()
        {
            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Rogue_Subtlety.xml";
            if (File.Exists(currentSettingsFile))
            {
                return
                    CurrentSetting = Load<RogueSubtletySettings>(currentSettingsFile);
            }
            return new RogueSubtletySettings();
        }
    }

    #endregion
}

public class RogueAssassination
{
    private static RogueAssassinationSettings MySettings = RogueAssassinationSettings.GetSettings();

    #region General Timers & Variables

    private readonly WoWItem _firstTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET);
    private readonly WoWItem _secondTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET, 2);
    public uint CP = 0;
    public int LC = 0;

    private Timer _onCd = new Timer(0);

    #endregion

    #region Professions & Racials

    public readonly Spell Alchemy = new Spell("Alchemy");
    public readonly Spell ArcaneTorrent = new Spell("Arcane Torrent");
    public readonly Spell Berserking = new Spell("Berserking");
    public readonly Spell BloodFury = new Spell("Blood Fury");

    public readonly Spell GiftoftheNaaru = new Spell("Gift of the Naaru");

    public readonly Spell Stoneform = new Spell("Stoneform");
    public readonly Spell WarStomp = new Spell("War Stomp");

    #endregion

    #region Rogue Buffs

    public readonly Spell BurstofSpeed = new Spell("Burst of Speed");
    public readonly Spell CripplingPoison = new Spell("Crippling Poison");
    public readonly Spell DeadlyPoison = new Spell("Deadly Poison");
    public readonly Spell LeechingPoison = new Spell("Leeching Poison");
    public readonly Spell MindnumbingPoison = new Spell("Mind-numbing Poison");
    public readonly Spell ParalyticPoison = new Spell("Paralytic Poison");
    public readonly Spell SliceandDice = new Spell("Slice and Dice");
    public readonly Spell Sprint = new Spell("Sprint");
    public readonly Spell Stealth = new Spell("Stealth");
    public readonly Spell WoundPoison = new Spell("Wound Poison");
    private Timer _sliceandDiceTimer = new Timer(0);

    #endregion

    #region Offensive Spell

    public readonly Spell Ambush = new Spell("Ambush");
    public readonly Spell CrimsonTempest = new Spell("Crimson Tempest");
    public readonly Spell DeadlyThrow = new Spell("Deadly Throw");
    public readonly Spell Dispatch = new Spell("Dispatch");
    public readonly Spell Envenom = new Spell("Envenom");
    public readonly Spell Eviscerate = new Spell("Eviscerate");
    public readonly Spell ExposeArmor = new Spell("Expose Armor");
    public readonly Spell FanofKnives = new Spell("Fan of Knives");
    public readonly Spell Garrote = new Spell("Garrote");
    public readonly Spell Mutilate = new Spell("Mutilate");
    public readonly Spell Rupture = new Spell("Rupture");
    public readonly Spell Shiv = new Spell("Shiv");
    public readonly Spell ShurikenToss = new Spell("Shuriken Toss");
    public readonly Spell SinisterStrike = new Spell("Sinister Strike");
    public readonly Spell Throw = new Spell("Throw");
    private Timer _ruptureTimer = new Timer(0);

    #endregion

    #region Offensive Cooldown

    public readonly Spell Redirect = new Spell("Redirect");
    public readonly Spell ShadowBlades = new Spell("Shadow Blades");
    public readonly Spell ShadowStep = new Spell("Shadow Step");
    public readonly Spell Vendetta = new Spell("Vendetta");

    #endregion

    #region Defensive Cooldown

    public readonly Spell CheapShot = new Spell("Cheap Shot");
    public readonly Spell CloakofShadows = new Spell("Cloak of Shadows");
    public readonly Spell CombatReadiness = new Spell("Combat Readiness");
    public readonly Spell Dismantle = new Spell("Dismantle");
    public readonly Spell Evasion = new Spell("Evasion");
    public readonly Spell Kick = new Spell("Kick");
    public readonly Spell KidneyShot = new Spell("Kidney Shot");
    public readonly Spell Preparation = new Spell("Preparation");
    public readonly Spell SmokeBomb = new Spell("Smoke Bomb");
    public readonly Spell Vanish = new Spell("Vanish");
/*
        private Timer _dismantleTimer = new Timer(0);
*/

    #endregion

    #region Healing Spell

    public readonly Spell Recuperate = new Spell("Recuperate");

    #endregion

    public RogueAssassination()
    {
        Main.InternalRange = ObjectManager.Me.GetCombatReach;
        MySettings = RogueAssassinationSettings.GetSettings();
        Main.DumpCurrentSettings<RogueAssassinationSettings>(MySettings);
        UInt128 lastTarget = 0;

        while (Main.InternalLoop)
        {
            try
            {
                if (!ObjectManager.Me.IsDeadMe)
                {
                    if (!ObjectManager.Me.IsMounted)
                    {
                        if (Fight.InFight && ObjectManager.Me.Target > 0)
                        {
                            if (ObjectManager.Me.Target != lastTarget
                                && (Throw.IsHostileDistanceGood || CheapShot.IsHostileDistanceGood))
                            {
                                Pull();
                                lastTarget = ObjectManager.Me.Target;
                            }

                            if (ObjectManager.Target.Level < 70 && ObjectManager.Me.Level > 84
                                && MySettings.UseLowCombat)
                            {
                                LC = 1;
                                if (ObjectManager.Target.GetDistance < 30)
                                    LowCombat();
                            }
                            else
                            {
                                LC = 0;
                                if (ObjectManager.Target.GetDistance < 30)
                                    Combat();
                            }
                        }
                        if (!ObjectManager.Me.IsCast)
                            Patrolling();
                    }
                }
                else
                    Thread.Sleep(500);
            }
            catch
            {
            }
            Thread.Sleep(100);
        }
    }

    private void Pull()
    {
        if (Redirect.IsSpellUsable && Redirect.IsHostileDistanceGood && Redirect.KnownSpell
            && MySettings.UseRedirect && ObjectManager.Me.ComboPoint > 0)
        {
            Redirect.Cast();
            Others.SafeSleep(200);
        }

        if (((Stealth.KnownSpell && Stealth.IsSpellUsable && !Stealth.HaveBuff && MySettings.UseStealth)
             || Stealth.HaveBuff) && LC != 1)
        {
            if (!Stealth.HaveBuff)
            {
                Stealth.Cast();
                Others.SafeSleep(200);
            }

            if (ShadowStep.IsSpellUsable && ShadowStep.IsHostileDistanceGood && ShadowStep.KnownSpell
                && MySettings.UseShadowStep)
            {
                ShadowStep.Cast();
                Others.SafeSleep(200);
            }

            if (Garrote.IsSpellUsable && Garrote.IsHostileDistanceGood && Garrote.KnownSpell
                && MySettings.UseGarrote)
            {
                Garrote.Cast();
                return;
            }
            if (CheapShot.IsSpellUsable && CheapShot.IsHostileDistanceGood && CheapShot.KnownSpell
                && MySettings.UseCheapShot)
            {
                CheapShot.Cast();
                return;
            }
            return;
        }
        if (ShurikenToss.IsSpellUsable && ShurikenToss.IsHostileDistanceGood && ShurikenToss.KnownSpell
            && MySettings.UseShurikenToss && !MySettings.UseStealth)
        {
            ShurikenToss.Cast();
            return;
        }
        if (Throw.IsSpellUsable && Throw.IsHostileDistanceGood && Throw.KnownSpell
            && MySettings.UseThrow && !MySettings.UseStealth)
        {
            MovementManager.StopMove();
            Throw.Cast();
            Others.SafeSleep(1000);
        }
    }

    private void LowCombat()
    {
        Buff();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        DefenseCycle();
        Heal();

        if (Throw.IsSpellUsable && Throw.IsHostileDistanceGood && Throw.KnownSpell && !ObjectManager.Target.InCombat
            && MySettings.UseThrow)
        {
            Throw.Cast();
            return;
        }
        // Blizzard API Calls for Envenom using Eviscerate Function
        if (Eviscerate.KnownSpell && Eviscerate.IsSpellUsable && Eviscerate.IsHostileDistanceGood
            && MySettings.UseEnvenom && (ObjectManager.Me.ComboPoint > 4
                                         || (SliceandDice.HaveBuff && _sliceandDiceTimer.IsReady)))
        {
            Eviscerate.Cast();
            if (SliceandDice.HaveBuff)
                _sliceandDiceTimer = new Timer(1000*(6 + (5*6)));
            return;
        }
        // Blizzard API Calls for Dispatch using Sinister Strike Function
        if (SinisterStrike.KnownSpell && SinisterStrike.IsSpellUsable && SinisterStrike.IsHostileDistanceGood
            && MySettings.UseDispatch)
        {
            SinisterStrike.Cast();
            return;
        }
        if (SliceandDice.KnownSpell && SliceandDice.IsSpellUsable && SliceandDice.IsHostileDistanceGood
            && MySettings.UseSliceandDice && !SliceandDice.HaveBuff)
        {
            CP = ObjectManager.Me.ComboPoint;
            SliceandDice.Cast();
            _sliceandDiceTimer = new Timer(1000*(6 + (CP*6)));
            return;
        }
        if (Mutilate.KnownSpell && Mutilate.IsSpellUsable && ObjectManager.Target.HealthPercent > 35
            && MySettings.UseMutilate && Mutilate.IsHostileDistanceGood)
        {
            Mutilate.Cast();
            return;
        }
        if (FanofKnives.KnownSpell && FanofKnives.IsSpellUsable && FanofKnives.IsHostileDistanceGood
            && MySettings.UseFanofKnives)
        {
            FanofKnives.Cast();
        }
    }

    private void Combat()
    {
        Buff();
        DPSBurst();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        DPSCycle();
        Decast();
        if (_onCd.IsReady)
            DefenseCycle();
        Heal();
    }

    private void Buff()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (MySettings.UseDeadlyPoison && DeadlyPoison.KnownSpell && DeadlyPoison.IsSpellUsable
            && !DeadlyPoison.HaveBuff)
        {
            DeadlyPoison.Cast();
            return;
        }
        if (!WoundPoison.HaveBuff && WoundPoison.KnownSpell && WoundPoison.IsSpellUsable
            && MySettings.UseWoundPoison && !DeadlyPoison.HaveBuff)
        {
            WoundPoison.Cast();
            return;
        }
        if (!LeechingPoison.HaveBuff && LeechingPoison.KnownSpell && LeechingPoison.IsSpellUsable
            && MySettings.UseLeechingPoison)
        {
            LeechingPoison.Cast();
            return;
        }
        if (!ParalyticPoison.HaveBuff && ParalyticPoison.KnownSpell && ParalyticPoison.IsSpellUsable
            && MySettings.UseParalyticPoison && !LeechingPoison.HaveBuff)
        {
            ParalyticPoison.Cast();
            return;
        }
        if (!CripplingPoison.HaveBuff && CripplingPoison.KnownSpell && CripplingPoison.IsSpellUsable
            && MySettings.UseCripplingPoison && !LeechingPoison.HaveBuff && ParalyticPoison.HaveBuff)
        {
            CripplingPoison.Cast();
            return;
        }
        if (!MindnumbingPoison.HaveBuff && MindnumbingPoison.KnownSpell && MindnumbingPoison.IsSpellUsable
            && MySettings.UseMindnumbingPoison && !CripplingPoison.HaveBuff && !ParalyticPoison.HaveBuff
            && !LeechingPoison.HaveBuff)
        {
            MindnumbingPoison.Cast();
            return;
        }
        if (!ObjectManager.Me.InCombat && BurstofSpeed.IsSpellUsable && BurstofSpeed.KnownSpell
            && MySettings.UseBurstofSpeed && ObjectManager.Me.GetMove)
        {
            BurstofSpeed.Cast();
            return;
        }
        if (!ObjectManager.Me.InCombat && Sprint.IsSpellUsable && Sprint.KnownSpell
            && MySettings.UseSprint && ObjectManager.Me.GetMove)
        {
            Sprint.Cast();
            return;
        }
        if (MySettings.UseAlchFlask && !ObjectManager.Me.HaveBuff(79638) && !ObjectManager.Me.HaveBuff(79640) && !ObjectManager.Me.HaveBuff(79639) &&
            !ItemsManager.IsItemOnCooldown(75525) && ItemsManager.GetItemCount(75525) > 0)
        {
            ItemsManager.UseItem(75525);
        }
    }

    private void AvoidMelee()
    {
        if (ObjectManager.Target.GetDistance < MySettings.DoAvoidMeleeDistance && ObjectManager.Target.InCombat)
        {
            Logging.WriteFight("Too Close. Moving Back");
            var maxTimeTimer = new Timer(1000*2);
            MovementsAction.MoveBackward(true);
            while (ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat && !maxTimeTimer.IsReady)
                Others.SafeSleep(300);
            MovementsAction.MoveBackward(false);
            if (maxTimeTimer.IsReady && ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat)
            {
                MovementsAction.MoveForward(true);
                Others.SafeSleep(1000);
                MovementsAction.MoveForward(false);
                MovementManager.Face(ObjectManager.Target.Position);
            }
        }
    }

    private void DefenseCycle()
    {
        if (ObjectManager.Me.HealthPercent <= 80 && !KidneyShot.TargetHaveBuff && KidneyShot.KnownSpell
            && KidneyShot.IsSpellUsable && KidneyShot.IsHostileDistanceGood && ObjectManager.Me.ComboPoint <= 3
            && Recuperate.HaveBuff && MySettings.UseKidneyShot)
        {
            CP = ObjectManager.Me.ComboPoint;
            KidneyShot.Cast();
            _onCd = new Timer(1000*CP);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= 80 && Evasion.KnownSpell && Evasion.IsSpellUsable
            && MySettings.UseEvasion)
        {
            Evasion.Cast();
            _onCd = new Timer(1000*15);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= 90 && CombatReadiness.KnownSpell && CombatReadiness.IsSpellUsable
            && MySettings.UseCombatReadiness)
        {
            CombatReadiness.Cast();
            _onCd = new Timer(1000*20);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= 95 && Dismantle.KnownSpell && Dismantle.IsSpellUsable
            && MySettings.UseDismantle)
        {
            Dismantle.Cast();
            //_dismantleTimer = new Timer(1000*60);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseWarStompAtPercentage && WarStomp.IsSpellUsable &&
            WarStomp.KnownSpell
            && MySettings.UseWarStomp)
        {
            WarStomp.Cast();
            _onCd = new Timer(1000*2);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseStoneformAtPercentage && Stoneform.IsSpellUsable &&
            Stoneform.KnownSpell
            && MySettings.UseStoneform)
        {
            Stoneform.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (ObjectManager.GetNumberAttackPlayer() >= 3 && Vanish.KnownSpell && Vanish.IsSpellUsable
            && MySettings.UseVanish)
        {
            Vanish.Cast();
            Others.SafeSleep(5000);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= 70 && Preparation.KnownSpell && Preparation.IsSpellUsable
            && MySettings.UsePreparation && !Evasion.IsSpellUsable)
        {
            Preparation.Cast();
        }
    }

    private void Heal()
    {
        if (ObjectManager.Me.IsMounted)
            return;
        if (ObjectManager.Me.HealthPercent <= MySettings.UseGiftoftheNaaruAtPercentage && GiftoftheNaaru.KnownSpell &&
            GiftoftheNaaru.IsSpellUsable
            && MySettings.UseGiftoftheNaaru)
        {
            GiftoftheNaaru.Cast();
            return;
        }
        if (!Recuperate.HaveBuff && ObjectManager.Me.ComboPoint > 1 && MySettings.UseRecuperate
            && ObjectManager.Me.HealthPercent <= 90 && Recuperate.KnownSpell && Recuperate.IsSpellUsable)
        {
            Recuperate.Cast();
        }
    }

    private void Decast()
    {
        if (ObjectManager.Target.IsCast && Kick.KnownSpell && Kick.IsSpellUsable
            && Kick.IsHostileDistanceGood && MySettings.UseKick && ObjectManager.Target.IsTargetingMe)
        {
            Kick.Cast();
            return;
        }
        if (ArcaneTorrent.IsSpellUsable && ArcaneTorrent.KnownSpell && ObjectManager.Target.GetDistance < 8
            && ObjectManager.Me.HealthPercent <= MySettings.UseArcaneTorrentForDecastAtPercentage
            && MySettings.UseArcaneTorrentForDecast && ObjectManager.Target.IsCast &&
            ObjectManager.Target.IsTargetingMe)
        {
            ArcaneTorrent.Cast();
            return;
        }
        if (ObjectManager.Target.IsCast && CloakofShadows.KnownSpell && CloakofShadows.IsSpellUsable
            && ObjectManager.Target.IsTargetingMe && MySettings.UseCloakofShadows)
        {
            CloakofShadows.Cast();
            return;
        }
        if (ObjectManager.Target.IsCast && SmokeBomb.KnownSpell && SmokeBomb.IsSpellUsable
            && ObjectManager.Target.IsTargetingMe && MySettings.UseSmokeBomb
            && !CloakofShadows.HaveBuff)
        {
            SmokeBomb.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent <= 70 && Preparation.KnownSpell && Preparation.IsSpellUsable
            && MySettings.UsePreparation && !CloakofShadows.IsSpellUsable && ObjectManager.Target.IsCast
            && ObjectManager.Target.IsTargetingMe)
        {
            Preparation.Cast();
        }
    }

    private void DPSBurst()
    {
        if (MySettings.UseTrinketOne && !ItemsManager.IsItemOnCooldown(_firstTrinket.Entry) && ItemsManager.IsItemUsable(_firstTrinket.Entry))
        {
            ItemsManager.UseItem(_firstTrinket.Name);
            Logging.WriteFight("Use First Trinket Slot");
        }

        if (MySettings.UseTrinketTwo && !ItemsManager.IsItemOnCooldown(_secondTrinket.Entry) && ItemsManager.IsItemUsable(_secondTrinket.Entry))
        {
            ItemsManager.UseItem(_secondTrinket.Name);
            Logging.WriteFight("Use Second Trinket Slot");
            return;
        }
        if (Berserking.IsSpellUsable && Berserking.KnownSpell && ObjectManager.Target.GetDistance < 30
            && MySettings.UseBerserking)
        {
            Berserking.Cast();
            return;
        }
        if (BloodFury.IsSpellUsable && BloodFury.KnownSpell && ObjectManager.Target.GetDistance < 30
            && MySettings.UseBloodFury)
        {
            BloodFury.Cast();
            return;
        }
        if (Vendetta.KnownSpell && Vendetta.IsSpellUsable
            && MySettings.UseVendetta && Vendetta.IsHostileDistanceGood)
        {
            Vendetta.Cast();
            return;
        }
        if (ShadowBlades.KnownSpell && ShadowBlades.IsSpellUsable
            && MySettings.UseShadowBlades && ObjectManager.Target.GetDistance < 30)
        {
            ShadowBlades.Cast();
        }
    }

    private void DPSCycle()
    {
        Usefuls.SleepGlobalCooldown();
        try
        {
            Memory.WowMemory.GameFrameLock(); // !!! WARNING - DONT SLEEP WHILE LOCKED - DO FINALLY(GameFrameUnLock()) !!!

            if (Mutilate.KnownSpell && Mutilate.IsSpellUsable && MySettings.UseMutilate
                && Mutilate.IsHostileDistanceGood && MySettings.UseShadowFocus && !ObjectManager.Target.InCombat
                && (Stealth.HaveBuff || ObjectManager.Me.HaveBuff(115192)))
            {
                Mutilate.Cast();
                return;
            }

            if (Garrote.IsSpellUsable && Garrote.IsHostileDistanceGood && Garrote.KnownSpell
                && MySettings.UseGarrote && ObjectManager.Me.HaveBuff(115192))
            {
                Garrote.Cast();
                return;
            }

            if (Throw.IsSpellUsable && Throw.IsHostileDistanceGood && Throw.KnownSpell && !ObjectManager.Target.InCombat
                && MySettings.UseThrow)
            {
                Throw.Cast();
                return;
            }

            if (Eviscerate.KnownSpell && Eviscerate.IsSpellUsable && Eviscerate.IsHostileDistanceGood
                && MySettings.UseEnvenom && (ObjectManager.Me.ComboPoint > 4
                                             || (SliceandDice.HaveBuff && _sliceandDiceTimer.IsReady)))
            {
                Eviscerate.Cast();
                if (SliceandDice.HaveBuff)
                    _sliceandDiceTimer = new Timer(1000*(6 + (5*6)));
                return;
            }
            if (SinisterStrike.KnownSpell && SinisterStrike.IsSpellUsable && SinisterStrike.IsHostileDistanceGood
                && MySettings.UseDispatch)
            {
                SinisterStrike.Cast();
                return;
            }
            if (SliceandDice.KnownSpell && SliceandDice.IsSpellUsable && SliceandDice.IsHostileDistanceGood
                && MySettings.UseSliceandDice && !SliceandDice.HaveBuff)
            {
                CP = ObjectManager.Me.ComboPoint;
                SliceandDice.Cast();
                _sliceandDiceTimer = new Timer(1000*(6 + (CP*6)));
                return;
            }
            if (Rupture.KnownSpell && Rupture.IsHostileDistanceGood && Rupture.IsSpellUsable
                && MySettings.UseRupture && (!Rupture.TargetHaveBuff || _ruptureTimer.IsReady))
            {
                CP = ObjectManager.Me.ComboPoint;
                Rupture.Cast();
                _ruptureTimer = new Timer(1000*(4 + (CP*4)));
                return;
            }
            if (ExposeArmor.IsSpellUsable && ExposeArmor.IsHostileDistanceGood && ExposeArmor.KnownSpell
                && MySettings.UseExposeArmor && !ObjectManager.Target.HaveBuff(113746))
            {
                ExposeArmor.Cast();
                return;
            }
            if (Mutilate.KnownSpell && Mutilate.IsSpellUsable && ObjectManager.Target.HealthPercent > 35
                && MySettings.UseMutilate && Mutilate.IsHostileDistanceGood)
            {
                Mutilate.Cast();
                return;
            }
            if (ArcaneTorrent.IsSpellUsable && ArcaneTorrent.KnownSpell
                && MySettings.UseArcaneTorrentForResource)
            {
                ArcaneTorrent.Cast();
            }
        }
        finally
        {
            Memory.WowMemory.GameFrameUnLock();
        }
    }

    private void Patrolling()
    {
        if (!ObjectManager.Me.IsMounted)
        {
            Buff();
            Heal();
        }
    }

    #region Nested type: RogueAssassinationSettings

    [Serializable]
    public class RogueAssassinationSettings : Settings
    {
        public bool DoAvoidMelee = false;
        public int DoAvoidMeleeDistance = 0;
        public bool UseAlchFlask = true;
        public bool UseAmbush = true;
        public bool UseArcaneTorrentForDecast = true;
        public int UseArcaneTorrentForDecastAtPercentage = 100;
        public bool UseArcaneTorrentForResource = true;
        public bool UseBerserking = true;
        public bool UseBloodFury = true;
        public bool UseBurstofSpeed = true;
        public bool UseCheapShot = true;
        public bool UseCloakofShadows = true;
        public bool UseCombatReadiness = true;
        public bool UseCrimsonTempest = true;
        public bool UseCripplingPoison = false;
        public bool UseDeadlyPoison = true;
        public bool UseDeadlyThrow = true;
        public bool UseDismantle = true;
        public bool UseDispatch = true;

        public bool UseEnvenom = true;
        public bool UseEvasion = true;
        public bool UseExposeArmor = false;
        public bool UseFanofKnives = true;
        public bool UseGarrote = true;
        public bool UseGiftoftheNaaru = true;
        public int UseGiftoftheNaaruAtPercentage = 80;
        public bool UseKick = true;
        public bool UseKidneyShot = true;
        public bool UseLeechingPoison = true;

        public bool UseLowCombat = true;
        public bool UseMindnumbingPoison = true;
        public bool UseMutilate = true;
        public bool UseParalyticPoison = false;
        public bool UsePreparation = true;
        public bool UseRecuperate = true;
        public bool UseRedirect = true;
        public bool UseRupture = true;
        public bool UseShadowBlades = true;
        public bool UseShadowFocus = false;
        public bool UseShadowStep = true;
        public bool UseShiv = true;
        public bool UseShurikenToss = true;
        public bool UseSliceandDice = true;
        public bool UseSmokeBomb = true;
        public bool UseSprint = true;
        public bool UseStealth = false;
        public bool UseStoneform = true;
        public int UseStoneformAtPercentage = 80;
        public bool UseThrow = true;
        public bool UseTrinketOne = true;
        public bool UseTrinketTwo = true;
        public bool UseVanish = true;
        public bool UseVendetta = true;
        public bool UseWarStomp = true;
        public int UseWarStompAtPercentage = 80;
        public bool UseWoundPoison = false;

        public RogueAssassinationSettings()
        {
            ConfigWinForm("Rogue Assassination Settings");
            /* Professions & Racials */
            AddControlInWinForm("Use Arcane Torrent for Interrupt", "UseArcaneTorrentForDecast", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Arcane Torrent for Resource", "UseArcaneTorrentForResource", "Professions & Racials");
            AddControlInWinForm("Use Berserking", "UseBerserking", "Professions & Racials");
            AddControlInWinForm("Use Blood Fury", "UseBloodFury", "Professions & Racials");
            AddControlInWinForm("Use Gift of the Naaru", "UseGiftoftheNaaru", "Professions & Racials");

            AddControlInWinForm("Use Stoneform", "UseStoneform", "Professions & Racials");
            AddControlInWinForm("Use War Stomp", "UseWarStomp", "Professions & Racials");
            /* Rogue Buffs */
            AddControlInWinForm("Use Burst of Speed", "UseBurstofSpeed", "Rogue Buffs");
            AddControlInWinForm("Use Crippling Poison", "UseCripplingPoison", "Rogue Buffs");
            AddControlInWinForm("Use Deadly Poison", "UseDeadlyPoison", "Rogue Buffs");
            AddControlInWinForm("Use Leeching Poison", "UseLeechingPoison", "Rogue Buffs");
            AddControlInWinForm("Use Mindnumbing Poison", "UseMindnumbingPoison", "Rogue Buffs");
            AddControlInWinForm("Use Paralytic Poison", "UseParalyticPoison", "Rogue Buffs");
            AddControlInWinForm("Use Slice and Dice", "UseSliceandDice", "Rogue Buffs");
            AddControlInWinForm("Use Sprint", "UseSprint", "Rogue Buffs");
            AddControlInWinForm("Use Stealth", "UseStealth", "Rogue Buffs");
            AddControlInWinForm("Use Wound Poison", "UseWoundPoison", "Rogue Buffs");
            /* Offensive Spell */
            AddControlInWinForm("Use Ambush", "UseAmbush", "Offensive Spell");
            AddControlInWinForm("Use Crimson Tempest", "UseCrimsonTempest", "Offensive Spell");
            AddControlInWinForm("Use Deadly Throw", "UseDeadlyThrow", "Offensive Spell");
            AddControlInWinForm("Use Dispatch", "UseDispatch", "Offensive Spell");
            AddControlInWinForm("Use Envenom", "UseEnvenom", "Offensive Spell");
            AddControlInWinForm("Use Expose Armor", "UseExposeArmor", "Offensive Spell");
            AddControlInWinForm("Use Fan of Knives", "UseFanofKnives", "Offensive Spell");
            AddControlInWinForm("Use Garrote", "UseGarrote", "Offensive Spell");
            AddControlInWinForm("Use Mutilate", "UseMutilate", "Offensive Spell");
            AddControlInWinForm("Use Rupture", "UseRupture", "Offensive Spell");
            AddControlInWinForm("Use Shiv", "UseShiv", "Offensive Spell");
            AddControlInWinForm("Use Shuriken Toss", "UseShurikenToss", "Offensive Spell");
            AddControlInWinForm("Use Throw", "UseThrow", "Offensive Spell");
            /* Offensive Cooldown */
            AddControlInWinForm("Use Redirect", "UseRedirect", "Offensive Cooldown");
            AddControlInWinForm("Use Shadow Blades", "UseShadowBlades", "Offensive Cooldown");
            AddControlInWinForm("Use Shadow Step", "UseShadowStep", "Offensive Cooldown");
            AddControlInWinForm("Use Vendetta", "UseVendetta", "Offensive Cooldown");
            /* Defensive Cooldown */
            AddControlInWinForm("Use CheapShot", "UseCheapShot", "Defensive Cooldown");
            AddControlInWinForm("Use CloakofShadows", "UseCloakofShadows", "Defensive Cooldown");
            AddControlInWinForm("Use CombatReadiness", "UseCombatReadiness", "Defensive Cooldown");
            AddControlInWinForm("Use Dismantle", "UseDismantle", "Defensive Cooldown");
            AddControlInWinForm("Use Evasion", "UseEvasion", "Defensive Cooldown");
            AddControlInWinForm("Use Kick", "UseKick", "Defensive Cooldown");
            AddControlInWinForm("Use KidneyShot", "UseKidneyShot", "Defensive Cooldown");
            AddControlInWinForm("Use Preparation", "UsePreparation", "Defensive Cooldown");
            AddControlInWinForm("Use SmokeBomb", "UseSmokeBomb", "Defensive Cooldown");
            AddControlInWinForm("Use Vanish", "UseVanish", "Defensive Cooldown");
            /* Healing Spell */
            AddControlInWinForm("Use Recuperate", "UseRecuperate", "Healing Spell");
            /* Game Settings */
            AddControlInWinForm("Use Low Combat Settings", "UseLowCombat", "Game Settings");
            AddControlInWinForm("Use Trinket One", "UseTrinketOne", "Game Settings");
            AddControlInWinForm("Use Trinket Two", "UseTrinketTwo", "Game Settings");

            AddControlInWinForm("Use Alchemist Flask", "UseAlchFlask", "Game Settings");
            AddControlInWinForm("Use Shadow Focus Talent?", "UseShadowFocus", "Game Settings");
            AddControlInWinForm("Do avoid melee (Off Advised!!)", "DoAvoidMelee", "Game Settings");
            AddControlInWinForm("Avoid melee distance (1 to 4)", "DoAvoidMeleeDistance", "Game Settings");
        }

        public static RogueAssassinationSettings CurrentSetting { get; set; }

        public static RogueAssassinationSettings GetSettings()
        {
            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Rogue_Assassination.xml";
            if (File.Exists(currentSettingsFile))
            {
                return
                    CurrentSetting = Load<RogueAssassinationSettings>(currentSettingsFile);
            }
            return new RogueAssassinationSettings();
        }
    }

    #endregion
}

#endregion

#region Warrior

public class WarriorArms
{
    private static WarriorArmsSettings MySettings = WarriorArmsSettings.GetSettings();

    #region General Timers & Variables

    private readonly WoWItem _firstTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET);
    private readonly WoWItem _secondTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET, 2);
    public int LC = 0;

    private Timer _onCd = new Timer(0);

    #endregion

    #region Professions & Racials

    public readonly Spell Alchemy = new Spell("Alchemy");
    public readonly Spell ArcaneTorrent = new Spell("Arcane Torrent");
    public readonly Spell Berserking = new Spell("Berserking");
    public readonly Spell BloodFury = new Spell("Blood Fury");

    public readonly Spell GiftoftheNaaru = new Spell("Gift of the Naaru");

    public readonly Spell Stoneform = new Spell("Stoneform");
    public readonly Spell WarStomp = new Spell("War Stomp");

    #endregion

    #region Warrior Buffs

    public readonly Spell BattleShout = new Spell("Battle Shout");
    public readonly Spell BattleStance = new Spell("Battle Stance");
    public readonly Spell BerserkerStance = new Spell("Berserker Stance");
    public readonly Spell CommandingShout = new Spell("Commanding Shout");
    public readonly Spell DefensiveStance = new Spell("Defensive Stance");

    public readonly Spell SuddenDeath = new Spell("Sudden Death");

    #endregion

    #region Offensive Spell

    public readonly Spell Rend = new Spell("Rend");
    public readonly Spell Ravager = new Spell("Ravager");
    public readonly Spell Avatar = new Spell("Avatar");
    public readonly Spell Bladestorm = new Spell("Bladestorm");
    public readonly Spell Bloodbath = new Spell("Bloodbath");
    public readonly Spell Charge = new Spell("Charge");
    public readonly Spell Cleave = new Spell("Cleave");
    public readonly Spell ColossusSmash = new Spell("Colossus Smash");
    public readonly Spell DragonRoar = new Spell("Dragon Roar");
    public readonly Spell Execute = new Spell("Execute");
    public readonly Spell HeroicLeap = new Spell("Heroic Leap");
    public readonly Spell HeroicStrike = new Spell("Heroic Strike");
    public readonly Spell HeroicThrow = new Spell("Heroic Throw");
    public readonly Spell ImpendingVictory = new Spell("Impending Victory");
    public readonly Spell MortalStrike = new Spell("Mortal Strike");
    public readonly Spell Overpower = new Spell("Overpower");
    public readonly Spell Shockwave = new Spell("Shockwave");
    public readonly Spell Siegebreaker = new Spell("Siegebreaker");
    public readonly Spell Slam = new Spell("Slam");
    public readonly Spell StormBolt = new Spell("Storm Bolt");
    public readonly Spell Taunt = new Spell("Taunt");
    public readonly Spell ThunderClap = new Spell("Thunder Clap");
    public readonly Spell Whirlwind = new Spell("Whirlwind");

    #endregion

    #region Offensive Cooldown

    public readonly Spell BerserkerRage = new Spell("Berserker Rage");
    public readonly Spell DeadlyCalm = new Spell("Deadly Calm");
    public readonly Spell Recklessness = new Spell("Recklessness");
    public readonly Spell ShatteringThrow = new Spell("Shattering Throw");
    public readonly Spell SkullBanner = new Spell("Skull Banner");
    public readonly Spell SweepingStrikes = new Spell("Sweeping Strikes");

    #endregion

    #region Defensive Cooldown

    public readonly Spell DemoralizingBanner = new Spell("Demoralizing Banner");
    public readonly Spell DiebytheSword = new Spell("Die by the Sword");
    public readonly Spell Disarm = new Spell("Disarm");
    public readonly Spell DisruptingShout = new Spell("Disrupting Shout");
    public readonly Spell Hamstring = new Spell("Hamstring");
    public readonly Spell IntimidatingShout = new Spell("Intimidating Shout");
    public readonly Spell MassSpellReflection = new Spell("Mass Spell Reflection");
    public readonly Spell PiercingHowl = new Spell("Piercing Howl");
    public readonly Spell Pummel = new Spell("Pummel");
    public readonly Spell StaggeringShout = new Spell("Staggering Shout");
    private Timer _disarmTimer = new Timer(0);

    #endregion

    #region Healing Spell

    public readonly Spell EnragedRegeneration = new Spell("Enraged Regeneration");
    public readonly Spell RallyingCry = new Spell("Rallying Cry");
    public readonly Spell VictoryRush = new Spell("Victory Rush");

    #endregion

    public WarriorArms()
    {
        Main.InternalRange = ObjectManager.Me.GetCombatReach;
        MySettings = WarriorArmsSettings.GetSettings();
        Main.DumpCurrentSettings<WarriorArmsSettings>(MySettings);
        UInt128 lastTarget = 0;

        while (Main.InternalLoop)
        {
            try
            {
                if (!ObjectManager.Me.IsDeadMe)
                {
                    if (!ObjectManager.Me.IsMounted)
                    {
                        if (Fight.InFight && ObjectManager.Me.Target > 0)
                        {
                            if (ObjectManager.Me.Target != lastTarget
                                && Taunt.IsHostileDistanceGood)
                            {
                                Pull();
                                lastTarget = ObjectManager.Me.Target;
                            }

                            if (ObjectManager.Target.Level < 70 && ObjectManager.Me.Level > 84
                                && MySettings.UseLowCombat)
                            {
                                LC = 1;
                                if (ObjectManager.Target.GetDistance < 30)
                                    LowCombat();
                            }
                            else
                            {
                                LC = 0;
                                if (ObjectManager.Target.GetDistance < 30)
                                    Combat();
                            }
                        }
                        if (!ObjectManager.Me.IsCast)
                            Patrolling();
                    }
                }
                else
                    Thread.Sleep(500);
            }
            catch
            {
            }
            Thread.Sleep(100);
        }
    }

    private void Pull()
    {
        if (HeroicLeap.IsHostileDistanceGood && HeroicLeap.KnownSpell && HeroicLeap.IsSpellUsable
            && MySettings.UseHeroicLeap)
        {
            SpellManager.CastSpellByIDAndPosition(6544, ObjectManager.Target.Position);
            Others.SafeSleep(200);
        }

        if (Taunt.IsHostileDistanceGood && Taunt.KnownSpell && Taunt.IsSpellUsable
            && MySettings.UseTaunt && ObjectManager.Target.GetDistance > 20)
        {
            Taunt.Cast();
        }
    }

    private void LowCombat()
    {
        Buff();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        DefenseCycle();
        Heal();

        if (HeroicThrow.KnownSpell && HeroicThrow.IsSpellUsable && HeroicThrow.IsHostileDistanceGood
            && MySettings.UseHeroicThrow && !ObjectManager.Target.InCombat)
        {
            HeroicThrow.Cast();
            return;
        }

        if (Charge.KnownSpell && Charge.IsSpellUsable && Charge.IsHostileDistanceGood
            && MySettings.UseCharge && ObjectManager.Target.GetDistance > Main.InternalRange)
        {
            Charge.Cast();
            return;
        }

        if (MortalStrike.KnownSpell && MortalStrike.IsSpellUsable && MortalStrike.IsHostileDistanceGood
            && MySettings.UseMortalStrike)
        {
            MortalStrike.Cast();
            return;
        }
        if (ColossusSmash.KnownSpell && ColossusSmash.IsHostileDistanceGood && ColossusSmash.IsSpellUsable
            && MySettings.UseColossusSmash)
        {
            ColossusSmash.Cast();
            return;
        }
        if (HeroicStrike.KnownSpell && HeroicStrike.IsSpellUsable && HeroicStrike.IsHostileDistanceGood
            && MySettings.UseHeroicStrike && ObjectManager.GetNumberAttackPlayer() < 3
            && (ObjectManager.Me.RagePercentage > 90 || ObjectManager.Me.HaveBuff(125831)))
        {
            if (DeadlyCalm.KnownSpell && DeadlyCalm.IsSpellUsable && MySettings.UseDeadlyCalm)
            {
                DeadlyCalm.Cast();
                Others.SafeSleep(200);
            }

            HeroicStrike.Cast();
            return;
        }
        if (Shockwave.KnownSpell && Shockwave.IsSpellUsable && ObjectManager.Target.GetDistance < 10
            && MySettings.UseShockwave)
        {
            Shockwave.Cast();
            return;
        }
        if (DragonRoar.KnownSpell && DragonRoar.IsSpellUsable && ObjectManager.Target.GetDistance < 8
            && MySettings.UseDragonRoar)
        {
            DragonRoar.Cast();
            return;
        }
        if (Bladestorm.KnownSpell && Bladestorm.IsSpellUsable && ObjectManager.Target.GetDistance < 8
            && MySettings.UseBladestorm)
        {
            Bladestorm.Cast();
            return;
        }

        if (ThunderClap.KnownSpell && ThunderClap.IsSpellUsable && ThunderClap.IsHostileDistanceGood
            && MySettings.UseThunderClap)
        {
            ThunderClap.Cast();
        }
    }

    private void Combat()
    {
        Buff();
        DPSBurst();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        DPSCycle();
        Decast();
        if (_onCd.IsReady)
            DefenseCycle();
        Heal();
    }

    private void Buff()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (ObjectManager.Me.HealthPercent < 30 && MySettings.UseDefensiveStance
            && DefensiveStance.KnownSpell && DefensiveStance.IsSpellUsable && !DefensiveStance.HaveBuff)
        {
            DefensiveStance.Cast();
            return;
        }
        if (!BattleStance.HaveBuff && BattleStance.KnownSpell && BattleStance.IsSpellUsable
            && MySettings.UseBattleStance && ObjectManager.Me.HealthPercent > 50)
        {
            BattleStance.Cast();
            return;
        }
        if (!BerserkerStance.HaveBuff && BerserkerStance.KnownSpell && BerserkerStance.IsSpellUsable
            && MySettings.UseBerserkerStance && !MySettings.UseBattleStance && ObjectManager.Me.HealthPercent > 50)
        {
            BerserkerStance.Cast();
            return;
        }
        if (BattleShout.KnownSpell && BattleShout.IsSpellUsable && !BattleShout.HaveBuff
            && MySettings.UseBattleShout)
        {
            BattleShout.Cast();
            return;
        }
        if (CommandingShout.KnownSpell && CommandingShout.IsSpellUsable && !CommandingShout.HaveBuff
            && MySettings.UseCommandingShout && !MySettings.UseBattleShout)
        {
            CommandingShout.Cast();
            return;
        }
        if (MySettings.UseAlchFlask && !ObjectManager.Me.HaveBuff(79638) && !ObjectManager.Me.HaveBuff(79640) && !ObjectManager.Me.HaveBuff(79639)
            && !ItemsManager.IsItemOnCooldown(75525) && ItemsManager.GetItemCount(75525) > 0)
        {
            ItemsManager.UseItem(75525);
        }
    }

    private void AvoidMelee()
    {
        if (ObjectManager.Target.GetDistance < MySettings.DoAvoidMeleeDistance && ObjectManager.Target.InCombat)
        {
            Logging.WriteFight("Too Close. Moving Back");
            var maxTimeTimer = new Timer(1000*2);
            MovementsAction.MoveBackward(true);
            while (ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat && !maxTimeTimer.IsReady)
                Others.SafeSleep(300);
            MovementsAction.MoveBackward(false);
            if (maxTimeTimer.IsReady && ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat)
            {
                MovementsAction.MoveForward(true);
                Others.SafeSleep(1000);
                MovementsAction.MoveForward(false);
                MovementManager.Face(ObjectManager.Target.Position);
            }
        }
    }

    private void DefenseCycle()
    {
        if (ObjectManager.Me.HealthPercent < 95 && MySettings.UseDisarm && Disarm.IsHostileDistanceGood
            && Disarm.KnownSpell && Disarm.IsSpellUsable && _disarmTimer.IsReady)
        {
            Disarm.Cast();
            _disarmTimer = new Timer(1000*60);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 20 && MySettings.UseIntimidatingShout
            && IntimidatingShout.KnownSpell && IntimidatingShout.IsSpellUsable &&
            ObjectManager.Target.GetDistance < 8)
        {
            IntimidatingShout.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 80 && MySettings.UseDiebytheSword
            && DiebytheSword.KnownSpell && DiebytheSword.IsSpellUsable)
        {
            DiebytheSword.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 80 && MySettings.UseDemoralizingBanner
            && DemoralizingBanner.KnownSpell && DemoralizingBanner.IsSpellUsable &&
            ObjectManager.Target.GetDistance < 30)
        {
            SpellManager.CastSpellByIDAndPosition(114203, ObjectManager.Target.Position);
            _onCd = new Timer(1000*15);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseWarStompAtPercentage && WarStomp.IsSpellUsable &&
            WarStomp.KnownSpell
            && MySettings.UseWarStomp)
        {
            WarStomp.Cast();
            _onCd = new Timer(1000*2);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseStoneformAtPercentage && Stoneform.IsSpellUsable &&
            Stoneform.KnownSpell
            && MySettings.UseStoneform)
        {
            Stoneform.Cast();
            _onCd = new Timer(1000*8);
        }
    }

    private void Heal()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (VictoryRush.KnownSpell && VictoryRush.IsSpellUsable && VictoryRush.IsHostileDistanceGood
            && MySettings.UseVictoryRush && ObjectManager.Me.HealthPercent < 90)
        {
            VictoryRush.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 30 && RallyingCry.IsSpellUsable && RallyingCry.KnownSpell
            && MySettings.UseRallyingCry && ObjectManager.Me.InCombat)
        {
            RallyingCry.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseGiftoftheNaaruAtPercentage &&
            GiftoftheNaaru.IsSpellUsable && GiftoftheNaaru.KnownSpell
            && MySettings.UseGiftoftheNaaru)
        {
            GiftoftheNaaru.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 80 && EnragedRegeneration.IsSpellUsable &&
            EnragedRegeneration.KnownSpell
            && MySettings.UseEnragedRegeneration)
        {
            EnragedRegeneration.Cast();
        }
    }

    private void Decast()
    {
        if (ArcaneTorrent.IsSpellUsable && ArcaneTorrent.KnownSpell && ObjectManager.Target.GetDistance < 8
            && ObjectManager.Me.HealthPercent <= MySettings.UseArcaneTorrentForDecastAtPercentage
            && MySettings.UseArcaneTorrentForDecast && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe)
        {
            ArcaneTorrent.Cast();
            return;
        }
        if (!Hamstring.TargetHaveBuff && MySettings.UseHamstring && Hamstring.KnownSpell
            && Hamstring.IsSpellUsable && Hamstring.IsHostileDistanceGood)
        {
            Hamstring.Cast();
            return;
        }
        if (ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe && Pummel.IsHostileDistanceGood
            && Pummel.KnownSpell && Pummel.IsSpellUsable && MySettings.UsePummel)
        {
            Pummel.Cast();
            return;
        }
        if (ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe &&
            ObjectManager.Target.GetDistance < 10
            && DisruptingShout.KnownSpell && DisruptingShout.IsSpellUsable && MySettings.UseDisruptingShout)
        {
            DisruptingShout.Cast();
            return;
        }
        if (ObjectManager.Target.GetMove && !PiercingHowl.TargetHaveBuff && MySettings.UsePiercingHowl
            && PiercingHowl.KnownSpell && PiercingHowl.IsSpellUsable && ObjectManager.Target.GetDistance < 15)
        {
            PiercingHowl.Cast();
            return;
        }
        if (Hamstring.TargetHaveBuff && MySettings.UseStaggeringShout && StaggeringShout.KnownSpell
            && StaggeringShout.IsSpellUsable && ObjectManager.Target.GetDistance < 20)
        {
            StaggeringShout.Cast();
            return;
        }
        if (ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe &&
            MySettings.UseMassSpellReflection
            && MassSpellReflection.KnownSpell && MassSpellReflection.IsSpellUsable)
        {
            MassSpellReflection.Cast();
        }
    }

    private void DPSBurst()
    {
        if (MySettings.UseTrinketOne && !ItemsManager.IsItemOnCooldown(_firstTrinket.Entry) && ItemsManager.IsItemUsable(_firstTrinket.Entry))
        {
            ItemsManager.UseItem(_firstTrinket.Name);
            Logging.WriteFight("Use First Trinket Slot");
        }

        if (MySettings.UseTrinketTwo && !ItemsManager.IsItemOnCooldown(_secondTrinket.Entry) && ItemsManager.IsItemUsable(_secondTrinket.Entry))
        {
            ItemsManager.UseItem(_secondTrinket.Name);
            Logging.WriteFight("Use Second Trinket Slot");
            return;
        }
        if (Berserking.IsSpellUsable && Berserking.KnownSpell && ObjectManager.Target.GetDistance < 30
            && MySettings.UseBerserking)
        {
            Berserking.Cast();
            return;
        }
        if (BloodFury.IsSpellUsable && BloodFury.KnownSpell && ObjectManager.Target.GetDistance < 30
            && MySettings.UseBloodFury)
        {
            BloodFury.Cast();
            return;
        }
        if (BerserkerRage.KnownSpell && BerserkerRage.IsSpellUsable && ObjectManager.Me.RagePercentage < 50
            && MySettings.UseBerserkerRage && ObjectManager.Target.GetDistance < 30)
        {
            BerserkerRage.Cast();
            return;
        }
        if (Recklessness.KnownSpell && Recklessness.IsSpellUsable && MySettings.UseRecklessness
            && ObjectManager.Target.GetDistance < 30)
        {
            Recklessness.Cast();
            return;
        }
        if (ShatteringThrow.KnownSpell && ShatteringThrow.IsSpellUsable && ShatteringThrow.IsHostileDistanceGood
            && MySettings.UseShatteringThrow)
        {
            ShatteringThrow.Cast();
            return;
        }
        if (SkullBanner.KnownSpell && SkullBanner.IsSpellUsable
            && MySettings.UseSkullBanner && ObjectManager.Target.GetDistance < 30)
        {
            SkullBanner.Cast();
            return;
        }
        if (Avatar.KnownSpell && Avatar.IsSpellUsable
            && MySettings.UseAvatar && ObjectManager.Target.GetDistance < 30)
        {
            Avatar.Cast();
            return;
        }
        if (Bloodbath.KnownSpell && Bloodbath.IsSpellUsable
            && MySettings.UseBloodbath && ObjectManager.Target.GetDistance < 30)
        {
            Bloodbath.Cast();
            return;
        }
        if (DeadlyCalm.KnownSpell && DeadlyCalm.IsSpellUsable && ObjectManager.Me.RagePercentage > 90
            && MySettings.UseDeadlyCalm && HeroicStrike.IsHostileDistanceGood)
        {
            DeadlyCalm.Cast();
            return;
        }
        if (StormBolt.KnownSpell && StormBolt.IsSpellUsable
            && MySettings.UseStormBolt && StormBolt.IsHostileDistanceGood)
        {
            StormBolt.Cast();
            return;
        }

        if (HeroicStrike.KnownSpell && HeroicStrike.IsSpellUsable && HeroicStrike.IsHostileDistanceGood
            && MySettings.UseHeroicStrike && ObjectManager.Me.Level < 10)
        {
            HeroicStrike.Cast();
        }
    }

    private void DPSCycleDuringColossusSmash()
    {
        if (MySettings.UseMortalStrike && MortalStrike.IsSpellUsable && MortalStrike.IsHostileDistanceGood)
        {
            MortalStrike.Cast();
            return;
        }
        if (MySettings.UseStormBolt && ObjectManager.Me.Rage < 70 && StormBolt.IsSpellUsable && StormBolt.IsHostileDistanceGood)
        {
            StormBolt.Cast();
            return;
        }
        if (MySettings.UseThunderClap && ThunderClap.IsSpellUsable && ThunderClap.IsHostileDistanceGood)
        {
            ThunderClap.Cast();
            return;
        }
        if (MySettings.UseWhirlwind && Whirlwind.IsSpellUsable && Whirlwind.IsHostileDistanceGood)
        {
            Whirlwind.Cast();
            return;
        }
    }

    private void DPSCycleExecuteDuringColossusSmash()
    {
        if (MySettings.UseExecute && Execute.IsSpellUsable && Execute.IsHostileDistanceGood)
        {
            Execute.Cast();
        }
        if (MySettings.UseRend && (!Rend.TargetHaveBuffFromMe || ObjectManager.Target.AuraIsActiveAndExpireInLessThanMs(Rend.Id, 5000, true)) && Rend.IsSpellUsable && Rend.IsHostileDistanceGood)
        {
            Rend.Cast();
            return;
        }
        if (MySettings.UseStormBolt && ObjectManager.Me.Rage < 70f && StormBolt.IsSpellUsable && StormBolt.IsHostileDistanceGood)
        {
            StormBolt.Cast();
            return;
        }
        if (MySettings.UseSiegebreaker && ObjectManager.Me.Rage < 70f && Siegebreaker.IsSpellUsable && Siegebreaker.IsHostileDistanceGood)
        {
            Siegebreaker.Cast();
            return;
        }
    }

    private void DPSCycleExecute()
    {
        if (MySettings.UseRend && (!Rend.TargetHaveBuffFromMe || ObjectManager.Target.AuraIsActiveAndExpireInLessThanMs(Rend.Id, 5000, true)) && Rend.IsSpellUsable && Rend.IsHostileDistanceGood)
        {
            Rend.Cast();
            return;
        }
        if (MySettings.UseRavager && Ravager.IsSpellUsable && Ravager.IsHostileDistanceGood)
        {
            Ravager.Cast();
            return;
        }
        if (MySettings.UseColossusSmash && ObjectManager.Me.Rage >= 60f && !ColossusSmash.TargetHaveBuffFromMe && ColossusSmash.IsSpellUsable && ColossusSmash.IsHostileDistanceGood)
        {
            ColossusSmash.Cast();
            return;
        }
        if (MySettings.UseExecute && ObjectManager.Me.Rage >= 60f && Execute.IsSpellUsable && Execute.IsHostileDistanceGood)
        {
            Execute.Cast();
        }
        if (MySettings.UseStormBolt && StormBolt.IsSpellUsable && StormBolt.IsHostileDistanceGood)
        {
            StormBolt.Cast();
            return;
        }
        if (MySettings.UseDragonRoar && DragonRoar.IsSpellUsable && DragonRoar.IsHostileDistanceGood)
        {
            DragonRoar.Cast();
            return;
        }
    }

    private void DPSCycle()
    {
        Usefuls.SleepGlobalCooldown();
        try
        {
            Memory.WowMemory.GameFrameLock(); // !!! WARNING - DONT SLEEP WHILE LOCKED - DO FINALLY(GameFrameUnLock()) !!!

            if (MySettings.UseExecute && SuddenDeath.KnownSpell && SuddenDeath.HaveBuff && Execute.IsSpellUsable && Execute.IsHostileDistanceGood)
            {
                Execute.Cast();
            }
            if (MySettings.UseExecute && ObjectManager.Target.HealthPercent <= 20 && ColossusSmash.KnownSpell && ColossusSmash.TargetHaveBuffFromMe)
            {
                DPSCycleExecuteDuringColossusSmash();
                return;
            }
            if (MySettings.UseExecute && ObjectManager.Target.HealthPercent <= 20)
            {
                DPSCycleExecute();
                return;
            }
            if (ColossusSmash.KnownSpell && ColossusSmash.TargetHaveBuffFromMe)
            {
                DPSCycleDuringColossusSmash();
                return;
            }
            if (MySettings.UseRend && (!Rend.TargetHaveBuffFromMe || ObjectManager.Target.AuraIsActiveAndExpireInLessThanMs(Rend.Id, 5000, true)) && Rend.IsSpellUsable && Rend.IsHostileDistanceGood)
            {
                Rend.Cast();
                return;
            }
            if (MySettings.UseRavager && Ravager.IsSpellUsable && Ravager.IsHostileDistanceGood)
            {
                Ravager.Cast();
                return;
            }
            if (MySettings.UseColossusSmash && ObjectManager.Me.Rage >= 60f && !ColossusSmash.TargetHaveBuffFromMe && ColossusSmash.IsSpellUsable && ColossusSmash.IsHostileDistanceGood)
            {
                ColossusSmash.Cast();
                return;
            }
            if (MySettings.UseMortalStrike && MortalStrike.IsSpellUsable && MortalStrike.IsHostileDistanceGood)
            {
                MortalStrike.Cast();
                return;
            }
            if (MySettings.UseSiegebreaker && Siegebreaker.IsSpellUsable && Siegebreaker.IsHostileDistanceGood)
            {
                Siegebreaker.Cast();
                return;
            }
            if (MySettings.UseStormBolt && StormBolt.IsSpellUsable && StormBolt.IsHostileDistanceGood)
            {
                StormBolt.Cast();
                return;
            }
            if (MySettings.UseDragonRoar && DragonRoar.IsSpellUsable && DragonRoar.IsHostileDistanceGood)
            {
                DragonRoar.Cast();
                return;
            }
            if (MySettings.UseThunderClap && ThunderClap.IsSpellUsable && ThunderClap.IsHostileDistanceGood)
            {
                ThunderClap.Cast();
                return;
            }
            if (MySettings.UseWhirlwind && ObjectManager.Me.Rage >= 40f && Whirlwind.IsSpellUsable && Whirlwind.IsHostileDistanceGood)
            {
                Whirlwind.Cast();
                return;
            }
        }
        finally
        {
            Memory.WowMemory.GameFrameUnLock();
        }
    }

    private void Patrolling()
    {
        if (ObjectManager.Me.IsMounted) return;
        Buff();
        Heal();
    }

    #region Nested type: WarriorArmsSettings

    [Serializable]
    public class WarriorArmsSettings : Settings
    {
        public bool DoAvoidMelee = false;
        public int DoAvoidMeleeDistance = 0;
        public bool UseAlchFlask = true;
        public bool UseArcaneTorrentForDecast = true;
        public int UseArcaneTorrentForDecastAtPercentage = 100;
        public bool UseArcaneTorrentForResource = true;
        public bool UseAvatar = true;
        public bool UseBattleShout = true;
        public bool UseBattleStance = true;
        public bool UseBerserkerRage = true;
        public bool UseBerserkerStance = false;
        public bool UseBerserking = true;
        public bool UseBladestorm = true;
        public bool UseBloodFury = true;
        public bool UseBloodbath = true;
        public bool UseCharge = true;
        public bool UseCleave = true;
        public bool UseColossusSmash = true;
        public bool UseCommandingShout = false;
        public bool UseDeadlyCalm = true;
        public bool UseDefensiveStance = true;
        public bool UseDemoralizingBanner = true;
        public bool UseDiebytheSword = true;
        public bool UseDisarm = true;
        public bool UseDisruptingShout = true;
        public bool UseDragonRoar = true;
        public bool UseEnragedRegeneration = true;
        public bool UseExecute = true;
        public bool UseGiftoftheNaaru = true;
        public int UseGiftoftheNaaruAtPercentage = 80;
        public bool UseHamstring = false;
        public bool UseHeroicLeap = true;
        public bool UseHeroicStrike = true;
        public bool UseHeroicThrow = true;
        public bool UseIntimidatingShout = true;
        public bool UseLowCombat = true;
        public bool UseMassSpellReflection = true;
        public bool UseMortalStrike = true;
        public bool UseOverpower = true;
        public bool UsePiercingHowl = false;
        public bool UsePummel = true;
        public bool UseRavager = true;
        public bool UseRallyingCry = true;
        public bool UseRecklessness = true;
        public bool UseRend = true;
        public bool UseSiegebreaker = true;
        public bool UseShatteringThrow = true;
        public bool UseShockwave = true;
        public bool UseSkullBanner = true;
        public bool UseSlam = true;
        public bool UseStaggeringShout = true;
        public bool UseStoneform = true;
        public int UseStoneformAtPercentage = 80;
        public bool UseStormBolt = true;
        public bool UseSweepingStrikes = true;
        public bool UseTaunt = true;
        public bool UseThunderClap = true;
        public bool UseTrinketOne = true;
        public bool UseTrinketTwo = true;
        public bool UseVictoryRush = true;
        public bool UseWarStomp = true;
        public int UseWarStompAtPercentage = 80;
        public bool UseWhirlwind = true;

        public WarriorArmsSettings()
        {
            ConfigWinForm("Warrior Arms Settings");
            /* Professions & Racials */
            AddControlInWinForm("Use Arcane Torrent for Interrupt", "UseArcaneTorrentForDecast", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Arcane Torrent for Resource", "UseArcaneTorrentForResource", "Professions & Racials");
            AddControlInWinForm("Use Berserking", "UseBerserking", "Professions & Racials");
            AddControlInWinForm("Use Blood Fury", "UseBloodFury", "Professions & Racials");
            AddControlInWinForm("Use Gift of the Naaru", "UseGiftoftheNaaru", "Professions & Racials");
            AddControlInWinForm("Use Stoneform", "UseStoneform", "Professions & Racials");
            AddControlInWinForm("Use War Stomp", "UseWarStomp", "Professions & Racials");
            /* Warrior Buffs */
            AddControlInWinForm("Use Battle Shout", "UseBattleShout", "Warrior Buffs");
            AddControlInWinForm("Use Battle Stance", "UseBattleStance", "Warrior Buffs");
            AddControlInWinForm("Use Berserker Stance", "UseBerserkerStance", "Warrior Buffs");
            AddControlInWinForm("Use Commanding Shout", "UseCommandingShout", "Warrior Buffs");
            AddControlInWinForm("Use Defensive Stance", "UseDefensiveStance", "Warrior Buffs");
            /* Offensive Spell */
            AddControlInWinForm("Use Rend", "UseRend", "Offensive Spell");
            AddControlInWinForm("Use Ravager", "UseRavager", "Offensive Spell");
            AddControlInWinForm("Use Siegebreaker", "UseSiegebreaker", "Offensive Spell");
            AddControlInWinForm("Use Avatar", "UseAvatar", "Offensive Spell");
            AddControlInWinForm("Use Bladestorm", "UseBladestorm", "Offensive Spell");
            AddControlInWinForm("Use Bloodbath", "UseBloodbath", "Offensive Spell");
            AddControlInWinForm("Use Charge", "UseCharge", "Offensive Spell");
            AddControlInWinForm("Use Cleave", "UseCleave", "Offensive Spell");
            AddControlInWinForm("Use Colossus Smash", "UseColossusSmash", "Offensive Spell");
            AddControlInWinForm("Use Dragon Roar", "UseDragonRoar", "Offensive Spell");
            AddControlInWinForm("Use Exectue", "UseExecute", "Offensive Spell");
            AddControlInWinForm("Use Heroic Leap", "UseHeroicLeap", "Offensive Spell");
            AddControlInWinForm("Use Heroic Strike", "UseHeroicStrike", "Offensive Spell");
            AddControlInWinForm("Use Heroic Throw", "UseHeroicThrow", "Offensive Spell");
            AddControlInWinForm("Use Mortal Strike", "UseMortalStrike", "Offensive Spell");
            AddControlInWinForm("Use Overpower", "UseOverpower", "Offensive Spell");
            AddControlInWinForm("Use Shockwave", "UseShockwave", "Offensive Spell");
            AddControlInWinForm("Use Slam", "UseSlam", "Offensive Spell");
            AddControlInWinForm("Use Storm Bolt", "UseStormBolt", "Offensive Spell");
            AddControlInWinForm("Use Taunt", "UseTaunt", "Offensive Spell");
            AddControlInWinForm("Use Thunder Clap", "UseThunderClap", "Offensive Spell");
            AddControlInWinForm("Use Whirlwind", "UseWhirlwind", "Offensive Spell");
            /* Offensive Cooldown */
            AddControlInWinForm("Use Berserker Rage", "UseBerserkerRage", "Offensive Cooldown");
            AddControlInWinForm("Use Deadly Calm", "UseDeadlyCalm", "Offensive Cooldown");
            AddControlInWinForm("Use Recklessness", "UseRecklessness", "Offensive Cooldown");
            AddControlInWinForm("Use Shattering Throw", "UseShatteringThrow", "Offensive Cooldown");
            AddControlInWinForm("Use Sweeping Strikes", "UseSweepingStrikes", "Offensive Cooldown");
            AddControlInWinForm("Use Skull Banner", "UseSkullBanner", "Offensive Cooldown");
            /* Defensive Cooldown */
            AddControlInWinForm("Use Demoralizing Banner", "UseDemoralizingBanner", "Defensive Cooldown");
            AddControlInWinForm("Use Die by the Sword", "UseDiebytheSword", "Defensive Cooldown");
            AddControlInWinForm("Use Disarm", "UseDisarm", "Defensive Cooldown");
            AddControlInWinForm("Use Disrupting Shout", "UseDisruptingShout", "Defensive Cooldown");
            AddControlInWinForm("Use Hamstring", "UseHamstring", "Defensive Cooldown");
            AddControlInWinForm("Use Intimidating Shout", "UseIntimidatingShout", "Defensive Cooldown");
            AddControlInWinForm("Use Mass Spell Reflection", "UseMassSpellReflection", "Defensive Cooldown");
            AddControlInWinForm("Use Piercing Howl", "UsePiercingHowl", "Defensive Cooldown");
            AddControlInWinForm("Use Pummel", "UsePummel", "Defensive Cooldown");
            AddControlInWinForm("Use Staggering Shout", "UseStaggeringShout", "Defensive Cooldown");
            /* Healing Spell */
            AddControlInWinForm("Use Enraged Regeneration", "UseEnragedRegeneration", "Healing Spell");
            AddControlInWinForm("Use Rallying Cry", "UseRallyingCry", "Healing Spell");
            AddControlInWinForm("Use Victory Rush", "UseVictoryRush", "Healing Spell");
            /* Game Settings */
            AddControlInWinForm("Use Low Combat Settings", "UseLowCombat", "Game Settings");
            AddControlInWinForm("Use Trinket One", "UseTrinketOne", "Game Settings");
            AddControlInWinForm("Use Trinket Two", "UseTrinketTwo", "Game Settings");

            AddControlInWinForm("Use Alchemist Flask", "UseAlchFlask", "Game Settings");
            AddControlInWinForm("Do avoid melee (Off Advised!!)", "DoAvoidMelee", "Game Settings");
            AddControlInWinForm("Avoid melee distance (1 to 4)", "DoAvoidMeleeDistance", "Game Settings");
        }

        public static WarriorArmsSettings CurrentSetting { get; set; }

        public static WarriorArmsSettings GetSettings()
        {
            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Warrior_Arms.xml";
            if (File.Exists(currentSettingsFile))
            {
                return
                    CurrentSetting = Load<WarriorArmsSettings>(currentSettingsFile);
            }
            return new WarriorArmsSettings();
        }
    }

    #endregion
}

public class WarriorProtection
{
    private static WarriorProtectionSettings MySettings = WarriorProtectionSettings.GetSettings();

    #region General Timers & Variables

    private readonly WoWItem _firstTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET);
    private readonly WoWItem _secondTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET, 2);
    public int LC = 0;

    private Timer _onCd = new Timer(0);

    #endregion

    #region Professions & Racials

    public readonly Spell Alchemy = new Spell("Alchemy");
    public readonly Spell ArcaneTorrent = new Spell("Arcane Torrent");
    public readonly Spell Berserking = new Spell("Berserking");
    public readonly Spell BloodFury = new Spell("Blood Fury");

    public readonly Spell GiftoftheNaaru = new Spell("Gift of the Naaru");

    public readonly Spell Stoneform = new Spell("Stoneform");
    public readonly Spell WarStomp = new Spell("War Stomp");

    #endregion

    #region Warrior Buffs

    public readonly Spell BattleShout = new Spell("Battle Shout");
    public readonly Spell BattleStance = new Spell("Battle Stance");
    public readonly Spell BerserkerStance = new Spell("Berserker Stance");
    public readonly Spell CommandingShout = new Spell("Commanding Shout");
    public readonly Spell DefensiveStance = new Spell("Defensive Stance");

    #endregion

    #region Offensive Spell

    public readonly Spell Avatar = new Spell("Avatar");
    public readonly Spell Bladestorm = new Spell("Bladestorm");
    public readonly Spell Bloodbath = new Spell("Bloodbath");
    public readonly Spell Charge = new Spell("Charge");
    public readonly Spell Cleave = new Spell("Cleave");
    public readonly Spell Devastate = new Spell("Devastate");
    public readonly Spell DragonRoar = new Spell("Dragon Roar");
    public readonly Spell Execute = new Spell("Execute");
    public readonly Spell HeroicLeap = new Spell("Heroic Leap");
    public readonly Spell HeroicStrike = new Spell("Heroic Strike");
    public readonly Spell HeroicThrow = new Spell("Heroic Throw");
    public readonly Spell Revenge = new Spell("Revenge");
    public readonly Spell ShieldSlam = new Spell("Shield Slam");
    public readonly Spell Shockwave = new Spell("Shockwave");
    public readonly Spell StormBolt = new Spell("Storm Bolt");
    public readonly Spell SunderArmor = new Spell("Sunder Armor");
    public readonly Spell Taunt = new Spell("Taunt");
    public readonly Spell ThunderClap = new Spell("Thunder Clap");

    #endregion

    #region Offensive Cooldown

    public readonly Spell BerserkerRage = new Spell("Berserker Rage");
    public readonly Spell DeadlyCalm = new Spell("Deadly Calm");
    public readonly Spell Recklessness = new Spell("Recklessness");
    public readonly Spell ShatteringThrow = new Spell("Shattering Throw");
    public readonly Spell SkullBanner = new Spell("Skull Banner");
    public readonly Spell SweepingStrikes = new Spell("Sweeping Strikes");

    #endregion

    #region Defensive Cooldown

    public readonly Spell DemoralizingBanner = new Spell("Demoralizing Banner");
    public readonly Spell DemoralizingShout = new Spell("Demoralizing Shout");
    public readonly Spell Disarm = new Spell("Disarm");
    public readonly Spell DisruptingShout = new Spell("Disrupting Shout");
    public readonly Spell Hamstring = new Spell("Hamstring");
    public readonly Spell IntimidatingShout = new Spell("Intimidating Shout");
    public readonly Spell MassSpellReflection = new Spell("Mass Spell Reflection");
    public readonly Spell PiercingHowl = new Spell("Piercing Howl");
    public readonly Spell Pummel = new Spell("Pummel");
    public readonly Spell ShieldBarrier = new Spell("Shield Barrier");
    public readonly Spell ShieldBlock = new Spell("Shield Block");
    public readonly Spell ShieldWall = new Spell("Shield Wall");
    public readonly Spell SpellReflection = new Spell("Spell Reflection");
    public readonly Spell StaggeringShout = new Spell("Staggering Shout");
    private Timer _disarmTimer = new Timer(0);
    private Timer _shieldBarrierTimer = new Timer(0);

    #endregion

    #region Healing Spell

    public readonly Spell EnragedRegeneration = new Spell("Enraged Regeneration");
    public readonly Spell LastStand = new Spell("Last Stand");
    public readonly Spell RallyingCry = new Spell("Rallying Cry");
    public readonly Spell VictoryRush = new Spell("Victory Rush");

    #endregion

    public WarriorProtection()
    {
        Main.InternalRange = ObjectManager.Me.GetCombatReach;
        MySettings = WarriorProtectionSettings.GetSettings();
        Main.DumpCurrentSettings<WarriorProtectionSettings>(MySettings);
        UInt128 lastTarget = 0;

        while (Main.InternalLoop)
        {
            try
            {
                if (!ObjectManager.Me.IsDeadMe)
                {
                    if (!ObjectManager.Me.IsMounted)
                    {
                        if (Fight.InFight && ObjectManager.Me.Target > 0)
                        {
                            if (ObjectManager.Me.Target != lastTarget
                                && Taunt.IsHostileDistanceGood)
                            {
                                Pull();
                                lastTarget = ObjectManager.Me.Target;
                            }

                            if (ObjectManager.Target.Level < 70 && ObjectManager.Me.Level > 84
                                && MySettings.UseLowCombat)
                            {
                                LC = 1;
                                if (ObjectManager.Target.GetDistance < 30)
                                    LowCombat();
                            }
                            else
                            {
                                LC = 0;
                                if (ObjectManager.Target.GetDistance < 30)
                                    Combat();
                            }
                        }
                        if (!ObjectManager.Me.IsCast)
                            Patrolling();
                    }
                }
                else
                    Thread.Sleep(500);
            }
            catch
            {
            }
            Thread.Sleep(100);
        }
    }

    private void Pull()
    {
        if (HeroicLeap.IsHostileDistanceGood && HeroicLeap.KnownSpell && HeroicLeap.IsSpellUsable
            && MySettings.UseHeroicLeap)
        {
            SpellManager.CastSpellByIDAndPosition(6544, ObjectManager.Target.Position);
            Others.SafeSleep(200);
        }

        if (Taunt.IsHostileDistanceGood && Taunt.KnownSpell && Taunt.IsSpellUsable
            && MySettings.UseTaunt && ObjectManager.Target.GetDistance > 20)
        {
            Taunt.Cast();
        }
    }

    private void LowCombat()
    {
        Buff();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        DefenseCycle();
        Heal();

        if (HeroicThrow.KnownSpell && HeroicThrow.IsSpellUsable && HeroicThrow.IsHostileDistanceGood
            && MySettings.UseHeroicThrow && !ObjectManager.Target.InCombat)
        {
            HeroicThrow.Cast();
            return;
        }

        if (Charge.KnownSpell && Charge.IsSpellUsable && Charge.IsHostileDistanceGood
            && MySettings.UseCharge && ObjectManager.Target.GetDistance > Main.InternalRange)
        {
            Charge.Cast();
            return;
        }

        if (ShieldSlam.KnownSpell && ShieldSlam.IsSpellUsable && ShieldSlam.IsHostileDistanceGood
            && ObjectManager.Me.RagePercentage < 95 && MySettings.UseShieldSlam)
        {
            ShieldSlam.Cast();
            return;
        }
        if (HeroicStrike.KnownSpell && HeroicStrike.IsSpellUsable && HeroicStrike.IsHostileDistanceGood && MySettings.UseHeroicStrike &&
            (ObjectManager.Me.RagePercentage > 80 || ObjectManager.Me.HaveBuff(122510)))
        {
            if (ObjectManager.Me.HealthPercent > 80)
            {
                if (DeadlyCalm.KnownSpell && DeadlyCalm.IsSpellUsable && MySettings.UseDeadlyCalm)
                {
                    DeadlyCalm.Cast();
                    Others.SafeSleep(200);
                }
                HeroicStrike.Cast();
                return;
            }
            return;
        }
        if (Revenge.KnownSpell && Revenge.IsHostileDistanceGood && Revenge.IsSpellUsable
            && ObjectManager.Me.RagePercentage < 95 && MySettings.UseRevenge)
        {
            Revenge.Cast();
            return;
        }
        if (Shockwave.KnownSpell && Shockwave.IsSpellUsable && Shockwave.IsHostileDistanceGood
            && MySettings.UseShockwave)
        {
            Shockwave.Cast();
            return;
        }
        if (DragonRoar.KnownSpell && DragonRoar.IsSpellUsable && DragonRoar.IsHostileDistanceGood
            && MySettings.UseDragonRoar)
        {
            DragonRoar.Cast();
            return;
        }
        if (Bladestorm.KnownSpell && Bladestorm.IsSpellUsable && Bladestorm.IsHostileDistanceGood
            && MySettings.UseBladestorm)
        {
            Bladestorm.Cast();
            return;
        }
        // Blizzard API Calls for Devastate using Sunder Armor Function
        if (SunderArmor.KnownSpell && SunderArmor.IsSpellUsable && SunderArmor.IsHostileDistanceGood
            && MySettings.UseDevastate)
        {
            SunderArmor.Cast();
            return;
        }
        if (ThunderClap.KnownSpell && ThunderClap.IsSpellUsable && ThunderClap.IsHostileDistanceGood
            && MySettings.UseThunderClap)
        {
            ThunderClap.Cast();
        }
    }

    private void Combat()
    {
        Buff();
        DPSBurst();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        DPSCycle();
        Decast();
        if (_onCd.IsReady)
            DefenseCycle();
        Heal();
    }


    private void Buff()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (MySettings.UseDefensiveStance && DefensiveStance.KnownSpell && DefensiveStance.IsSpellUsable
            && !DefensiveStance.HaveBuff && LC != 1)
        {
            DefensiveStance.Cast();
            return;
        }
        if (!BattleStance.HaveBuff && BattleStance.KnownSpell && BattleStance.IsSpellUsable
            && MySettings.UseBattleStance && LC == 1)
        {
            BattleStance.Cast();
            return;
        }
        if (!BerserkerStance.HaveBuff && BerserkerStance.KnownSpell && BerserkerStance.IsSpellUsable
            && MySettings.UseBerserkerStance && !MySettings.UseBattleStance && !MySettings.UseDefensiveStance)
        {
            BerserkerStance.Cast();
            return;
        }
        if (BattleShout.KnownSpell && BattleShout.IsSpellUsable && !BattleShout.HaveBuff
            && MySettings.UseBattleShout)
        {
            BattleShout.Cast();
            return;
        }
        if (CommandingShout.KnownSpell && CommandingShout.IsSpellUsable && !CommandingShout.HaveBuff
            && MySettings.UseCommandingShout && !MySettings.UseBattleShout)
        {
            CommandingShout.Cast();
            return;
        }
        if (MySettings.UseAlchFlask && !ObjectManager.Me.HaveBuff(79638) && !ObjectManager.Me.HaveBuff(79640) && !ObjectManager.Me.HaveBuff(79639)
            && !ItemsManager.IsItemOnCooldown(75525) && ItemsManager.GetItemCount(75525) > 0)
        {
            ItemsManager.UseItem(75525);
        }
    }

    private void AvoidMelee()
    {
        if (ObjectManager.Target.GetDistance < MySettings.DoAvoidMeleeDistance && ObjectManager.Target.InCombat)
        {
            Logging.WriteFight("Too Close. Moving Back");
            var maxTimeTimer = new Timer(1000*2);
            MovementsAction.MoveBackward(true);
            while (ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat && !maxTimeTimer.IsReady)
                Others.SafeSleep(300);
            MovementsAction.MoveBackward(false);
            if (maxTimeTimer.IsReady && ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat)
            {
                MovementsAction.MoveForward(true);
                Others.SafeSleep(1000);
                MovementsAction.MoveForward(false);
                MovementManager.Face(ObjectManager.Target.Position);
            }
        }
    }

    private void DefenseCycle()
    {
        if (ObjectManager.Me.HealthPercent < 95 && MySettings.UseDisarm && Disarm.IsHostileDistanceGood
            && Disarm.KnownSpell && Disarm.IsSpellUsable && _disarmTimer.IsReady)
        {
            Disarm.Cast();
            _disarmTimer = new Timer(1000*60);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 20 && MySettings.UseIntimidatingShout
            && IntimidatingShout.KnownSpell && IntimidatingShout.IsSpellUsable &&
            ObjectManager.Target.GetDistance < 8)
        {
            IntimidatingShout.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 60 && ShieldWall.KnownSpell && ShieldWall.IsSpellUsable
            && MySettings.UseShieldWall)
        {
            ShieldWall.Cast();
            _onCd = new Timer(1000*12);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 80 && MySettings.UseDemoralizingBanner
            && DemoralizingBanner.KnownSpell && DemoralizingBanner.IsSpellUsable &&
            ObjectManager.Target.GetDistance < 30)
        {
            SpellManager.CastSpellByIDAndPosition(114203, ObjectManager.Target.Position);
            _onCd = new Timer(1000*15);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 90 && MySettings.UseDemoralizingShout
            && DemoralizingShout.KnownSpell && DemoralizingShout.IsSpellUsable &&
            ObjectManager.Target.GetDistance < 30)
        {
            DemoralizingShout.Cast();
            _onCd = new Timer(1000*10);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseWarStompAtPercentage && WarStomp.IsSpellUsable &&
            WarStomp.KnownSpell
            && MySettings.UseWarStomp)
        {
            WarStomp.Cast();
            _onCd = new Timer(1000*2);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseStoneformAtPercentage && Stoneform.IsSpellUsable &&
            Stoneform.KnownSpell
            && MySettings.UseStoneform)
        {
            Stoneform.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 80 && ShieldBlock.KnownSpell && ShieldBlock.IsSpellUsable
            && MySettings.UseShieldBlock)
        {
            ShieldBlock.Cast();
            _onCd = new Timer(1000*6);
        }
    }

    private void Heal()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (VictoryRush.KnownSpell && VictoryRush.IsSpellUsable && VictoryRush.IsHostileDistanceGood
            && MySettings.UseVictoryRush && ObjectManager.Me.HealthPercent < 90)
        {
            VictoryRush.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 30 && LastStand.IsSpellUsable && LastStand.KnownSpell
            && MySettings.UseLastStand && ObjectManager.Me.InCombat)
        {
            LastStand.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 30 && RallyingCry.IsSpellUsable && RallyingCry.KnownSpell
            && MySettings.UseRallyingCry && ObjectManager.Me.InCombat && !LastStand.HaveBuff)
        {
            RallyingCry.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseGiftoftheNaaruAtPercentage &&
            GiftoftheNaaru.IsSpellUsable && GiftoftheNaaru.KnownSpell
            && MySettings.UseGiftoftheNaaru)
        {
            GiftoftheNaaru.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 80 && EnragedRegeneration.IsSpellUsable &&
            EnragedRegeneration.KnownSpell
            && MySettings.UseEnragedRegeneration)
        {
            EnragedRegeneration.Cast();
        }
    }

    private void Decast()
    {
        if (ArcaneTorrent.IsSpellUsable && ArcaneTorrent.KnownSpell && ObjectManager.Target.GetDistance < 8
            && ObjectManager.Me.HealthPercent <= MySettings.UseArcaneTorrentForDecastAtPercentage
            && MySettings.UseArcaneTorrentForDecast && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe)
        {
            ArcaneTorrent.Cast();
            return;
        }
        if (!Hamstring.TargetHaveBuff && MySettings.UseHamstring && Hamstring.KnownSpell
            && Hamstring.IsSpellUsable && Hamstring.IsHostileDistanceGood)
        {
            Hamstring.Cast();
            return;
        }
        if (ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe && Pummel.IsHostileDistanceGood && Pummel.KnownSpell && Pummel.IsSpellUsable &&
            MySettings.UsePummel)
        {
            Pummel.Cast();
            return;
        }
        if (ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe && ObjectManager.Target.GetDistance < 10 && DisruptingShout.KnownSpell &&
            DisruptingShout.IsSpellUsable && MySettings.UseDisruptingShout)
        {
            DisruptingShout.Cast();
            return;
        }
        if (ObjectManager.Target.GetMove && !PiercingHowl.TargetHaveBuff && MySettings.UsePiercingHowl && PiercingHowl.KnownSpell && PiercingHowl.IsSpellUsable &&
            ObjectManager.Target.GetDistance < 15)
        {
            PiercingHowl.Cast();
            return;
        }
        if (Hamstring.TargetHaveBuff && MySettings.UseStaggeringShout && StaggeringShout.KnownSpell && StaggeringShout.IsSpellUsable && ObjectManager.Target.GetDistance < 20)
        {
            StaggeringShout.Cast();
            return;
        }
        if (ObjectManager.Target.IsCast && SpellReflection.KnownSpell && SpellReflection.IsSpellUsable && MySettings.UseSpellReflection)
        {
            SpellReflection.Cast();
            return;
        }
        if (ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe && MySettings.UseMassSpellReflection && MassSpellReflection.KnownSpell &&
            MassSpellReflection.IsSpellUsable)
        {
            MassSpellReflection.Cast();
            return;
        }
        if (ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe && ObjectManager.Me.HealthPercent < 80 && ShieldBarrier.KnownSpell && ShieldBarrier.IsSpellUsable &&
            MySettings.UseShieldBarrier && _shieldBarrierTimer.IsReady)
        {
            ShieldBarrier.Cast();
            _shieldBarrierTimer = new Timer(1000*6);
        }
    }

    private void DPSBurst()
    {
        if (MySettings.UseTrinketOne && !ItemsManager.IsItemOnCooldown(_firstTrinket.Entry) && ItemsManager.IsItemUsable(_firstTrinket.Entry))
        {
            ItemsManager.UseItem(_firstTrinket.Name);
            Logging.WriteFight("Use First Trinket Slot");
        }

        if (MySettings.UseTrinketTwo && !ItemsManager.IsItemOnCooldown(_secondTrinket.Entry) && ItemsManager.IsItemUsable(_secondTrinket.Entry))
        {
            ItemsManager.UseItem(_secondTrinket.Name);
            Logging.WriteFight("Use Second Trinket Slot");
            return;
        }
        if (Berserking.IsSpellUsable && Berserking.KnownSpell && ObjectManager.Target.GetDistance < 30
            && MySettings.UseBerserking)
        {
            Berserking.Cast();
            return;
        }
        if (BloodFury.IsSpellUsable && BloodFury.KnownSpell && ObjectManager.Target.GetDistance < 30
            && MySettings.UseBloodFury)
        {
            BloodFury.Cast();
            return;
        }
        if (BerserkerRage.KnownSpell && BerserkerRage.IsSpellUsable && ObjectManager.Me.RagePercentage < 50
            && MySettings.UseBerserkerRage && ObjectManager.Target.GetDistance < 30)
        {
            BerserkerRage.Cast();
            return;
        }
        if (Recklessness.KnownSpell && Recklessness.IsSpellUsable && MySettings.UseRecklessness && ObjectManager.Target.GetDistance < 30)
        {
            Recklessness.Cast();
            return;
        }
        if (ShatteringThrow.KnownSpell && ShatteringThrow.IsSpellUsable && ShatteringThrow.IsHostileDistanceGood && MySettings.UseShatteringThrow)
        {
            ShatteringThrow.Cast();
            return;
        }
        if (SkullBanner.KnownSpell && SkullBanner.IsSpellUsable && MySettings.UseSkullBanner && ObjectManager.Target.GetDistance < 30)
        {
            SkullBanner.Cast();
            return;
        }
        if (Avatar.KnownSpell && Avatar.IsSpellUsable && MySettings.UseAvatar && ObjectManager.Target.GetDistance < 30)
        {
            Avatar.Cast();
            return;
        }
        if (Bloodbath.KnownSpell && Bloodbath.IsSpellUsable && MySettings.UseBloodbath && ObjectManager.Target.GetDistance < 30)
        {
            Bloodbath.Cast();
            return;
        }
        if (StormBolt.KnownSpell && StormBolt.IsSpellUsable && MySettings.UseStormBolt && StormBolt.IsHostileDistanceGood)
        {
            StormBolt.Cast();
        }
    }

    private void DPSCycle()
    {
        Usefuls.SleepGlobalCooldown();
        try
        {
            Memory.WowMemory.GameFrameLock(); // !!! WARNING - DONT SLEEP WHILE LOCKED - DO FINALLY(GameFrameUnLock()) !!!

            if (HeroicThrow.KnownSpell && HeroicThrow.IsSpellUsable && HeroicThrow.IsHostileDistanceGood
                && MySettings.UseHeroicThrow && !ObjectManager.Target.InCombat)
            {
                HeroicThrow.Cast();
                return;
            }

            if (Charge.KnownSpell && Charge.IsSpellUsable && Charge.IsHostileDistanceGood
                && MySettings.UseCharge && ObjectManager.Target.GetDistance > Main.InternalRange)
            {
                Charge.Cast();
                return;
            }

            if (VictoryRush.KnownSpell && VictoryRush.IsSpellUsable && VictoryRush.IsHostileDistanceGood
                && MySettings.UseVictoryRush && ObjectManager.Me.HealthPercent < 90)
            {
                VictoryRush.Cast();
                return;
            }

            if (ObjectManager.GetNumberAttackPlayer() > 2 && ThunderClap.KnownSpell && ThunderClap.IsSpellUsable
                && ThunderClap.IsHostileDistanceGood && MySettings.UseThunderClap)
            {
                ThunderClap.Cast();
                return;
            }

            if (Cleave.KnownSpell && Cleave.IsSpellUsable && Cleave.IsHostileDistanceGood &&
                ObjectManager.GetNumberAttackPlayer() > 2
                && MySettings.UseCleave && (ObjectManager.Me.RagePercentage > 80 || ObjectManager.Me.HaveBuff(122510)))
            {
                if (ObjectManager.Me.HealthPercent > 80)
                {
                    if (DeadlyCalm.KnownSpell && DeadlyCalm.IsSpellUsable && MySettings.UseDeadlyCalm)
                    {
                        DeadlyCalm.Cast();
                        Others.SafeSleep(200);
                    }
                    Cleave.Cast();
                    return;
                }
            }

            else
            {
                if (HeroicStrike.KnownSpell && HeroicStrike.IsSpellUsable && HeroicStrike.IsHostileDistanceGood
                    && MySettings.UseHeroicStrike &&
                    (ObjectManager.Me.RagePercentage > 80 || ObjectManager.Me.HaveBuff(122510)))
                {
                    if (ObjectManager.Me.HealthPercent > 80)
                    {
                        if (DeadlyCalm.KnownSpell && DeadlyCalm.IsSpellUsable && MySettings.UseDeadlyCalm)
                        {
                            DeadlyCalm.Cast();
                            Others.SafeSleep(200);
                        }
                        HeroicStrike.Cast();
                        return;
                    }
                }
            }

            if (ShieldSlam.KnownSpell && ShieldSlam.IsSpellUsable && ShieldSlam.IsHostileDistanceGood
                && MySettings.UseShieldSlam && ObjectManager.Me.RagePercentage < 95)
            {
                ShieldSlam.Cast();
                return;
            }
            if (Revenge.KnownSpell && Revenge.IsHostileDistanceGood && Revenge.IsSpellUsable
                && MySettings.UseRevenge && ObjectManager.Me.RagePercentage < 95)
            {
                Revenge.Cast();
                return;
            }
            if (Shockwave.KnownSpell && Shockwave.IsSpellUsable && Shockwave.IsHostileDistanceGood
                && MySettings.UseShockwave)
            {
                Shockwave.Cast();
                return;
            }
            if (DragonRoar.KnownSpell && DragonRoar.IsSpellUsable && DragonRoar.IsHostileDistanceGood
                && MySettings.UseDragonRoar)
            {
                Shockwave.Cast();
                return;
            }
            if (Bladestorm.KnownSpell && Bladestorm.IsSpellUsable && Bladestorm.IsHostileDistanceGood
                && MySettings.UseBladestorm)
            {
                Bladestorm.Cast();
                return;
            }
            if (ThunderClap.KnownSpell && ThunderClap.IsSpellUsable && ThunderClap.IsHostileDistanceGood
                && MySettings.UseThunderClap && !ObjectManager.Target.HaveBuff(115798))
            {
                ThunderClap.Cast();
                return;
            }
            if (SunderArmor.KnownSpell && SunderArmor.IsSpellUsable && SunderArmor.IsHostileDistanceGood
                && MySettings.UseDevastate)
            {
                SunderArmor.Cast();
                return;
            }
            if (ArcaneTorrent.IsSpellUsable && ArcaneTorrent.KnownSpell
                && MySettings.UseArcaneTorrentForResource)
            {
                ArcaneTorrent.Cast();
            }
        }
        finally
        {
            Memory.WowMemory.GameFrameUnLock();
        }
    }

    private void Patrolling()
    {
        if (ObjectManager.Me.IsMounted) return;
        Buff();
        Heal();
    }

    #region Nested type: WarriorProtectionSettings

    [Serializable]
    public class WarriorProtectionSettings : Settings
    {
        public bool DoAvoidMelee = false;
        public int DoAvoidMeleeDistance = 0;
        public bool UseAlchFlask = true;
        public bool UseArcaneTorrentForDecast = true;
        public int UseArcaneTorrentForDecastAtPercentage = 100;
        public bool UseArcaneTorrentForResource = true;
        public bool UseAvatar = true;
        public bool UseBattleShout = true;
        public bool UseBattleStance = true;
        public bool UseBerserkerRage = true;
        public bool UseBerserkerStance = false;
        public bool UseBerserking = true;
        public bool UseBladestorm = true;
        public bool UseBloodFury = true;
        public bool UseBloodbath = true;
        public bool UseCharge = true;
        public bool UseCleave = true;
        public bool UseCommandingShout = false;
        public bool UseDeadlyCalm = true;
        public bool UseDefensiveStance = true;
        public bool UseDemoralizingBanner = true;
        public bool UseDemoralizingShout = true;
        public bool UseDevastate = true;
        public bool UseDisarm = true;
        public bool UseDisruptingShout = true;
        public bool UseDragonRoar = true;

        public bool UseEnragedRegeneration = true;
        public bool UseExecute = true;
        public bool UseGiftoftheNaaru = true;
        public int UseGiftoftheNaaruAtPercentage = 80;
        public bool UseHamstring = false;
        public bool UseHeroicLeap = true;
        public bool UseHeroicStrike = true;
        public bool UseHeroicThrow = true;
        public bool UseIntimidatingShout = true;
        public bool UseLastStand = true;

        public bool UseLowCombat = true;
        public bool UseMassSpellReflection = true;
        public bool UsePiercingHowl = false;
        public bool UsePummel = true;
        public bool UseRallyingCry = true;
        public bool UseRecklessness = true;
        public bool UseRevenge = true;
        public bool UseShatteringThrow = true;
        public bool UseShieldBarrier = true;
        public bool UseShieldBlock = true;
        public bool UseShieldSlam = true;
        public bool UseShieldWall = true;
        public bool UseShockwave = true;
        public bool UseSkullBanner = true;
        public bool UseSpellReflection = true;
        public bool UseStaggeringShout = true;
        public bool UseStoneform = true;
        public int UseStoneformAtPercentage = 80;
        public bool UseStormBolt = true;
        public bool UseSweepingStrikes = true;
        public bool UseTaunt = true;
        public bool UseThunderClap = true;
        public bool UseTrinketOne = true;
        public bool UseTrinketTwo = true;
        public bool UseVictoryRush = true;
        public bool UseWarStomp = true;
        public int UseWarStompAtPercentage = 80;

        public WarriorProtectionSettings()
        {
            ConfigWinForm("Warrior Protection Settings");
            /* Professions & Racials */
            AddControlInWinForm("Use Arcane Torrent for Interrupt", "UseArcaneTorrentForDecast", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Arcane Torrent for Resource", "UseArcaneTorrentForResource", "Professions & Racials");
            AddControlInWinForm("Use Berserking", "UseBerserking", "Professions & Racials");
            AddControlInWinForm("Use Blood Fury", "UseBloodFury", "Professions & Racials");
            AddControlInWinForm("Use Gift of the Naaru", "UseGiftoftheNaaru", "Professions & Racials");

            AddControlInWinForm("Use Stoneform", "UseStoneform", "Professions & Racials");
            AddControlInWinForm("Use War Stomp", "UseWarStomp", "Professions & Racials");
            /* Warrior Buffs */
            AddControlInWinForm("Use Battle Shout", "UseBattleShout", "Warrior Buffs");
            AddControlInWinForm("Use Battle Stance", "UseBattleStance", "Warrior Buffs");
            AddControlInWinForm("Use Berserker Stance", "UseBerserkerStance", "Warrior Buffs");
            AddControlInWinForm("Use Commanding Shout", "UseCommandingShout", "Warrior Buffs");
            AddControlInWinForm("Use Defensive Stance", "UseDefensiveStance", "Warrior Buffs");
            /* Offensive Spell */
            AddControlInWinForm("Use Avatar", "UseAvatar", "Offensive Spell");
            AddControlInWinForm("Use Bladestorm", "UseBladestorm", "Offensive Spell");
            AddControlInWinForm("Use Bloodbath", "UseBloodbath", "Offensive Spell");
            AddControlInWinForm("Use Charge", "UseCharge", "Offensive Spell");
            AddControlInWinForm("Use Cleave", "UseCleave", "Offensive Spell");
            AddControlInWinForm("Use Devastate", "UseDevastate", "Offensive Spell");
            AddControlInWinForm("Use Dragon Roar", "UseDragonRoar", "Offensive Spell");
            AddControlInWinForm("Use Exectue", "UseExecute", "Offensive Spell");
            AddControlInWinForm("Use Heroic Leap", "UseHeroicLeap", "Offensive Spell");
            AddControlInWinForm("Use Heroic Strike", "UseHeroicStrike", "Offensive Spell");
            AddControlInWinForm("Use Heroic Throw", "UseHeroicThrow", "Offensive Spell");
            AddControlInWinForm("Use Revenge", "UseRevenge", "Offensive Spell");
            AddControlInWinForm("Use Shield Slam", "UseShieldSlam", "Offensive Spell");
            AddControlInWinForm("Use Shockwave", "UseShockwave", "Offensive Spell");
            AddControlInWinForm("Use Storm Bolt", "UseStormBolt", "Offensive Spell");
            AddControlInWinForm("Use Taunt", "UseTaunt", "Offensive Spell");
            AddControlInWinForm("Use Thunder Clap", "UseThunderClap", "Offensive Spell");
            /* Offensive Cooldown */
            AddControlInWinForm("Use Berserker Rage", "UseBerserkerRage", "Offensive Cooldown");
            AddControlInWinForm("Use Deadly Calm", "UseDeadlyCalm", "Offensive Cooldown");
            AddControlInWinForm("Use Recklessness", "UseRecklessness", "Offensive Cooldown");
            AddControlInWinForm("Use Shattering Throw", "UseShatteringThrow", "Offensive Cooldown");
            AddControlInWinForm("Use Sweeping Strikes", "UseSweepingStrikes", "Offensive Cooldown");
            AddControlInWinForm("Use Skull Banner", "UseSkullBanner", "Offensive Cooldown");
            /* Defensive Cooldown */
            AddControlInWinForm("Use Demoralizing Banner", "UseDemoralizingBanner", "Defensive Cooldown");
            AddControlInWinForm("Use Demoralizing Shout", "UseDemoralizingShout", "Defensive Cooldown");
            AddControlInWinForm("Use Disarm", "UseDisarm", "Defensive Cooldown");
            AddControlInWinForm("Use Disrupting Shout", "UseDisruptingShout", "Defensive Cooldown");
            AddControlInWinForm("Use Hamstring", "UseHamstring", "Defensive Cooldown");
            AddControlInWinForm("Use Intimidating Shout", "UseIntimidatingShout", "Defensive Cooldown");
            AddControlInWinForm("Use Mass Spell Reflection", "UseMassSpellReflection", "Defensive Cooldown");
            AddControlInWinForm("Use Piercing Howl", "UsePiercingHowl", "Defensive Cooldown");
            AddControlInWinForm("Use Pummel", "UsePummel", "Defensive Cooldown");
            AddControlInWinForm("Use Shield Barrier", "UseShieldBarrier", "Defensive Cooldown");
            AddControlInWinForm("Use Shield Block", "UseShieldBlock", "Defensive Cooldown");
            AddControlInWinForm("Use Shield Wall", "UseShieldWall", "Defensive Cooldown");
            AddControlInWinForm("Use Spell Reflection", "UseSpellReflection", "Defensive Cooldown");
            AddControlInWinForm("Use Staggering Shout", "UseStaggeringShout", "Defensive Cooldown");
            /* Healing Spell */
            AddControlInWinForm("Use Enraged Regeneration", "UseEnragedRegeneration", "Healing Spell");
            AddControlInWinForm("Use Last Stand", "UseLastStand", "Healing Spell");
            AddControlInWinForm("Use Rallying Cry", "UseRallyingCry", "Healing Spell");
            AddControlInWinForm("Use Victory Rush", "UseVictoryRush", "Healing Spell");
            /* Game Settings */
            AddControlInWinForm("Use Low Combat Settings", "UseLowCombat", "Game Settings");
            AddControlInWinForm("Use Trinket One", "UseTrinketOne", "Game Settings");
            AddControlInWinForm("Use Trinket Two", "UseTrinketTwo", "Game Settings");

            AddControlInWinForm("Use Alchemist Flask", "UseAlchFlask", "Game Settings");
            AddControlInWinForm("Do avoid melee (Off Advised!!)", "DoAvoidMelee", "Game Settings");
            AddControlInWinForm("Avoid melee distance (1 to 4)", "DoAvoidMeleeDistance", "Game Settings");
        }

        public static WarriorProtectionSettings CurrentSetting { get; set; }

        public static WarriorProtectionSettings GetSettings()
        {
            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Warrior_Protection.xml";
            if (File.Exists(currentSettingsFile))
            {
                return
                    CurrentSetting = Load<WarriorProtectionSettings>(currentSettingsFile);
            }
            return new WarriorProtectionSettings();
        }
    }

    #endregion
}

public class WarriorFury
{
    private static WarriorFurySettings MySettings = WarriorFurySettings.GetSettings();

    #region General Timers & Variables

    private readonly WoWItem _firstTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET);
    private readonly WoWItem _secondTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET, 2);
    public int LC = 0;

    private Timer _onCd = new Timer(0);

    #endregion

    #region Professions & Racials

    public readonly Spell Alchemy = new Spell("Alchemy");
    public readonly Spell ArcaneTorrent = new Spell("Arcane Torrent");
    public readonly Spell Berserking = new Spell("Berserking");
    public readonly Spell BloodFury = new Spell("Blood Fury");

    public readonly Spell GiftoftheNaaru = new Spell("Gift of the Naaru");

    public readonly Spell Stoneform = new Spell("Stoneform");
    public readonly Spell WarStomp = new Spell("War Stomp");

    #endregion

    #region Warrior Buffs

    public readonly Spell BattleShout = new Spell("Battle Shout");
    public readonly Spell BattleStance = new Spell("Battle Stance");
    public readonly Spell BerserkerStance = new Spell("Berserker Stance");
    public readonly Spell CommandingShout = new Spell("Commanding Shout");
    public readonly Spell DefensiveStance = new Spell("Defensive Stance");
    public readonly Spell SuddenDeathTalent = new Spell("Sudden Death");
    public readonly Spell UnquenchableThirstTalent = new Spell("Unquenchable Thirst");
    public readonly uint EnrageBuffId = 13046;
    public readonly uint BloodsurgeBuffId = 46915;

    #endregion

    #region Offensive Spell

    public readonly Spell Avatar = new Spell("Avatar");
    public readonly Spell Bladestorm = new Spell("Bladestorm");
    public readonly Spell Bloodbath = new Spell("Bloodbath");
    public readonly Spell Bloodthirst = new Spell("Bloodthirst");
    public readonly Spell Charge = new Spell("Charge");
    public readonly Spell Cleave = new Spell("Cleave");
    public readonly Spell ColossusSmash = new Spell("Colossus Smash");
    public readonly Spell DragonRoar = new Spell("Dragon Roar");
    public readonly Spell Execute = new Spell("Execute");
    public readonly Spell HeroicLeap = new Spell("Heroic Leap");
    public readonly Spell HeroicStrike = new Spell("Heroic Strike");
    public readonly Spell HeroicThrow = new Spell("Heroic Throw");
    public readonly Spell ImpendingVictory = new Spell("Impending Victory");
    public readonly Spell RagingBlow = new Spell("Raging Blow");
    public readonly Spell Ravager = new Spell("Ravager");
    public readonly Spell Shockwave = new Spell("Shockwave");
    public readonly Spell StormBolt = new Spell("Storm Bolt");
    public readonly Spell Taunt = new Spell("Taunt");
    public readonly Spell ThunderClap = new Spell("Thunder Clap");
    public readonly Spell Whirlwind = new Spell("Whirlwind");
    public readonly Spell WildStrike = new Spell("Wild Strike");

    #endregion

    #region Offensive Cooldown

    public readonly Spell BerserkerRage = new Spell("Berserker Rage");
    public readonly Spell DeadlyCalm = new Spell("Deadly Calm");
    public readonly Spell Recklessness = new Spell("Recklessness");
    public readonly Spell ShatteringThrow = new Spell("Shattering Throw");
    public readonly Spell SkullBanner = new Spell("Skull Banner");
    public readonly Spell SweepingStrikes = new Spell("Sweeping Strikes");

    #endregion

    #region Defensive Cooldown

    public readonly Spell DemoralizingBanner = new Spell("Demoralizing Banner");
    public readonly Spell DiebytheSword = new Spell("Die by the Sword");
    public readonly Spell Disarm = new Spell("Disarm");
    public readonly Spell DisruptingShout = new Spell("Disrupting Shout");
    public readonly Spell Hamstring = new Spell("Hamstring");
    public readonly Spell IntimidatingShout = new Spell("Intimidating Shout");
    public readonly Spell MassSpellReflection = new Spell("Mass Spell Reflection");
    public readonly Spell PiercingHowl = new Spell("Piercing Howl");
    public readonly Spell Pummel = new Spell("Pummel");
    public readonly Spell StaggeringShout = new Spell("Staggering Shout");
    private Timer _disarmTimer = new Timer(0);

    #endregion

    #region Healing Spell

    public readonly Spell EnragedRegeneration = new Spell("Enraged Regeneration");
    public readonly Spell RallyingCry = new Spell("Rallying Cry");
    public readonly Spell VictoryRush = new Spell("Victory Rush");

    #endregion

    public WarriorFury()
    {
        Main.InternalRange = ObjectManager.Me.GetCombatReach;
        MySettings = WarriorFurySettings.GetSettings();
        Main.DumpCurrentSettings<WarriorFurySettings>(MySettings);
        UInt128 lastTarget = 0;

        while (Main.InternalLoop)
        {
            try
            {
                if (!ObjectManager.Me.IsDeadMe)
                {
                    if (!ObjectManager.Me.IsMounted)
                    {
                        if (Fight.InFight && ObjectManager.Me.Target > 0)
                        {
                            if (ObjectManager.Me.Target != lastTarget
                                && Taunt.IsHostileDistanceGood)
                            {
                                Pull();
                                lastTarget = ObjectManager.Me.Target;
                            }

                            if (ObjectManager.Target.Level < 70 && ObjectManager.Me.Level > 84
                                && MySettings.UseLowCombat)
                            {
                                LC = 1;
                                if (ObjectManager.Target.GetDistance < 30)
                                    LowCombat();
                            }
                            else
                            {
                                LC = 0;
                                if (ObjectManager.Target.GetDistance < 30)
                                    Combat();
                            }
                        }
                        if (!ObjectManager.Me.IsCast)
                            Patrolling();
                    }
                }
                else
                    Thread.Sleep(500);
            }
            catch
            {
            }
            Thread.Sleep(100);
        }
    }

    private void Pull()
    {
        if (MySettings.UseCharge && Charge.IsSpellUsable && Charge.IsHostileDistanceGood)
        {
            Charge.Cast();
            Thread.Sleep(100);
            Usefuls.SleepGlobalCooldown();
        }
        if (MySettings.UseRavager && Ravager.IsSpellUsable && Ravager.IsHostileDistanceGood)
        {
            Ravager.Cast();
            Thread.Sleep(100);
            Usefuls.SleepGlobalCooldown();
        }
        if (MySettings.UseRecklessness && Recklessness.IsSpellUsable && ObjectManager.Target.GetDistance < 10f)
        {
            Recklessness.Cast();
            Thread.Sleep(100);
            Usefuls.SleepGlobalCooldown();
        }
        if (MySettings.UseBloodthirst && Bloodthirst.IsSpellUsable && ObjectManager.Target.GetDistance < 10f)
        {
            Bloodthirst.Cast();
            return;
        }
        if (MySettings.UseHeroicLeap && HeroicLeap.IsSpellUsable && HeroicLeap.IsHostileDistanceGood)
        {
            SpellManager.CastSpellByIDAndPosition(6544, ObjectManager.Target.Position);
            Others.SafeSleep(200);
        }
        if (MySettings.UseTaunt && Taunt.IsSpellUsable && Taunt.IsHostileDistanceGood && ObjectManager.Target.GetDistance > 20)
        {
            Taunt.Cast();
            return;
        }
    }

    private void LowCombat()
    {
        Buff();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        DefenseCycle();
        Heal();

        if (HeroicThrow.KnownSpell && HeroicThrow.IsSpellUsable && HeroicThrow.IsHostileDistanceGood
            && MySettings.UseHeroicThrow && !ObjectManager.Target.InCombat)
        {
            HeroicThrow.Cast();
            return;
        }

        if (Charge.KnownSpell && Charge.IsSpellUsable && Charge.IsHostileDistanceGood
            && MySettings.UseCharge && ObjectManager.Target.GetDistance > Main.InternalRange)
        {
            Charge.Cast();
            return;
        }

        if (Bloodthirst.KnownSpell && Bloodthirst.IsSpellUsable && Bloodthirst.IsHostileDistanceGood
            && MySettings.UseBloodthirst)
        {
            Bloodthirst.Cast();
            return;
        }
        if (ColossusSmash.KnownSpell && ColossusSmash.IsHostileDistanceGood && ColossusSmash.IsSpellUsable
            && MySettings.UseColossusSmash)
        {
            ColossusSmash.Cast();
            return;
        }
        if (HeroicStrike.KnownSpell && HeroicStrike.IsSpellUsable && HeroicStrike.IsHostileDistanceGood
            && MySettings.UseHeroicStrike && ObjectManager.GetNumberAttackPlayer() < 3
            && ObjectManager.Me.RagePercentage > 80)
        {
            if (DeadlyCalm.KnownSpell && DeadlyCalm.IsSpellUsable && MySettings.UseDeadlyCalm)
            {
                DeadlyCalm.Cast();
                Others.SafeSleep(200);
            }

            HeroicStrike.Cast();
            return;
        }
        if (Shockwave.KnownSpell && Shockwave.IsSpellUsable && ObjectManager.Target.GetDistance < 10
            && MySettings.UseShockwave)
        {
            Shockwave.Cast();
            return;
        }
        if (DragonRoar.KnownSpell && DragonRoar.IsSpellUsable && ObjectManager.Target.GetDistance < 8
            && MySettings.UseDragonRoar)
        {
            DragonRoar.Cast();
            return;
        }
        if (Bladestorm.KnownSpell && Bladestorm.IsSpellUsable && ObjectManager.Target.GetDistance < 8
            && MySettings.UseBladestorm)
        {
            Bladestorm.Cast();
            return;
        }
        if (ThunderClap.KnownSpell && ThunderClap.IsSpellUsable && ThunderClap.IsHostileDistanceGood
            && MySettings.UseThunderClap)
        {
            ThunderClap.Cast();
        }
    }

    private void Combat()
    {
        Buff();
        DPSBurst();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        DPSCycle();
        Decast();
        if (_onCd.IsReady)
            DefenseCycle();
        Heal();
    }


    private void Buff()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (ObjectManager.Me.HealthPercent < 30 && MySettings.UseDefensiveStance && DefensiveStance.KnownSpell && DefensiveStance.IsSpellUsable && !DefensiveStance.HaveBuff)
        {
            DefensiveStance.Cast();
            return;
        }
        if (!BattleStance.HaveBuff && BattleStance.KnownSpell && BattleStance.IsSpellUsable && MySettings.UseBattleStance && ObjectManager.Me.HealthPercent > 50)
        {
            BattleStance.Cast();
            return;
        }
        if (!BerserkerStance.HaveBuff && BerserkerStance.KnownSpell && BerserkerStance.IsSpellUsable && MySettings.UseBerserkerStance && !MySettings.UseBattleStance &&
            ObjectManager.Me.HealthPercent > 50)
        {
            BerserkerStance.Cast();
            return;
        }
        if (BattleShout.KnownSpell && BattleShout.IsSpellUsable && !BattleShout.HaveBuff && MySettings.UseBattleShout)
        {
            BattleShout.Cast();
            return;
        }
        if (CommandingShout.KnownSpell && CommandingShout.IsSpellUsable && !CommandingShout.HaveBuff && MySettings.UseCommandingShout && !MySettings.UseBattleShout)
        {
            CommandingShout.Cast();
            return;
        }
        if (MySettings.UseAlchFlask && !ObjectManager.Me.HaveBuff(79638) && !ObjectManager.Me.HaveBuff(79640) && !ObjectManager.Me.HaveBuff(79639) &&
            !ItemsManager.IsItemOnCooldown(75525) && ItemsManager.GetItemCount(75525) > 0)
        {
            ItemsManager.UseItem(75525);
        }
    }

    private void AvoidMelee()
    {
        if (ObjectManager.Target.GetDistance < MySettings.DoAvoidMeleeDistance && ObjectManager.Target.InCombat)
        {
            Logging.WriteFight("Too Close. Moving Back");
            var maxTimeTimer = new Timer(1000*2);
            MovementsAction.MoveBackward(true);
            while (ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat && !maxTimeTimer.IsReady)
                Others.SafeSleep(300);
            MovementsAction.MoveBackward(false);
            if (maxTimeTimer.IsReady && ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat)
            {
                MovementsAction.MoveForward(true);
                Others.SafeSleep(1000);
                MovementsAction.MoveForward(false);
                MovementManager.Face(ObjectManager.Target.Position);
            }
        }
    }

    private void DefenseCycle()
    {
        if (ObjectManager.Me.HealthPercent < 95 && MySettings.UseDisarm && Disarm.IsHostileDistanceGood
            && Disarm.KnownSpell && Disarm.IsSpellUsable && _disarmTimer.IsReady)
        {
            Disarm.Cast();
            _disarmTimer = new Timer(1000*60);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 20 && MySettings.UseIntimidatingShout
            && IntimidatingShout.KnownSpell && IntimidatingShout.IsSpellUsable &&
            ObjectManager.Target.GetDistance < 8)
        {
            IntimidatingShout.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 80 && MySettings.UseDiebytheSword
            && DiebytheSword.KnownSpell && DiebytheSword.IsSpellUsable)
        {
            DiebytheSword.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 80 && MySettings.UseDemoralizingBanner
            && DemoralizingBanner.KnownSpell && DemoralizingBanner.IsSpellUsable &&
            ObjectManager.Target.GetDistance < 30)
        {
            SpellManager.CastSpellByIDAndPosition(114203, ObjectManager.Target.Position);
            _onCd = new Timer(1000*15);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseWarStompAtPercentage && WarStomp.IsSpellUsable &&
            WarStomp.KnownSpell
            && MySettings.UseWarStomp)
        {
            WarStomp.Cast();
            _onCd = new Timer(1000*2);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseStoneformAtPercentage && Stoneform.IsSpellUsable &&
            Stoneform.KnownSpell
            && MySettings.UseStoneform)
        {
            Stoneform.Cast();
            _onCd = new Timer(1000*8);
        }
    }

    private void Heal()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (VictoryRush.KnownSpell && VictoryRush.IsSpellUsable && VictoryRush.IsHostileDistanceGood
            && MySettings.UseVictoryRush && ObjectManager.Me.HealthPercent < 90)
        {
            VictoryRush.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 30 && RallyingCry.IsSpellUsable && RallyingCry.KnownSpell
            && MySettings.UseRallyingCry && ObjectManager.Me.InCombat)
        {
            RallyingCry.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseGiftoftheNaaruAtPercentage &&
            GiftoftheNaaru.IsSpellUsable && GiftoftheNaaru.KnownSpell
            && MySettings.UseGiftoftheNaaru)
        {
            GiftoftheNaaru.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 80 && EnragedRegeneration.IsSpellUsable &&
            EnragedRegeneration.KnownSpell
            && MySettings.UseEnragedRegeneration)
        {
            EnragedRegeneration.Cast();
        }
    }

    private void Decast()
    {
        if (ArcaneTorrent.IsSpellUsable && ArcaneTorrent.KnownSpell && ObjectManager.Target.GetDistance < 8
            && ObjectManager.Me.HealthPercent <= MySettings.UseArcaneTorrentForDecastAtPercentage
            && MySettings.UseArcaneTorrentForDecast && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe)
        {
            ArcaneTorrent.Cast();
            return;
        }
        if (!Hamstring.TargetHaveBuff && MySettings.UseHamstring && Hamstring.KnownSpell
            && Hamstring.IsSpellUsable && Hamstring.IsHostileDistanceGood)
        {
            Hamstring.Cast();
            return;
        }
        if (ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe && Pummel.IsHostileDistanceGood
            && Pummel.KnownSpell && Pummel.IsSpellUsable && MySettings.UsePummel)
        {
            Pummel.Cast();
            return;
        }
        if (ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe &&
            ObjectManager.Target.GetDistance < 10
            && DisruptingShout.KnownSpell && DisruptingShout.IsSpellUsable && MySettings.UseDisruptingShout)
        {
            DisruptingShout.Cast();
            return;
        }
        if (ObjectManager.Target.GetMove && !PiercingHowl.TargetHaveBuff && MySettings.UsePiercingHowl
            && PiercingHowl.KnownSpell && PiercingHowl.IsSpellUsable && ObjectManager.Target.GetDistance < 15)
        {
            PiercingHowl.Cast();
            return;
        }
        if (Hamstring.TargetHaveBuff && MySettings.UseStaggeringShout && StaggeringShout.KnownSpell
            && StaggeringShout.IsSpellUsable && ObjectManager.Target.GetDistance < 20)
        {
            StaggeringShout.Cast();
            return;
        }
        if (ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe &&
            MySettings.UseMassSpellReflection
            && MassSpellReflection.KnownSpell && MassSpellReflection.IsSpellUsable)
        {
            MassSpellReflection.Cast();
        }
    }

    private void DPSBurst()
    {
        if (MySettings.UseTrinketOne && !ItemsManager.IsItemOnCooldown(_firstTrinket.Entry) && ItemsManager.IsItemUsable(_firstTrinket.Entry))
        {
            ItemsManager.UseItem(_firstTrinket.Name);
            Logging.WriteFight("Use First Trinket Slot");
        }

        if (MySettings.UseTrinketTwo && !ItemsManager.IsItemOnCooldown(_secondTrinket.Entry) && ItemsManager.IsItemUsable(_secondTrinket.Entry))
        {
            ItemsManager.UseItem(_secondTrinket.Name);
            Logging.WriteFight("Use Second Trinket Slot");
            return;
        }
        if (Berserking.IsSpellUsable && Berserking.KnownSpell && ObjectManager.Target.GetDistance < 30 && MySettings.UseBerserking)
        {
            Berserking.Cast();
            return;
        }
        if (BloodFury.IsSpellUsable && BloodFury.KnownSpell && ObjectManager.Target.GetDistance < 30 && MySettings.UseBloodFury)
        {
            BloodFury.Cast();
            return;
        }
        if (BerserkerRage.KnownSpell && BerserkerRage.IsSpellUsable && ObjectManager.Me.RagePercentage < 50 && MySettings.UseBerserkerRage &&
            ObjectManager.Target.GetDistance < 30)
        {
            BerserkerRage.Cast();
            return;
        }
        if (Recklessness.KnownSpell && Recklessness.IsSpellUsable && MySettings.UseRecklessness && ObjectManager.Target.GetDistance < 30)
        {
            Recklessness.Cast();
            return;
        }
        if (ShatteringThrow.KnownSpell && ShatteringThrow.IsSpellUsable && ShatteringThrow.IsHostileDistanceGood && MySettings.UseShatteringThrow)
        {
            ShatteringThrow.Cast();
            return;
        }
        if (SkullBanner.KnownSpell && SkullBanner.IsSpellUsable && MySettings.UseSkullBanner && ObjectManager.Target.GetDistance < 30)
        {
            SkullBanner.Cast();
            return;
        }
        if (Avatar.KnownSpell && Avatar.IsSpellUsable && MySettings.UseAvatar && ObjectManager.Target.GetDistance < 30)
        {
            Avatar.Cast();
            return;
        }
        if (Bloodbath.KnownSpell && Bloodbath.IsSpellUsable && MySettings.UseBloodbath && ObjectManager.Target.GetDistance < 30)
        {
            Bloodbath.Cast();
            return;
        }
        if (StormBolt.KnownSpell && StormBolt.IsSpellUsable && MySettings.UseStormBolt && StormBolt.IsHostileDistanceGood)
        {
            StormBolt.Cast();
        }
    }

    private void ExecuteCycle()
    {
        if (MySettings.UseExecute && (SuddenDeathTalent.HaveBuff || ObjectManager.Me.Rage > 70) && Execute.IsSpellUsable && Execute.IsHostileDistanceGood)
        {
            Execute.Cast();
            return;
        }
        if (MySettings.UseBloodthirst && !ObjectManager.Me.HaveBuff(EnrageBuffId) && (UnquenchableThirstTalent.KnownSpell || ObjectManager.Me.Rage < 80) && Bloodthirst.IsSpellUsable &&
            Bloodthirst.IsHostileDistanceGood)
        {
            Bloodthirst.Cast();
            return;
        }
        if (MySettings.UseRavager && Ravager.IsSpellUsable && Ravager.IsHostileDistanceGood)
        {
            Ravager.Cast();
            return;
        }
        if (MySettings.UseDragonRoar && DragonRoar.IsSpellUsable && DragonRoar.IsHostileDistanceGood)
        {
            DragonRoar.Cast();
            return;
        }
        if (MySettings.UseStormBolt && StormBolt.IsSpellUsable && StormBolt.IsHostileDistanceGood)
        {
            StormBolt.Cast();
            return;
        }
        if (MySettings.UseExecute && ObjectManager.Me.HaveBuff(EnrageBuffId) && Execute.IsSpellUsable && Execute.IsHostileDistanceGood)
        {
            Execute.Cast();
            return;
        }
        if (MySettings.UseWildStrike && ObjectManager.Me.HaveBuff(BloodsurgeBuffId) && WildStrike.IsSpellUsable && WildStrike.IsHostileDistanceGood)
        {
            WildStrike.Cast();
            return;
        }
        if (MySettings.UseRagingBlow && RagingBlow.IsSpellUsable && RagingBlow.IsHostileDistanceGood)
        {
            RagingBlow.Cast();
            return;
        }
        if (MySettings.UseBloodthirst && UnquenchableThirstTalent.KnownSpell && Bloodthirst.IsSpellUsable && Bloodthirst.IsHostileDistanceGood)
        {
            Bloodthirst.Cast();
            return;
        }
    }

    private void DPSCycle()
    {
        Usefuls.SleepGlobalCooldown();
        try
        {
            Memory.WowMemory.GameFrameLock(); // !!! WARNING - DONT SLEEP WHILE LOCKED - DO FINALLY(GameFrameUnLock()) !!!

            if (MySettings.UseBerserkerRage && BerserkerRage.IsSpellUsable && !ObjectManager.Me.HaveBuff(EnrageBuffId) && ObjectManager.Target.GetDistance <= 25)
            {
                BerserkerRage.Cast();
                return;
            }
            if (MySettings.UseCharge && Charge.IsSpellUsable && Charge.IsHostileDistanceGood)
            {
                Charge.Cast();
                return;
            }
            if (ObjectManager.Target.HealthPercent <= 20)
            {
                ExecuteCycle();
                return;
            }
            if (MySettings.UseWildStrike && (ObjectManager.Me.HaveBuff(BloodsurgeBuffId) || ObjectManager.Me.Rage > 70) && WildStrike.IsSpellUsable && WildStrike.IsHostileDistanceGood)
            {
                WildStrike.Cast();
                return;
            }
            if (MySettings.UseExecute && SuddenDeathTalent.KnownSpell && SuddenDeathTalent.HaveBuff && Execute.IsSpellUsable && Execute.IsHostileDistanceGood)
            {
                Execute.Cast();
                return;
            }
            if (MySettings.UseRagingBlow && RagingBlow.BuffStack == 2 && RagingBlow.IsSpellUsable && RagingBlow.IsHostileDistanceGood)
            {
                RagingBlow.Cast();
                return;
            }
            if (MySettings.UseBloodthirst && !ObjectManager.Me.HaveBuff(EnrageBuffId) && (UnquenchableThirstTalent.KnownSpell || ObjectManager.Me.Rage < 80) && Bloodthirst.IsSpellUsable &&
                Bloodthirst.IsHostileDistanceGood)
            {
                Bloodthirst.Cast();
                return;
            }
            if (MySettings.UseRavager && Ravager.IsSpellUsable && Ravager.IsHostileDistanceGood)
            {
                Ravager.Cast();
                return;
            }
            if (MySettings.UseDragonRoar && DragonRoar.IsSpellUsable && DragonRoar.IsHostileDistanceGood)
            {
                DragonRoar.Cast();
                return;
            }
            if (MySettings.UseStormBolt && StormBolt.IsSpellUsable && StormBolt.IsHostileDistanceGood)
            {
                StormBolt.Cast();
                return;
            }
            if (MySettings.UseWildStrike && ObjectManager.Me.HaveBuff(BloodsurgeBuffId) && WildStrike.IsSpellUsable && WildStrike.IsHostileDistanceGood)
            {
                WildStrike.Cast();
                return;
            }
            if (MySettings.UseRagingBlow && RagingBlow.IsSpellUsable && RagingBlow.IsHostileDistanceGood)
            {
                RagingBlow.Cast();
                return;
            }
            if (MySettings.UseWildStrike && ObjectManager.Me.HaveBuff(EnrageBuffId) && WildStrike.IsSpellUsable && WildStrike.IsHostileDistanceGood)
            {
                WildStrike.Cast();
                return;
            }
            if (MySettings.UseBloodthirst && UnquenchableThirstTalent.KnownSpell && Bloodthirst.IsSpellUsable && Bloodthirst.IsHostileDistanceGood)
            {
                Bloodthirst.Cast();
                return;
            }
        }
        finally
        {
            Memory.WowMemory.GameFrameUnLock();
        }
    }

    private void Patrolling()
    {
        if (!ObjectManager.Me.IsMounted)
        {
            Buff();
            Heal();
        }
    }

    #region Nested type: WarriorFurySettings

    [Serializable]
    public class WarriorFurySettings : Settings
    {
        public bool DoAvoidMelee = false;
        public int DoAvoidMeleeDistance = 0;
        public bool UseAlchFlask = true;
        public bool UseArcaneTorrentForDecast = true;
        public int UseArcaneTorrentForDecastAtPercentage = 100;
        public bool UseArcaneTorrentForResource = true;
        public bool UseAvatar = true;
        public bool UseBattleShout = true;
        public bool UseBattleStance = true;
        public bool UseBerserkerRage = true;
        public bool UseBerserkerStance = false;
        public bool UseBerserking = true;
        public bool UseBladestorm = true;
        public bool UseBloodFury = true;
        public bool UseBloodbath = true;
        public bool UseBloodthirst = true;
        public bool UseCharge = true;
        public bool UseCleave = true;
        public bool UseColossusSmash = true;
        public bool UseCommandingShout = false;
        public bool UseDeadlyCalm = true;
        public bool UseDefensiveStance = true;
        public bool UseDemoralizingBanner = true;
        public bool UseDiebytheSword = true;
        public bool UseDisarm = true;
        public bool UseDisruptingShout = true;
        public bool UseDragonRoar = true;
        public bool UseRavager = true;
        public bool UseEnragedRegeneration = true;
        public bool UseExecute = true;
        public bool UseGiftoftheNaaru = true;
        public int UseGiftoftheNaaruAtPercentage = 80;
        public bool UseHamstring = false;
        public bool UseHeroicLeap = true;
        public bool UseHeroicStrike = true;
        public bool UseHeroicThrow = true;
        public bool UseIntimidatingShout = true;

        public bool UseLowCombat = true;
        public bool UseMassSpellReflection = true;
        public bool UsePiercingHowl = false;
        public bool UsePummel = true;
        public bool UseRagingBlow = true;
        public bool UseRallyingCry = true;
        public bool UseRecklessness = true;
        public bool UseShatteringThrow = true;
        public bool UseShockwave = true;
        public bool UseSkullBanner = true;
        public bool UseStaggeringShout = true;
        public bool UseStoneform = true;
        public int UseStoneformAtPercentage = 80;
        public bool UseStormBolt = true;
        public bool UseSweepingStrikes = true;
        public bool UseTaunt = true;
        public bool UseThunderClap = true;
        public bool UseTrinketOne = true;
        public bool UseTrinketTwo = true;
        public bool UseVictoryRush = true;
        public bool UseWarStomp = true;
        public int UseWarStompAtPercentage = 80;
        public bool UseWhirlwind = true;
        public bool UseWildStrike = true;

        public WarriorFurySettings()
        {
            ConfigWinForm("Warrior Fury Settings");
            /* Professions & Racials */
            AddControlInWinForm("Use Arcane Torrent for Interrupt", "UseArcaneTorrentForDecast", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Arcane Torrent for Resource", "UseArcaneTorrentForResource", "Professions & Racials");
            AddControlInWinForm("Use Berserking", "UseBerserking", "Professions & Racials");
            AddControlInWinForm("Use Blood Fury", "UseBloodFury", "Professions & Racials");
            AddControlInWinForm("Use Gift of the Naaru", "UseGiftoftheNaaru", "Professions & Racials");

            AddControlInWinForm("Use Stoneform", "UseStoneform", "Professions & Racials");
            AddControlInWinForm("Use War Stomp", "UseWarStomp", "Professions & Racials");
            /* Warrior Buffs */
            AddControlInWinForm("Use Battle Shout", "UseBattleShout", "Warrior Buffs");
            AddControlInWinForm("Use Battle Stance", "UseBattleStance", "Warrior Buffs");
            AddControlInWinForm("Use Berserker Stance", "UseBerserkerStance", "Warrior Buffs");
            AddControlInWinForm("Use Commanding Shout", "UseCommandingShout", "Warrior Buffs");
            AddControlInWinForm("Use Defensive Stance", "UseDefensiveStance", "Warrior Buffs");
            /* Offensive Spell */
            AddControlInWinForm("Use Avatar", "UseAvatar", "Offensive Spell");
            AddControlInWinForm("Use Bladestorm", "UseBladestorm", "Offensive Spell");
            AddControlInWinForm("Use Bloodbath", "UseBloodbath", "Offensive Spell");
            AddControlInWinForm("Use Bloodthirst", "UseBloodthirst", "Offensive Spell");
            AddControlInWinForm("Use Charge", "UseCharge", "Offensive Spell");
            AddControlInWinForm("Use Cleave", "UseCleave", "Offensive Spell");
            AddControlInWinForm("Use Colossus Smash", "UseColossusSmash", "Offensive Spell");
            AddControlInWinForm("Use Ravager", "UseRavager", "Offensive Spell");
            AddControlInWinForm("Use Dragon Roar", "UseDragonRoar", "Offensive Spell");
            AddControlInWinForm("Use Exectue", "UseExecute", "Offensive Spell");
            AddControlInWinForm("Use Heroic Leap", "UseHeroicLeap", "Offensive Spell");
            AddControlInWinForm("Use Heroic Strike", "UseHeroicStrike", "Offensive Spell");
            AddControlInWinForm("Use Heroic Throw", "UseHeroicThrow", "Offensive Spell");
            AddControlInWinForm("Use Raging Blow", "UseRagingBlow", "Offensive Spell");
            AddControlInWinForm("Use Shockwave", "UseShockwave", "Offensive Spell");
            AddControlInWinForm("Use Storm Bolt", "UseStormBolt", "Offensive Spell");
            AddControlInWinForm("Use Taunt", "UseTaunt", "Offensive Spell");
            AddControlInWinForm("Use Thunder Clap", "UseThunderClap", "Offensive Spell");
            AddControlInWinForm("Use Whirlwind", "UseWhirlwind", "Offensive Spell");
            AddControlInWinForm("Use Wild Strike", "UseWildStrike", "Offensive Spell");
            /* Offensive Cooldown */
            AddControlInWinForm("Use Berserker Rage", "UseBerserkerRage", "Offensive Cooldown");
            AddControlInWinForm("Use Deadly Calm", "UseDeadlyCalm", "Offensive Cooldown");
            AddControlInWinForm("Use Recklessness", "UseRecklessness", "Offensive Cooldown");
            AddControlInWinForm("Use Shattering Throw", "UseShatteringThrow", "Offensive Cooldown");
            AddControlInWinForm("Use Sweeping Strikes", "UseSweepingStrikes", "Offensive Cooldown");
            AddControlInWinForm("Use Skull Banner", "UseSkullBanner", "Offensive Cooldown");
            /* Defensive Cooldown */
            AddControlInWinForm("Use Demoralizing Banner", "UseDemoralizingBanner", "Defensive Cooldown");
            AddControlInWinForm("Use Die by the Sword", "UseDiebytheSword", "Defensive Cooldown");
            AddControlInWinForm("Use Disarm", "UseDisarm", "Defensive Cooldown");
            AddControlInWinForm("Use Disrupting Shout", "UseDisruptingShout", "Defensive Cooldown");
            AddControlInWinForm("Use Hamstring", "UseHamstring", "Defensive Cooldown");
            AddControlInWinForm("Use Intimidating Shout", "UseIntimidatingShout", "Defensive Cooldown");
            AddControlInWinForm("Use Mass Spell Reflection", "UseMassSpellReflection", "Defensive Cooldown");
            AddControlInWinForm("Use Piercing Howl", "UsePiercingHowl", "Defensive Cooldown");
            AddControlInWinForm("Use Pummel", "UsePummel", "Defensive Cooldown");
            AddControlInWinForm("Use Staggering Shout", "UseStaggeringShout", "Defensive Cooldown");
            /* Healing Spell */
            AddControlInWinForm("Use Enraged Regeneration", "UseEnragedRegeneration", "Healing Spell");
            AddControlInWinForm("Use Rallying Cry", "UseRallyingCry", "Healing Spell");
            AddControlInWinForm("Use Victory Rush", "UseVictoryRush", "Healing Spell");
            /* Game Settings */
            AddControlInWinForm("Use Low Combat Settings", "UseLowCombat", "Game Settings");
            AddControlInWinForm("Use Trinket One", "UseTrinketOne", "Game Settings");
            AddControlInWinForm("Use Trinket Two", "UseTrinketTwo", "Game Settings");

            AddControlInWinForm("Use Alchemist Flask", "UseAlchFlask", "Game Settings");
            AddControlInWinForm("Do avoid melee (Off Advised!!)", "DoAvoidMelee", "Game Settings");
            AddControlInWinForm("Avoid melee distance (1 to 4)", "DoAvoidMeleeDistance", "Game Settings");
        }

        public static WarriorFurySettings CurrentSetting { get; set; }

        public static WarriorFurySettings GetSettings()
        {
            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Warrior_Fury.xml";
            if (File.Exists(currentSettingsFile))
            {
                return
                    CurrentSetting = Load<WarriorFurySettings>(currentSettingsFile);
            }
            return new WarriorFurySettings();
        }
    }

    #endregion
}

#endregion

#region Hunter

public class HunterMarksmanship
{
    private static HunterMarksmanshipSettings MySettings = HunterMarksmanshipSettings.GetSettings();

    #region General Timers & Variables

    private readonly WoWItem _firstTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET);
    private readonly WoWItem _secondTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET, 2);
    public int LC = 0;

    private Timer _onCd = new Timer(0);

    #endregion

    #region Professions & Racials

    public readonly Spell Alchemy = new Spell("Alchemy");
    public readonly Spell ArcaneTorrent = new Spell("Arcane Torrent");
    public readonly Spell Berserking = new Spell("Berserking");
    public readonly Spell BloodFury = new Spell("Blood Fury");

    public readonly Spell GiftoftheNaaru = new Spell("Gift of the Naaru");

    public readonly Spell Stoneform = new Spell("Stoneform");
    public readonly Spell WarStomp = new Spell("War Stomp");

    #endregion

    #region Hunter Buffs

    public readonly Spell AspectoftheHawk = new Spell("Aspect of the Hawk");
    public readonly Spell Camouflage = new Spell("Camouflage");
    public readonly Spell FeignDeath = new Spell("Feign Death");
    public readonly Spell HuntersMark = new Spell("Hunter's Mark");
    public readonly Spell Misdirection = new Spell("Misdirection");
    public readonly Spell SteadyFocus = new Spell("Steady Focus");

    #endregion

    #region Offensive Spell

    public readonly Spell AimedShot = new Spell("Aimed Shot");
    public readonly Spell ArcaneShot = new Spell("Arcane Shot");
    public readonly Spell CallPet1 = new Spell("Call Pet 1");
    public readonly Spell CallPet2 = new Spell("Call Pet 2");
    public readonly Spell CallPet3 = new Spell("Call Pet 3");
    public readonly Spell CallPet4 = new Spell("Call Pet 4");
    public readonly Spell CallPet5 = new Spell("Call Pet 5");
    public readonly Spell ChimeraShot = new Spell("Chimera Shot");
    public readonly Spell Dismiss = new Spell("Dismiss Pet");
    public readonly Spell ExplosiveTrap = new Spell("Explosive Trap");
    public readonly Spell KillShot = new Spell("Kill Shot");
    public readonly Spell MultiShot = new Spell("Multi-Shot");
    public readonly Spell SerpentSting = new Spell("Serpent Sting");
    public readonly Spell SteadyShot = new Spell("Steady Shot");
/*
        private Timer _serpentStingTimer = new Timer(0);
*/

    #endregion

    #region Offensive Cooldown

    public readonly Spell AMurderofCrows = new Spell("A Murder of Crows");
    public readonly Spell Barrage = new Spell("Barrage");
    public readonly Spell BlinkStrike = new Spell("Blink Strike");
    public readonly Spell DireBeast = new Spell("Dire Beast");
    public readonly Spell Fervor = new Spell("Fervor");
    public readonly Spell GlaiveToss = new Spell("Glaive Toss");
    public readonly Spell LynxRush = new Spell("Lynx Rush");
    public readonly Spell Powershot = new Spell("Powershot");
    public readonly Spell RapidFire = new Spell("Rapid Fire");
    public readonly Spell Readiness = new Spell("Readiness");
    public readonly Spell Stampede = new Spell("Stampede");
    private Timer _direBeastTimer = new Timer(0);

    #endregion

    #region Defensive Cooldown

    public readonly Spell BindingShot = new Spell("Binding Shot");
    public readonly Spell ConcussiveShot = new Spell("Concussive Shot");
    public readonly Spell Deterrance = new Spell("Deterrance");
    public readonly Spell Disengage = new Spell("Disengage");
    public readonly Spell FreezingTrap = new Spell("Freezing Trap");
    public readonly Spell IceTrap = new Spell("Ice Trap");
    public readonly Spell ScatterShot = new Spell("Scatter Shot");
    public readonly Spell SilencingShot = new Spell("Silencing Shot");
    public readonly Spell WyvernSting = new Spell("Wyvern Sting");

    #endregion

    #region Healing Spell

    public readonly Spell Exhilaration = new Spell("Exhilaration");
    public readonly Spell FeedPet = new Spell("Feed Pet");
    public readonly Spell MendPet = new Spell("Mend Pet");
    public readonly Spell RevivePet = new Spell("Revive Pet");
    private Timer _mendPetTimer = new Timer(0);

    #endregion

    public HunterMarksmanship()
    {
        Main.InternalRange = 39f;
        Main.InternalAggroRange = 39f;
        MySettings = HunterMarksmanshipSettings.GetSettings();
        Main.DumpCurrentSettings<HunterMarksmanshipSettings>(MySettings);
        UInt128 lastTarget = 0;

        while (Main.InternalLoop)
        {
            try
            {
                if (!ObjectManager.Me.IsDeadMe)
                {
                    if (!ObjectManager.Me.IsMounted)
                    {
                        if (Fight.InFight && ObjectManager.Me.Target > 0)
                        {
                            if (ObjectManager.Me.Target != lastTarget
                                && SerpentSting.IsHostileDistanceGood)
                            {
                                Pull();
                                lastTarget = ObjectManager.Me.Target;
                            }

                            if (ObjectManager.Target.Level < 70 && ObjectManager.Me.Level > 84
                                && MySettings.UseLowCombat)
                            {
                                LC = 1;
                                if (CombatClass.InSpellRange(ObjectManager.Target, 0, Main.InternalRange))
                                    LowCombat();
                            }
                            else
                            {
                                LC = 0;
                                if (CombatClass.InSpellRange(ObjectManager.Target, 0, Main.InternalRange))
                                    Combat();
                            }
                        }
                        if (!ObjectManager.Me.IsCast)
                            Patrolling();
                    }
                }
                else
                    Thread.Sleep(500);
            }
            catch
            {
            }
            Thread.Sleep(100);
        }
    }

    private void Pull()
    {
        if (HuntersMark.KnownSpell && HuntersMark.IsSpellUsable && MySettings.UseHuntersMark
            && HuntersMark.IsHostileDistanceGood && !HuntersMark.TargetHaveBuff && LC != 1)
            HuntersMark.Cast();

        if (ObjectManager.Pet.IsAlive)
        {
            Lua.RunMacroText("/petattack");
            Logging.WriteFight("Cast Pet Attack");
        }

        if (ObjectManager.Pet.IsAlive && MySettings.UseMisdirection && Misdirection.KnownSpell
            && Misdirection.IsSpellUsable)
        {
            Misdirection.CastOnUnitID("pet");
        }

        if (SerpentSting.KnownSpell && SerpentSting.IsSpellUsable && SerpentSting.IsHostileDistanceGood
            && MySettings.UseSerpentSting)
        {
            SerpentSting.Cast();
        }
    }

    private void LowCombat()
    {
        Buff();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        DefenseCycle();
        Heal();

        if (GlaiveToss.KnownSpell && GlaiveToss.IsSpellUsable && GlaiveToss.IsHostileDistanceGood
            && MySettings.UseGlaiveToss)
        {
            GlaiveToss.Cast();
            return;
        }
        if (ArcaneShot.IsSpellUsable && ArcaneShot.IsHostileDistanceGood && ArcaneShot.KnownSpell
            && MySettings.UseArcaneShot)
        {
            ArcaneShot.Cast();
            return;
        }
        if (SteadyShot.KnownSpell && SteadyShot.IsSpellUsable && SteadyShot.IsHostileDistanceGood
            && MySettings.UseSteadyShot)
        {
            SteadyShot.Cast();
            return;
        }
        if (ExplosiveTrap.KnownSpell && ExplosiveTrap.IsSpellUsable && ExplosiveTrap.IsHostileDistanceGood
            && MySettings.UseExplosiveTrap)
        {
            ExplosiveTrap.Cast();
        }
    }

    private void Combat()
    {
        Buff();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        if (_onCd.IsReady)
            DefenseCycle();
        DPSCycle();
        Heal();
        Decast();
        DPSCycle();
        DPSBurst();
        DPSCycle();
    }

    private void Buff()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        Pet();

        if (MySettings.UseAspectoftheHawk && AspectoftheHawk.KnownSpell && AspectoftheHawk.IsSpellUsable
            && !AspectoftheHawk.HaveBuff && !ObjectManager.Me.HaveBuff(109260))
        {
            AspectoftheHawk.Cast();
            return;
        }

        if (MySettings.UseCamouflage && Camouflage.KnownSpell && Camouflage.IsSpellUsable && !Camouflage.HaveBuff
            && !ObjectManager.Me.InCombat)
        {
            Camouflage.Cast();
            return;
        }

        if (MySettings.UseAlchFlask && !ObjectManager.Me.HaveBuff(79638) && !ObjectManager.Me.HaveBuff(79640) && !ObjectManager.Me.HaveBuff(79639)
            && !ItemsManager.IsItemOnCooldown(75525) && ItemsManager.GetItemCount(75525) > 0)
            ItemsManager.UseItem(75525);
    }

    private void DismissPet()
    {
        if (MySettings.DismissOnCall)
        {
            if (!ObjectManager.Me.IsCast && (ObjectManager.Pet.Health == 0 || ObjectManager.Pet.Guid == 0 || !ObjectManager.Pet.IsValid) && Dismiss.KnownSpell && Dismiss.IsSpellUsable)
            {
                Dismiss.Cast();
                Others.SafeSleep(1500);
            }
        }
    }

    private void Pet()
    {
        if (MountTask.JustDismounted())
            return;
        if (MySettings.UsePet1 && !ObjectManager.Me.IsCast && (ObjectManager.Pet.Health == 0 || ObjectManager.Pet.Guid == 0 || !ObjectManager.Pet.IsValid) && CallPet1.KnownSpell && CallPet1.IsSpellUsable)
        {
            DismissPet();
            CallPet1.Cast();
            Others.SafeSleep(1000);
        }
        else if (MySettings.UsePet2 && !ObjectManager.Me.IsCast && (ObjectManager.Pet.Health == 0 || ObjectManager.Pet.Guid == 0 || !ObjectManager.Pet.IsValid) && CallPet2.KnownSpell && CallPet2.IsSpellUsable)
        {
            DismissPet();
            CallPet2.Cast();
            Others.SafeSleep(1000);
        }
        else if (MySettings.UsePet3 && !ObjectManager.Me.IsCast && (ObjectManager.Pet.Health == 0 || ObjectManager.Pet.Guid == 0 || !ObjectManager.Pet.IsValid) && CallPet3.KnownSpell && CallPet3.IsSpellUsable)
        {
            DismissPet();
            CallPet3.Cast();
            Others.SafeSleep(1000);
        }
        else if (MySettings.UsePet4 && !ObjectManager.Me.IsCast && (ObjectManager.Pet.Health == 0 || ObjectManager.Pet.Guid == 0 || !ObjectManager.Pet.IsValid) && CallPet4.KnownSpell && CallPet4.IsSpellUsable)
        {
            DismissPet();
            CallPet4.Cast();
            Others.SafeSleep(1000);
        }
        else
        {
            if (MySettings.UsePet5 && !ObjectManager.Me.IsCast && (ObjectManager.Pet.Health == 0 || ObjectManager.Pet.Guid == 0 || !ObjectManager.Pet.IsValid) && CallPet5.KnownSpell && CallPet5.IsSpellUsable)
            {
                DismissPet();
                CallPet5.Cast();
                Others.SafeSleep(1000);
            }
        }

        if (!ObjectManager.Me.IsCast && (!ObjectManager.Pet.IsAlive || ObjectManager.Pet.Guid == 0)
            && RevivePet.KnownSpell && RevivePet.IsSpellUsable && MySettings.UseRevivePet
            && MySettings.UseCombatRevive && ObjectManager.Target.HealthPercent > 10 && ObjectManager.Me.InCombat)
        {
            RevivePet.Cast();
            Others.SafeSleep(1000);
            return;
        }
        if (!ObjectManager.Me.IsCast && !ObjectManager.Pet.IsAlive
            && RevivePet.KnownSpell && RevivePet.IsSpellUsable && MySettings.UseRevivePet
            && !ObjectManager.Me.InCombat)
        {
            RevivePet.Cast();
            Others.SafeSleep(1000);
        }
    }

    private void AvoidMelee()
    {
        if (ObjectManager.Target.GetDistance < MySettings.DoAvoidMeleeDistance && ObjectManager.Target.InCombat)
        {
            Logging.WriteFight("Too Close. Moving Back");
            var maxTimeTimer = new Timer(1000*2);
            MovementsAction.MoveBackward(true);
            while (ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat && !maxTimeTimer.IsReady)
                Others.SafeSleep(300);
            MovementsAction.MoveBackward(false);
            if (maxTimeTimer.IsReady && ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat)
            {
                MovementsAction.MoveForward(true);
                Others.SafeSleep(1000);
                MovementsAction.MoveForward(false);
                MovementManager.Face(ObjectManager.Target.Position);
            }
        }
    }

    private void DefenseCycle()
    {
        if (ObjectManager.Me.HealthPercent < 20 && MySettings.UseFeignDeath
            && FeignDeath.KnownSpell && FeignDeath.IsSpellUsable)
        {
            FeignDeath.Cast();
            Others.SafeSleep(5000);
            if (ObjectManager.Pet.Health == 0 || ObjectManager.Pet.Guid == 0)
                return;
            Others.SafeSleep(5000);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 50 && MySettings.UseDeterrance
            && Deterrance.KnownSpell && Deterrance.IsSpellUsable)
        {
            Deterrance.Cast();
            Others.SafeSleep(200);
            return;
        }
        if (MySettings.UseFreezingTrap && ObjectManager.GetNumberAttackPlayer() > 1 && FreezingTrap.KnownSpell
            && FreezingTrap.IsSpellUsable && ObjectManager.Target.GetDistance > 10)
        {
            FreezingTrap.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 80 && MySettings.UseIceTrap
            && IceTrap.KnownSpell && IceTrap.IsSpellUsable && ObjectManager.Target.GetDistance < 10
            && Disengage.KnownSpell && Disengage.IsSpellUsable && MySettings.UseDisengage)
        {
            IceTrap.Cast();
            Others.SafeSleep(1000);
            MovementsAction.Jump();
            Disengage.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 80 && MySettings.UseConcussiveShot
            && ConcussiveShot.KnownSpell && ConcussiveShot.IsSpellUsable && ConcussiveShot.IsHostileDistanceGood
            && Disengage.KnownSpell && Disengage.IsSpellUsable && MySettings.UseDisengage)
        {
            ConcussiveShot.Cast();
            Others.SafeSleep(1000);
            MovementsAction.Jump();
            Disengage.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 80 && MySettings.UseBindingShot
            && BindingShot.KnownSpell && BindingShot.IsSpellUsable && BindingShot.IsHostileDistanceGood
            && Disengage.KnownSpell && Disengage.IsSpellUsable && MySettings.UseDisengage)
        {
            BindingShot.Cast();
            Others.SafeSleep(1000);
            MovementsAction.Jump();
            Disengage.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseWarStompAtPercentage && WarStomp.IsSpellUsable &&
            WarStomp.KnownSpell
            && MySettings.UseWarStomp)
        {
            WarStomp.Cast();
            _onCd = new Timer(1000*2);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseStoneformAtPercentage && Stoneform.IsSpellUsable &&
            Stoneform.KnownSpell
            && MySettings.UseStoneform)
        {
            Stoneform.Cast();
            _onCd = new Timer(1000*8);
        }
    }

    private void Heal()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (ObjectManager.Me.HealthPercent <= MySettings.UseGiftoftheNaaruAtPercentage && GiftoftheNaaru.KnownSpell &&
            GiftoftheNaaru.IsSpellUsable
            && MySettings.UseGiftoftheNaaru)
        {
            GiftoftheNaaru.Cast();
            return;
        }
        if (Exhilaration.KnownSpell && Exhilaration.IsSpellUsable
            && MySettings.UseExhilaration && ObjectManager.Me.HealthPercent < 70)
        {
            Exhilaration.Cast();
            return;
        }
        if (ObjectManager.Pet.Health > 0 && ObjectManager.Pet.HealthPercent < 50
            && FeedPet.KnownSpell && FeedPet.IsSpellUsable && MySettings.UseFeedPet
            && !ObjectManager.Me.InCombat)
        {
            FeedPet.Cast();
            return;
        }
        if (ObjectManager.Pet.Health > 0 && ObjectManager.Pet.HealthPercent < 80
            && MendPet.KnownSpell && MendPet.IsSpellUsable && MySettings.UseMendPet
            && _mendPetTimer.IsReady)
        {
            MendPet.Cast();
            _mendPetTimer = new Timer(1000*10);
        }
    }

    private void Decast()
    {
        if (ArcaneTorrent.IsSpellUsable && ArcaneTorrent.KnownSpell && ObjectManager.Target.GetDistance < 8
            && ObjectManager.Me.HealthPercent <= MySettings.UseArcaneTorrentForDecastAtPercentage
            && MySettings.UseArcaneTorrentForDecast && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe)
        {
            ArcaneTorrent.Cast();
            return;
        }
        if (ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe && SilencingShot.IsHostileDistanceGood
            && SilencingShot.KnownSpell && SilencingShot.IsSpellUsable && MySettings.UseSilencingShot)
        {
            SilencingShot.Cast();
            return;
        }
        if (ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe && ScatterShot.IsHostileDistanceGood
            && ScatterShot.KnownSpell && ScatterShot.IsSpellUsable && MySettings.UseScatterShot)
        {
            ScatterShot.Cast();
            return;
        }
        if (ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe && MySettings.UseWyvernSting
            && WyvernSting.KnownSpell && WyvernSting.IsSpellUsable && WyvernSting.IsHostileDistanceGood)
        {
            WyvernSting.Cast();
        }
    }

    private void DPSBurst()
    {
        if (MySettings.UseTrinketOne && !ItemsManager.IsItemOnCooldown(_firstTrinket.Entry) && ItemsManager.IsItemUsable(_firstTrinket.Entry))
        {
            ItemsManager.UseItem(_firstTrinket.Name);
            Logging.WriteFight("Use First Trinket Slot");
        }

        if (MySettings.UseTrinketTwo && !ItemsManager.IsItemOnCooldown(_secondTrinket.Entry) && ItemsManager.IsItemUsable(_secondTrinket.Entry))
        {
            ItemsManager.UseItem(_secondTrinket.Name);
            Logging.WriteFight("Use Second Trinket Slot");
            return;
        }
        if (Berserking.IsSpellUsable && Berserking.KnownSpell && ObjectManager.Target.GetDistance <= 40f
            && MySettings.UseBerserking)
        {
            Berserking.Cast();
            return;
        }
        if (BloodFury.IsSpellUsable && BloodFury.KnownSpell && ObjectManager.Target.GetDistance <= 40f
            && MySettings.UseBloodFury)
        {
            BloodFury.Cast();
            return;
        }
        if (AimedShot.KnownSpell && AimedShot.IsSpellUsable && AimedShot.IsHostileDistanceGood
            && MySettings.UseAimedShot && ObjectManager.Me.HaveBuff(82926))
        {
            AimedShot.Cast();
            return;
        }
        if (MySettings.UseSteadyShot && SteadyShot.KnownSpell && SteadyShot.IsHostileDistanceGood && SteadyShot.IsSpellUsable
            && SteadyFocus.KnownSpell && !ObjectManager.Me.HaveBuff(53220))
        {
            SteadyShot.Cast();
            return;
        }
        if (AMurderofCrows.KnownSpell && AMurderofCrows.IsSpellUsable && AMurderofCrows.IsHostileDistanceGood
            && MySettings.UseAMurderofCrows && !AMurderofCrows.TargetHaveBuff)
        {
            AMurderofCrows.Cast();
            return;
        }
        if (Barrage.KnownSpell && Barrage.IsSpellUsable && MySettings.UseBarrage && Barrage.IsHostileDistanceGood)
        {
            Barrage.Cast();
            return;
        }
        if (BlinkStrike.KnownSpell && BlinkStrike.IsSpellUsable && ObjectManager.Pet.IsAlive
            && MySettings.UseBlinkStrike && ObjectManager.Target.GetDistance <= 40f)
        {
            BlinkStrike.Cast();
            return;
        }
        if (DireBeast.KnownSpell && DireBeast.IsSpellUsable && MySettings.UseDireBeast
            && DireBeast.IsHostileDistanceGood && _direBeastTimer.IsReady)
        {
            DireBeast.Cast();
            _direBeastTimer = new Timer(1000*15);
            return;
        }
        if (Fervor.KnownSpell && Fervor.IsSpellUsable && ObjectManager.Me.Focus < 50
            && MySettings.UseFervor)
        {
            Fervor.Cast();
            return;
        }
        if (GlaiveToss.KnownSpell && GlaiveToss.IsSpellUsable && MySettings.UseGlaiveToss &&
            GlaiveToss.IsHostileDistanceGood)
        {
            GlaiveToss.Cast();
            return;
        }
        if (LynxRush.KnownSpell && LynxRush.IsSpellUsable && MySettings.UseLynxRush &&
            ObjectManager.Target.GetDistance <= 40f)
        {
            LynxRush.Cast();
            return;
        }
        if (Powershot.KnownSpell && Powershot.IsSpellUsable && MySettings.UsePowershot &&
            Powershot.IsHostileDistanceGood)
        {
            Powershot.Cast();
            return;
        }
        if (Stampede.KnownSpell && Stampede.IsSpellUsable && MySettings.UseStampede &&
            Stampede.IsHostileDistanceGood)
        {
            Stampede.Cast();
            return;
        }
        if (RapidFire.KnownSpell && RapidFire.IsSpellUsable && MySettings.UseRapidFire
            && ObjectManager.Target.GetDistance <= 40f)
        {
            RapidFire.Cast();
            return;
        }
        if (Readiness.KnownSpell && Readiness.IsSpellUsable && MySettings.UseReadiness)
        {
            Readiness.Cast();
        }
    }

    private void DPSCycle()
    {
        Usefuls.SleepGlobalCooldown();
        try
        {
            Memory.WowMemory.GameFrameLock(); // !!! WARNING - DONT SLEEP WHILE LOCKED - DO FINALLY(GameFrameUnLock()) !!!

            if (SerpentSting.IsSpellUsable && SerpentSting.IsHostileDistanceGood && SerpentSting.KnownSpell
                && MySettings.UseSerpentSting && !SerpentSting.TargetHaveBuff)
            {
                SerpentSting.Cast();
                //_serpentStingTimer = new Timer(1000*12);
                return;
            }
            if (ChimeraShot.KnownSpell && ChimeraShot.IsSpellUsable && ChimeraShot.IsHostileDistanceGood
                && MySettings.UseChimeraShot)
            {
                ChimeraShot.Cast();
                //_serpentStingTimer = new Timer(1000*12);
                return;
            }
            if (KillShot.KnownSpell && KillShot.IsSpellUsable && KillShot.IsHostileDistanceGood
                && MySettings.UseKillShot)
            {
                KillShot.Cast();
                return;
            }
            if (AimedShot.KnownSpell && AimedShot.IsSpellUsable && AimedShot.IsHostileDistanceGood
                && MySettings.UseAimedShot && ObjectManager.Me.HaveBuff(82926))
            {
                AimedShot.Cast();
                return;
            }
            if (MySettings.UseSteadyShot && SteadyShot.KnownSpell && SteadyShot.IsHostileDistanceGood && SteadyShot.IsSpellUsable
                && SteadyFocus.KnownSpell && !ObjectManager.Me.HaveBuff(53220))
            {
                SteadyShot.Cast();
                return;
            }
            if (ObjectManager.GetNumberAttackPlayer() > 3 && MySettings.UseMultiShot && MultiShot.KnownSpell && MultiShot.IsHostileDistanceGood
                && MultiShot.IsSpellUsable)
            {
                MultiShot.Cast();
                return;
            }
            if (ObjectManager.GetNumberAttackPlayer() > 3 && MySettings.UseMultiShot && MySettings.UseSteadyShot && SteadyShot.KnownSpell && SteadyShot.IsHostileDistanceGood &&
                SteadyShot.IsSpellUsable && ObjectManager.Me.FocusPercentage < 40)
            {
                SteadyShot.Cast();
                return;
            }
            if (ArcaneShot.KnownSpell && ArcaneShot.IsSpellUsable && ArcaneShot.IsHostileDistanceGood && MySettings.UseArcaneShot && ObjectManager.Me.FocusPercentage > 64)
            {
                ArcaneShot.Cast();
                return;
            }
            if (ArcaneTorrent.IsSpellUsable && ArcaneTorrent.KnownSpell && MySettings.UseArcaneTorrentForResource)
            {
                ArcaneTorrent.Cast();
                return;
            }
            if (SteadyShot.KnownSpell && SteadyShot.IsSpellUsable && SteadyShot.IsHostileDistanceGood
                && MySettings.UseSteadyShot && ObjectManager.Me.FocusPercentage < 80)
            {
                SteadyShot.Cast();
            }
        }
        finally
        {
            Memory.WowMemory.GameFrameUnLock();
        }
    }

    private void Patrolling()
    {
        if (ObjectManager.Me.IsMounted) return;
        Buff();
        Heal();
    }

    #region Nested type: HunterMarksmanshipSettings

    [Serializable]
    public class HunterMarksmanshipSettings : Settings
    {
        public bool DismissOnCall = true;
        public bool DoAvoidMelee = false;
        public int DoAvoidMeleeDistance = 0;
        public bool UseAMurderofCrows = true;
        public bool UseAimedShot = true;
        public bool UseAlchFlask = true;
        public bool UseArcaneShot = true;
        public bool UseArcaneTorrentForDecast = true;
        public int UseArcaneTorrentForDecastAtPercentage = 100;
        public bool UseArcaneTorrentForResource = true;
        public bool UseAspectoftheHawk = true;
        public bool UseBarrage = true;
        public bool UseBerserking = true;
        public bool UseBindingShot = true;
        public bool UseBlinkStrike = true;
        public bool UseBloodFury = true;
        public bool UseCamouflage = false;
        public bool UseChimeraShot = true;
        public bool UseCombatRevive = true;
        public bool UseConcussiveShot = true;
        public bool UseDeterrance = true;
        public bool UseDireBeast = true;
        public bool UseDisengage = true;

        public bool UseExhilaration = true;
        public bool UseExplosiveTrap = true;
        public bool UseFeedPet = true;
        public bool UseFeignDeath = true;
        public bool UseFervor = true;
        public bool UseFreezingTrap = true;
        public bool UseGiftoftheNaaru = true;
        public int UseGiftoftheNaaruAtPercentage = 80;
        public bool UseGlaiveToss = true;
        public bool UseHuntersMark = true;
        public bool UseIceTrap = true;
        public bool UseKillShot = true;

        public bool UseLowCombat = true;
        public bool UseLynxRush = true;
        public bool UseMendPet = true;
        public bool UseMisdirection = true;
        public bool UseMultiShot = true;
        public bool UsePet1 = true;
        public bool UsePet2 = false;
        public bool UsePet3 = false;
        public bool UsePet4 = false;
        public bool UsePet5 = false;
        public bool UsePowershot = true;
        public bool UseRapidFire = true;
        public bool UseReadiness = true;
        public bool UseRevivePet = true;
        public bool UseScatterShot = true;
        public bool UseSerpentSting = true;
        public bool UseSilencingShot = true;
        public bool UseStampede = true;
        public bool UseSteadyShot = true;
        public bool UseStoneform = true;
        public int UseStoneformAtPercentage = 80;
        public bool UseTrinketOne = true;
        public bool UseTrinketTwo = true;
        public bool UseWarStomp = true;
        public int UseWarStompAtPercentage = 80;
        public bool UseWyvernSting = true;

        public HunterMarksmanshipSettings()
        {
            ConfigWinForm("Hunter Marksmanship Settings");
            /* Professions & Racials */
            AddControlInWinForm("Use Arcane Torrent for Interrupt", "UseArcaneTorrentForDecast", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Arcane Torrent for Resource", "UseArcaneTorrentForResource", "Professions & Racials");
            AddControlInWinForm("Use Berserking", "UseBerserking", "Professions & Racials");
            AddControlInWinForm("Use Blood Fury", "UseBloodFury", "Professions & Racials");
            AddControlInWinForm("Use Gift of the Naaru", "UseGiftoftheNaaru", "Professions & Racials");

            AddControlInWinForm("Use Stoneform", "UseStoneform", "Professions & Racials");
            AddControlInWinForm("Use War Stomp", "UseWarStomp", "Professions & Racials");
            /* Hunter Buffs */
            AddControlInWinForm("Use Aspect of the Hawk", "UseAspectoftheHawk", "Hunter Buffs");
            AddControlInWinForm("Use Camouflage", "UseCamouflage", "Hunter Buffs");
            AddControlInWinForm("Use Feign Death", "UseFeignDeath", "Hunter Buffs");
            AddControlInWinForm("Use Hunter's Mark", "UseHuntersMark", "Hunter Buffs");
            AddControlInWinForm("Use Misdirection", "UseMisdirection", "Hunter Buffs");
            /* Offensive Spell */
            AddControlInWinForm("Use Aimed Shot", "UseAimedShot", "Offensive Spell");
            AddControlInWinForm("Use Arcane Shot", "UseArcaneShot", "Offensive Spell");
            AddControlInWinForm("Dismiss pet before calling again", "DismissOnCall", "Offensive Spell");
            AddControlInWinForm("Use Pet in Slot 1", "UsePet1", "Offensive Spell");
            AddControlInWinForm("Use Pet in Slot 2", "UsePet2", "Offensive Spell");
            AddControlInWinForm("Use Pet in Slot 3", "UsePet3", "Offensive Spell");
            AddControlInWinForm("Use Pet in Slot 4", "UsePet4", "Offensive Spell");
            AddControlInWinForm("Use Pet in Slot 5", "UsePet5", "Offensive Spell");
            AddControlInWinForm("Use Chimera Shot", "UseChimeraShot", "Offensive Spell");
            AddControlInWinForm("Use Explosive Trap", "UseExplosiveTrap", "Offensive Spell");
            AddControlInWinForm("Use KillShot", "UseKillShot", "Offensive Spell");
            AddControlInWinForm("Use Multi-Shot", "UseMultiShot", "Offensive Spell");
            AddControlInWinForm("Use Serpent Sting", "UseSerpentSting", "Offensive Spell");
            AddControlInWinForm("Use Steady Shot", "UseSteadyShot", "Offensive Spell");
            /* Offensive Cooldown */
            AddControlInWinForm("Use A Murder of Crows", "UseAMurderofCrows", "Offensive Cooldown");
            AddControlInWinForm("Use Barrage", "UseBarrage", "Offensive Cooldown");
            AddControlInWinForm("Use Blink Strike", "UseBlinkStrike", "Offensive Cooldown");
            AddControlInWinForm("Use Dire Beast", "UseDireBeast", "Offensive Cooldown");
            AddControlInWinForm("Use Fervor", "UseFervor", "Offensive Cooldown");
            AddControlInWinForm("Use Glaive Toss", "UseGlaiveToss", "Offensive Cooldown");
            AddControlInWinForm("Use Lynx Rush", "UseLynxRush", "Offensive Cooldown");
            AddControlInWinForm("Use Powershot", "UsePowershot", "Offensive Cooldown");
            AddControlInWinForm("Use Rapid Fire", "UseRapidFire", "Offensive Cooldown");
            AddControlInWinForm("Use Readiness", "UseReadiness", "Offensive Cooldown");
            AddControlInWinForm("Use Stampede", "UseStampede", "Offensive Cooldown");
            /* Defensive Cooldown */
            AddControlInWinForm("Use Binding Shot", "UseBindingShot", "Defensive Cooldown");
            AddControlInWinForm("Use Concussive Shot", "UseConcussiveShot", "Defensive Cooldown");
            AddControlInWinForm("Use Deterrance", "UseDeterrance", "Defensive Cooldown");
            AddControlInWinForm("Use Disengage", "UseDisengage", "Defensive Cooldown");
            AddControlInWinForm("Use Freezing Trap", "UseFreezingTrap", "Defensive Cooldown");
            AddControlInWinForm("Use Ice Trap", "UseIceTrap", "Defensive Cooldown");
            AddControlInWinForm("Use Scatter Shot", "UseScatterShot", "Defensive Cooldown");
            AddControlInWinForm("Use Silencing Shot", "UseSilencingShot", "Defensive Cooldown");
            AddControlInWinForm("Use Wyvern Sting", "UseWyvernSting", "Defensive Cooldown");
            /* Healing Spell */
            AddControlInWinForm("Use Exhilaration", "UseExhilaration", "Healing Spell");
            AddControlInWinForm("Use Feed Pet", "UseFeedPet", "Healing Spell");
            AddControlInWinForm("Use Mend Pet", "UseMendPet", "Healing Spell");
            AddControlInWinForm("Use Revive Pet", "UseRevivePet", "Healing Spell");
            /* Game Settings */
            AddControlInWinForm("Use Low Combat Settings", "UseLowCombat", "Game Settings");
            AddControlInWinForm("Use Trinket One", "UseTrinketOne", "Game Settings");
            AddControlInWinForm("Use Trinket Two", "UseTrinketTwo", "Game Settings");

            AddControlInWinForm("Use Alchemist Flask", "UseAlchFlask", "Game Settings");
            AddControlInWinForm("Use Revive Pet in Combat", "UseCombatRevive", "Game Settings");
            AddControlInWinForm("Do avoid melee (Off Advised!!)", "DoAvoidMelee", "Game Settings");
            AddControlInWinForm("Avoid melee distance (1 to 4)", "DoAvoidMeleeDistance", "Game Settings");
        }

        public static HunterMarksmanshipSettings CurrentSetting { get; set; }

        public static HunterMarksmanshipSettings GetSettings()
        {
            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Hunter_Marksmanship.xml";
            if (File.Exists(currentSettingsFile))
            {
                return
                    CurrentSetting = Load<HunterMarksmanshipSettings>(currentSettingsFile);
            }
            return new HunterMarksmanshipSettings();
        }
    }

    #endregion
}

public class HunterBeastMastery
{
    private static HunterBeastMasterySettings MySettings = HunterBeastMasterySettings.GetSettings();

    #region General Timers & Variables

    private readonly WoWItem _firstTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET);
    private readonly WoWItem _secondTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET, 2);
    public int LC = 0;
    private Timer _ancientHysteriaTimer = new Timer(0);
    private Timer _burrowAttackTimer = new Timer(0);

    private Timer _froststormBreathTimer = new Timer(0);
    private Timer _onCd = new Timer(0);
    private Timer _spiritMendTimer = new Timer(0);

    #endregion

    #region Professions & Racials

    public readonly Spell Alchemy = new Spell("Alchemy");
    public readonly Spell ArcaneTorrent = new Spell("Arcane Torrent");
    public readonly Spell Berserking = new Spell("Berserking");
    public readonly Spell BloodFury = new Spell("Blood Fury");

    public readonly Spell GiftoftheNaaru = new Spell("Gift of the Naaru");

    public readonly Spell Stoneform = new Spell("Stoneform");
    public readonly Spell WarStomp = new Spell("War Stomp");

    #endregion

    #region Hunter Buffs

    public readonly Spell Camouflage = new Spell("Camouflage");
    public readonly Spell FeignDeath = new Spell("Feign Death");
    public readonly Spell HuntersMark = new Spell("Hunter's Mark");
    public readonly Spell Misdirection = new Spell("Misdirection");

    #endregion

    #region Offensive Spell

    public readonly Spell ArcaneShot = new Spell("Arcane Shot");
    public readonly Spell CallPet1 = new Spell("Call Pet 1");
    public readonly Spell CallPet2 = new Spell("Call Pet 2");
    public readonly Spell CallPet3 = new Spell("Call Pet 3");
    public readonly Spell CallPet4 = new Spell("Call Pet 4");
    public readonly Spell CallPet5 = new Spell("Call Pet 5");
    public readonly Spell CobraShot = new Spell("Cobra Shot");
    public readonly Spell Dismiss = new Spell("Dismiss Pet");
    public readonly Spell ExplosiveTrap = new Spell("Explosive Trap");
    public readonly Spell KillCommand = new Spell("Kill Command");
    public readonly Spell KillShot = new Spell("Kill Shot");
    public readonly Spell MultiShot = new Spell("Multi-Shot");
    public readonly Spell SteadyShot = new Spell("Steady Shot");

    #endregion

    #region Offensive Cooldown

    public readonly Spell AMurderofCrows = new Spell("A Murder of Crows");
    public readonly Spell Barrage = new Spell("Barrage");
    public readonly Spell BestialWrath = new Spell("Bestial Wrath");
    public readonly Spell BlinkStrike = new Spell("Blink Strike");
    public readonly Spell DireBeast = new Spell("Dire Beast");
    public readonly Spell Fervor = new Spell("Fervor");
    public readonly Spell FocusFire = new Spell("Focus Fire");
    public readonly Spell GlaiveToss = new Spell("Glaive Toss");
    public readonly Spell LynxRush = new Spell("Lynx Rush");
    public readonly Spell Powershot = new Spell("Powershot");
    public readonly Spell Stampede = new Spell("Stampede");
    private Timer _direBeastTimer = new Timer(0);

    #endregion

    #region Defensive Cooldown

    public readonly Spell BindingShot = new Spell("Binding Shot");
    public readonly Spell ConcussiveShot = new Spell("Concussive Shot");
    public readonly Spell Deterrance = new Spell("Deterrance");
    public readonly Spell Disengage = new Spell("Disengage");
    public readonly Spell FreezingTrap = new Spell("Freezing Trap");
    public readonly Spell IceTrap = new Spell("Ice Trap");
    public readonly Spell Intimidation = new Spell("Intimidation");
    public readonly Spell ScatterShot = new Spell("Scatter Shot");
    public readonly Spell SilencingShot = new Spell("Silencing Shot");

    #endregion

    #region Healing Spell

    public readonly Spell Exhilaration = new Spell("Exhilaration");
    public readonly Spell FeedPet = new Spell("Feed Pet");
    public readonly Spell MendPet = new Spell("Mend Pet");
    public readonly Spell RevivePet = new Spell("Revive Pet");
    private Timer _mendPetTimer = new Timer(0);

    #endregion

    public HunterBeastMastery()
    {
        Main.InternalRange = 39f;
        Main.InternalAggroRange = 39f;
        MySettings = HunterBeastMasterySettings.GetSettings();
        Main.DumpCurrentSettings<HunterBeastMasterySettings>(MySettings);
        UInt128 lastTarget = 0;

        while (Main.InternalLoop)
        {
            try
            {
                if (!ObjectManager.Me.IsDeadMe)
                {
                    if (!ObjectManager.Me.IsMounted)
                    {
                        if (Fight.InFight && ObjectManager.Me.Target > 0)
                        {
                            if (ObjectManager.Me.Target != lastTarget
                                && ArcaneShot.IsHostileDistanceGood)
                            {
                                Pull();
                                lastTarget = ObjectManager.Me.Target;
                            }

                            if (ObjectManager.Target.Level < 70 && ObjectManager.Me.Level > 84
                                && MySettings.UseLowCombat)
                            {
                                LC = 1;
                                if (CombatClass.InSpellRange(ObjectManager.Target, 0, Main.InternalRange))
                                    LowCombat();
                            }
                            else
                            {
                                LC = 0;
                                if (CombatClass.InSpellRange(ObjectManager.Target, 0, Main.InternalRange))
                                    Combat();
                            }
                        }
                        if (!ObjectManager.Me.IsCast)
                            Patrolling();
                    }
                }
                else
                    Thread.Sleep(500);
            }
            catch
            {
            }
            Thread.Sleep(100);
        }
    }

    private void Pull()
    {
        if (HuntersMark.KnownSpell && HuntersMark.IsSpellUsable && MySettings.UseHuntersMark
            && HuntersMark.IsHostileDistanceGood && !HuntersMark.TargetHaveBuff && LC != 1)
            HuntersMark.Cast();

        if (ObjectManager.Pet.IsAlive)
        {
            Lua.RunMacroText("/petattack");
            Logging.WriteFight("Cast Pet Attack");
        }

        if (ObjectManager.Pet.IsAlive && MySettings.UseMisdirection && Misdirection.KnownSpell
            && Misdirection.IsSpellUsable)
        {
            Misdirection.CastOnUnitID("pet");
        }
    }

    private void LowCombat()
    {
        Buff();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        DefenseCycle();
        Heal();

        if (GlaiveToss.KnownSpell && MySettings.UseGlaiveToss && GlaiveToss.IsHostileDistanceGood
            && GlaiveToss.IsSpellUsable)
        {
            GlaiveToss.Cast();
            return;
        }
        if (ArcaneShot.KnownSpell && MySettings.UseArcaneShot && ArcaneShot.IsHostileDistanceGood
            && ArcaneShot.IsSpellUsable)
        {
            ArcaneShot.Cast();
            return;
        }
        if (ExplosiveTrap.KnownSpell && MySettings.UseExplosiveTrap && ExplosiveTrap.IsHostileDistanceGood
            && ExplosiveTrap.IsSpellUsable)
        {
            ExplosiveTrap.Cast();
            return;
        }
        if (CobraShot.KnownSpell && MySettings.UseCobraShot && CobraShot.IsHostileDistanceGood
            && CobraShot.IsSpellUsable)
        {
            CobraShot.Cast();
            return;
        }
        if (SteadyShot.KnownSpell && (!CobraShot.KnownSpell || !MySettings.UseCobraShot) && SteadyShot.IsHostileDistanceGood
            && SteadyShot.IsSpellUsable)
        {
            SteadyShot.Cast();
        }
    }

    private void Combat()
    {
        Buff();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        if (_onCd.IsReady)
            DefenseCycle();
        DPSCycle();
        Heal();
        Decast();
        DPSCycle();
        DPSBurst();
        DPSCycle();
    }

    private void Buff()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        Pet();

        if (MySettings.UseCamouflage && Camouflage.KnownSpell && Camouflage.IsSpellUsable && !Camouflage.HaveBuff
            && !ObjectManager.Me.InCombat)
        {
            Camouflage.Cast();
            return;
        }

        if (MySettings.UseAlchFlask && !ObjectManager.Me.HaveBuff(79638) && !ObjectManager.Me.HaveBuff(79640) && !ObjectManager.Me.HaveBuff(79639)
            && !ItemsManager.IsItemOnCooldown(75525) && ItemsManager.GetItemCount(75525) > 0)
            ItemsManager.UseItem(75525);
    }

    private void DismissPet()
    {
        if (MySettings.DismissOnCall)
        {
            if (!ObjectManager.Me.IsCast && (ObjectManager.Pet.Health == 0 || ObjectManager.Pet.Guid == 0 || !ObjectManager.Pet.IsValid) && Dismiss.KnownSpell && Dismiss.IsSpellUsable)
            {
                Dismiss.Cast();
                Others.SafeSleep(1500);
            }
        }
    }

    private void Pet()
    {
        if (MountTask.JustDismounted())
            return;
        if (MySettings.UsePet1 && !ObjectManager.Me.IsCast && (ObjectManager.Pet.Health == 0 || ObjectManager.Pet.Guid == 0 || !ObjectManager.Pet.IsValid) && CallPet1.KnownSpell && CallPet1.IsSpellUsable)
        {
            DismissPet();
            CallPet1.Cast();
            Others.SafeSleep(1000);
        }
        else if (MySettings.UsePet2 && !ObjectManager.Me.IsCast && (ObjectManager.Pet.Health == 0 || ObjectManager.Pet.Guid == 0 || !ObjectManager.Pet.IsValid) && CallPet2.KnownSpell && CallPet2.IsSpellUsable)
        {
            DismissPet();
            CallPet2.Cast();
            Others.SafeSleep(1000);
        }
        else if (MySettings.UsePet3 && !ObjectManager.Me.IsCast && (ObjectManager.Pet.Health == 0 || ObjectManager.Pet.Guid == 0 || !ObjectManager.Pet.IsValid) && CallPet3.KnownSpell && CallPet3.IsSpellUsable)
        {
            DismissPet();
            CallPet3.Cast();
            Others.SafeSleep(1000);
        }
        else if (MySettings.UsePet4 && !ObjectManager.Me.IsCast && (ObjectManager.Pet.Health == 0 || ObjectManager.Pet.Guid == 0 || !ObjectManager.Pet.IsValid) && CallPet4.KnownSpell && CallPet4.IsSpellUsable)
        {
            DismissPet();
            CallPet4.Cast();
            Others.SafeSleep(1000);
        }
        else
        {
            if (MySettings.UsePet5 && !ObjectManager.Me.IsCast && (ObjectManager.Pet.Health == 0 || ObjectManager.Pet.Guid == 0 || !ObjectManager.Pet.IsValid) && CallPet5.KnownSpell && CallPet5.IsSpellUsable)
            {
                DismissPet();
                CallPet5.Cast();
                Others.SafeSleep(1000);
            }
        }

        if (!ObjectManager.Me.IsCast && (!ObjectManager.Pet.IsAlive || ObjectManager.Pet.Guid == 0)
            && RevivePet.KnownSpell && RevivePet.IsSpellUsable && MySettings.UseRevivePet
            && MySettings.UseCombatRevive && ObjectManager.Target.HealthPercent > 10 && ObjectManager.Me.InCombat)
        {
            RevivePet.Cast();
            Others.SafeSleep(1000);
            return;
        }
        if (!ObjectManager.Me.IsCast && !ObjectManager.Pet.IsAlive
            && RevivePet.KnownSpell && RevivePet.IsSpellUsable && MySettings.UseRevivePet
            && !ObjectManager.Me.InCombat)
        {
            RevivePet.Cast();
            Others.SafeSleep(1000);
        }
    }

    private void AvoidMelee()
    {
        if (ObjectManager.Target.GetDistance < MySettings.DoAvoidMeleeDistance && ObjectManager.Target.InCombat)
        {
            Logging.WriteFight("Too Close. Moving Back");
            var maxTimeTimer = new Timer(1000*2);
            MovementsAction.MoveBackward(true);
            while (ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat && !maxTimeTimer.IsReady)
                Others.SafeSleep(300);
            MovementsAction.MoveBackward(false);
            if (maxTimeTimer.IsReady && ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat)
            {
                MovementsAction.MoveForward(true);
                Others.SafeSleep(1000);
                MovementsAction.MoveForward(false);
                MovementManager.Face(ObjectManager.Target.Position);
            }
        }
    }

    private void DefenseCycle()
    {
        if (ObjectManager.Me.HealthPercent < 20 && MySettings.UseFeignDeath
            && FeignDeath.KnownSpell && FeignDeath.IsSpellUsable)
        {
            FeignDeath.Cast();
            Others.SafeSleep(5000);
            if (ObjectManager.Pet.Health == 0 || ObjectManager.Pet.Guid == 0 || !ObjectManager.Pet.IsValid)
                return;
            Others.SafeSleep(5000);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 50 && MySettings.UseDeterrance
            && Deterrance.KnownSpell && Deterrance.IsSpellUsable)
        {
            Deterrance.Cast();
            Others.SafeSleep(200);
            return;
        }
        if (MySettings.UseFreezingTrap && ObjectManager.GetNumberAttackPlayer() > 1 && FreezingTrap.KnownSpell
            && FreezingTrap.IsSpellUsable && ObjectManager.Target.GetDistance > 10)
        {
            FreezingTrap.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 80 && MySettings.UseIceTrap
            && IceTrap.KnownSpell && IceTrap.IsSpellUsable && ObjectManager.Target.GetDistance < 10
            && Disengage.KnownSpell && Disengage.IsSpellUsable && MySettings.UseDisengage)
        {
            IceTrap.Cast();
            Others.SafeSleep(1000);
            MovementsAction.Jump();
            Disengage.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 80 && MySettings.UseConcussiveShot
            && ConcussiveShot.KnownSpell && ConcussiveShot.IsSpellUsable && ConcussiveShot.IsHostileDistanceGood
            && Disengage.KnownSpell && Disengage.IsSpellUsable && MySettings.UseDisengage)
        {
            ConcussiveShot.Cast();
            Others.SafeSleep(1000);
            MovementsAction.Jump();
            Disengage.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 80 && MySettings.UseBindingShot
            && BindingShot.KnownSpell && BindingShot.IsSpellUsable && BindingShot.IsHostileDistanceGood
            && Disengage.KnownSpell && Disengage.IsSpellUsable && MySettings.UseDisengage)
        {
            BindingShot.Cast();
            Others.SafeSleep(1000);
            MovementsAction.Jump();
            Disengage.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseWarStompAtPercentage && WarStomp.IsSpellUsable &&
            WarStomp.KnownSpell
            && MySettings.UseWarStomp)
        {
            WarStomp.Cast();
            _onCd = new Timer(1000*2);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseStoneformAtPercentage && Stoneform.IsSpellUsable &&
            Stoneform.KnownSpell
            && MySettings.UseStoneform)
        {
            Stoneform.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (Intimidation.IsSpellUsable && Intimidation.KnownSpell && MySettings.UseIntimidation
            && (ObjectManager.Me.HealthPercent < 80 || ObjectManager.Pet.Health < 80))
        {
            Intimidation.Cast();
            _onCd = new Timer(1000*3);
        }
    }

    private void Heal()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (ObjectManager.Me.HealthPercent < 85 && ObjectManager.Pet.IsAlive && MySettings.UseSpiritBeastPet && _spiritMendTimer.IsReady)
        {
            Logging.WriteFight("Cast Spirit Mend.");
            Lua.RunMacroText("/target Player");
            Others.SafeSleep(200);
            Lua.RunMacroText("/cast Spirit Mend");
            _spiritMendTimer = new Timer(1000*40);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseGiftoftheNaaruAtPercentage && GiftoftheNaaru.KnownSpell && GiftoftheNaaru.IsSpellUsable
            && MySettings.UseGiftoftheNaaru)
        {
            GiftoftheNaaru.Cast();
            return;
        }
        if (Exhilaration.KnownSpell && Exhilaration.IsSpellUsable
            && MySettings.UseExhilaration && ObjectManager.Me.HealthPercent < 70)
        {
            Exhilaration.Cast();
            return;
        }
        if (ObjectManager.Pet.Health > 0 && ObjectManager.Pet.HealthPercent < 50
            && FeedPet.KnownSpell && FeedPet.IsSpellUsable && MySettings.UseFeedPet
            && !ObjectManager.Me.InCombat)
        {
            FeedPet.Cast();
            return;
        }
        if (ObjectManager.Pet.Health > 0 && ObjectManager.Pet.HealthPercent < 80
            && MendPet.KnownSpell && MendPet.IsSpellUsable && MySettings.UseMendPet
            && _mendPetTimer.IsReady)
        {
            MendPet.Cast();
            _mendPetTimer = new Timer(1000*10);
        }
    }

    private void Decast()
    {
        if (ArcaneTorrent.IsSpellUsable && ArcaneTorrent.KnownSpell && ObjectManager.Target.GetDistance < 8
            && ObjectManager.Me.HealthPercent <= MySettings.UseArcaneTorrentForDecastAtPercentage
            && MySettings.UseArcaneTorrentForDecast && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe)
        {
            ArcaneTorrent.Cast();
            return;
        }
        if (ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe && SilencingShot.IsHostileDistanceGood
            && SilencingShot.KnownSpell && SilencingShot.IsSpellUsable && MySettings.UseSilencingShot)
        {
            SilencingShot.Cast();
            return;
        }
        if (ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe && ScatterShot.IsHostileDistanceGood
            && ScatterShot.KnownSpell && ScatterShot.IsSpellUsable && MySettings.UseScatterShot)
        {
            ScatterShot.Cast();
        }
    }

    private void DPSBurst()
    {
        if (MySettings.UseTrinketOne && !ItemsManager.IsItemOnCooldown(_firstTrinket.Entry) && ItemsManager.IsItemUsable(_firstTrinket.Entry))
        {
            ItemsManager.UseItem(_firstTrinket.Name);
            Logging.WriteFight("Use First Trinket Slot");
        }

        if (MySettings.UseTrinketTwo && !ItemsManager.IsItemOnCooldown(_secondTrinket.Entry) && ItemsManager.IsItemUsable(_secondTrinket.Entry))
        {
            ItemsManager.UseItem(_secondTrinket.Name);
            Logging.WriteFight("Use Second Trinket Slot");
            return;
        }
        if (Berserking.IsSpellUsable && Berserking.KnownSpell && ObjectManager.Target.GetDistance <= 40f && MySettings.UseBerserking)
        {
            Berserking.Cast();
            return;
        }
        if (BloodFury.IsSpellUsable && BloodFury.KnownSpell && ObjectManager.Target.GetDistance <= 40f && MySettings.UseBloodFury)
        {
            BloodFury.Cast();
            return;
        }
        if (AMurderofCrows.KnownSpell && AMurderofCrows.IsSpellUsable && AMurderofCrows.IsHostileDistanceGood
            && MySettings.UseAMurderofCrows && !AMurderofCrows.TargetHaveBuff)
        {
            AMurderofCrows.Cast();
            return;
        }
        if (Barrage.KnownSpell && Barrage.IsSpellUsable && MySettings.UseBarrage && Barrage.IsHostileDistanceGood)
        {
            Barrage.Cast();
            return;
        }
        if (BlinkStrike.KnownSpell && BlinkStrike.IsSpellUsable && ObjectManager.Pet.IsAlive
            && MySettings.UseBlinkStrike && ObjectManager.Target.GetDistance <= 40f)
        {
            BlinkStrike.Cast();
            return;
        }
        if (DireBeast.KnownSpell && DireBeast.IsSpellUsable && MySettings.UseDireBeast
            && DireBeast.IsHostileDistanceGood && _direBeastTimer.IsReady)
        {
            DireBeast.Cast();
            _direBeastTimer = new Timer(1000*15);
            return;
        }
        if (Fervor.KnownSpell && Fervor.IsSpellUsable && ObjectManager.Me.Focus < 50
            && MySettings.UseFervor)
        {
            Fervor.Cast();
            return;
        }
        if (GlaiveToss.KnownSpell && GlaiveToss.IsSpellUsable && MySettings.UseGlaiveToss &&
            GlaiveToss.IsHostileDistanceGood)
        {
            GlaiveToss.Cast();
            return;
        }
        if (LynxRush.KnownSpell && LynxRush.IsSpellUsable && MySettings.UseLynxRush &&
            ObjectManager.Target.GetDistance <= 40f)
        {
            LynxRush.Cast();
            return;
        }
        if (Powershot.KnownSpell && Powershot.IsSpellUsable && MySettings.UsePowershot &&
            Powershot.IsHostileDistanceGood)
        {
            Powershot.Cast();
            return;
        }
        if (Stampede.KnownSpell && Stampede.IsSpellUsable && MySettings.UseStampede &&
            Stampede.IsHostileDistanceGood)
        {
            Stampede.Cast();
            return;
        }
        if (BestialWrath.KnownSpell && BestialWrath.IsSpellUsable && MySettings.UseBestialWrath
            && ObjectManager.Target.GetDistance <= 40f)
        {
            BestialWrath.Cast();
            return;
        }
        if (MySettings.UseCoreHoundPet && ObjectManager.Target.GetDistance <= 40f
            && _ancientHysteriaTimer.IsReady && ObjectManager.Me.HaveBuff(95809)
            && ObjectManager.Pet.IsAlive && !BestialWrath.HaveBuff)
        {
            Lua.RunMacroText("/cast Ancient Hysteria");
            Logging.WriteFight("Cast Core Hound Pet Ancient Hysteria");
            _ancientHysteriaTimer = new Timer(1000*60*6);
            return;
        }
        if (ObjectManager.Pet.BuffStack(19623) == 5 && FocusFire.IsSpellUsable &&
            FocusFire.KnownSpell
            && MySettings.UseFocusFire)
        {
            FocusFire.Cast();
        }
    }

    private void DPSCycle()
    {
        Usefuls.SleepGlobalCooldown();
        try
        {
            Memory.WowMemory.GameFrameLock(); // !!! WARNING - DONT SLEEP WHILE LOCKED - DO FINALLY(GameFrameUnLock()) !!!

            if (KillShot.KnownSpell && KillShot.IsSpellUsable && KillShot.IsHostileDistanceGood
                && MySettings.UseKillShot)
            {
                KillShot.Cast();
                return;
            }
            if (ObjectManager.GetNumberAttackPlayer() > 2 && MySettings.UseMultiShot)
            {
                if (MultiShot.KnownSpell && MultiShot.IsSpellUsable && MultiShot.IsHostileDistanceGood)
                {
                    MultiShot.Cast();
                    return;
                }
                if (MySettings.UseChimeraPet && ObjectManager.Target.GetDistance < 10
                    && ObjectManager.Pet.Guid == 780 && ObjectManager.Pet.Focus > 29
                    && _froststormBreathTimer.IsReady && ObjectManager.Pet.IsAlive)
                {
                    Lua.RunMacroText("/cast Froststorm Breath");
                    Logging.WriteFight("Cast Chimera Pet AoE");
                    _froststormBreathTimer = new Timer(1000*8);
                    return;
                }
                if (MySettings.UseWormPet && ObjectManager.Target.GetDistance < 10
                    && ObjectManager.Pet.Guid == 784 && ObjectManager.Pet.Focus > 29
                    && _burrowAttackTimer.IsReady && ObjectManager.Pet.IsAlive)
                {
                    Lua.RunMacroText("/cast Burrow Attack");
                    Logging.WriteFight("Cast Worm Pet AoE");
                    _burrowAttackTimer = new Timer(1000*20);
                }
                return;
            }
            if (KillCommand.KnownSpell && KillCommand.IsSpellUsable && KillCommand.IsHostileDistanceGood
                && MySettings.UseKillCommand && ObjectManager.Target.GetDistance <= 40f)
            {
                KillCommand.Cast();
                return;
            }
            if (ArcaneShot.KnownSpell && ArcaneShot.IsSpellUsable && ArcaneShot.IsHostileDistanceGood
                && MySettings.UseArcaneShot && ObjectManager.Me.FocusPercentage > 59)
            {
                ArcaneShot.Cast();
                return;
            }
            if (ArcaneTorrent.IsSpellUsable && ArcaneTorrent.KnownSpell
                && MySettings.UseArcaneTorrentForResource)
            {
                ArcaneTorrent.Cast();
                return;
            }
            if (CobraShot.KnownSpell && CobraShot.IsSpellUsable && CobraShot.IsHostileDistanceGood
                && MySettings.UseCobraShot && ObjectManager.Me.FocusPercentage < 60)
            {
                CobraShot.Cast();
                return;
            }
            if (SteadyShot.KnownSpell && SteadyShot.IsSpellUsable && SteadyShot.IsHostileDistanceGood && (ObjectManager.Me.FocusPercentage < 60 || !CobraShot.KnownSpell || !MySettings.UseCobraShot))
            {
                SteadyShot.Cast();
            }
        }
        finally
        {
            Memory.WowMemory.GameFrameUnLock();
        }
    }

    private void Patrolling()
    {
        if (!ObjectManager.Me.IsMounted)
        {
            Buff();
            Heal();
        }
    }

    #region Nested type: HunterBeastMasterySettings

    [Serializable]
    public class HunterBeastMasterySettings : Settings
    {
        public bool DismissOnCall = true;
        public bool DoAvoidMelee = false;
        public int DoAvoidMeleeDistance = 0;
        public bool UseAMurderofCrows = true;
        public bool UseAlchFlask = true;
        public bool UseArcaneShot = true;
        public bool UseArcaneTorrentForDecast = true;
        public int UseArcaneTorrentForDecastAtPercentage = 100;
        public bool UseArcaneTorrentForResource = true;
        public bool UseBarrage = true;
        public bool UseBerserking = true;
        public bool UseBestialWrath = true;
        public bool UseBindingShot = true;
        public bool UseBlinkStrike = true;
        public bool UseBloodFury = true;
        public bool UseCamouflage = false;
        public bool UseChimeraPet = false;
        public bool UseCobraShot = true;
        public bool UseCombatRevive = true;
        public bool UseConcussiveShot = true;
        public bool UseCoreHoundPet = false;
        public bool UseDeterrance = true;
        public bool UseDireBeast = true;
        public bool UseDisengage = true;

        public bool UseExhilaration = true;
        public bool UseExplosiveTrap = true;
        public bool UseFeedPet = true;
        public bool UseFeignDeath = true;
        public bool UseFervor = true;
        public bool UseFocusFire = false;
        public bool UseFreezingTrap = true;
        public bool UseGiftoftheNaaru = true;
        public int UseGiftoftheNaaruAtPercentage = 80;
        public bool UseGlaiveToss = true;
        public bool UseHuntersMark = true;
        public bool UseIceTrap = true;
        public bool UseIntimidation = true;
        public bool UseKillCommand = true;
        public bool UseKillShot = true;

        public bool UseLowCombat = true;
        public bool UseLynxRush = true;
        public bool UseMendPet = true;
        public bool UseMisdirection = true;
        public bool UseMultiShot = true;
        public bool UsePet1 = true;
        public bool UsePet2 = false;
        public bool UsePet3 = false;
        public bool UsePet4 = false;
        public bool UsePet5 = false;
        public bool UsePowershot = true;
        public bool UseRevivePet = true;
        public bool UseScatterShot = true;
        public bool UseSilencingShot = true;
        public bool UseSpiritBeastPet = false;
        public bool UseStampede = true;
        public bool UseStoneform = true;
        public int UseStoneformAtPercentage = 80;
        public bool UseTrinketOne = true;
        public bool UseTrinketTwo = true;
        public bool UseWarStomp = true;
        public int UseWarStompAtPercentage = 80;
        public bool UseWormPet = false;

        public HunterBeastMasterySettings()
        {
            ConfigWinForm("Hunter BeastMastery Settings");
            /* Professions & Racials */
            AddControlInWinForm("Use Arcane Torrent for Interrupt", "UseArcaneTorrentForDecast", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Arcane Torrent for Resource", "UseArcaneTorrentForResource", "Professions & Racials");
            AddControlInWinForm("Use Berserking", "UseBerserking", "Professions & Racials");
            AddControlInWinForm("Use Blood Fury", "UseBloodFury", "Professions & Racials");
            AddControlInWinForm("Use Gift of the Naaru", "UseGiftoftheNaaru", "Professions & Racials");

            AddControlInWinForm("Use Stoneform", "UseStoneform", "Professions & Racials");
            AddControlInWinForm("Use War Stomp", "UseWarStomp", "Professions & Racials");
            /* Hunter Buffs */
            AddControlInWinForm("Use Camouflage", "UseCamouflage", "Hunter Buffs");
            AddControlInWinForm("Use Feign Death", "UseFeignDeath", "Hunter Buffs");
            AddControlInWinForm("Use Hunter's Mark", "UseHuntersMark", "Hunter Buffs");
            AddControlInWinForm("Use Misdirection", "UseMisdirection", "Hunter Buffs");
            /* Offensive Spell */
            AddControlInWinForm("Use Arcane Shot", "UseArcaneShot", "Offensive Spell");
            AddControlInWinForm("Dismiss pet before calling again", "DismissOnCall", "Offensive Spell");
            AddControlInWinForm("Use Pet in Slot 1", "UsePet1", "Offensive Spell");
            AddControlInWinForm("Use Pet in Slot 2", "UsePet2", "Offensive Spell");
            AddControlInWinForm("Use Pet in Slot 3", "UsePet3", "Offensive Spell");
            AddControlInWinForm("Use Pet in Slot 4", "UsePet4", "Offensive Spell");
            AddControlInWinForm("Use Pet in Slot 5", "UsePet5", "Offensive Spell");
            AddControlInWinForm("Use Cobra Shot", "UseCobraShot", "Offensive Spell");
            AddControlInWinForm("Use Explosive Trap", "UseExplosiveTrap", "Offensive Spell");
            AddControlInWinForm("Use Kill Command", "UseKillCommand", "Offensive Spell");
            AddControlInWinForm("Use KillShot", "UseKillShot", "Offensive Spell");
            AddControlInWinForm("Use Multi-Shot", "UseMultiShot", "Offensive Spell");
            /* Offensive Cooldown */
            AddControlInWinForm("Use A Murder of Crows", "UseAMurderofCrows", "Offensive Cooldown");
            AddControlInWinForm("Use Barrage", "UseBarrage", "Offensive Cooldown");
            AddControlInWinForm("Use Bestial Wrath", "UseBestialWrath", "Offensive Cooldown");
            AddControlInWinForm("Use Blink Strike", "UseBlinkStrike", "Offensive Cooldown");
            AddControlInWinForm("Use Dire Beast", "UseDireBeast", "Offensive Cooldown");
            AddControlInWinForm("Use Fervor", "UseFervor", "Offensive Cooldown");
            AddControlInWinForm("Use Focus Fire", "UseFocusFire", "Offensive Cooldown");
            AddControlInWinForm("Use Glaive Toss", "UseGlaiveToss", "Offensive Cooldown");
            AddControlInWinForm("Use Lynx Rush", "UseLynxRush", "Offensive Cooldown");
            AddControlInWinForm("Use Powershot", "UsePowershot", "Offensive Cooldown");
            AddControlInWinForm("Use Stampede", "UseStampede", "Offensive Cooldown");
            /* Defensive Cooldown */
            AddControlInWinForm("Use Binding Shot", "UseBindingShot", "Defensive Cooldown");
            AddControlInWinForm("Use Concussive Shot", "UseConcussiveShot", "Defensive Cooldown");
            AddControlInWinForm("Use Deterrance", "UseDeterrance", "Defensive Cooldown");
            AddControlInWinForm("Use Disengage", "UseDisengage", "Defensive Cooldown");
            AddControlInWinForm("Use Freezing Trap", "UseFreezingTrap", "Defensive Cooldown");
            AddControlInWinForm("Use Ice Trap", "UseIceTrap", "Defensive Cooldown");
            AddControlInWinForm("Use Intimidation", "UseIntimidation", "Defensive Cooldown");
            AddControlInWinForm("Use Scatter Shot", "UseScatterShot", "Defensive Cooldown");
            AddControlInWinForm("Use Silencing Shot", "UseSilencingShot", "Defensive Cooldown");
            /* Healing Spell */
            AddControlInWinForm("Use Exhilaration", "UseExhilaration", "Healing Spell");
            AddControlInWinForm("Use Feed Pet", "UseFeedPet", "Healing Spell");
            AddControlInWinForm("Use Mend Pet", "UseMendPet", "Healing Spell");
            AddControlInWinForm("Use Revive Pet", "UseRevivePet", "Healing Spell");
            /* Game Settings */
            AddControlInWinForm("Use Low Combat Settings", "UseLowCombat", "Game Settings");
            AddControlInWinForm("Use Trinket One", "UseTrinketOne", "Game Settings");
            AddControlInWinForm("Use Trinket Two", "UseTrinketTwo", "Game Settings");

            AddControlInWinForm("Use Alchemist Flask", "UseAlchFlask", "Game Settings");
            AddControlInWinForm("Use Core Hound Pet", "UseCoreHoundPet", "Game Settings");
            AddControlInWinForm("Use Worm Pet", "UseWormPet", "Game Settings");
            AddControlInWinForm("Use Chimera Pet", "UseChimeraPet", "Game Settings");
            AddControlInWinForm("Use Spirit Beast Pet", "UseSpiritBeastPet", "Game Settings");
            AddControlInWinForm("Use Revive Pet in Combat", "UseCombatRevive", "Game Settings");
            AddControlInWinForm("Do avoid melee (Off Advised!!)", "DoAvoidMelee", "Game Settings");
            AddControlInWinForm("Avoid melee distance (1 to 4)", "DoAvoidMeleeDistance", "Game Settings");
        }

        public static HunterBeastMasterySettings CurrentSetting { get; set; }

        public static HunterBeastMasterySettings GetSettings()
        {
            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Hunter_BeastMastery.xml";
            if (File.Exists(currentSettingsFile))
            {
                return
                    CurrentSetting = Load<HunterBeastMasterySettings>(currentSettingsFile);
            }
            return new HunterBeastMasterySettings();
        }
    }

    #endregion
}

public class HunterSurvival
{
    private static HunterSurvivalSettings MySettings = HunterSurvivalSettings.GetSettings();

    #region General Timers & Variables

    private readonly WoWItem _firstTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET);
    private readonly WoWItem _secondTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET, 2);

    private Timer _onCd = new Timer(0);

    #endregion

    #region Professions & Racials

    public readonly Spell Alchemy = new Spell("Alchemy");
    public readonly Spell ArcaneTorrent = new Spell("Arcane Torrent");
    public readonly Spell Berserking = new Spell("Berserking");
    public readonly Spell BloodFury = new Spell("Blood Fury");

    public readonly Spell GiftoftheNaaru = new Spell("Gift of the Naaru");

    public readonly Spell Stoneform = new Spell("Stoneform");
    public readonly Spell WarStomp = new Spell("War Stomp");

    #endregion

    #region Hunter Buffs

    public readonly Spell AspectoftheHawk = new Spell("Aspect of the Hawk");
    public readonly Spell Camouflage = new Spell("Camouflage");
    public readonly Spell FeignDeath = new Spell("Feign Death");
    public readonly Spell Misdirection = new Spell("Misdirection");
    public readonly Spell SerpentSting = new Spell("Serpent Sting");
    public readonly Spell TrapCaster = new Spell("Trap Caster");

    #endregion

    #region Offensive Spell

    public readonly Spell ArcaneShot = new Spell("Arcane Shot");
    public readonly Spell BlackArrow = new Spell("Black Arrow");
    public readonly Spell CallPet1 = new Spell("Call Pet 1");
    public readonly Spell CallPet2 = new Spell("Call Pet 2");
    public readonly Spell CallPet3 = new Spell("Call Pet 3");
    public readonly Spell CallPet4 = new Spell("Call Pet 4");
    public readonly Spell CallPet5 = new Spell("Call Pet 5");
    public readonly Spell CobraShot = new Spell("Cobra Shot");
    public readonly Spell Dismiss = new Spell("Dismiss Pet");
    public readonly Spell ExplosiveShot = new Spell("Explosive Shot");
    public readonly Spell ExplosiveTrap = new Spell("Explosive Trap");
    public readonly Spell KillShot = new Spell("Kill Shot");
    public readonly Spell MultiShot = new Spell("Multi-Shot");
    public readonly Spell SteadyShot = new Spell("Steady Shot");
    private Timer _serpentStingTimer = new Timer(0);

    #endregion

    #region Offensive Cooldown

    public readonly Spell AMurderofCrows = new Spell("A Murder of Crows");
    public readonly Spell Barrage = new Spell("Barrage");
    public readonly Spell BlinkStrike = new Spell("Blink Strike");
    public readonly Spell DireBeast = new Spell("Dire Beast");
    public readonly Spell Fervor = new Spell("Fervor");
    public readonly Spell GlaiveToss = new Spell("Glaive Toss");
    public readonly Spell LynxRush = new Spell("Lynx Rush");
    public readonly Spell Powershot = new Spell("Powershot");
    public readonly Spell Stampede = new Spell("Stampede");
    private Timer _direBeastTimer = new Timer(0);

    #endregion

    #region Defensive Cooldown

    public readonly Spell BindingShot = new Spell("Binding Shot");
    public readonly Spell ConcussiveShot = new Spell("Concussive Shot");
    public readonly Spell Deterrance = new Spell("Deterrance");
    public readonly Spell Disengage = new Spell("Disengage");
    public readonly Spell FreezingTrap = new Spell("Freezing Trap");
    public readonly Spell IceTrap = new Spell("Ice Trap");
    public readonly Spell ScatterShot = new Spell("Scatter Shot");
    public readonly Spell SilencingShot = new Spell("Silencing Shot");
    public readonly Spell WyvernSting = new Spell("Wyvern Sting");

    #endregion

    #region Healing Spell

    public readonly Spell Exhilaration = new Spell("Exhilaration");
    public readonly Spell FeedPet = new Spell("Feed Pet");
    public readonly Spell MendPet = new Spell("Mend Pet");
    public readonly Spell RevivePet = new Spell("Revive Pet");
    private Timer _mendPetTimer = new Timer(0);

    #endregion

    public HunterSurvival()
    {
        Main.InternalRange = 39f;
        Main.InternalAggroRange = 39f;
        MySettings = HunterSurvivalSettings.GetSettings();
        Main.DumpCurrentSettings<HunterSurvivalSettings>(MySettings);
        UInt128 lastTarget = 0;

        while (Main.InternalLoop)
        {
            try
            {
                if (!ObjectManager.Me.IsDeadMe)
                {
                    if (!ObjectManager.Me.IsMounted)
                    {
                        if (Fight.InFight && ObjectManager.Me.Target > 0)
                        {
                            if (ObjectManager.Me.Target != lastTarget
                                && SerpentSting.IsHostileDistanceGood)
                            {
                                Pull();
                                lastTarget = ObjectManager.Me.Target;
                            }

                            if (MySettings.UseLowCombat &&
                                ((ObjectManager.Target.Level < 70 && ObjectManager.Me.Level > 84)))
                            {
                                if (CombatClass.InSpellRange(ObjectManager.Target, 0, Main.InternalRange))
                                    LowCombat();
                            }
                            else
                            {
                                if (CombatClass.InSpellRange(ObjectManager.Target, 0, Main.InternalRange))
                                    Combat();
                            }
                        }
                        else
                        {
                            if (!ObjectManager.Me.IsCast)
                                Patrolling();
                        }
                    }
                }
                else
                    Thread.Sleep(500);
            }
            catch
            {
            }
            Thread.Sleep(100);
        }
    }

    private void UseTrap(Spell trap)
    {
        if (TrapCaster.HaveBuff)
            SpellManager.CastSpellByIDAndPosition(trap.Id, ObjectManager.Target.Position);
        else
            trap.Cast();
    }

    private void Pull()
    {
        if (ObjectManager.Pet.IsAlive)
        {
            Lua.RunMacroText("/petattack");
            Logging.WriteFight("Cast Pet Attack");
        }

        if (ObjectManager.Pet.IsAlive && MySettings.UseMisdirection && Misdirection.KnownSpell
            && Misdirection.IsSpellUsable)
        {
            Misdirection.CastOnUnitID("pet");
        }

        if (ArcaneShot.KnownSpell && ArcaneShot.IsHostileDistanceGood && MySettings.UseArcaneShot &&
            ArcaneShot.IsSpellUsable)
        {
            ArcaneShot.Cast();
        }
    }

    private void LowCombat()
    {
        Buff();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        DefenseCycle();
        Heal();

        if (GlaiveToss.KnownSpell && MySettings.UseGlaiveToss && GlaiveToss.IsHostileDistanceGood &&
            GlaiveToss.IsSpellUsable)
        {
            GlaiveToss.Cast();
            return;
        }
        if (Barrage.KnownSpell && ObjectManager.GetNumberAttackPlayer() > 2 && MySettings.UseBarrage && Barrage.IsHostileDistanceGood && Barrage.IsSpellUsable)
        {
            Barrage.Cast();
            return;
        }
        if (!SerpentSting.TargetHaveBuff || _serpentStingTimer.IsReady)
        {
            if (MultiShot.KnownSpell && MySettings.UseMultiShot && MultiShot.IsHostileDistanceGood && ObjectManager.GetNumberAttackPlayer() >= 3 && MultiShot.IsSpellUsable)
            {
                _serpentStingTimer = new Timer(1000*12);
                MultiShot.Cast();
                return;
            }
            if (ArcaneShot.KnownSpell && MySettings.UseArcaneShot && ArcaneShot.IsHostileDistanceGood && ArcaneShot.IsSpellUsable)
            {
                _serpentStingTimer = new Timer(1000*12);
                ArcaneShot.Cast();
                return;
            }
        }
        if (CobraShot.KnownSpell && MySettings.UseCobraShot && CobraShot.IsHostileDistanceGood && CobraShot.IsSpellUsable)
        {
            CobraShot.Cast();
            return;
        }
        if (SteadyShot.KnownSpell && SteadyShot.IsHostileDistanceGood && ObjectManager.Me.FocusPercentage < 60
            && (!CobraShot.KnownSpell || !MySettings.UseCobraShot) && SteadyShot.IsSpellUsable)
        {
            SteadyShot.Cast();
            return;
        }
        if (ExplosiveTrap.KnownSpell && MySettings.UseExplosiveTrap && ExplosiveTrap.IsHostileDistanceGood
            && ExplosiveTrap.IsSpellUsable)
        {
            UseTrap(ExplosiveTrap);
        }
    }

    private void Combat()
    {
        Buff();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        if (_onCd.IsReady)
            DefenseCycle();
        DPSCycle();
        Heal();
        Decast();
        DPSCycle();
        DPSBurst();
        DPSCycle();
    }

    private void Buff()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        Pet();

        if (MySettings.UseAspectoftheHawk && AspectoftheHawk.KnownSpell && AspectoftheHawk.IsSpellUsable
            && !AspectoftheHawk.HaveBuff && !ObjectManager.Me.HaveBuff(109260))
        {
            AspectoftheHawk.Cast();
            return;
        }

        if (MySettings.UseCamouflage && Camouflage.KnownSpell && Camouflage.IsSpellUsable && !Camouflage.HaveBuff
            && !ObjectManager.Me.InCombat)
        {
            Camouflage.Cast();
            return;
        }

        if (MySettings.UseAlchFlask && !ObjectManager.Me.HaveBuff(79638) && !ObjectManager.Me.HaveBuff(79640) && !ObjectManager.Me.HaveBuff(79639)
            && !ItemsManager.IsItemOnCooldown(75525) && ItemsManager.GetItemCount(75525) > 0)
            ItemsManager.UseItem(75525);
    }

    private void DismissPet()
    {
        if (MySettings.DismissOnCall)
        {
            if (!ObjectManager.Me.IsCast && (ObjectManager.Pet.Health == 0 || ObjectManager.Pet.Guid == 0 || !ObjectManager.Pet.IsValid) && Dismiss.KnownSpell && Dismiss.IsSpellUsable)
            {
                Dismiss.Cast();
                Others.SafeSleep(1500);
            }
        }
    }

    private void Pet()
    {
        if (MountTask.JustDismounted())
            return;
        if (MySettings.UsePet1 && !ObjectManager.Me.IsCast && (ObjectManager.Pet.Health == 0 || ObjectManager.Pet.Guid == 0 || !ObjectManager.Pet.IsValid) && CallPet1.KnownSpell && CallPet1.IsSpellUsable)
        {
            DismissPet();
            CallPet1.Cast();
            Others.SafeSleep(1000);
        }
        else if (MySettings.UsePet2 && !ObjectManager.Me.IsCast && (ObjectManager.Pet.Health == 0 || ObjectManager.Pet.Guid == 0 || !ObjectManager.Pet.IsValid) && CallPet2.KnownSpell && CallPet2.IsSpellUsable)
        {
            DismissPet();
            CallPet2.Cast();
            Others.SafeSleep(1000);
        }
        else if (MySettings.UsePet3 && !ObjectManager.Me.IsCast && (ObjectManager.Pet.Health == 0 || ObjectManager.Pet.Guid == 0 || !ObjectManager.Pet.IsValid) && CallPet3.KnownSpell && CallPet3.IsSpellUsable)
        {
            DismissPet();
            CallPet3.Cast();
            Others.SafeSleep(1000);
        }
        else if (MySettings.UsePet4 && !ObjectManager.Me.IsCast && (ObjectManager.Pet.Health == 0 || ObjectManager.Pet.Guid == 0 || !ObjectManager.Pet.IsValid) && CallPet4.KnownSpell && CallPet4.IsSpellUsable)
        {
            DismissPet();
            CallPet4.Cast();
            Others.SafeSleep(1000);
        }
        else
        {
            if (MySettings.UsePet5 && !ObjectManager.Me.IsCast && (ObjectManager.Pet.Health == 0 || ObjectManager.Pet.Guid == 0 || !ObjectManager.Pet.IsValid) && CallPet5.KnownSpell && CallPet5.IsSpellUsable)
            {
                DismissPet();
                CallPet5.Cast();
                Others.SafeSleep(1000);
            }
        }

        if (!ObjectManager.Me.IsCast && (!ObjectManager.Pet.IsAlive || ObjectManager.Pet.Guid == 0)
            && RevivePet.KnownSpell && RevivePet.IsSpellUsable && MySettings.UseRevivePet
            && MySettings.UseCombatRevive && ObjectManager.Target.HealthPercent > 10 && ObjectManager.Me.InCombat)
        {
            RevivePet.Cast();
            Others.SafeSleep(1000);
            return;
        }
        if (!ObjectManager.Me.IsCast && !ObjectManager.Pet.IsAlive
            && RevivePet.KnownSpell && RevivePet.IsSpellUsable && MySettings.UseRevivePet
            && !ObjectManager.Me.InCombat)
        {
            RevivePet.Cast();
            Others.SafeSleep(1000);
        }
    }

    private void AvoidMelee()
    {
        if (ObjectManager.Target.GetDistance < MySettings.DoAvoidMeleeDistance && ObjectManager.Target.InCombat)
        {
            if (Disengage.KnownSpell && MySettings.UseDisengage && Disengage.IsSpellUsable)
            {
                Logging.WriteFight("Too Close. Using disengage");
                Disengage.Cast();
                MovementManager.Face(ObjectManager.Target.Position);
            }
        }
    }

    private void DefenseCycle()
    {
        if (ObjectManager.Me.HealthPercent < 20 && MySettings.UseFeignDeath
            && FeignDeath.KnownSpell && FeignDeath.IsSpellUsable)
        {
            FeignDeath.Cast();
            Others.SafeSleep(5000);
            if (ObjectManager.Pet.Health == 0 || ObjectManager.Pet.Guid == 0 || !ObjectManager.Pet.IsValid)
                return;
            Others.SafeSleep(5000);
            return;
        }
        if (Deterrance.KnownSpell && MySettings.UseDeterrance && ObjectManager.Me.HealthPercent < 50
            && Deterrance.IsSpellUsable)
        {
            Deterrance.Cast();
            Others.SafeSleep(200);
            return;
        }
        if (MySettings.UseFreezingTrap && FreezingTrap.KnownSpell && ObjectManager.GetNumberAttackPlayer() > 1
            && ObjectManager.Target.GetDistance > 10 && FreezingTrap.IsSpellUsable)
        {
            UseTrap(FreezingTrap);
            return;
        }
        if (IceTrap.KnownSpell && MySettings.UseIceTrap && Disengage.KnownSpell && MySettings.UseDisengage
            && ObjectManager.Me.HealthPercent < 80 && ObjectManager.Target.GetDistance < 10
            && IceTrap.IsSpellUsable && Disengage.IsSpellUsable)
        {
            UseTrap(IceTrap);
            Others.SafeSleep(1000);
            MovementsAction.Jump();
            Disengage.Cast();
            return;
        }
        if (Disengage.KnownSpell && MySettings.UseDisengage && ConcussiveShot.KnownSpell
            && MySettings.UseConcussiveShot && ConcussiveShot.IsHostileDistanceGood
            && ObjectManager.Me.HealthPercent < 80 && ConcussiveShot.IsSpellUsable && Disengage.IsSpellUsable)
        {
            ConcussiveShot.Cast();
            Others.SafeSleep(1000);
            MovementsAction.Jump();
            Disengage.Cast();
            return;
        }
        if (BindingShot.KnownSpell && MySettings.UseBindingShot && Disengage.KnownSpell && MySettings.UseDisengage
            && ObjectManager.Me.HealthPercent < 80 && BindingShot.IsHostileDistanceGood
            && Disengage.IsSpellUsable && BindingShot.IsSpellUsable)
        {
            BindingShot.Cast();
            Others.SafeSleep(1000);
            MovementsAction.Jump();
            Disengage.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseWarStompAtPercentage && WarStomp.KnownSpell &&
            WarStomp.IsSpellUsable
            && MySettings.UseWarStomp)
        {
            WarStomp.Cast();
            _onCd = new Timer(1000*2);
            return;
        }
        if (ObjectManager.Me.HealthPercent <= MySettings.UseStoneformAtPercentage && Stoneform.KnownSpell &&
            Stoneform.IsSpellUsable
            && MySettings.UseStoneform)
        {
            Stoneform.Cast();
            _onCd = new Timer(1000*8);
        }
    }

    private void Heal()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (ObjectManager.Me.HealthPercent <= MySettings.UseGiftoftheNaaruAtPercentage && GiftoftheNaaru.KnownSpell
            && MySettings.UseGiftoftheNaaru && GiftoftheNaaru.IsSpellUsable)
        {
            GiftoftheNaaru.Cast();
            return;
        }
        if (Exhilaration.KnownSpell && MySettings.UseExhilaration && ObjectManager.Me.HealthPercent < 70
            && Exhilaration.IsSpellUsable)
        {
            Exhilaration.Cast();
            return;
        }
        if (FeedPet.KnownSpell && MySettings.UseFeedPet && !ObjectManager.Me.InCombat
            && ObjectManager.Pet.Health > 0 && ObjectManager.Pet.HealthPercent < 50 && FeedPet.IsSpellUsable)
        {
            FeedPet.Cast();
            return;
        }
        if (MySettings.UseMendPet && _mendPetTimer.IsReady && MendPet.KnownSpell && ObjectManager.Pet.Health > 0
            && ObjectManager.Pet.HealthPercent < 80 && MendPet.IsSpellUsable)
        {
            MendPet.Cast();
            _mendPetTimer = new Timer(1000*10);
        }
    }

    private void Decast()
    {
        if (ArcaneTorrent.IsSpellUsable && ArcaneTorrent.KnownSpell && ObjectManager.Target.GetDistance < 8
            && ObjectManager.Me.HealthPercent <= MySettings.UseArcaneTorrentForDecastAtPercentage
            && MySettings.UseArcaneTorrentForDecast && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe)
        {
            ArcaneTorrent.Cast();
            return;
        }
        if (ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe && SilencingShot.IsHostileDistanceGood
            && SilencingShot.KnownSpell && SilencingShot.IsSpellUsable && MySettings.UseSilencingShot)
        {
            SilencingShot.Cast();
            return;
        }
        if (ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe && ScatterShot.IsHostileDistanceGood
            && ScatterShot.KnownSpell && ScatterShot.IsSpellUsable && MySettings.UseScatterShot)
        {
            ScatterShot.Cast();
            return;
        }
        if (ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe && MySettings.UseWyvernSting
            && WyvernSting.KnownSpell && WyvernSting.IsSpellUsable && WyvernSting.IsHostileDistanceGood)
        {
            WyvernSting.Cast();
        }
    }

    private void DPSBurst()
    {
        if (MySettings.UseTrinketOne && !ItemsManager.IsItemOnCooldown(_firstTrinket.Entry) && ItemsManager.IsItemUsable(_firstTrinket.Entry))
        {
            ItemsManager.UseItem(_firstTrinket.Name);
            Logging.WriteFight("Use First Trinket Slot");
        }

        if (MySettings.UseTrinketTwo && !ItemsManager.IsItemOnCooldown(_secondTrinket.Entry) && ItemsManager.IsItemUsable(_secondTrinket.Entry))
        {
            ItemsManager.UseItem(_secondTrinket.Name);
            Logging.WriteFight("Use Second Trinket Slot");
            return;
        }
        if (MySettings.UseBerserking && Berserking.KnownSpell && ObjectManager.Target.GetDistance <= 40f
            && Berserking.IsSpellUsable)
        {
            Berserking.Cast();
            return;
        }
        if (MySettings.UseBloodFury && BloodFury.KnownSpell && ObjectManager.Target.GetDistance <= 40f
            && BloodFury.IsSpellUsable)
        {
            BloodFury.Cast();
            return;
        }
        if (AMurderofCrows.KnownSpell && MySettings.UseAMurderofCrows && AMurderofCrows.IsHostileDistanceGood
            && AMurderofCrows.IsSpellUsable && !AMurderofCrows.TargetHaveBuff)
        {
            AMurderofCrows.Cast();
            return;
        }
        if (Barrage.KnownSpell && MySettings.UseBarrage && Barrage.IsHostileDistanceGood && Barrage.IsSpellUsable)
        {
            Barrage.Cast();
            return;
        }
        if (BlinkStrike.KnownSpell && MySettings.UseBlinkStrike && ObjectManager.Pet.IsAlive
            && ObjectManager.Target.GetDistance <= 40f && BlinkStrike.IsSpellUsable)
        {
            BlinkStrike.Cast();
            return;
        }
        if (DireBeast.KnownSpell && MySettings.UseDireBeast && _direBeastTimer.IsReady
            && DireBeast.IsHostileDistanceGood && DireBeast.IsSpellUsable)
        {
            DireBeast.Cast();
            _direBeastTimer = new Timer(1000*15);
            return;
        }
        if (Fervor.KnownSpell && MySettings.UseFervor && ObjectManager.Me.Focus < 50
            && Fervor.IsSpellUsable)
        {
            Fervor.Cast();
            return;
        }
        if (GlaiveToss.KnownSpell && MySettings.UseGlaiveToss && GlaiveToss.IsHostileDistanceGood
            && GlaiveToss.IsSpellUsable)
        {
            GlaiveToss.Cast();
            return;
        }
        if (LynxRush.KnownSpell && MySettings.UseLynxRush && ObjectManager.Target.GetDistance <= 40f
            && LynxRush.IsSpellUsable)
        {
            LynxRush.Cast();
            return;
        }
        if (Powershot.KnownSpell && MySettings.UsePowershot && Powershot.IsHostileDistanceGood
            && Powershot.IsSpellUsable)
        {
            Powershot.Cast();
            return;
        }
        if (Stampede.KnownSpell && MySettings.UseStampede && Stampede.IsHostileDistanceGood
            && Stampede.IsSpellUsable)
        {
            Stampede.Cast();
        }
    }

    private void DPSCycle()
    {
        Usefuls.SleepGlobalCooldown();
        try
        {
            Memory.WowMemory.GameFrameLock(); // !!! WARNING - DONT SLEEP WHILE LOCKED - DO FINALLY(GameFrameUnLock()) !!!

            if (ArcaneShot.KnownSpell && MySettings.UseArcaneShot && !SerpentSting.TargetHaveBuff
                && ArcaneShot.IsHostileDistanceGood && ArcaneShot.IsSpellUsable)
            {
                ArcaneShot.Cast();
                _serpentStingTimer = new Timer(1000*12);
                return;
            }
            if (ArcaneShot.KnownSpell && MySettings.UseArcaneShot && _serpentStingTimer.IsReady
                && ArcaneShot.IsHostileDistanceGood && ArcaneShot.IsSpellUsable)
            {
                ArcaneShot.Cast();
                _serpentStingTimer = new Timer(1000*12);
                return;
            }
            if (KillShot.KnownSpell && MySettings.UseKillShot && KillShot.IsHostileDistanceGood
                && KillShot.IsSpellUsable)
            {
                KillShot.Cast();
                return;
            }
            if (ObjectManager.GetNumberAttackPlayer() > 4 && MySettings.UseMultiShot && MySettings.UseExplosiveTrap
                && MySettings.UseExplosiveShot)
            {
                if (MultiShot.KnownSpell && MultiShot.IsHostileDistanceGood && MultiShot.IsSpellUsable)
                {
                    MultiShot.Cast();
                    return;
                }
                if (ExplosiveTrap.KnownSpell && ObjectManager.Target.GetDistance < 10 && ExplosiveTrap.IsSpellUsable)
                {
                    UseTrap(ExplosiveTrap);
                    return;
                }
                if (ExplosiveShot.KnownSpell && ExplosiveShot.IsHostileDistanceGood && ExplosiveShot.IsSpellUsable)
                {
                    ExplosiveShot.Cast();
                    return;
                }
                return;
            }
            if (ExplosiveTrap.KnownSpell && MySettings.UseExplosiveTrap && ObjectManager.Target.GetDistance < 10
                && ObjectManager.GetNumberAttackPlayer() < 4 && ObjectManager.GetNumberAttackPlayer() > 1
                && ExplosiveTrap.IsSpellUsable)
            {
                UseTrap(ExplosiveTrap);
                return;
            }
            if (BlackArrow.KnownSpell && MySettings.UseBlackArrow && BlackArrow.IsHostileDistanceGood
                && BlackArrow.IsSpellUsable)
            {
                BlackArrow.Cast();
                return;
            }
            if (ExplosiveShot.KnownSpell && MySettings.UseExplosiveShot && ExplosiveShot.IsHostileDistanceGood
                && ExplosiveShot.IsSpellUsable)
            {
                ExplosiveShot.Cast();
                return;
            }
            if (MultiShot.KnownSpell && MySettings.UseMultiShot && MultiShot.IsHostileDistanceGood
                && ObjectManager.Me.FocusPercentage > 79
                && ObjectManager.GetNumberAttackPlayer() < 4 && ObjectManager.GetNumberAttackPlayer() > 1
                && MultiShot.IsSpellUsable)
            {
                MultiShot.Cast();
                return;
            }
            if (ArcaneShot.KnownSpell && MySettings.UseArcaneShot && ArcaneShot.IsHostileDistanceGood
                && ObjectManager.Me.FocusPercentage > 79 && ArcaneShot.IsSpellUsable)
            {
                ArcaneShot.Cast();
                return;
            }
            if (ArcaneTorrent.KnownSpell && MySettings.UseArcaneTorrentForResource
                && ArcaneTorrent.IsSpellUsable)
            {
                ArcaneTorrent.Cast();
                return;
            }
            if (CobraShot.KnownSpell && MySettings.UseCobraShot && CobraShot.IsHostileDistanceGood
                && ObjectManager.Me.FocusPercentage < 80 && CobraShot.IsSpellUsable)
            {
                CobraShot.Cast();
                return;
            }
            if (SteadyShot.KnownSpell && SteadyShot.IsHostileDistanceGood
                && ObjectManager.Me.FocusPercentage < 60 && (!CobraShot.KnownSpell || !MySettings.UseCobraShot)
                && SteadyShot.IsSpellUsable)
            {
                SteadyShot.Cast();
            }
        }
        finally
        {
            Memory.WowMemory.GameFrameUnLock();
        }
    }

    private void Patrolling()
    {
        if (ObjectManager.Me.IsMounted) return;
        Buff();
        Heal();
    }

    #region Nested type: HunterSurvivalSettings

    [Serializable]
    public class HunterSurvivalSettings : Settings
    {
        public bool DismissOnCall = true;
        public bool DoAvoidMelee = false;
        public int DoAvoidMeleeDistance = 0;
        public bool UseAMurderofCrows = true;
        public bool UseAlchFlask = true;
        public bool UseArcaneShot = true;
        public bool UseArcaneTorrentForDecast = true;
        public int UseArcaneTorrentForDecastAtPercentage = 100;
        public bool UseArcaneTorrentForResource = true;
        public bool UseAspectoftheHawk = true;
        public bool UseBarrage = true;
        public bool UseBerserking = true;
        public bool UseBindingShot = true;
        public bool UseBlackArrow = true;
        public bool UseBlinkStrike = true;
        public bool UseBloodFury = true;
        public bool UseCamouflage = false;
        public bool UseCobraShot = true;
        public bool UseCombatRevive = true;
        public bool UseConcussiveShot = true;
        public bool UseDeterrance = true;
        public bool UseDireBeast = true;
        public bool UseDisengage = true;

        public bool UseExhilaration = true;
        public bool UseExplosiveShot = true;
        public bool UseExplosiveTrap = true;
        public bool UseFeedPet = true;
        public bool UseFeignDeath = true;
        public bool UseFervor = true;
        public bool UseFreezingTrap = true;
        public bool UseGiftoftheNaaru = true;
        public int UseGiftoftheNaaruAtPercentage = 80;
        public bool UseGlaiveToss = true;
        public bool UseHuntersMark = true;
        public bool UseIceTrap = true;
        public bool UseKillShot = true;

        public bool UseLowCombat = true;
        public bool UseLynxRush = true;
        public bool UseMendPet = true;
        public bool UseMisdirection = true;
        public bool UseMultiShot = true;
        public bool UsePet1 = true;
        public bool UsePet2 = false;
        public bool UsePet3 = false;
        public bool UsePet4 = false;
        public bool UsePet5 = false;
        public bool UsePowershot = true;
        public bool UseRevivePet = true;
        public bool UseScatterShot = true;
        public bool UseSerpentSting = true;
        public bool UseSilencingShot = true;
        public bool UseStampede = true;
        public bool UseStoneform = true;
        public int UseStoneformAtPercentage = 80;
        public bool UseTrinketOne = true;
        public bool UseTrinketTwo = true;
        public bool UseWarStomp = true;
        public int UseWarStompAtPercentage = 80;
        public bool UseWyvernSting = true;

        public HunterSurvivalSettings()
        {
            ConfigWinForm("Hunter Survival Settings");
            /* Professions & Racials */
            AddControlInWinForm("Use Arcane Torrent for Interrupt", "UseArcaneTorrentForDecast", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Arcane Torrent for Resource", "UseArcaneTorrentForResource", "Professions & Racials");
            AddControlInWinForm("Use Berserking", "UseBerserking", "Professions & Racials");
            AddControlInWinForm("Use Blood Fury", "UseBloodFury", "Professions & Racials");
            AddControlInWinForm("Use Gift of the Naaru", "UseGiftoftheNaaru", "Professions & Racials");

            AddControlInWinForm("Use Stoneform", "UseStoneform", "Professions & Racials");
            AddControlInWinForm("Use War Stomp", "UseWarStomp", "Professions & Racials");
            /* Hunter Buffs */
            AddControlInWinForm("Use Aspect of the Hawk", "UseAspectoftheHawk", "Hunter Buffs");
            AddControlInWinForm("Use Camouflage", "UseCamouflage", "Hunter Buffs");
            AddControlInWinForm("Use Feign Death", "UseFeignDeath", "Hunter Buffs");
            AddControlInWinForm("Use Hunter's Mark", "UseHuntersMark", "Hunter Buffs");
            AddControlInWinForm("Use Misdirection", "UseMisdirection", "Hunter Buffs");
            /* Offensive Spell */
            AddControlInWinForm("Use Arcane Shot", "UseArcaneShot", "Offensive Spell");
            AddControlInWinForm("Use Black Arrow", "UseBlackArrow", "Offensive Spell");
            AddControlInWinForm("Dismiss pet before calling again", "DismissOnCall", "Offensive Spell");
            AddControlInWinForm("Use Pet in Slot 1", "UsePet1", "Offensive Spell");
            AddControlInWinForm("Use Pet in Slot 2", "UsePet2", "Offensive Spell");
            AddControlInWinForm("Use Pet in Slot 3", "UsePet3", "Offensive Spell");
            AddControlInWinForm("Use Pet in Slot 4", "UsePet4", "Offensive Spell");
            AddControlInWinForm("Use Pet in Slot 5", "UsePet5", "Offensive Spell");
            AddControlInWinForm("Use Cobra Shot", "UseCobraShot", "Offensive Spell");
            AddControlInWinForm("Use Explosive Shot", "UseExplosiveShot", "Offensive Spell");
            AddControlInWinForm("Use Explosive Trap", "UseExplosiveTrap", "Offensive Spell");
            AddControlInWinForm("Use KillShot", "UseKillShot", "Offensive Spell");
            AddControlInWinForm("Use Multi-Shot", "UseMultiShot", "Offensive Spell");
            AddControlInWinForm("Use Serpent Sting", "UseSerpentSting", "Offensive Spell");
            /* Offensive Cooldown */
            AddControlInWinForm("Use A Murder of Crows", "UseAMurderofCrows", "Offensive Cooldown");
            AddControlInWinForm("Use Barrage", "UseBarrage", "Offensive Cooldown");
            AddControlInWinForm("Use Blink Strike", "UseBlinkStrike", "Offensive Cooldown");
            AddControlInWinForm("Use Dire Beast", "UseDireBeast", "Offensive Cooldown");
            AddControlInWinForm("Use Fervor", "UseFervor", "Offensive Cooldown");
            AddControlInWinForm("Use Glaive Toss", "UseGlaiveToss", "Offensive Cooldown");
            AddControlInWinForm("Use Lynx Rush", "UseLynxRush", "Offensive Cooldown");
            AddControlInWinForm("Use Powershot", "UsePowershot", "Offensive Cooldown");
            AddControlInWinForm("Use Rapid Fire", "UseRapidFire", "Offensive Cooldown");
            AddControlInWinForm("Use Readiness", "UseReadiness", "Offensive Cooldown");
            AddControlInWinForm("Use Stampede", "UseStampede", "Offensive Cooldown");
            /* Defensive Cooldown */
            AddControlInWinForm("Use Binding Shot", "UseBindingShot", "Defensive Cooldown");
            AddControlInWinForm("Use Concussive Shot", "UseConcussiveShot", "Defensive Cooldown");
            AddControlInWinForm("Use Deterrance", "UseDeterrance", "Defensive Cooldown");
            AddControlInWinForm("Use Disengage", "UseDisengage", "Defensive Cooldown");
            AddControlInWinForm("Use Freezing Trap", "UseFreezingTrap", "Defensive Cooldown");
            AddControlInWinForm("Use Ice Trap", "UseIceTrap", "Defensive Cooldown");
            AddControlInWinForm("Use Scatter Shot", "UseScatterShot", "Defensive Cooldown");
            AddControlInWinForm("Use Silencing Shot", "UseSilencingShot", "Defensive Cooldown");
            AddControlInWinForm("Use Wyvern Sting", "UseWyvernSting", "Defensive Cooldown");
            /* Healing Spell */
            AddControlInWinForm("Use Exhilaration", "UseExhilaration", "Healing Spell");
            AddControlInWinForm("Use Feed Pet", "UseFeedPet", "Healing Spell");
            AddControlInWinForm("Use Mend Pet", "UseMendPet", "Healing Spell");
            AddControlInWinForm("Use Revive Pet", "UseRevivePet", "Healing Spell");
            /* Game Settings */
            AddControlInWinForm("Use Low Combat Settings", "UseLowCombat", "Game Settings");
            AddControlInWinForm("Use Trinket One", "UseTrinketOne", "Game Settings");
            AddControlInWinForm("Use Trinket Two", "UseTrinketTwo", "Game Settings");

            AddControlInWinForm("Use Alchemist Flask", "UseAlchFlask", "Game Settings");
            AddControlInWinForm("Use Revive Pet in Combat", "UseCombatRevive", "Game Settings");
            AddControlInWinForm("Do avoid melee (Off Advised!!)", "DoAvoidMelee", "Game Settings");
            AddControlInWinForm("Avoid melee distance (1 to 4)", "DoAvoidMeleeDistance", "Game Settings");
        }

        public static HunterSurvivalSettings CurrentSetting { get; set; }

        public static HunterSurvivalSettings GetSettings()
        {
            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Hunter_Survival.xml";
            if (File.Exists(currentSettingsFile))
            {
                return
                    CurrentSetting = Load<HunterSurvivalSettings>(currentSettingsFile);
            }
            return new HunterSurvivalSettings();
        }
    }

    #endregion
}

#endregion

#region Monk

public class MonkBrewmaster
{
    private static MonkBrewmasterSettings MySettings = MonkBrewmasterSettings.GetSettings();

    #region General Timers & Variables

    private readonly WoWItem _firstTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET);
    private readonly WoWItem _secondTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET, 2);
    public int ElusiveBrewStack = 0;

    private Timer _grappleWeaponTimer = new Timer(0);
    private Timer _healingSphereTimer = new Timer(0);
    private Timer _onCd = new Timer(0);
/*
        private Timer _staggerTimer = new Timer(0);
*/

    #endregion

    #region Professions & Racials

    public readonly Spell Alchemy = new Spell("Alchemy");
    public readonly Spell ArcaneTorrent = new Spell("Arcane Torrent");
    public readonly Spell Berserking = new Spell("Berserking");
    public readonly Spell BloodFury = new Spell("Blood Fury");

    public readonly Spell GiftoftheNaaru = new Spell("Gift of the Naaru");

    public readonly Spell Stoneform = new Spell("Stoneform");
    public readonly Spell WarStomp = new Spell("War Stomp");

    #endregion

    #region Monk Buffs

    public readonly Spell Disable = new Spell("Disable");
    public readonly Spell LegacyoftheEmperor = new Spell("Legacy of the Emperor");
    public readonly Spell StanceoftheFierceTiger = new Spell("Stance of the Fierce Tiger");
    public readonly Spell StanceoftheSturdyOx = new Spell("Stance of the Sturdy Ox");
    public readonly Spell TigersLust = new Spell("Tiger's Lust");

    #endregion

    #region Offensive Spell

    public readonly Spell BlackoutKick = new Spell("Blackout Kick");
    public readonly Spell BreathofFire = new Spell("Breathe of Fire");
    public readonly Spell Clash = new Spell("Clash");
    public readonly Spell CracklingJadeLightning = new Spell("Crackling Jade Lightning");
    public readonly Spell DizzyingHaze = new Spell("Dizzying Haze");
    public readonly Spell Jab = new Spell("Jab");
    public readonly Spell KegSmash = new Spell("Keg Smash");
    public readonly Spell Provoke = new Spell("Provoke");
    public readonly Spell Roll = new Spell("Roll");
    public readonly Spell SpinningCraneKick = new Spell("Spinning Crane Kick");
    public readonly Spell TigerPalm = new Spell("Tiger Palm");
    public readonly Spell TouchofDeath = new Spell("Touch of Death");

    #endregion

    #region Offensive Cooldown

    public readonly Spell ChiBrew = new Spell("Chi Brew");
    public readonly Spell InvokeXuentheWhiteTiger = new Spell("Invoke Xuen, the White Tiger");
    public readonly Spell RushingJadeWind = new Spell("Rushing Jade Wind");

    #endregion

    #region Defensive Cooldown

    public readonly Spell ChargingOxWave = new Spell("Charging Ox Wave");
    public readonly Spell DampenHarm = new Spell("Dampen Harm");
    public readonly Spell DiffuseMagic = new Spell("Diffuse Magic");
    public readonly Spell ElusiveBrew = new Spell("Elusive Brew");
    public readonly Spell FortifyingBrew = new Spell("Fortifying Brew");
    public readonly Spell GrappleWeapon = new Spell("Grapple Weapon");
    public readonly Spell Guard = new Spell("Guard");
    public readonly Spell LegSweep = new Spell("Leg Sweep");
    public readonly Spell PurifyingBrew = new Spell("Purifying Brew");
    public readonly Spell SpearHandStrike = new Spell("Spear Hand Strike");
    public readonly Spell SummonBlackOxStatue = new Spell("Summon Black Ox Statue");
    public readonly Spell ZenMeditation = new Spell("Zen Meditation");
    private Timer _furifyingBrewTimer = new Timer(0);

    #endregion

    #region Healing Spell

    public readonly Spell ChiBurst = new Spell("Chi Burst");
    public readonly Spell ChiWave = new Spell("Chi Wave");
    public readonly Spell ExpelHarm = new Spell("Expel Harm");
    public readonly Spell HealingSphere = new Spell("Healing Sphere");
    public readonly Spell ZenSphere = new Spell("Zen Sphere");

    #endregion

    public MonkBrewmaster()
    {
        Main.InternalRange = ObjectManager.Me.GetCombatReach;
        Main.InternalAggroRange = 25.0f;
        MySettings = MonkBrewmasterSettings.GetSettings();
        Main.DumpCurrentSettings<MonkBrewmasterSettings>(MySettings);
        UInt128 lastTarget = 0;

        while (Main.InternalLoop)
        {
            try
            {
                if (!ObjectManager.Me.IsDead)
                {
                    if (!ObjectManager.Me.IsMounted)
                    {
                        if (Fight.InFight && ObjectManager.Me.Target > 0)
                        {
                            if (ObjectManager.Me.Target != lastTarget &&
                                Provoke.IsHostileDistanceGood)
                            {
                                Pull();
                                lastTarget = ObjectManager.Me.Target;
                            }

                            if (ObjectManager.Target.GetDistance < Main.InternalAggroRange)
                                Combat();
                        }
                        if (!ObjectManager.Me.IsCast)
                            Patrolling();
                    }
                }
                else
                    Thread.Sleep(500);
            }
            catch
            {
            }
            Thread.Sleep(100);
        }
    }

    private void Pull()
    {
        if (MySettings.UseClash && Clash.KnownSpell && Clash.IsHostileDistanceGood && Clash.IsSpellUsable)
            Clash.Cast();

        if (MySettings.UseProvoke && Provoke.KnownSpell && !ObjectManager.Target.InCombat && Provoke.IsHostileDistanceGood && Provoke.IsSpellUsable)
        {
            Provoke.Cast();
        }
    }

    private void Combat()
    {
        Buff();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        DPSCycle();
        if (_onCd.IsReady &&
            (ObjectManager.Me.HealthPercent <= MySettings.UseGrappleWeaponAtPercentage || ObjectManager.Me.HealthPercent <= MySettings.UseElusiveBrewAtPercentage
             || ObjectManager.Me.HealthPercent <= MySettings.UseFortifyingBrewAtPercentage ||
             ObjectManager.Me.HealthPercent <= MySettings.UseChargingOxWaveAtPercentage
             || ObjectManager.Me.HealthPercent <= MySettings.UseDampenHarmAtPercentage || ObjectManager.Me.HealthPercent <= MySettings.UseLegSweepAtPercentage
             || ObjectManager.Me.HealthPercent <= MySettings.UseGuardAtPercentage || ObjectManager.Me.HealthPercent <= MySettings.UseStoneformAtPercentage
             || ObjectManager.Me.HealthPercent <= MySettings.UseWarStompAtPercentage || ObjectManager.Me.HealthPercent <= MySettings.UsePurifyingBrewAtPercentage))
            DefenseCycle();
        Heal();
        Decast();
        DPSBurst();
        DPSCycle();
    }

    private void Buff()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (MySettings.UseLegacyoftheEmperor && LegacyoftheEmperor.KnownSpell && !LegacyoftheEmperor.HaveBuff && LegacyoftheEmperor.IsSpellUsable)
            LegacyoftheEmperor.Cast();

        if (MySettings.UseStanceoftheSturdyOx && StanceoftheSturdyOx.KnownSpell && !StanceoftheSturdyOx.HaveBuff && StanceoftheSturdyOx.IsSpellUsable)
            StanceoftheSturdyOx.Cast();

        if (MySettings.UseTigersLust && TigersLust.KnownSpell && !ObjectManager.Me.InCombat && ObjectManager.Me.GetMove && TigersLust.IsSpellUsable)
            TigersLust.Cast();

        if (MySettings.UseRoll && !ObjectManager.Me.InCombat && Roll.KnownSpell && ObjectManager.Me.GetMove
            && !TigersLust.HaveBuff && Roll.IsSpellUsable && ObjectManager.Target.GetDistance > 14)
            Roll.Cast();

        if (MySettings.UseSummonBlackOxStatue && SummonBlackOxStatue.KnownSpell && !ObjectManager.Me.HaveBuff(126119) && SummonBlackOxStatue.IsSpellUsable
            && ObjectManager.Target.GetDistance < 30 && ObjectManager.Target.InCombat)
            SpellManager.CastSpellByIDAndPosition(115315, ObjectManager.Target.Position);

        if (MySettings.UseAlchFlask && !ObjectManager.Me.HaveBuff(79638) && !ObjectManager.Me.HaveBuff(79640) && !ObjectManager.Me.HaveBuff(79639)
            && !ItemsManager.IsItemOnCooldown(75525) && ItemsManager.GetItemCount(75525) > 0)
            ItemsManager.UseItem(75525);
    }

    private void AvoidMelee()
    {
        if (ObjectManager.Target.GetDistance < 1.0f && ObjectManager.Target.GetDistance < ObjectManager.Target.GetBoundingRadius && ObjectManager.Target.InCombat)
        {
            Logging.WriteFight("Too Close. Moving forward");
            MovementsAction.MoveForward(true);
            Others.SafeSleep(1250);
            MovementsAction.MoveForward(false);
            MovementManager.Face(ObjectManager.Target.Position);
        }
    }

    private void DefenseCycle()
    {
        if (MySettings.UseGrappleWeapon && GrappleWeapon.KnownSpell && GrappleWeapon.IsHostileDistanceGood &&
            ObjectManager.Me.HealthPercent <= MySettings.UseGrappleWeaponAtPercentage
            && _grappleWeaponTimer.IsReady && GrappleWeapon.IsSpellUsable)
        {
            GrappleWeapon.Cast();
            _grappleWeaponTimer = new Timer(1000*60);
            return;
        }
        if (MySettings.UseElusiveBrew && ElusiveBrew.KnownSpell && ObjectManager.Me.InCombat && ObjectManager.Me.HealthPercent <= MySettings.UseElusiveBrewAtPercentage
            && ElusiveBrew.IsSpellUsable && ObjectManager.Me.BuffStack(128939) > 5)
        {
            ElusiveBrewStack = ObjectManager.Me.BuffStack(128939);
            ElusiveBrew.Cast();
            _onCd = new Timer(1000*ElusiveBrewStack);
            return;
        }
        if (MySettings.UseFortifyingBrew && FortifyingBrew.KnownSpell && ObjectManager.Me.HealthPercent <= MySettings.UseFortifyingBrewAtPercentage &&
            FortifyingBrew.IsSpellUsable)
        {
            FortifyingBrew.Cast();
            _onCd = new Timer(1000*20);
            return;
        }
        if (MySettings.UseChargingOxWave && ChargingOxWave.KnownSpell && ChargingOxWave.IsHostileDistanceGood &&
            ObjectManager.Me.HealthPercent <= MySettings.UseChargingOxWaveAtPercentage
            && ChargingOxWave.IsSpellUsable)
        {
            ChargingOxWave.Cast();
            _onCd = new Timer(1000*3);
            return;
        }
        if (MySettings.UseDampenHarm && DampenHarm.KnownSpell && DampenHarm.IsSpellUsable && ObjectManager.Me.HealthPercent <= MySettings.UseDampenHarmAtPercentage)
        {
            DampenHarm.Cast();
            _onCd = new Timer(1000*5);
            return;
        }
        if (MySettings.UseLegSweep && LegSweep.KnownSpell && ObjectManager.Target.GetDistance < 6 &&
            ObjectManager.Me.HealthPercent <= MySettings.UseLegSweepAtPercentage
            && LegSweep.IsSpellUsable)
        {
            LegSweep.Cast();
            _onCd = new Timer(1000*5);
            return;
        }
        if (MySettings.UseGuard && Guard.KnownSpell && ObjectManager.Me.HaveBuff(118636) && Guard.IsSpellUsable &&
            ObjectManager.Me.HealthPercent <= MySettings.UseGuardAtPercentage)
        {
            Guard.Cast();
            _onCd = new Timer(1000*5);
            return;
        }
        if (MySettings.UsePurifyingBrew && PurifyingBrew.KnownSpell && ObjectManager.Me.HaveBuff(124255) && _furifyingBrewTimer.IsReady &&
            PurifyingBrew.IsSpellUsable
            && ObjectManager.Me.HealthPercent <= MySettings.UsePurifyingBrewAtPercentage)
        {
            PurifyingBrew.Cast();
            _furifyingBrewTimer = new Timer(1000*10);
            return;
        }
        if (MySettings.UseStoneform && Stoneform.KnownSpell && Stoneform.IsSpellUsable &&
            ObjectManager.Me.HealthPercent <= MySettings.UseStoneformAtPercentage)
        {
            Stoneform.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (MySettings.UseWarStomp && WarStomp.KnownSpell && ObjectManager.Target.GetDistance < 8 && WarStomp.IsSpellUsable &&
            ObjectManager.Me.HealthPercent <= MySettings.UseWarStompAtPercentage)
        {
            WarStomp.Cast();
            _onCd = new Timer(1000*2);
        }
    }

    private void Heal()
    {
        if (MySettings.UseGiftoftheNaaru && GiftoftheNaaru.KnownSpell && GiftoftheNaaru.IsSpellUsable
            && ObjectManager.Me.HealthPercent <= MySettings.UseGiftoftheNaaruAtPercentage)
        {
            GiftoftheNaaru.Cast();
            return;
        }
        if (MySettings.UseHealingSphere && HealingSphere.KnownSpell && HealingSphere.IsSpellUsable && _healingSphereTimer.IsReady &&
            ObjectManager.Me.HealthPercent <= MySettings.UseHealingSphereAtPercentage)
        {
            SpellManager.CastSpellByIDAndPosition(115460, ObjectManager.Me.Position);
            _healingSphereTimer = new Timer(1000*8);
            return;
        }
        if (MySettings.UseChiWave && ChiWave.KnownSpell && ObjectManager.Me.HealthPercent <= MySettings.UseChiWaveAtPercentage && ChiWave.IsSpellUsable)
        {
            ChiWave.Cast();
            return;
        }
        if (MySettings.UseChiBurst && ChiBurst.KnownSpell && ObjectManager.Me.HealthPercent <= MySettings.UseChiBurstAtPercentage && ChiBurst.IsSpellUsable)
        {
            ChiBurst.Cast();
            return;
        }
        if (MySettings.UseExpelHarm && ExpelHarm.KnownSpell && ObjectManager.Me.HealthPercent <= MySettings.UseExpelHarmAtPercentage && ExpelHarm.IsSpellUsable)
        {
            ExpelHarm.Cast();
            return;
        }
        if (MySettings.UseZenSphere && ZenSphere.KnownSpell && ObjectManager.Me.HealthPercent <= MySettings.UseZenSphereAtPercentage
            && !ZenSphere.HaveBuff && ZenSphere.IsSpellUsable)
        {
            ZenSphere.Cast();
        }
    }

    private void Decast()
    {
        if (MySettings.UseArcaneTorrentForDecast && ArcaneTorrent.KnownSpell && ObjectManager.Me.HealthPercent <= MySettings.UseArcaneTorrentForDecastAtPercentage
            && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe && ObjectManager.Target.GetDistance < 8 && ArcaneTorrent.IsSpellUsable)
        {
            ArcaneTorrent.Cast();
            return;
        }
        if (MySettings.UseDiffuseMagic && DiffuseMagic.KnownSpell && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe && DiffuseMagic.IsSpellUsable
            && ObjectManager.Me.HealthPercent <= MySettings.UseDiffuseMagicAtPercentage)
        {
            DiffuseMagic.Cast();
            return;
        }
        if (MySettings.UseSpearHandStrike && SpearHandStrike.KnownSpell && ObjectManager.Target.IsCast && SpearHandStrike.IsHostileDistanceGood && SpearHandStrike.IsSpellUsable
            && ObjectManager.Me.HealthPercent <= MySettings.UseSpearHandStrikeAtPercentage)
        {
            SpearHandStrike.Cast();
            return;
        }
        if (MySettings.UseDisable && Disable.KnownSpell && ObjectManager.Target.GetMove && !Disable.TargetHaveBuff && Disable.IsHostileDistanceGood && Disable.IsSpellUsable)
        {
            Disable.Cast();
        }
    }

    private void DPSBurst()
    {
        if (MySettings.UseTrinketOne && !ItemsManager.IsItemOnCooldown(_firstTrinket.Entry) && ItemsManager.IsItemUsable(_firstTrinket.Entry))
        {
            ItemsManager.UseItem(_firstTrinket.Name);
            Logging.WriteFight("Use First Trinket Slot");
        }
        if (MySettings.UseTrinketTwo && !ItemsManager.IsItemOnCooldown(_secondTrinket.Entry) && ItemsManager.IsItemUsable(_secondTrinket.Entry))
        {
            ItemsManager.UseItem(_secondTrinket.Name);
            Logging.WriteFight("Use Second Trinket Slot");
            return;
        }
        if (MySettings.UseBerserking && Berserking.KnownSpell && ObjectManager.Target.GetDistance < 30 && Berserking.IsSpellUsable)
        {
            Berserking.Cast();
            return;
        }
        if (MySettings.UseBloodFury && BloodFury.KnownSpell && ObjectManager.Target.GetDistance < 30 && BloodFury.IsSpellUsable)
        {
            BloodFury.Cast();
            return;
        }
        if (MySettings.UseChiBrew && ChiBrew.KnownSpell && ObjectManager.Me.Chi == 0 && ChiBrew.IsSpellUsable)
        {
            ChiBrew.Cast();
        }

        if (MySettings.UseTouchofDeath && TouchofDeath.KnownSpell && TouchofDeath.IsHostileDistanceGood && TouchofDeath.IsSpellUsable)
        {
            TouchofDeath.Cast();
        }

        if (MySettings.UseInvokeXuentheWhiteTiger && InvokeXuentheWhiteTiger.KnownSpell && InvokeXuentheWhiteTiger.IsHostileDistanceGood &&
            InvokeXuentheWhiteTiger.IsSpellUsable)
        {
            InvokeXuentheWhiteTiger.Cast();
        }
        if (MySettings.UseRushingJadeWind && RushingJadeWind.KnownSpell && RushingJadeWind.IsHostileDistanceGood && RushingJadeWind.IsSpellUsable
            && ObjectManager.GetNumberAttackPlayer() > 3)
        {
            RushingJadeWind.Cast();
        }
    }

    private void DPSCycle()
    {
        Usefuls.SleepGlobalCooldown();
        try
        {
            Memory.WowMemory.GameFrameLock(); // !!! WARNING - DONT SLEEP WHILE LOCKED - DO FINALLY(GameFrameUnLock()) !!!

            if (ObjectManager.GetNumberAttackPlayer() > 2)
            {
                if (MySettings.UseSpinningCraneKick && SpinningCraneKick.KnownSpell && ObjectManager.GetNumberAttackPlayer() > 5 && !ObjectManager.Me.IsCast
                    && ObjectManager.Target.GetDistance < 8 && SpinningCraneKick.IsSpellUsable)
                {
                    SpinningCraneKick.Cast();
                    return;
                }
                if (MySettings.UseDizzyingHaze && DizzyingHaze.KnownSpell && !DizzyingHaze.TargetHaveBuff && DizzyingHaze.IsHostileDistanceGood && DizzyingHaze.IsSpellUsable)
                {
                    SpellManager.CastSpellByIDAndPosition(115180, ObjectManager.Target.Position);
                    return;
                }
                if (MySettings.UseBreathofFire && BreathofFire.KnownSpell && !BreathofFire.TargetHaveBuff && ObjectManager.Target.GetDistance < 8 && BreathofFire.IsSpellUsable)
                {
                    BreathofFire.Cast();
                    return;
                }
                if (MySettings.UseRushingJadeWind && RushingJadeWind.KnownSpell && ObjectManager.Target.GetDistance < 30 && RushingJadeWind.IsSpellUsable)
                {
                    RushingJadeWind.Cast();
                    return;
                }
                return;
            }
            if (MySettings.UseRushingJadeWind && RushingJadeWind.KnownSpell && ObjectManager.Target.GetDistance < 30 && !ObjectManager.Target.HaveBuff(115307) &&
                RushingJadeWind.IsSpellUsable)
            {
                RushingJadeWind.Cast();
                return;
            }
            if (MySettings.UseBlackoutKick && BlackoutKick.KnownSpell && BlackoutKick.IsHostileDistanceGood && BlackoutKick.IsSpellUsable &&
                (!ObjectManager.Me.HaveBuff(121125) || !MySettings.UseTouchofDeath) && (!ObjectManager.Me.HaveBuff(115307) || !StanceoftheSturdyOx.KnownSpell))
            {
                BlackoutKick.Cast();
                return;
            }
            if (MySettings.UseTigerPalm && TigerPalm.KnownSpell && TigerPalm.IsHostileDistanceGood && TigerPalm.IsSpellUsable &&
                (!ObjectManager.Me.HaveBuff(121125) || !MySettings.UseTouchofDeath)
                &&
                (!ObjectManager.Me.HaveBuff(125359) ||
                 (!ObjectManager.Me.HaveBuff(118636) && Guard.IsSpellUsable && ObjectManager.Me.HealthPercent <= MySettings.UseGuardAtPercentage)))
            {
                TigerPalm.Cast();
                return;
            }
            if (MySettings.UseKegSmash && KegSmash.KnownSpell && KegSmash.IsHostileDistanceGood && ObjectManager.Me.Chi < 3 && KegSmash.IsSpellUsable)
            {
                KegSmash.Cast();
                return;
            }
            if (MySettings.UseArcaneTorrentForResource && ArcaneTorrent.KnownSpell && ObjectManager.Me.EnergyPercentage < 40 && ArcaneTorrent.IsSpellUsable
                && ObjectManager.Me.HealthPercent <= MySettings.UseExpelHarmAtPercentage)
            {
                ArcaneTorrent.Cast();
                return;
            }
            if (MySettings.UseExpelHarm && ExpelHarm.KnownSpell && ObjectManager.Me.HealthPercent <= MySettings.UseExpelHarmAtPercentage && ObjectManager.Me.Chi < 4
                && ExpelHarm.IsHostileDistanceGood && ExpelHarm.IsSpellUsable)
            {
                ExpelHarm.Cast();
                return;
            }
            if (MySettings.UseJab && Jab.KnownSpell && ObjectManager.Me.Chi < 4 && Jab.IsHostileDistanceGood && Jab.IsSpellUsable)
            {
                Jab.Cast();
                return;
            }
            if (MySettings.UseTigerPalm && TigerPalm.KnownSpell && TigerPalm.IsHostileDistanceGood && TigerPalm.IsSpellUsable && !ObjectManager.Me.HaveBuff(121125)
                && (ObjectManager.Me.HaveBuff(115307) || !StanceoftheSturdyOx.KnownSpell))
            {
                TigerPalm.Cast();
            }
        }
        finally
        {
            Memory.WowMemory.GameFrameUnLock();
        }
    }

    private void Patrolling()
    {
        if (ObjectManager.Me.IsMounted) return;
        Buff();
        Heal();
    }

    #region Nested type: MonkBrewmasterSettings

    [Serializable]
    public class MonkBrewmasterSettings : Settings
    {
        public bool DoAvoidMelee = true;
        public bool UseAlchFlask = true;
        public bool UseArcaneTorrentForDecast = true;
        public int UseArcaneTorrentForDecastAtPercentage = 100;
        public bool UseArcaneTorrentForResource = true;
        public bool UseBerserking = true;
        public bool UseBlackoutKick = true;
        public bool UseBloodFury = true;
        public bool UseBreathofFire = true;
        public bool UseChargingOxWave = true;
        public int UseChargingOxWaveAtPercentage = 90;
        public bool UseChiBrew = true;
        public bool UseChiBurst = true;
        public int UseChiBurstAtPercentage = 90;
        public bool UseChiWave = true;
        public int UseChiWaveAtPercentage = 85;
        public bool UseClash = true;
        public bool UseCracklingJadeLightning = true;
        public bool UseDampenHarm = true;
        public int UseDampenHarmAtPercentage = 90;
        public bool UseDiffuseMagic = true;
        public int UseDiffuseMagicAtPercentage = 90;
        public bool UseDisable = false;
        public bool UseDizzyingHaze = true;
        public bool UseElusiveBrew = true;
        public int UseElusiveBrewAtPercentage = 70;

        public bool UseExpelHarm = true;
        public int UseExpelHarmAtPercentage = 90;
        public bool UseFortifyingBrew = true;
        public int UseFortifyingBrewAtPercentage = 80;
        public bool UseGiftoftheNaaru = true;
        public int UseGiftoftheNaaruAtPercentage = 80;
        public bool UseGrappleWeapon = true;
        public int UseGrappleWeaponAtPercentage = 95;
        public bool UseGuard = true;
        public int UseGuardAtPercentage = 95;
        public bool UseHealingSphere = true;
        public int UseHealingSphereAtPercentage = 70;
        public bool UseInvokeXuentheWhiteTiger = true;
        public bool UseJab = true;
        public bool UseKegSmash = true;
        public bool UseLegSweep = true;
        public int UseLegSweepAtPercentage = 90;
        public bool UseLegacyoftheEmperor = true;

        public bool UseProvoke = true;
        public bool UsePurifyingBrew = true;
        public int UsePurifyingBrewAtPercentage = 90;
        public bool UseRoll = true;
        public bool UseRushingJadeWind = true;
        public bool UseSpearHandStrike = true;
        public int UseSpearHandStrikeAtPercentage = 100;
        public bool UseSpinningCraneKick = true;
        public bool UseStanceoftheFierceTiger = true;
        public bool UseStanceoftheSturdyOx = true;
        public bool UseStoneform = true;
        public int UseStoneformAtPercentage = 80;
        public bool UseSummonBlackOxStatue = true;
        public bool UseTigerPalm = true;
        public bool UseTigersLust = true;
        public bool UseTouchofDeath = true;
        public bool UseTrinketOne = true;
        public bool UseTrinketTwo = true;
        public bool UseWarStomp = true;
        public int UseWarStompAtPercentage = 80;
        public bool UseZenMeditation = true;
        public bool UseZenSphere = true;
        public int UseZenSphereAtPercentage = 90;

        public MonkBrewmasterSettings()
        {
            ConfigWinForm("Brewmaster Monk Settings");
            /* Professions & Racials */
            AddControlInWinForm("Use Arcane Torrent For Decast", "UseArcaneTorrentForDecast", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Arcane Torrent For Resource", "UseArcaneTorrentForResource", "Professions & Racials");
            AddControlInWinForm("Use Berserking", "UseBerserking", "Professions & Racials");
            AddControlInWinForm("Use Blood Fury", "UseBloodFury", "Professions & Racials");
            AddControlInWinForm("Use Gift of the Naaru", "UseGiftoftheNaaru", "Professions & Racials", "AtPercentage");

            AddControlInWinForm("Use Stoneform", "UseStoneform", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use War Stomp", "UseWarStomp", "Professions & Racials", "AtPercentage");
            /* Monk Buffs */
            AddControlInWinForm("Use Disable", "UseDisable", "Monk Buffs");
            AddControlInWinForm("Use Legacy of the Emperor", "UseLegacyoftheEmperor", "Monk Buffs");
            AddControlInWinForm("Use Stance of the Fierce Tiger", "UseStanceoftheFierceTiger", "Monk Buffs");
            AddControlInWinForm("Use Tiger's Lust", "UseTigersLust", "Monk Buffs");
            /* Offensive Spell */
            AddControlInWinForm("Use Chi Wave", "UseChiWave", "Offensive Spell", "AtPercentage");
            AddControlInWinForm("Use Blackout Kick", "UseBlackoutKick", "Offensive Spell");
            AddControlInWinForm("Use Breath of Fire", "UseBreathofFire", "Offensive Spell");
            AddControlInWinForm("Use Clash", "UseClash", "Offensive Spell");
            AddControlInWinForm("Use Crackling Jade Lightning", "UseCracklingJadeLightning", "Offensive Spell");
            AddControlInWinForm("Use Dizzying Haze", "UseDizzyingHaze", "Offensive Spell");
            AddControlInWinForm("Use Jab", "UseJab", "Offensive Spell");
            AddControlInWinForm("Use Keg Smash", "UseKegSmash", "Offensive Spell");
            AddControlInWinForm("Use Provoke", "UseProvoke", "Offensive Spell");
            AddControlInWinForm("Use Roll", "UseRoll", "Offensive Spell");
            AddControlInWinForm("Use Spinning Crane Kick", "UseSpinningCraneKick", "Offensive Spell");
            AddControlInWinForm("Use Tiger Palm", "UseTigerPalm", "Offensive Spell");
            AddControlInWinForm("Use Touch of Death", "UseTouchofDeath", "Offensive Spell");
            /* Offensive Cooldown */
            AddControlInWinForm("Use Chi Brew", "UseChiBrew", "Offensive Cooldown");
            AddControlInWinForm("Use Invoke Xuen, the White Tiger", "UseInvokeXuentheWhiteTiger", "Offensive Cooldown");
            AddControlInWinForm("Use Rushing Jade Wind", "UseRushingJadeWind", "Offensive Cooldown");
            /* Defensive Cooldown */
            AddControlInWinForm("Use Charging Ox Wave", "UseChargingOxWave", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Dampen Harm ", "UseDampenHarm ", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Diffuse Magic", "UseDiffuseMagic", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Elusive Brew", "UseElusiveBrew", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Fortifying Brew", "UseFortifyingBrew", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Grapple Weapon", "UseGrappleWeapon", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Guard", "UseGuard", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Leg Sweep", "UseLegSweep", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Purifying Brew", "UsePurifyingBrew", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Spear Hand Strike", "UseSpearHandStrike", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Summon Black Ox Statue", "UseSummonBlackOxStatue", "Defensive Cooldown");
            AddControlInWinForm("Use Zen Meditation", "UseZenMeditation", "Defensive Cooldown");
            /* Healing Spell */
            AddControlInWinForm("Use Chi Burst", "UseChiBurst", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Expel Harm", "UseExpelHarm", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Healing Sphere", "UseHealingSphere", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Zen Sphere", "UseZenSphere", "Healing Spell", "AtPercentage");
            /* Game Settings */
            AddControlInWinForm("Use Trinket One", "UseTrinketOne", "Game Settings");
            AddControlInWinForm("Use Trinket Two", "UseTrinketTwo", "Game Settings");

            AddControlInWinForm("Use Alchemist Flask", "UseAlchFlask", "Game Settings");
            AddControlInWinForm("Do avoid melee (Off Advised!!)", "DoAvoidMelee", "Game Settings");
            AddControlInWinForm("Avoid melee distance (1 to 4)", "DoAvoidMeleeDistance", "Game Settings");
        }

        public static MonkBrewmasterSettings CurrentSetting { get; set; }

        public static MonkBrewmasterSettings GetSettings()
        {
            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Monk_Brewmaster.xml";
            if (File.Exists(currentSettingsFile))
            {
                return
                    CurrentSetting = Load<MonkBrewmasterSettings>(currentSettingsFile);
            }
            return new MonkBrewmasterSettings();
        }
    }

    #endregion
}

public class MonkWindwalker
{
    private static MonkWindwalkerSettings MySettings = MonkWindwalkerSettings.GetSettings();

    #region General Timers & Variables

    private readonly WoWItem _firstTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET);
    private readonly WoWItem _secondTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET, 2);

    private Timer _grappleWeaponTimer = new Timer(0);
    private Timer _healingSphereTimer = new Timer(0);
    private Timer _onCd = new Timer(0);
    private Timer _risingSunKickTimer = new Timer(0);
    private Timer _tigerPowerTimer = new Timer(0);
    private Timer _rollTimer = new Timer(0);

    #endregion

    #region Professions & Racials

    public readonly Spell Alchemy = new Spell("Alchemy");
    public readonly Spell ArcaneTorrent = new Spell("Arcane Torrent");
    public readonly Spell Berserking = new Spell("Berserking");
    public readonly Spell BloodFury = new Spell("Blood Fury");

    public readonly Spell GiftoftheNaaru = new Spell("Gift of the Naaru");

    public readonly Spell Stoneform = new Spell("Stoneform");
    public readonly Spell WarStomp = new Spell("War Stomp");

    #endregion

    #region Monk Buffs

    public readonly Spell Disable = new Spell("Disable");
    public readonly Spell LegacyoftheEmperor = new Spell("Legacy of the Emperor");
    public readonly Spell LegacyoftheWhiteTiger = new Spell("Legacy of the White Tiger");
    public readonly Spell StanceoftheFierceTiger = new Spell("Stance of the Fierce Tiger");
    public readonly Spell TigereyeBrew = new Spell("Tigereye Brew");
    public readonly Spell TigersLust = new Spell("Tiger's Lust");

    #endregion

    #region Offensive Spell

    public readonly Spell BlackoutKick = new Spell("Blackout Kick");
    public readonly Spell CracklingJadeLightning = new Spell("Crackling Jade Lightning");
    public readonly Spell FistsofFury = new Spell("Fists of Fury");
    public readonly Spell Jab = new Spell("Jab");
    public readonly Spell Provoke = new Spell("Provoke");
    public readonly Spell RisingSunKick = new Spell("Rising Sun Kick");
    public readonly Spell Roll = new Spell("Roll");
    public readonly Spell SpinningCraneKick = new Spell("Spinning Crane Kick");
    public readonly Spell TigerPalm = new Spell("Tiger Palm");
    public readonly Spell TouchofDeath = new Spell("Touch of Death");

    #endregion

    #region Offensive Cooldown

    public readonly Spell ChiBrew = new Spell("Chi Brew");
    public readonly Spell EnergizingBrew = new Spell("Energizing Brew");
    public readonly Spell InvokeXuentheWhiteTiger = new Spell("Invoke Xuen, the White Tiger");
    public readonly Spell RushingJadeWind = new Spell("Rushing Jade Wind");

    #endregion

    #region Defensive Cooldown

    public readonly Spell ChargingOxWave = new Spell("Charging Ox Wave");
    public readonly Spell DampenHarm = new Spell("Dampen Harm");
    public readonly Spell DiffuseMagic = new Spell("Diffuse Magic");
    public readonly Spell FortifyingBrew = new Spell("Fortifying Brew");
    public readonly Spell GrappleWeapon = new Spell("Grapple Weapon");
    public readonly Spell LegSweep = new Spell("Leg Sweep");
    public readonly Spell SpearHandStrike = new Spell("Spear Hand Strike");
    public readonly Spell TouchofKarma = new Spell("Touch of Karma");
    public readonly Spell ZenMeditation = new Spell("Zen Meditation");

    #endregion

    #region Healing Spell

    public readonly Spell ChiBurst = new Spell("Chi Burst");
    public readonly Spell ChiWave = new Spell("Chi Wave");
    public readonly Spell ExpelHarm = new Spell("Expel Harm");
    public readonly Spell HealingSphere = new Spell("Healing Sphere");
    public readonly Spell ZenSphere = new Spell("Zen Sphere");

    #endregion

    public MonkWindwalker()
    {
        Main.InternalRange = ObjectManager.Me.GetCombatReach;
        MySettings = MonkWindwalkerSettings.GetSettings();
        Main.DumpCurrentSettings<MonkWindwalkerSettings>(MySettings);
        UInt128 lastTarget = 0;

        while (Main.InternalLoop)
        {
            try
            {
                if (!ObjectManager.Me.IsDead)
                {
                    if (!ObjectManager.Me.IsMounted)
                    {
                        if (Fight.InFight && ObjectManager.Me.Target > 0)
                        {
                            if (ObjectManager.Me.Target != lastTarget &&
                                Provoke.IsHostileDistanceGood)
                            {
                                Pull();
                                lastTarget = ObjectManager.Me.Target;
                            }

                            if (ObjectManager.Target.GetDistance < 30)
                                Combat();
                        }
                        if (!ObjectManager.Me.IsCast)
                            Patrolling();
                    }
                }
                else
                    Thread.Sleep(500);
            }
            catch
            {
            }
            Thread.Sleep(100);
        }
    }

    private void Pull()
    {
        if (MySettings.UseProvoke && Provoke.KnownSpell && !ObjectManager.Target.InCombat && Provoke.IsHostileDistanceGood && Provoke.IsSpellUsable)
        {
            Provoke.Cast();
        }
    }

    private void Combat()
    {
        Buff();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        DPSCycle();
        if (_onCd.IsReady &&
            (ObjectManager.Me.HealthPercent <= MySettings.UseGrappleWeaponAtPercentage || ObjectManager.Me.HealthPercent <= MySettings.UseFortifyingBrewAtPercentage
             || ObjectManager.Me.HealthPercent <= MySettings.UseChargingOxWaveAtPercentage ||
             ObjectManager.Me.HealthPercent <= MySettings.UseTouchofKarmaAtPercentage
             || ObjectManager.Me.HealthPercent <= MySettings.UseDampenHarmAtPercentage || ObjectManager.Me.HealthPercent <= MySettings.UseLegSweepAtPercentage
             || ObjectManager.Me.HealthPercent <= MySettings.UseStoneformAtPercentage || ObjectManager.Me.HealthPercent <= MySettings.UseWarStompAtPercentage))
            DefenseCycle();
        Heal();
        Decast();
        DPSBurst();
        DPSCycle();
    }

    private void Buff()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (MySettings.UseLegacyoftheEmperor && LegacyoftheEmperor.KnownSpell && !LegacyoftheEmperor.HaveBuff && LegacyoftheEmperor.IsSpellUsable)
            LegacyoftheEmperor.Cast();

        if (MySettings.UseLegacyoftheWhiteTiger && LegacyoftheWhiteTiger.KnownSpell && !LegacyoftheWhiteTiger.HaveBuff && LegacyoftheWhiteTiger.IsSpellUsable)
            LegacyoftheWhiteTiger.Cast();

        if (MySettings.UseStanceoftheFierceTiger && StanceoftheFierceTiger.KnownSpell && !StanceoftheFierceTiger.HaveBuff && StanceoftheFierceTiger.IsSpellUsable)
            StanceoftheFierceTiger.Cast();

        if (MySettings.UseTigersLust && TigersLust.KnownSpell && !ObjectManager.Me.InCombat && ObjectManager.Me.GetMove && TigersLust.IsSpellUsable)
            TigersLust.Cast();

        if (MySettings.UseRoll && !ObjectManager.Me.InCombat && Roll.KnownSpell && ObjectManager.Me.GetMove
            && !TigersLust.HaveBuff && _rollTimer.IsReady && Roll.IsSpellUsable && ObjectManager.Target.GetDistance > 14)
        {
            Roll.Cast();
            _rollTimer = new Timer(1000*15);
            return;
        }

        if (MySettings.UseAlchFlask && !ObjectManager.Me.HaveBuff(79638) && !ObjectManager.Me.HaveBuff(79640) && !ObjectManager.Me.HaveBuff(79639)
            && !ItemsManager.IsItemOnCooldown(75525) && ItemsManager.GetItemCount(75525) > 0)
            ItemsManager.UseItem(75525);
    }

    private void AvoidMelee()
    {
        if (ObjectManager.Target.GetDistance < MySettings.DoAvoidMeleeDistance && ObjectManager.Target.InCombat)
        {
            Logging.WriteFight("Too Close. Moving Back");
            var maxTimeTimer = new Timer(1000*2);
            MovementsAction.MoveBackward(true);
            while (ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat && !maxTimeTimer.IsReady)
                Others.SafeSleep(300);
            MovementsAction.MoveBackward(false);
            if (maxTimeTimer.IsReady && ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat)
            {
                MovementsAction.MoveForward(true);
                Others.SafeSleep(1000);
                MovementsAction.MoveForward(false);
                MovementManager.Face(ObjectManager.Target.Position);
            }
        }
    }

    private void DefenseCycle()
    {
        if (MySettings.UseGrappleWeapon && GrappleWeapon.KnownSpell && GrappleWeapon.IsHostileDistanceGood &&
            ObjectManager.Me.HealthPercent <= MySettings.UseGrappleWeaponAtPercentage
            && _grappleWeaponTimer.IsReady && GrappleWeapon.IsSpellUsable)
        {
            GrappleWeapon.Cast();
            _grappleWeaponTimer = new Timer(1000*60);
            return;
        }
        if (MySettings.UseFortifyingBrew && FortifyingBrew.KnownSpell && ObjectManager.Me.HealthPercent <= MySettings.UseFortifyingBrewAtPercentage &&
            FortifyingBrew.IsSpellUsable)
        {
            FortifyingBrew.Cast();
            _onCd = new Timer(1000*20);
            return;
        }
        if (MySettings.UseChargingOxWave && ChargingOxWave.KnownSpell && ChargingOxWave.IsHostileDistanceGood &&
            ObjectManager.Me.HealthPercent <= MySettings.UseChargingOxWaveAtPercentage
            && ChargingOxWave.IsSpellUsable)
        {
            ChargingOxWave.Cast();
            _onCd = new Timer(1000*3);
            return;
        }
        if (MySettings.UseDampenHarm && DampenHarm.KnownSpell && DampenHarm.IsSpellUsable && ObjectManager.Me.HealthPercent <= MySettings.UseDampenHarmAtPercentage)
        {
            DampenHarm.Cast();
            _onCd = new Timer(1000*5);
            return;
        }
        if (MySettings.UseLegSweep && LegSweep.KnownSpell && ObjectManager.Target.GetDistance < 6 &&
            ObjectManager.Me.HealthPercent <= MySettings.UseLegSweepAtPercentage
            && LegSweep.IsSpellUsable)
        {
            LegSweep.Cast();
            _onCd = new Timer(1000*5);
            return;
        }
        if (MySettings.UseTouchofKarma && TouchofKarma.KnownSpell && ObjectManager.Me.HealthPercent <= MySettings.UseTouchofKarmaAtPercentage
            && TouchofKarma.IsHostileDistanceGood && TouchofKarma.IsSpellUsable)
        {
            TouchofKarma.Cast();
            _onCd = new Timer(1000*6);
            return;
        }
        if (MySettings.UseStoneform && Stoneform.KnownSpell && Stoneform.IsSpellUsable && ObjectManager.Me.HealthPercent <= MySettings.UseStoneformAtPercentage)
        {
            Stoneform.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (MySettings.UseWarStomp && WarStomp.KnownSpell && ObjectManager.Target.GetDistance < 8 && WarStomp.IsSpellUsable &&
            ObjectManager.Me.HealthPercent <= MySettings.UseWarStompAtPercentage)
        {
            WarStomp.Cast();
            _onCd = new Timer(1000*2);
        }
    }

    private void Heal()
    {
        if (MySettings.UseGiftoftheNaaru && GiftoftheNaaru.KnownSpell && GiftoftheNaaru.IsSpellUsable
            && ObjectManager.Me.HealthPercent <= MySettings.UseGiftoftheNaaruAtPercentage)
        {
            GiftoftheNaaru.Cast();
            return;
        }
        if (MySettings.UseHealingSphere && HealingSphere.KnownSpell && HealingSphere.IsSpellUsable && _healingSphereTimer.IsReady &&
            ObjectManager.Me.HealthPercent <= MySettings.UseHealingSphereAtPercentage)
        {
            SpellManager.CastSpellByIDAndPosition(115460, ObjectManager.Me.Position);
            _healingSphereTimer = new Timer(1000*8);
            return;
        }
        if (MySettings.UseChiWave && ChiWave.KnownSpell && ObjectManager.Me.HealthPercent <= MySettings.UseChiWaveAtPercentage && ChiWave.IsSpellUsable)
        {
            ChiWave.Cast();
            return;
        }
        if (MySettings.UseChiBurst && ChiBurst.KnownSpell && ObjectManager.Me.HealthPercent <= MySettings.UseChiBurstAtPercentage && ChiBurst.IsSpellUsable)
        {
            ChiBurst.Cast();
            return;
        }
        if (MySettings.UseExpelHarm && ExpelHarm.KnownSpell && ObjectManager.Me.HealthPercent <= MySettings.UseExpelHarmAtPercentage && ExpelHarm.IsSpellUsable)
        {
            ExpelHarm.Cast();
            return;
        }
        if (MySettings.UseZenSphere && ZenSphere.KnownSpell && ObjectManager.Me.HealthPercent <= MySettings.UseZenSphereAtPercentage
            && !ZenSphere.HaveBuff && ZenSphere.IsSpellUsable)
        {
            ZenSphere.Cast();
        }
    }

    private void Decast()
    {
        if (MySettings.UseArcaneTorrentForDecast && ArcaneTorrent.KnownSpell && ObjectManager.Me.HealthPercent <= MySettings.UseArcaneTorrentForDecastAtPercentage
            && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe && ObjectManager.Target.GetDistance < 8 && ArcaneTorrent.IsSpellUsable)
        {
            ArcaneTorrent.Cast();
            return;
        }
        if (MySettings.UseDiffuseMagic && DiffuseMagic.KnownSpell && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe && DiffuseMagic.IsSpellUsable
            && ObjectManager.Me.HealthPercent <= MySettings.UseDiffuseMagicAtPercentage)
        {
            DiffuseMagic.Cast();
            return;
        }
        if (MySettings.UseSpearHandStrike && SpearHandStrike.KnownSpell && ObjectManager.Target.IsCast && SpearHandStrike.IsHostileDistanceGood && SpearHandStrike.IsSpellUsable
            && ObjectManager.Me.HealthPercent <= MySettings.UseSpearHandStrikeAtPercentage)
        {
            SpearHandStrike.Cast();
            return;
        }
        if (MySettings.UseDisable && Disable.KnownSpell && ObjectManager.Target.GetMove && !Disable.TargetHaveBuff && Disable.IsHostileDistanceGood && Disable.IsSpellUsable)
        {
            Disable.Cast();
        }
    }

    private void DPSBurst()
    {
        if (MySettings.UseTrinketOne && !ItemsManager.IsItemOnCooldown(_firstTrinket.Entry) && ItemsManager.IsItemUsable(_firstTrinket.Entry))
        {
            ItemsManager.UseItem(_firstTrinket.Name);
            Logging.WriteFight("Use First Trinket Slot");
        }
        if (MySettings.UseTrinketTwo && !ItemsManager.IsItemOnCooldown(_secondTrinket.Entry) && ItemsManager.IsItemUsable(_secondTrinket.Entry))
        {
            ItemsManager.UseItem(_secondTrinket.Name);
            Logging.WriteFight("Use Second Trinket Slot");
            return;
        }
        if (MySettings.UseBerserking && Berserking.KnownSpell && ObjectManager.Target.GetDistance < 30 && Berserking.IsSpellUsable)
        {
            Berserking.Cast();
            return;
        }
        if (MySettings.UseBloodFury && BloodFury.KnownSpell && ObjectManager.Target.GetDistance < 30 && BloodFury.IsSpellUsable)
        {
            BloodFury.Cast();
            return;
        }
        if (MySettings.UseChiBrew && ChiBrew.KnownSpell && ObjectManager.Me.Chi == 0 && ChiBrew.IsSpellUsable)
        {
            ChiBrew.Cast();
        }
        if (MySettings.UseTouchofDeath && TouchofDeath.KnownSpell && TouchofDeath.IsHostileDistanceGood && TouchofDeath.IsSpellUsable)
        {
            TouchofDeath.Cast();
        }
        if (MySettings.UseInvokeXuentheWhiteTiger && InvokeXuentheWhiteTiger.KnownSpell && InvokeXuentheWhiteTiger.IsHostileDistanceGood &&
            InvokeXuentheWhiteTiger.IsSpellUsable)
        {
            InvokeXuentheWhiteTiger.Cast();
        }
        if (MySettings.UseEnergizingBrew && EnergizingBrew.KnownSpell && ObjectManager.Me.Energy <= 40f && ObjectManager.Target.GetDistance < 30 && EnergizingBrew.IsSpellUsable)
        {
            EnergizingBrew.Cast();
        }
        if (MySettings.UseTigereyeBrew && TigereyeBrew.KnownSpell && ObjectManager.Me.BuffStack(125195) > 9 && ObjectManager.Target.GetDistance < 30 &&
            TigereyeBrew.IsSpellUsable)
        {
            TigereyeBrew.Cast();
        }
        if (MySettings.UseChiWave && ChiWave.KnownSpell && ChiWave.IsHostileDistanceGood && ChiWave.IsSpellUsable)
        {
            ChiWave.Cast();
        }
        if (MySettings.UseRushingJadeWind && RushingJadeWind.KnownSpell && RushingJadeWind.IsHostileDistanceGood && RushingJadeWind.IsSpellUsable
            && ObjectManager.GetNumberAttackPlayer() > 3)
        {
            RushingJadeWind.Cast();
        }
    }

    private void DPSCycle()
    {
        Usefuls.SleepGlobalCooldown();
        try
        {
            Memory.WowMemory.GameFrameLock(); // !!! WARNING - DONT SLEEP WHILE LOCKED - DO FINALLY(GameFrameUnLock()) !!!

            if (ObjectManager.GetNumberAttackPlayer() > 3)
            {
                if (MySettings.UseTigerPalm && TigerPalm.KnownSpell && !ObjectManager.Me.HaveBuff(125359) && TigerPalm.IsHostileDistanceGood && TigerPalm.IsSpellUsable
                    && ObjectManager.Me.Chi > 0 && (_tigerPowerTimer.IsReady || !ObjectManager.Me.HaveBuff(125359)))
                {
                    TigerPalm.Cast();
                    _tigerPowerTimer = new Timer(1000*16);
                    return;
                }
                if (MySettings.UseRisingSunKick && RisingSunKick.KnownSpell && !ObjectManager.Target.HaveBuff(130320) && RisingSunKick.IsHostileDistanceGood && RisingSunKick.IsSpellUsable
                    && ObjectManager.Me.Chi > 1 && (_risingSunKickTimer.IsReady || !ObjectManager.Target.HaveBuff(130320)))
                {
                    RisingSunKick.Cast();
                    _risingSunKickTimer = new Timer(1000*6);
                    return;
                }
                if (MySettings.UseSpinningCraneKick && SpinningCraneKick.KnownSpell && SpinningCraneKick.IsHostileDistanceGood && !ObjectManager.Me.IsCast &&
                    SpinningCraneKick.IsSpellUsable)
                {
                    SpinningCraneKick.Cast();
                    return;
                }
            }

            if (MySettings.UseExpelHarm && ExpelHarm.KnownSpell && ObjectManager.Me.HealthPercent <= MySettings.UseExpelHarmAtPercentage && ExpelHarm.IsHostileDistanceGood &&
                ExpelHarm.IsSpellUsable
                && ObjectManager.Me.Chi < 4)
            {
                ExpelHarm.Cast();
                return;
            }
            if (MySettings.UseJab && Jab.KnownSpell && !ObjectManager.Me.HaveBuff(116768) && Jab.IsHostileDistanceGood && Jab.IsSpellUsable
                && ObjectManager.Me.Chi < 4 && !ObjectManager.Me.HaveBuff(118864))
            {
                Jab.Cast();
                return;
            }
            if (MySettings.UseTigerPalm && TigerPalm.KnownSpell && TigerPalm.IsHostileDistanceGood && TigerPalm.IsSpellUsable &&
                (!ObjectManager.Me.HaveBuff(121125) || !MySettings.UseTouchofDeath) && ObjectManager.Me.Chi > 0
                && (_tigerPowerTimer.IsReady || !ObjectManager.Me.HaveBuff(125359) || ObjectManager.Me.HaveBuff(118864)))
            {
                TigerPalm.Cast();
                _tigerPowerTimer = new Timer(1000*16);
                return;
            }
            if (MySettings.UseRisingSunKick && RisingSunKick.KnownSpell && RisingSunKick.IsHostileDistanceGood && RisingSunKick.IsSpellUsable
                && (!ObjectManager.Me.HaveBuff(121125) || !MySettings.UseTouchofDeath) && ObjectManager.Me.Chi > 1
                && (_risingSunKickTimer.IsReady || !ObjectManager.Target.HaveBuff(130320)))
            {
                RisingSunKick.Cast();
                _risingSunKickTimer = new Timer(1000*6);
                return;
            }
            if (MySettings.UseFistsofFury && FistsofFury.KnownSpell && FistsofFury.IsHostileDistanceGood && FistsofFury.IsSpellUsable &&
                (!ObjectManager.Me.HaveBuff(121125) || !MySettings.UseTouchofDeath) && ObjectManager.Me.Chi > 2
                && !_tigerPowerTimer.IsReady && !_risingSunKickTimer.IsReady && ObjectManager.Me.EnergyPercentage < 81)
            {
                FistsofFury.Cast();
                return;
            }
            if (MySettings.UseBlackoutKick && BlackoutKick.KnownSpell && BlackoutKick.IsHostileDistanceGood && BlackoutKick.IsSpellUsable
                && (!ObjectManager.Me.HaveBuff(121125) || !MySettings.UseTouchofDeath) && ObjectManager.Me.Chi > 1)
            {
                BlackoutKick.Cast();
                return;
            }
            if (MySettings.UseArcaneTorrentForResource && ArcaneTorrent.KnownSpell && ArcaneTorrent.IsSpellUsable && ObjectManager.Me.EnergyPercentage < 90)
            {
                ArcaneTorrent.Cast();
            }
        }
        finally
        {
            Memory.WowMemory.GameFrameUnLock();
        }
    }

    private void Patrolling()
    {
        if (ObjectManager.Me.IsMounted) return;
        Buff();
        Heal();
    }

    #region Nested type: MonkWindwalkerSettings

    [Serializable]
    public class MonkWindwalkerSettings : Settings
    {
        public bool DoAvoidMelee = false;
        public int DoAvoidMeleeDistance = 0;
        public bool UseAlchFlask = true;
        public bool UseArcaneTorrentForDecast = true;
        public int UseArcaneTorrentForDecastAtPercentage = 100;
        public bool UseArcaneTorrentForResource = true;
        public bool UseBerserking = true;
        public bool UseBlackoutKick = true;
        public bool UseBloodFury = true;
        public bool UseChargingOxWave = true;
        public int UseChargingOxWaveAtPercentage = 90;
        public bool UseChiBrew = true;
        public bool UseChiBurst = true;
        public int UseChiBurstAtPercentage = 90;
        public bool UseChiWave = true;
        public int UseChiWaveAtPercentage = 85;
        public bool UseDampenHarm = true;
        public int UseDampenHarmAtPercentage = 90;
        public bool UseDiffuseMagic = true;
        public int UseDiffuseMagicAtPercentage = 90;
        public bool UseDisable = false;
        public bool UseEnergizingBrew = true;

        public bool UseExpelHarm = true;
        public int UseExpelHarmAtPercentage = 90;
        public bool UseFistsofFury = true;
        public bool UseFortifyingBrew = true;
        public int UseFortifyingBrewAtPercentage = 80;
        public bool UseGiftoftheNaaru = true;
        public int UseGiftoftheNaaruAtPercentage = 80;
        public bool UseGrappleWeapon = true;
        public int UseGrappleWeaponAtPercentage = 95;
        public bool UseHealingSphere = true;
        public int UseHealingSphereAtPercentage = 70;
        public bool UseInvokeXuentheWhiteTiger = true;
        public bool UseJab = true;
        public bool UseLegSweep = true;
        public int UseLegSweepAtPercentage = 90;
        public bool UseLegacyoftheEmperor = true;
        public bool UseLegacyoftheWhiteTiger = true;

        public bool UseProvoke = true;
        public bool UseRisingSunKick = true;
        public bool UseRoll = true;
        public bool UseRushingJadeWind = true;
        public bool UseSpearHandStrike = true;
        public int UseSpearHandStrikeAtPercentage = 100;
        public bool UseSpinningCraneKick = true;
        public bool UseStanceoftheFierceTiger = true;
        public bool UseStoneform = true;
        public int UseStoneformAtPercentage = 80;
        public bool UseTigerPalm = true;
        public bool UseTigereyeBrew = true;
        public bool UseTigersLust = true;
        public bool UseTouchofDeath = true;
        public bool UseTouchofKarma = true;
        public int UseTouchofKarmaAtPercentage = 95;
        public bool UseTrinketOne = true;
        public bool UseTrinketTwo = true;
        public bool UseWarStomp = true;
        public int UseWarStompAtPercentage = 80;
        public bool UseZenMeditation = true;
        public bool UseZenSphere = true;
        public int UseZenSphereAtPercentage = 90;

        public MonkWindwalkerSettings()
        {
            ConfigWinForm("Windwalker Monk Settings");
            /* Professions & Racials */
            AddControlInWinForm("Use Arcane Torrent For Decast", "UseArcaneTorrentForDecast", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Arcane Torrent For Resource", "UseArcaneTorrentForResource", "Professions & Racials");
            AddControlInWinForm("Use Berserking", "UseBerserking", "Professions & Racials");
            AddControlInWinForm("Use Blood Fury", "UseBloodFury", "Professions & Racials");
            AddControlInWinForm("Use Gift of the Naaru", "UseGiftoftheNaaru", "Professions & Racials", "AtPercentage");

            AddControlInWinForm("Use Stoneform", "UseStoneform", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use War Stomp", "UseWarStomp", "Professions & Racials", "AtPercentage");
            /* Monk Buffs */
            AddControlInWinForm("Use Disable", "UseDisable", "Monk Buffs");
            AddControlInWinForm("Use Legacy of the Emperor", "UseLegacyoftheEmperor", "Monk Buffs");
            AddControlInWinForm("Use Legacy of the White Tiger", "UseLegacyoftheWhiteTiger", "Monk Buffs");
            AddControlInWinForm("Use Stance of the Fierce Tiger", "UseStanceoftheFierceTiger", "Monk Buffs");
            AddControlInWinForm("Use Tigereye Brew", "UseTigereBrew", "Monk Buffs");
            AddControlInWinForm("Use Tiger's Lust", "UseTigersLust", "Monk Buffs");
            /* Offensive Spell */
            AddControlInWinForm("Use Blackout Kick", "UseBlackoutKick", "Offensive Spell");
            AddControlInWinForm("Use Fists of Fury", "UseFistsofFury", "Offensive Spell");
            AddControlInWinForm("Use Jab", "UseJab", "Offensive Spell");
            AddControlInWinForm("Use Path of Blossoms", "UsePathofBlossoms", "Offensive Spell");
            AddControlInWinForm("Use Provoke", "UseProvoke", "Offensive Spell");
            AddControlInWinForm("Use Rising Sun Kick", "UseRisingSunKick", "Offensive Spell");
            AddControlInWinForm("Use Roll", "UseRoll", "Offensive Spell");
            AddControlInWinForm("Use Spinning Crane Kick", "UseSpinningCraneKick", "Offensive Spell");
            AddControlInWinForm("Use Tiger Palm", "UseTigerPalm", "Offensive Spell");
            AddControlInWinForm("Use Touch of Death", "UseTouchofDeath", "Offensive Spell");
            /* Offensive Cooldown */
            AddControlInWinForm("Use Chi Brew", "UseChiBrew", "Offensive Cooldown");
            AddControlInWinForm("Use Energizing Brew", "UseEnergizingBrew", "Offensive Cooldown");
            AddControlInWinForm("Use Invoke Xuen, the White Tiger", "UseInvokeXuentheWhiteTiger", "Offensive Cooldown");
            AddControlInWinForm("Use Rushing Jade Wind", "UseRushingJadeWind", "Offensive Cooldown");
            /* Defensive Cooldown */
            AddControlInWinForm("Use Charging Ox Wave", "UseChargingOxWave", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Dampen Harm ", "UseDampenHarm ", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Diffuse Magic", "UseDiffuseMagic", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Fortifying Brew", "UseFortifyingBrew", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Grapple Weapon", "UseGrappleWeapon", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Leg Sweep", "UseLegSweep", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Spear Hand Strike", "UseSpearHandStrike", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Touch of Karma", "UseTouchofKarma", "Defensive Cooldown", "AtPercentage");
            AddControlInWinForm("Use Zen Meditation", "UseZenMeditation", "Defensive Cooldown");
            /* Healing Spell */
            AddControlInWinForm("Use Chi Burst", "UseChiBurst", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Chi Wave", "UseChiWave", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Expel Harm", "UseExpelHarm", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Healing Sphere", "UseHealingSphere", "Healing Spell", "AtPercentage");
            AddControlInWinForm("Use Zen Sphere", "UseZenSphere", "Healing Spell", "AtPercentage");
            /* Game Settings */
            AddControlInWinForm("Use Trinket One", "UseTrinketOne", "Game Settings");
            AddControlInWinForm("Use Trinket Two", "UseTrinketTwo", "Game Settings");

            AddControlInWinForm("Use Alchemist Flask", "UseAlchFlask", "Game Settings");
            AddControlInWinForm("Do avoid melee (Off Advised!!)", "DoAvoidMelee", "Game Settings");
            AddControlInWinForm("Avoid melee distance (1 to 4)", "DoAvoidMeleeDistance", "Game Settings");
        }

        public static MonkWindwalkerSettings CurrentSetting { get; set; }

        public static MonkWindwalkerSettings GetSettings()
        {
            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Monk_Windwalker.xml";
            if (File.Exists(currentSettingsFile))
            {
                return
                    CurrentSetting = Load<MonkWindwalkerSettings>(currentSettingsFile);
            }
            return new MonkWindwalkerSettings();
        }
    }

    #endregion
}

public class MonkMistweaver
{
    private static MonkMistweaverSettings MySettings = MonkMistweaverSettings.GetSettings();

    #region General Timers & Variables

    private readonly WoWItem _firstTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET);
    private readonly WoWItem _secondTrinket = EquippedItems.GetEquippedItem(WoWInventorySlot.INVTYPE_TRINKET, 2);

    private Timer _grappleWeaponTimer = new Timer(0);
    private Timer _healingSphereTimer = new Timer(0);
    private Timer _onCd = new Timer(0);
    private Timer _serpentsZealTimer = new Timer(0);

    #endregion

    #region Professions & Racials

    public readonly Spell Alchemy = new Spell("Alchemy");
    public readonly Spell ArcaneTorrent = new Spell("Arcane Torrent");
    public readonly Spell Berserking = new Spell("Berserking");
    public readonly Spell BloodFury = new Spell("Blood Fury");

    public readonly Spell GiftoftheNaaru = new Spell("Gift of the Naaru");

    public readonly Spell Stoneform = new Spell("Stoneform");
    public readonly Spell WarStomp = new Spell("War Stomp");

    #endregion

    #region Monk Buffs

    public readonly Spell Disable = new Spell("Disable");
    public readonly Spell LegacyoftheEmperor = new Spell("Legacy of the Emperor");
    public readonly Spell StanceoftheFierceTiger = new Spell("Stance of the Fierce Tiger");
    public readonly Spell StanceoftheWiseSerpent = new Spell("Stance of the Wise Serpent");
    public readonly Spell SummonJadeSerpentStatue = new Spell("Summon Jade Serpent Statue");
    public readonly Spell TigersLust = new Spell("Tiger's Lust");

    #endregion

    #region Offensive Spell

    public readonly Spell BlackoutKick = new Spell("Blackout Kick");
    public readonly Spell CracklingJadeLightning = new Spell("Crackling Jade Lightning");
    public readonly Spell Jab = new Spell("Jab");
    public readonly Spell PathofBlossoms = new Spell("Path of Blossoms");
    public readonly Spell Provoke = new Spell("Provoke");
    public readonly Spell Roll = new Spell("Roll");
    public readonly Spell SpinningCraneKick = new Spell("Spinning Crane Kick");
    public readonly Spell TigerPalm = new Spell("Tiger Palm");
    public readonly Spell TouchofDeath = new Spell("Touch of Death");

    #endregion

    #region Healing Cooldown

    public readonly Spell ChiBrew = new Spell("Chi Brew");
    public readonly Spell InvokeXuentheWhiteTiger = new Spell("Invoke Xuen, the White Tiger");
    public readonly Spell RushingJadeWind = new Spell("Rushing Jade Wind");
    public readonly Spell ThunderFocusTea = new Spell("Thunder Focus Tea");

    #endregion

    #region Defensive Cooldown

    public readonly Spell ChargingOxWave = new Spell("Charging Ox Wave");
    public readonly Spell DampenHarm = new Spell("Dampen Harm");
    public readonly Spell DiffuseMagic = new Spell("Diffuse Magic");
    public readonly Spell FortifyingBrew = new Spell("Fortifying Brew");
    public readonly Spell GrappleWeapon = new Spell("Grapple Weapon");
    public readonly Spell LegSweep = new Spell("Leg Sweep");
    public readonly Spell LifeCocoon = new Spell("Life Cocoon");
    public readonly Spell SpearHandStrike = new Spell("Spear Hand Strike");
    public readonly Spell ZenMeditation = new Spell("Zen Meditation");

    #endregion

    #region Healing Spell

    public readonly Spell ChiBurst = new Spell("Chi Burst");
    public readonly Spell ChiWave = new Spell("Chi Wave");
    public readonly Spell EnvelopingMist = new Spell("Enveloping Mist");
    public readonly Spell ExpelHarm = new Spell("Expel Harm");
    public readonly Spell HealingSphere = new Spell("Healing Sphere");
    public readonly Spell ManaTea = new Spell("Mana Tea");
    public readonly Spell RenewingMist = new Spell("Renewing Mist");
    public readonly Spell Revival = new Spell("Revival");
    public readonly Spell SoothingMist = new Spell("Soothing Mist");
    public readonly Spell SurgingMist = new Spell("Surging Mist");
    public readonly Spell Uplift = new Spell("Uplift");
    public readonly Spell ZenSphere = new Spell("Zen Sphere");

    #endregion

    public MonkMistweaver()
    {
        Main.InternalRange = 30.0f;
        MySettings = MonkMistweaverSettings.GetSettings();
        Main.DumpCurrentSettings<MonkMistweaverSettings>(MySettings);
        UInt128 lastTarget = 0;

        while (Main.InternalLoop)
        {
            try
            {
                if (!ObjectManager.Me.IsDead)
                {
                    if (!ObjectManager.Me.IsMounted)
                    {
                        if (Fight.InFight && ObjectManager.Me.Target > 0)
                        {
                            if (ObjectManager.Me.Target != lastTarget &&
                                Provoke.IsHostileDistanceGood)
                            {
                                Pull();
                                lastTarget = ObjectManager.Me.Target;
                            }

                            if (ObjectManager.Target.GetDistance <= 40f)
                                Combat();
                        }
                        if (!ObjectManager.Me.IsCast)
                            Patrolling();
                    }
                }
                else
                    Thread.Sleep(500);
            }
            catch
            {
            }
            Thread.Sleep(100);
        }
    }

    private void Pull()
    {
        if (!ObjectManager.Target.InCombat && Provoke.IsSpellUsable && Provoke.IsHostileDistanceGood
            && MySettings.UseProvoke && Provoke.KnownSpell)
        {
            Provoke.Cast();
        }
    }

    private void Combat()
    {
        Buff();
        if (MySettings.DoAvoidMelee)
            AvoidMelee();
        if (_onCd.IsReady)
            DefenseCycle();
        DPSCycle();
        Heal();
        Decast();
        DPSCycle();
        HealingBurst();
        DPSCycle();
    }

    private void Buff()
    {
        if (ObjectManager.Me.IsMounted)
            return;

        if (LegacyoftheEmperor.KnownSpell && LegacyoftheEmperor.IsSpellUsable &&
            !LegacyoftheEmperor.HaveBuff && MySettings.UseLegacyoftheEmperor)
        {
            LegacyoftheEmperor.Cast();
            return;
        }
        if (StanceoftheWiseSerpent.KnownSpell && StanceoftheWiseSerpent.IsSpellUsable && !StanceoftheWiseSerpent.HaveBuff
            && MySettings.UseStanceoftheWiseSerpent)
        {
            StanceoftheWiseSerpent.Cast();
            return;
        }
        if (!ObjectManager.Me.InCombat && TigersLust.IsSpellUsable && TigersLust.KnownSpell
            && MySettings.UseTigersLust && ObjectManager.Me.GetMove)
        {
            TigersLust.Cast();
            return;
        }
        if (!ObjectManager.Me.InCombat && Roll.IsSpellUsable && Roll.KnownSpell
            && MySettings.UseRoll && ObjectManager.Me.GetMove && !TigersLust.HaveBuff
            && ObjectManager.Target.GetDistance > 14)
        {
            Roll.Cast();
            return;
        }
        if (ObjectManager.Me.InCombat && SummonJadeSerpentStatue.IsSpellUsable && SummonJadeSerpentStatue.KnownSpell
            && MySettings.UseSummonJadeSerpentStatue && !SummonJadeSerpentStatue.HaveBuff && ObjectManager.Target.GetDistance <= 40f)
        {
            SummonJadeSerpentStatue.Cast();
            return;
        }
        if (MySettings.UseAlchFlask && !ObjectManager.Me.HaveBuff(79638) && !ObjectManager.Me.HaveBuff(79640) && !ObjectManager.Me.HaveBuff(79639)
            && !ItemsManager.IsItemOnCooldown(75525) && ItemsManager.GetItemCount(75525) > 0)
        {
            ItemsManager.UseItem(75525);
        }
    }

    private void AvoidMelee()
    {
        if (ObjectManager.Target.GetDistance < MySettings.DoAvoidMeleeDistance && ObjectManager.Target.InCombat)
        {
            Logging.WriteFight("Too Close. Moving Back");
            var maxTimeTimer = new Timer(1000*2);
            MovementsAction.MoveBackward(true);
            while (ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat && !maxTimeTimer.IsReady)
                Others.SafeSleep(300);
            MovementsAction.MoveBackward(false);
            if (maxTimeTimer.IsReady && ObjectManager.Target.GetDistance < 2 && ObjectManager.Target.InCombat)
            {
                MovementsAction.MoveForward(true);
                Others.SafeSleep(1000);
                MovementsAction.MoveForward(false);
                MovementManager.Face(ObjectManager.Target.Position);
            }
        }
    }

    private void DefenseCycle()
    {
        if (ObjectManager.Me.HealthPercent < 95 && MySettings.UseGrappleWeapon && GrappleWeapon.IsHostileDistanceGood
            && GrappleWeapon.KnownSpell && GrappleWeapon.IsSpellUsable && _grappleWeaponTimer.IsReady)
        {
            GrappleWeapon.Cast();
            _grappleWeaponTimer = new Timer(1000*60);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 80 && FortifyingBrew.IsSpellUsable && FortifyingBrew.KnownSpell
            && MySettings.UseFortifyingBrew)
        {
            FortifyingBrew.Cast();
            _onCd = new Timer(1000*20);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 80 && LifeCocoon.IsSpellUsable && LifeCocoon.KnownSpell
            && MySettings.UseLifeCocoon)
        {
            LifeCocoon.Cast();
            _onCd = new Timer(1000*12);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 90 && ChargingOxWave.IsSpellUsable && ChargingOxWave.KnownSpell
            && MySettings.UseChargingOxWave && ChargingOxWave.IsHostileDistanceGood)
        {
            ChargingOxWave.Cast();
            _onCd = new Timer(1000*3);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 90 && DampenHarm.IsSpellUsable && DampenHarm.KnownSpell
            && MySettings.UseDampenHarm)
        {
            DampenHarm.Cast();
            _onCd = new Timer(1000*5);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 90 && LegSweep.IsSpellUsable && LegSweep.KnownSpell
            && MySettings.UseLegSweep && ObjectManager.Target.GetDistance < 6)
        {
            LegSweep.Cast();
            _onCd = new Timer(1000*5);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 80 && ZenMeditation.IsSpellUsable && ZenMeditation.KnownSpell
            && MySettings.UseZenMeditation)
        {
            ZenMeditation.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 80 && Stoneform.IsSpellUsable && Stoneform.KnownSpell
            && MySettings.UseStoneform)
        {
            Stoneform.Cast();
            _onCd = new Timer(1000*8);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 80 && WarStomp.IsSpellUsable && WarStomp.KnownSpell
            && MySettings.UseWarStomp)
        {
            WarStomp.Cast();
            _onCd = new Timer(1000*2);
        }
    }

    private void Heal()
    {
        if (MySettings.UseArcaneTorrentForResource && ArcaneTorrent.KnownSpell && ArcaneTorrent.IsSpellUsable
            && ObjectManager.Me.ManaPercentage <= MySettings.UseArcaneTorrentForResourceAtPercentage)
        {
            ArcaneTorrent.Cast();
            return;
        }

        if (ObjectManager.Me.ManaPercentage < 50 && ManaTea.KnownSpell && ManaTea.IsSpellUsable
            && MySettings.UseManaTea && ObjectManager.Me.BuffStack(115867) > 4
            && !ObjectManager.Me.InCombat)
        {
            ManaTea.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 95 && SurgingMist.KnownSpell && SurgingMist.IsSpellUsable
            && MySettings.UseSurgingMist && ObjectManager.Me.BuffStack(118674) > 4
            && !ObjectManager.Me.InCombat)
        {
            SurgingMist.Cast();
            return;
        }
        if (HealingSphere.KnownSpell && HealingSphere.IsSpellUsable && ObjectManager.Me.Energy > 39 &&
            ObjectManager.Me.HealthPercent < 60 && MySettings.UseHealingSphere && _healingSphereTimer.IsReady)
        {
            SpellManager.CastSpellByIDAndPosition(115460, ObjectManager.Me.Position);
            _healingSphereTimer = new Timer(1000*5);
            return;
        }
        if (ObjectManager.Me.HealthPercent < 70 && SurgingMist.KnownSpell && SurgingMist.IsSpellUsable
            && MySettings.UseSurgingMist)
        {
            SurgingMist.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 85 && Uplift.KnownSpell && Uplift.IsSpellUsable
            && MySettings.UseUplift && RenewingMist.HaveBuff)
        {
            Uplift.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 85 && ChiWave.KnownSpell && ChiWave.IsSpellUsable
            && MySettings.UseChiWave)
        {
            ChiWave.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 90 && ChiBurst.KnownSpell && ChiBurst.IsSpellUsable
            && MySettings.UseChiBurst)
        {
            ChiBurst.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 90 && ExpelHarm.KnownSpell && ExpelHarm.IsSpellUsable
            && MySettings.UseExpelHarm && ExpelHarm.IsHostileDistanceGood)
        {
            ExpelHarm.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 90 && EnvelopingMist.KnownSpell && EnvelopingMist.IsSpellUsable
            && MySettings.UseEnvelopingMist && !EnvelopingMist.HaveBuff)
        {
            EnvelopingMist.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 95 && SurgingMist.KnownSpell && SurgingMist.IsSpellUsable
            && MySettings.UseSurgingMist && ObjectManager.Me.BuffStack(118674) > 4)
        {
            SurgingMist.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 95 && SoothingMist.KnownSpell && SoothingMist.IsSpellUsable
            && MySettings.UseSoothingMist && !SoothingMist.HaveBuff && !ObjectManager.Me.IsCast)
        {
            SoothingMist.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 95 && RenewingMist.KnownSpell && RenewingMist.IsSpellUsable
            && MySettings.UseRenewingMist && !RenewingMist.HaveBuff)
        {
            RenewingMist.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 95 && ZenSphere.KnownSpell && ZenSphere.IsSpellUsable
            && MySettings.UseZenSphere)
        {
            ZenSphere.Cast();
        }
    }

    private void Decast()
    {
        if (ArcaneTorrent.KnownSpell && MySettings.UseArcaneTorrentForDecast && ArcaneTorrent.IsSpellUsable &&
            ObjectManager.Me.HealthPercent <= MySettings.UseArcaneTorrentForDecastAtPercentage
            && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe && ObjectManager.Target.GetDistance < 8)
        {
            ArcaneTorrent.Cast();
            return;
        }
        if (DiffuseMagic.KnownSpell && MySettings.UseDiffuseMagic && DiffuseMagic.IsSpellUsable
            && ObjectManager.Target.IsCast && ObjectManager.Target.IsTargetingMe)
        {
            DiffuseMagic.Cast();
            return;
        }
        if (SpearHandStrike.KnownSpell && MySettings.UseSpearHandStrike && ObjectManager.Target.IsCast
            && SpearHandStrike.IsSpellUsable && SpearHandStrike.IsHostileDistanceGood)
        {
            SpearHandStrike.Cast();
            return;
        }
        if (ObjectManager.Target.GetMove && !Disable.TargetHaveBuff && MySettings.UseDisable
            && Disable.KnownSpell && Disable.IsSpellUsable && Disable.IsHostileDistanceGood)
        {
            Disable.Cast();
        }
    }

    private void HealingBurst()
    {
        if (MySettings.UseTrinketOne && !ItemsManager.IsItemOnCooldown(_firstTrinket.Entry) && ItemsManager.IsItemUsable(_firstTrinket.Entry))
        {
            ItemsManager.UseItem(_firstTrinket.Name);
            Logging.WriteFight("Use First Trinket Slot");
        }

        if (MySettings.UseTrinketTwo && !ItemsManager.IsItemOnCooldown(_secondTrinket.Entry) && ItemsManager.IsItemUsable(_secondTrinket.Entry))
        {
            ItemsManager.UseItem(_secondTrinket.Name);
            Logging.WriteFight("Use Second Trinket Slot");
            return;
        }
        if (Berserking.IsSpellUsable && Berserking.KnownSpell && ObjectManager.Target.GetDistance <= 40f
            && MySettings.UseBerserking)
        {
            Berserking.Cast();
            return;
        }
        if (BloodFury.IsSpellUsable && BloodFury.KnownSpell && ObjectManager.Target.GetDistance <= 40f
            && MySettings.UseBloodFury)
        {
            BloodFury.Cast();
            return;
        }
        if (ChiBrew.IsSpellUsable && ChiBrew.KnownSpell
            && MySettings.UseChiBrew && ObjectManager.Me.Chi == 0)
        {
            ChiBrew.Cast();
            return;
        }
        if (TouchofDeath.IsSpellUsable && TouchofDeath.KnownSpell && TouchofDeath.IsHostileDistanceGood
            && MySettings.UseTouchofDeath)
        {
            TouchofDeath.Cast();
            return;
        }
        if (InvokeXuentheWhiteTiger.IsSpellUsable && InvokeXuentheWhiteTiger.KnownSpell
            && MySettings.UseInvokeXuentheWhiteTiger && InvokeXuentheWhiteTiger.IsHostileDistanceGood)
        {
            InvokeXuentheWhiteTiger.Cast();
            return;
        }
        if (ThunderFocusTea.IsSpellUsable && ThunderFocusTea.KnownSpell
            && MySettings.UseThunderFocusTea && ObjectManager.Me.HealthPercent < 90)
        {
            ThunderFocusTea.Cast();
            return;
        }
        if (ObjectManager.Me.HealthPercent < 80 && Revival.KnownSpell && Revival.IsSpellUsable
            && MySettings.UseRevival)
        {
            Revival.Cast();
            return;
        }
        if (RushingJadeWind.IsSpellUsable && RushingJadeWind.KnownSpell && RushingJadeWind.IsHostileDistanceGood
            && MySettings.UseRushingJadeWind && ObjectManager.GetNumberAttackPlayer() > 3)
        {
            RushingJadeWind.Cast();
        }
    }

    private void DPSCycle()
    {
        Usefuls.SleepGlobalCooldown();
        try
        {
            Memory.WowMemory.GameFrameLock(); // !!! WARNING - DONT SLEEP WHILE LOCKED - DO FINALLY(GameFrameUnLock()) !!!

            if (ObjectManager.GetNumberAttackPlayer() > 2 && SpinningCraneKick.IsSpellUsable && SpinningCraneKick.KnownSpell
                && SpinningCraneKick.IsHostileDistanceGood && !ObjectManager.Me.IsCast && MySettings.UseSpinningCraneKick)
            {
                SpinningCraneKick.Cast();
                return;
            }
            if (CracklingJadeLightning.KnownSpell && CracklingJadeLightning.IsSpellUsable
                && MySettings.UseCracklingJadeLightning && ObjectManager.Me.Chi < 4 && CracklingJadeLightning.IsHostileDistanceGood
                && !ExpelHarm.IsHostileDistanceGood)
            {
                CracklingJadeLightning.Cast();
                return;
            }
            if (BlackoutKick.KnownSpell && BlackoutKick.IsSpellUsable && BlackoutKick.IsHostileDistanceGood
                && MySettings.UseBlackoutKick && (!ObjectManager.Me.HaveBuff(127722) || _serpentsZealTimer.IsReady))
            {
                BlackoutKick.Cast();
                _serpentsZealTimer = new Timer(1000*25);
                return;
            }
            if (ObjectManager.Me.HealthPercent < 91 && ExpelHarm.KnownSpell && ExpelHarm.IsSpellUsable
                && MySettings.UseExpelHarm && ObjectManager.Me.Chi < 4 && ExpelHarm.IsHostileDistanceGood)
            {
                ExpelHarm.Cast();
                return;
            }
            if (Jab.KnownSpell && Jab.IsSpellUsable && MySettings.UseJab && ObjectManager.Me.Chi < 4
                && Jab.IsHostileDistanceGood)
            {
                Jab.Cast();
                return;
            }
            if (TigerPalm.KnownSpell && TigerPalm.IsSpellUsable && TigerPalm.IsHostileDistanceGood
                && MySettings.UseTigerPalm && ObjectManager.Me.HealthPercent > 90
                && ObjectManager.Me.BuffStack(125359) < 3)
            {
                TigerPalm.Cast();
            }
        }
        finally
        {
            Memory.WowMemory.GameFrameUnLock();
        }
    }

    private void Patrolling()
    {
        if (ObjectManager.Me.IsMounted) return;
        Buff();
        Heal();
    }

    #region Nested type: MonkMistweaverSettings

    [Serializable]
    public class MonkMistweaverSettings : Settings
    {
        public bool DoAvoidMelee = false;
        public int DoAvoidMeleeDistance = 0;
        public bool UseAlchFlask = true;
        public bool UseArcaneTorrentForDecast = true;
        public int UseArcaneTorrentForDecastAtPercentage = 100;
        public bool UseArcaneTorrentForResource = true;
        public int UseArcaneTorrentForResourceAtPercentage = 80;
        public bool UseBerserking = true;
        public bool UseBlackoutKick = true;
        public bool UseBloodFury = true;
        public bool UseChargingOxWave = true;
        public bool UseChiBrew = true;
        public bool UseChiBurst = true;
        public bool UseChiWave = true;
        public bool UseCracklingJadeLightning = true;
        public bool UseDampenHarm = true;
        public bool UseDiffuseMagic = true;
        public bool UseDisable = false;

        public bool UseEnvelopingMist = true;
        public bool UseExpelHarm = true;
        public bool UseFortifyingBrew = true;
        public bool UseGiftoftheNaaru = true;
        public bool UseGrappleWeapon = true;
        public bool UseHealingSphere = true;
        public bool UseInvokeXuentheWhiteTiger = true;
        public bool UseJab = true;
        public bool UseLegSweep = true;
        public bool UseLegacyoftheEmperor = true;
        public bool UseLifeCocoon = true;

        public bool UseManaTea = true;
        public bool UsePathofBlossoms = true;
        public bool UseProvoke = true;
        public bool UseRenewingMist = true;
        public bool UseRevival = true;
        public bool UseRoll = true;
        public bool UseRushingJadeWind = true;
        public bool UseSoothingMist = false;
        public bool UseSpearHandStrike = true;
        public bool UseSpinningCraneKick = true;
        public bool UseStanceoftheFierceTiger = true;
        public bool UseStanceoftheWiseSerpent = true;
        public bool UseStoneform = true;
        public bool UseSummonJadeSerpentStatue = true;
        public bool UseSurgingMist = true;
        public bool UseThunderFocusTea = true;
        public bool UseTigerPalm = true;
        public bool UseTigersLust = true;
        public bool UseTouchofDeath = true;
        public bool UseTrinketOne = true;
        public bool UseTrinketTwo = true;
        public bool UseUplift = true;
        public bool UseWarStomp = true;
        public bool UseZenMeditation = true;
        public bool UseZenSphere = true;

        public MonkMistweaverSettings()
        {
            ConfigWinForm("Mistweaver Monk Settings");
            /* Professions & Racials */
            AddControlInWinForm("Use Arcane Torrent For Decast", "UseArcaneTorrentForDecast", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Arcane Torrent For Resource", "UseArcaneTorrentForResource", "Professions & Racials", "AtPercentage");
            AddControlInWinForm("Use Berserking", "UseBerserking", "Professions & Racials");
            AddControlInWinForm("Use Blood Fury", "UseBloodFury", "Professions & Racials");
            AddControlInWinForm("Use Gift of the Naaru", "UseGiftoftheNaaru", "Professions & Racials");

            AddControlInWinForm("Use Stoneform", "UseStoneform", "Professions & Racials");
            AddControlInWinForm("Use War Stomp", "UseWarStomp", "Professions & Racials");
            /* Monk Buffs */
            AddControlInWinForm("Use Disable", "UseDisable", "Monk Buffs");
            AddControlInWinForm("Use Legacy of the Emperor", "UseLegacyoftheEmperor", "Monk Buffs");
            AddControlInWinForm("Use Stance of the Fierce Tiger", "UseStanceoftheFierceTiger", "Monk Buffs");
            AddControlInWinForm("Use Summon Jade Serpent Statue", "UseSummonJadeSerpentStatue", "Monk Buffs");
            AddControlInWinForm("Use Tiger's Lust", "UseTigersLust", "Monk Buffs");
            /* Offensive Spell */
            AddControlInWinForm("Use Chi Wave", "UseChiWave", "Offensive Spell");
            AddControlInWinForm("Use Blackout Kick", "UseBlackoutKick", "Offensive Spell");
            AddControlInWinForm("Use Crackling Jade Lightning", "UseCracklingJadeLightning", "Offensive Spell");
            AddControlInWinForm("Use Jab", "UseJab", "Offensive Spell");
            AddControlInWinForm("Use Path of Blossoms", "UsePathofBlossoms", "Offensive Spell");
            AddControlInWinForm("Use Provoke", "UseProvoke", "Offensive Spell");
            AddControlInWinForm("Use Roll", "UseRoll", "Offensive Spell");
            AddControlInWinForm("Use Spinning Crane Kick", "UseSpinningCraneKick", "Offensive Spell");
            AddControlInWinForm("Use Tiger Palm", "UseTigerPalm", "Offensive Spell");
            AddControlInWinForm("Use Touch of Death", "UseTouchofDeath", "Offensive Spell");
            /* Healing Cooldown */
            AddControlInWinForm("Use Chi Brew", "UseChiBrew", "Healing Cooldown");
            AddControlInWinForm("Use Invoke Xuen, the White Tiger", "UseInvokeXuentheWhiteTiger", "Healing Cooldown");
            AddControlInWinForm("Use Revival", "UseRevival", "Healing Cooldown");
            AddControlInWinForm("Use Rushing Jade Wind", "UseRushingJadeWind", "Healing Cooldown");
            AddControlInWinForm("Use Thunder Focus Tea", "UseThunderFocusTea", "Healing Cooldown");
            /* Defensive Cooldown */
            AddControlInWinForm("Use Charging Ox Wave", "UseChargingOxWave", "Defensive Cooldown");
            AddControlInWinForm("Use Dampen Harm ", "UseDampenHarm ", "Defensive Cooldown");
            AddControlInWinForm("Use Diffuse Magic", "UseDiffuseMagic", "Defensive Cooldown");
            AddControlInWinForm("Use Fortifying Brew", "UseFortifyingBrew", "Defensive Cooldown");
            AddControlInWinForm("Use Grapple Weapon", "UseGrappleWeapon", "Defensive Cooldown");
            AddControlInWinForm("Use Leg Sweep", "UseLegSweep", "Defensive Cooldown");
            AddControlInWinForm("Use Life Cocoon", "UseLifeCocoon", "Defensive Cooldown");
            AddControlInWinForm("Use Spear Hand Strike", "UseSpearHandStrike", "Defensive Cooldown");
            AddControlInWinForm("Use Zen Meditation", "UseZenMeditation", "Defensive Cooldown");
            /* Healing Spell */
            AddControlInWinForm("Use Chi Burst", "UseChiBurst", "Healing Spell");
            AddControlInWinForm("Use Enveloping Mist", "UseEnvelopingMist", "Healing Spell");
            AddControlInWinForm("Use Expel Harm", "UseExpelHarm", "Healing Spell");
            AddControlInWinForm("Use Healing Sphere", "UseHealingSphere", "Healing Spell");
            AddControlInWinForm("Use Mana Tea", "UseManaTea", "Healing Spell");
            AddControlInWinForm("Use Renewing Mist", "UseRenewingMist", "Healing Spell");
            AddControlInWinForm("Use Soothing Mist", "UseSoothingMist", "Healing Spell");
            AddControlInWinForm("Use Surging Mist", "UseSurgingMist", "Healing Spell");
            AddControlInWinForm("Use Uplift", "UseUplift", "Healing Spell");
            AddControlInWinForm("Use Zen Sphere", "UseZenSphere", "Healing Spell");
            /* Game Settings */
            AddControlInWinForm("Use Trinket One", "UseTrinketOne", "Game Settings");
            AddControlInWinForm("Use Trinket Two", "UseTrinketTwo", "Game Settings");

            AddControlInWinForm("Use Alchemist Flask", "UseAlchFlask", "Game Settings");
            AddControlInWinForm("Do avoid melee (Off Advised!!)", "DoAvoidMelee", "Game Settings");
            AddControlInWinForm("Avoid melee distance (1 to 4)", "DoAvoidMeleeDistance", "Game Settings");
        }

        public static MonkMistweaverSettings CurrentSetting { get; set; }

        public static MonkMistweaverSettings GetSettings()
        {
            string currentSettingsFile = Application.StartupPath + "\\CombatClasses\\Settings\\Monk_Mistweaver.xml";
            if (File.Exists(currentSettingsFile))
            {
                return
                    CurrentSetting = Load<MonkMistweaverSettings>(currentSettingsFile);
            }
            return new MonkMistweaverSettings();
        }
    }

    #endregion
}

#endregion

// ReSharper restore ObjectCreationAsStatement
// ReSharper restore EmptyGeneralCatchClause