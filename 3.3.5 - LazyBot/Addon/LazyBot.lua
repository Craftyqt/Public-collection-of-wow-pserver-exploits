local IsSettingName = 0;
function LazyBot1_OnLoad()
	DEFAULT_CHAT_FRAME:AddMessage("LazyBot loaded", 0, 0.7, 1);
	SlashCmdList["LazyBot"]=FunctionSlash;
	SLASH_LazyBot1="/am";
	this:RegisterEvent("ADDON_LOADED");
	this:RegisterEvent("MERCHANT_SHOW");
	this:RegisterEvent("MAIL_SHOW");
end

function FunctionSlash(cmd)
	if(cmd == "help") then
		DEFAULT_CHAT_FRAME:AddMessage("<LazyBot>", 0, 0.7, 1);
		DEFAULT_CHAT_FRAME:AddMessage("    /am show ", 0, 0.7, 1);
		DEFAULT_CHAT_FRAME:AddMessage("    /am on ", 0, 0.7, 1);
		DEFAULT_CHAT_FRAME:AddMessage("    /am hide ", 0, 0.7, 1);
		DEFAULT_CHAT_FRAME:AddMessage("    /am setname ", 0, 0.7, 1);
		DEFAULT_CHAT_FRAME:AddMessage("    /am showname ", 0, 0.7, 1);
	elseif(cmd == "show") then
		LazyBot1:Show();
	elseif(cmd == "on") then
		EnabledSaveButton:SetChecked(true);
		savedEnabled = 1;
	elseif(cmd == "hide") then
		LazyBot1:Hide();
	elseif(cmd == "showname") then
		if (savedName ~= nill and savedName ~= "") then 
			DEFAULT_CHAT_FRAME:AddMessage("<LazyBot> Playername is at the moment: " .. savedName, 0, 0.7, 1);
		else
			DEFAULT_CHAT_FRAME:AddMessage("<LazyBot> Playername is not set atm", 0, 0.7, 1);
		end
	elseif(cmd == "setname") then
		IsSettingName = 1;
		DEFAULT_CHAT_FRAME:AddMessage("<LazyBot> Set the name of the char you want to email: Use /am nickname e.g /am Someone  - now to set it", 0, 0.7, 1);
		if (savedName ~= nill and savedName ~= "") then 
			DEFAULT_CHAT_FRAME:AddMessage("<LazyBot> Playername is at the moment: " .. savedName, 0, 0.7, 1);
		end
	else
		if (IsSettingName == 1) then
	        savedName = cmd;
	        DEFAULT_CHAT_FRAME:AddMessage("<LazyBot> ".. savedName .." set as mail to name", 0, 0.7, 1);
			IsSettingName = 0;
	    else 
			DEFAULT_CHAT_FRAME:AddMessage("<LazyBot> Type '/am help' for a list of commands", 0, 0.7, 1);
		end
	end
end

function LazyBot1_OnEvent(event)
	local enabled = EnabledSaveButton:GetChecked();		
	if (event == "MERCHANT_SHOW") then
		if enabled == 1 then
			SellGray();
			RepairAllItems();
		end
	end
	if (event == "ADDON_LOADED") then
		if(savedName~= nill and savedName~= "") then
			LazyBot1:Hide();
		end
		LazyBot1:SetMovable(true);
		FontString4:SetText(savedName);
		if(savedEnabled ~= nill) then
			if savedEnabled == 1 then
				EnabledSaveButton:SetChecked(true);
			else
				EnabledSaveButton:SetChecked(false);
			end
		end
		if savedName ~= nil then
			EditBox1:Hide()
		end	
	end
	if (event == "MAIL_SHOW") then
		if enabled == 1 then  
			if savedName ~= nill and savedName ~= "" then
				CheckBags();
				ClearCursor();
			else
				DEFAULT_CHAT_FRAME:AddMessage("<LazyBot> Name not set - not mailing", 0, 0.7, 1);
			end
		end
	end
end

function SellGray()
	for b=0,4 do                                   
	  for s=1, GetContainerNumSlots(b) do          
		n=GetContainerItemLink(b,s)               
		if n and string.find(n, "ff9d9d9d") then                                 
			UseContainerItem(b,s)                   
		end                                        
	  end                                          
	end                                            
end

function CheckBags()
	for bag = 0, 4 do 
		for slot = 1, GetContainerNumSlots(bag) do 
			local item = GetContainerItemLink(bag,slot) 
			local texture, itemCount, locked, quality, readable = GetContainerItemInfo(bag, slot) 
			PickupContainerItem(bag, slot);
			if item and item:find("Saronite Ore") and itemCount == 20 then 
				ClickSendMailItemButton()
			elseif item and item:find("Talandra's Rose") and itemCount == 20 then
				ClickSendMailItemButton()			
			elseif item and item:find("Titanium Ore") and itemCount == 20 then
				ClickSendMailItemButton()		
			elseif item and item:find("Adder's Tongue") and itemCount == 20 then
				ClickSendMailItemButton()
			elseif item and item:find("Goldclover") and itemCount == 20 then
				ClickSendMailItemButton()		
			elseif item and item:find("Tiger Lily") and itemCount == 20 then
				ClickSendMailItemButton()		
			elseif item and item:find("Deadnettle") and itemCount == 20 then
				ClickSendMailItemButton()			
			elseif item and item:find("Frost Lotus") then
				ClickSendMailItemButton()			
			elseif item and item:find("Eternal Life") then
				ClickSendMailItemButton()		
			elseif item and item:find("Eternal Shadow") then
				ClickSendMailItemButton()
			elseif item and item:find("Eternal Earth") then
				ClickSendMailItemButton()			
			elseif item and item:find("Eternal Water") then
				ClickSendMailItemButton()		
			elseif item and item:find("Eternal Air") then
				ClickSendMailItemButton()			
			elseif item and item:find("Eternal Fire") then
				ClickSendMailItemButton()			
			elseif item and item:find("Twilight Opal") then
				ClickSendMailItemButton()	
			elseif item and item:find("Autumn's Glow") then
				ClickSendMailItemButton()		
			elseif item and item:find("Forest Emerald") then
				ClickSendMailItemButton()
			elseif item and item:find("Sky Sapphire") then
				ClickSendMailItemButton()			
			elseif item and item:find("Scarlet Ruby") then
				ClickSendMailItemButton()			
			elseif item and item:find("Monarch Topaz") then
				ClickSendMailItemButton()			
			elseif item and item:find("Bloodstone") and itemCount == 20 then
				ClickSendMailItemButton()			
			elseif item and item:find("Sun Crystal") and itemCount == 20 then
				ClickSendMailItemButton()		
			elseif item and item:find("Chalcedony") and itemCount == 20 then
				ClickSendMailItemButton()		
			elseif item and item:find("Huge Citrine") and itemCount == 20 then
				ClickSendMailItemButton()			
			elseif item and item:find("Lichbloom") and itemCount == 20 then
				ClickSendMailItemButton()			
			elseif item and item:find("Icethorn") and itemCount == 20 then
				ClickSendMailItemButton()			
			elseif item and item:find("Dark Jade") and itemCount == 20 then
				ClickSendMailItemButton()
			elseif item and item:find("Shadow Crystal") and itemCount == 20 then
				ClickSendMailItemButton()
			end
			PickupContainerItem(bag, slot);
		end 
	end
	local NameAttachment, TextureAttachment, CountAttachment, QualityAttachment = GetSendMailItem(index)
	if NameAttachment ~= nil then
		__wait(1, SendMailNow)
		ClearCursor()
	end
end

function SendMailNow()
	if savedName ~= nill and savedName ~= "" then
		ClearCursor()
		SendMail(savedName, "Hey")
		DEFAULT_CHAT_FRAME:AddMessage("<LazyBot> Mailing items to: " ..savedName, 0, 0.7, 1);
		__wait(3, CheckBags)
	end
end

local waitTable = {};
local waitFrame = nil;
function __wait(delay, func, ...)
  if(type(delay)~="number" or type(func)~="function") then
    return false;
  end
  if(waitFrame == nil) then
    waitFrame = CreateFrame("Frame","WaitFrame", UIParent);
    waitFrame:SetScript("onUpdate",function (self,elapse)
      local count = #waitTable;
      local i = 1;
      while(i<=count) do
        local waitRecord = tremove(waitTable,i);
        local d = tremove(waitRecord,1);
        local f = tremove(waitRecord,1);
        local p = tremove(waitRecord,1);
        if(d>elapse) then
          tinsert(waitTable,i,{d-elapse,f,p});
          i = i + 1;
        else
          count = count - 1;
          f(unpack(p));
        end
      end
    end);
  end
  tinsert(waitTable,{delay,func,{...}});
  return true;
end

function SaveButton_OnClick()
	EditBox1:Hide()
	FontString4:SetText(EditBox1:GetText())
	savedName = EditBox1:GetText()
end

function SetNameButton_OnClick()
	EditBox1:Show()	
end

function EnabledSaveButton_OnClick()
	local enabled = EnabledSaveButton:GetChecked();
	if enabled == 1 then
		savedEnabled = 1;
	else
		savedEnabled = 0;
	end
end
